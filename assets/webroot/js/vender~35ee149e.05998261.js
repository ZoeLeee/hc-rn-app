"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[471],{13566:(e,t,i)=>{i.d(t,{w:()=>l});var r=i(58095),n=i(3085),s=i(9148),a=i(15631),o=i(15210);class l{get xAxis(){return this._xAxis}get yAxis(){return this._yAxis}get zAxis(){return this._zAxis}constructor(e,t=1,i=2,u,h,c,d=1){if(this._scaleLinesFactor=4,this._instanced=!1,this.scene=null,this.scaleLines=1,e=e||o.l.LastCreatedScene){if(this.scaleLines=t,!u){const t=new n.K("",e);t.disableLighting=!0,t.emissiveColor=a.Wo.Red().scale(.5),u=s.u._CreateArrow(e,t,d)}if(!h){const t=new n.K("",e);t.disableLighting=!0,t.emissiveColor=a.Wo.Green().scale(.5),h=s.u._CreateArrow(e,t,d)}if(!c){const t=new n.K("",e);t.disableLighting=!0,t.emissiveColor=a.Wo.Blue().scale(.5),c=s.u._CreateArrow(e,t,d)}this._xAxis=u,this._xAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._yAxis=h,this._yAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._zAxis=c,this._zAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),null!=i&&(l._SetRenderingGroupId(this._xAxis,i),l._SetRenderingGroupId(this._yAxis,i),l._SetRenderingGroupId(this._zAxis,i)),this.scene=e,this.update(new r.P,r.P.Right(),r.P.Up(),r.P.Forward())}}update(e,t,i,r){this._xAxis.position.copyFrom(e),this._xAxis.setDirection(t),this._xAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._yAxis.position.copyFrom(e),this._yAxis.setDirection(i),this._yAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._zAxis.position.copyFrom(e),this._zAxis.setDirection(r),this._zAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor)}createInstance(){const e=s.u._CreateArrowInstance(this.scene,this._xAxis),t=s.u._CreateArrowInstance(this.scene,this._yAxis),i=s.u._CreateArrowInstance(this.scene,this._zAxis),r=new l(this.scene,this.scaleLines,null,e,t,i);return r._instanced=!0,r}dispose(){this._xAxis&&this._xAxis.dispose(!1,!this._instanced),this._yAxis&&this._yAxis.dispose(!1,!this._instanced),this._zAxis&&this._zAxis.dispose(!1,!this._instanced),this.scene=null}static _SetRenderingGroupId(e,t){e.getChildMeshes().forEach((e=>{e.renderingGroupId=t}))}}},22933:(e,t,i)=>{i.r(t),i.d(t,{DebugLayer:()=>u,DebugLayerTab:()=>r});var r,n=i(13514),s=i(62897),a=i(65273),o=i(37290),l=i(15210);Object.defineProperty(a.x.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new u(this)),this._debugLayer},enumerable:!0,configurable:!0}),function(e){e[e.Properties=0]="Properties",e[e.Debug=1]="Debug",e[e.Statistics=2]="Statistics",e[e.Tools=3]="Tools",e[e.Settings=4]="Settings"}(r||(r={}));class u{get onPropertyChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new s.y$),this._onPropertyChangedObservable)}get onSelectionChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new s.y$),this._onSelectionChangedObservable)}constructor(e){this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||l.l.LastCreatedScene,this._scene&&this._scene.onDisposeObservable.add((()=>{this._scene._debugLayer&&this._scene._debugLayer.hide()}))}_createInspector(e){if(this.isVisible())return;if(this._onPropertyChangedObservable){for(const e of this._onPropertyChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(e);this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(const e of this._onSelectionChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(e);this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}const t={overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0,...e};this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,t)}select(e,t){this.BJSINSPECTOR&&(t&&("[object String]"==Object.prototype.toString.call(t)?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e))}_getGlobalInspector(){return"undefined"!=typeof INSPECTOR?INSPECTOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.Inspector?BABYLON:void 0}isVisible(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible}hide(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()}setAsActiveScene(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)}show(e){return new Promise((t=>{if(void 0===this.BJSINSPECTOR){const i=e&&e.inspectorURL?e.inspectorURL:u.InspectorURL;n.w1.LoadScript(i,(()=>{this._createInspector(e),t(this)}))}else this._createInspector(e),t(this)}))}}u.InspectorURL=`https://unpkg.com/babylonjs-inspector@${o.D.Version}/babylon.inspector.bundle.js`},67152:(e,t,i)=>{i(13566);var r=i(58095);i(43048);i(22933);var n=i(91243),s=(i(8451),i(48087)),a=i(15631),o=(i(15210),i(3085),i(59715),i(85527));i(62845),i(6588),i(84318),i(89209);var l=i(9866);var u=i(98163),h=i(54067),c=i(93980),d=i(72208),_=i(58445),p=i(75159);class g{static CreateBoneWeightShader(e,t){var i,r,n,s,o,l;const c=e.skeleton,d=null!==(i=e.colorBase)&&void 0!==i?i:a.Wo.Black(),p=null!==(r=e.colorZero)&&void 0!==r?r:a.Wo.Blue(),g=null!==(n=e.colorQuarter)&&void 0!==n?n:a.Wo.Green(),f=null!==(s=e.colorHalf)&&void 0!==s?s:a.Wo.Yellow(),m=null!==(o=e.colorFull)&&void 0!==o?o:a.Wo.Red(),E=null!==(l=e.targetBoneIndex)&&void 0!==l?l:0;_.Q.ShadersStore["boneWeights:"+c.name+"VertexShader"]="precision highp float;\n\n        attribute vec3 position;\n        attribute vec2 uv;\n\n        uniform mat4 view;\n        uniform mat4 projection;\n        uniform mat4 worldViewProjection;\n\n        #include<bonesDeclaration>\n        #if NUM_BONE_INFLUENCERS == 0\n            attribute vec4 matricesIndices;\n            attribute vec4 matricesWeights;\n        #endif\n        #include<bakedVertexAnimationDeclaration>\n\n        #include<instancesDeclaration>\n\n        varying vec3 vColor;\n\n        uniform vec3 colorBase;\n        uniform vec3 colorZero;\n        uniform vec3 colorQuarter;\n        uniform vec3 colorHalf;\n        uniform vec3 colorFull;\n\n        uniform float targetBoneIndex;\n\n        void main() {\n            vec3 positionUpdated = position;\n\n            #include<instancesVertex>\n            #include<bonesVertex>\n            #include<bakedVertexAnimation>\n\n            vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);\n\n            vec3 color = colorBase;\n            float totalWeight = 0.;\n            if(matricesIndices[0] == targetBoneIndex && matricesWeights[0] > 0.){\n                totalWeight += matricesWeights[0];\n            }\n            if(matricesIndices[1] == targetBoneIndex && matricesWeights[1] > 0.){\n                totalWeight += matricesWeights[1];\n            }\n            if(matricesIndices[2] == targetBoneIndex && matricesWeights[2] > 0.){\n                totalWeight += matricesWeights[2];\n            }\n            if(matricesIndices[3] == targetBoneIndex && matricesWeights[3] > 0.){\n                totalWeight += matricesWeights[3];\n            }\n\n            color = mix(color, colorZero, smoothstep(0., 0.25, totalWeight));\n            color = mix(color, colorQuarter, smoothstep(0.25, 0.5, totalWeight));\n            color = mix(color, colorHalf, smoothstep(0.5, 0.75, totalWeight));\n            color = mix(color, colorFull, smoothstep(0.75, 1.0, totalWeight));\n            vColor = color;\n\n        gl_Position = projection * view * worldPos;\n        }",_.Q.ShadersStore["boneWeights:"+c.name+"FragmentShader"]="\n            precision highp float;\n            varying vec3 vPosition;\n\n            varying vec3 vColor;\n\n            void main() {\n                vec4 color = vec4(vColor, 1.0);\n                gl_FragColor = color;\n            }\n        ";const T=new h.j("boneWeight:"+c.name,t,{vertex:"boneWeights:"+c.name,fragment:"boneWeights:"+c.name},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorBase","colorZero","colorQuarter","colorHalf","colorFull","targetBoneIndex"]});return T.setColor3("colorBase",d),T.setColor3("colorZero",p),T.setColor3("colorQuarter",g),T.setColor3("colorHalf",f),T.setColor3("colorFull",m),T.setFloat("targetBoneIndex",E),T.getClassName=()=>"BoneWeightShader",T.transparencyMode=u.F.MATERIAL_OPAQUE,T}static CreateSkeletonMapShader(e,t){var i;const r=e.skeleton,n=null!==(i=e.colorMap)&&void 0!==i?i:[{color:new a.Wo(1,.38,.18),location:0},{color:new a.Wo(.59,.18,1),location:.2},{color:new a.Wo(.59,1,.18),location:.4},{color:new a.Wo(1,.87,.17),location:.6},{color:new a.Wo(1,.17,.42),location:.8},{color:new a.Wo(.17,.68,1),location:1}],s=r.bones.length+1,o=g._CreateBoneMapColorBuffer(s,n,t),l=new h.j("boneWeights:"+r.name,t,{vertexSource:"precision highp float;\n\n            attribute vec3 position;\n            attribute vec2 uv;\n\n            uniform mat4 view;\n            uniform mat4 projection;\n            uniform mat4 worldViewProjection;\n            uniform float colorMap["+4*r.bones.length+"];\n\n            #include<bonesDeclaration>\n            #if NUM_BONE_INFLUENCERS == 0\n                attribute vec4 matricesIndices;\n                attribute vec4 matricesWeights;\n            #endif\n            #include<bakedVertexAnimationDeclaration>\n            #include<instancesDeclaration>\n\n            varying vec3 vColor;\n\n            void main() {\n                vec3 positionUpdated = position;\n\n                #include<instancesVertex>\n                #include<bonesVertex>\n                #include<bakedVertexAnimation>\n\n                vec3 color = vec3(0.);\n                bool first = true;\n\n                for (int i = 0; i < 4; i++) {\n                    int boneIdx = int(matricesIndices[i]);\n                    float boneWgt = matricesWeights[i];\n\n                    vec3 c = vec3(colorMap[boneIdx * 4 + 0], colorMap[boneIdx * 4 + 1], colorMap[boneIdx * 4 + 2]);\n\n                    if (boneWgt > 0.) {\n                        if (first) {\n                            first = false;\n                            color = c;\n                        } else {\n                            color = mix(color, c, boneWgt);\n                        }\n                    }\n                }\n\n                vColor = color;\n\n                vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);\n\n                gl_Position = projection * view * worldPos;\n            }",fragmentSource:"\n            precision highp float;\n            varying vec3 vColor;\n\n            void main() {\n                vec4 color = vec4( vColor, 1.0 );\n                gl_FragColor = color;\n            }\n            "},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorMap"]});return l.setFloats("colorMap",o),l.getClassName=()=>"SkeletonMapShader",l.transparencyMode=u.F.MATERIAL_OPAQUE,l}static _CreateBoneMapColorBuffer(e,t,i){const r=new c.c("temp",{width:e,height:1},i,!1),n=r.getContext(),s=n.createLinearGradient(0,0,e,0);t.forEach((e=>{s.addColorStop(e.location,e.color.toHexString())})),n.fillStyle=s,n.fillRect(0,0,e,1),r.update();const a=[],o=n.getImageData(0,0,e,1).data;for(let e=0;e<o.length;e++)a.push(.00392156862745098*o[e]);return r.dispose(),a}get scene(){return this._scene}get utilityLayer(){return this._utilityLayer}get isReady(){return this._ready}set ready(e){this._ready=e}get debugMesh(){return this._debugMesh}set debugMesh(e){this._debugMesh=e}get displayMode(){return this.options.displayMode||g.DISPLAY_LINES}set displayMode(e){e>g.DISPLAY_SPHERE_AND_SPURS&&(e=g.DISPLAY_LINES),this.options.displayMode=e}constructor(e,t,i,r=!0,n=3,s={}){var l,u,h,c,_,p,f,m,E,T,x,S,b,R;this.skeleton=e,this.mesh=t,this.autoUpdateBonesMatrices=r,this.renderingGroupId=n,this.options=s,this.color=a.Wo.White(),this._debugLines=new Array,this._localAxes=null,this._isEnabled=!0,this._obs=null,this._scene=i,this._ready=!1,s.pauseAnimations=null===(l=s.pauseAnimations)||void 0===l||l,s.returnToRest=null!==(u=s.returnToRest)&&void 0!==u&&u,s.displayMode=null!==(h=s.displayMode)&&void 0!==h?h:g.DISPLAY_LINES,s.displayOptions=null!==(c=s.displayOptions)&&void 0!==c?c:{},s.displayOptions.midStep=null!==(_=s.displayOptions.midStep)&&void 0!==_?_:.235,s.displayOptions.midStepFactor=null!==(p=s.displayOptions.midStepFactor)&&void 0!==p?p:.155,s.displayOptions.sphereBaseSize=null!==(f=s.displayOptions.sphereBaseSize)&&void 0!==f?f:.15,s.displayOptions.sphereScaleUnit=null!==(m=s.displayOptions.sphereScaleUnit)&&void 0!==m?m:2,s.displayOptions.sphereFactor=null!==(E=s.displayOptions.sphereFactor)&&void 0!==E?E:.865,s.displayOptions.spurFollowsChild=null!==(T=s.displayOptions.spurFollowsChild)&&void 0!==T&&T,s.displayOptions.showLocalAxes=null!==(x=s.displayOptions.showLocalAxes)&&void 0!==x&&x,s.displayOptions.localAxesSize=null!==(S=s.displayOptions.localAxesSize)&&void 0!==S?S:.075,s.computeBonesUsingShaders=null===(b=s.computeBonesUsingShaders)||void 0===b||b,s.useAllBones=null===(R=s.useAllBones)||void 0===R||R;const A=t.getVerticesData(d.o.MatricesIndicesKind),y=t.getVerticesData(d.o.MatricesWeightsKind);if(this._boneIndices=new Set,!s.useAllBones&&A&&y)for(let e=0;e<A.length;++e){const t=A[e];0!==y[e]&&this._boneIndices.add(t)}this._utilityLayer=new o.x(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0;let v=this.options.displayMode||0;v>g.DISPLAY_SPHERE_AND_SPURS&&(v=g.DISPLAY_LINES),this.displayMode=v,this.update(),this._bindObs()}_bindObs(){if(this.displayMode===g.DISPLAY_LINES)this._obs=this.scene.onBeforeRenderObservable.add((()=>{this._displayLinesUpdate()}))}update(){switch(this.displayMode){case g.DISPLAY_LINES:this._displayLinesUpdate();break;case g.DISPLAY_SPHERES:this._buildSpheresAndSpurs(!0);break;case g.DISPLAY_SPHERE_AND_SPURS:this._buildSpheresAndSpurs(!1)}this._buildLocalAxes()}set isEnabled(e){this.isEnabled!==e&&(this._isEnabled=e,this.debugMesh&&this.debugMesh.setEnabled(e),e&&!this._obs?this._bindObs():!e&&this._obs&&(this.scene.onBeforeRenderObservable.remove(this._obs),this._obs=null))}get isEnabled(){return this._isEnabled}_getBonePosition(e,t,i,n=0,s=0,a=0){const o=r.jp.Matrix[0],l=t.getParent();if(o.copyFrom(t.getLocalMatrix()),0!==n||0!==s||0!==a){const e=r.jp.Matrix[1];r.y3.IdentityToRef(e),e.setTranslationFromFloats(n,s,a),e.multiplyToRef(o,o)}l&&o.multiplyToRef(l.getAbsoluteTransform(),o),o.multiplyToRef(i,o),e.x=o.m[12],e.y=o.m[13],e.z=o.m[14]}_getLinesForBonesWithLength(e,t){const i=e.length,n=this.mesh.position;let s=0;for(let a=0;a<i;a++){const i=e[a];let o=this._debugLines[s];-1!==i._index&&(this._boneIndices.has(i.getIndex())||this.options.useAllBones)&&(o||(o=[r.P.Zero(),r.P.Zero()],this._debugLines[s]=o),this._getBonePosition(o[0],i,t),this._getBonePosition(o[1],i,t,0,i.length,0),o[0].subtractInPlace(n),o[1].subtractInPlace(n),s++)}}_getLinesForBonesNoLength(e){const t=e.length;let i=0;const n=this.mesh,s=n.position;for(let a=t-1;a>=0;a--){const t=e[a],o=t.getParent();if(!o||!this._boneIndices.has(t.getIndex())&&!this.options.useAllBones)continue;let l=this._debugLines[i];l||(l=[r.P.Zero(),r.P.Zero()],this._debugLines[i]=l),t.getAbsolutePositionToRef(n,l[0]),o.getAbsolutePositionToRef(n,l[1]),l[0].subtractInPlace(s),l[1].subtractInPlace(s),i++}}_revert(e){this.options.pauseAnimations&&(this.scene.animationsEnabled=e,this.utilityLayer.utilityLayerScene.animationsEnabled=e)}_getAbsoluteBindPoseToRef(e,t){null!==e&&-1!==e._index?(this._getAbsoluteBindPoseToRef(e.getParent(),t),e.getBaseMatrix().multiplyToRef(t,t)):t.copyFrom(r.y3.Identity())}_buildSpheresAndSpurs(e=!0){var t,i;this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this._ready=!1;const a=null===(t=this.utilityLayer)||void 0===t?void 0:t.utilityLayerScene,o=this.skeleton.bones,l=[],u=[],h=this.scene.animationsEnabled;try{this.options.pauseAnimations&&(this.scene.animationsEnabled=!1,a.animationsEnabled=!1),this.options.returnToRest&&this.skeleton.returnToRest(),this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms();let t=Number.NEGATIVE_INFINITY;const c=this.options.displayOptions||{};for(let i=0;i<o.length;i++){const h=o[i];if(-1===h._index||!this._boneIndices.has(h.getIndex())&&!this.options.useAllBones)continue;const _=new r.y3;this._getAbsoluteBindPoseToRef(h,_);const g=new r.P;_.decompose(void 0,void 0,g),h.children.forEach((i=>{const s=new r.y3;i.getBaseMatrix().multiplyToRef(_,s);const o=new r.P;s.decompose(void 0,void 0,o);const l=r.P.Distance(g,o);if(l>t&&(t=l),e)return;const f=o.clone().subtract(g.clone()),m=f.length(),E=f.normalize().scale(m),T=c.midStep||.165,x=c.midStepFactor||.215,S=E.scale(T),b=(0,p.bC)("skeletonViewer",{shape:[new r.P(1,-1,0),new r.P(1,1,0),new r.P(-1,1,0),new r.P(-1,-1,0),new r.P(1,-1,0)],path:[r.P.Zero(),S,E],scaleFunction:e=>{switch(e){case 0:case 2:return 0;case 1:return m*x}return 0},sideOrientation:n.Kj.DEFAULTSIDE,updatable:!1},a),R=b.getTotalVertices(),A=[],y=[];for(let e=0;e<R;e++)A.push(1,0,0,0),c.spurFollowsChild&&e>9?y.push(i.getIndex(),0,0,0):y.push(h.getIndex(),0,0,0);b.position=g.clone(),b.setVerticesData(d.o.MatricesWeightsKind,A,!1),b.setVerticesData(d.o.MatricesIndicesKind,y,!1),b.convertToFlatShadedMesh(),u.push(b)}));const f=c.sphereBaseSize||.2,m=(0,s.Qk)("skeletonViewer",{segments:6,diameter:f,updatable:!0},a),E=m.getTotalVertices(),T=[],x=[];for(let e=0;e<E;e++)T.push(1,0,0,0),x.push(h.getIndex(),0,0,0);m.setVerticesData(d.o.MatricesWeightsKind,T,!1),m.setVerticesData(d.o.MatricesIndicesKind,x,!1),m.position=g.clone(),l.push([m,h])}const _=c.sphereScaleUnit||2,g=c.sphereFactor||.85,f=[];for(let e=0;e<l.length;e++){const[i,r]=l[e],n=1/(_/t);let s=0,a=r;for(;a.getParent()&&-1!==a.getParent().getIndex();)s++,a=a.getParent();i.scaling.scaleInPlace(n*Math.pow(g,s)),f.push(i)}this.debugMesh=n.Kj.MergeMeshes(f.concat(u),!0,!0),this.debugMesh&&(this.debugMesh.renderingGroupId=this.renderingGroupId,this.debugMesh.skeleton=this.skeleton,this.debugMesh.parent=this.mesh,this.debugMesh.computeBonesUsingShaders=null===(i=this.options.computeBonesUsingShaders)||void 0===i||i,this.debugMesh.alwaysSelectAsActiveMesh=!0);this.utilityLayer._getSharedGizmoLight().intensity=.7,this._revert(h),this.ready=!0}catch(e){console.error(e),this._revert(h),this.dispose()}}_buildLocalAxes(){var e;this._localAxes&&this._localAxes.dispose(),this._localAxes=null;const t=this.options.displayOptions||{};if(!t.showLocalAxes)return;const i=this._utilityLayer.utilityLayerScene,n=t.localAxesSize||.075,s=[],o=[],u=new a.HE(1,0,0,1),h=new a.HE(0,1,0,1),c=new a.HE(0,0,1,1),_=[],p=[];for(const e in this.skeleton.bones){const t=this.skeleton.bones[e];if(-1===t._index||!this._boneIndices.has(t.getIndex())&&!this.options.useAllBones)continue;const i=new r.y3,a=new r.P;this._getAbsoluteBindPoseToRef(t,i),i.decompose(void 0,r.jp.Quaternion[0],a);const l=new r.y3;r.jp.Quaternion[0].toRotationMatrix(l);const d=r.P.TransformCoordinates(new r.P(0+n,0,0),l),g=r.P.TransformCoordinates(new r.P(0,0+n,0),l),f=r.P.TransformCoordinates(new r.P(0,0,0+n),l),m=[[a,a.add(d)],[a,a.add(g)],[a,a.add(f)]],E=[[u,u],[h,h],[c,c]];s.push(...m),o.push(...E);for(let e=0;e<6;e++)_.push(1,0,0,0),p.push(t.getIndex(),0,0,0)}this._localAxes=(0,l.xW)("localAxes",{lines:s,colors:o,updatable:!0},i),this._localAxes.setVerticesData(d.o.MatricesWeightsKind,_,!1),this._localAxes.setVerticesData(d.o.MatricesIndicesKind,p,!1),this._localAxes.skeleton=this.skeleton,this._localAxes.renderingGroupId=this.renderingGroupId+1,this._localAxes.parent=this.mesh,this._localAxes.computeBonesUsingShaders=null===(e=this.options.computeBonesUsingShaders)||void 0===e||e}_displayLinesUpdate(){if(!this._utilityLayer)return;this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms(),void 0===this.skeleton.bones[0].length?this._getLinesForBonesNoLength(this.skeleton.bones):this._getLinesForBonesWithLength(this.skeleton.bones,this.mesh.getWorldMatrix());const e=this._utilityLayer.utilityLayerScene;e&&(this._debugMesh?(0,l.xW)("",{lines:this._debugLines,updatable:!0,instance:this._debugMesh},e):(this._debugMesh=(0,l.xW)("",{lines:this._debugLines,updatable:!0,instance:null},e),this._debugMesh.renderingGroupId=this.renderingGroupId),this._debugMesh.position.copyFrom(this.mesh.position),this._debugMesh.color=this.color)}changeDisplayMode(e){const t=!!this.isEnabled;this.displayMode!==e&&(this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.displayMode=e,this.update(),this._bindObs(),this.isEnabled=t)}changeDisplayOptions(e,t){const i=!!this.isEnabled;this.options.displayOptions[e]=t,this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.update(),this._bindObs(),this.isEnabled=i}dispose(){this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null),this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null),this.ready=!1}}g.DISPLAY_LINES=0,g.DISPLAY_SPHERES=1,g.DISPLAY_SPHERE_AND_SPURS=2;i(30700)},33097:(e,t,i)=>{var r,n,s,a,o,l,u;i.d(t,{FP:()=>s,Fz:()=>n,Yi:()=>r}),function(e){e[e.Generic=0]="Generic",e[e.Keyboard=1]="Keyboard",e[e.Mouse=2]="Mouse",e[e.Touch=3]="Touch",e[e.DualShock=4]="DualShock",e[e.Xbox=5]="Xbox",e[e.Switch=6]="Switch",e[e.DualSense=7]="DualSense"}(r||(r={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.Move=12]="Move"}(n||(n={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.DeltaHorizontal=10]="DeltaHorizontal",e[e.DeltaVertical=11]="DeltaVertical"}(s||(s={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(a||(a={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Create=8]="Create",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(o||(o={})),function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.LT=6]="LT",e[e.RT=7]="RT",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.LStickXAxis=17]="LStickXAxis",e[e.LStickYAxis=18]="LStickYAxis",e[e.RStickXAxis=19]="RStickXAxis",e[e.RStickYAxis=20]="RStickYAxis"}(l||(l={})),function(e){e[e.B=0]="B",e[e.A=1]="A",e[e.Y=2]="Y",e[e.X=3]="X",e[e.L=4]="L",e[e.R=5]="R",e[e.ZL=6]="ZL",e[e.ZR=7]="ZR",e[e.Minus=8]="Minus",e[e.Plus=9]="Plus",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.Capture=17]="Capture",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(u||(u={}))},76503:(e,t,i)=>{i.d(t,{p:()=>n});var r=i(62897);class n{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new r.y$,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}},58334:(e,t,i)=>{i.d(t,{U:()=>p});var r=i(33097),n=i(62897),s=i(49671);class a{static CreateDeviceEvent(e,t,i,n,s,a,o){switch(e){case r.Yi.Keyboard:return this._CreateKeyboardEvent(i,n,s,a);case r.Yi.Mouse:if(i===r.Fz.MouseWheelX||i===r.Fz.MouseWheelY||i===r.Fz.MouseWheelZ)return this._CreateWheelEvent(e,t,i,n,s,a);case r.Yi.Touch:return this._CreatePointerEvent(e,t,i,n,s,a,o);default:throw`Unable to generate event for device ${r.Yi[e]}`}}static _CreatePointerEvent(e,t,i,n,s,a,o){const l=this._CreateMouseEvent(e,t,i,n,s,a);return e===r.Yi.Mouse?(l.deviceType=r.Yi.Mouse,l.pointerId=1,l.pointerType="mouse"):(l.deviceType=r.Yi.Touch,l.pointerId=null!=o?o:t,l.pointerType="touch"),i===r.Fz.Move?l.type="pointermove":i>=r.Fz.LeftClick&&i<=r.Fz.RightClick&&(l.type=1===n?"pointerdown":"pointerup",l.button=i-2),l}static _CreateWheelEvent(e,t,i,n,a,o){const l=this._CreateMouseEvent(e,t,i,n,a,o);switch(l.type="wheel",l.deltaMode=s.G.DOM_DELTA_PIXEL,l.deltaX=0,l.deltaY=0,l.deltaZ=0,i){case r.Fz.MouseWheelX:l.deltaX=n;break;case r.Fz.MouseWheelY:l.deltaY=n;break;case r.Fz.MouseWheelZ:l.deltaZ=n}return l}static _CreateMouseEvent(e,t,i,n,s,a){const o=this._CreateEvent(a),l=s.pollInput(e,t,r.Fz.Horizontal),u=s.pollInput(e,t,r.Fz.Vertical);return a?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-a.getBoundingClientRect().x,o.offsetY=o.movementY-a.getBoundingClientRect().y):(o.movementX=s.pollInput(e,t,r.FP.DeltaHorizontal),o.movementY=s.pollInput(e,t,r.FP.DeltaVertical),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,s),o.clientX=l,o.clientY=u,o.x=l,o.y=u,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,n){const s=this._CreateEvent(n);return this._CheckNonCharacterKeys(s,i),s.deviceType=r.Yi.Keyboard,s.deviceSlot=0,s.inputIndex=e,s.type=1===t?"keydown":"keyup",s.key=String.fromCharCode(e),s.keyCode=e,s}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(r.Yi.Keyboard),n=i&&1===t.pollInput(r.Yi.Keyboard,0,18),s=i&&1===t.pollInput(r.Yi.Keyboard,0,17),a=i&&(1===t.pollInput(r.Yi.Keyboard,0,91)||1===t.pollInput(r.Yi.Keyboard,0,92)||1===t.pollInput(r.Yi.Keyboard,0,93)),o=i&&1===t.pollInput(r.Yi.Keyboard,0,16);e.altKey=n,e.ctrlKey=s,e.metaKey=a,e.shiftKey=o}static _CreateEvent(e){const t={preventDefault:()=>{}};return t.target=e,t}}class o{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,((e,t,r,n)=>{const s=a.CreateDeviceEvent(e,t,r,n,this);i(e,t,s)})):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===r.Yi.Mouse||e===r.Yi.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}var l=i(80352),u=i(13514);const h=Object.keys(r.Fz).length/2;class c{constructor(e,t,i,r){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=u.w1.IsSafari(),this._usingMacOS=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=e=>{},this._keyboardUpEvent=e=>{},this._keyboardBlurEvent=e=>{},this._pointerMoveEvent=e=>{},this._pointerDownEvent=e=>{},this._pointerUpEvent=e=>{},this._pointerCancelEvent=e=>{},this._pointerWheelEvent=e=>{},this._pointerBlurEvent=e=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=l.MZ.IsNavigatorAvailable()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=e=>{},this._gamepadDisconnectedEvent=e=>{},this._eventPrefix=u.w1.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=r,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const n=this._inputs[e][t];if(!n)throw`Unable to find device ${r.Yi[e]}`;e>=r.Yi.DualShock&&e<=r.Yi.DualSense&&this._updateDevice(e,t,i);const s=n[i];if(void 0===s)throw`Unable to find input ${i} for device ${r.Yi[e]} in slot ${t}`;return i===r.Fz.Move&&u.w1.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),s}isDeviceAvailable(e){return void 0!==this._inputs[e]}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=null==this?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(const e of this._inputs)if(e)for(const t in e){const i=e[+t];if(i)for(let e=0;e<i.length;e++)i[e]=0}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(r.Yi.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,r){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,h);const n=this._inputs[e][t];n[0]=i,n[1]=r}_registerDevice(e,t,i){if(void 0===t)throw`Unable to register device ${r.Yi[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const r=new Array(i);r.fill(0),this._inputs[e][t]=r,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(r.Yi.Keyboard,0,255));const t=this._inputs[r.Yi.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&"Meta"!==e.key&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(r.Yi.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(r.Yi.Keyboard,0,255));const t=this._inputs[r.Yi.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&"Meta"===e.key&&this._metaKeys.length>0){for(const e of this._metaKeys){const i=a.CreateDeviceEvent(r.Yi.Keyboard,0,e,0,this,this._elementToAttachTo);t[e]=0,this._onInputChanged(r.Yi.Keyboard,0,i)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(r.Yi.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[r.Yi.Keyboard][0];for(let t=0;t<e.length;t++)if(0!==e[t]){e[t]=0;const i=a.CreateDeviceEvent(r.Yi.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(r.Yi.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=l.MZ.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let e=0;e<this._maxTouchPoints;e++)this._activeTouchIds[e]=-1;this._pointerMoveEvent=e=>{const t=this._getPointerType(e),i=t===r.Yi.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]||this._addPointerDevice(t,i,e.clientX,e.clientY);const n=this._inputs[t][i];if(n){const s=e;s.inputIndex=r.Fz.Move,n[r.Fz.Horizontal]=e.clientX,n[r.Fz.Vertical]=e.clientY,this._onInputChanged(t,i,s),this._usingSafari||-1===e.button||(s.inputIndex=e.button+2,n[e.button+2]=n[e.button+2]?0:1,this._onInputChanged(t,i,s))}},this._pointerDownEvent=e=>{const t=this._getPointerType(e);let i=t===r.Yi.Mouse?0:e.pointerId;if(t===r.Yi.Touch){const t=this._activeTouchIds.indexOf(-1);if(!(t>=0))return void u.w1.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=t,this._activeTouchIds[t]=e.pointerId}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]?t===r.Yi.Touch&&this._onDeviceConnected(t,i):this._addPointerDevice(t,i,e.clientX,e.clientY);const n=this._inputs[t][i];if(n){const s=n[r.Fz.Horizontal],a=n[r.Fz.Vertical];if(t===r.Yi.Mouse){if(-1===this._mouseId&&(void 0===e.pointerId?this._mouseId=this._isUsingFirefox?0:1:this._mouseId=e.pointerId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch(e){}}else if(e.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(e.pointerId)}catch(e){}n[r.Fz.Horizontal]=e.clientX,n[r.Fz.Vertical]=e.clientY,n[e.button+2]=1;const o=e;o.inputIndex=e.button+2,this._onInputChanged(t,i,o),s===e.clientX&&a===e.clientY||(o.inputIndex=r.Fz.Move,this._onInputChanged(t,i,o))}},this._pointerUpEvent=e=>{var t,i,n,s,a;const o=this._getPointerType(e),l=o===r.Yi.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(o===r.Yi.Touch){if(-1===l)return;this._activeTouchIds[l]=-1}const u=null===(t=this._inputs[o])||void 0===t?void 0:t[l];if(u&&0!==u[e.button+2]){const t=u[r.Fz.Horizontal],h=u[r.Fz.Vertical];u[r.Fz.Horizontal]=e.clientX,u[r.Fz.Vertical]=e.clientY,u[e.button+2]=0;const c=e;t===e.clientX&&h===e.clientY||(c.inputIndex=r.Fz.Move,this._onInputChanged(o,l,c)),c.inputIndex=e.button+2,o===r.Yi.Mouse&&this._mouseId>=0&&(null===(n=(i=this._elementToAttachTo).hasPointerCapture)||void 0===n?void 0:n.call(i,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):e.pointerId&&(null===(a=(s=this._elementToAttachTo).hasPointerCapture)||void 0===a?void 0:a.call(s,e.pointerId))&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._onInputChanged(o,l,c),o===r.Yi.Touch&&this._onDeviceDisconnected(o,l)}},this._pointerCancelEvent=e=>{var t,i,n,s;if("mouse"===e.pointerType){const e=this._inputs[r.Yi.Mouse][0];this._mouseId>=0&&(null===(i=(t=this._elementToAttachTo).hasPointerCapture)||void 0===i?void 0:i.call(t,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=r.Fz.LeftClick;t<=r.Fz.BrowserForward;t++)if(1===e[t]){e[t]=0;const i=a.CreateDeviceEvent(r.Yi.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(r.Yi.Mouse,0,i)}}else{const t=this._activeTouchIds.indexOf(e.pointerId);(null===(s=(n=this._elementToAttachTo).hasPointerCapture)||void 0===s?void 0:s.call(n,e.pointerId))&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._inputs[r.Yi.Touch][t][r.Fz.LeftClick]=0;const i=a.CreateDeviceEvent(r.Yi.Touch,t,r.Fz.LeftClick,0,this,this._elementToAttachTo,e.pointerId);this._onInputChanged(r.Yi.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(r.Yi.Touch,t)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch(e){}this._pointerBlurEvent=()=>{var e,t,i,n,s;if(this.isDeviceAvailable(r.Yi.Mouse)){const i=this._inputs[r.Yi.Mouse][0];this._mouseId>=0&&(null===(t=(e=this._elementToAttachTo).hasPointerCapture)||void 0===t?void 0:t.call(e,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let e=r.Fz.LeftClick;e<=r.Fz.BrowserForward;e++)if(1===i[e]){i[e]=0;const t=a.CreateDeviceEvent(r.Yi.Mouse,0,e,0,this,this._elementToAttachTo);this._onInputChanged(r.Yi.Mouse,0,t)}}if(this.isDeviceAvailable(r.Yi.Touch)){const e=this._inputs[r.Yi.Touch];for(let t=0;t<this._activeTouchIds.length;t++){const o=this._activeTouchIds[t];if((null===(n=(i=this._elementToAttachTo).hasPointerCapture)||void 0===n?void 0:n.call(i,o))&&this._elementToAttachTo.releasePointerCapture(o),-1!==o&&1===(null===(s=e[t])||void 0===s?void 0:s[r.Fz.LeftClick])){e[t][r.Fz.LeftClick]=0;const i=a.CreateDeviceEvent(r.Yi.Touch,t,r.Fz.LeftClick,0,this,this._elementToAttachTo,o);this._onInputChanged(r.Yi.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(r.Yi.Touch,t)}}}},this._pointerWheelEvent=e=>{const t=r.Yi.Mouse;this._inputs[t]||(this._inputs[t]=[]),this._inputs[t][0]||(this._pointerActive=!0,this._registerDevice(t,0,h));const i=this._inputs[t][0];if(i){i[r.Fz.MouseWheelX]=e.deltaX||0,i[r.Fz.MouseWheelY]=e.deltaY||e.wheelDelta||0,i[r.Fz.MouseWheelZ]=e.deltaZ||0;const n=e;0!==i[r.Fz.MouseWheelX]&&(n.inputIndex=r.Fz.MouseWheelX,this._onInputChanged(t,0,n)),0!==i[r.Fz.MouseWheelY]&&(n.inputIndex=r.Fz.MouseWheelY,this._onInputChanged(t,0,n)),0!==i[r.Fz.MouseWheelZ]&&(n.inputIndex=r.Fz.MouseWheelZ,this._onInputChanged(t,0,n))}},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!e&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add((()=>{if(this.isDeviceAvailable(r.Yi.Mouse)){const e=this._inputs[r.Yi.Mouse][0];e[r.Fz.MouseWheelX]=0,e[r.Fz.MouseWheelY]=0,e[r.Fz.MouseWheelZ]=0}}))}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const r=navigator.getGamepads()[t];if(r&&e===this._gamepads[t]){const n=this._inputs[e][t];i>=r.buttons.length?n[i]=r.axes[i-r.buttons.length].valueOf():n[i]=r.buttons[i].value}}_getGamepadDeviceType(e){return-1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?r.Yi.DualSense:r.Yi.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?r.Yi.Xbox:-1!==e.indexOf("057e")?r.Yi.Switch:r.Yi.Generic}_getPointerType(e){let t=r.Yi.Mouse;return("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=r.Yi.Touch),t}}var d=i(76503);class _{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=e=>{for(let t=0;t<this._devices.length;t++){const i=this._devices[t];for(const r in i){const i=+r;e._addDevice(new d.p(this._deviceInputSystem,t,i))}}this._registeredManagers.push(e)},this.unregisterManager=e=>{const t=this._registeredManagers.indexOf(e);t>-1&&this._registeredManagers.splice(t,1)};const t=Object.keys(r.Yi).length/2;this._devices=new Array(t);const i=(e,t)=>{this._devices[e]||(this._devices[e]=new Array),this._devices[e][t]||(this._devices[e][t]=t);for(const i of this._registeredManagers){const r=new d.p(this._deviceInputSystem,e,t);i._addDevice(r)}},n=(e,t)=>{var i;(null===(i=this._devices[e])||void 0===i?void 0:i[t])&&delete this._devices[e][t];for(const i of this._registeredManagers)i._removeDevice(e,t)},s=(e,t,i)=>{if(i)for(const r of this._registeredManagers)r._onInputChanged(e,t,i)};"undefined"!=typeof _native?this._deviceInputSystem=new o(i,n,s):this._deviceInputSystem=new c(e,i,n,s)}dispose(){this._deviceInputSystem.dispose()}}class p{getDeviceSource(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e]}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null}getDeviceSources(e){return this._devices[e]?this._devices[e].filter((e=>!!e)):[]}constructor(e){const t=Object.keys(r.Yi).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new _(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new n.y$((e=>{for(const t of this._devices)if(t)for(const i of t)i&&this.onDeviceConnectedObservable.notifyObserver(e,i)})),this.onDeviceDisconnectedObservable=new n.y$,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add((()=>{this.dispose()}))}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var i,r;const n=null===(i=this._devices[e])||void 0===i?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(n),(null===(r=this._devices[e])||void 0===r?void 0:r[t])&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){var r,n;null===(n=null===(r=this._devices[e])||void 0===r?void 0:r[t])||void 0===n||n.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case r.Yi.Keyboard:case r.Yi.Mouse:this._firstDevice[e]=0;break;case r.Yi.Touch:case r.Yi.DualSense:case r.Yi.DualShock:case r.Yi.Xbox:case r.Yi.Switch:case r.Yi.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t)for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}break}}}}},5185:(e,t,i)=>{i(33097),i(76503),i(58334)},21352:(e,t,i)=>{var r=i(61159);r.B.prototype.setAlphaConstants=function(e,t,i,r){this._alphaState.setAlphaBlendConstants(e,t,i,r)},r.B.prototype.setAlphaMode=function(e,t=!1){if(this._alphaMode!==e){switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}t||(this.depthCullingState.depthMask=0===e),this._alphaMode=e}else if(!t){const t=0===e;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}},r.B.prototype.getAlphaMode=function(){return this._alphaMode},r.B.prototype.setAlphaEquation=function(e){if(this._alphaEquation!==e){switch(e){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=e}},r.B.prototype.getAlphaEquation=function(){return this._alphaEquation}},34435:(e,t,i)=>{i.d(t,{t:()=>r});var r,n=i(61159);!function(e){e[e.Texture=0]="Texture",e[e.StorageTexture=1]="StorageTexture",e[e.UniformBuffer=2]="UniformBuffer",e[e.StorageBuffer=3]="StorageBuffer",e[e.TextureWithoutSampler=4]="TextureWithoutSampler",e[e.Sampler=5]="Sampler"}(r||(r={})),n.B.prototype.createComputeEffect=function(e,t){throw new Error("createComputeEffect: This engine does not support compute shaders!")},n.B.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")},n.B.prototype.createComputeContext=function(){},n.B.prototype.computeDispatch=function(e,t,i,r,n,s,a){throw new Error("computeDispatch: This engine does not support compute shaders!")},n.B.prototype.areAllComputeEffectsReady=function(){return!0},n.B.prototype.releaseComputeEffects=function(){},n.B.prototype._prepareComputePipelineContext=function(e,t,i,r,n){},n.B.prototype._rebuildComputeEffects=function(){},n.B.prototype._executeWhenComputeStateIsCompiled=function(e,t){t()},n.B.prototype._releaseComputeEffect=function(e){},n.B.prototype._deleteComputePipelineContext=function(e){}},90052:(e,t,i)=>{var r=i(61159),n=i(59157),s=i(84318),a=i(79245),o=i(54007);r.B.prototype._createDepthStencilCubeTexture=function(e,t,i){const r=new n.l(this,n.S.DepthStencil);if(r.isCube=!0,1===this.webGLVersion)return s.Y.Error("Depth cube texture is not supported by WebGL 1."),r;const a={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...t},o=this._gl;this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,r,!0),this._setupDepthStencilTexture(r,e,a.generateStencil,a.bilinearFiltering,a.comparisonFunction),i._depthStencilTexture=r,i._depthStencilTextureWithStencil=a.generateStencil;for(let t=0;t<6;t++)a.generateStencil?o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,o.DEPTH24_STENCIL8,e,e,0,o.DEPTH_STENCIL,o.UNSIGNED_INT_24_8,null):o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,o.DEPTH_COMPONENT24,e,e,0,o.DEPTH_COMPONENT,o.UNSIGNED_INT,null);return this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(r),r},r.B.prototype._partialLoadFile=function(e,t,i,r,n=null){this._loadFile(e,(e=>{i[t]=e,i._internalCount++,6===i._internalCount&&r(i)}),void 0,void 0,!0,((e,t)=>{n&&e&&n(e.status+" "+e.statusText,t)}))},r.B.prototype._cascadeLoadFiles=function(e,t,i,r=null){const n=[];n._internalCount=0;for(let e=0;e<6;e++)this._partialLoadFile(i[e],e,n,t,r)},r.B.prototype._cascadeLoadImgs=function(e,t,i,r,n=null,s){const a=[];a._internalCount=0;for(let o=0;o<6;o++)this._partialLoadImg(r[o],o,a,e,t,i,n,s)},r.B.prototype._partialLoadImg=function(e,t,i,r,n,s,l=null,u){const h=(0,o.f)();(0,a.r6)(e,(e=>{i[t]=e,i._internalCount++,r&&r.removePendingData(h),6===i._internalCount&&s&&s(n,i)}),((e,t)=>{r&&r.removePendingData(h),l&&l(e,t)}),r?r.offlineProvider:null,u),r&&r.addPendingData(h)},r.B.prototype._setCubeMapTextureParams=function(e,t,i){const r=this._gl;r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,t?r.LINEAR_MIPMAP_LINEAR:r.LINEAR),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),e.samplingMode=t?3:2,t&&this.getCaps().textureMaxLevel&&void 0!==i&&i>0&&(r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAX_LEVEL,i),e._maxLodLevel=i),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null)},r.B.prototype.createCubeTextureBase=function(e,t,i,a,o=null,l=null,u,h=null,c=!1,d=0,_=0,p=null,g=null,f=null,m=!1){const E=p||new n.l(this,n.S.Cube);E.isCube=!0,E.url=e,E.generateMipMaps=!a,E._lodGenerationScale=d,E._lodGenerationOffset=_,E._useSRGBBuffer=!!m&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!a),this._doNotHandleContextLost||(E._extension=h,E._files=i);const T=e;this._transformTextureUrl&&!p&&(e=this._transformTextureUrl(e));const x=e.split("?")[0],S=x.lastIndexOf("."),b=h||(S>-1?x.substring(S).toLowerCase():"");let R=null;for(const e of r.B._TextureLoaders)if(e.canLoad(b)){R=e;break}const A=(r,n)=>{e===T?l&&r&&l(r.status+" "+r.statusText,n):(s.Y.Warn(`Failed to load ${e}, falling back to the ${T}`),this.createCubeTextureBase(T,t,i,!!a,o,l,u,h,c,d,_,E,g,f,m))};if(R){const r=e=>{g&&g(E,e),R.loadCubeData(e,E,c,o,l)};i&&6===i.length?R.supportCascades?this._cascadeLoadFiles(t,(e=>r(e.map((e=>new Uint8Array(e))))),i,l):l?l("Textures type does not support cascades."):s.Y.Warn("Texture loader does not support cascades."):this._loadFile(e,(e=>r(new Uint8Array(e))),void 0,void 0,!0,A)}else{if(!i)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(t,E,((e,t)=>{f&&f(e,t)}),i,l)}return this._internalTexturesCache.push(E),E},r.B.prototype.createCubeTexture=function(e,t,i,n,a=null,o=null,l,u=null,h=!1,c=0,d=0,_=null,p,g=!1){const f=this._gl;return this.createCubeTextureBase(e,t,i,!!n,a,o,l,u,h,c,d,_,(e=>this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,e,!0)),((e,t)=>{const i=this.needPOTTextures?r.B.GetExponentOfTwo(t[0].width,this._caps.maxCubemapTextureSize):t[0].width,o=i,u=[f.TEXTURE_CUBE_MAP_POSITIVE_X,f.TEXTURE_CUBE_MAP_POSITIVE_Y,f.TEXTURE_CUBE_MAP_POSITIVE_Z,f.TEXTURE_CUBE_MAP_NEGATIVE_X,f.TEXTURE_CUBE_MAP_NEGATIVE_Y,f.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(!1);const h=l?this._getInternalFormat(l,e._useSRGBBuffer):e._useSRGBBuffer?f.SRGB8_ALPHA8:f.RGBA;let c=l?this._getInternalFormat(l):f.RGBA;e._useSRGBBuffer&&1===this.webGLVersion&&(c=h);for(let e=0;e<u.length;e++)if(t[e].width!==i||t[e].height!==o){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void s.Y.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=i,this._workingCanvas.height=o,this._workingContext.drawImage(t[e],0,0,t[e].width,t[e].height,0,0,i,o),f.texImage2D(u[e],0,h,c,f.UNSIGNED_BYTE,this._workingCanvas)}else f.texImage2D(u[e],0,h,c,f.UNSIGNED_BYTE,t[e]);n||f.generateMipmap(f.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(e,!n),e.width=i,e.height=o,e.isReady=!0,l&&(e.format=l),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),a&&a()}),!!g)}},89553:(e,t,i)=>{var r=i(61159);r.B.prototype.updateDynamicIndexBuffer=function(e,t,i=0){let r;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(e),r=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,r,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},r.B.prototype.updateDynamicVertexBuffer=function(e,t,i,r){this.bindArrayBuffer(e),void 0===i&&(i=0);const n=t.byteLength||t.length;void 0===r||r>=n&&0===i?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t).subarray(i,i+r)):(t=t instanceof ArrayBuffer?new Uint8Array(t,i,r):new Uint8Array(t.buffer,t.byteOffset+i,r),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)),this._resetVertexBufferBinding()}},25008:(e,t,i)=>{var r=i(61159),n=i(59157);r.B.prototype.createDynamicTexture=function(e,t,i,s){const a=new n.l(this,n.S.Dynamic);return a.baseWidth=e,a.baseHeight=t,i&&(e=this.needPOTTextures?r.B.GetExponentOfTwo(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?r.B.GetExponentOfTwo(t,this._caps.maxTextureSize):t),a.width=e,a.height=t,a.isReady=!1,a.generateMipMaps=i,a.samplingMode=s,this.updateTextureSamplingMode(s,a),this._internalTexturesCache.push(a),a},r.B.prototype.updateDynamicTexture=function(e,t,i,r=!1,n,s=!1,a=!1){if(!e)return;const o=this._gl,l=o.TEXTURE_2D,u=this._bindTextureDirectly(l,e,!0,s);this._unpackFlipY(void 0===i?e.invertY:i),r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const h=this._getWebGLTextureType(e.type),c=this._getInternalFormat(n||e.format),d=this._getRGBABufferInternalSizedFormat(e.type,c);o.texImage2D(l,0,d,c,h,t),e.generateMipMaps&&o.generateMipmap(l),u||this._bindTextureDirectly(l,null),r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),e.isReady=!0}},54904:(e,t,i)=>{var r=i(61159);r.B.prototype.createExternalTexture=function(e){return null},r.B.prototype.setExternalTexture=function(e,t){throw new Error("setExternalTexture: This engine does not support external textures!")}},17770:(e,t,i)=>{var r=i(59157),n=i(84318),s=i(61159);s.B.prototype.restoreSingleAttachment=function(){const e=this._gl;this.bindAttachments([e.BACK])},s.B.prototype.restoreSingleAttachmentForRenderTarget=function(){const e=this._gl;this.bindAttachments([e.COLOR_ATTACHMENT0])},s.B.prototype.buildTextureLayout=function(e){const t=this._gl,i=[];for(let r=0;r<e.length;r++)e[r]?i.push(t["COLOR_ATTACHMENT"+r]):i.push(t.NONE);return i},s.B.prototype.bindAttachments=function(e){this._gl.drawBuffers(e)},s.B.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){this._currentRenderTarget=null;const r=this._gl,n=e._attachments,s=n.length;if(e._MSAAFramebuffer){r.bindFramebuffer(r.READ_FRAMEBUFFER,e._MSAAFramebuffer),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,e._framebuffer);for(let t=0;t<s;t++){const i=e.textures[t];for(let e=0;e<s;e++)n[e]=r.NONE;n[t]=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"],r.readBuffer(n[t]),r.drawBuffers(n),r.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,r.COLOR_BUFFER_BIT,r.NEAREST)}for(let e=0;e<s;e++)n[e]=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];r.drawBuffers(n)}for(let i=0;i<s;i++){const n=e.textures[i];!n.generateMipMaps||t||n.isCube||(this._bindTextureDirectly(r.TEXTURE_2D,n,!0),r.generateMipmap(r.TEXTURE_2D),this._bindTextureDirectly(r.TEXTURE_2D,null))}i&&(e._MSAAFramebuffer&&this._bindUnboundFramebuffer(e._framebuffer),i()),this._bindUnboundFramebuffer(null)},s.B.prototype.createMultipleRenderTarget=function(e,t,i=!0){let s=!1,a=!0,o=!1,l=!1,u=15,h=1;let c=new Array,d=new Array,_=new Array;const p=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(s=void 0!==t.generateMipMaps&&t.generateMipMaps,a=void 0===t.generateDepthBuffer||t.generateDepthBuffer,o=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,l=void 0!==t.generateDepthTexture&&t.generateDepthTexture,h=t.textureCount||1,t.types&&(c=t.types),t.samplingModes&&(d=t.samplingModes),t.useSRGBBuffers&&(_=t.useSRGBBuffers),this.webGLVersion>1&&(13===t.depthTextureFormat||17===t.depthTextureFormat||16===t.depthTextureFormat||14===t.depthTextureFormat||18===t.depthTextureFormat)&&(u=t.depthTextureFormat));const g=this._gl,f=g.createFramebuffer();this._bindUnboundFramebuffer(f);const m=e.width||e,E=e.height||e,T=[],x=[],S=this.webGLVersion>1&&l&&(13===t.depthTextureFormat||17===t.depthTextureFormat||18===t.depthTextureFormat),b=this._setupFramebufferDepthAttachments(!S&&o,!l&&a,m,E);p._framebuffer=f,p._depthStencilBuffer=b,p._generateDepthBuffer=!l&&a,p._generateStencilBuffer=!S&&o,p._attachments=x;for(let e=0;e<h;e++){let t=d[e]||3,i=c[e]||0,a=_[e]||false;(1!==i||this._caps.textureFloatLinearFiltering)&&(2!==i||this._caps.textureHalfFloatLinearFiltering)||(t=1);const o=this._getSamplingParameters(t,s);1!==i||this._caps.textureFloat||(i=0,n.Y.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),a=a&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const l=new r.l(this,r.S.MultiRenderTarget),u=g[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];T.push(l),x.push(u),g.activeTexture(g["TEXTURE"+e]),g.bindTexture(g.TEXTURE_2D,l._hardwareTexture.underlyingResource),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,o.mag),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,o.min),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE);const h=this._getRGBABufferInternalSizedFormat(i,5,a);g.texImage2D(g.TEXTURE_2D,0,h,m,E,0,g.RGBA,this._getWebGLTextureType(i),null),g.framebufferTexture2D(g.DRAW_FRAMEBUFFER,u,g.TEXTURE_2D,l._hardwareTexture.underlyingResource,0),s&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(g.TEXTURE_2D,null),l.baseWidth=m,l.baseHeight=E,l.width=m,l.height=E,l.isReady=!0,l.samples=1,l.generateMipMaps=s,l.samplingMode=t,l.type=i,l._useSRGBBuffer=a,this._internalTexturesCache.push(l)}if(l&&this._caps.depthTextureExtension){const e=new r.l(this,r.S.Depth);let t=5,i=g.DEPTH_COMPONENT16,n=g.DEPTH_COMPONENT,a=g.UNSIGNED_SHORT,o=g.DEPTH_ATTACHMENT;this.webGLVersion<2?i=g.DEPTH_COMPONENT:14===u?(t=1,a=g.FLOAT,i=g.DEPTH_COMPONENT32F):18===u?(t=0,a=g.FLOAT_32_UNSIGNED_INT_24_8_REV,i=g.DEPTH32F_STENCIL8,n=g.DEPTH_STENCIL,o=g.DEPTH_STENCIL_ATTACHMENT):16===u?(t=0,a=g.UNSIGNED_INT,i=g.DEPTH_COMPONENT24,o=g.DEPTH_ATTACHMENT):13!==u&&17!==u||(t=12,a=g.UNSIGNED_INT_24_8,i=g.DEPTH24_STENCIL8,n=g.DEPTH_STENCIL,o=g.DEPTH_STENCIL_ATTACHMENT),g.activeTexture(g.TEXTURE0),g.bindTexture(g.TEXTURE_2D,e._hardwareTexture.underlyingResource),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.NEAREST),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.NEAREST),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE),g.texImage2D(g.TEXTURE_2D,0,i,m,E,0,n,a,null),g.framebufferTexture2D(g.FRAMEBUFFER,o,g.TEXTURE_2D,e._hardwareTexture.underlyingResource,0),e.baseWidth=m,e.baseHeight=E,e.width=m,e.height=E,e.isReady=!0,e.samples=1,e.generateMipMaps=s,e.samplingMode=1,e.format=u,e.type=t,T.push(e),this._internalTexturesCache.push(e)}return p.setTextures(T),i&&g.drawBuffers(x),this._bindUnboundFramebuffer(null),this.resetTextureCache(),p},s.B.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t,i=!0){if(this.webGLVersion<2||!e||!e.texture)return 1;if(e.samples===t)return t;const r=e._attachments.length;if(0===r)return 1;const n=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples);const s=!!e._depthStencilBuffer;if(s&&(n.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(n.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null),t>1&&"function"==typeof n.renderbufferStorageMultisample){const s=n.createFramebuffer();if(!s)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=s,this._bindUnboundFramebuffer(s);const a=[];for(let i=0;i<r;i++){const r=e.textures[i],s=r._hardwareTexture,o=n[this.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"],l=s._MSAARenderBuffer?this._updateRenderBuffer(s._MSAARenderBuffer,r.width,r.height,t,-1,this._getRGBAMultiSampleBufferFormat(r.type),o):this._createRenderBuffer(r.width,r.height,t,-1,this._getRGBAMultiSampleBufferFormat(r.type),o);if(!l)throw new Error("Unable to create multi sampled framebuffer");s._MSAARenderBuffer=l,r.samples=t,a.push(o)}i&&n.drawBuffers(a)}else this._bindUnboundFramebuffer(e._framebuffer);return s&&(e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.texture.width,e.texture.height,t)),this._bindUnboundFramebuffer(null),t}},74649:(e,t,i)=>{var r=i(2055),n=i(37290),s=i(65273),a=i(59157),o=i(58095),l=i(83353),u=i(19363),h=i(84319);function c(e,t){const i=new l.M(e,void 0,!0,t);return i.addUniform("viewProjection",16),i.addUniform("viewProjectionR",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}n.D.prototype.createMultiviewRenderTargetTexture=function(e,t){const i=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const r=this._createHardwareRenderTargetWrapper(!1,!1,{width:e,height:t});r._framebuffer=i.createFramebuffer();const n=new a.l(this,a.S.Unknown,!0);return n.width=e,n.height=t,n.isMultiview=!0,r._colorTextureArray=i.createTexture(),i.bindTexture(i.TEXTURE_2D_ARRAY,r._colorTextureArray),i.texStorage3D(i.TEXTURE_2D_ARRAY,1,i.RGBA8,e,t,2),r._depthStencilTextureArray=i.createTexture(),i.bindTexture(i.TEXTURE_2D_ARRAY,r._depthStencilTextureArray),i.texStorage3D(i.TEXTURE_2D_ARRAY,1,i.DEPTH24_STENCIL8,e,t,2),n.isReady=!0,r.setTextures(n),r._depthStencilTexture=n,r},n.D.prototype.bindMultiviewFramebuffer=function(e){const t=e,i=this._gl,r=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(t,void 0,void 0,void 0,!0),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),!t._colorTextureArray||!t._depthStencilTextureArray)throw"Invalid multiview frame buffer";this.getCaps().oculusMultiview?(r.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,t.samples,0,2),r.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,t._depthStencilTextureArray,0,t.samples,0,2)):(r.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,0,2),r.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,t._depthStencilTextureArray,0,0,2))},r.V.prototype._useMultiviewToSingleView=!1,r.V.prototype._multiviewTexture=null,r.V.prototype._resizeOrCreateMultiviewTexture=function(e,t){this._multiviewTexture?this._multiviewTexture.getRenderWidth()==e&&this._multiviewTexture.getRenderHeight()==t||(this._multiviewTexture.dispose(),this._multiviewTexture=new u.x(this.getScene(),{width:e,height:t})):this._multiviewTexture=new u.x(this.getScene(),{width:e,height:t})};const d=s.x.prototype.createSceneUniformBuffer;s.x.prototype._transformMatrixR=o.y3.Zero(),s.x.prototype._multiviewSceneUbo=null,s.x.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=c(this.getEngine(),"scene_multiview")},s.x.prototype.createSceneUniformBuffer=function(e){return this._multiviewSceneUbo?c(this.getEngine(),e):d.bind(this)(e)},s.x.prototype._updateMultiviewUbo=function(e,t){e&&t&&e.multiplyToRef(t,this._transformMatrixR),e&&t&&(e.multiplyToRef(t,o.jp.Matrix[0]),h.i.GetRightPlaneToRef(o.jp.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},s.x.prototype._renderMultiviewToSingleView=function(e){e._resizeOrCreateMultiviewTexture(e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.width>0?e._rigPostProcess.width:this.getEngine().getRenderWidth(!0),e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.height>0?e._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),e.outputRenderTarget=e._multiviewTexture,this._renderForCamera(e),e.outputRenderTarget=null;for(let t=0;t<e._rigCameras.length;t++){const i=this.getEngine();this._activeCamera=e._rigCameras[t],i.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}}},51392:(e,t,i)=>{var r=i(59157),n=i(84318),s=i(13514),a=i(61159);function o(e,t,i,r){let n,s=1;1===r?n=new Float32Array(t*i*4):2===r?(n=new Uint16Array(t*i*4),s=15360):n=7===r?new Uint32Array(t*i*4):new Uint8Array(t*i*4);for(let r=0;r<t;r++)for(let a=0;a<i;a++){const i=3*(a*t+r),o=4*(a*t+r);n[o+0]=e[i+0],n[o+1]=e[i+1],n[o+2]=e[i+2],n[o+3]=s}return n}function l(e){return function(t,i,n,s,a,o,l,u,h=null,c=0){const d=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,_=e?r.S.Raw3D:r.S.Raw2DArray,p=new r.l(this,_);p.baseWidth=i,p.baseHeight=n,p.baseDepth=s,p.width=i,p.height=n,p.depth=s,p.format=a,p.type=c,p.generateMipMaps=o,p.samplingMode=u,e?p.is3D=!0:p.is2DArray=!0,this._doNotHandleContextLost||(p._bufferView=t),e?this.updateRawTexture3D(p,t,a,l,h,c):this.updateRawTexture2DArray(p,t,a,l,h,c),this._bindTextureDirectly(d,p,!0);const g=this._getSamplingParameters(u,o);return this._gl.texParameteri(d,this._gl.TEXTURE_MAG_FILTER,g.mag),this._gl.texParameteri(d,this._gl.TEXTURE_MIN_FILTER,g.min),o&&this._gl.generateMipmap(d),this._bindTextureDirectly(d,null),this._internalTexturesCache.push(p),p}}function u(e){return function(t,i,r,n,s=null,a=0){const o=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(a),u=this._getInternalFormat(r),h=this._getRGBABufferInternalSizedFormat(a,r);this._bindTextureDirectly(o,t,!0),this._unpackFlipY(void 0===n||!!n),this._doNotHandleContextLost||(t._bufferView=i,t.format=r,t.invertY=n,t._compression=s),t.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&i?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[s],t.width,t.height,t.depth,0,i):this._gl.texImage3D(o,0,h,t.width,t.height,t.depth,0,u,l,i),t.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),t.isReady=!0}}a.B.prototype.updateRawTexture=function(e,t,i,r,n=null,s=0,a=!1){if(!e)return;const o=this._getRGBABufferInternalSizedFormat(s,i,a),l=this._getInternalFormat(i),u=this._getWebGLTextureType(s);this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._unpackFlipY(void 0===r||!!r),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.type=s,e.invertY=r,e._compression=n),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&t?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[n],e.width,e.height,0,t):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,e.width,e.height,0,l,u,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0},a.B.prototype.createRawTexture=function(e,t,i,n,s,a,o,l=null,u=0,h=0,c=!1){const d=new r.l(this,r.S.Raw);d.baseWidth=t,d.baseHeight=i,d.width=t,d.height=i,d.format=n,d.generateMipMaps=s,d.samplingMode=o,d.invertY=a,d._compression=l,d.type=u,d._useSRGBBuffer=this._getUseSRGBBuffer(c,!s),this._doNotHandleContextLost||(d._bufferView=e),this.updateRawTexture(d,e,n,a,l,u,d._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,d,!0);const _=this._getSamplingParameters(o,s);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,_.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,_.min),s&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(d),d},a.B.prototype.createRawCubeTexture=function(e,t,i,a,o,l,u,h=null){const c=this._gl,d=new r.l(this,r.S.CubeRaw);d.isCube=!0,d.format=i,d.type=a,this._doNotHandleContextLost||(d._bufferViewArray=e);const _=this._getWebGLTextureType(a);let p=this._getInternalFormat(i);p===c.RGB&&(p=c.RGBA),_!==c.FLOAT||this._caps.textureFloatLinearFiltering?_!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?_!==c.FLOAT||this._caps.textureFloatRender?_!==c.HALF_FLOAT||this._caps.colorBufferFloat||(o=!1,n.Y.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(o=!1,n.Y.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(o=!1,u=1,n.Y.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(o=!1,u=1,n.Y.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const g=t,f=g;d.width=g,d.height=f,d.invertY=l,d._compression=h;if(!this.needPOTTextures||s.w1.IsExponentOfTwo(d.width)&&s.w1.IsExponentOfTwo(d.height)||(o=!1),e)this.updateRawCubeTexture(d,e,i,a,l,h);else{const e=this._getRGBABufferInternalSizedFormat(a),t=0;this._bindTextureDirectly(c.TEXTURE_CUBE_MAP,d,!0);for(let i=0;i<6;i++)h?c.compressedTexImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+i,t,this.getCaps().s3tc[h],d.width,d.height,0,void 0):c.texImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+i,t,e,d.width,d.height,0,p,_,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,d,!0),e&&o&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const m=this._getSamplingParameters(u,o);return c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MAG_FILTER,m.mag),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MIN_FILTER,m.min),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),this._bindTextureDirectly(c.TEXTURE_CUBE_MAP,null),d.generateMipMaps=o,d.samplingMode=u,d.isReady=!0,d},a.B.prototype.updateRawCubeTexture=function(e,t,i,r,n,a=null,l=0){e._bufferViewArray=t,e.format=i,e.type=r,e.invertY=n,e._compression=a;const u=this._gl,h=this._getWebGLTextureType(r);let c=this._getInternalFormat(i);const d=this._getRGBABufferInternalSizedFormat(r);let _=!1;c===u.RGB&&(c=u.RGBA,_=!0),this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(void 0===n||!!n),e.width%4!=0&&u.pixelStorei(u.UNPACK_ALIGNMENT,1);for(let i=0;i<6;i++){let n=t[i];a?u.compressedTexImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+i,l,this.getCaps().s3tc[a],e.width,e.height,0,n):(_&&(n=o(n,e.width,e.height,r)),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+i,l,d,e.width,e.height,0,c,h,n))}(!this.needPOTTextures||s.w1.IsExponentOfTwo(e.width)&&s.w1.IsExponentOfTwo(e.height))&&e.generateMipMaps&&0===l&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),e.isReady=!0},a.B.prototype.createRawCubeTextureFromUrl=function(e,t,i,r,n,s,a,l,u=null,h=null,c=3,d=!1){const _=this._gl,p=this.createRawCubeTexture(null,i,r,n,!s,d,c,null);null==t||t.addPendingData(p),p.url=e,this._internalTexturesCache.push(p);const g=e=>{const i=p.width,s=a(e);if(s){if(l){const e=this._getWebGLTextureType(n);let t=this._getInternalFormat(r);const a=this._getRGBABufferInternalSizedFormat(n);let u=!1;t===_.RGB&&(t=_.RGBA,u=!0),this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,p,!0),this._unpackFlipY(!1);const h=l(s);for(let r=0;r<h.length;r++){const s=i>>r;for(let i=0;i<6;i++){let l=h[r][i];u&&(l=o(l,s,s,n)),_.texImage2D(i,r,a,s,s,0,t,e,l)}}this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(p,s,r,n,d);p.isReady=!0,null==t||t.removePendingData(p),p.onLoadedObservable.notifyObservers(p),p.onLoadedObservable.clear(),u&&u()}};return this._loadFile(e,(e=>{g(e)}),void 0,null==t?void 0:t.offlineProvider,!0,((e,i)=>{null==t||t.removePendingData(p),h&&e&&h(e.status+" "+e.statusText,i)})),p},a.B.prototype.createRawTexture2DArray=l(!1),a.B.prototype.createRawTexture3D=l(!0),a.B.prototype.updateRawTexture2DArray=u(!1),a.B.prototype.updateRawTexture3D=u(!0)},5382:(e,t,i)=>{i.d(t,{A:()=>n});var r=i(61159);function n(e,t,i=!1,r){switch(e){case 3:{const e=(ArrayBuffer,new Int8Array(t));return r&&e.set(new Int8Array(r)),e}case 0:{const e=(ArrayBuffer,new Uint8Array(t));return r&&e.set(new Uint8Array(r)),e}case 4:{const e=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(i?t/2:t);return r&&e.set(new Int16Array(r)),e}case 5:case 8:case 9:case 10:case 2:{const e=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(i?t/2:t);return r&&e.set(new Uint16Array(r)),e}case 6:{const e=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(i?t/4:t);return r&&e.set(new Int32Array(r)),e}case 7:case 11:case 12:case 13:case 14:case 15:{const e=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(i?t/4:t);return r&&e.set(new Uint32Array(r)),e}case 1:{const e=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(i?t/4:t);return r&&e.set(new Float32Array(r)),e}}const n=(ArrayBuffer,new Uint8Array(t));return r&&n.set(new Uint8Array(r)),n}r.B.prototype._readTexturePixelsSync=function(e,t,i,r=-1,s=0,a=null,o=!0,l=!1,u=0,h=0){var c,d;const _=this._gl;if(!_)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const e=_.createFramebuffer();if(!e)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=e}_.bindFramebuffer(_.FRAMEBUFFER,this._dummyFramebuffer),r>-1?_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+r,null===(c=e._hardwareTexture)||void 0===c?void 0:c.underlyingResource,s):_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,null===(d=e._hardwareTexture)||void 0===d?void 0:d.underlyingResource,s);let p=void 0!==e.type?this._getWebGLTextureType(e.type):_.UNSIGNED_BYTE;if(l)a||(a=n(e.type,4*t*i));else if(p===_.UNSIGNED_BYTE)a||(a=new Uint8Array(4*t*i)),p=_.UNSIGNED_BYTE;else a||(a=new Float32Array(4*t*i)),p=_.FLOAT;return o&&this.flushFramebuffer(),_.readPixels(u,h,t,i,_.RGBA,p,a),_.bindFramebuffer(_.FRAMEBUFFER,this._currentFramebuffer),a},r.B.prototype._readTexturePixels=function(e,t,i,r=-1,n=0,s=null,a=!0,o=!1,l=0,u=0){return Promise.resolve(this._readTexturePixelsSync(e,t,i,r,n,s,a,o,l,u))}},13534:(e,t,i)=>{var r=i(59157),n=i(84318),s=i(61159),a=i(73005);class o extends a.r{constructor(e,t,i,r,n){super(e,t,i,r),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._context=n}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}_shareDepth(e){super._shareDepth(e);const t=this._context,i=this._depthStencilBuffer,r=e._MSAAFramebuffer||e._framebuffer;e._depthStencilBuffer&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=this._depthStencilBuffer,this._engine._bindUnboundFramebuffer(r),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i),this._engine._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i=-1,r=0){if(!e._hardwareTexture)return;const n=this._context,s=this._framebuffer,a=this._engine._currentFramebuffer;this._engine._bindUnboundFramebuffer(s);const o=n[this._engine.webGLVersion>1?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"],l=-1!==i?n.TEXTURE_CUBE_MAP_POSITIVE_X+i:n.TEXTURE_2D;n.framebufferTexture2D(n.FRAMEBUFFER,o,l,e._hardwareTexture.underlyingResource,r),this._engine._bindUnboundFramebuffer(a)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}dispose(e=!1){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}s.B.prototype._createHardwareRenderTargetWrapper=function(e,t,i){const r=new o(e,t,i,this,this._gl);return this._renderTargetWrapperCache.push(r),r},s.B.prototype.createRenderTargetTexture=function(e,t){var i,n;const s=this._createHardwareRenderTargetWrapper(!1,!1,e);let a,o=!0,l=!1,u=!1,h=1;void 0!==t&&"object"==typeof t&&(o=null===(i=t.generateDepthBuffer)||void 0===i||i,l=!!t.generateStencilBuffer,u=!!t.noColorAttachment,a=t.colorAttachment,h=null!==(n=t.samples)&&void 0!==n?n:1);const c=a||(u?null:this._createInternalTexture(e,t,!0,r.S.RenderTarget)),d=e.width||e,_=e.height||e,p=this._currentFramebuffer,g=this._gl,f=g.createFramebuffer();return this._bindUnboundFramebuffer(f),s._depthStencilBuffer=this._setupFramebufferDepthAttachments(l,o,d,_),c&&!c.is2DArray&&g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_2D,c._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(p),s._framebuffer=f,s._generateDepthBuffer=o,s._generateStencilBuffer=l,s.setTextures(c),this.updateRenderTargetTextureSampleCount(s,h),s},s.B.prototype.createDepthStencilTexture=function(e,t,i){if(t.isCube){const r=e.width||e;return this._createDepthStencilCubeTexture(r,t,i)}return this._createDepthStencilTexture(e,t,i)},s.B.prototype._createDepthStencilTexture=function(e,t,i){const s=this._gl,a=e.layers||0,o=0!==a?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,l=new r.l(this,r.S.DepthStencil);if(!this._caps.depthTextureExtension)return n.Y.Error("Depth texture is not supported by your browser or hardware."),l;const u={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...t};if(this._bindTextureDirectly(o,l,!0),this._setupDepthStencilTexture(l,e,u.generateStencil,0!==u.comparisonFunction&&u.bilinearFiltering,u.comparisonFunction,u.samples),void 0!==u.depthTextureFormat){if(15!==u.depthTextureFormat&&16!==u.depthTextureFormat&&17!==u.depthTextureFormat&&13!==u.depthTextureFormat&&14!==u.depthTextureFormat&&18!==u.depthTextureFormat)return n.Y.Error("Depth texture format is not supported."),l;l.format=u.depthTextureFormat}else l.format=u.generateStencil?13:16;const h=17===l.format||13===l.format||18===l.format;i._depthStencilTexture=l,i._depthStencilTextureWithStencil=h;let c=s.UNSIGNED_INT;15===l.format?c=s.UNSIGNED_SHORT:17===l.format||13===l.format?c=s.UNSIGNED_INT_24_8:14===l.format?c=s.FLOAT:18===l.format&&(c=s.FLOAT_32_UNSIGNED_INT_24_8_REV);const d=h?s.DEPTH_STENCIL:s.DEPTH_COMPONENT;let _=d;this.webGLVersion>1&&(15===l.format?_=s.DEPTH_COMPONENT16:16===l.format?_=s.DEPTH_COMPONENT24:17===l.format||13===l.format?_=s.DEPTH24_STENCIL8:14===l.format?_=s.DEPTH_COMPONENT32F:18===l.format&&(_=s.DEPTH32F_STENCIL8)),l.is2DArray?s.texImage3D(o,0,_,l.width,l.height,a,0,d,c,null):s.texImage2D(o,0,_,l.width,l.height,0,d,c,null),this._bindTextureDirectly(o,null),this._internalTexturesCache.push(l);const p=i;if(p._depthStencilBuffer){const e=this._currentFramebuffer;this._bindUnboundFramebuffer(p._framebuffer),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,null),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,null),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.STENCIL_ATTACHMENT,s.RENDERBUFFER,null),this._bindUnboundFramebuffer(e),s.deleteRenderbuffer(p._depthStencilBuffer),p._depthStencilBuffer=null}return l},s.B.prototype.updateRenderTargetTextureSampleCount=function(e,t){if(this.webGLVersion<2||!e||!e.texture)return 1;if(e.samples===t)return t;const i=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(i.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(i.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);const r=e.texture._hardwareTexture;if(r._MSAARenderBuffer&&(i.deleteRenderbuffer(r._MSAARenderBuffer),r._MSAARenderBuffer=null),t>1&&"function"==typeof i.renderbufferStorageMultisample){const n=i.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=n,this._bindUnboundFramebuffer(e._MSAAFramebuffer);const s=this._createRenderBuffer(e.texture.width,e.texture.height,t,-1,this._getRGBAMultiSampleBufferFormat(e.texture.type),i.COLOR_ATTACHMENT0,!1);if(!s)throw new Error("Unable to create multi sampled framebuffer");r._MSAARenderBuffer=s}else this._bindUnboundFramebuffer(e._framebuffer);return e.texture.samples=t,e._samples=t,e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.texture.width,e.texture.height,t),this._bindUnboundFramebuffer(null),t}},74500:(e,t,i)=>{var r=i(59157),n=i(84318);i(61159).B.prototype.createRenderTargetCubeTexture=function(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!0,e),s={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...t};s.generateStencilBuffer=s.generateDepthBuffer&&s.generateStencilBuffer,(1!==s.type||this._caps.textureFloatLinearFiltering)&&(2!==s.type||this._caps.textureHalfFloatLinearFiltering)||(s.samplingMode=1);const a=this._gl,o=new r.l(this,r.S.RenderTarget);this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,o,!0);const l=this._getSamplingParameters(s.samplingMode,s.generateMipMaps);1!==s.type||this._caps.textureFloat||(s.type=0,n.Y.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,l.mag),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,l.min),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);for(let t=0;t<6;t++)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this._getRGBABufferInternalSizedFormat(s.type,s.format),e,e,0,this._getInternalFormat(s.format),this._getWebGLTextureType(s.type),null);const u=a.createFramebuffer();return this._bindUnboundFramebuffer(u),i._depthStencilBuffer=this._setupFramebufferDepthAttachments(s.generateStencilBuffer,s.generateDepthBuffer,e,e),s.generateMipMaps&&a.generateMipmap(a.TEXTURE_CUBE_MAP),this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),i._framebuffer=u,i._generateDepthBuffer=s.generateDepthBuffer,i._generateStencilBuffer=s.generateStencilBuffer,o.width=e,o.height=e,o.isReady=!0,o.isCube=!0,o.samples=1,o.generateMipMaps=s.generateMipMaps,o.samplingMode=s.samplingMode,o.type=s.type,o.format=s.format,this._internalTexturesCache.push(o),i.setTextures(o),i}},78459:(e,t,i)=>{var r=i(61159),n=i(21254);r.B.prototype.createUniformBuffer=function(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create uniform buffer");const i=new n.M(t);return this.bindUniformBuffer(i),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),i.references=1,i},r.B.prototype.createDynamicUniformBuffer=function(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create dynamic uniform buffer");const i=new n.M(t);return this.bindUniformBuffer(i),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),i.references=1,i},r.B.prototype.updateUniformBuffer=function(e,t,i,r){this.bindUniformBuffer(e),void 0===i&&(i=0),void 0===r?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(i,i+r)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(i,i+r)),this.bindUniformBuffer(null)},r.B.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e?e.underlyingResource:null)},r.B.prototype.bindUniformBufferBase=function(e,t,i){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e?e.underlyingResource:null)},r.B.prototype.bindUniformBlock=function(e,t,i){const r=e.program,n=this._gl.getUniformBlockIndex(r,t);4294967295!==n&&this._gl.uniformBlockBinding(r,n,i)}},52858:(e,t,i)=>{i(61159).B.prototype.updateVideoTexture=function(e,t,i){if(!e||e._isDisabled)return;const r=this._getInternalFormat(e.format),n=this._getRGBABufferInternalSizedFormat(0,e.format),s=this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0);this._unpackFlipY(!i);try{if(void 0===this._videoTextureSupported&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,r,this._gl.UNSIGNED_BYTE,t),0!==this._gl.getError()?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,r,this._gl.UNSIGNED_BYTE,t);else{if(!e._workingCanvas){e._workingCanvas=this.createCanvas(e.width,e.height);const t=e._workingCanvas.getContext("2d");if(!t)throw new Error("Unable to get 2d context");e._workingContext=t,e._workingCanvas.width=e.width,e._workingCanvas.height=e.height}e._workingContext.clearRect(0,0,e.width,e.height),e._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,e.width,e.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,r,this._gl.UNSIGNED_BYTE,e._workingCanvas)}e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),s||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0}catch(t){e._isDisabled=!0}}},99986:(e,t,i)=>{var r=i(37290),n=i(76144),s=i(62897),a=i(13514),o=i(80352);Object.defineProperty(r.D.prototype,"isInVRExclusivePointerMode",{get:function(){return this._vrExclusivePointerMode},enumerable:!0,configurable:!0}),r.D.prototype._prepareVRComponent=function(){this._vrSupported=!1,this._vrExclusivePointerMode=!1,this.onVRDisplayChangedObservable=new s.y$,this.onVRRequestPresentComplete=new s.y$,this.onVRRequestPresentStart=new s.y$},r.D.prototype.isVRDevicePresent=function(){return!!this._vrDisplay},r.D.prototype.getVRDevice=function(){return this._vrDisplay},r.D.prototype.initWebVR=function(){return this.initWebVRAsync(),this.onVRDisplayChangedObservable},r.D.prototype.initWebVRAsync=function(){const e=()=>{const e={vrDisplay:this._vrDisplay,vrSupported:this._vrSupported};this.onVRDisplayChangedObservable.notifyObservers(e),this._webVRInitPromise=new Promise((t=>{t(e)}))};if(!this._onVrDisplayConnect){this._onVrDisplayConnect=t=>{this._vrDisplay=t.display,e()},this._onVrDisplayDisconnect=()=>{this._vrDisplay.cancelAnimationFrame(this._frameHandler),this._vrDisplay=void 0,this._frameHandler=r.D.QueueNewFrame(this._boundRenderFunction),e()},this._onVrDisplayPresentChange=()=>{this._vrExclusivePointerMode=this._vrDisplay&&this._vrDisplay.isPresenting};const t=this.getHostWindow();t&&(t.addEventListener("vrdisplayconnect",this._onVrDisplayConnect),t.addEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),t.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange))}return this._webVRInitPromise=this._webVRInitPromise||this._getVRDisplaysAsync(),this._webVRInitPromise.then(e),this._webVRInitPromise},r.D.prototype._getVRDisplaysAsync=function(){return new Promise((e=>{navigator.getVRDisplays?navigator.getVRDisplays().then((t=>{this._vrSupported=!0,this._vrDisplay=t[0],e({vrDisplay:this._vrDisplay,vrSupported:this._vrSupported})})):(this._vrDisplay=void 0,this._vrSupported=!1,e({vrDisplay:this._vrDisplay,vrSupported:this._vrSupported}))}))},r.D.prototype.enableVR=function(e){if(this._vrDisplay&&!this._vrDisplay.isPresenting){const t=()=>{this.onVRRequestPresentComplete.notifyObservers(!0),this._onVRFullScreenTriggered()},i=()=>{this.onVRRequestPresentComplete.notifyObservers(!1)};this.onVRRequestPresentStart.notifyObservers(this);const r={highRefreshRate:!!this.vrPresentationAttributes&&this.vrPresentationAttributes.highRefreshRate,foveationLevel:this.vrPresentationAttributes?this.vrPresentationAttributes.foveationLevel:1,multiview:(this.getCaps().multiview||this.getCaps().oculusMultiview)&&e.useMultiview};this._vrDisplay.requestPresent([{source:this.getRenderingCanvas(),attributes:r,...r}]).then(t).catch(i)}},r.D.prototype._onVRFullScreenTriggered=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting){this._oldSize=new n.$(this.getRenderWidth(),this.getRenderHeight()),this._oldHardwareScaleFactor=this.getHardwareScalingLevel();const e=this._vrDisplay.getEyeParameters("left");this.setHardwareScalingLevel(1),this.setSize(2*e.renderWidth,e.renderHeight)}else this.setHardwareScalingLevel(this._oldHardwareScaleFactor),this.setSize(this._oldSize.width,this._oldSize.height)},r.D.prototype.disableVR=function(){this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.exitPresent().then((()=>this._onVRFullScreenTriggered())).catch((()=>this._onVRFullScreenTriggered())),(0,o.CG)()&&(window.removeEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted),window.removeEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted),this._onVrDisplayConnect&&(window.removeEventListener("vrdisplayconnect",this._onVrDisplayConnect),this._onVrDisplayDisconnect&&window.removeEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),this._onVrDisplayPresentChange&&window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),this._onVrDisplayConnect=null,this._onVrDisplayDisconnect=null))},r.D.prototype._connectVREvents=function(e,t){if(this._onVRDisplayPointerRestricted=()=>{e&&e.requestPointerLock()},this._onVRDisplayPointerUnrestricted=()=>{if(t)t.exitPointerLock&&t.exitPointerLock();else{const e=this.getHostWindow();e.document&&e.document.exitPointerLock&&e.document.exitPointerLock()}},(0,o.CG)()){const e=this.getHostWindow();e.addEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted,!1),e.addEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted,!1)}},r.D.prototype._submitVRFrame=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting)try{this._vrDisplay.submitFrame()}catch(e){a.w1.Warn("webVR submitFrame has had an unexpected failure: "+e)}},r.D.prototype.isVRPresenting=function(){return this._vrDisplay&&this._vrDisplay.isPresenting},r.D.prototype._requestVRFrame=function(){this._frameHandler=r.D.QueueNewFrame(this._boundRenderFunction,this._vrDisplay)}},72759:(e,t,i)=>{i.d(t,{e:()=>r});class r{constructor(){const e=new ArrayBuffer(r.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(e),this._int32s=new Int32Array(e),this._float32s=new Float32Array(e),this._length=r.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream((()=>{this._flush()}))}writeUint32(e){this._flushIfNecessary(1),this._uint32s[this._position++]=e}writeInt32(e){this._flushIfNecessary(1),this._int32s[this._position++]=e}writeFloat32(e){this._flushIfNecessary(1),this._float32s[this._position++]=e}writeUint32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._uint32s.set(e,this._position),this._position+=e.length}writeInt32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._int32s.set(e,this._position),this._position+=e.length}writeFloat32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._float32s.set(e,this._position),this._position+=e.length}writeNativeData(e){this._flushIfNecessary(e.length),this._uint32s.set(e,this._position),this._position+=e.length}writeBoolean(e){this.writeUint32(e?1:0)}_flushIfNecessary(e){this._position+e>this._length&&this._flush()}_flush(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0}}r.DEFAULT_BUFFER_SIZE=65536},21634:(e,t,i)=>{i.d(t,{E:()=>r});class r{get underlyingResource(){return this._nativeTexture}constructor(e,t){this._engine=t,this.set(e)}setUsage(){}set(e){this._nativeTexture=e}reset(){this._nativeTexture=null}release(){this._nativeTexture&&this._engine.deleteTexture(this._nativeTexture),this.reset()}}},45095:(e,t,i)=>{i.d(t,{G:()=>r});class r{_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}_handlesSpectorRebuildCallback(e){throw new Error("Not implemented")}constructor(e){this.isAsync=!1,this.isReady=!1,this._valueCache={},this._engine=e}_fillEffectInformation(e,t,i,r,n,s,a,o){const l=this._engine;if(l.supportsUniformBuffers)for(const i in t)e.bindUniformBlock(i,t[i]);let u;for(this._engine.getUniforms(this,i).forEach(((e,t)=>{r[i[t]]=e})),this._uniforms=r,u=0;u<n.length;u++){null==e.getUniform(n[u])&&(n.splice(u,1),u--)}n.forEach(((e,t)=>{s[e]=t})),o.push(...l.getAttributes(this,a))}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],r=t.updateFlag;return(void 0===i||i!==r)&&(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r)return r=[t,i],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==i&&(r[1]=i,n=!0),n}_cacheFloat3(e,t,i,r){let n=this._valueCache[e];if(!n)return n=[t,i,r],this._valueCache[e]=n,!0;let s=!1;return n[0]!==t&&(n[0]=t,s=!0),n[1]!==i&&(n[1]=i,s=!0),n[2]!==r&&(n[2]=r,s=!0),s}_cacheFloat4(e,t,i,r,n){let s=this._valueCache[e];if(!s)return s=[t,i,r,n],this._valueCache[e]=s,!0;let a=!1;return s[0]!==t&&(s[0]=t,a=!0),s[1]!==i&&(s[1]=i,a=!0),s[2]!==r&&(s[2]=r,a=!0),s[3]!==n&&(s[3]=n,a=!0),a}setInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setInt4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this._engine.setInt4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setUInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setUInt4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this._engine.setUInt4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this._engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this._engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this._engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this._engine.setUIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this._engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this._engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this._engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this._engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this._engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this._engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this._engine.setFloat4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}}},16837:(e,t,i)=>{i.d(t,{o:()=>n});var r=i(73005);class n extends r.r{get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}constructor(e,t,i,r){super(e,t,i,r),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=r}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}}},57710:(e,t,i)=>{i.d(t,{Z:()=>n});var r=i(31259);class n{get code(){return this._sourceCode}constructor(e,t=20){this.debug=!1,this._sourceCode=e,this._numMaxIterations=t,this._functionDescr=[],this.inlineToken="#define inline"}processCode(){this.debug&&this._sourceCode.length,this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug}_collectFunctions(){let e=0;for(;e<this._sourceCode.length;){const t=this._sourceCode.indexOf(this.inlineToken,e);if(t<0)break;const i=this._sourceCode.indexOf("(",t+this.inlineToken.length);if(i<0){this.debug&&console.warn(`Could not find the opening parenthesis after the token. startIndex=${e}`),e=t+this.inlineToken.length;continue}const s=n._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(t+this.inlineToken.length,i));if(!s){this.debug&&console.warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(t+this.inlineToken.length,i)}`),e=t+this.inlineToken.length;continue}const[a,o]=[s[3],s[4]],l=(0,r.vt)("(",")",this._sourceCode,i);if(l<0){this.debug&&console.warn(`Could not extract the parameters the function '${o}' (type=${a}). funcParamsStartIndex=${i}`),e=t+this.inlineToken.length;continue}const u=this._sourceCode.substring(i+1,l),h=(0,r.Pm)(this._sourceCode,l+1);if(h===this._sourceCode.length){this.debug&&console.warn(`Could not extract the body of the function '${o}' (type=${a}). funcParamsEndIndex=${l}`),e=t+this.inlineToken.length;continue}const c=(0,r.vt)("{","}",this._sourceCode,h);if(c<0){this.debug&&console.warn(`Could not extract the body of the function '${o}' (type=${a}). funcBodyStartIndex=${h}`),e=t+this.inlineToken.length;continue}const d=this._sourceCode.substring(h,c+1),_=(0,r.Kt)(u).split(","),p=[];for(let e=0;e<_.length;++e){const t=_[e].trim(),i=t.lastIndexOf(" ");i>=0&&p.push(t.substring(i+1))}"void"!==a&&p.push("return"),this._functionDescr.push({name:o,type:a,parameters:p,body:d,callIndex:0}),e=c+1;const g=t>0?this._sourceCode.substring(0,t):"",f=c+1<this._sourceCode.length-1?this._sourceCode.substring(c+1):"";this._sourceCode=g+f,e-=c+1-t}this.debug&&(this._functionDescr.length,this._functionDescr)}_processInlining(e=20){for(;e-- >=0&&this._replaceFunctionCallsByCode(););return this.debug,e>=0}_replaceFunctionCallsByCode(){let e=!1;for(const t of this._functionDescr){const{name:i,type:n,parameters:s,body:a}=t;let o=0;for(;o<this._sourceCode.length;){const l=this._sourceCode.indexOf(i,o);if(l<0)break;if(0===l||(0,r.uA)(this._sourceCode.charAt(l-1))){o=l+i.length;continue}const u=(0,r.Pm)(this._sourceCode,l+i.length);if(u===this._sourceCode.length||"("!==this._sourceCode.charAt(u)){o=l+i.length;continue}const h=(0,r.vt)("(",")",this._sourceCode,u);if(h<0){this.debug&&console.warn(`Could not extract the parameters of the function call. Function '${i}' (type=${n}). callParamsStartIndex=${u}`),o=l+i.length;continue}const c=this._sourceCode.substring(u+1,h),d=e=>{const t=[];let i=0,n=0;for(;i<e.length;){if("("===e.charAt(i)){const t=(0,r.vt)("(",")",e,i);if(t<0)return null;i=t}else","===e.charAt(i)&&(t.push(e.substring(n,i)),n=i+1);i++}return n<i&&t.push(e.substring(n,i)),t},_=d((0,r.Kt)(c));if(null===_){this.debug&&console.warn(`Invalid function call: can't extract the parameters of the function call. Function '${i}' (type=${n}). callParamsStartIndex=${u}, callParams=`+c),o=l+i.length;continue}const p=[];for(let e=0;e<_.length;++e){const t=_[e].trim();p.push(t)}const g="void"!==n?i+"_"+t.callIndex++:null;if(g&&p.push(g+" ="),p.length!==s.length){this.debug&&console.warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${i}' (type=${n}). function parameters=${s}, call parameters=${p}`),o=l+i.length;continue}o=h+1;const f=this._replaceNames(a,s,p);let m=l>0?this._sourceCode.substring(0,l):"";const E=h+1<this._sourceCode.length-1?this._sourceCode.substring(h+1):"";if(g){const e=(0,r.wm)(this._sourceCode,l-1,"\n");m=this._sourceCode.substring(0,e+1);const t=this._sourceCode.substring(e+1,l);this._sourceCode=m+n+" "+g+";\n"+f+"\n"+t+g+E,this.debug}else this._sourceCode=m+f+E,o+=f.length-(h+1-l),this.debug;e=!0}}return e}_replaceNames(e,t,i){for(let n=0;n<t.length;++n){const s=new RegExp((0,r.AW)(t[n]),"g"),a=t[n].length,o=i[n];e=e.replace(s,((i,...s)=>{const l=s[0];return(0,r.uA)(e.charAt(l-1))||(0,r.uA)(e.charAt(l+a))?t[n]:o}))}return e}}n._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/},91153:(e,t,i)=>{i.d(t,{L:()=>m});class r{constructor(){this.children=[]}isValid(e){return!0}process(e,t){var i,r,n,s,a,o;let l="";if(this.line){let u=this.line;const h=t.processor;if(h){h.lineProcessor&&(u=h.lineProcessor(u,t.isFragment,t.processingContext));const l=null!==(r=null===(i=t.processor)||void 0===i?void 0:i.attributeKeywordName)&&void 0!==r?r:"attribute",c=t.isFragment&&(null===(n=t.processor)||void 0===n?void 0:n.varyingFragmentKeywordName)?null===(s=t.processor)||void 0===s?void 0:s.varyingFragmentKeywordName:!t.isFragment&&(null===(a=t.processor)||void 0===a?void 0:a.varyingVertexKeywordName)?null===(o=t.processor)||void 0===o?void 0:o.varyingVertexKeywordName:"varying";if(!t.isFragment&&h.attributeProcessor&&this.line.startsWith(l))u=h.attributeProcessor(this.line,e,t.processingContext);else if(h.varyingProcessor&&this.line.startsWith(c))u=h.varyingProcessor(this.line,t.isFragment,e,t.processingContext);else if(h.uniformProcessor&&h.uniformRegexp&&h.uniformRegexp.test(this.line))t.lookForClosingBracketForUniformBuffer||(u=h.uniformProcessor(this.line,t.isFragment,e,t.processingContext));else if(h.uniformBufferProcessor&&h.uniformBufferRegexp&&h.uniformBufferRegexp.test(this.line))t.lookForClosingBracketForUniformBuffer||(u=h.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0);else if(h.textureProcessor&&h.textureRegexp&&h.textureRegexp.test(this.line))u=h.textureProcessor(this.line,t.isFragment,e,t.processingContext);else if((h.uniformProcessor||h.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer){/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?h.uniformProcessor&&(u=h.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):h.uniformBufferProcessor&&(u=h.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)}t.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(t.lookForClosingBracketForUniformBuffer=!1,h.endOfUniformBufferProcessor&&(u=h.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}l+=u+"\r\n"}return this.children.forEach((i=>{l+=i.process(e,t)})),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),l}}class n{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if("#"===t[0]){this._lines.push(t);continue}if(t.trim().startsWith("//")){this._lines.push(t);continue}const e=t.split(";");for(let t=0;t<e.length;t++){let i=e[t];i=i.trim(),i&&this._lines.push(i+(t!==e.length-1?";":""))}}}}class s extends r{process(e,t){for(let i=0;i<this.children.length;i++){const r=this.children[i];if(r.isValid(e))return r.process(e,t)}return""}}class a extends r{isValid(e){return this.testExpression.isTrue(e)}}class o{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(void 0===o._OperatorPriority[i])t.push(i);else{const e=t[t.length-1],r=t[t.length-2];t.length-=2,t.push(`(${r}${i}${e})`)}return t[t.length-1]}static infixToPostfix(e){const t=[];let i=-1;const r=()=>{u=u.trim(),""!==u&&(t.push(u),u="")},n=e=>{i<o._Stack.length-1&&(o._Stack[++i]=e)},s=()=>o._Stack[i],a=()=>-1===i?"!!INVALID EXPRESSION!!":o._Stack[i--];let l=0,u="";for(;l<e.length;){const h=e.charAt(l),c=l<e.length-1?e.substr(l,2):"";if("("===h)u="",n(h);else if(")"===h){for(r();-1!==i&&"("!==s();)t.push(a());a()}else if(o._OperatorPriority[c]>1){for(r();-1!==i&&o._OperatorPriority[s()]>=o._OperatorPriority[c];)t.push(a());n(c),l++}else u+=h;l++}for(r();-1!==i;)"("===s()?a():t.push(a());return t}}o._OperatorPriority={")":0,"(":1,"||":2,"&&":3},o._Stack=["","","","","","","","","","","","","","","","","","","",""];class l extends o{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=void 0!==e[this.define];return this.not&&(t=!t),t}}class u extends o{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class h extends o{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class c extends o{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];void 0===t&&(t=this.define);let i=!1;const r=parseInt(t),n=parseInt(this.testValue);switch(this.operand){case">":i=r>n;break;case"<":i=r<n;break;case"<=":i=r<=n;break;case">=":i=r>=n;break;case"==":i=r===n}return i}}var d=i(77851),_=i(41659);const p=/defined\s*?\((.+?)\)/g,g=/defined\s*?\[(.+?)\]/g,f=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g;class m{static Initialize(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}static Process(e,t,i,r){var n;(null===(n=t.processor)||void 0===n?void 0:n.preProcessShaderCode)&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,(e=>{t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e));const n=this._ProcessShaderConversion(e,t,r);i(n,e)}))}static PreProcess(e,t,i,r){var n;(null===(n=t.processor)||void 0===n?void 0:n.preProcessShaderCode)&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,(e=>{t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e));const n=this._ApplyPreProcessing(e,t,r);i(n,e)}))}static Finalize(e,t,i){return i.processor&&i.processor.finalizeShaders?i.processor.finalizeShaders(e,t,i.processingContext):{vertexCode:e,fragmentCode:t}}static _ProcessPrecision(e,t){var i;if(null===(i=t.processor)||void 0===i?void 0:i.noPrecision)return e;const r=t.shouldUseHighPrecisionShader;return-1===e.indexOf("precision highp float")?e=r?"precision highp float;\n"+e:"precision mediump float;\n"+e:r||(e=e.replace("precision highp float","precision mediump float")),e}static _ExtractOperation(e){const t=/defined\((.+)\)/.exec(e);if(t&&t.length)return new l(t[1].trim(),"!"===e[0]);const i=["==",">=","<=","<",">"];let r="",n=0;for(r of i)if(n=e.indexOf(r),n>-1)break;if(-1===n)return new l(e);const s=e.substring(0,n).trim(),a=e.substring(n+r.length).trim();return new c(s,r,a)}static _BuildSubExpression(e){e=e.replace(p,"defined[$1]");const t=o.infixToPostfix(e),i=[];for(const e of t)if("||"!==e&&"&&"!==e)i.push(e);else if(i.length>=2){let t=i[i.length-1],r=i[i.length-2];i.length-=2;const n="&&"==e?new h:new u;"string"==typeof t&&(t=t.replace(g,"defined($1)")),"string"==typeof r&&(r=r.replace(g,"defined($1)")),n.leftOperand="string"==typeof r?this._ExtractOperation(r):r,n.rightOperand="string"==typeof t?this._ExtractOperation(t):t,i.push(n)}let r=i[i.length-1];return"string"==typeof r&&(r=r.replace(g,"defined($1)")),"string"==typeof r?this._ExtractOperation(r):r}static _BuildExpression(e,t){const i=new a,r=e.substring(0,t);let n=e.substring(t);return n=n.substring(0,(n.indexOf("//")+1||n.length+1)-1).trim(),i.testExpression="#ifdef"===r?new l(n):"#ifndef"===r?new l(n,!0):this._BuildSubExpression(n),i}static _MoveCursorWithinIf(e,t,i){let n=e.currentLine;for(;this._MoveCursor(e,i);){n=e.currentLine;const s=n.substring(0,5).toLowerCase();if("#else"===s){const i=new r;return t.children.push(i),void this._MoveCursor(e,i)}if("#elif"===s){const e=this._BuildExpression(n,5);t.children.push(e),i=e}}}static _MoveCursor(e,t){for(;e.canRead;){e.lineIndex++;const i=e.currentLine,n=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(i);if(n&&n.length){switch(n[0]){case"#ifdef":{const r=new s;t.children.push(r);const n=this._BuildExpression(i,6);r.children.push(n),this._MoveCursorWithinIf(e,r,n);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const r=new s;t.children.push(r);const n=this._BuildExpression(i,7);r.children.push(n),this._MoveCursorWithinIf(e,r,n);break}case"#if":{const r=new s,n=this._BuildExpression(i,3);t.children.push(r),r.children.push(n),this._MoveCursorWithinIf(e,r,n);break}}}else{const e=new r;if(e.line=i,t.children.push(e),"#"===i[0]&&"d"===i[1]){const t=i.replace(";","").split(" ");e.additionalDefineKey=t[1],3===t.length&&(e.additionalDefineValue=t[2])}}}return!1}static _EvaluatePreProcessors(e,t,i){const s=new r,a=new n;return a.lineIndex=-1,a.lines=e.split("\n"),this._MoveCursor(a,s),s.process(t,i)}static _PreparePreProcessors(e,t){var i;const r=e.defines,n={};for(const e of r){const t=e.replace("#define","").replace(";","").trim().split(" ");n[t[0]]=t.length>1?t[1]:""}return(null===(i=e.processor)||void 0===i?void 0:i.shaderLanguage)===_.x.GLSL&&(n.GL_ES="true"),n.__VERSION__=e.version,n[e.platformName]="true",t._getGlobalDefines(n),n}static _ProcessShaderConversion(e,t,i){let r=this._ProcessPrecision(e,t);if(!t.processor)return r;if(t.processor.shaderLanguage===_.x.GLSL&&-1!==r.indexOf("#version 3")&&(r=r.replace("#version 300 es",""),!t.processor.parseGLES3))return r;const n=t.defines,s=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(r=t.processor.preProcessor(r,n,t.isFragment,t.processingContext)),r=this._EvaluatePreProcessors(r,s,t),t.processor.postProcessor&&(r=t.processor.postProcessor(r,n,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(r=i.inlineShaderCode(r)),r}static _ApplyPreProcessing(e,t,i){var r,n;let s=e;const a=t.defines,o=this._PreparePreProcessors(t,i);return(null===(r=t.processor)||void 0===r?void 0:r.preProcessor)&&(s=t.processor.preProcessor(s,a,t.isFragment,t.processingContext)),s=this._EvaluatePreProcessors(s,o,t),(null===(n=t.processor)||void 0===n?void 0:n.postProcessor)&&(s=t.processor.postProcessor(s,a,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(s=i.inlineShaderCode(s)),s}static _ProcessIncludes(e,t,i){let r=f.exec(e),n=new String(e),s=!1;for(;null!=r;){let a=r[1];if(-1!==a.indexOf("__decl__")&&(a=a.replace(/__decl__/,""),t.supportsUniformBuffers&&(a=a.replace(/Vertex/,"Ubo"),a=a.replace(/Fragment/,"Ubo")),a+="Declaration"),!t.includesShadersStore[a]){const e=t.shadersRepository+"ShadersInclude/"+a+".fx";return void m._FileToolsLoadFile(e,(e=>{t.includesShadersStore[a]=e,this._ProcessIncludes(n,t,i)}))}{let e=t.includesShadersStore[a];if(r[2]){const t=r[3].split(",");for(let i=0;i<t.length;i+=2){const r=new RegExp(t[i],"g"),n=t[i+1];e=e.replace(r,n)}}if(r[4]){const i=r[5];if(-1!==i.indexOf("..")){const r=i.split(".."),n=parseInt(r[0]);let s=parseInt(r[1]),a=e.slice(0);e="",isNaN(s)&&(s=t.indexParameters[r[1]]);for(let i=n;i<s;i++)t.supportsUniformBuffers||(a=a.replace(/light\{X\}.(\w*)/g,((e,t)=>t+"{X}"))),e+=a.replace(/\{X\}/g,i.toString())+"\n"}else t.supportsUniformBuffers||(e=e.replace(/light\{X\}.(\w*)/g,((e,t)=>t+"{X}"))),e=e.replace(/\{X\}/g,i)}n=n.replace(r[0],e),s=s||e.indexOf("#include<")>=0||e.indexOf("#include <")>=0}r=f.exec(e)}s?this._ProcessIncludes(n.toString(),t,i):i(n)}static _FileToolsLoadFile(e,t,i,r,n,s){throw(0,d.S)("FileTools")}}},48743:(e,t,i)=>{i.d(t,{C:()=>n});var r=i(41659);class n{constructor(){this.shaderLanguage=r.x.GLSL}attributeProcessor(e){return e.replace("attribute","in")}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const r=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i)e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(r?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");else{if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e}return e}}},61319:(e,t,i)=>{i.d(t,{B:()=>r});class r{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffer=null,this._context=t,!e&&!(e=t.createTexture()))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffer=null}release(){this._MSAARenderBuffer&&(this._context.deleteRenderbuffer(this._MSAARenderBuffer),this._MSAARenderBuffer=null),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},86830:(e,t,i)=>{i.d(t,{y:()=>n});const r=["Int","Int2","Int3","Int4","UInt","UInt2","UInt3","UInt4","Vector2","Vector3","Vector4","Float2","Float","Float3","Float4","Quaternion","Color3","Color4","DirectColor4"];class n{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null;const e=[],t=function(){e.length=0,Array.prototype.push.apply(e,arguments),e[0]=this._uniforms[e[0]]},i=i=>{const n=r.includes(i.substring(3))&&"FloatN";if(n){const r=this[`_cache${n}`];return function(){const n=this.engine[i];t.apply(this,arguments),r.apply(this,arguments)&&(n.apply(this.engine,e)||(this._valueCache[arguments[0]]=null))}}return function(){const r=this.engine[i];t.apply(this,arguments),void 0!==arguments[1]&&(this._valueCache[arguments[0]]=null,r.apply(this.engine,e))}};["Int?","UInt?","IntArray?","UIntArray?","Array?","Float?","Matrices","Matrix3x3","Matrix2x2"].forEach((e=>{const t=`set${e}`;this[t]||(t.endsWith("?")?["",2,3,4].forEach((e=>{this[t.slice(0,-1)+e]=this[t.slice(0,-1)+e]||i(t.slice(0,-1)+e).bind(this)})):this[t]=this[t]||i(t).bind(this))}))}get isAsync(){return this.isParallelCompiled}get isReady(){return!!this.program&&(!this.isParallelCompiled||this.engine._isRenderingStateCompiled(this))}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}_fillEffectInformation(e,t,i,r,n,s,a,o){const l=this.engine;if(l.supportsUniformBuffers)for(const i in t)e.bindUniformBlock(i,t[i]);let u;for(this.engine.getUniforms(this,i).forEach(((e,t)=>{r[i[t]]=e})),this._uniforms=r,u=0;u<n.length;u++){null==e.getUniform(n[u])&&(n.splice(u,1),u--)}n.forEach(((e,t)=>{s[e]=t}));for(const e of l.getAttributes(this,a))o.push(e)}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],r=t.updateFlag;return(void 0===i||i!==r)&&(this._valueCache[e]=r,!0)}_cacheFloatN(e,t,i,r,n){let s=this._valueCache[arguments[0]];if(!s||s.length!==arguments.length-1)return s=Array.prototype.slice.call(arguments,1),this._valueCache[arguments[0]]=s,!0;let a=!1;for(let e=0;e<s.length;++e)s[e]!==arguments[e+1]&&(s[e]=arguments[e+1],a=!0);return a}_cacheFloat2(e,t,i){return this._cacheFloatN(e,t,i)}_cacheFloat3(e,t,i,r){return this._cacheFloatN(e,t,i,r)}_cacheFloat4(e,t,i,r,n){return this._cacheFloatN(e,t,i,r,n)}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}},98619:(e,t,i)=>{i.d(t,{f:()=>n});var r=i(41659);class n{constructor(){this.shaderLanguage=r.x.GLSL}postProcessor(e,t,i,r,n){if(!n.getCaps().drawBuffersExtension){const t=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(t,"")}return e}}},11564:(e,t,i)=>{i.d(t,{V:()=>o});var r=i(84157),n=i(80949),s=i(5382),a=i(8724);class o{static _IsGPUBuffer(e){return void 0===e.underlyingResource}constructor(e){this._deferredReleaseBuffers=[],this._device=e}createRawBuffer(e,t,i=!1){const r={mappedAtCreation:i,size:void 0!==e.byteLength?e.byteLength+3&-4:e+3&-4,usage:t};return this._device.createBuffer(r)}createBuffer(e,t){const i=void 0!==e.byteLength,n=this.createRawBuffer(e,t),s=new r.C(n);return s.references=1,s.capacity=i?e.byteLength:e,i&&this.setSubData(s,0,e),s}setRawData(e,t,i,r,n){this._device.queue.writeBuffer(e,t,i.buffer,r,n)}setSubData(e,t,i,r=0,n=0){const s=e.underlyingResource;n=n||i.byteLength,n=Math.min(n,e.capacity-t);let a=i.byteOffset+r,o=a+n;const l=n+3&-4;if(l!==n){const e=new Uint8Array(i.buffer.slice(a,o));(i=new Uint8Array(l)).set(e),r=0,a=0,o=l,n=l}const u=15728640;let h=0;for(;o-(a+h)>u;)this._device.queue.writeBuffer(s,t+h,i.buffer,a+h,u),h+=u;this._device.queue.writeBuffer(s,t+h,i.buffer,a+h,n-h)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i||(i=new Float32Array(e));const r=new Uint16Array(t);for(;e--;)i[e]=(0,n.qZ)(r[e]);return i}readDataFromBuffer(e,t,i,r,n,o,l=0,u=0,h=null,c=!0,d=!1){const _=1===l?2:2===l?1:0;return new Promise(((i,p)=>{e.mapAsync(a.gc.Read,u,t).then((()=>{const a=e.getMappedRange(u,t);let p=h;if(d)p=null===p?(0,s.A)(l,t,!0,a):(0,s.A)(l,p.buffer,void 0,a);else if(null===p)switch(_){case 0:p=new Uint8Array(t),p.set(new Uint8Array(a));break;case 1:p=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,a);break;case 2:p=new Float32Array(t/4),p.set(new Float32Array(a))}else switch(_){case 0:p=new Uint8Array(p.buffer),p.set(new Uint8Array(a));break;case 1:p=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,a,h);break;case 2:p=new Float32Array(p.buffer),p.set(new Float32Array(a))}if(n!==o){1!==_||d||(n*=2,o*=2);const e=new Uint8Array(p.buffer);let t=n,i=0;for(let s=1;s<r;++s){i=s*o;for(let r=0;r<n;++r)e[t++]=e[i++]}p=0===_||d?new Uint8Array(e.buffer,0,t):new Float32Array(e.buffer,0,t/4)}e.unmap(),c&&this.releaseBuffer(e),i(p)}),(e=>p(e)))}))}releaseBuffer(e){return o._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,0===e.references&&(this._deferredReleaseBuffers.push(e.underlyingResource),!0))}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}},81987:(e,t,i)=>{i.d(t,{GB:()=>o,fv:()=>r,fw:()=>l,kP:()=>a,me:()=>n,nt:()=>h,vr:()=>s});class r{constructor(e,t,i,r){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(r)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new r(this.x,this.y,this.w,this.h)}}class n{constructor(e,t,i,r){this.x=e,this.y=t,this.w=i,this.h=r}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new n(this.x,this.y,this.w,this.h)}}class s{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new s(this.ref)}}class a{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new a(this.color)}}class o{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new o(this.query)}}class l{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new l}}class u{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){const e=new u;return e.bundles=this.bundles,e}}class h{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){const e=new u;this._list[this._listLength++]=e,this._currentBundleList=e.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:i})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();const e=new h(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}},66970:(e,t,i)=>{i.d(t,{C:()=>s});var r=i(84318);class n{constructor(){this.values={}}}class s{static get Statistics(){return{totalCreated:s.NumBindGroupsCreatedTotal,lastFrameCreated:s.NumBindGroupsCreatedLastFrame,lookupLastFrame:s.NumBindGroupsLookupLastFrame,noLookupLastFrame:s.NumBindGroupsNoLookupLastFrame}}constructor(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}endFrame(){s.NumBindGroupsCreatedLastFrame=s._NumBindGroupsCreatedCurrentFrame,s.NumBindGroupsLookupLastFrame=s._NumBindGroupsLookupCurrentFrame,s.NumBindGroupsNoLookupLastFrame=s._NumBindGroupsNoLookupCurrentFrame,s._NumBindGroupsCreatedCurrentFrame=0,s._NumBindGroupsLookupCurrentFrame=0,s._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,i){var a,o,l,u,h,c,d,_,p,g;let f,m=s._Cache;const E=this.disabled||i.forceBindGroupCreation;if(!E){if(!t.isDirty(i.updateId)&&!i.isDirty)return s._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(const i of e.shaderProcessingContext.bufferNames){const e=null!==(o=null===(a=t.buffers[i])||void 0===a?void 0:a.uniqueId)&&void 0!==o?o:0;let r=m.values[e];r||(r=new n,m.values[e]=r),m=r}for(const t of e.shaderProcessingContext.samplerNames){const e=null!==(u=null===(l=i.samplers[t])||void 0===l?void 0:l.hashCode)&&void 0!==u?u:0;let r=m.values[e];r||(r=new n,m.values[e]=r),m=r}for(const t of e.shaderProcessingContext.textureNames){const e=null!==(d=null===(c=null===(h=i.textures[t])||void 0===h?void 0:h.texture)||void 0===c?void 0:c.uniqueId)&&void 0!==d?d:0;let r=m.values[e];r||(r=new n,m.values[e]=r),m=r}f=m.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,f)return t.bindGroups=f,s._NumBindGroupsLookupCurrentFrame++,f;f=[],t.bindGroups=f,E||(m.bindGroups=f),s.NumBindGroupsCreatedTotal++,s._NumBindGroupsCreatedCurrentFrame++;const T=e.bindGroupLayouts;for(let n=0;n<e.shaderProcessingContext.bindGroupLayoutEntries.length;n++){const s=e.shaderProcessingContext.bindGroupLayoutEntries[n],a=e.shaderProcessingContext.bindGroupEntries[n];for(let o=0;o<s.length;o++){const s=e.shaderProcessingContext.bindGroupLayoutEntries[n][o],l=e.shaderProcessingContext.bindGroupLayoutEntryInfo[n][s.binding],u=null!==(_=l.nameInArrayOfTexture)&&void 0!==_?_:l.name;if(s.sampler){const e=i.samplers[u];if(e){const t=e.sampler;if(!t){this._engine.dbgSanityChecks&&r.Y.Error(`Trying to bind a null sampler! entry=${JSON.stringify(s)}, name=${u}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, materialContext.uniqueId=${i.uniqueId}`,50);continue}a[o].resource=this._cacheSampler.getSampler(t,!1,e.hashCode)}else r.Y.Error(`Sampler "${u}" could not be bound. entry=${JSON.stringify(s)}, materialContext=${JSON.stringify(i,((e,t)=>"texture"===e||"sampler"===e?"<no dump>":t))}`,50)}else if(s.texture||s.storageTexture){const e=i.textures[u];if(e){if(this._engine.dbgSanityChecks&&null===e.texture){r.Y.Error(`Trying to bind a null texture! entry=${JSON.stringify(s)}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const t=e.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!t||s.texture&&!t.view||s.storageTexture&&!t.viewForWriting)){r.Y.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(s)}, name=${u}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, isReady=${null===(p=e.texture)||void 0===p?void 0:p.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}a[o].resource=s.storageTexture?t.viewForWriting:t.view}else r.Y.Error(`Texture "${u}" could not be bound. entry=${JSON.stringify(s)}, materialContext=${JSON.stringify(i,((e,t)=>"texture"===e||"sampler"===e?"<no dump>":t))}`,50)}else if(s.externalTexture){const e=i.textures[u];if(e){if(this._engine.dbgSanityChecks&&null===e.texture){r.Y.Error(`Trying to bind a null external texture! entry=${JSON.stringify(s)}, name=${u}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const t=e.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!t){r.Y.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(s)}, name=${u}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, isReady=${null===(g=e.texture)||void 0===g?void 0:g.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}a[o].resource=this._device.importExternalTexture({source:t})}else r.Y.Error(`Texture "${u}" could not be bound. entry=${JSON.stringify(s)}, materialContext=${JSON.stringify(i,((e,t)=>"texture"===e||"sampler"===e?"<no dump>":t))}`,50)}else if(s.buffer){const e=t.buffers[u];if(e){const t=e.underlyingResource;a[o].resource.buffer=t,a[o].resource.size=e.capacity}else r.Y.Error(`Can't find buffer "${u}". entry=${JSON.stringify(s)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}const o=T[n];f[n]=this._device.createBindGroup({layout:o,entries:a})}return f}}s.NumBindGroupsCreatedTotal=0,s.NumBindGroupsCreatedLastFrame=0,s.NumBindGroupsLookupLastFrame=0,s.NumBindGroupsNoLookupLastFrame=0,s._Cache=new n,s._NumBindGroupsCreatedCurrentFrame=0,s._NumBindGroupsLookupCurrentFrame=0,s._NumBindGroupsNoLookupCurrentFrame=0},93052:(e,t,i)=>{i.d(t,{O:()=>h});var r,n=i(8724),s=i(72208),a=i(50113),o=i(72089);!function(e){e[e.StencilReadMask=0]="StencilReadMask",e[e.StencilWriteMask=1]="StencilWriteMask",e[e.DepthBias=2]="DepthBias",e[e.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",e[e.DepthStencilState=4]="DepthStencilState",e[e.MRTAttachments1=5]="MRTAttachments1",e[e.MRTAttachments2=6]="MRTAttachments2",e[e.RasterizationState=7]="RasterizationState",e[e.ColorStates=8]="ColorStates",e[e.ShaderStage=9]="ShaderStage",e[e.TextureStage=10]="TextureStage",e[e.VertexState=11]="VertexState",e[e.NumStates=12]="NumStates"}(r||(r={}));const l={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},u={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7};class h{constructor(e,t,i){this.mrtTextureCount=0,this._device=e,this._useTextureStage=i,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=t,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=e.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=[n.EV.BGRA8Unorm],this.setColorFormat(n.EV.BGRA8Unorm),this.setMRT([]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat(n.EV.Depth24PlusStencil8),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments1>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(e,t,i,r=0){if(i>1&&(i=4),this.disabled){const r=h._GetTopology(e);return this._setVertexState(t),this._parameter.pipeline=this._createRenderPipeline(t,r,i),h.NumCacheMiss++,h._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(t.uniqueId),this._setRasterizationState(e,i),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(t),this._setTextureState(r),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,h.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return h.NumCacheHitWithHash++,this._parameter.pipeline;const n=h._GetTopology(e);return this._parameter.pipeline=this._createRenderPipeline(t,n,i),this._setRenderPipeline(this._parameter),h.NumCacheMiss++,h._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){h.NumPipelineCreationLastFrame=h._NumPipelineCreationCurrentFrame,h._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(e){this._alphaToCoverageEnabled=e}setFrontFace(e){this._frontFace=e}setCullEnabled(e){this._cullEnabled=e}setCullFace(e){this._cullFace=e}setClampDepth(e){this._clampDepth=e}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(e,t,i,r,n,s,a,o){this._depthWriteEnabled=a,this._depthTestEnabled=s,this._depthCompare=(null!=o?o:519)-512,this._cullFace=i,this._cullEnabled=e,this._frontFace=t,this.setDepthBiasSlopeScale(r),this.setDepthBias(n)}setDepthBias(e){this._depthBias!==e&&(this._depthBias=e,this._states[r.DepthBias]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,r.DepthBias))}setDepthBiasSlopeScale(e){this._depthBiasSlopeScale!==e&&(this._depthBiasSlopeScale=e,this._states[r.DepthBiasSlopeScale]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,r.DepthBiasSlopeScale))}setColorFormat(e){this._webgpuColorFormat[0]=e,this._colorFormat=o.U[null!=e?e:""]}setMRTAttachments(e){this.mrtAttachments=e;let t=0;for(let i=0;i<e.length;++i)0!==e[i]&&(t+=1<<i);this._mrtEnabledMask!==t&&(this._mrtEnabledMask=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,r.MRTAttachments1))}setMRT(e,t){var i,n;if((t=null!=t?t:e.length)>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";this.mrtTextureArray=e,this.mrtTextureCount=t,this._mrtEnabledMask=65535;const s=[0,0];let a=0,l=0,u=0;for(let r=0;r<t;++r){const t=e[r],h=null==t?void 0:t._hardwareTexture;this._mrtFormats[u]=null!==(i=null==h?void 0:h.format)&&void 0!==i?i:this._webgpuColorFormat[0],s[a]+=o.U[null!==(n=this._mrtFormats[u])&&void 0!==n?n:""]<<l,l+=6,u++,l>=32&&(l=0,a++)}this._mrtFormats.length=u,this._mrtAttachments1===s[0]&&this._mrtAttachments2===s[1]||(this._mrtAttachments1=s[0],this._mrtAttachments2=s[1],this._states[r.MRTAttachments1]=s[0],this._states[r.MRTAttachments2]=s[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,r.MRTAttachments1))}setAlphaBlendEnabled(e){this._alphaBlendEnabled=e}setAlphaBlendFactors(e,t){this._alphaBlendFuncParams=e,this._alphaBlendEqParams=t}setWriteMask(e){this._writeMask=e}setDepthStencilFormat(e){this._webgpuDepthStencilFormat=e,this._depthStencilFormat=void 0===e?0:o.U[e]}setDepthTestEnabled(e){this._depthTestEnabled=e}setDepthWriteEnabled(e){this._depthWriteEnabled=e}setDepthCompare(e){this._depthCompare=(null!=e?e:519)-512}setStencilEnabled(e){this._stencilEnabled=e}setStencilCompare(e){this._stencilFrontCompare=(null!=e?e:519)-512}setStencilDepthFailOp(e){this._stencilFrontDepthFailOp=null===e?1:u[e]}setStencilPassOp(e){this._stencilFrontPassOp=null===e?2:u[e]}setStencilFailOp(e){this._stencilFrontFailOp=null===e?1:u[e]}setStencilReadMask(e){this._stencilReadMask!==e&&(this._stencilReadMask=e,this._states[r.StencilReadMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,r.StencilReadMask))}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this._stencilWriteMask=e,this._states[r.StencilWriteMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,r.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(e,t,i,r,n,s,a){this._stencilEnabled=e,this._stencilFrontCompare=(null!=t?t:519)-512,this._stencilFrontDepthFailOp=null===i?1:u[i],this._stencilFrontPassOp=null===r?2:u[r],this._stencilFrontFailOp=null===n?1:u[n],this.setStencilReadMask(s),this.setStencilWriteMask(a)}setBuffers(e,t,i){this._vertexBuffers=e,this._overrideVertexBuffers=i,this._indexBuffer=t}static _GetTopology(e){switch(e){case 0:default:return n.YV.TriangleList;case 2:case 3:return n.YV.PointList;case 1:case 4:return n.YV.LineList;case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return n.YV.LineStrip;case 7:return n.YV.TriangleStrip;case 8:throw"TriangleFan is an unsupported fillmode in WebGPU"}}static _GetAphaBlendOperation(e){switch(e){case 32774:default:return n.db.Add;case 32778:return n.db.Subtract;case 32779:return n.db.ReverseSubtract;case 32775:return n.db.Min;case 32776:return n.db.Max}}static _GetAphaBlendFactor(e){switch(e){case 0:return n.zi.Zero;case 1:default:return n.zi.One;case 768:return n.zi.Src;case 769:return n.zi.OneMinusSrc;case 770:return n.zi.SrcAlpha;case 771:return n.zi.OneMinusSrcAlpha;case 772:return n.zi.DstAlpha;case 773:return n.zi.OneMinusDstAlpha;case 774:return n.zi.Dst;case 775:return n.zi.OneMinusDst;case 776:return n.zi.SrcAlphaSaturated;case 32769:case 32771:return n.zi.Constant;case 32770:case 32772:return n.zi.OneMinusConstant}}static _GetCompareFunction(e){switch(e){case 0:return n.wb.Never;case 1:return n.wb.Less;case 2:return n.wb.Equal;case 3:return n.wb.LessEqual;case 4:return n.wb.Greater;case 5:return n.wb.NotEqual;case 6:return n.wb.GreaterEqual;case 7:return n.wb.Always}return n.wb.Never}static _GetStencilOpFunction(e){switch(e){case 0:return n.xS.Zero;case 1:return n.xS.Keep;case 2:return n.xS.Replace;case 3:return n.xS.IncrementClamp;case 4:return n.xS.DecrementClamp;case 5:return n.xS.Invert;case 6:return n.xS.IncrementWrap;case 7:return n.xS.DecrementWrap}return n.xS.Keep}static _GetVertexInputDescriptorFormat(e){const t=e.type,i=e.normalized,r=e.getSize();switch(t){case s.o.BYTE:switch(r){case 1:case 2:return i?n.gB.Snorm8x2:n.gB.Sint8x2;case 3:case 4:return i?n.gB.Snorm8x4:n.gB.Sint8x4}break;case s.o.UNSIGNED_BYTE:switch(r){case 1:case 2:return i?n.gB.Unorm8x2:n.gB.Uint8x2;case 3:case 4:return i?n.gB.Unorm8x4:n.gB.Uint8x4}break;case s.o.SHORT:switch(r){case 1:case 2:return i?n.gB.Snorm16x2:n.gB.Sint16x2;case 3:case 4:return i?n.gB.Snorm16x4:n.gB.Sint16x4}break;case s.o.UNSIGNED_SHORT:switch(r){case 1:case 2:return i?n.gB.Unorm16x2:n.gB.Uint16x2;case 3:case 4:return i?n.gB.Unorm16x4:n.gB.Uint16x4}break;case s.o.INT:switch(r){case 1:return n.gB.Sint32;case 2:return n.gB.Sint32x2;case 3:return n.gB.Sint32x3;case 4:return n.gB.Sint32x4}break;case s.o.UNSIGNED_INT:switch(r){case 1:return n.gB.Uint32;case 2:return n.gB.Uint32x2;case 3:return n.gB.Uint32x3;case 4:return n.gB.Uint32x4}break;case s.o.FLOAT:switch(r){case 1:return n.gB.Float32;case 2:return n.gB.Float32x2;case 3:return n.gB.Float32x3;case 4:return n.gB.Float32x4}}throw new Error(`Invalid Format '${e.getKind()}' - type=${t}, normalized=${i}, size=${r}`)}_getAphaBlendState(){return this._alphaBlendEnabled?{srcFactor:h._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:h._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:h._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:null}_getColorBlendState(){return this._alphaBlendEnabled?{srcFactor:h._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:h._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:h._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:null}_setShaderStage(e){this._shaderId!==e&&(this._shaderId=e,this._states[r.ShaderStage]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,r.ShaderStage))}_setRasterizationState(e,t){const i=this._frontFace-1+((this._cullEnabled?this._cullFace:0)<<1)+((this._clampDepth?1:0)<<3)+((this._alphaToCoverageEnabled?1:0)<<4)+(e<<5)+(t<<8);this._rasterizationState!==i&&(this._rasterizationState=i,this._states[r.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,r.RasterizationState))}_setColorStates(){let e=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(e+=((null===this._alphaBlendFuncParams[0]?2:l[this._alphaBlendFuncParams[0]])<<0)+((null===this._alphaBlendFuncParams[1]?2:l[this._alphaBlendFuncParams[1]])<<4)+((null===this._alphaBlendFuncParams[2]?2:l[this._alphaBlendFuncParams[2]])<<8)+((null===this._alphaBlendFuncParams[3]?2:l[this._alphaBlendFuncParams[3]])<<12)+((null===this._alphaBlendEqParams[0]?1:this._alphaBlendEqParams[0]-32773)<<16)+((null===this._alphaBlendEqParams[1]?1:this._alphaBlendEqParams[1]-32773)<<19)),e!==this._colorStates&&(this._colorStates=e,this._states[r.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,r.ColorStates))}_setDepthStencilState(){const e=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):591,t=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+(e<<10);this._depthStencilState!==t&&(this._depthStencilState=t,this._states[r.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,r.DepthStencilState))}_setVertexState(e){var t,i;const n=this._statesLength;let s=r.VertexState;const a=e._pipelineContext,o=a.shaderProcessingContext.attributeNamesFromEffect,l=a.shaderProcessingContext.attributeLocationsFromEffect;let u,h=0;for(let e=0;e<o.length;e++){const r=l[e];let n=null!==(t=this._overrideVertexBuffers&&this._overrideVertexBuffers[o[e]])&&void 0!==t?t:this._vertexBuffers[o[e]];n||(n=this._emptyVertexBuffer);const a=null===(i=n.getBuffer())||void 0===i?void 0:i.underlyingResource;if(void 0===n._validOffsetRange){const e=n.byteOffset,t=n.getSize(!0),i=n.byteStride;n._validOffsetRange=e<=this._kMaxVertexBufferStride-t&&(0===i||e+t<=i)}u&&u===a&&n._validOffsetRange||(this.vertexBuffers[h++]=n,u=n._validOffsetRange?a:null);const c=n.hashCode+(r<<7);this._isDirty=this._isDirty||this._states[s]!==c,this._states[s++]=c}this.vertexBuffers.length=h,this._statesLength=s,this._isDirty=this._isDirty||s!==n,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,r.VertexState))}_setTextureState(e){this._textureState!==e&&(this._textureState=e,this._states[r.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,r.TextureStage))}_createPipelineLayout(e){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(e);const t=[],i=e.shaderProcessingContext.bindGroupLayoutEntries;for(let e=0;e<i.length;e++){const r=i[e];t[e]=this._device.createBindGroupLayout({entries:r})}return e.bindGroupLayouts=t,this._device.createPipelineLayout({bindGroupLayouts:t})}_createPipelineLayoutWithTextureStage(e){var t;const i=e.shaderProcessingContext,r=i.bindGroupLayoutEntries;let s=1;for(let e=0;e<r.length;e++){const o=r[e];for(let l=0;l<o.length;l++){const o=r[e][l];if(o.texture){const l=i.bindGroupLayoutEntryInfo[e][o.binding].name,u=i.availableTextures[l],h=u.autoBindSampler?i.availableSamplers[l+a.e.AutoSamplerSuffix]:null;let c=u.sampleType,d=null!==(t=null==h?void 0:h.type)&&void 0!==t?t:n.dV.Filtering;if(this._textureState&s&&c!==n.oD.Depth&&(u.autoBindSampler&&(d=n.dV.NonFiltering),c=n.oD.UnfilterableFloat),o.texture.sampleType=c,h){const e=i.bindGroupLayoutEntryInfo[h.binding.groupIndex][h.binding.bindingIndex].index;r[h.binding.groupIndex][e].sampler.type=d}s<<=1}}}const o=[];for(let e=0;e<r.length;++e)o[e]=this._device.createBindGroupLayout({entries:r[e]});return e.bindGroupLayouts=o,this._device.createPipelineLayout({bindGroupLayouts:o})}_getVertexInputDescriptor(e){var t,i;const r=[],s=e._pipelineContext,a=s.shaderProcessingContext.attributeNamesFromEffect,o=s.shaderProcessingContext.attributeLocationsFromEffect;let l,u;for(let e=0;e<a.length;e++){const s=o[e];let c=null!==(t=this._overrideVertexBuffers&&this._overrideVertexBuffers[a[e]])&&void 0!==t?t:this._vertexBuffers[a[e]];c||(c=this._emptyVertexBuffer);let d=null===(i=c.getBuffer())||void 0===i?void 0:i.underlyingResource,_=c.byteOffset;const p=!c._validOffsetRange;if(!l||!u||l!==d||p){const e={arrayStride:c.byteStride,stepMode:c.getIsInstanced()?n.V.Instance:n.V.Vertex,attributes:[]};r.push(e),u=e.attributes,p&&(_=0,d=null)}u.push({shaderLocation:s,offset:_,format:h._GetVertexInputDescriptorFormat(c)}),l=d}return r}_createRenderPipeline(e,t,i){var r,s,a;const l=e._pipelineContext,u=this._getVertexInputDescriptor(e),c=this._createPipelineLayout(l),d=[],_=this._getAphaBlendState(),p=this._getColorBlendState();if(this._mrtAttachments1>0)for(let e=0;e<this._mrtFormats.length;++e){const t=this._mrtFormats[e];if(t){const i={format:t,writeMask:0!=(this._mrtEnabledMask&1<<e)?this._writeMask:0};_&&p&&(i.blend={alpha:_,color:p}),d.push(i)}else d.push(null)}else if(this._webgpuColorFormat[0]){const e={format:this._webgpuColorFormat[0],writeMask:this._writeMask};_&&p&&(e.blend={alpha:_,color:p}),d.push(e)}else d.push(null);const g={compare:h._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:h._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:h._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:h._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)};let f;t!==n.YV.LineStrip&&t!==n.YV.TriangleStrip||(f=!this._indexBuffer||this._indexBuffer.is32Bits?n.iD.Uint32:n.iD.Uint16);const m=!!this._webgpuDepthStencilFormat&&o.D.HasStencilAspect(this._webgpuDepthStencilFormat);return this._device.createRenderPipeline({label:`RenderPipeline_${null!==(s=null===(r=d[0])||void 0===r?void 0:r.format)&&void 0!==s?s:"nooutput"}_${null!==(a=this._webgpuDepthStencilFormat)&&void 0!==a?a:"nodepth"}_samples${i}`,layout:c,vertex:{module:l.stages.vertexStage.module,entryPoint:l.stages.vertexStage.entryPoint,buffers:u},primitive:{topology:t,stripIndexFormat:f,frontFace:1===this._frontFace?n.zX.CCW:n.zX.CW,cullMode:this._cullEnabled?2===this._cullFace?n.Wf.Front:n.Wf.Back:n.Wf.None},fragment:l.stages.fragmentStage?{module:l.stages.fragmentStage.module,entryPoint:l.stages.fragmentStage.entryPoint,targets:d}:void 0,multisample:{count:i},depthStencil:void 0===this._webgpuDepthStencilFormat?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?h._GetCompareFunction(this._depthCompare):n.wb.Always,format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&m?g:void 0,stencilBack:this._stencilEnabled&&m?g:void 0,stencilReadMask:this._stencilEnabled&&m?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&m?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale}})}}h.NumCacheHitWithoutHash=0,h.NumCacheHitWithHash=0,h.NumCacheMiss=0,h.NumPipelineCreationLastFrame=0,h._NumPipelineCreationCurrentFrame=0},85801:(e,t,i)=>{i.d(t,{H:()=>s});var r=i(93052);class n{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(const i in this.values){const r=this.values[i],[n,s]=r.count();e+=n,t+=s,e++}return[e,t]}}class s extends r.O{static GetNodeCounts(){const e=s._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,i,r){if(e.pipeline){const e=i.slice();e.length=r,t.push(e)}for(const n in e.values){const a=e.values[n];i[r]=parseInt(n),s._GetPipelines(a,t,i,r+1)}}static GetPipelines(){const e=[];return s._GetPipelines(s._Cache,e,[],0),e}constructor(e,t,i){super(e,t,i),this._nodeStack=[],this._nodeStack[0]=s._Cache}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let e=this._stateDirtyLowestIndex;e<this._statesLength;++e){let i=t.values[this._states[e]];i||(i=new n,t.values[this._states[e]]=i),t=i,this._nodeStack[e+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}}s._Cache=new n},20955:(e,t,i)=>{i.d(t,{W:()=>o});var r=i(8724);const n=[0,0,3,7,0,2,6,2,4,1,5,3,1],s=[0,64,32,96,16,80,48,112,8],a=[0,128,128,0,0,0,0,128,0,0,0,0,128];class o{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){var t,i,r;const o=e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1;return n[e.samplingMode]+s[(e._comparisonFunction||514)-512+1]+a[e.samplingMode]+((null!==(t=e._cachedWrapU)&&void 0!==t?t:1)<<8)+((null!==(i=e._cachedWrapV)&&void 0!==i?i:1)<<10)+((null!==(r=e._cachedWrapR)&&void 0!==r?r:1)<<12)+((e.useMipMaps?1:0)<<14)+(o<<15)}static _GetSamplerFilterDescriptor(e,t){let i,n,s,a,o;const l=e.useMipMaps;switch(e.samplingMode){case 11:i=r.X9.Linear,n=r.X9.Linear,s=r.X9.Nearest,l||(a=o=0);break;case 3:case 3:i=r.X9.Linear,n=r.X9.Linear,l?s=r.X9.Linear:(s=r.X9.Nearest,a=o=0);break;case 8:i=r.X9.Nearest,n=r.X9.Nearest,l?s=r.X9.Linear:(s=r.X9.Nearest,a=o=0);break;case 4:i=r.X9.Nearest,n=r.X9.Nearest,s=r.X9.Nearest,l||(a=o=0);break;case 5:i=r.X9.Nearest,n=r.X9.Linear,s=r.X9.Nearest,l||(a=o=0);break;case 6:i=r.X9.Nearest,n=r.X9.Linear,l?s=r.X9.Linear:(s=r.X9.Nearest,a=o=0);break;case 7:i=r.X9.Nearest,n=r.X9.Linear,s=r.X9.Nearest,a=o=0;break;case 1:case 1:default:i=r.X9.Nearest,n=r.X9.Nearest,s=r.X9.Nearest,a=o=0;break;case 9:i=r.X9.Linear,n=r.X9.Nearest,s=r.X9.Nearest,l||(a=o=0);break;case 10:i=r.X9.Linear,n=r.X9.Nearest,l?s=r.X9.Linear:(s=r.X9.Nearest,a=o=0);break;case 2:case 2:i=r.X9.Linear,n=r.X9.Linear,s=r.X9.Nearest,a=o=0;break;case 12:i=r.X9.Linear,n=r.X9.Nearest,s=r.X9.Nearest,a=o=0}return t>1&&(0!==a||0!==o)?{magFilter:r.X9.Linear,minFilter:r.X9.Linear,mipmapFilter:r.X9.Linear,anisotropyEnabled:!0}:{magFilter:i,minFilter:n,mipmapFilter:s,lodMinClamp:a,lodMaxClamp:o}}static _GetWrappingMode(e){switch(e){case 1:return r.OB.Repeat;case 0:return r.OB.ClampToEdge;case 2:return r.OB.MirrorRepeat}return r.OB.Repeat}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e){const t=e.useMipMaps&&e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1,i=this._GetSamplerFilterDescriptor(e,t);return{...i,...this._GetSamplerWrappingDescriptor(e),compare:e._comparisonFunction?o.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:i.anisotropyEnabled?t:1}}static GetCompareFunction(e){switch(e){case 519:return r.wb.Always;case 514:return r.wb.Equal;case 516:return r.wb.Greater;case 518:return r.wb.GreaterEqual;case 513:default:return r.wb.Less;case 515:return r.wb.LessEqual;case 512:return r.wb.Never;case 517:return r.wb.NotEqual}}getSampler(e,t=!1,i=0){if(this.disabled)return this._device.createSampler(o._GetSamplerDescriptor(e));t?i=0:0===i&&(i=o.GetSamplerHashCode(e));let r=t?void 0:this._samplers[i];return r||(r=this._device.createSampler(o._GetSamplerDescriptor(e)),t||(this._samplers[i]=r)),r}}},62274:(e,t,i)=>{i.d(t,{T:()=>a});var r=i(85801),n=i(94274),s=i(72089);i(48736),i(72731);class a{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new r.H(this._device,i,!t._caps.textureFloatLinearFiltering),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"])}clear(e,t,i,r,a=1){var o,l;let u,h,c=null;const d=!!this._engine._currentRenderTarget;if(e)u=e;else{let e=0;this._keyTemp.length=0;for(let t=0;t<this._cacheRenderPipeline.colorFormats.length;++t)this._keyTemp[e++]=s.U[null!==(o=this._cacheRenderPipeline.colorFormats[t])&&void 0!==o?o:""];const n=s.U[null!==(l=this._depthTextureFormat)&&void 0!==l?l:0];if(this._keyTemp[e]=(t?t.r+256*t.g+256*t.b*256+256*t.a*256*256:0)+(i?2**32:0)+(r?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(d?2**35:0)+(a>1?2**36:0)+n*2**37,h=this._keyTemp.join("_"),c=this._bundleCache[h],c)return c;u=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:a})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!r&&!!this._depthTextureFormat&&s.D.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(r?255:0),this._cacheRenderPipeline.setStencilCompare(r?519:512),this._cacheRenderPipeline.setStencilPassOp(r?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);const _=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,a),p=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),p.uniformBuffer.update();const g=d?this._engine._ubInvertY:this._engine._ubDontInvertY,f=p.uniformBuffer.getBuffer(),m=f.uniqueId+"-"+g.uniqueId;let E=this._bindGroups[m];if(!E){const e=p.bindGroupLayouts;E=this._bindGroups[m]=[],E.push(this._device.createBindGroup({layout:e[0],entries:[]})),n.d._SimplifiedKnownBindings||E.push(this._device.createBindGroup({layout:e[1],entries:[]})),E.push(this._device.createBindGroup({layout:e[n.d._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:g.underlyingResource,size:g.capacity}},{binding:1,resource:{buffer:f.underlyingResource,size:f.capacity}}]}))}u.setPipeline(_);for(let e=0;e<E.length;++e)u.setBindGroup(e,E[e]);return u.draw(4,1,0,0),e||(c=u.finish(),this._bundleCache[h]=c),c}}},8724:(e,t,i)=>{var r,n,s,a,o,l,u,h,c,d,_,p,g,f,m,E,T,x,S,b,R,A,y,v,C,B,I,U,P,F,D,w,L,M,O,G,N,V;i.d(t,{$X:()=>f,EG:()=>M,EV:()=>d,FB:()=>a,Gt:()=>x,H7:()=>c,OB:()=>_,Rs:()=>m,V:()=>F,Wf:()=>y,Ws:()=>L,X9:()=>p,YV:()=>R,Zu:()=>G,dV:()=>E,db:()=>B,eS:()=>s,fu:()=>b,gB:()=>P,gc:()=>o,iD:()=>U,kd:()=>l,oD:()=>T,p_:()=>h,v2:()=>u,wb:()=>g,xL:()=>O,xS:()=>I,zX:()=>A,zi:()=>C}),function(e){e.SRGB="srgb"}(r||(r={})),function(e){e.LowPower="low-power",e.HighPerformance="high-performance"}(n||(n={})),function(e){e.DepthClipControl="depth-clip-control",e.Depth24UnormStencil8="depth24unorm-stencil8",e.Depth32FloatStencil8="depth32float-stencil8",e.TextureCompressionBC="texture-compression-bc",e.TextureCompressionETC2="texture-compression-etc2",e.TextureCompressionASTC="texture-compression-astc",e.TimestampQuery="timestamp-query",e.IndirectFirstInstance="indirect-first-instance",e.ShaderF16="shader-f16",e.BGRA8UnormStorage="bgra8unorm-storage"}(s||(s={})),function(e){e[e.MapRead=1]="MapRead",e[e.MapWrite=2]="MapWrite",e[e.CopySrc=4]="CopySrc",e[e.CopyDst=8]="CopyDst",e[e.Index=16]="Index",e[e.Vertex=32]="Vertex",e[e.Uniform=64]="Uniform",e[e.Storage=128]="Storage",e[e.Indirect=256]="Indirect",e[e.QueryResolve=512]="QueryResolve"}(a||(a={})),function(e){e[e.Read=1]="Read",e[e.Write=2]="Write"}(o||(o={})),function(e){e.E1d="1d",e.E2d="2d",e.E3d="3d"}(l||(l={})),function(e){e[e.CopySrc=1]="CopySrc",e[e.CopyDst=2]="CopyDst",e[e.TextureBinding=4]="TextureBinding",e[e.StorageBinding=8]="StorageBinding",e[e.RenderAttachment=16]="RenderAttachment"}(u||(u={})),function(e){e.E1d="1d",e.E2d="2d",e.E2dArray="2d-array",e.Cube="cube",e.CubeArray="cube-array",e.E3d="3d"}(h||(h={})),function(e){e.All="all",e.StencilOnly="stencil-only",e.DepthOnly="depth-only"}(c||(c={})),function(e){e.R8Unorm="r8unorm",e.R8Snorm="r8snorm",e.R8Uint="r8uint",e.R8Sint="r8sint",e.R16Uint="r16uint",e.R16Sint="r16sint",e.R16Float="r16float",e.RG8Unorm="rg8unorm",e.RG8Snorm="rg8snorm",e.RG8Uint="rg8uint",e.RG8Sint="rg8sint",e.R32Uint="r32uint",e.R32Sint="r32sint",e.R32Float="r32float",e.RG16Uint="rg16uint",e.RG16Sint="rg16sint",e.RG16Float="rg16float",e.RGBA8Unorm="rgba8unorm",e.RGBA8UnormSRGB="rgba8unorm-srgb",e.RGBA8Snorm="rgba8snorm",e.RGBA8Uint="rgba8uint",e.RGBA8Sint="rgba8sint",e.BGRA8Unorm="bgra8unorm",e.BGRA8UnormSRGB="bgra8unorm-srgb",e.RGB9E5UFloat="rgb9e5ufloat",e.RGB10A2Unorm="rgb10a2unorm",e.RG11B10UFloat="rg11b10ufloat",e.RG32Uint="rg32uint",e.RG32Sint="rg32sint",e.RG32Float="rg32float",e.RGBA16Uint="rgba16uint",e.RGBA16Sint="rgba16sint",e.RGBA16Float="rgba16float",e.RGBA32Uint="rgba32uint",e.RGBA32Sint="rgba32sint",e.RGBA32Float="rgba32float",e.Stencil8="stencil8",e.Depth16Unorm="depth16unorm",e.Depth24Plus="depth24plus",e.Depth24PlusStencil8="depth24plus-stencil8",e.Depth32Float="depth32float",e.BC1RGBAUnorm="bc1-rgba-unorm",e.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",e.BC2RGBAUnorm="bc2-rgba-unorm",e.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",e.BC3RGBAUnorm="bc3-rgba-unorm",e.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",e.BC4RUnorm="bc4-r-unorm",e.BC4RSnorm="bc4-r-snorm",e.BC5RGUnorm="bc5-rg-unorm",e.BC5RGSnorm="bc5-rg-snorm",e.BC6HRGBUFloat="bc6h-rgb-ufloat",e.BC6HRGBFloat="bc6h-rgb-float",e.BC7RGBAUnorm="bc7-rgba-unorm",e.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",e.ETC2RGB8Unorm="etc2-rgb8unorm",e.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",e.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",e.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",e.ETC2RGBA8Unorm="etc2-rgba8unorm",e.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",e.EACR11Unorm="eac-r11unorm",e.EACR11Snorm="eac-r11snorm",e.EACRG11Unorm="eac-rg11unorm",e.EACRG11Snorm="eac-rg11snorm",e.ASTC4x4Unorm="astc-4x4-unorm",e.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",e.ASTC5x4Unorm="astc-5x4-unorm",e.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",e.ASTC5x5Unorm="astc-5x5-unorm",e.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",e.ASTC6x5Unorm="astc-6x5-unorm",e.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",e.ASTC6x6Unorm="astc-6x6-unorm",e.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",e.ASTC8x5Unorm="astc-8x5-unorm",e.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",e.ASTC8x6Unorm="astc-8x6-unorm",e.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",e.ASTC8x8Unorm="astc-8x8-unorm",e.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",e.ASTC10x5Unorm="astc-10x5-unorm",e.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",e.ASTC10x6Unorm="astc-10x6-unorm",e.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",e.ASTC10x8Unorm="astc-10x8-unorm",e.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",e.ASTC10x10Unorm="astc-10x10-unorm",e.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",e.ASTC12x10Unorm="astc-12x10-unorm",e.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",e.ASTC12x12Unorm="astc-12x12-unorm",e.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",e.Depth24UnormStencil8="depth24unorm-stencil8",e.Depth32FloatStencil8="depth32float-stencil8"}(d||(d={})),function(e){e.ClampToEdge="clamp-to-edge",e.Repeat="repeat",e.MirrorRepeat="mirror-repeat"}(_||(_={})),function(e){e.Nearest="nearest",e.Linear="linear"}(p||(p={})),function(e){e.Never="never",e.Less="less",e.Equal="equal",e.LessEqual="less-equal",e.Greater="greater",e.NotEqual="not-equal",e.GreaterEqual="greater-equal",e.Always="always"}(g||(g={})),function(e){e[e.Vertex=1]="Vertex",e[e.Fragment=2]="Fragment",e[e.Compute=4]="Compute"}(f||(f={})),function(e){e.Uniform="uniform",e.Storage="storage",e.ReadOnlyStorage="read-only-storage"}(m||(m={})),function(e){e.Filtering="filtering",e.NonFiltering="non-filtering",e.Comparison="comparison"}(E||(E={})),function(e){e.Float="float",e.UnfilterableFloat="unfilterable-float",e.Depth="depth",e.Sint="sint",e.Uint="uint"}(T||(T={})),function(e){e.WriteOnly="write-only"}(x||(x={})),function(e){e.Error="error",e.Warning="warning",e.Info="info"}(S||(S={})),function(e){e.Auto="auto"}(b||(b={})),function(e){e.PointList="point-list",e.LineList="line-list",e.LineStrip="line-strip",e.TriangleList="triangle-list",e.TriangleStrip="triangle-strip"}(R||(R={})),function(e){e.CCW="ccw",e.CW="cw"}(A||(A={})),function(e){e.None="none",e.Front="front",e.Back="back"}(y||(y={})),function(e){e[e.Red=1]="Red",e[e.Green=2]="Green",e[e.Blue=4]="Blue",e[e.Alpha=8]="Alpha",e[e.All=15]="All"}(v||(v={})),function(e){e.Zero="zero",e.One="one",e.Src="src",e.OneMinusSrc="one-minus-src",e.SrcAlpha="src-alpha",e.OneMinusSrcAlpha="one-minus-src-alpha",e.Dst="dst",e.OneMinusDst="one-minus-dst",e.DstAlpha="dst-alpha",e.OneMinusDstAlpha="one-minus-dst-alpha",e.SrcAlphaSaturated="src-alpha-saturated",e.Constant="constant",e.OneMinusConstant="one-minus-constant"}(C||(C={})),function(e){e.Add="add",e.Subtract="subtract",e.ReverseSubtract="reverse-subtract",e.Min="min",e.Max="max"}(B||(B={})),function(e){e.Keep="keep",e.Zero="zero",e.Replace="replace",e.Invert="invert",e.IncrementClamp="increment-clamp",e.DecrementClamp="decrement-clamp",e.IncrementWrap="increment-wrap",e.DecrementWrap="decrement-wrap"}(I||(I={})),function(e){e.Uint16="uint16",e.Uint32="uint32"}(U||(U={})),function(e){e.Uint8x2="uint8x2",e.Uint8x4="uint8x4",e.Sint8x2="sint8x2",e.Sint8x4="sint8x4",e.Unorm8x2="unorm8x2",e.Unorm8x4="unorm8x4",e.Snorm8x2="snorm8x2",e.Snorm8x4="snorm8x4",e.Uint16x2="uint16x2",e.Uint16x4="uint16x4",e.Sint16x2="sint16x2",e.Sint16x4="sint16x4",e.Unorm16x2="unorm16x2",e.Unorm16x4="unorm16x4",e.Snorm16x2="snorm16x2",e.Snorm16x4="snorm16x4",e.Float16x2="float16x2",e.Float16x4="float16x4",e.Float32="float32",e.Float32x2="float32x2",e.Float32x3="float32x3",e.Float32x4="float32x4",e.Uint32="uint32",e.Uint32x2="uint32x2",e.Uint32x3="uint32x3",e.Uint32x4="uint32x4",e.Sint32="sint32",e.Sint32x2="sint32x2",e.Sint32x3="sint32x3",e.Sint32x4="sint32x4"}(P||(P={})),function(e){e.Vertex="vertex",e.Instance="instance"}(F||(F={})),function(e){e.Beginning="beginning",e.End="end"}(D||(D={})),function(e){e.Beginning="beginning",e.End="end"}(w||(w={})),function(e){e.Load="load",e.Clear="clear"}(L||(L={})),function(e){e.Store="store",e.Discard="discard"}(M||(M={})),function(e){e.Occlusion="occlusion",e.Timestamp="timestamp"}(O||(O={})),function(e){e.Opaque="opaque",e.Premultiplied="premultiplied"}(G||(G={})),function(e){e.Destroyed="destroyed"}(N||(N={})),function(e){e.OutOfMemory="out-of-memory",e.Validation="validation"}(V||(V={}))},58203:(e,t,i)=>{i.d(t,{K:()=>n});var r=i(29507);class n extends r.k{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(null!=e?e:1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(null!=e?e:2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}},9257:(e,t,i)=>{i.d(t,{g:()=>n});var r=i(8724);class n{isDirty(e){return this._isDirty||this._materialContextUpdateId!==e}resetIsDirty(e){this._isDirty=!1,this._materialContextUpdateId=e}get useInstancing(){return this._useInstancing}set useInstancing(e){this._useInstancing!==e&&(e?(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(40,r.FB.CopyDst|r.FB.Indirect),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this.indirectDrawBuffer&&this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this._useInstancing=e,this._currentInstanceCount=-1)}constructor(e){this._bufferManager=e,this.uniqueId=n._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0}setBuffer(e,t){var i;this._isDirty||(this._isDirty=(null==t?void 0:t.uniqueId)!==(null===(i=this.buffers[e])||void 0===i?void 0:i.uniqueId)),this.buffers[e]=t}setIndirectData(e,t,i){t!==this._currentInstanceCount&&this.indirectDrawBuffer&&this._indirectDrawData&&(this._currentInstanceCount=t,this._indirectDrawData[0]=e,this._indirectDrawData[1]=t,this._indirectDrawData[2]=i,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0}}n._Counter=0},19015:(e,t,i)=>{i.d(t,{Z:()=>a});var r=i(59157),n=i(72739),s=i(8724);class a{get underlyingResource(){return this._webgpuTexture}get msaaTexture(){return this._webgpuMSAATexture}set msaaTexture(e){this._webgpuMSAATexture=e}constructor(e=null){this.format=s.EV.RGBA8Unorm,this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=e,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,i,a,o){t=e!==r.S.RenderTarget&&t,this.createView({format:this.format,dimension:i?s.p_.Cube:s.p_.E2d,mipLevelCount:t?n.R.ILog2(Math.max(a,o))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:i?6:1,aspect:s.H7.All})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){const t=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=t}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){var e,t,i;null===(e=this._webgpuTexture)||void 0===e||e.destroy(),null===(t=this._webgpuMSAATexture)||void 0===t||t.destroy(),null===(i=this._copyInvertYTempTexture)||void 0===i||i.destroy(),this.reset()}}},9460:(e,t,i)=>{i.d(t,{D:()=>s});var r=i(44919),n=i(20955);class s{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatTextures(){return this._numFloatTextures>0}constructor(){this.uniqueId=s._Counter++,this.updateId=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatTextures=0,this._numExternalTextures=0}setSampler(e,t){let i=this.samplers[e],r=-1;i?r=i.hashCode:this.samplers[e]=i={sampler:t,hashCode:0},i.sampler=t,i.hashCode=t?n.W.GetSamplerHashCode(t):0;const s=r!==i.hashCode;s&&this.updateId++,this.isDirty||(this.isDirty=s)}setTexture(e,t){var i,n,s;let a=this.textures[e],o=-1;a?o=null!==(n=null===(i=a.texture)||void 0===i?void 0:i.uniqueId)&&void 0!==n?n:-1:this.textures[e]=a={texture:t,isFloatTexture:!1,isExternalTexture:!1},a.isExternalTexture&&this._numExternalTextures--,a.isFloatTexture&&this._numFloatTextures--,t?(a.isFloatTexture=1===t.type,a.isExternalTexture=r.x.IsExternalTexture(t),a.isFloatTexture&&this._numFloatTextures++,a.isExternalTexture&&this._numExternalTextures++):(a.isFloatTexture=!1,a.isExternalTexture=!1),a.texture=t;const l=o!==(null!==(s=null==t?void 0:t.uniqueId)&&void 0!==s?s:-1);l&&this.updateId++,this.isDirty||(this.isDirty=l)}}s._Counter=0},85900:(e,t,i)=>{i.d(t,{D:()=>s});var r=i(8724),n=i(22812);class s{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}get canBeginQuery(){switch(this._engine._getCurrentRenderPassIndex()){case 0:return void 0!==this._engine._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet;case 1:return void 0!==this._engine._rttRenderPassWrapper.renderPassDescriptor.occlusionQuerySet}return!1}constructor(e,t,i,r=50,n=100){this._availableIndices=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=n,this._allocateNewIndices(r)}createQuery(){0===this._availableIndices.length&&this._allocateNewIndices();const e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length-1]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){var t,i;return Number(null!==(i=null===(t=this._lastBuffer)||void 0===t?void 0:t[e])&&void 0!==i?i:-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then((e=>{this._lastBuffer=e})))}_allocateNewIndices(e){e=null!=e?e:this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new n.t(this._currentTotalIndices,r.xL.Occlusion,this._device,this._bufferManager,!1)}_delayQuerySetDispose(){const e=this._querySet;e&&setTimeout((()=>e.dispose),1e3)}dispose(){var e;null===(e=this._querySet)||void 0===e||e.dispose(),this._availableIndices.length=0}}},88934:(e,t,i)=>{i.d(t,{$:()=>s});var r=i(83353),n=i(50113);class s{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,i,r,n,s,a,o){const l=this.engine;e._fragmentSourceCode="",e._vertexSourceCode="";const u=this.shaderProcessingContext.availableTextures;let h;for(h=0;h<n.length;h++){const e=n[h],t=u[n[h]];null==t||null==t?(n.splice(h,1),h--):s[e]=h}for(const e of l.getAttributes(this,a))o.push(e);this.buildUniformLayout();const c=[],d=[];for(h=0;h<a.length;h++){const e=o[h];e>=0&&(c.push(a[h]),d.push(e))}this.shaderProcessingContext.attributeNamesFromEffect=c,this.shaderProcessingContext.attributeLocationsFromEffect=d}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer=new r.M(this.engine,void 0,void 0,"leftOver-"+this._name);for(const e of this.shaderProcessingContext.leftOverUniforms){const t=e.type.replace(/^(.*?)(<.*>)?$/,"$1"),i=n.e.UniformSizes[t];this.uniformBuffer.addUniform(e.name,i,e.length),this._leftOverUniformsByName[e.name]=e.type}this.uniformBuffer.create()}}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt(e,t)}setInt2(e,t,i){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt2(e,t,i)}setInt3(e,t,i,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt3(e,t,i,r)}setInt4(e,t,i,r,n){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt4(e,t,i,r,n)}setIntArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,i){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt2(e,t,i)}setUInt3(e,t,i,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt3(e,t,i,r)}setUInt4(e,t,i,r,n){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt4(e,t,i,r,n)}setUIntArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,i){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat2(e,t,i)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,i,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat3(e,t,i,r)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,i,r,n){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat4(e,t,i,r,n)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){var e;return null===(e=this.sources)||void 0===e?void 0:e.vertex}_getFragmentShaderCode(){var e;return null===(e=this.sources)||void 0===e?void 0:e.fragment}}},22812:(e,t,i)=>{i.d(t,{t:()=>n});var r=i(8724);class n{get querySet(){return this._querySet}constructor(e,t,i,n,s=!0){this._dstBuffers=[],this._device=i,this._bufferManager=n,this._count=e,this._canUseMultipleBuffers=s,this._querySet=i.createQuerySet({type:t,count:e}),this._queryBuffer=n.createRawBuffer(8*e,r.FB.QueryResolve|r.FB.CopySrc),s||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,r.FB.MapRead|r.FB.CopyDst))}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&0===this._dstBuffers.length)return null;const i=this._device.createCommandEncoder();let n;return 0===this._dstBuffers.length?n=this._bufferManager.createRawBuffer(8*this._count,r.FB.MapRead|r.FB.CopyDst):(n=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),i.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),i.copyBufferToBuffer(this._queryBuffer,0,n,0,8*t),this._device.queue.submit([i.finish()]),n}async readValues(e=0,t=1){const i=this._getBuffer(e,t);if(null===i)return null;await i.mapAsync(r.gc.Read);const n=new BigUint64Array(i.getMappedRange()).slice();return i.unmap(),this._dstBuffers[this._dstBuffers.length]=i,n}async readValue(e=0){const t=this._getBuffer(e,1);if(null===t)return null;await t.mapAsync(r.gc.Read);const i=new BigUint64Array(t.getMappedRange()),n=Number(i[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,n}async readTwoValuesAndSubtract(e=0){const t=this._getBuffer(e,2);if(null===t)return null;await t.mapAsync(r.gc.Read);const i=new BigUint64Array(t.getMappedRange()),n=Number(i[1]-i[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,n}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}},54231:(e,t,i)=>{i.d(t,{B:()=>r});class r{constructor(){this.colorAttachmentGPUTextures=[],this.reset()}reset(e=!1){this.renderPass=null,e&&(this.renderPassDescriptor=null,this.colorAttachmentViewDescriptor=null,this.depthAttachmentViewDescriptor=null,this.colorAttachmentGPUTextures=[],this.depthTextureFormat=void 0)}}},94274:(e,t,i)=>{i.d(t,{d:()=>n});const r={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};class n{static get KnownUBOs(){return n._SimplifiedKnownBindings?n._SimplifiedKnownUBOs:n._KnownUBOs}constructor(e){this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],this._findStartingGroupBinding()}_findStartingGroupBinding(){const e=n.KnownUBOs,t=[];for(const i in e){const r=e[i].binding;-1!==r.groupIndex&&(void 0===t[r.groupIndex]?t[r.groupIndex]=r.bindingIndex:t[r.groupIndex]=Math.max(t[r.groupIndex],r.bindingIndex))}this.freeGroupIndex=t.length-1,0===this.freeGroupIndex?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1}getAttributeNextLocation(e,t=0){var i;const n=this._attributeNextLocation;return this._attributeNextLocation+=(null!==(i=r[e])&&void 0!==i?i:1)*(t||1),n}getVaryingNextLocation(e,t=0){var i;const n=this._varyingNextLocation;return this._varyingNextLocation+=(null!==(i=r[e])&&void 0!==i?i:1)*(t||1),n}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(e){if(this.freeBindingIndex>65536-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),4===this.freeGroupIndex)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";const t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t}}n._SimplifiedKnownBindings=!0,n._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},n._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}}},50113:(e,t,i)=>{i.d(t,{e:()=>s});var r=i(41659),n=i(8724);class s{constructor(){this.shaderLanguage=r.x.GLSL}_addUniformToLeftOverUBO(e,t,i){let r=0;[e,t,r]=this._getArraySize(e,t,i);for(let t=0;t<this._webgpuProcessingContext.leftOverUniforms.length;t++)if(this._webgpuProcessingContext.leftOverUniforms[t].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:r})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";const e=s.LeftOvertUBOName;let t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,n.Rs.Uniform,!0),this._addBufferBindingDescription(e,t,n.Rs.Uniform,!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(void 0!==t)for(let i=0;i<t.length;i++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e][i],r=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][t.binding].name,n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][t.binding].nameInArrayOfTexture;t&&(t.texture||t.externalTexture||t.storageTexture?this._webgpuProcessingContext.textureNames.push(n):t.sampler?this._webgpuProcessingContext.samplerNames.push(r):t.buffer&&this._webgpuProcessingContext.bufferNames.push(r))}else this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[]}}_preCreateBindGroupEntries(){const e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){const i=this._webgpuProcessingContext.bindGroupLayoutEntries[t],r=[];for(let e=0;e<i.length;e++){const i=this._webgpuProcessingContext.bindGroupLayoutEntries[t][e];i.sampler||i.texture||i.storageTexture||i.externalTexture?r.push({binding:i.binding,resource:void 0}):i.buffer&&r.push({binding:i.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=r}}_addTextureBindingDescription(e,t,i,r,s,a){let{groupIndex:o,bindingIndex:l}=t.textures[i];if(this._webgpuProcessingContext.bindGroupLayoutEntries[o]||(this._webgpuProcessingContext.bindGroupLayoutEntries[o]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l]){let a;a=null===r?this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,externalTexture:{}}):s?this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,storageTexture:{access:n.Gt.WriteOnly,format:s,viewDimension:r}}):this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,texture:{sampleType:t.sampleType,viewDimension:r,multisampled:!1}});const u=t.isTextureArray?e+i:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l]={name:e,index:a-1,nameInArrayOfTexture:u}}l=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l].index,this._webgpuProcessingContext.bindGroupLayoutEntries[o][l].visibility|=a?n.$X.Vertex:n.$X.Fragment}_addSamplerBindingDescription(e,t,i){let{groupIndex:r,bindingIndex:s}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[r]||(this._webgpuProcessingContext.bindGroupLayoutEntries[r]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][s]){const i=this._webgpuProcessingContext.bindGroupLayoutEntries[r].push({binding:s,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][s]={name:e,index:i-1}}s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][s].index,this._webgpuProcessingContext.bindGroupLayoutEntries[r][s].visibility|=i?n.$X.Vertex:n.$X.Fragment}_addBufferBindingDescription(e,t,i,r){let{groupIndex:s,bindingIndex:a}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[s]||(this._webgpuProcessingContext.bindGroupLayoutEntries[s]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][a]){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[s].push({binding:a,visibility:0,buffer:{type:i}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][a]={name:e,index:t-1}}a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][a].index,this._webgpuProcessingContext.bindGroupLayoutEntries[s][a].visibility|=r?n.$X.Vertex:n.$X.Fragment}_injectStartingAndEndingCode(e,t,i,r){let n=e.indexOf(t);if(n<0)return console.error('No "main" function found in shader code! Processing aborted.'),e;if(i){for(;n++<e.length&&"{"!=e.charAt(n););if(n<e.length){const t=e.substring(0,n+1),r=e.substring(n+1);e=t+i+r}}if(r){const t=e.lastIndexOf("}");e=e.substring(0,t),e+=r+"\n}"}return e}}s.AutoSamplerSuffix="Sampler",s.LeftOvertUBOName="LeftOver",s.InternalsUBOName="Internals",s.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,vec3:3,ivec3:3,vec4:4,ivec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16},s._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"},s._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"},s._GpuTextureViewDimensionByWebGPUTextureType={textureCube:n.p_.Cube,textureCubeArray:n.p_.CubeArray,texture2D:n.p_.E2d,texture2DArray:n.p_.E2dArray,texture3D:n.p_.E3d},s._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},s._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1}},86937:(e,t,i)=>{i.d(t,{s:()=>l});var r=i(94274),n=i(8724),s=i(84318),a=i(50113),o=i(41659);class l extends a.e{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=o.x.GLSL,this.parseGLES3=!0}_getArraySize(e,t,i){let r=0;const n=e.indexOf("["),s=e.indexOf("]");if(n>0&&s>0){const t=e.substring(n+1,s);r=+t,isNaN(r)&&(r=+i[t.trim()]),e=e.substr(0,n)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){const i=`// Internals UBO\r\nuniform ${a.e.InternalsUBOName} {\nfloat yFactor_;\nfloat textureOutputHeight_;\n};\n`,r=-1!==e.indexOf("// Internals UBO");return t?(this._fragmentIsGLES3=-1!==e.indexOf("#version 3"),this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),r?e:i+"##INJECTCODE##\n"+e):(this._vertexIsGLES3=-1!==e.indexOf("#version 3"),this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),r?e:i+e)}varyingProcessor(e,t,i){this._preProcessors=i;const r=(t&&this._fragmentIsGLES3?/\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:!t&&this._vertexIsGLES3?/\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==r){const n=r[1],a=r[2];let o;t?(o=this._webgpuProcessingContext.availableVaryings[a],this._missingVaryings[o]="",void 0===o&&s.Y.Warn(`Invalid fragment shader: The varying named "${a}" is not declared in the vertex shader! This declaration will be ignored.`)):(o=this._webgpuProcessingContext.getVaryingNextLocation(n,this._getArraySize(a,n,i)[2]),this._webgpuProcessingContext.availableVaryings[a]=o,this._missingVaryings[o]=`layout(location = ${o}) in ${n} ${a};`),e=e.replace(r[0],void 0===o?"":`layout(location = ${o}) ${t?"in":"out"} ${n} ${a};`)}return e}attributeProcessor(e,t){this._preProcessors=t;const i=(this._vertexIsGLES3?/\s*in\s+(\S+)\s+(\S+)\s*;/gm:/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==i){const r=i[1],n=i[2],s=this._webgpuProcessingContext.getAttributeNextLocation(r,this._getArraySize(n,r,t)[2]);this._webgpuProcessingContext.availableAttributes[n]=s,this._webgpuProcessingContext.orderedAttributes[s]=n,e=e.replace(i[0],`layout(location = ${s}) in ${r} ${n};`)}return e}uniformProcessor(e,t,i){var r;this._preProcessors=i;const s=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==s){let o=s[1],l=s[2];if(0===o.indexOf("sampler")||1===o.indexOf("sampler")){let s=0;[l,o,s]=this._getArraySize(l,o,i);let u=this._webgpuProcessingContext.availableTextures[l];if(!u){u={autoBindSampler:!0,isTextureArray:s>0,isStorageTexture:!1,textures:[],sampleType:n.oD.Float};for(let e=0;e<(s||1);++e)u.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}const h=null!==(r=a.e._SamplerTypeByWebGLSamplerType[o])&&void 0!==r?r:"sampler",c=!!a.e._IsComparisonSamplerByWebGPUSamplerType[h],d=c?n.dV.Comparison:n.dV.Filtering,_=l+a.e.AutoSamplerSuffix;let p=this._webgpuProcessingContext.availableSamplers[_];p||(p={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:d});const g="u"===o.charAt(0)?"u":"i"===o.charAt(0)?"i":"";g&&(o=o.substr(1));const f=c?n.oD.Depth:"u"===g?n.oD.Uint:"i"===g?n.oD.Sint:n.oD.Float;u.sampleType=f;const m=s>0,E=p.binding.groupIndex,T=p.binding.bindingIndex,x=a.e._SamplerFunctionByWebGLSamplerType[o],S=a.e._TextureTypeByWebGLSamplerType[o],b=a.e._GpuTextureViewDimensionByWebGPUTextureType[S];if(m){const t=[];t.push(`layout(set = ${E}, binding = ${T}) uniform ${g}${h} ${_};`),e="\r\n";for(let i=0;i<s;++i){const r=u.textures[i].groupIndex,n=u.textures[i].bindingIndex;t.push(`layout(set = ${r}, binding = ${n}) uniform ${S} ${l}Texture${i};`),e+=`${i>0?"\r\n":""}#define ${l}${i} ${g}${x}(${l}Texture${i}, ${_})`}e=t.join("\r\n")+e,this._textureArrayProcessing.push(l)}else s=1,e=`layout(set = ${E}, binding = ${T}) uniform ${g}${h} ${_};\n                        layout(set = ${u.textures[0].groupIndex}, binding = ${u.textures[0].bindingIndex}) uniform ${S} ${l}Texture;\n                        #define ${l} ${g}${x}(${l}Texture, ${_})`;this._webgpuProcessingContext.availableTextures[l]=u,this._webgpuProcessingContext.availableSamplers[_]=p,this._addSamplerBindingDescription(_,p,!t);for(let e=0;e<s;++e)this._addTextureBindingDescription(l,u,e,b,null,!t)}else this._addUniformToLeftOverUBO(l,o,i),e=""}return e}uniformBufferProcessor(e,t){const i=/uniform\s+(\w+)/gm.exec(e);if(null!==i){const s=i[1];let a=this._webgpuProcessingContext.availableBuffers[s];if(!a){const e=r.d.KnownUBOs[s];let t;t=e&&-1!==e.binding.groupIndex?e.binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),a={binding:t},this._webgpuProcessingContext.availableBuffers[s]=a}this._addBufferBindingDescription(s,a,n.Rs.Uniform,!t),e=e.replace("uniform",`layout(set = ${a.binding.groupIndex}, binding = ${a.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,r,n){const s=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){const t=e.indexOf("gl_FragCoord")>=0,i="\n                glFragCoord_ = gl_FragCoord;\n                if (yFactor_ == 1.) {\n                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;\n                }\n            ",r=t?"vec4 glFragCoord_;\n":"";if(e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/gl_FragCoord/g,"glFragCoord_"),this._fragmentIsGLES3){const t=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);null!==t&&(e=e.substring(0,t.index)+"layout(location = 0) "+e.substring(t.index))}else e=e.replace(/void\s+?main\s*\(/g,(s?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");e=(e=e.replace(/dFdy/g,"(-yFactor_)*dFdy")).replace("##INJECTCODE##",r),t&&(e=this._injectStartingAndEndingCode(e,"void main",i))}else{e=(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex")).replace(/gl_VertexID/g,"gl_VertexIndex");if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e}if(!i){const t=e.lastIndexOf("}");e=e.substring(0,t),e+="gl_Position.y *= yFactor_;\n",n.isNDCHalfZRange||(e+="gl_Position.z = (gl_Position.z + gl_Position.w) / 2.0;\n"),e+="}"}return e}_applyTextureArrayProcessing(e,t){const i=new RegExp(t+"\\s*\\[(.+)?\\]","gm");let r=i.exec(e);for(;null!==r;){const n=r[1];let s=+n;this._preProcessors&&isNaN(s)&&(s=+this._preProcessors[n.trim()]),e=e.replace(r[0],t+s),r=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {\n    `;for(const e of this._webgpuProcessingContext.leftOverUniforms)e.length>0?i+=`    ${e.type} ${e.name}[${e.length}];\n`:i+=`    ${e.type} ${e.name};\n`;return i+="};\n\n",i}finalizeShaders(e,t){for(let i=0;i<this._textureArrayProcessing.length;++i){const r=this._textureArrayProcessing[i];e=this._applyTextureArrayProcessing(e,r),t=this._applyTextureArrayProcessing(t,r)}for(let e=0;e<this._missingVaryings.length;++e){const i=this._missingVaryings[e];i&&i.length>0&&(t=i+"\n"+t)}const i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,{vertexCode:e,fragmentCode:t}}}},15212:(e,t,i)=>{i.d(t,{o:()=>c});var r=i(94274),n=i(8724),s=i(84318),a=i(50113),o=i(31259),l=(i(94112),i(27764),i(20349),i(74529),i(93350),i(99498),i(5932),i(55393),i(82618),i(64957),i(27880),i(7174),i(53223),i(95375),i(84825),i(38527),i(41659));const u="gl_FragDepth",h={texture_1d:n.p_.E1d,texture_2d:n.p_.E2d,texture_2d_array:n.p_.E2dArray,texture_3d:n.p_.E3d,texture_cube:n.p_.Cube,texture_cube_array:n.p_.CubeArray,texture_multisampled_2d:n.p_.E2d,texture_depth_2d:n.p_.E2d,texture_depth_2d_array:n.p_.E2dArray,texture_depth_cube:n.p_.Cube,texture_depth_cube_array:n.p_.CubeArray,texture_depth_multisampled_2d:n.p_.E2d,texture_storage_1d:n.p_.E1d,texture_storage_2d:n.p_.E2d,texture_storage_2d_array:n.p_.E2dArray,texture_storage_3d:n.p_.E3d,texture_external:null};class c extends a.e{constructor(){super(...arguments),this.shaderLanguage=l.x.WGSL,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0}_getArraySize(e,t,i){let r=0;const n=t.lastIndexOf(">");if(t.indexOf("array")>=0&&n>0){let e=n;for(;e>0&&" "!==t.charAt(e)&&","!==t.charAt(e);)e--;const s=t.substring(e+1,n);for(r=+s,isNaN(r)&&(r=+i[s.trim()]);e>0&&(" "===t.charAt(e)||","===t.charAt(e));)e--;t=t.substring(t.indexOf("<")+1,e+1)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesWGSL=[],this._attributesDeclWGSL=[],this._attributeNamesWGSL=[],this._varyingsWGSL=[],this._varyingsDeclWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){return`struct ${a.e.InternalsUBOName} {\nyFactor_: f32,\ntextureOutputHeight_: f32,\n};\nvar<uniform> internals : ${a.e.InternalsUBOName};\n`+(0,o.Kt)(e)}varyingProcessor(e,t,i){const r=/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==r){const n=r[2],a=r[1];let o;t?(o=this._webgpuProcessingContext.availableVaryings[a],void 0===o&&s.Y.Warn(`Invalid fragment shader: The varying named "${a}" is not declared in the vertex shader! This declaration will be ignored.`)):(o=this._webgpuProcessingContext.getVaryingNextLocation(n,this._getArraySize(a,n,i)[2]),this._webgpuProcessingContext.availableVaryings[a]=o,this._varyingsWGSL.push(`@location(${o}) ${a} : ${n},`),this._varyingsDeclWGSL.push(`var<private> ${a} : ${n};`),this._varyingNamesWGSL.push(a)),e=""}return e}attributeProcessor(e,t){const i=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==i){const r=i[2],n=i[1],s=this._webgpuProcessingContext.getAttributeNextLocation(r,this._getArraySize(n,r,t)[2]);this._webgpuProcessingContext.availableAttributes[n]=s,this._webgpuProcessingContext.orderedAttributes[s]=n,this._attributesWGSL.push(`@location(${s}) ${n} : ${r},`),this._attributesDeclWGSL.push(`var<private> ${n} : ${r};`),this._attributeNamesWGSL.push(n),e=""}return e}uniformProcessor(e,t,i){const r=this.uniformRegexp.exec(e);if(null!==r){const t=r[2],n=r[1];this._addUniformToLeftOverUBO(n,t,i),e=""}return e}textureProcessor(e,t,i){const r=this.textureRegexp.exec(e);if(null!==r){const s=r[1],a=r[2],o=!!r[3],l=r[4],u=l.indexOf("storage")>0,c=r[6],d=u?c.substring(0,c.indexOf(",")).trim():null;let _=o?this._getArraySize(s,a,i)[2]:0,p=this._webgpuProcessingContext.availableTextures[s];if(p)_=p.textures.length;else{p={isTextureArray:_>0,isStorageTexture:u,textures:[],sampleType:n.oD.Float},_=_||1;for(let e=0;e<_;++e)p.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[s]=p;const g=l.indexOf("depth")>0,f=h[l],m=g?n.oD.Depth:"u32"===c?n.oD.Uint:"i32"===c?n.oD.Sint:n.oD.Float;if(p.sampleType=m,void 0===f)throw`Can't get the texture dimension corresponding to the texture function "${l}"!`;for(let i=0;i<_;++i){const{groupIndex:r,bindingIndex:n}=p.textures[i];0===i&&(e=`@group(${r}) @binding(${n}) ${e}`),this._addTextureBindingDescription(s,p,i,f,d,!t)}}return e}postProcessor(e){return e}finalizeShaders(e,t){const i=t.indexOf("gl_FragCoord")>=0?"\n            if (internals.yFactor_ == 1.) {\n                gl_FragCoord.y = internals.textureOutputHeight_ - gl_FragCoord.y;\n            }\n        ":"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);const r=this._buildLeftOverUBO();t=r+t,e=(e=r+e).replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);const n=this._varyingsDeclWGSL.join("\n")+"\n",s=this._attributesDeclWGSL.join("\n")+"\n";let a="struct VertexInputs {\n  @builtin(vertex_index) vertexIndex : u32,\n  @builtin(instance_index) instanceIndex : u32,\n";this._attributesWGSL.length>0&&(a+=this._attributesWGSL.join("\n")),a+="\n};\n";let o="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n";this._varyingsWGSL.length>0&&(o+=this._varyingsWGSL.join("\n")),o+="\n};\n",e="var<private> gl_VertexID : u32;\nvar<private> gl_InstanceID : u32;\nvar<private> gl_Position : vec4<f32>;\n"+a+s+o+n+e;let l="  var output : FragmentInputs;\n  gl_VertexID = input.vertexIndex;\n  gl_InstanceID = input.instanceIndex;\n";for(let e=0;e<this._attributeNamesWGSL.length;++e){const t=this._attributeNamesWGSL[e];l+=`  ${t} = input.${t};\n`}let h="  output.position = gl_Position;\n  output.position.y = output.position.y * internals.yFactor_;\n";for(let e=0;e<this._varyingNamesWGSL.length;++e){const t=this._varyingNamesWGSL[e];h+=`  output.${t} = ${t};\n`}h+="  return output;",e=this._injectStartingAndEndingCode(e,"fn main",l,h),t=t.replace(/#define /g,"//#define "),t=(t=this._processStridedUniformArrays(t)).replace(/dpdy/g,"(-internals.yFactor_)*dpdy");let c="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n  @builtin(front_facing) frontFacing : bool,\n";this._varyingsWGSL.length>0&&(c+=this._varyingsWGSL.join("\n")),c+="\n};\n";let d="struct FragmentOutputs {\n  @location(0) color : vec4<f32>,\n",_=!1,p=0;for(;!(_||(p=t.indexOf(u,p),p<0));){const e=p;for(_=!0;p>1&&"\n"!==t.charAt(p);){if("/"===t.charAt(p)&&"/"===t.charAt(p-1)){_=!1;break}p--}p=e+u.length}_&&(d+="  @builtin(frag_depth) fragDepth: f32,\n"),d+="};\n",t="var<private> gl_FragCoord : vec4<f32>;\nvar<private> gl_FrontFacing : bool;\nvar<private> gl_FragColor : vec4<f32>;\nvar<private> gl_FragDepth : f32;\n"+c+n+d+t;let g="  var output : FragmentOutputs;\n  gl_FragCoord = input.position;\n  gl_FrontFacing = input.frontFacing;\n"+i;for(let e=0;e<this._varyingNamesWGSL.length;++e){const t=this._varyingNamesWGSL[e];g+=`  ${t} = input.${t};\n`}let f="  output.color = gl_FragColor;\n";return _&&(f+="  output.fragDepth = gl_FragDepth;\n"),f+="  return output;",t=this._injectStartingAndEndingCode(t,"fn main",g,f),this._collectBindingNames(),this._preCreateBindGroupEntries(),{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",r=`struct ${e} {\n`;for(const t of this._webgpuProcessingContext.leftOverUniforms){const n=t.type.replace(/^(.*?)(<.*>)?$/,"$1"),s=a.e.UniformSizes[n];if(t.length>0)if(s<=2){const s=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${s} {\n                        @size(16)\n                        el: ${n},\n                    }`,this._stridedUniformArrays.push(t.name),r+=` @align(16) ${t.name} : array<${s}, ${t.length}>,\n`}else r+=` ${t.name} : array<${t.type}, ${t.length}>,\n`;else r+=`  ${t.name} : ${t.type},\n`}return r+="};\n",r=`${i}\n${r}`,r+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> uniforms : ${e};\n`,r}_processSamplers(e,t){const i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){const r=i.exec(e);if(null===r)break;const s=r[1],o=r[2],l=s.indexOf(a.e.AutoSamplerSuffix)===s.length-a.e.AutoSamplerSuffix.length?s.substring(0,s.indexOf(a.e.AutoSamplerSuffix)):null,u="sampler_comparison"===o?n.dV.Comparison:n.dV.Filtering;if(l){const e=this._webgpuProcessingContext.availableTextures[l];e&&(e.autoBindSampler=!0)}let h=this._webgpuProcessingContext.availableSamplers[s];h||(h={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:u},this._webgpuProcessingContext.availableSamplers[s]=h),this._addSamplerBindingDescription(s,h,t);const c=e.substring(0,r.index),d=`@group(${h.binding.groupIndex}) @binding(${h.binding.bindingIndex}) `,_=e.substring(r.index);e=c+d+_,i.lastIndex+=d.length}return e}_processCustomBuffers(e,t){const i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){const s=i.exec(e);if(null===s)break;const a=s[1],o=s[3];let l=s[4];const u=s[5];let h=this._webgpuProcessingContext.availableBuffers[l];if(!h){const e="uniform"===a?r.d.KnownUBOs[u]:null;let t;e?(l=u,t=e.binding,-1===t.groupIndex&&(t=this._webgpuProcessingContext.getNextFreeUBOBinding())):t=this._webgpuProcessingContext.getNextFreeUBOBinding(),h={binding:t},this._webgpuProcessingContext.availableBuffers[l]=h}this._addBufferBindingDescription(l,this._webgpuProcessingContext.availableBuffers[l],"read_write"===o?n.Rs.Storage:"storage"===a?n.Rs.ReadOnlyStorage:n.Rs.Uniform,t);const c=h.binding.groupIndex,d=h.binding.bindingIndex,_=e.substring(0,s.index),p=`@group(${c}) @binding(${d}) `,g=e.substring(s.index);e=_+p+g,i.lastIndex+=p.length}return e}_processStridedUniformArrays(e){for(const t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*)\\]`,"g"),`${t}[$1].el`);return e}}},44344:(e,t,i)=>{i.d(t,{w:()=>r});class r{constructor(e,t,i,r){this._record=!1,this._play=!1,this._mainPassBundleList=[],this._enabled=!1,this._engine=e,this._mode=t,this._bundleList=i,this._bundleListRenderTarget=r}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._mainPassBundleList.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endMainRenderPass(){this._record&&this._mainPassBundleList.push(this._bundleList.clone())}endRenderTargetPass(e,t){var i,r,n,s;if(this._play)null===(r=null===(i=t._bundleLists)||void 0===i?void 0:i[t._currentLayer])||void 0===r||r.run(e),1===this._mode&&this._engine._reportDrawCall(null===(s=null===(n=t._bundleLists)||void 0===n?void 0:n[t._currentLayer])||void 0===s?void 0:s.numDrawCalls);else{if(!this._record)return!1;t._bundleLists||(t._bundleLists=[]),t._bundleLists[t._currentLayer]=this._bundleListRenderTarget.clone(),t._bundleLists[t._currentLayer].run(e),this._bundleListRenderTarget.reset()}return!0}endFrame(e){if(this._record&&(this._mainPassBundleList.push(this._bundleList.clone()),this._record=!1,this._play=!0,this._mode=this._modeSaved),null!==e&&this._play)for(let t=0;t<this._mainPassBundleList.length;++t)this._mainPassBundleList[t].run(e),1===this._mode&&this._engine._reportDrawCall(this._mainPassBundleList[t].numDrawCalls)}reset(){this.enabled=!1,this.enabled=!0}}},86980:(e,t,i)=>{i.d(t,{F:()=>n});var r=i(61625);class n extends r.C{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){var e;const t=null===(e=this.stencilMaterial)||void 0===e?void 0:e.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask)}}},72089:(e,t,i)=>{i.d(t,{D:()=>d,U:()=>c});var r=i(8724),n=i(72739),s=i(59157),a=i(19015);const o="\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) out flat ivec2 vTextureSize;\n    #endif\n\n    void main() {\n        #ifdef INVERTY\n            vTextureSize = textureSize(img, 0);\n        #endif\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ";var l,u;!function(e){e[e.MipMap=0]="MipMap",e[e.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",e[e.Clear=2]="Clear",e[e.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst"}(l||(l={})),function(e){e[e.DontInvertY=0]="DontInvertY",e[e.InvertY=1]="InvertY"}(u||(u={}));const h=[{vertex:"\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(location = 0) out vec2 vTex;\n\n    void main() {\n        vTex = tex[gl_VertexIndex];\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    layout(set = 0, binding = 0) uniform sampler imgSampler;\n    layout(set = 0, binding = 1) uniform texture2D img;\n\n    layout(location = 0) in vec2 vTex;\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        outColor = texture(sampler2D(img, imgSampler), vTex);\n    }\n    "},{vertex:o,fragment:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) in flat ivec2 vTextureSize;\n    #endif\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n    #ifdef INVERTY\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, vTextureSize.y - gl_FragCoord.y), 0);\n    #else\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color.rgb *= color.a;\n    #endif\n        outColor = color;\n    }\n    "},{vertex:"\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n\n    void main() {\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    layout(set = 0, binding = 0) uniform Uniforms {\n        uniform vec4 color;\n    };\n\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        outColor = color;\n    }\n    "},{vertex:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) out flat ivec2 vTextureSize;\n    #endif\n\n    void main() {\n        #ifdef INVERTY\n            vTextureSize = textureSize(img, 0);\n        #endif\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n    layout(set = 0, binding = 1) uniform Params {\n        float ofstX;\n        float ofstY;\n        float width;\n        float height;\n    };\n\n    #ifdef INVERTY\n        layout(location = 0) in flat ivec2 vTextureSize;\n    #endif\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        if (gl_FragCoord.x < ofstX || gl_FragCoord.x >= ofstX + width) {\n            discard;\n        }\n        if (gl_FragCoord.y < ofstY || gl_FragCoord.y >= ofstY + height) {\n            discard;\n        }\n    #ifdef INVERTY\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, ofstY + height - (gl_FragCoord.y - ofstY)), 0);\n    #else\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color.rgb *= color.a;\n    #endif\n        outColor = color;\n    }\n    "}],c={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2unorm:22,rg32uint:23,rg32sint:24,rg32float:25,rgba16uint:26,rgba16sint:27,rgba16float:28,rgba32uint:29,rgba32sint:30,rgba32float:31,stencil8:32,depth16unorm:33,depth24plus:34,"depth24plus-stencil8":35,depth32float:36,"depth24unorm-stencil8":37,"depth32float-stencil8":38};class d{static ComputeNumMipmapLevels(e,t){return n.R.ILog2(Math.max(e,t))+1}constructor(e,t,i,n){this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._device=e,this._glslang=t,this._tintWASM=i,this._bufferManager=n,this._mipmapSampler=e.createSampler({minFilter:r.X9.Linear}),this._videoSampler=e.createSampler({minFilter:r.X9.Linear}),this._ubCopyWithOfst=this._bufferManager.createBuffer(16,r.FB.Uniform|r.FB.CopyDst).underlyingResource,this._getPipeline(r.EV.RGBA8Unorm),this._getVideoPipeline(r.EV.RGBA8Unorm)}_getPipeline(e,t=l.MipMap,i){const n=t===l.MipMap?1:t===l.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===l.Clear?8:t===l.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let s=this._pipelines[e][n];if(!s){let a="#version 450\r\n";t!==l.InvertYPremultiplyAlpha&&t!==l.InvertYPremultiplyAlphaWithOfst||(i.invertY&&(a+="#define INVERTY\r\n"),i.premultiplyAlpha&&(a+="#define PREMULTIPLYALPHA\r\n"));let o=this._compiledShaders[n];if(!o){let e=this._glslang.compileGLSL(a+h[t].vertex,"vertex"),i=this._glslang.compileGLSL(a+h[t].fragment,"fragment");this._tintWASM&&(e=this._tintWASM.convertSpirV2WGSL(e),i=this._tintWASM.convertSpirV2WGSL(i));const r=this._device.createShaderModule({code:e}),s=this._device.createShaderModule({code:i});o=this._compiledShaders[n]=[r,s]}const u=this._device.createRenderPipeline({layout:r.fu.Auto,vertex:{module:o[0],entryPoint:"main"},fragment:{module:o[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:r.YV.TriangleStrip,stripIndexFormat:r.iD.Uint16}});s=this._pipelines[e][n]=[u,u.getBindGroupLayout(0)]}return s}_getVideoPipeline(e,t=u.DontInvertY){const i=t===u.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let n=this._videoPipelines[e][i];if(!n){let t=this._videoCompiledShaders[i];if(!t){const e=this._device.createShaderModule({code:"\n    struct VertexOutput {\n        @builtin(position) Position : vec4<f32>,\n        @location(0) fragUV : vec2<f32>\n    }\n  \n    @vertex\n    fn main(\n        @builtin(vertex_index) VertexIndex : u32\n    ) -> VertexOutput {\n        var pos = array<vec2<f32>, 4>(\n            vec2(-1.0,  1.0),\n            vec2( 1.0,  1.0),\n            vec2(-1.0, -1.0),\n            vec2( 1.0, -1.0)\n        );\n        var tex = array<vec2<f32>, 4>(\n            vec2(0.0, 0.0),\n            vec2(1.0, 0.0),\n            vec2(0.0, 1.0),\n            vec2(1.0, 1.0)\n        );\n\n        var output: VertexOutput;\n\n        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n        output.fragUV = tex[VertexIndex];\n\n        return output;\n    }\n    "}),r=this._device.createShaderModule({code:0===i?"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);\n    }\n    ":"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));\n    }\n    "});t=this._videoCompiledShaders[i]=[e,r]}const s=this._device.createRenderPipeline({label:`CopyVideoToTexture_${e}_${0===i?"DontInvertY":"InvertY"}`,layout:r.fu.Auto,vertex:{module:t[0],entryPoint:"main"},fragment:{module:t[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:r.YV.TriangleStrip,stripIndexFormat:r.iD.Uint16}});n=this._videoPipelines[e][i]=[s,s.getBindGroupLayout(0)]}return n}static _GetTextureTypeFromFormat(e){switch(e){case r.EV.R8Unorm:case r.EV.R8Snorm:case r.EV.R8Uint:case r.EV.R8Sint:case r.EV.RG8Unorm:case r.EV.RG8Snorm:case r.EV.RG8Uint:case r.EV.RG8Sint:case r.EV.RGBA8Unorm:case r.EV.RGBA8UnormSRGB:case r.EV.RGBA8Snorm:case r.EV.RGBA8Uint:case r.EV.RGBA8Sint:case r.EV.BGRA8Unorm:case r.EV.BGRA8UnormSRGB:case r.EV.RGB10A2Unorm:case r.EV.RGB9E5UFloat:case r.EV.RG11B10UFloat:case r.EV.Depth24UnormStencil8:case r.EV.Depth32FloatStencil8:case r.EV.BC7RGBAUnorm:case r.EV.BC7RGBAUnormSRGB:case r.EV.BC6HRGBUFloat:case r.EV.BC6HRGBFloat:case r.EV.BC5RGUnorm:case r.EV.BC5RGSnorm:case r.EV.BC3RGBAUnorm:case r.EV.BC3RGBAUnormSRGB:case r.EV.BC2RGBAUnorm:case r.EV.BC2RGBAUnormSRGB:case r.EV.BC4RUnorm:case r.EV.BC4RSnorm:case r.EV.BC1RGBAUnorm:case r.EV.BC1RGBAUnormSRGB:case r.EV.ETC2RGB8Unorm:case r.EV.ETC2RGB8UnormSRGB:case r.EV.ETC2RGB8A1Unorm:case r.EV.ETC2RGB8A1UnormSRGB:case r.EV.ETC2RGBA8Unorm:case r.EV.ETC2RGBA8UnormSRGB:case r.EV.EACR11Unorm:case r.EV.EACR11Snorm:case r.EV.EACRG11Unorm:case r.EV.EACRG11Snorm:case r.EV.ASTC4x4Unorm:case r.EV.ASTC4x4UnormSRGB:case r.EV.ASTC5x4Unorm:case r.EV.ASTC5x4UnormSRGB:case r.EV.ASTC5x5Unorm:case r.EV.ASTC5x5UnormSRGB:case r.EV.ASTC6x5Unorm:case r.EV.ASTC6x5UnormSRGB:case r.EV.ASTC6x6Unorm:case r.EV.ASTC6x6UnormSRGB:case r.EV.ASTC8x5Unorm:case r.EV.ASTC8x5UnormSRGB:case r.EV.ASTC8x6Unorm:case r.EV.ASTC8x6UnormSRGB:case r.EV.ASTC8x8Unorm:case r.EV.ASTC8x8UnormSRGB:case r.EV.ASTC10x5Unorm:case r.EV.ASTC10x5UnormSRGB:case r.EV.ASTC10x6Unorm:case r.EV.ASTC10x6UnormSRGB:case r.EV.ASTC10x8Unorm:case r.EV.ASTC10x8UnormSRGB:case r.EV.ASTC10x10Unorm:case r.EV.ASTC10x10UnormSRGB:case r.EV.ASTC12x10Unorm:case r.EV.ASTC12x10UnormSRGB:case r.EV.ASTC12x12Unorm:case r.EV.ASTC12x12UnormSRGB:return 0;case r.EV.R16Uint:case r.EV.R16Sint:case r.EV.RG16Uint:case r.EV.RG16Sint:case r.EV.RGBA16Uint:case r.EV.RGBA16Sint:case r.EV.Depth16Unorm:return 5;case r.EV.R16Float:case r.EV.RG16Float:case r.EV.RGBA16Float:return 2;case r.EV.R32Uint:case r.EV.R32Sint:case r.EV.RG32Uint:case r.EV.RG32Sint:case r.EV.RGBA32Uint:case r.EV.RGBA32Sint:return 7;case r.EV.R32Float:case r.EV.RG32Float:case r.EV.RGBA32Float:case r.EV.Depth32Float:return 1;case r.EV.Stencil8:throw"No fixed size for Stencil8 format!";case r.EV.Depth24Plus:throw"No fixed size for Depth24Plus format!";case r.EV.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!"}return 0}static _GetBlockInformationFromFormat(e){switch(e){case r.EV.R8Unorm:case r.EV.R8Snorm:case r.EV.R8Uint:case r.EV.R8Sint:return{width:1,height:1,length:1};case r.EV.R16Uint:case r.EV.R16Sint:case r.EV.R16Float:case r.EV.RG8Unorm:case r.EV.RG8Snorm:case r.EV.RG8Uint:case r.EV.RG8Sint:return{width:1,height:1,length:2};case r.EV.R32Uint:case r.EV.R32Sint:case r.EV.R32Float:case r.EV.RG16Uint:case r.EV.RG16Sint:case r.EV.RG16Float:case r.EV.RGBA8Unorm:case r.EV.RGBA8UnormSRGB:case r.EV.RGBA8Snorm:case r.EV.RGBA8Uint:case r.EV.RGBA8Sint:case r.EV.BGRA8Unorm:case r.EV.BGRA8UnormSRGB:case r.EV.RGB9E5UFloat:case r.EV.RGB10A2Unorm:case r.EV.RG11B10UFloat:return{width:1,height:1,length:4};case r.EV.RG32Uint:case r.EV.RG32Sint:case r.EV.RG32Float:case r.EV.RGBA16Uint:case r.EV.RGBA16Sint:case r.EV.RGBA16Float:return{width:1,height:1,length:8};case r.EV.RGBA32Uint:case r.EV.RGBA32Sint:case r.EV.RGBA32Float:return{width:1,height:1,length:16};case r.EV.Stencil8:throw"No fixed size for Stencil8 format!";case r.EV.Depth16Unorm:return{width:1,height:1,length:2};case r.EV.Depth24Plus:throw"No fixed size for Depth24Plus format!";case r.EV.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!";case r.EV.Depth32Float:case r.EV.Depth24UnormStencil8:return{width:1,height:1,length:4};case r.EV.Depth32FloatStencil8:return{width:1,height:1,length:5};case r.EV.BC7RGBAUnorm:case r.EV.BC7RGBAUnormSRGB:case r.EV.BC6HRGBUFloat:case r.EV.BC6HRGBFloat:case r.EV.BC5RGUnorm:case r.EV.BC5RGSnorm:case r.EV.BC3RGBAUnorm:case r.EV.BC3RGBAUnormSRGB:case r.EV.BC2RGBAUnorm:case r.EV.BC2RGBAUnormSRGB:return{width:4,height:4,length:16};case r.EV.BC4RUnorm:case r.EV.BC4RSnorm:case r.EV.BC1RGBAUnorm:case r.EV.BC1RGBAUnormSRGB:case r.EV.ETC2RGB8Unorm:case r.EV.ETC2RGB8UnormSRGB:case r.EV.ETC2RGB8A1Unorm:case r.EV.ETC2RGB8A1UnormSRGB:case r.EV.EACR11Unorm:case r.EV.EACR11Snorm:return{width:4,height:4,length:8};case r.EV.ETC2RGBA8Unorm:case r.EV.ETC2RGBA8UnormSRGB:case r.EV.EACRG11Unorm:case r.EV.EACRG11Snorm:case r.EV.ASTC4x4Unorm:case r.EV.ASTC4x4UnormSRGB:return{width:4,height:4,length:16};case r.EV.ASTC5x4Unorm:case r.EV.ASTC5x4UnormSRGB:return{width:5,height:4,length:16};case r.EV.ASTC5x5Unorm:case r.EV.ASTC5x5UnormSRGB:return{width:5,height:5,length:16};case r.EV.ASTC6x5Unorm:case r.EV.ASTC6x5UnormSRGB:return{width:6,height:5,length:16};case r.EV.ASTC6x6Unorm:case r.EV.ASTC6x6UnormSRGB:return{width:6,height:6,length:16};case r.EV.ASTC8x5Unorm:case r.EV.ASTC8x5UnormSRGB:return{width:8,height:5,length:16};case r.EV.ASTC8x6Unorm:case r.EV.ASTC8x6UnormSRGB:return{width:8,height:6,length:16};case r.EV.ASTC8x8Unorm:case r.EV.ASTC8x8UnormSRGB:return{width:8,height:8,length:16};case r.EV.ASTC10x5Unorm:case r.EV.ASTC10x5UnormSRGB:return{width:10,height:5,length:16};case r.EV.ASTC10x6Unorm:case r.EV.ASTC10x6UnormSRGB:return{width:10,height:6,length:16};case r.EV.ASTC10x8Unorm:case r.EV.ASTC10x8UnormSRGB:return{width:10,height:8,length:16};case r.EV.ASTC10x10Unorm:case r.EV.ASTC10x10UnormSRGB:return{width:10,height:10,length:16};case r.EV.ASTC12x10Unorm:case r.EV.ASTC12x10UnormSRGB:return{width:12,height:10,length:16};case r.EV.ASTC12x12Unorm:case r.EV.ASTC12x12UnormSRGB:return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static _IsHardwareTexture(e){return!!e.release}static _IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return void 0!==e.close}static IsImageBitmapArray(e){return Array.isArray(e)&&void 0!==e[0].close}setCommandEncoder(e){this._commandEncoderForCreation=e}static IsCompressedFormat(e){switch(e){case r.EV.BC7RGBAUnormSRGB:case r.EV.BC7RGBAUnorm:case r.EV.BC6HRGBFloat:case r.EV.BC6HRGBUFloat:case r.EV.BC5RGSnorm:case r.EV.BC5RGUnorm:case r.EV.BC4RSnorm:case r.EV.BC4RUnorm:case r.EV.BC3RGBAUnormSRGB:case r.EV.BC3RGBAUnorm:case r.EV.BC2RGBAUnormSRGB:case r.EV.BC2RGBAUnorm:case r.EV.BC1RGBAUnormSRGB:case r.EV.BC1RGBAUnorm:case r.EV.ETC2RGB8Unorm:case r.EV.ETC2RGB8UnormSRGB:case r.EV.ETC2RGB8A1Unorm:case r.EV.ETC2RGB8A1UnormSRGB:case r.EV.ETC2RGBA8Unorm:case r.EV.ETC2RGBA8UnormSRGB:case r.EV.EACR11Unorm:case r.EV.EACR11Snorm:case r.EV.EACRG11Unorm:case r.EV.EACRG11Snorm:case r.EV.ASTC4x4Unorm:case r.EV.ASTC4x4UnormSRGB:case r.EV.ASTC5x4Unorm:case r.EV.ASTC5x4UnormSRGB:case r.EV.ASTC5x5Unorm:case r.EV.ASTC5x5UnormSRGB:case r.EV.ASTC6x5Unorm:case r.EV.ASTC6x5UnormSRGB:case r.EV.ASTC6x6Unorm:case r.EV.ASTC6x6UnormSRGB:case r.EV.ASTC8x5Unorm:case r.EV.ASTC8x5UnormSRGB:case r.EV.ASTC8x6Unorm:case r.EV.ASTC8x6UnormSRGB:case r.EV.ASTC8x8Unorm:case r.EV.ASTC8x8UnormSRGB:case r.EV.ASTC10x5Unorm:case r.EV.ASTC10x5UnormSRGB:case r.EV.ASTC10x6Unorm:case r.EV.ASTC10x6UnormSRGB:case r.EV.ASTC10x8Unorm:case r.EV.ASTC10x8UnormSRGB:case r.EV.ASTC10x10Unorm:case r.EV.ASTC10x10UnormSRGB:case r.EV.ASTC12x10Unorm:case r.EV.ASTC12x10UnormSRGB:case r.EV.ASTC12x12Unorm:case r.EV.ASTC12x12UnormSRGB:return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return r.EV.Depth16Unorm;case 16:return r.EV.Depth24Plus;case 13:return r.EV.Depth24PlusStencil8;case 14:return r.EV.Depth32Float;case 17:return r.EV.Depth24UnormStencil8;case 18:return r.EV.Depth32FloatStencil8;case 36492:return i?r.EV.BC7RGBAUnormSRGB:r.EV.BC7RGBAUnorm;case 36495:return r.EV.BC6HRGBUFloat;case 36494:return r.EV.BC6HRGBFloat;case 33779:return i?r.EV.BC3RGBAUnormSRGB:r.EV.BC3RGBAUnorm;case 33778:return i?r.EV.BC2RGBAUnormSRGB:r.EV.BC2RGBAUnorm;case 33777:case 33776:return i?r.EV.BC1RGBAUnormSRGB:r.EV.BC1RGBAUnorm;case 37808:return i?r.EV.ASTC4x4UnormSRGB:r.EV.ASTC4x4Unorm;case 36196:case 37492:return i?r.EV.ETC2RGB8UnormSRGB:r.EV.ETC2RGB8Unorm;case 37496:return i?r.EV.ETC2RGBA8UnormSRGB:r.EV.ETC2RGBA8Unorm}switch(e){case 3:switch(t){case 6:return r.EV.R8Snorm;case 7:return r.EV.RG8Snorm;case 4:throw"RGB format not supported in WebGPU";case 8:return r.EV.R8Sint;case 9:return r.EV.RG8Sint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return r.EV.RGBA8Sint;default:return r.EV.RGBA8Snorm}case 0:switch(t){case 6:return r.EV.R8Unorm;case 7:return r.EV.RG8Unorm;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?r.EV.RGBA8UnormSRGB:r.EV.RGBA8Unorm;case 12:return i?r.EV.BGRA8UnormSRGB:r.EV.BGRA8Unorm;case 8:return r.EV.R8Uint;case 9:return r.EV.RG8Uint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return r.EV.RGBA8Uint;case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return r.EV.RGBA8Unorm}case 4:switch(t){case 8:return r.EV.R16Sint;case 9:return r.EV.RG16Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return r.EV.RGBA16Sint}case 5:switch(t){case 8:return r.EV.R16Uint;case 9:return r.EV.RG16Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return r.EV.RGBA16Uint}case 6:switch(t){case 8:return r.EV.R32Sint;case 9:return r.EV.RG32Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return r.EV.RGBA32Sint}case 7:switch(t){case 8:return r.EV.R32Uint;case 9:return r.EV.RG32Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return r.EV.RGBA32Uint}case 1:switch(t){case 6:return r.EV.R32Float;case 7:return r.EV.RG32Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return r.EV.RGBA32Float}case 2:switch(t){case 6:return r.EV.R16Float;case 7:return r.EV.RG16Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return r.EV.RGBA16Float}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:throw"TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV format not supported in WebGPU";case 14:throw"TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV format not supported in WebGPU";case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:default:return r.EV.RGB10A2Unorm;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV"}}return i?r.EV.RGBA8UnormSRGB:r.EV.RGBA8Unorm}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case r.EV.R8Unorm:case r.EV.R8Snorm:case r.EV.R8Uint:case r.EV.R8Sint:case r.EV.BC4RUnorm:case r.EV.BC4RSnorm:case r.EV.R16Uint:case r.EV.R16Sint:case r.EV.Depth16Unorm:case r.EV.R16Float:case r.EV.R32Uint:case r.EV.R32Sint:case r.EV.R32Float:case r.EV.Depth32Float:case r.EV.Stencil8:case r.EV.Depth24Plus:case r.EV.EACR11Unorm:case r.EV.EACR11Snorm:return 1;case r.EV.RG8Unorm:case r.EV.RG8Snorm:case r.EV.RG8Uint:case r.EV.RG8Sint:case r.EV.Depth24UnormStencil8:case r.EV.Depth32FloatStencil8:case r.EV.BC5RGUnorm:case r.EV.BC5RGSnorm:case r.EV.RG16Uint:case r.EV.RG16Sint:case r.EV.RG16Float:case r.EV.RG32Uint:case r.EV.RG32Sint:case r.EV.RG32Float:case r.EV.Depth24PlusStencil8:case r.EV.EACRG11Unorm:case r.EV.EACRG11Snorm:return 2;case r.EV.RGB9E5UFloat:case r.EV.RG11B10UFloat:case r.EV.BC6HRGBUFloat:case r.EV.BC6HRGBFloat:case r.EV.ETC2RGB8Unorm:case r.EV.ETC2RGB8UnormSRGB:return 3;case r.EV.RGBA8Unorm:case r.EV.RGBA8UnormSRGB:case r.EV.RGBA8Snorm:case r.EV.RGBA8Uint:case r.EV.RGBA8Sint:case r.EV.BGRA8Unorm:case r.EV.BGRA8UnormSRGB:case r.EV.RGB10A2Unorm:case r.EV.BC7RGBAUnorm:case r.EV.BC7RGBAUnormSRGB:case r.EV.BC3RGBAUnorm:case r.EV.BC3RGBAUnormSRGB:case r.EV.BC2RGBAUnorm:case r.EV.BC2RGBAUnormSRGB:case r.EV.BC1RGBAUnorm:case r.EV.BC1RGBAUnormSRGB:case r.EV.RGBA16Uint:case r.EV.RGBA16Sint:case r.EV.RGBA16Float:case r.EV.RGBA32Uint:case r.EV.RGBA32Sint:case r.EV.RGBA32Float:case r.EV.ETC2RGB8A1Unorm:case r.EV.ETC2RGB8A1UnormSRGB:case r.EV.ETC2RGBA8Unorm:case r.EV.ETC2RGBA8UnormSRGB:case r.EV.ASTC4x4Unorm:case r.EV.ASTC4x4UnormSRGB:case r.EV.ASTC5x4Unorm:case r.EV.ASTC5x4UnormSRGB:case r.EV.ASTC5x5Unorm:case r.EV.ASTC5x5UnormSRGB:case r.EV.ASTC6x5Unorm:case r.EV.ASTC6x5UnormSRGB:case r.EV.ASTC6x6Unorm:case r.EV.ASTC6x6UnormSRGB:case r.EV.ASTC8x5Unorm:case r.EV.ASTC8x5UnormSRGB:case r.EV.ASTC8x6Unorm:case r.EV.ASTC8x6UnormSRGB:case r.EV.ASTC8x8Unorm:case r.EV.ASTC8x8UnormSRGB:case r.EV.ASTC10x5Unorm:case r.EV.ASTC10x5UnormSRGB:case r.EV.ASTC10x6Unorm:case r.EV.ASTC10x6UnormSRGB:case r.EV.ASTC10x8Unorm:case r.EV.ASTC10x8UnormSRGB:case r.EV.ASTC10x10Unorm:case r.EV.ASTC10x10UnormSRGB:case r.EV.ASTC12x10Unorm:case r.EV.ASTC12x10UnormSRGB:case r.EV.ASTC12x12Unorm:case r.EV.ASTC12x12UnormSRGB:return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case r.EV.Stencil8:case r.EV.Depth24UnormStencil8:case r.EV.Depth32FloatStencil8:case r.EV.Depth24PlusStencil8:return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case r.EV.Depth24UnormStencil8:case r.EV.Depth32FloatStencil8:case r.EV.Depth24PlusStencil8:return!0}return!1}copyVideoToTexture(e,t,i,n=!1,s){var a,o,l,h;const c=void 0===s,[d,_]=this._getVideoPipeline(i,n?u.InvertY:u.DontInvertY);c&&(s=this._device.createCommandEncoder({})),null===(o=(a=s).pushDebugGroup)||void 0===o||o.call(a,`copy video to texture - invertY=${n}`);const p={colorAttachments:[{view:t._hardwareTexture.underlyingResource.createView({format:i,dimension:r.p_.E2d,mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:r.H7.All}),loadOp:r.Ws.Load,storeOp:r.EG.Store}]},g=s.beginRenderPass(p),f={layout:_,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},m=this._device.createBindGroup(f);g.setPipeline(d),g.setBindGroup(0,m),g.draw(4,1,0,0),g.end(),null===(h=(l=s).popDebugGroup)||void 0===h||h.call(l),c&&(this._device.queue.submit([s.finish()]),s=null)}invertYPreMultiplyAlpha(e,t,i,n,s=!1,a=!1,o=0,u=0,h=1,c=0,_=0,p=0,g=0,f,m){var E,T,x,S,b,R;const A=0!==p,y=void 0===f,[v,C]=this._getPipeline(n,A?l.InvertYPremultiplyAlphaWithOfst:l.InvertYPremultiplyAlpha,{invertY:s,premultiplyAlpha:a});let B;if(o=Math.max(o,0),y&&(f=this._device.createCommandEncoder({})),null===(T=(E=f).pushDebugGroup)||void 0===T||T.call(E,`internal process texture - invertY=${s} premultiplyAlpha=${a}`),d._IsHardwareTexture(e)?(B=e.underlyingResource,s&&!a&&1===h&&0===o||(e=void 0)):(B=e,e=void 0),!B)return;A&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([c,_,p,g]),0,16);const I=e,U=null!==(x=null==I?void 0:I._copyInvertYTempTexture)&&void 0!==x?x:this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,n,1,f,r.v2.CopySrc|r.v2.RenderAttachment|r.v2.TextureBinding),P=null!==(S=null==I?void 0:I._copyInvertYRenderPassDescr)&&void 0!==S?S:{colorAttachments:[{view:U.createView({format:n,dimension:r.p_.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:r.Ws.Load,storeOp:r.EG.Store}]},F=f.beginRenderPass(P);let D=A?null==I?void 0:I._copyInvertYBindGroupWithOfst:null==I?void 0:I._copyInvertYBindGroup;if(!D){const e={layout:C,entries:[{binding:0,resource:B.createView({format:n,dimension:r.p_.E2d,baseMipLevel:u,mipLevelCount:1,arrayLayerCount:h,baseArrayLayer:o})}]};A&&e.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),D=this._device.createBindGroup(e)}F.setPipeline(v),F.setBindGroup(0,D),F.draw(4,1,0,0),F.end(),f.copyTextureToTexture({texture:U},{texture:B,mipLevel:u,origin:{x:0,y:0,z:o}},{width:t,height:i,depthOrArrayLayers:1}),I?(I._copyInvertYTempTexture=U,I._copyInvertYRenderPassDescr=P,A?I._copyInvertYBindGroupWithOfst=D:I._copyInvertYBindGroup=D):this._deferredReleaseTextures.push([U,null]),null===(R=(b=f).popDebugGroup)||void 0===R||R.call(b),y&&(this._device.queue.submit([f.finish()]),f=null)}copyWithInvertY(e,t,i,r){var n,s,a,o;const u=void 0===r,[h,c]=this._getPipeline(t,l.InvertYPremultiplyAlpha,{invertY:!0,premultiplyAlpha:!1});u&&(r=this._device.createCommandEncoder({})),null===(s=(n=r).pushDebugGroup)||void 0===s||s.call(n,"internal copy texture with invertY");const d=r.beginRenderPass(i),_=this._device.createBindGroup({layout:c,entries:[{binding:0,resource:e}]});d.setPipeline(h),d.setBindGroup(0,_),d.draw(4,1,0,0),d.end(),null===(o=(a=r).popDebugGroup)||void 0===o||o.call(a),u&&(this._device.queue.submit([r.finish()]),r=null)}createTexture(e,t=!1,i=!1,n=!1,s=!1,a=!1,o=r.EV.RGBA8Unorm,l=1,u,h=-1,c=0){l>1&&(l=4);const _=e.layers||1,p={width:e.width,height:e.height,depthOrArrayLayers:_},g=d.IsCompressedFormat(o),f=t?d.ComputeNumMipmapLevels(e.width,e.height):1,m=h>=0?h:r.v2.CopySrc|r.v2.CopyDst|r.v2.TextureBinding;c|=t&&!g?r.v2.CopySrc|r.v2.RenderAttachment:0,g||a||(c|=r.v2.RenderAttachment|r.v2.CopyDst);const E=this._device.createTexture({label:`Texture_${p.width}x${p.height}x${p.depthOrArrayLayers}_${t?"wmips":"womips"}_${o}_samples${l}`,size:p,dimension:a?r.kd.E3d:r.kd.E2d,format:o,usage:m|c,sampleCount:l,mipLevelCount:f});return d.IsImageBitmap(e)&&(this.updateTexture(e,E,e.width,e.height,_,o,0,0,n,s,0,0),t&&i&&this.generateMipmaps(E,o,f,0,u)),E}createCubeTexture(e,t=!1,i=!1,n=!1,s=!1,a=r.EV.RGBA8Unorm,o=1,l,u=-1,h=0){o>1&&(o=4);const c=d.IsImageBitmapArray(e)?e[0].width:e.width,_=d.IsImageBitmapArray(e)?e[0].height:e.height,p=d.IsCompressedFormat(a),g=t?d.ComputeNumMipmapLevels(c,_):1,f=u>=0?u:r.v2.CopySrc|r.v2.CopyDst|r.v2.TextureBinding;h|=t&&!p?r.v2.CopySrc|r.v2.RenderAttachment:0,p||(h|=r.v2.RenderAttachment|r.v2.CopyDst);const m=this._device.createTexture({label:`TextureCube_${c}x${_}x6_${t?"wmips":"womips"}_${a}_samples${o}`,size:{width:c,height:_,depthOrArrayLayers:6},dimension:r.kd.E2d,format:a,usage:f|h,sampleCount:o,mipLevelCount:g});return d.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,m,c,_,a,n,s,0,0),t&&i&&this.generateCubeMipmaps(m,a,g,l)),m}generateCubeMipmaps(e,t,i,r){var n,s,a,o;const l=void 0===r;l&&(r=this._device.createCommandEncoder({})),null===(s=(n=r).pushDebugGroup)||void 0===s||s.call(n,`create cube mipmaps - ${i} levels`);for(let n=0;n<6;++n)this.generateMipmaps(e,t,i,n,r);null===(o=(a=r).popDebugGroup)||void 0===o||o.call(a),l&&(this._device.queue.submit([r.finish()]),r=null)}generateMipmaps(e,t,i,n=0,s){var a,o,l,u,h,c,_,p;const g=void 0===s,[f,m]=this._getPipeline(t);let E;if(n=Math.max(n,0),g&&(s=this._device.createCommandEncoder({})),null===(o=(a=s).pushDebugGroup)||void 0===o||o.call(a,`create mipmaps for face #${n} - ${i} levels`),d._IsHardwareTexture(e)?(E=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(E=e,e=void 0),!E)return;const T=e;for(let e=1;e<i;++e){const i=null!==(u=null===(l=null==T?void 0:T._mipmapGenRenderPassDescr[n])||void 0===l?void 0:l[e-1])&&void 0!==u?u:{colorAttachments:[{view:E.createView({format:t,dimension:r.p_.E2d,baseMipLevel:e,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:n}),loadOp:r.Ws.Load,storeOp:r.EG.Store}]};T&&(T._mipmapGenRenderPassDescr[n]=T._mipmapGenRenderPassDescr[n]||[],T._mipmapGenRenderPassDescr[n][e-1]=i);const a=s.beginRenderPass(i),o=null!==(c=null===(h=null==T?void 0:T._mipmapGenBindGroup[n])||void 0===h?void 0:h[e-1])&&void 0!==c?c:this._device.createBindGroup({layout:m,entries:[{binding:0,resource:this._mipmapSampler},{binding:1,resource:E.createView({format:t,dimension:r.p_.E2d,baseMipLevel:e-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:n})}]});T&&(T._mipmapGenBindGroup[n]=T._mipmapGenBindGroup[n]||[],T._mipmapGenBindGroup[n][e-1]=o),a.setPipeline(f),a.setBindGroup(0,o),a.draw(4,1,0,0),a.end()}null===(p=(_=s).popDebugGroup)||void 0===p||p.call(_),g&&(this._device.queue.submit([s.finish()]),s=null)}createGPUTextureForInternalTexture(e,t,i,n,o){e._hardwareTexture||(e._hardwareTexture=new a.Z),void 0===t&&(t=e.width),void 0===i&&(i=e.height),void 0===n&&(n=e.depth);const l=e._hardwareTexture,u=0!=(1&(null!=o?o:0));l.format=d.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),l.textureUsages=e._source===s.S.RenderTarget||e.source===s.S.MultiRenderTarget?r.v2.TextureBinding|r.v2.CopySrc|r.v2.RenderAttachment:e._source===s.S.DepthStencil?r.v2.TextureBinding|r.v2.RenderAttachment:-1,l.textureAdditionalUsages=u?r.v2.StorageBinding:0;const h=e.generateMipMaps,c=n||1;let _;if(_=null!==e._maxLodLevel?e._maxLodLevel:h?d.ComputeNumMipmapLevels(t,i):1,e.isCube){const n=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,l.format,1,this._commandEncoderForCreation,l.textureUsages,l.textureAdditionalUsages);l.set(n),l.createView({format:l.format,dimension:r.p_.Cube,mipLevelCount:_,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:d.HasDepthAndStencilAspects(l.format)?r.H7.DepthOnly:r.H7.All},u)}else{const n=this.createTexture({width:t,height:i,layers:c},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,l.format,1,this._commandEncoderForCreation,l.textureUsages,l.textureAdditionalUsages);l.set(n),l.createView({format:l.format,dimension:e.is2DArray?r.p_.E2dArray:e.is3D?r.kd.E3d:r.p_.E2d,mipLevelCount:_,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:e.is3D?1:c,aspect:d.HasDepthAndStencilAspects(l.format)?r.H7.DepthOnly:r.H7.All},u)}return e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=n,this.createMSAATexture(e,e.samples),l}createMSAATexture(e,t){const i=e._hardwareTexture;if((null==i?void 0:i.msaaTexture)&&(this.releaseTexture(i.msaaTexture),i.msaaTexture=null),!i||(null!=t?t:1)<=1)return;const r=e.width,n=e.height,s=e.depth||1;if(e.isCube){const s=this.createCubeTexture({width:r,height:n},!1,!1,e.invertY,!1,i.format,t,this._commandEncoderForCreation,i.textureUsages,i.textureAdditionalUsages);i.msaaTexture=s}else{const a=this.createTexture({width:r,height:n,layers:s},!1,!1,e.invertY,!1,e.is3D,i.format,t,this._commandEncoderForCreation,i.textureUsages,i.textureAdditionalUsages);i.msaaTexture=a}}updateCubeTextures(e,t,i,r,n,s=!1,a=!1,o=0,l=0){const u=[0,3,1,4,2,5];for(let h=0;h<u.length;++h){const c=e[u[h]];this.updateTexture(c,t,i,r,1,n,h,0,s,a,o,l)}}updateTexture(e,t,i,n,s,a,o=0,l=0,u=!1,h=!1,c=0,_=0,p){const g=d._IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,f=d._GetBlockInformationFromFormat(a),m=d._IsInternalTexture(t)?t._hardwareTexture:t,E={texture:g,origin:{x:c,y:_,z:Math.max(o,0)},mipLevel:l,premultipliedAlpha:h},T={width:Math.ceil(i/f.width)*f.width,height:Math.ceil(n/f.height)*f.height,depthOrArrayLayers:s||1};if(void 0!==e.byteLength){const g=Math.ceil(i/f.width)*f.length;if(256*Math.ceil(g/256)===g){const t=this._device.createCommandEncoder({}),i=this._bufferManager.createRawBuffer(e.byteLength,r.FB.MapWrite|r.FB.CopySrc,!0),s=i.getMappedRange();new Uint8Array(s).set(e),i.unmap(),t.copyBufferToTexture({buffer:i,offset:0,bytesPerRow:g,rowsPerImage:n},E,T),this._device.queue.submit([t.finish()]),this._bufferManager.releaseBuffer(i)}else this._device.queue.writeTexture(E,e,{offset:0,bytesPerRow:g,rowsPerImage:n},T);if(u||h){if(!d._IsInternalTexture(t))throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!";{const e=0===c&&0===_&&i===t.width&&n===t.height;this.invertYPreMultiplyAlpha(m,t.width,t.height,a,u,h,o,l,s||1,c,_,e?0:i,e?0:n,void 0,p)}}}else if(u)if(E.premultipliedAlpha=!1,d._IsInternalTexture(t)&&0===c&&0===_&&i===t.width&&n===t.height)this._device.queue.copyExternalImageToTexture({source:e},E,T),this.invertYPreMultiplyAlpha(m,i,n,a,u,h,o,l,s||1,0,0,0,0,void 0,p);else{const t=this._device.createCommandEncoder({}),c=this.createTexture({width:i,height:n,layers:1},!1,!1,!1,!1,!1,a,1,t,r.v2.CopySrc|r.v2.TextureBinding);this._deferredReleaseTextures.push([c,null]),T.depthOrArrayLayers=1,this._device.queue.copyExternalImageToTexture({source:e},{texture:c},T),T.depthOrArrayLayers=s||1,this.invertYPreMultiplyAlpha(c,i,n,a,u,h,o,l,s||1,0,0,0,0,t,p),t.copyTextureToTexture({texture:c},E,T),this._device.queue.submit([t.finish()])}else this._device.queue.copyExternalImageToTexture({source:e},E,T)}readPixels(e,t,i,n,s,a,o=0,l=0,u=null,h=!1){const c=d._GetBlockInformationFromFormat(a),_=Math.ceil(n/c.width)*c.length,p=256*Math.ceil(_/256),g=p*s,f=this._bufferManager.createRawBuffer(g,r.FB.MapRead|r.FB.CopyDst),m=this._device.createCommandEncoder({});return m.copyTextureToBuffer({texture:e,mipLevel:l,origin:{x:t,y:i,z:Math.max(o,0)}},{buffer:f,offset:0,bytesPerRow:p},{width:n,height:s,depthOrArrayLayers:1}),this._device.queue.submit([m.finish()]),this._bufferManager.readDataFromBuffer(f,g,n,s,_,p,d._GetTextureTypeFromFormat(a),0,u,!0,h)}releaseTexture(e){if(d._IsInternalTexture(e)){const t=e._hardwareTexture,i=e._irradianceTexture;this._deferredReleaseTextures.push([t,i])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){const[t,i]=this._deferredReleaseTextures[e];t&&(d._IsHardwareTexture(t)?t.release():t.destroy()),null==i||i.dispose()}this._deferredReleaseTextures.length=0}}},73750:(e,t,i)=>{i.d(t,{b:()=>a});var r=i(8724),n=i(82577),s=i(22812);class a{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t){this._enabled=!1,this._gpuFrameTimeCounter=new n.z,this._measureDurationState=0,this._device=e,this._bufferManager=t}get enable(){return this._enabled}set enable(e){this._enabled!==e&&(this._enabled=e,this._measureDurationState=0,e?this._measureDuration=new o(this._device,this._bufferManager):this._measureDuration.dispose())}startFrame(e){this._enabled&&0===this._measureDurationState&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){1===this._measureDurationState&&(this._measureDurationState=2,this._measureDuration.stop(e).then((e=>{null!==e&&e>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(e,!0)),this._measureDurationState=0})))}}class o{constructor(e,t){this._querySet=new s.t(2,r.xL.Timestamp,e,t)}start(e){e.writeTimestamp(this._querySet.querySet,0)}async stop(e){return e.writeTimestamp(this._querySet.querySet,1),this._querySet.readTwoValuesAndSubtract(0)}dispose(){this._querySet.dispose()}}},59412:(e,t,i)=>{i.d(t,{S:()=>s});var r=i(80352),n=i(13514);class s{constructor(){this._twgsl=null}async initTwgsl(e){return e=e||{},(e={...s._TWgslDefaultOptions,...e}).twgsl?(this._twgsl=e.twgsl,Promise.resolve()):(e.jsPath&&e.wasmPath&&((0,r.CG)()?await n.w1.LoadScriptAsync(e.jsPath):importScripts(e.jsPath)),self.twgsl?(this._twgsl=await self.twgsl(e.wasmPath),Promise.resolve()):Promise.reject("twgsl is not available."))}convertSpirV2WGSL(e){const t=this._twgsl.convertSpirV2WGSL(e);return s.ShowWGSLShaderCode,t}}s._TWgslDefaultOptions={jsPath:"https://preview.babylonjs.com/twgsl/twgsl.js",wasmPath:"https://preview.babylonjs.com/twgsl/twgsl.wasm"},s.ShowWGSLShaderCode=!1},34941:(e,t,i)=>{i.d(t,{g:()=>r});class r{}r.ALPHA_DISABLE=0,r.ALPHA_ADD=1,r.ALPHA_COMBINE=2,r.ALPHA_SUBTRACT=3,r.ALPHA_MULTIPLY=4,r.ALPHA_MAXIMIZED=5,r.ALPHA_ONEONE=6,r.ALPHA_PREMULTIPLIED=7,r.ALPHA_PREMULTIPLIED_PORTERDUFF=8,r.ALPHA_INTERPOLATE=9,r.ALPHA_SCREENMODE=10,r.ALPHA_ONEONE_ONEONE=11,r.ALPHA_ALPHATOCOLOR=12,r.ALPHA_REVERSEONEMINUS=13,r.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,r.ALPHA_ONEONE_ONEZERO=15,r.ALPHA_EXCLUSION=16,r.ALPHA_LAYER_ACCUMULATE=17,r.ALPHA_EQUATION_ADD=0,r.ALPHA_EQUATION_SUBSTRACT=1,r.ALPHA_EQUATION_REVERSE_SUBTRACT=2,r.ALPHA_EQUATION_MAX=3,r.ALPHA_EQUATION_MIN=4,r.ALPHA_EQUATION_DARKEN=5,r.DELAYLOADSTATE_NONE=0,r.DELAYLOADSTATE_LOADED=1,r.DELAYLOADSTATE_LOADING=2,r.DELAYLOADSTATE_NOTLOADED=4,r.NEVER=512,r.ALWAYS=519,r.LESS=513,r.EQUAL=514,r.LEQUAL=515,r.GREATER=516,r.GEQUAL=518,r.NOTEQUAL=517,r.KEEP=7680,r.ZERO=0,r.REPLACE=7681,r.INCR=7682,r.DECR=7683,r.INVERT=5386,r.INCR_WRAP=34055,r.DECR_WRAP=34056,r.TEXTURE_CLAMP_ADDRESSMODE=0,r.TEXTURE_WRAP_ADDRESSMODE=1,r.TEXTURE_MIRROR_ADDRESSMODE=2,r.TEXTURE_CREATIONFLAG_STORAGE=1,r.TEXTUREFORMAT_ALPHA=0,r.TEXTUREFORMAT_LUMINANCE=1,r.TEXTUREFORMAT_LUMINANCE_ALPHA=2,r.TEXTUREFORMAT_RGB=4,r.TEXTUREFORMAT_RGBA=5,r.TEXTUREFORMAT_RED=6,r.TEXTUREFORMAT_R=6,r.TEXTUREFORMAT_RG=7,r.TEXTUREFORMAT_RED_INTEGER=8,r.TEXTUREFORMAT_R_INTEGER=8,r.TEXTUREFORMAT_RG_INTEGER=9,r.TEXTUREFORMAT_RGB_INTEGER=10,r.TEXTUREFORMAT_RGBA_INTEGER=11,r.TEXTUREFORMAT_BGRA=12,r.TEXTUREFORMAT_DEPTH24_STENCIL8=13,r.TEXTUREFORMAT_DEPTH32_FLOAT=14,r.TEXTUREFORMAT_DEPTH16=15,r.TEXTUREFORMAT_DEPTH24=16,r.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,r.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,r.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,r.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,r.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,r.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,r.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,r.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,r.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,r.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,r.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,r.TEXTURETYPE_UNSIGNED_BYTE=0,r.TEXTURETYPE_UNSIGNED_INT=0,r.TEXTURETYPE_FLOAT=1,r.TEXTURETYPE_HALF_FLOAT=2,r.TEXTURETYPE_BYTE=3,r.TEXTURETYPE_SHORT=4,r.TEXTURETYPE_UNSIGNED_SHORT=5,r.TEXTURETYPE_INT=6,r.TEXTURETYPE_UNSIGNED_INTEGER=7,r.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,r.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,r.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,r.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,r.TEXTURETYPE_UNSIGNED_INT_24_8=12,r.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,r.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,r.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,r.TEXTURETYPE_UNDEFINED=16,r.TEXTURE_NEAREST_SAMPLINGMODE=1,r.TEXTURE_NEAREST_NEAREST=1,r.TEXTURE_BILINEAR_SAMPLINGMODE=2,r.TEXTURE_LINEAR_LINEAR=2,r.TEXTURE_TRILINEAR_SAMPLINGMODE=3,r.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,r.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,r.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,r.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,r.TEXTURE_NEAREST_LINEAR=7,r.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,r.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,r.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,r.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,r.TEXTURE_LINEAR_NEAREST=12,r.TEXTURE_EXPLICIT_MODE=0,r.TEXTURE_SPHERICAL_MODE=1,r.TEXTURE_PLANAR_MODE=2,r.TEXTURE_CUBIC_MODE=3,r.TEXTURE_PROJECTION_MODE=4,r.TEXTURE_SKYBOX_MODE=5,r.TEXTURE_INVCUBIC_MODE=6,r.TEXTURE_EQUIRECTANGULAR_MODE=7,r.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,r.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,r.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,r.TEXTURE_FILTERING_QUALITY_HIGH=64,r.TEXTURE_FILTERING_QUALITY_MEDIUM=16,r.TEXTURE_FILTERING_QUALITY_LOW=8,r.SCALEMODE_FLOOR=1,r.SCALEMODE_NEAREST=2,r.SCALEMODE_CEILING=3,r.MATERIAL_TextureDirtyFlag=1,r.MATERIAL_LightDirtyFlag=2,r.MATERIAL_FresnelDirtyFlag=4,r.MATERIAL_AttributesDirtyFlag=8,r.MATERIAL_MiscDirtyFlag=16,r.MATERIAL_PrePassDirtyFlag=32,r.MATERIAL_AllDirtyFlag=63,r.MATERIAL_TriangleFillMode=0,r.MATERIAL_WireFrameFillMode=1,r.MATERIAL_PointFillMode=2,r.MATERIAL_PointListDrawMode=3,r.MATERIAL_LineListDrawMode=4,r.MATERIAL_LineLoopDrawMode=5,r.MATERIAL_LineStripDrawMode=6,r.MATERIAL_TriangleStripDrawMode=7,r.MATERIAL_TriangleFanDrawMode=8,r.MATERIAL_ClockWiseSideOrientation=0,r.MATERIAL_CounterClockWiseSideOrientation=1,r.ACTION_NothingTrigger=0,r.ACTION_OnPickTrigger=1,r.ACTION_OnLeftPickTrigger=2,r.ACTION_OnRightPickTrigger=3,r.ACTION_OnCenterPickTrigger=4,r.ACTION_OnPickDownTrigger=5,r.ACTION_OnDoublePickTrigger=6,r.ACTION_OnPickUpTrigger=7,r.ACTION_OnPickOutTrigger=16,r.ACTION_OnLongPressTrigger=8,r.ACTION_OnPointerOverTrigger=9,r.ACTION_OnPointerOutTrigger=10,r.ACTION_OnEveryFrameTrigger=11,r.ACTION_OnIntersectionEnterTrigger=12,r.ACTION_OnIntersectionExitTrigger=13,r.ACTION_OnKeyDownTrigger=14,r.ACTION_OnKeyUpTrigger=15,r.PARTICLES_BILLBOARDMODE_Y=2,r.PARTICLES_BILLBOARDMODE_ALL=7,r.PARTICLES_BILLBOARDMODE_STRETCHED=8,r.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,r.MESHES_CULLINGSTRATEGY_STANDARD=0,r.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,r.SCENELOADER_NO_LOGGING=0,r.SCENELOADER_MINIMAL_LOGGING=1,r.SCENELOADER_SUMMARY_LOGGING=2,r.SCENELOADER_DETAILED_LOGGING=3,r.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,r.PREPASS_POSITION_TEXTURE_TYPE=1,r.PREPASS_VELOCITY_TEXTURE_TYPE=2,r.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,r.PREPASS_COLOR_TEXTURE_TYPE=4,r.PREPASS_DEPTH_TEXTURE_TYPE=5,r.PREPASS_NORMAL_TEXTURE_TYPE=6,r.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,r.BUFFER_CREATIONFLAG_READ=1,r.BUFFER_CREATIONFLAG_WRITE=2,r.BUFFER_CREATIONFLAG_READWRITE=3,r.BUFFER_CREATIONFLAG_UNIFORM=4,r.BUFFER_CREATIONFLAG_VERTEX=8,r.BUFFER_CREATIONFLAG_INDEX=16,r.BUFFER_CREATIONFLAG_STORAGE=32,r.RENDERPASS_MAIN=0,r.INPUT_ALT_KEY=18,r.INPUT_CTRL_KEY=17,r.INPUT_META_KEY1=91,r.INPUT_META_KEY2=92,r.INPUT_META_KEY3=93,r.INPUT_SHIFT_KEY=16,r.SNAPSHOTRENDERING_STANDARD=0,r.SNAPSHOTRENDERING_FAST=1,r.PERSPECTIVE_CAMERA=0,r.ORTHOGRAPHIC_CAMERA=1,r.FOVMODE_VERTICAL_FIXED=0,r.FOVMODE_HORIZONTAL_FIXED=1,r.RIG_MODE_NONE=0,r.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,r.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,r.RIG_MODE_STEREOSCOPIC_INTERLACED=14,r.RIG_MODE_VR=20,r.RIG_MODE_WEBVR=21,r.RIG_MODE_CUSTOM=22,r.MAX_SUPPORTED_UV_SETS=6,r.GL_ALPHA_EQUATION_ADD=32774,r.GL_ALPHA_EQUATION_MIN=32775,r.GL_ALPHA_EQUATION_MAX=32776,r.GL_ALPHA_EQUATION_SUBTRACT=32778,r.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,r.GL_ALPHA_FUNCTION_SRC=768,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,r.GL_ALPHA_FUNCTION_SRC_ALPHA=770,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,r.GL_ALPHA_FUNCTION_DST_ALPHA=772,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,r.GL_ALPHA_FUNCTION_DST_COLOR=774,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,r.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,r.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,r.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,r.SnippetUrl="https://snippet.babylonjs.com"},37290:(e,t,i)=>{i.d(t,{D:()=>p});var r=i(62897),n=i(59157),s=i(80352),a=i(15210),o=i(77851),l=i(61159),u=i(31700),h=i(82577),c=i(21254),d=i(84318),_=i(61319);i(21352),i(5382),i(89553);class p extends l.B{static get NpmPackage(){return l.B.NpmPackage}static get Version(){return l.B.Version}static get Instances(){return a.l.Instances}static get LastCreatedEngine(){return a.l.LastCreatedEngine}static get LastCreatedScene(){return a.l.LastCreatedScene}_createImageBitmapFromSource(e,t){return new Promise(((i,r)=>{const n=new Image;n.onload=()=>{n.decode().then((()=>{this.createImageBitmap(n,t).then((e=>{i(e)}))}))},n.onerror=()=>{r(`Error loading image ${n.src}`)},n.src=e}))}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){const r=this.createCanvas(t,i).getContext("2d");if(!r)throw new Error("Unable to get 2d context for resizeImageBitmap");r.drawImage(e,0,0);return r.getImageData(0,0,t,i).data}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<p.Instances.length;i++){const r=p.Instances[i];for(let i=0;i<r.scenes.length;i++)r.scenes[i].markAllMaterialsAsDirty(e,t)}}static DefaultLoadingScreenFactory(e){throw(0,o.S)("LoadingScreen")}get _supportsHardwareTextureRescaling(){return!!p._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}constructor(e,t,i,n=!1){if(super(e,t,i,n),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=new Array,this._virtualScenes=new Array,this.onNewSceneAddedObservable=new r.y$,this.postProcesses=new Array,this.isPointerLock=!1,this.onResizeObservable=new r.y$,this.onCanvasBlurObservable=new r.y$,this.onCanvasFocusObservable=new r.y$,this.onCanvasPointerOutObservable=new r.y$,this.onBeginFrameObservable=new r.y$,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new r.y$,this.onBeforeShaderCompilationObservable=new r.y$,this.onAfterShaderCompilationObservable=new r.y$,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new h.z,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new u.A,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=["main"],p.Instances.push(this),e){if(this._features.supportRenderPasses=!0,i=this._creationOptions,e.getContext){const t=e;this._sharedInit(t),this._connectVREvents()}this._prepareVRComponent(),i.autoEnableWebVR&&this.initWebVR()}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=e=>{this.disableContextMenu&&e.preventDefault()},e.addEventListener("focus",this._onCanvasFocus),e.addEventListener("blur",this._onCanvasBlur),e.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=t=>{document.elementFromPoint(t.clientX,t.clientY)!==e&&this.onCanvasPointerOutObservable.notifyObservers(t)};const t=this.getHostWindow();t&&"function"==typeof t.addEventListener&&(t.addEventListener("blur",this._onBlur),t.addEventListener("focus",this._onFocus)),e.addEventListener("pointerout",this._onCanvasPointerOut),this._creationOptions.doNotHandleTouchAction||this._disableTouchAction(),!p.audioEngine&&this._creationOptions.audioEngine&&p.AudioEngineFactory&&(p.audioEngine=p.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination())),(0,s.n5)()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&e&&p._RequestPointerlock(e)},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)),this.enableOfflineSupport=void 0!==p.OfflineProviderFactory,this._deterministicLockstep=!!this._creationOptions.deterministicLockstep,this._lockstepMaxSteps=this._creationOptions.lockstepMaxSteps||0,this._timeStep=this._creationOptions.timeStep||1/60}getAspectRatio(e,t=!1){const i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return 1e3*this._timeStep}generateMipMapsForCubemap(e,t=!0){if(e.generateMipMaps){const i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(e){this._depthCullingState.depthMask=e}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(e){this._stencilState.stencilTest=e}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(e){this._stencilState.stencilMask=e}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(e){this._stencilState.stencilFunc=e}setStencilFunctionReference(e){this._stencilState.stencilFuncRef=e}setStencilFunctionMask(e){this._stencilState.stencilFuncMask=e}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(e){this._stencilState.stencilOpStencilFail=e}setStencilOperationDepthFail(e){this._stencilState.stencilOpDepthFail=e}setStencilOperationPass(e){this._stencilState.stencilOpStencilDepthPass=e}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(e){this._depthCullingState.depthFunc=e}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(e,t,i,r){const n=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,r),n}scissorClear(e,t,i,r,n){this.enableScissor(e,t,i,r),this.clear(n,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,r){const n=this._gl;n.enable(n.SCISSOR_TEST),n.scissor(e,t,i,r)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_reportDrawCall(e=1){this._drawCalls.addCount(e,!1)}initWebVR(){throw(0,o.S)("WebVRCamera")}_prepareVRComponent(){}_connectVREvents(e,t){}_submitVRFrame(){}disableVR(){}isVRPresenting(){return!1}_requestVRFrame(){}_loadFileAsync(e,t,i){return new Promise(((r,n)=>{this._loadFile(e,(e=>{r(e)}),void 0,t,i,((e,t)=>{n(t)}))}))}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}setDepthStencilTexture(e,t,i,r){void 0!==e&&(t&&(this._boundUniforms[e]=t),i&&i.depthStencilTexture?this._setTexture(e,i,!1,!0,r):this._setTexture(e,null,void 0,void 0,r))}setTextureFromPostProcess(e,t,i){var r;let n=null;t&&(t._textures.data[t._currentRenderTextureInd]?n=t._textures.data[t._currentRenderTextureInd]:t._forcedOutputTexture&&(n=t._forcedOutputTexture)),this._bindTexture(e,null!==(r=null==n?void 0:n.texture)&&void 0!==r?r:null,i)}setTextureFromPostProcessOutput(e,t,i){var r,n;this._bindTexture(e,null!==(n=null===(r=null==t?void 0:t._outputTexture)||void 0===r?void 0:r.texture)&&void 0!==n?n:null,i)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){(0,this._activeRenderLoops[e])()}}_renderLoop(){if(!this._contextWasLost){let e=!0;!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&p._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&p._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&p._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){p._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)}resize(e=!1){this.isVRPresenting()||super.resize(e)}setSize(e,t,i=!1){if(!this._renderingCanvas)return!1;if(!super.setSize(e,t,i))return!1;if(this.scenes){for(let e=0;e<this.scenes.length;e++){const t=this.scenes[e];for(let e=0;e<t.cameras.length;e++){t.cameras[e]._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,r,n,s=null){n=n||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const a=super.createShaderProgram(e,t,i,r,n,s);return this.onAfterShaderCompilationObservable.notifyObservers(this),a}_createShaderProgram(e,t,i,r,n=null){const s=r.createProgram();if(e.program=s,!s)throw new Error("Unable to create program");if(r.attachShader(s,t),r.attachShader(s,i),this.webGLVersion>1&&n){const t=this.createTransformFeedback();this.bindTransformFeedback(t),this.setTranformFeedbackVaryings(s,n),e.transformFeedback=t}return r.linkProgram(s),this.webGLVersion>1&&n&&this.bindTransformFeedback(null),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),s}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach((t=>{t.postProcesses.forEach((t=>{t._outputTexture===e&&(t._outputTexture=null)})),t.cameras.forEach((t=>{t._postProcesses.forEach((t=>{t&&t._outputTexture===e&&(t._outputTexture=null)}))}))}))}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(e){const t=++p._RenderPassIdCounter;return this._renderPassNames[t]=null!=e?e:"NONAME",t}releaseRenderPassId(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){const i=this.scenes[t];for(let t=0;t<i.meshes.length;++t){const r=i.meshes[t];if(r.subMeshes)for(let t=0;t<r.subMeshes.length;++t){r.subMeshes[t]._removeDrawWrapper(e)}}}}_rescaleTexture(e,t,i,r,n){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const s=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&p._RescalePostProcessFactory&&(this._rescalePostProcess=p._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled((()=>{this._rescalePostProcess.onApply=function(t){t._bindTexture("textureSampler",e)};let a=i;a||(a=this.scenes[this.scenes.length-1]),a.postProcessManager.directRender([this._rescalePostProcess],s,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,r,0,0,t.width,t.height,0),this.unBindFramebuffer(s),s.dispose(),n&&n()})))}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(e){const t=new _.B(e,this._gl),i=new n.l(this,n.S.Unknown,!0);return i._hardwareTexture=t,i.isReady=!0,i}_uploadImageToTexture(e,t,i=0,r=0){const n=this._gl,s=this._getWebGLTextureType(e.type),a=this._getInternalFormat(e.format),o=this._getRGBABufferInternalSizedFormat(e.type,a),l=e.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this._bindTextureDirectly(l,e,!0),this._unpackFlipY(e.invertY);let u=n.TEXTURE_2D;e.isCube&&(u=n.TEXTURE_CUBE_MAP_POSITIVE_X+i),n.texImage2D(u,r,o,a,s,t),this._bindTextureDirectly(l,null,!0)}updateTextureComparisonFunction(e,t){if(1===this.webGLVersion)return void d.Y.Error("WebGL 1 does not support texture comparison.");const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),0===t?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),0===t?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new c.M(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,i=10){const r=this._gl;return new Promise(((n,s)=>{const a=()=>{const o=r.clientWaitSync(e,t,0);o!=r.WAIT_FAILED?o!=r.TIMEOUT_EXPIRED?n():setTimeout(a,i):s()};a()}))}_readPixelsAsync(e,t,i,r,n,s,a){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const o=this._gl,l=o.createBuffer();o.bindBuffer(o.PIXEL_PACK_BUFFER,l),o.bufferData(o.PIXEL_PACK_BUFFER,a.byteLength,o.STREAM_READ),o.readPixels(e,t,i,r,n,s,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null);const u=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);return u?(o.flush(),this._clientWaitAsync(u,0,10).then((()=>(o.deleteSync(u),o.bindBuffer(o.PIXEL_PACK_BUFFER,l),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,a),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),o.deleteBuffer(l),a)))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();1===p.Instances.length&&p.audioEngine&&(p.audioEngine.dispose(),p.audioEngine=null),this.disableVR();const e=this.getHostWindow();e&&"function"==typeof e.removeEventListener&&(e.removeEventListener("blur",this._onBlur),e.removeEventListener("focus",this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),(0,s.n5)()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)),super.dispose();const t=p.Instances.indexOf(this);t>=0&&p.Instances.splice(t,1),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){this._renderingCanvas&&this._renderingCanvas.setAttribute&&(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!(0,s.CG)())return;const e=this.loadingScreen;e&&e.displayLoadingUI()}hideLoadingUI(){if(!(0,s.CG)())return;const e=this._loadingScreen;e&&e.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=p.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(e){this._loadingScreen=e}set loadingUIText(e){this.loadingScreen.loadingUIText=e}set loadingUIBackgroundColor(e){this.loadingScreen.loadingUIBackgroundColor=e}createVideoElement(e){return document.createElement("video")}static _RequestPointerlock(e){if(e.requestPointerLock){const t=e.requestPointerLock();t instanceof Promise?t.then((()=>{e.focus()})).catch((()=>{})):e.focus()}}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(e){const t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e)}static _ExitFullscreen(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}getFontOffset(e){const t=document.createElement("span");t.innerHTML="Hg",t.setAttribute("style",`font: ${e} !important`);const i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";const r=document.createElement("div");r.style.whiteSpace="nowrap",r.appendChild(t),r.appendChild(i),document.body.appendChild(r);let n=0,s=0;try{s=i.getBoundingClientRect().top-t.getBoundingClientRect().top,i.style.verticalAlign="baseline",n=i.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(r)}return{ascent:n,height:s,descent:s-n}}}p.ALPHA_DISABLE=0,p.ALPHA_ADD=1,p.ALPHA_COMBINE=2,p.ALPHA_SUBTRACT=3,p.ALPHA_MULTIPLY=4,p.ALPHA_MAXIMIZED=5,p.ALPHA_ONEONE=6,p.ALPHA_PREMULTIPLIED=7,p.ALPHA_PREMULTIPLIED_PORTERDUFF=8,p.ALPHA_INTERPOLATE=9,p.ALPHA_SCREENMODE=10,p.DELAYLOADSTATE_NONE=0,p.DELAYLOADSTATE_LOADED=1,p.DELAYLOADSTATE_LOADING=2,p.DELAYLOADSTATE_NOTLOADED=4,p.NEVER=512,p.ALWAYS=519,p.LESS=513,p.EQUAL=514,p.LEQUAL=515,p.GREATER=516,p.GEQUAL=518,p.NOTEQUAL=517,p.KEEP=7680,p.REPLACE=7681,p.INCR=7682,p.DECR=7683,p.INVERT=5386,p.INCR_WRAP=34055,p.DECR_WRAP=34056,p.TEXTURE_CLAMP_ADDRESSMODE=0,p.TEXTURE_WRAP_ADDRESSMODE=1,p.TEXTURE_MIRROR_ADDRESSMODE=2,p.TEXTUREFORMAT_ALPHA=0,p.TEXTUREFORMAT_LUMINANCE=1,p.TEXTUREFORMAT_LUMINANCE_ALPHA=2,p.TEXTUREFORMAT_RGB=4,p.TEXTUREFORMAT_RGBA=5,p.TEXTUREFORMAT_RED=6,p.TEXTUREFORMAT_R=6,p.TEXTUREFORMAT_RG=7,p.TEXTUREFORMAT_RED_INTEGER=8,p.TEXTUREFORMAT_R_INTEGER=8,p.TEXTUREFORMAT_RG_INTEGER=9,p.TEXTUREFORMAT_RGB_INTEGER=10,p.TEXTUREFORMAT_RGBA_INTEGER=11,p.TEXTURETYPE_UNSIGNED_BYTE=0,p.TEXTURETYPE_UNSIGNED_INT=0,p.TEXTURETYPE_FLOAT=1,p.TEXTURETYPE_HALF_FLOAT=2,p.TEXTURETYPE_BYTE=3,p.TEXTURETYPE_SHORT=4,p.TEXTURETYPE_UNSIGNED_SHORT=5,p.TEXTURETYPE_INT=6,p.TEXTURETYPE_UNSIGNED_INTEGER=7,p.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,p.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,p.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,p.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,p.TEXTURETYPE_UNSIGNED_INT_24_8=12,p.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,p.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,p.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,p.TEXTURE_NEAREST_SAMPLINGMODE=1,p.TEXTURE_BILINEAR_SAMPLINGMODE=2,p.TEXTURE_TRILINEAR_SAMPLINGMODE=3,p.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,p.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,p.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,p.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,p.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,p.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,p.TEXTURE_NEAREST_LINEAR=7,p.TEXTURE_NEAREST_NEAREST=1,p.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,p.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,p.TEXTURE_LINEAR_LINEAR=2,p.TEXTURE_LINEAR_NEAREST=12,p.TEXTURE_EXPLICIT_MODE=0,p.TEXTURE_SPHERICAL_MODE=1,p.TEXTURE_PLANAR_MODE=2,p.TEXTURE_CUBIC_MODE=3,p.TEXTURE_PROJECTION_MODE=4,p.TEXTURE_SKYBOX_MODE=5,p.TEXTURE_INVCUBIC_MODE=6,p.TEXTURE_EQUIRECTANGULAR_MODE=7,p.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,p.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,p.SCALEMODE_FLOOR=1,p.SCALEMODE_NEAREST=2,p.SCALEMODE_CEILING=3,p._RescalePostProcessFactory=null,p._RenderPassIdCounter=0},15210:(e,t,i)=>{i.d(t,{l:()=>r});class r{static get LastCreatedEngine(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}r.Instances=new Array,r._LastCreatedScene=null,r.UseFallbackTexture=!0,r.FallbackTexture=""},53128:(e,t,i)=>{i(34941),i(62457);var r=i(61159),n=i(37290);i(15210),i(79488),i(21352);r.B.prototype._debugPushGroup=function(e,t){},r.B.prototype._debugPopGroup=function(e){},r.B.prototype._debugInsertMarker=function(e,t){},r.B.prototype._debugFlushPendingCommands=function(){};var s=i(71419),a=i(98467),o=i(82577);class l{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=s.x.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=s.x.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}n.D.prototype.createQuery=function(){const e=this._gl.createQuery();if(!e)throw new Error("Unable to create Occlusion Query");return e},n.D.prototype.deleteQuery=function(e){return this._gl.deleteQuery(e),this},n.D.prototype.isQueryResultAvailable=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT_AVAILABLE)},n.D.prototype.getQueryResult=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT)},n.D.prototype.beginOcclusionQuery=function(e,t){const i=this._getGlAlgorithmType(e);return this._gl.beginQuery(i,t),!0},n.D.prototype.endOcclusionQuery=function(e){const t=this._getGlAlgorithmType(e);return this._gl.endQuery(t),this},n.D.prototype._createTimeQuery=function(){const e=this.getCaps().timerQuery;return e.createQueryEXT?e.createQueryEXT():this.createQuery()},n.D.prototype._deleteTimeQuery=function(e){const t=this.getCaps().timerQuery;t.deleteQueryEXT?t.deleteQueryEXT(e):this.deleteQuery(e)},n.D.prototype._getTimeQueryResult=function(e){const t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_EXT):this.getQueryResult(e)},n.D.prototype._getTimeQueryAvailability=function(e){const t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(e)},n.D.prototype.startTimeQuery=function(){const e=this.getCaps(),t=e.timerQuery;if(!t)return null;const i=new a.W;if(this._gl.getParameter(t.GPU_DISJOINT_EXT),e.canUseTimestampForTimerQuery)i._startTimeQuery=this._createTimeQuery(),t.queryCounterEXT(i._startTimeQuery,t.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;i._timeElapsedQuery=this._createTimeQuery(),t.beginQueryEXT?t.beginQueryEXT(t.TIME_ELAPSED_EXT,i._timeElapsedQuery):this._gl.beginQuery(t.TIME_ELAPSED_EXT,i._timeElapsedQuery),this._currentNonTimestampToken=i}return i},n.D.prototype.endTimeQuery=function(e){const t=this.getCaps(),i=t.timerQuery;if(!i||!e)return-1;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery)return-1;e._endTimeQuery||(e._endTimeQuery=this._createTimeQuery(),i.queryCounterEXT(e._endTimeQuery,i.TIMESTAMP_EXT))}else if(!e._timeElapsedQueryEnded){if(!e._timeElapsedQuery)return-1;i.endQueryEXT?i.endQueryEXT(i.TIME_ELAPSED_EXT):(this._gl.endQuery(i.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),e._timeElapsedQueryEnded=!0}const r=this._gl.getParameter(i.GPU_DISJOINT_EXT);let n=!1;if(e._endTimeQuery?n=this._getTimeQueryAvailability(e._endTimeQuery):e._timeElapsedQuery&&(n=this._getTimeQueryAvailability(e._timeElapsedQuery)),n&&!r){let i=0;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery||!e._endTimeQuery)return-1;const t=this._getTimeQueryResult(e._startTimeQuery);i=this._getTimeQueryResult(e._endTimeQuery)-t,this._deleteTimeQuery(e._startTimeQuery),this._deleteTimeQuery(e._endTimeQuery),e._startTimeQuery=null,e._endTimeQuery=null}else{if(!e._timeElapsedQuery)return-1;i=this._getTimeQueryResult(e._timeElapsedQuery),this._deleteTimeQuery(e._timeElapsedQuery),e._timeElapsedQuery=null,e._timeElapsedQueryEnded=!1}return i}return-1},n.D.prototype._captureGPUFrameTime=!1,n.D.prototype._gpuFrameTime=new o.z,n.D.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime},n.D.prototype.captureGPUFrameTime=function(e){e!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=e,e?(this._onBeginFrameObserver=this.onBeginFrameObservable.add((()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())})),this._onEndFrameObserver=this.onEndFrameObservable.add((()=>{if(!this._gpuFrameTimeToken)return;const e=this.endTimeQuery(this._gpuFrameTimeToken);e>-1&&(this._gpuFrameTimeToken=null,this._gpuFrameTime.fetchNewFrame(),this._gpuFrameTime.addCount(e,!0))}))):(this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))},n.D.prototype._getGlAlgorithmType=function(e){return e===s.x.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED},Object.defineProperty(s.x.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(e){this._occlusionDataStorage.isOcclusionQueryInProgress=e},enumerable:!1,configurable:!0}),Object.defineProperty(s.x.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new l),this.__occlusionDataStorage},enumerable:!1,configurable:!0}),Object.defineProperty(s.x.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(e){this._occlusionDataStorage.isOccluded=e},enumerable:!0,configurable:!0}),Object.defineProperty(s.x.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(e){this._occlusionDataStorage.occlusionQueryAlgorithmType=e},enumerable:!0,configurable:!0}),Object.defineProperty(s.x.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(e){this._occlusionDataStorage.occlusionType=e},enumerable:!0,configurable:!0}),Object.defineProperty(s.x.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(e){this._occlusionDataStorage.occlusionRetryCount=e},enumerable:!0,configurable:!0}),Object.defineProperty(s.x.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(e){this._occlusionDataStorage.forceRenderingWhenOccluded=e},enumerable:!0,configurable:!0}),s.x.prototype._checkOcclusionQuery=function(){const e=this._occlusionDataStorage;if(e.occlusionType===s.x.OCCLUSION_TYPE_NONE)return e.isOccluded=!1,!1;const t=this.getEngine();if(!t.getCaps().supportOcclusionQuery)return e.isOccluded=!1,!1;if(!t.isQueryResultAvailable)return e.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery){if(t.isQueryResultAvailable(this._occlusionQuery)){const i=t.getQueryResult(this._occlusionQuery);e.isOcclusionQueryInProgress=!1,e.occlusionInternalRetryCounter=0,e.isOccluded=!(i>0)}else{if(e.occlusionInternalRetryCounter++,!(-1!==e.occlusionRetryCount&&e.occlusionInternalRetryCounter>e.occlusionRetryCount))return e.occlusionType!==s.x.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded;e.isOcclusionQueryInProgress=!1,e.occlusionInternalRetryCounter=0,e.isOccluded=e.occlusionType!==s.x.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded}}const i=this.getScene();if(i.getBoundingBoxRenderer){const r=i.getBoundingBoxRenderer();null===this._occlusionQuery&&(this._occlusionQuery=t.createQuery()),t.beginOcclusionQuery(e.occlusionQueryAlgorithmType,this._occlusionQuery)&&(r.renderOcclusionBoundingBox(this),t.endOcclusionQuery(e.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return e.isOccluded};n.D.prototype.createTransformFeedback=function(){const e=this._gl.createTransformFeedback();if(!e)throw new Error("Unable to create Transform Feedback");return e},n.D.prototype.deleteTransformFeedback=function(e){this._gl.deleteTransformFeedback(e)},n.D.prototype.bindTransformFeedback=function(e){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,e)},n.D.prototype.beginTransformFeedback=function(e=!0){this._gl.beginTransformFeedback(e?this._gl.POINTS:this._gl.TRIANGLES)},n.D.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},n.D.prototype.setTranformFeedbackVaryings=function(e,t){this._gl.transformFeedbackVaryings(e,t,this._gl.INTERLEAVED_ATTRIBS)},n.D.prototype.bindTransformFeedbackBuffer=function(e){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e?e.underlyingResource:null)};i(74649),i(51392),i(25008),i(54904),i(52858),i(17770),i(90052),i(13534),i(74500);r.B.prototype.setTextureSampler=function(e,t){throw new Error("setTextureSampler: This engine does not support separate texture sampler objects!")};i(99986),i(78459),i(89553);var u=i(62897);const h=new u.y$,c=new u.y$;Object.defineProperty(n.D.prototype,"onBeforeViewRenderObservable",{get:function(){return h}}),Object.defineProperty(n.D.prototype,"onAfterViewRenderObservable",{get:function(){return c}}),Object.defineProperty(n.D.prototype,"inputElement",{get:function(){return this._inputElement},set:function(e){var t;this._inputElement!==e&&(this._inputElement=e,null===(t=this._onEngineViewChanged)||void 0===t||t.call(this))}}),n.D.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()},n.D.prototype.registerView=function(e,t,i){this.views||(this.views=[]);for(const t of this.views)if(t.target===e)return t;const r=this.getRenderingCanvas();r&&(e.width=r.width,e.height=r.height);const n={target:e,camera:t,clearBeforeCopy:i,enabled:!0,id:(1e5*Math.random()).toFixed()};return this.views.push(n),t&&t.onDisposeObservable.add((()=>{this.unRegisterView(e)})),n},n.D.prototype.unRegisterView=function(e){if(!this.views||0===this.views.length)return this;for(const t of this.views)if(t.target===e){const e=this.views.indexOf(t);-1!==e&&this.views.splice(e,1);break}return this},n.D.prototype._renderViewStep=function(e){const t=e.target,i=t.getContext("2d");if(!i)return!0;const r=this.getRenderingCanvas();h.notifyObservers(e);const n=e.camera;let s=null,a=null;if(n){if(a=n.getScene(),!a||a.activeCameras&&a.activeCameras.length)return!0;this.activeView=e,s=a.activeCamera,a.activeCamera=n}if(e.customResize)e.customResize(t);else{const e=Math.floor(t.clientWidth/this._hardwareScalingLevel),i=Math.floor(t.clientHeight/this._hardwareScalingLevel),n=e!==t.width||r.width!==t.width||i!==t.height||r.height!==t.height;t.clientWidth&&t.clientHeight&&n&&(t.width=e,t.height=i,this.setSize(e,i))}return!(!r.width||!r.height)&&(this._renderFrame(),this.flushFramebuffer(),e.clearBeforeCopy&&i.clearRect(0,0,r.width,r.height),i.drawImage(r,0,0),s&&a&&(a.activeCamera=s),c.notifyObservers(e),!0)},n.D.prototype._renderViews=function(){if(!this.views||0===this.views.length)return!1;if(!this.getRenderingCanvas())return!1;let e;for(const t of this.views){if(!t.enabled)continue;if(t.target!==this.inputElement){if(!this._renderViewStep(t))return!1}else e=t}return!(e&&!this._renderViewStep(e))&&(this.activeView=null,!0)};i(5382);var d=i(34435);function _(e){if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some((t=>{const i="\\b"+t+"\\b";return e&&(e===t||e.match(new RegExp(i,"g")))})))return e;const t=e.lastIndexOf("."),i=e.lastIndexOf("?"),r=i>-1?e.substring(i,e.length):"";return(t>-1?e.substring(0,t):e)+this._textureFormatInUse+r}r.B.prototype.createStorageBuffer=function(e,t){throw new Error("createStorageBuffer: Unsupported method in this engine!")},r.B.prototype.updateStorageBuffer=function(e,t,i,r){},r.B.prototype.readFromStorageBuffer=function(e,t,i,r){throw new Error("readFromStorageBuffer: Unsupported method in this engine!")},r.B.prototype.setStorageBuffer=function(e,t){throw new Error("setStorageBuffer: Unsupported method in this engine!")},Object.defineProperty(n.D.prototype,"texturesSupported",{get:function(){const e=new Array;return this._caps.astc&&e.push("-astc.ktx"),this._caps.s3tc&&e.push("-dxt.ktx"),this._caps.pvrtc&&e.push("-pvrtc.ktx"),this._caps.etc2&&e.push("-etc2.ktx"),this._caps.etc1&&e.push("-etc1.ktx"),e},enumerable:!0,configurable:!0}),Object.defineProperty(n.D.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0}),n.D.prototype.setCompressedTextureExclusions=function(e){this._excludedCompressedTextures=e},n.D.prototype.setTextureFormatToUse=function(e){const t=this.texturesSupported;for(let i=0,r=t.length;i<r;i++)for(let r=0,n=e.length;r<n;r++)if(t[i]===e[r].toLowerCase())return this._transformTextureUrl=_.bind(this),this._textureFormatInUse=t[i];return this._textureFormatInUse="",this._transformTextureUrl=null,null};var p=i(72759);i(49576).I6._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new g:new p.e};class g extends p.e{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}}var f=i(60100);f.f.prototype.setAlphaMode=function(e,t=!1){if(this._alphaMode===e&&(0===e&&!this._alphaState.alphaBlend||0!==e&&this._alphaState.alphaBlend)){if(!t){const t=0===e;this.depthCullingState.depthMask!==t&&(this.setDepthWrite(t),this._cacheRenderPipeline.setDepthWriteEnabled(t))}}else{switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,1),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(772,1,0,0),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(775,769,773,771),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,0),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(775,769,0,1),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,771),this._alphaState.alphaBlend=!0}t||(this.setDepthWrite(e===n.D.ALPHA_DISABLE),this._cacheRenderPipeline.setDepthWriteEnabled(e===n.D.ALPHA_DISABLE)),this._alphaMode=e,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)}},f.f.prototype.setAlphaEquation=function(e){n.D.prototype.setAlphaEquation.call(this,e),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};var m=i(27154),E=i(84318),T=i(8724);class x{getBindGroups(e,t,i){if(!i)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(0===this._bindGroups.length){const r=this._bindGroupEntries.length>0;for(const t in e){const n=e[t],s=i[t],a=s.group,o=s.binding,l=n.type,u=n.object;let h=n.indexInGroupEntries,c=this._bindGroupEntries[a];switch(c||(c=this._bindGroupEntries[a]=[]),l){case d.t.Sampler:{const e=u;void 0!==h&&r?c[h].resource=this._cacheSampler.getSampler(e):(n.indexInGroupEntries=c.length,c.push({binding:o,resource:this._cacheSampler.getSampler(e)}));break}case d.t.Texture:case d.t.TextureWithoutSampler:{const e=u,t=e._texture._hardwareTexture;void 0!==h&&r?(l===d.t.Texture&&(c[h++].resource=this._cacheSampler.getSampler(e._texture)),c[h].resource=t.view):(n.indexInGroupEntries=c.length,l===d.t.Texture&&c.push({binding:o-1,resource:this._cacheSampler.getSampler(e._texture)}),c.push({binding:o,resource:t.view}));break}case d.t.StorageTexture:{const e=u,t=e._texture._hardwareTexture;0==(t.textureAdditionalUsages&T.v2.StorageBinding)&&E.Y.Error(`computeDispatch: The texture (name=${e.name}, uniqueId=${e.uniqueId}) is not a storage texture!`,50),void 0!==h&&r?c[h].resource=t.viewForWriting:(n.indexInGroupEntries=c.length,c.push({binding:o,resource:t.viewForWriting}));break}case d.t.UniformBuffer:case d.t.StorageBuffer:{const e=(d.t.UniformBuffer,u).getBuffer(),t=e.underlyingResource;void 0!==h&&r?(c[h].resource.buffer=t,c[h].resource.size=e.capacity):(n.indexInGroupEntries=c.length,c.push({binding:o,resource:{buffer:t,offset:0,size:e.capacity}}));break}}}for(let e=0;e<this._bindGroupEntries.length;++e){const i=this._bindGroupEntries[e];i?this._bindGroups[e]=this._device.createBindGroup({layout:t.getBindGroupLayout(e),entries:i}):this._bindGroups[e]=void 0}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=x._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}x._Counter=0;class S{get isAsync(){return!1}get isReady(){return!!this.stage}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){var e;return null===(e=this.sources)||void 0===e?void 0:e.compute}dispose(){}}f.f.prototype.createComputeContext=function(){return new x(this._device,this._cacheSampler)},f.f.prototype.createComputeEffect=function(e,t){const i=(e.computeElement||e.compute||e.computeToken||e.computeSource||e)+"@"+t.defines;if(this._compiledComputeEffects[i]){const e=this._compiledComputeEffects[i];return t.onCompiled&&e.isReady()&&t.onCompiled(e),e}const r=new m.n(e,t,this,i);return this._compiledComputeEffects[i]=r,r},f.f.prototype.createComputePipelineContext=function(){return new S(this)},f.f.prototype.areAllComputeEffectsReady=function(){for(const e in this._compiledComputeEffects){if(!this._compiledComputeEffects[e].isReady())return!1}return!0},f.f.prototype.computeDispatch=function(e,t,i,r,n,s,a){if(this._currentRenderTarget)return void this._onAfterUnbindFrameBufferObservable.addOnce((()=>{this.computeDispatch(e,t,i,r,n,s,a)}));const o=e._pipelineContext,l=t;o.computePipeline||(o.computePipeline=this._device.createComputePipeline({layout:T.fu.Auto,compute:o.stage}));const u=this._renderTargetEncoder.beginComputePass();u.setPipeline(o.computePipeline);const h=l.getBindGroups(i,o.computePipeline,a);for(let e=0;e<h.length;++e){const t=h[e];t&&u.setBindGroup(e,t)}u.dispatchWorkgroups(r,n,s),u.end()},f.f.prototype.releaseComputeEffects=function(){for(const e in this._compiledComputeEffects){const t=this._compiledComputeEffects[e].getPipelineContext();this._deleteComputePipelineContext(t)}this._compiledComputeEffects={}},f.f.prototype._prepareComputePipelineContext=function(e,t,i,r,n){const s=e;this.dbgShowShaderCode,s.sources={compute:t,rawCompute:i},s.stage=this._createComputePipelineStageDescriptor(t,r,n)},f.f.prototype._releaseComputeEffect=function(e){this._compiledComputeEffects[e._key]&&(delete this._compiledComputeEffects[e._key],this._deleteComputePipelineContext(e.getPipelineContext()))},f.f.prototype._rebuildComputeEffects=function(){for(const e in this._compiledComputeEffects){const t=this._compiledComputeEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}},f.f.prototype._deleteComputePipelineContext=function(e){e&&e.dispose()},f.f.prototype._createComputePipelineStageDescriptor=function(e,t,i){return t=t?"//"+t.split("\n").join("\n//")+"\n":"",{module:this._device.createShaderModule({code:t+e}),entryPoint:i}};var b=i(59157);f.f.prototype._createDepthStencilCubeTexture=function(e,t){const i=new b.l(this,b.S.DepthStencil);i.isCube=!0;const r={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,...t};return i.format=r.generateStencil?13:14,this._setupDepthStencilTexture(i,e,r.generateStencil,r.bilinearFiltering,r.comparisonFunction,r.samples),this._textureHelper.createGPUTextureForInternalTexture(i),this._internalTexturesCache.push(i),i},f.f.prototype.createCubeTexture=function(e,t,i,r,n=null,s=null,a,o=null,l=!1,u=0,h=0,c=null,d=!1){return this.createCubeTextureBase(e,t,i,!!r,n,s,a,o,l,u,h,c,null,((e,t)=>{const i=t,s=i[0].width,o=s;this._setCubeMapTextureParams(e,!r),e.format=null!=a?a:-1;const l=this._textureHelper.createGPUTextureForInternalTexture(e,s,o);this._textureHelper.updateCubeTextures(i,l.underlyingResource,s,o,l.format,!1,!1,0,0),r||this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),n&&n()}),!!d)},f.f.prototype._setCubeMapTextureParams=function(e,t,i){e.samplingMode=t?3:2,e._cachedWrapU=0,e._cachedWrapV=0,i&&(e._maxLodLevel=i)},f.f.prototype._debugPushGroup=function(e,t){if(this._options.enableGPUDebugMarkers)if(0===t||1===t){(0===t?this._renderEncoder:this._renderTargetEncoder).pushDebugGroup(e)}else this._currentRenderPass?this._currentRenderPass.pushDebugGroup(e):this._pendingDebugCommands.push(["push",e])},f.f.prototype._debugPopGroup=function(e){if(this._options.enableGPUDebugMarkers)if(0===e||1===e){(0===e?this._renderEncoder:this._renderTargetEncoder).popDebugGroup()}else this._currentRenderPass?this._currentRenderPass.popDebugGroup():this._pendingDebugCommands.push(["pop",null])},f.f.prototype._debugInsertMarker=function(e,t){if(this._options.enableGPUDebugMarkers)if(0===t||1===t){(0===t?this._renderEncoder:this._renderTargetEncoder).insertDebugMarker(e)}else this._currentRenderPass?this._currentRenderPass.insertDebugMarker(e):this._pendingDebugCommands.push(["insert",e])},f.f.prototype._debugFlushPendingCommands=function(){for(let e=0;e<this._pendingDebugCommands.length;++e){const[t,i]=this._pendingDebugCommands[e];switch(t){case"push":this._debugPushGroup(i);break;case"pop":this._debugPopGroup();break;case"insert":this._debugInsertMarker(i)}}this._pendingDebugCommands.length=0},f.f.prototype.updateDynamicIndexBuffer=function(e,t,i=0){const r=e;let n;n=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._bufferManager.setSubData(r,i,n)},f.f.prototype.updateDynamicVertexBuffer=function(e,t,i,r){const n=e;let s;void 0===i&&(i=0),void 0===r?(s=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,r=s.byteLength):s=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,this._bufferManager.setSubData(n,i,s,0,r)},f.f.prototype.updateDynamicTexture=function(e,t,i,r=!1,n,s,a){var o;if(!e)return;const l=t.width,u=t.height;let h=e._hardwareTexture;(null===(o=e._hardwareTexture)||void 0===o?void 0:o.underlyingResource)||(h=this._textureHelper.createGPUTextureForInternalTexture(e,l,u)),this._textureHelper.updateTexture(t,e,l,u,e.depth,h.format,0,0,i,r,0,0,a),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0};var R=i(44919);class A extends R.x{constructor(e){super(e)}}var y=i(58445);y.Q.prototype.setExternalTexture=function(e,t){this._engine.setExternalTexture(e,t)},f.f.prototype.createExternalTexture=function(e){return new A(e)},f.f.prototype.setExternalTexture=function(e,t){t?this._setInternalTexture(e,t):this._currentMaterialContext.setTexture(e,null)},f.f.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){i&&i();const r=e._attachments.length;this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass();for(let i=0;i<r;i++){const r=e.textures[i];!r.generateMipMaps||t||r.isCube||this._generateMipmaps(r)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)},f.f.prototype.createMultipleRenderTarget=function(e,t,i){var r;let n=!1,s=!0,a=!1,o=!1,l=15,u=1;let h=new Array,c=new Array,d=new Array;const _=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(n=void 0!==t.generateMipMaps&&t.generateMipMaps,s=void 0===t.generateDepthBuffer||t.generateDepthBuffer,a=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,o=void 0!==t.generateDepthTexture&&t.generateDepthTexture,u=t.textureCount||1,l=null!==(r=t.depthTextureFormat)&&void 0!==r?r:15,t.types&&(h=t.types),t.samplingModes&&(c=t.samplingModes),t.useSRGBBuffers&&(d=t.useSRGBBuffers));const p=e.width||e,g=e.height||e;let f=null;(s||a||o)&&(f=_.createDepthStencilTexture(0,!1,a,1,l));const m=[],T=[],x=[];_._generateDepthBuffer=s,_._generateStencilBuffer=a,_._attachments=T,_._defaultAttachments=x;for(let e=0;e<u;e++){let t=c[e]||3,r=h[e]||0;const s=d[e]||false;(1!==r||this._caps.textureFloatLinearFiltering)&&(2!==r||this._caps.textureHalfFloatLinearFiltering)||(t=1),1!==r||this._caps.textureFloat||(r=0,E.Y.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));const a=new b.l(this,b.S.MultiRenderTarget);m.push(a),T.push(e+1),x.push(i?e+1:0===e?1:0),a.baseWidth=p,a.baseHeight=g,a.width=p,a.height=g,a.isReady=!0,a.samples=1,a.generateMipMaps=n,a.samplingMode=t,a.type=r,a._cachedWrapU=0,a._cachedWrapV=0,a._useSRGBBuffer=s,this._internalTexturesCache.push(a),this._textureHelper.createGPUTextureForInternalTexture(a)}return f&&(f.incrementReferences(),m.push(f),this._internalTexturesCache.push(f)),_.setTextures(m),_},f.f.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t){if(!e||!e.textures||e.textures[0].samples===t)return t;const i=e.textures.length;if(0===i)return 1;t=Math.min(t,this.getCaps().maxMSAASamples);for(let r=0;r<i;++r){const i=e.textures[r];this._textureHelper.createMSAATexture(i,t),i.samples=t}return e._depthStencilTexture&&e._depthStencilTexture!==e.textures[e.textures.length-1]&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),t},f.f.prototype.bindAttachments=function(e){0!==e.length&&this._currentRenderTarget&&(this._mrtAttachments=e,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(e))},f.f.prototype.buildTextureLayout=function(e){const t=[];for(let i=0;i<e.length;i++)e[i]?t.push(i+1):t.push(0);return t},f.f.prototype.restoreSingleAttachment=function(){},f.f.prototype.restoreSingleAttachmentForRenderTarget=function(){};var v=i(81987);function C(e,t,i,r){let n,s=1;1===r?n=new Float32Array(t*i*4):2===r?(n=new Uint16Array(t*i*4),s=15360):n=7===r?new Uint32Array(t*i*4):new Uint8Array(t*i*4);for(let r=0;r<t;r++)for(let a=0;a<i;a++){const i=3*(a*t+r),o=4*(a*t+r);n[o+0]=e[i+0],n[o+1]=e[i+1],n[o+2]=e[i+2],n[o+3]=s}return n}f.f.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter},f.f.prototype.captureGPUFrameTime=function(e){this._timestampQuery.enable=e&&!!this._caps.timerQuery},f.f.prototype.createQuery=function(){return this._occlusionQuery.createQuery()},f.f.prototype.deleteQuery=function(e){return this._occlusionQuery.deleteQuery(e),this},f.f.prototype.isQueryResultAvailable=function(e){return this._occlusionQuery.isQueryResultAvailable(e)},f.f.prototype.getQueryResult=function(e){return this._occlusionQuery.getQueryResult(e)},f.f.prototype.beginOcclusionQuery=function(e,t){var i;if(!this.compatibilityMode){return(0===this._getCurrentRenderPassIndex()?this._bundleList:this._bundleListRenderTarget).addItem(new v.GB(t)),!0}return!!this._occlusionQuery.canBeginQuery&&(null===(i=this._currentRenderPass)||void 0===i||i.beginOcclusionQuery(t),!0)},f.f.prototype.endOcclusionQuery=function(){var e;if(this.compatibilityMode)null===(e=this._currentRenderPass)||void 0===e||e.endOcclusionQuery();else{(0===this._getCurrentRenderPassIndex()?this._bundleList:this._bundleListRenderTarget).addItem(new v.fw)}return this},f.f.prototype.createRawTexture=function(e,t,i,r,n,s,a,o=null,l=0,u=0,h=!1){const c=new b.l(this,b.S.Raw);return c.baseWidth=t,c.baseHeight=i,c.width=t,c.height=i,c.format=r,c.generateMipMaps=n,c.samplingMode=a,c.invertY=s,c._compression=o,c.type=l,c._useSRGBBuffer=h,this._doNotHandleContextLost||(c._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(c,t,i,void 0,u),this.updateRawTexture(c,e,r,s,o,l,h),this._internalTexturesCache.push(c),c},f.f.prototype.updateRawTexture=function(e,t,i,r,n=null,s=0,a=!1){if(e){if(this._doNotHandleContextLost||(e._bufferView=t,e.invertY=r,e._compression=n,e._useSRGBBuffer=a),t){const n=e._hardwareTexture;4===i&&(t=C(t,e.width,e.height,s));const a=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(a,e,e.width,e.height,e.depth,n.format,0,0,r,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0}},f.f.prototype.createRawCubeTexture=function(e,t,i,r,n,s,a,o=null){const l=new b.l(this,b.S.CubeRaw);return 1!==r||this._caps.textureFloatLinearFiltering?2!==r||this._caps.textureHalfFloatLinearFiltering?1!==r||this._caps.textureFloatRender?2!==r||this._caps.colorBufferFloat||(n=!1,E.Y.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(n=!1,E.Y.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(n=!1,a=1,E.Y.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(n=!1,a=1,E.Y.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")),l.isCube=!0,l.format=4===i?5:i,l.type=r,l.generateMipMaps=n,l.width=t,l.height=t,l.samplingMode=a,this._doNotHandleContextLost||(l._bufferViewArray=e),l.invertY=s,l._compression=o,l._cachedWrapU=0,l._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(l),e&&this.updateRawCubeTexture(l,e,i,r,s,o),l.isReady=!0,l},f.f.prototype.updateRawCubeTexture=function(e,t,i,r,n,s=null){e._bufferViewArray=t,e.invertY=n,e._compression=s;const a=e._hardwareTexture,o=4===i,l=[];for(let i=0;i<t.length;++i){let n=t[i];o&&(n=C(t[i],e.width,e.height,r)),l.push(new Uint8Array(n.buffer,n.byteOffset,n.byteLength))}this._textureHelper.updateCubeTextures(l,a.underlyingResource,e.width,e.height,a.format,n,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0},f.f.prototype.createRawCubeTextureFromUrl=function(e,t,i,r,n,s,a,o,l=null,u=null,h=3,c=!1){const d=this.createRawCubeTexture(null,i,r,n,!s,c,h,null);null==t||t.addPendingData(d),d.url=e,this._internalTexturesCache.push(d);const _=e=>{const i=d.width,s=a(e);if(!s)return;const u=[0,2,4,1,3,5];if(o){const e=4===r,t=o(s),a=d._hardwareTexture,l=[0,1,2,3,4,5];for(let r=0;r<t.length;r++){const s=i>>r,o=[];for(let i=0;i<6;i++){let a=t[r][l[i]];e&&(a=C(a,s,s,n)),o.push(new Uint8Array(a.buffer,a.byteOffset,a.byteLength))}this._textureHelper.updateCubeTextures(o,a.underlyingResource,s,s,a.format,c,!1,0,0)}}else{const e=[];for(let t=0;t<6;t++)e.push(s[u[t]]);this.updateRawCubeTexture(d,e,r,n,c)}d.isReady=!0,null==t||t.removePendingData(d),l&&l()};return this._loadFile(e,(e=>{_(e)}),void 0,null==t?void 0:t.offlineProvider,!0,((e,i)=>{null==t||t.removePendingData(d),u&&e&&u(e.status+" "+e.statusText,i)})),d},f.f.prototype.createRawTexture3D=function(e,t,i,r,n,s,a,o,l=null,u=0,h=0){const c=b.S.Raw3D,d=new b.l(this,c);return d.baseWidth=t,d.baseHeight=i,d.baseDepth=r,d.width=t,d.height=i,d.depth=r,d.format=n,d.type=u,d.generateMipMaps=s,d.samplingMode=o,d.is3D=!0,this._doNotHandleContextLost||(d._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(d,t,i,void 0,h),this.updateRawTexture3D(d,e,n,a,l,u),this._internalTexturesCache.push(d),d},f.f.prototype.updateRawTexture3D=function(e,t,i,r,n=null,s=0){if(this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=r,e._compression=n),t){const n=e._hardwareTexture;4===i&&(t=C(t,e.width,e.height,s));const a=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(a,e,e.width,e.height,e.depth,n.format,0,0,r,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},f.f.prototype.createRawTexture2DArray=function(e,t,i,r,n,s,a,o,l=null,u=0,h=0){const c=b.S.Raw2DArray,d=new b.l(this,c);return d.baseWidth=t,d.baseHeight=i,d.baseDepth=r,d.width=t,d.height=i,d.depth=r,d.format=n,d.type=u,d.generateMipMaps=s,d.samplingMode=o,d.is2DArray=!0,this._doNotHandleContextLost||(d._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(d,t,i,r,h),this.updateRawTexture2DArray(d,e,n,a,l,u),this._internalTexturesCache.push(d),d},f.f.prototype.updateRawTexture2DArray=function(e,t,i,r,n=null,s=0){if(this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=r,e._compression=n),t){const n=e._hardwareTexture;4===i&&(t=C(t,e.width,e.height,s));const a=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(a,e,e.width,e.height,e.depth,n.format,0,0,r,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},f.f.prototype._readTexturePixels=function(e,t,i,r=-1,n=0,s=null,a=!0,o=!1,l=0,u=0){const h=e._hardwareTexture;return a&&this.flushFramebuffer(),this._textureHelper.readPixels(h.underlyingResource,l,u,t,i,h.format,r,n,s,o)},f.f.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"};var B=i(73005);class I extends B.r{}f.f.prototype._createHardwareRenderTargetWrapper=function(e,t,i){const r=new I(e,t,i,this);return this._renderTargetWrapperCache.push(r),r},f.f.prototype.createRenderTargetTexture=function(e,t){var i,r;const n=this._createHardwareRenderTargetWrapper(!1,!1,e),s={};void 0!==t&&"object"==typeof t?(s.generateMipMaps=t.generateMipMaps,s.generateDepthBuffer=void 0===t.generateDepthBuffer||t.generateDepthBuffer,s.generateStencilBuffer=s.generateDepthBuffer&&t.generateStencilBuffer,s.samplingMode=void 0===t.samplingMode?3:t.samplingMode,s.creationFlags=null!==(i=t.creationFlags)&&void 0!==i?i:0,s.noColorAttachment=!!t.noColorAttachment,s.samples=t.samples):(s.generateMipMaps=t,s.generateDepthBuffer=!0,s.generateStencilBuffer=!1,s.samplingMode=3,s.creationFlags=0,s.noColorAttachment=!1);const a=s.noColorAttachment?null:this._createInternalTexture(e,t,!0,b.S.RenderTarget);return n._samples=null!==(r=s.samples)&&void 0!==r?r:1,n._generateDepthBuffer=s.generateDepthBuffer,n._generateStencilBuffer=!!s.generateStencilBuffer,n.setTextures(a),(n._generateDepthBuffer||n._generateStencilBuffer)&&n.createDepthStencilTexture(0,this._caps.textureFloatLinearFiltering&&(void 0===s.samplingMode||2===s.samplingMode||2===s.samplingMode||3===s.samplingMode||3===s.samplingMode||5===s.samplingMode||6===s.samplingMode||7===s.samplingMode||11===s.samplingMode),n._generateStencilBuffer,n.samples,s.generateStencilBuffer?13:14),a&&(void 0!==t&&"object"==typeof t&&t.createMipMaps&&!s.generateMipMaps&&(a.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(a,void 0,void 0,void 0,s.creationFlags),void 0!==t&&"object"==typeof t&&t.createMipMaps&&!s.generateMipMaps&&(a.generateMipMaps=!1)),n},f.f.prototype._createDepthStencilTexture=function(e,t){const i=new b.l(this,b.S.DepthStencil),r={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:t.generateStencil?13:14,...t};return i.format=r.depthTextureFormat,this._setupDepthStencilTexture(i,e,r.generateStencil,r.bilinearFiltering,r.comparisonFunction,r.samples),this._textureHelper.createGPUTextureForInternalTexture(i),this._internalTexturesCache.push(i),i},f.f.prototype._setupDepthStencilTexture=function(e,t,i,r,n,s=1){const a=t.width||t,o=t.height||t,l=t.layers||0;e.baseWidth=a,e.baseHeight=o,e.width=a,e.height=o,e.is2DArray=l>0,e.depth=l,e.isReady=!0,e.samples=s,e.generateMipMaps=!1,e.samplingMode=r?2:1,e.type=1,e._comparisonFunction=n,e._cachedWrapU=0,e._cachedWrapV=0},f.f.prototype.updateRenderTargetTextureSampleCount=function(e,t){return e&&e.texture&&e.samples!==t?(t=Math.min(t,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(e.texture,t),e._depthStencilTexture&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),e._samples=t,e.texture.samples=t,t):t},f.f.prototype.createRenderTargetCubeTexture=function(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!0,e),r={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1,...t};r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,i._generateDepthBuffer=r.generateDepthBuffer,i._generateStencilBuffer=r.generateStencilBuffer;const n=new b.l(this,b.S.RenderTarget);return n.width=e,n.height=e,n.depth=0,n.isReady=!0,n.isCube=!0,n.samples=r.samples,n.generateMipMaps=r.generateMipMaps,n.samplingMode=r.samplingMode,n.type=r.type,n.format=r.format,this._internalTexturesCache.push(n),i.setTextures(n),(i._generateDepthBuffer||i._generateStencilBuffer)&&i.createDepthStencilTexture(0,void 0===r.samplingMode||2===r.samplingMode||2===r.samplingMode||3===r.samplingMode||3===r.samplingMode||5===r.samplingMode||6===r.samplingMode||7===r.samplingMode||11===r.samplingMode,i._generateStencilBuffer,i.samples),t&&t.createMipMaps&&!r.generateMipMaps&&(n.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(n),t&&t.createMipMaps&&!r.generateMipMaps&&(n.generateMipMaps=!1),i},y.Q.prototype.setTextureSampler=function(e,t){this._engine.setTextureSampler(e,t)},f.f.prototype.setTextureSampler=function(e,t){var i;null===(i=this._currentMaterialContext)||void 0===i||i.setSampler(e,t)},y.Q.prototype.setStorageBuffer=function(e,t){this._engine.setStorageBuffer(e,t)},f.f.prototype.createStorageBuffer=function(e,t){return this._createBuffer(e,32|t)},f.f.prototype.updateStorageBuffer=function(e,t,i,r){const n=e;let s;void 0===i&&(i=0),void 0===r?(s=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,r=s.byteLength):s=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,this._bufferManager.setSubData(n,i,s,0,r)},f.f.prototype.readFromStorageBuffer=function(e,t,i,r){i=i||e.capacity;const n=this._bufferManager.createRawBuffer(i,T.FB.MapRead|T.FB.CopyDst);return this._renderTargetEncoder.copyBufferToBuffer(e.underlyingResource,null!=t?t:0,n,0,i),new Promise(((e,t)=>{this.onEndFrameObservable.addOnce((()=>{n.mapAsync(T.gc.Read,0,i).then((()=>{const t=n.getMappedRange(0,i);let s=r;if(void 0===s)s=new Uint8Array(i),s.set(new Uint8Array(t));else{const e=s.constructor;s=new e(s.buffer),s.set(new e(t))}n.unmap(),this._bufferManager.releaseBuffer(n),e(s)}),(e=>t(e)))}))}))},f.f.prototype.setStorageBuffer=function(e,t){var i,r;null===(i=this._currentDrawContext)||void 0===i||i.setBuffer(e,null!==(r=null==t?void 0:t.getBuffer())&&void 0!==r?r:null)},f.f.prototype.createUniformBuffer=function(e){let t;t=e instanceof Array?new Float32Array(e):e;return this._bufferManager.createBuffer(t,T.FB.Uniform|T.FB.CopyDst)},f.f.prototype.createDynamicUniformBuffer=function(e){return this.createUniformBuffer(e)},f.f.prototype.updateUniformBuffer=function(e,t,i,r){void 0===i&&(i=0);const n=e;let s;void 0===r?(s=t instanceof Float32Array?t:new Float32Array(t),r=s.byteLength):s=t instanceof Float32Array?t:new Float32Array(t),this._bufferManager.setSubData(n,i,s,0,r)},f.f.prototype.bindUniformBufferBase=function(e,t,i){this._currentDrawContext.setBuffer(i,e)},f.f.prototype.bindUniformBlock=function(){},f.f.prototype.updateVideoTexture=function(e,t,i){var r;if(!e||e._isDisabled)return;void 0===this._videoTextureSupported&&(this._videoTextureSupported=!0);let n=e._hardwareTexture;(null===(r=e._hardwareTexture)||void 0===r?void 0:r.underlyingResource)||(n=this._textureHelper.createGPUTextureForInternalTexture(e)),!function(e){return!(!e||void 0===e.underlyingResource)}(t)?t&&this.createImageBitmap(t).then((t=>{this._textureHelper.updateTexture(t,e,e.width,e.height,e.depth,n.format,0,0,!i,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0})).catch((()=>{e.isReady=!0})):(this._textureHelper.copyVideoToTexture(t,e,n.format,!i),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0)};i(86830),i(61319),i(93052),i(85801),i(66970),i(20955),i(9257),i(59412),i(48743),i(57710),i(20298);i(69543)}}]);