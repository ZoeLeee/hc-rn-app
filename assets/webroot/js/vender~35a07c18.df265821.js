"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[919],{8152:(t,e,i)=>{i.d(e,{S:()=>n});var r=i(1101),s=i(58095),a=i(72739);class n{constructor(){this.direction1=new s.P(0,1,0),this.direction2=new s.P(0,1,0),this.minEmitBox=new s.P(-.5,-.5,-.5),this.maxEmitBox=new s.P(.5,.5,.5)}startDirectionFunction(t,e,i,r){const n=a.R.RandomRange(this.direction1.x,this.direction2.x),o=a.R.RandomRange(this.direction1.y,this.direction2.y),h=a.R.RandomRange(this.direction1.z,this.direction2.z);if(r)return e.x=n,e.y=o,void(e.z=h);s.P.TransformNormalFromFloatsToRef(n,o,h,t,e)}startPositionFunction(t,e,i,r){const n=a.R.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),o=a.R.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),h=a.R.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(r)return e.x=n,e.y=o,void(e.z=h);s.P.TransformCoordinatesFromFloatsToRef(n,o,h,t,e)}clone(){const t=new n;return r.j.DeepCopy(this,t),t}applyToShader(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2),t.setVector3("minEmitBox",this.minEmitBox),t.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(t){t.addUniform("direction1",3),t.addUniform("direction2",3),t.addUniform("minEmitBox",3),t.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.minEmitBox=this.minEmitBox.asArray(),t.maxEmitBox=this.maxEmitBox.asArray(),t}parse(t){s.P.FromArrayToRef(t.direction1,0,this.direction1),s.P.FromArrayToRef(t.direction2,0,this.direction2),s.P.FromArrayToRef(t.minEmitBox,0,this.minEmitBox),s.P.FromArrayToRef(t.maxEmitBox,0,this.maxEmitBox)}}},69212:(t,e,i)=>{i.d(e,{L:()=>n});var r=i(1101),s=i(58095),a=i(72739);class n{get radius(){return this._radius}set radius(t){this._radius=t,this._buildHeight()}get angle(){return this._angle}set angle(t){this._angle=t,this._buildHeight()}_buildHeight(){0!==this._angle?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(t=1,e=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=e,this.radius=t}startDirectionFunction(t,e,i,r){r?s.jp.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(t.getTranslation(),s.jp.Vector3[0]).normalize();const n=a.R.RandomRange(0,this.directionRandomizer),o=a.R.RandomRange(0,this.directionRandomizer),h=a.R.RandomRange(0,this.directionRandomizer);e.x=s.jp.Vector3[0].x+n,e.y=s.jp.Vector3[0].y+o,e.z=s.jp.Vector3[0].z+h,e.normalize()}startPositionFunction(t,e,i,r){const n=a.R.RandomRange(0,2*Math.PI);let o;this.emitFromSpawnPointOnly?o=1e-4:(o=a.R.RandomRange(0,this.heightRange),o=1-o*o);let h=this._radius-a.R.RandomRange(0,this._radius*this.radiusRange);h*=o;const c=h*Math.sin(n),d=h*Math.cos(n),l=o*this._height;if(r)return e.x=c,e.y=l,void(e.z=d);s.P.TransformCoordinatesFromFloatsToRef(c,l,d,t,e)}clone(){const t=new n(this._radius,this._angle,this.directionRandomizer);return r.j.DeepCopy(this,t),t}applyToShader(t){t.setFloat2("radius",this._radius,this.radiusRange),t.setFloat("coneAngle",this._angle),t.setFloat2("height",this._height,this.heightRange),t.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(t){t.addUniform("radius",2),t.addUniform("coneAngle",1),t.addUniform("height",2),t.addUniform("directionRandomizer",1)}getEffectDefines(){let t="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(t+="\n#define CONEEMITTERSPAWNPOINT"),t}getClassName(){return"ConeParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t.radius=this._radius,t.angle=this._angle,t.directionRandomizer=this.directionRandomizer,t.radiusRange=this.radiusRange,t.heightRange=this.heightRange,t.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,t}parse(t){this.radius=t.radius,this.angle=t.angle,this.directionRandomizer=t.directionRandomizer,this.radiusRange=void 0!==t.radiusRange?t.radiusRange:1,this.heightRange=void 0!==t.radiusRange?t.heightRange:1,this.emitFromSpawnPointOnly=void 0!==t.emitFromSpawnPointOnly&&t.emitFromSpawnPointOnly}}},97052:(t,e,i)=>{i.d(e,{E:()=>a});var r=i(1101),s=i(58095);class a{constructor(){this.particlePositionGenerator=()=>{},this.particleDestinationGenerator=()=>{}}startDirectionFunction(t,e,i,r){const a=s.jp.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,a);const t=s.jp.Vector3[1];a.subtractToRef(i.position,t),t.scaleToRef(1/i.lifeTime,a)}else a.set(0,0,0);r?e.copyFrom(a):s.P.TransformNormalToRef(a,t,e)}startPositionFunction(t,e,i,r){const a=s.jp.Vector3[0];this.particlePositionGenerator?this.particlePositionGenerator(-1,i,a):a.set(0,0,0),r?e.copyFrom(a):s.P.TransformCoordinatesToRef(a,t,e)}clone(){const t=new a;return r.j.DeepCopy(this,t),t}applyToShader(t){}buildUniformLayout(t){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t}parse(t){}}},4570:(t,e,i)=>{i.d(e,{k:()=>n,z:()=>o});var r=i(58095),s=i(72739),a=i(1101);class n{constructor(t=1,e=1,i=1,s=0){this.radius=t,this.height=e,this.radiusRange=i,this.directionRandomizer=s,this._tempVector=r.P.Zero()}startDirectionFunction(t,e,i,a,n){i.position.subtractToRef(t.getTranslation(),this._tempVector),this._tempVector.normalize(),r.P.TransformNormalToRef(this._tempVector,n,this._tempVector);const o=s.R.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2);let h=Math.atan2(this._tempVector.x,this._tempVector.z);h+=s.R.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=o,this._tempVector.x=Math.sin(h),this._tempVector.z=Math.cos(h),this._tempVector.normalize(),a?e.copyFrom(this._tempVector):r.P.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,t,e)}startPositionFunction(t,e,i,a){const n=s.R.RandomRange(-this.height/2,this.height/2),o=s.R.RandomRange(0,2*Math.PI),h=s.R.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),c=Math.sqrt(h)*this.radius,d=c*Math.cos(o),l=c*Math.sin(o);a?e.copyFromFloats(d,n,l):r.P.TransformCoordinatesFromFloatsToRef(d,n,l,t,e)}clone(){const t=new n(this.radius,this.directionRandomizer);return a.j.DeepCopy(this,t),t}applyToShader(t){t.setFloat("radius",this.radius),t.setFloat("height",this.height),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(t){t.addUniform("radius",1),t.addUniform("height",1),t.addUniform("radiusRange",1),t.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t.radius=this.radius,t.height=this.height,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t}parse(t){this.radius=t.radius,this.height=t.height,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer}}class o extends n{constructor(t=1,e=1,i=1,s=new r.P(0,1,0),a=new r.P(0,1,0)){super(t,e,i),this.direction1=s,this.direction2=a}startDirectionFunction(t,e){const i=s.R.RandomRange(this.direction1.x,this.direction2.x),a=s.R.RandomRange(this.direction1.y,this.direction2.y),n=s.R.RandomRange(this.direction1.z,this.direction2.z);r.P.TransformNormalFromFloatsToRef(i,a,n,t,e)}clone(){const t=new o(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return a.j.DeepCopy(this,t),t}applyToShader(t){t.setFloat("radius",this.radius),t.setFloat("height",this.height),t.setFloat("radiusRange",this.radiusRange),t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)}buildUniformLayout(t){t.addUniform("radius",1),t.addUniform("height",1),t.addUniform("radiusRange",1),t.addUniform("direction1",3),t.addUniform("direction2",3)}getEffectDefines(){return"#define CYLINDEREMITTER\n#define DIRECTEDCYLINDEREMITTER"}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const t=super.serialize();return t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t}parse(t){super.parse(t),this.direction1.copyFrom(t.direction1),this.direction2.copyFrom(t.direction2)}}},50091:(t,e,i)=>{i.d(e,{V:()=>n});var r=i(1101),s=i(58095),a=i(72739);class n{constructor(t=1,e=1,i=0){this.radius=t,this.radiusRange=e,this.directionRandomizer=i}startDirectionFunction(t,e,i,r){const n=i.position.subtract(t.getTranslation()).normalize(),o=a.R.RandomRange(0,this.directionRandomizer),h=a.R.RandomRange(0,this.directionRandomizer),c=a.R.RandomRange(0,this.directionRandomizer);n.x+=o,n.y+=h,n.z+=c,n.normalize(),r?e.copyFrom(n):s.P.TransformNormalFromFloatsToRef(n.x,n.y,n.z,t,e)}startPositionFunction(t,e,i,r){const n=this.radius-a.R.RandomRange(0,this.radius*this.radiusRange),o=a.R.RandomRange(0,1),h=a.R.RandomRange(0,2*Math.PI),c=Math.acos(2*o-1),d=n*Math.cos(h)*Math.sin(c),l=n*Math.cos(c),u=n*Math.sin(h)*Math.sin(c);r?e.copyFromFloats(d,Math.abs(l),u):s.P.TransformCoordinatesFromFloatsToRef(d,Math.abs(l),u,t,e)}clone(){const t=new n(this.radius,this.directionRandomizer);return r.j.DeepCopy(this,t),t}applyToShader(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t.radius=this.radius,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t}parse(t){this.radius=t.radius,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer}}},61761:(t,e,i)=>{i.d(e,{S3:()=>r.S,LV:()=>s.L,z:()=>a.z,kT:()=>a.k,VD:()=>n.V,F3:()=>m,cl:()=>d,cE:()=>l.c,Ai:()=>l.A});var r=i(8152),s=i(69212),a=i(4570),n=i(50091),o=i(1101),h=i(58095),c=i(72739);class d{constructor(){this.direction1=new h.P(0,1,0),this.direction2=new h.P(0,1,0)}startDirectionFunction(t,e,i,r){const s=c.R.RandomRange(this.direction1.x,this.direction2.x),a=c.R.RandomRange(this.direction1.y,this.direction2.y),n=c.R.RandomRange(this.direction1.z,this.direction2.z);r?e.copyFromFloats(s,a,n):h.P.TransformNormalFromFloatsToRef(s,a,n,t,e)}startPositionFunction(t,e,i,r){r?e.copyFromFloats(0,0,0):h.P.TransformCoordinatesFromFloatsToRef(0,0,0,t,e)}clone(){const t=new d;return o.j.DeepCopy(this,t),t}applyToShader(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)}buildUniformLayout(t){t.addUniform("direction1",3),t.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t}parse(t){h.P.FromArrayToRef(t.direction1,0,this.direction1),h.P.FromArrayToRef(t.direction2,0,this.direction2)}}var l=i(54095),u=(i(97052),i(72208));class m{get mesh(){return this._mesh}set mesh(t){this._mesh!==t&&(this._mesh=t,t?(this._indices=t.getIndices(),this._positions=t.getVerticesData(u.o.PositionKind),this._normals=t.getVerticesData(u.o.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}constructor(t=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=h.P.Zero(),this._mesh=null,this.direction1=new h.P(0,1,0),this.direction2=new h.P(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=t}startDirectionFunction(t,e,i,r){if(this.useMeshNormalsForDirection&&this._normals)return void h.P.TransformNormalToRef(this._storedNormal,t,e);const s=c.R.RandomRange(this.direction1.x,this.direction2.x),a=c.R.RandomRange(this.direction1.y,this.direction2.y),n=c.R.RandomRange(this.direction1.z,this.direction2.z);r?e.copyFromFloats(s,a,n):h.P.TransformNormalFromFloatsToRef(s,a,n,t,e)}startPositionFunction(t,e,i,r){if(!this._indices||!this._positions)return;const s=3*Math.random()*(this._indices.length/3)|0,a=Math.random(),n=Math.random()*(1-a),o=1-a-n,c=this._indices[s],d=this._indices[s+1],l=this._indices[s+2],u=h.jp.Vector3[0],m=h.jp.Vector3[1],p=h.jp.Vector3[2],_=h.jp.Vector3[3];h.P.FromArrayToRef(this._positions,3*c,u),h.P.FromArrayToRef(this._positions,3*d,m),h.P.FromArrayToRef(this._positions,3*l,p),_.x=a*u.x+n*m.x+o*p.x,_.y=a*u.y+n*m.y+o*p.y,_.z=a*u.z+n*m.z+o*p.z,r?e.copyFromFloats(_.x,_.y,_.z):h.P.TransformCoordinatesFromFloatsToRef(_.x,_.y,_.z,t,e),this.useMeshNormalsForDirection&&this._normals&&(h.P.FromArrayToRef(this._normals,3*c,u),h.P.FromArrayToRef(this._normals,3*d,m),h.P.FromArrayToRef(this._normals,3*l,p),this._storedNormal.x=a*u.x+n*m.x+o*p.x,this._storedNormal.y=a*u.y+n*m.y+o*p.y,this._storedNormal.z=a*u.z+n*m.z+o*p.z)}clone(){const t=new m(this.mesh);return o.j.DeepCopy(this,t),t}applyToShader(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)}buildUniformLayout(t){t.addUniform("direction1",3),t.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){var t;const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.meshId=null===(t=this.mesh)||void 0===t?void 0:t.id,e.useMeshNormalsForDirection=this.useMeshNormalsForDirection,e}parse(t,e){h.P.FromArrayToRef(t.direction1,0,this.direction1),h.P.FromArrayToRef(t.direction2,0,this.direction2),t.meshId&&e&&(this.mesh=e.getLastMeshById(t.meshId)),this.useMeshNormalsForDirection=t.useMeshNormalsForDirection}}},54095:(t,e,i)=>{i.d(e,{A:()=>n,c:()=>o});var r=i(58095),s=i(72739),a=i(1101);class n{constructor(t=1,e=1,i=0){this.radius=t,this.radiusRange=e,this.directionRandomizer=i}startDirectionFunction(t,e,i,a){const n=i.position.subtract(t.getTranslation()).normalize(),o=s.R.RandomRange(0,this.directionRandomizer),h=s.R.RandomRange(0,this.directionRandomizer),c=s.R.RandomRange(0,this.directionRandomizer);n.x+=o,n.y+=h,n.z+=c,n.normalize(),a?e.copyFrom(n):r.P.TransformNormalFromFloatsToRef(n.x,n.y,n.z,t,e)}startPositionFunction(t,e,i,a){const n=this.radius-s.R.RandomRange(0,this.radius*this.radiusRange),o=s.R.RandomRange(0,1),h=s.R.RandomRange(0,2*Math.PI),c=Math.acos(2*o-1),d=n*Math.cos(h)*Math.sin(c),l=n*Math.cos(c),u=n*Math.sin(h)*Math.sin(c);a?e.copyFromFloats(d,l,u):r.P.TransformCoordinatesFromFloatsToRef(d,l,u,t,e)}clone(){const t=new n(this.radius,this.directionRandomizer);return a.j.DeepCopy(this,t),t}applyToShader(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t.radius=this.radius,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t}parse(t){this.radius=t.radius,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer}}class o extends n{constructor(t=1,e=new r.P(0,1,0),i=new r.P(0,1,0)){super(t),this.direction1=e,this.direction2=i}startDirectionFunction(t,e){const i=s.R.RandomRange(this.direction1.x,this.direction2.x),a=s.R.RandomRange(this.direction1.y,this.direction2.y),n=s.R.RandomRange(this.direction1.z,this.direction2.z);r.P.TransformNormalFromFloatsToRef(i,a,n,t,e)}clone(){const t=new o(this.radius,this.direction1,this.direction2);return a.j.DeepCopy(this,t),t}applyToShader(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)}buildUniformLayout(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("direction1",3),t.addUniform("direction2",3)}getEffectDefines(){return"#define SPHEREEMITTER\n#define DIRECTEDSPHEREEMITTER"}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const t=super.serialize();return t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t}parse(t){super.parse(t),this.direction1.copyFrom(t.direction1),this.direction2.copyFrom(t.direction2)}}},25846:(t,e,i)=>{i.d(e,{U:()=>o});var r=i(58095),s=i(90622),a=i(61761),n=i(15631);i(89553);class o{get noiseTexture(){return this._noiseTexture}set noiseTexture(t){this._noiseTexture!==t&&(this._noiseTexture=t,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(t){this._isAnimationSheetEnabled!=t&&(this._isAnimationSheetEnabled=t,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:r.P.Zero()}set direction1(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:r.P.Zero()}set direction2(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:r.P.Zero()}set minEmitBox(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:r.P.Zero()}set maxEmitBox(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)}get billboardMode(){return this._billboardMode}set billboardMode(t){this._billboardMode!==t&&(this._billboardMode=t,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(t){this._isBillboardBased!==t&&(this._isBillboardBased=t,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(t){this._attachImageProcessingConfiguration(t)}_attachImageProcessingConfiguration(t){t!==this._imageProcessingConfiguration&&(!t&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=t)}_reset(){}_removeGradientAndTexture(t,e,i){if(!e)return this;let r=0;for(const i of e){if(i.gradient===t){e.splice(r,1);break}r++}return i&&i.dispose(),this}constructor(t){this.animations=[],this.renderingGroupId=0,this.emitter=r.P.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new r.P(10,10,10),this.onAnimationEnd=null,this.blendMode=o.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new r.FM(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new r.P(0,0,0),this._useLogarithmicDepth=!1,this.gravity=r.P.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new n.HE(1,1,1,1),this.color2=new n.HE(1,1,1,1),this.colorDead=new n.HE(0,0,0,1),this.textureMask=new n.HE(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new s.b,this.id=t,this.name=t}createPointEmitter(t,e){const i=new a.cl;return i.direction1=t,i.direction2=e,this.particleEmitterType=i,i}createHemisphericEmitter(t=1,e=1){const i=new a.VD(t,e);return this.particleEmitterType=i,i}createSphereEmitter(t=1,e=1){const i=new a.Ai(t,e);return this.particleEmitterType=i,i}createDirectedSphereEmitter(t=1,e=new r.P(0,1,0),i=new r.P(0,1,0)){const s=new a.cE(t,e,i);return this.particleEmitterType=s,s}createCylinderEmitter(t=1,e=1,i=1,r=0){const s=new a.kT(t,e,i,r);return this.particleEmitterType=s,s}createDirectedCylinderEmitter(t=1,e=1,i=1,s=new r.P(0,1,0),n=new r.P(0,1,0)){const o=new a.z(t,e,i,s,n);return this.particleEmitterType=o,o}createConeEmitter(t=1,e=Math.PI/4){const i=new a.LV(t,e);return this.particleEmitterType=i,i}createBoxEmitter(t,e,i,r){const s=new a.S3;return this.particleEmitterType=s,this.direction1=t,this.direction2=e,this.minEmitBox=i,this.maxEmitBox=r,s}}o.BLENDMODE_ONEONE=0,o.BLENDMODE_STANDARD=1,o.BLENDMODE_ADD=2,o.BLENDMODE_MULTIPLY=3,o.BLENDMODE_MULTIPLYADD=4},92993:(t,e,i)=>{i.d(e,{O:()=>a,Q:()=>s});var r=i(34389);class s{constructor(t,e,i,s,a){this.idx=0,this.color=new r.HE(1,1,1,1),this.position=r.P.Zero(),this.rotation=r.P.Zero(),this.uv=new r.FM(0,0),this.velocity=r.P.Zero(),this.pivot=r.P.Zero(),this.translateFromPivot=!1,this._pos=0,this._ind=0,this.groupId=0,this.idxInGroup=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this._globalPosition=r.P.Zero(),this.idx=t,this._group=e,this.groupId=i,this.idxInGroup=s,this._pcs=a}get size(){return this.size}set size(t){this.size=t}get quaternion(){return this.rotationQuaternion}set quaternion(t){this.rotationQuaternion=t}intersectsMesh(t,e){if(!t.hasBoundingInfo)return!1;if(!this._pcs.mesh)throw new Error("Point Cloud System doesnt contain the Mesh");if(e)return t.getBoundingInfo().boundingSphere.intersectsPoint(this.position.add(this._pcs.mesh.position));const i=t.getBoundingInfo().boundingBox,r=i.maximumWorld.x,s=i.minimumWorld.x,a=i.maximumWorld.y,n=i.minimumWorld.y,o=i.maximumWorld.z,h=i.minimumWorld.z,c=this.position.x+this._pcs.mesh.position.x,d=this.position.y+this._pcs.mesh.position.y,l=this.position.z+this._pcs.mesh.position.z;return s<=c&&c<=r&&n<=d&&d<=a&&h<=l&&l<=o}getRotationMatrix(t){let e;if(this.rotationQuaternion)e=this.rotationQuaternion;else{e=r.jp.Quaternion[0];const t=this.rotation;r._f.RotationYawPitchRollToRef(t.y,t.x,t.z,e)}e.toRotationMatrix(t)}}class a{get groupID(){return this.groupId}set groupID(t){this.groupId=t}constructor(t,e){this.groupId=t,this._positionFunction=e}}},4392:(t,e,i)=>{i.d(e,{h:()=>b});var r=i(4359),s=i(62897),a=i(58095),n=i(15631),o=i(72739),h=i(72208),c=i(25846),d=i(22672),l=i(8152),u=i(90360),m=i(90622),p=i(46807),_=i(15210),f=i(97052),g=i(61159),y=i(67759),S=(i(79762),i(12954),i(48620)),x=i(77633);class b extends c.U{static get IsSupported(){if(!_.l.LastCreatedEngine)return!1;const t=_.l.LastCreatedEngine.getCaps();return t.supportTransformFeedbacks||t.supportComputeShaders}getCapacity(){return this._capacity}get activeParticleCount(){return this._activeCount}set activeParticleCount(t){this._activeCount=Math.min(t,this._capacity)}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==d.p.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else{if(!this._getWrapper(d.p.BLENDMODE_MULTIPLY).effect.isReady())return!1;if(!this._getWrapper(d.p.BLENDMODE_ADD).effect.isReady())return!1}return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)}isStarted(){return this._started}isStopped(){return this._stopped}isStopping(){return!1}getActiveCount(){return this._currentActiveCount}start(t=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";t?setTimeout((()=>{this.start(0)}),t):(this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop))}stop(){this._stopped||(this._stopped=!0)}reset(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(t=0){var e,i;return null!==(i=null===(e=this._customWrappers[t])||void 0===e?void 0:e.effect)&&void 0!==i?i:this._customWrappers[0].effect}_getCustomDrawWrapper(t=0){var e;return null!==(e=this._customWrappers[t])&&void 0!==e?e:this._customWrappers[0]}setCustomEffect(t,e=0){this._customWrappers[e]=new y.q(this._engine),this._customWrappers[e].effect=t}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new s.y$),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"gpuRenderParticles"}get vertexBuffers(){return this._renderVertexBuffers[1^this._targetIndex]}get indexBuffer(){return null}_removeGradientAndTexture(t,e,i){return super._removeGradientAndTexture(t,e,i),this._releaseBuffers(),this}addColorGradient(t,e){this._colorGradients||(this._colorGradients=[]);const i=new r.bK(t,e);return this._colorGradients.push(i),this._refreshColorGradient(!0),this._releaseBuffers(),this}_refreshColorGradient(t=!1){this._colorGradients&&(t&&this._colorGradients.sort(((t,e)=>t.gradient<e.gradient?-1:t.gradient>e.gradient?1:0)),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))}forceRefreshGradients(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()}removeColorGradient(t){return this._removeGradientAndTexture(t,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this}resetDrawCache(){var t;for(const e in this._drawWrappers){null===(t=this._drawWrappers[e].drawContext)||void 0===t||t.reset()}}_addFactorGradient(t,e,i){const s=new r.b3(e,i);t.push(s),this._releaseBuffers()}addSizeGradient(t,e){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,t,e),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this}removeSizeGradient(t){return this._removeGradientAndTexture(t,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this}_refreshFactorGradient(t,e,i=!1){if(!t)return;i&&t.sort(((t,e)=>t.gradient<e.gradient?-1:t.gradient>e.gradient?1:0));const r=this;r[e]&&(r[e].dispose(),r[e]=null)}addAngularSpeedGradient(t,e){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,t,e),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this}removeAngularSpeedGradient(t){return this._removeGradientAndTexture(t,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this}addVelocityGradient(t,e){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,t,e),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this}removeVelocityGradient(t){return this._removeGradientAndTexture(t,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this}addLimitVelocityGradient(t,e){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,t,e),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this}removeLimitVelocityGradient(t){return this._removeGradientAndTexture(t,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this}addDragGradient(t,e){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,t,e),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this}removeDragGradient(t){return this._removeGradientAndTexture(t,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(t){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}constructor(t,e,i,r=null,n=!1){if(super(t),this.layerMask=268435455,this._accumulatedCount=0,this._renderVertexBuffers=[],this._targetIndex=0,this._currentRenderId=-1,this._currentRenderingCameraUniqueId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this.updateInAnimate=!1,this._actualFrame=0,this._rawTextureWidth=256,this.onDisposeObservable=new s.y$,this.onStoppedObservable=new s.y$,this.forceDepthWrite=!1,this._preWarmDone=!1,this.isLocal=!1,this.isGPU=!0,this._onBeforeDrawParticlesObservable=null,i&&"Scene"!==i.getClassName()?(this._engine=i,this.defaultProjectionMatrix=a.y3.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)):(this._scene=i||_.l.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)),this._engine.getCaps().supportComputeShaders){if(!(0,S.q)("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this._platform=new((0,S.q)("BABYLON.ComputeShaderParticleSystem"))(this,this._engine)}else{if(!(0,S.q)("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this._platform=new((0,S.q)("BABYLON.WebGL2ParticleSystem"))(this,this._engine)}this._customWrappers={0:new y.q(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers={0:new y.q(this._engine)},this._drawWrappers[0].drawContext&&(this._drawWrappers[0].drawContext.useInstancing=!0),this._attachImageProcessingConfiguration(null),(e=null!=e?e:{}).randomTextureSize||delete e.randomTextureSize;const o={capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize,...e},h=e;isFinite(h)&&(o.capacity=h),this._capacity=o.capacity,this._activeCount=o.capacity,this._currentActiveCount=0,this._isAnimationSheetEnabled=n,this.particleEmitterType=new l.S;const c=Math.min(this._engine.getCaps().maxTextureSize,o.randomTextureSize);let d=[];for(let t=0;t<c;++t)d.push(Math.random()),d.push(Math.random()),d.push(Math.random()),d.push(Math.random());this._randomTexture=new p.l(new Float32Array(d),c,1,5,i,!1,!1,1,1),this._randomTexture.name="GPUParticleSystem_random1",this._randomTexture.wrapU=1,this._randomTexture.wrapV=1,d=[];for(let t=0;t<c;++t)d.push(Math.random()),d.push(Math.random()),d.push(Math.random()),d.push(Math.random());this._randomTexture2=new p.l(new Float32Array(d),c,1,5,i,!1,!1,1,1),this._randomTexture2.name="GPUParticleSystem_random2",this._randomTexture2.wrapU=1,this._randomTexture2.wrapV=1,this._randomTextureSize=c}_reset(){this._releaseBuffers()}_createVertexBuffers(t,e,i){const r={};r.position=e.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);let s=3;r.age=e.createVertexBuffer("age",s,1,this._attributesStrideSize,!0),s+=1,r.size=e.createVertexBuffer("size",s,3,this._attributesStrideSize,!0),s+=3,r.life=e.createVertexBuffer("life",s,1,this._attributesStrideSize,!0),s+=1,s+=4,this.billboardMode===d.p.BILLBOARDMODE_STRETCHED&&(r.direction=e.createVertexBuffer("direction",s,3,this._attributesStrideSize,!0)),s+=3,this._platform.alignDataInBuffer&&(s+=1),this.particleEmitterType instanceof f.E&&(s+=3,this._platform.alignDataInBuffer&&(s+=1)),this._colorGradientsTexture||(r.color=e.createVertexBuffer("color",s,4,this._attributesStrideSize,!0),s+=4),this._isBillboardBased||(r.initialDirection=e.createVertexBuffer("initialDirection",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),this.noiseTexture&&(r.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1),r.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),r.angle=e.createVertexBuffer("angle",s,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?s++:s+=2,this._isAnimationSheetEnabled&&(r.cellIndex=e.createVertexBuffer("cellIndex",s,1,this._attributesStrideSize,!0),s+=1,this.spriteRandomStartCell&&(r.cellStartOffset=e.createVertexBuffer("cellStartOffset",s,1,this._attributesStrideSize,!0),s+=1)),r.offset=i.createVertexBuffer("offset",0,2),r.uv=i.createVertexBuffer("uv",2,2),this._renderVertexBuffers.push(r),this._platform.createVertexBuffers(t,r),this.resetDrawCache()}_initialize(t=!1){if(this._buffer0&&!t)return;const e=this._engine,i=new Array;this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof f.E&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));const r=this.particleEmitterType instanceof f.E,s=a.jp.Vector3[0];let n=0;for(let t=0;t<this._capacity;t++)if(i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),r?(this.particleEmitterType.particleDestinationGenerator(t,null,s),i.push(s.x),i.push(s.y),i.push(s.z)):(i.push(0),i.push(0),i.push(0)),this._platform.alignDataInBuffer&&i.push(0),n+=16,r&&(this.particleEmitterType.particlePositionGenerator(t,null,s),i.push(s.x),i.push(s.y),i.push(s.z),this._platform.alignDataInBuffer&&i.push(0),n+=4),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0),n+=4),this.isBillboardBased||(i.push(0),i.push(0),i.push(0),this._platform.alignDataInBuffer&&i.push(0),n+=4),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),n+=8),i.push(0),n+=1,this._angularSpeedGradientsTexture||(i.push(0),n+=1),this._isAnimationSheetEnabled&&(i.push(0),n+=1,this.spriteRandomStartCell&&(i.push(0),n+=1)),this._platform.alignDataInBuffer){let t=3-(n+3&3);for(n+=t;t-- >0;)i.push(0)}const o=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),c=this._platform.createParticleBuffer(i),d=this._platform.createParticleBuffer(i);this._buffer0=new h.l(e,c,!1,this._attributesStrideSize),this._buffer1=new h.l(e,d,!1,this._attributesStrideSize),this._spriteBuffer=new h.l(e,o,!1,4),this._renderVertexBuffers=[],this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}_recreateUpdateEffect(){let t=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";return this._isBillboardBased&&(t+="\n#define BILLBOARD"),this._colorGradientsTexture&&(t+="\n#define COLORGRADIENTS"),this._sizeGradientsTexture&&(t+="\n#define SIZEGRADIENTS"),this._angularSpeedGradientsTexture&&(t+="\n#define ANGULARSPEEDGRADIENTS"),this._velocityGradientsTexture&&(t+="\n#define VELOCITYGRADIENTS"),this._limitVelocityGradientsTexture&&(t+="\n#define LIMITVELOCITYGRADIENTS"),this._dragGradientsTexture&&(t+="\n#define DRAGGRADIENTS"),this.isAnimationSheetEnabled&&(t+="\n#define ANIMATESHEET",this.spriteRandomStartCell&&(t+="\n#define ANIMATESHEETRANDOMSTART")),this.noiseTexture&&(t+="\n#define NOISE"),this.isLocal&&(t+="\n#define LOCAL"),!(!this._platform.isUpdateBufferCreated()||this._cachedUpdateDefines!==t)||(this._cachedUpdateDefines=t,this._updateBuffer=this._platform.createUpdateBuffer(t),this._platform.isUpdateBufferReady())}_getWrapper(t){const e=this._getCustomDrawWrapper(t);if(null==e?void 0:e.effect)return e;const i=[];this.fillDefines(i,t);let r=this._drawWrappers[t];r||(r=new y.q(this._engine),r.drawContext&&(r.drawContext.useInstancing=!0),this._drawWrappers[t]=r);const s=i.join("\n");if(r.defines!==s){const t=[],e=[],i=[];this.fillUniformsAttributesAndSamplerNames(e,t,i),r.setEffect(this._engine.createEffect("gpuRenderParticles",t,e,i,s),s)}return r}static _GetAttributeNamesOrOptions(t=!1,e=!1,i=!1,r=!1){const s=[h.o.PositionKind,"age","life","size","angle"];return t||s.push(h.o.ColorKind),e&&s.push("cellIndex"),i||s.push("initialDirection"),r||s.push("direction"),s.push("offset",h.o.UVKind),s}static _GetEffectCreationOptions(t=!1,e=!1){const i=["emitterWM","worldOffset","view","projection","colorDead","invView","translationPivot","eyePosition"];return(0,x.qx)(i),t&&i.push("sheetInfos"),e&&i.push("logarithmicDepthConstant"),i}fillDefines(t,e=0){if(this._scene&&(0,x.AN)(this,this._scene,t),e===d.p.BLENDMODE_MULTIPLY&&t.push("#define BLENDMULTIPLYMODE"),this.isLocal&&t.push("#define LOCAL"),this.useLogarithmicDepth&&t.push("#define LOGARITHMICDEPTH"),this._isBillboardBased)switch(t.push("#define BILLBOARD"),this.billboardMode){case d.p.BILLBOARDMODE_Y:t.push("#define BILLBOARDY");break;case d.p.BILLBOARDMODE_STRETCHED:t.push("#define BILLBOARDSTRETCHED");break;case d.p.BILLBOARDMODE_ALL:t.push("#define BILLBOARDMODE_ALL")}this._colorGradientsTexture&&t.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&t.push("#define ANIMATESHEET"),this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),t.push(""+this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(t,e,i){e.push(...b._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===d.p.BILLBOARDMODE_STRETCHED)),t.push(...b._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth)),i.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(m.$.PrepareUniforms(t,this._imageProcessingConfigurationDefines),m.$.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}animate(t=!1){var e;this._timeDelta=this.updateSpeed*(t?this.preWarmStepOffset:(null===(e=this._scene)||void 0===e?void 0:e.getAnimationRatio())||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop(),this.updateInAnimate&&this._update()}_createFactorGradientTexture(t,e){const i=this[e];if(!t||!t.length||i)return;const s=new Float32Array(this._rawTextureWidth);for(let e=0;e<this._rawTextureWidth;e++){const i=e/this._rawTextureWidth;r.fR.GetCurrentGradient(i,t,((t,i,r)=>{s[e]=o.R.Lerp(t.factor1,i.factor1,r)}))}this[e]=p.l.CreateRTexture(s,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1)}_createSizeGradientTexture(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")}_createAngularSpeedGradientTexture(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")}_createVelocityGradientTexture(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")}_createLimitVelocityGradientTexture(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")}_createDragGradientTexture(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")}_createColorGradientTexture(){if(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)return;const t=new Uint8Array(4*this._rawTextureWidth),e=n.zZ.Color4[0];for(let i=0;i<this._rawTextureWidth;i++){const s=i/this._rawTextureWidth;r.fR.GetCurrentGradient(s,this._colorGradients,((r,s,a)=>{n.HE.LerpToRef(r.color1,s.color1,a,e),t[4*i]=255*e.r,t[4*i+1]=255*e.g,t[4*i+2]=255*e.b,t[4*i+3]=255*e.a}))}this._colorGradientsTexture=p.l.CreateRGBATexture(t,this._rawTextureWidth,1,this._scene,!1,!1,1)}_render(t,e){var i,r;const s=this._getWrapper(t),n=s.effect;this._engine.enableEffect(s);const o=(null===(i=this._scene)||void 0===i?void 0:i.getViewMatrix())||a.y3.IdentityReadOnly;if(n.setMatrix("view",o),n.setMatrix("projection",null!==(r=this.defaultProjectionMatrix)&&void 0!==r?r:this._scene.getProjectionMatrix()),n.setTexture("diffuseSampler",this.particleTexture),n.setVector2("translationPivot",this.translationPivot),n.setVector3("worldOffset",this.worldOffset),this.isLocal&&n.setMatrix("emitterWM",e),this._colorGradientsTexture?n.setTexture("colorGradientSampler",this._colorGradientsTexture):n.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){const t=this.particleTexture.getBaseSize();n.setFloat3("sheetInfos",this.spriteCellWidth/t.width,this.spriteCellHeight/t.height,t.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){const t=this._scene.activeCamera;n.setVector3("eyePosition",t.globalPosition)}const h=n.defines;if(this._scene&&(0,x.an)(n,this,this._scene),h.indexOf("#define BILLBOARDMODE_ALL")>=0){const t=o.clone();t.invert(),n.setMatrix("invView",t)}switch(this.useLogarithmicDepth&&this._scene&&u.G.BindLogDepth(h,n,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(n),t){case d.p.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case d.p.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case d.p.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case d.p.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4)}return this._platform.bindDrawBuffers(this._targetIndex,n),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(n),this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),this._currentActiveCount}_update(t){if(!this.emitter)return;if(!this._recreateUpdateEffect())return;if(this.emitter.position){t=this.emitter.getWorldMatrix()}else{const e=this.emitter;t=a.jp.Matrix[0],a.y3.TranslationToRef(e.x,e.y,e.z,t)}this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this._updateBuffer.setMatrix("emitterWM",t),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount),this._targetIndex++,2===this._targetIndex&&(this._targetIndex=0);const e=this._sourceBuffer;this._sourceBuffer=this._targetBuffer,this._targetBuffer=e}render(t=!1,e=!1){if(!this._started)return 0;if(this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture(),!this.isReady())return 0;if(!t&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(let t=0;t<this.preWarmCycles;t++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getFrameId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getFrameId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){const t=0|this._accumulatedCount;this._accumulatedCount-=t,this._currentActiveCount=Math.min(this._activeCount,this._currentActiveCount+t)}if(!this._currentActiveCount)return 0;let i;if(this.emitter.position){i=this.emitter.getWorldMatrix()}else{const t=this.emitter;i=a.jp.Matrix[0],a.y3.TranslationToRef(t.x,t.y,t.z,i)}const r=this._engine;this.updateInAnimate||this._update(i);let s=0;return t||e||(r.setState(!1),this.forceDepthWrite&&r.setDepthWrite(!0),s=this.blendMode===d.p.BLENDMODE_MULTIPLYADD?this._render(d.p.BLENDMODE_MULTIPLY,i)+this._render(d.p.BLENDMODE_ADD,i):this._render(this.blendMode,i),this._engine.setAlphaMode(0)),s}rebuild(){this._initialize(!0)}_releaseBuffers(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()}dispose(t=!0){for(const t in this._drawWrappers){this._drawWrappers[t].dispose()}if(this._drawWrappers={},this._scene){const t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers();for(let t=0;t<this._renderVertexBuffers.length;++t){const e=this._renderVertexBuffers[t];for(const t in e)e[t].dispose()}this._renderVertexBuffers=[],this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),t&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),t&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(t,e,i=!1){const r={...this._customWrappers};let s=null;const a=this._engine;if(a.createEffectForParticles&&null!=this.customShader){s=this.customShader;const t=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join("\n"):"";r[0]=a.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,t,void 0,void 0,void 0,this)}const n=this.serialize(i),o=b.Parse(n,this._scene||this._engine,this._rootUrl);return o.name=t,o.customShader=s,o._customWrappers=r,void 0===e&&(e=this.emitter),this.noiseTexture&&(o.noiseTexture=this.noiseTexture.clone()),o.emitter=e,o}serialize(t=!1){const e={};return d.p._Serialize(e,this,t),e.activeParticleCount=this.activeParticleCount,e.randomTextureSize=this._randomTextureSize,e.customShader=this.customShader,e}static Parse(t,e,i,r=!1,s){const a=t.name;let n,o;e instanceof g.B?n=e:(o=e,n=o.getEngine());const h=new b(a,{capacity:s||t.capacity,randomTextureSize:t.randomTextureSize},e,null,t.isAnimationSheetEnabled);if(h._rootUrl=i,t.customShader&&n.createEffectForParticles){const e=t.customShader,i=e.shaderOptions.defines.length>0?e.shaderOptions.defines.join("\n"):"",r=n.createEffectForParticles(e.shaderPath.fragmentElement,e.shaderOptions.uniforms,e.shaderOptions.samplers,i,void 0,void 0,void 0,h);h.setCustomEffect(r,0),h.customShader=e}return t.id&&(h.id=t.id),t.activeParticleCount&&(h.activeParticleCount=t.activeParticleCount),d.p._Parse(t,h,e,i),t.preventAutoStart&&(h.preventAutoStart=t.preventAutoStart),r||h.preventAutoStart||h.start(),h}}},1345:(t,e,i)=>{i(25846),i(61761);var r=i(58445),s=i(97052),a=i(38649),n=i(48620);i(19187),i(99763);(0,n.H)("BABYLON.WebGL2ParticleSystem",class{constructor(t,e){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=t,this._engine=e,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}isUpdateBufferCreated(){return!!this._updateEffect}isUpdateBufferReady(){var t,e;return null!==(e=null===(t=this._updateEffect)||void 0===t?void 0:t.isReady())&&void 0!==e&&e}createUpdateBuffer(t){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof s.E&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=t,this._updateEffect=new r.Q("gpuUpdateParticles",this._updateEffectOptions,this._engine),new a.c(this._updateEffect)}createVertexBuffers(t,e){this._updateVAO.push(this._createUpdateVAO(t)),this._renderVAO.push(this._engine.recordVertexArrayObject(e,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null)}createParticleBuffer(t){return t}bindDrawBuffers(t){this._engine.bindVertexArrayObject(this._renderVAO[t],null)}preUpdateParticleBuffer(){const t=this._engine;if(this._engine.enableEffect(this._updateEffect),!t.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(t,e,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[t],null);const r=this._engine;r.bindTransformFeedbackBuffer(e.getBuffer()),r.setRasterizerState(!1),r.beginTransformFeedback(!0),r.drawArraysType(3,0,i),r.endTransformFeedback(),r.setRasterizerState(!0),r.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let t=0;t<this._updateVAO.length;t++)this._engine.releaseVertexArrayObject(this._updateVAO[t]);this._updateVAO.length=0;for(let t=0;t<this._renderVAO.length;t++)this._engine.releaseVertexArrayObject(this._renderVAO[t]);this._renderVAO.length=0}_createUpdateVAO(t){const e={};e.position=t.createVertexBuffer("position",0,3);let i=3;e.age=t.createVertexBuffer("age",i,1),i+=1,e.size=t.createVertexBuffer("size",i,3),i+=3,e.life=t.createVertexBuffer("life",i,1),i+=1,e.seed=t.createVertexBuffer("seed",i,4),i+=4,e.direction=t.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof s.E&&(e.initialPosition=t.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(e.color=t.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(e.initialDirection=t.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(e.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",i,3),i+=3,e.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(e.angle=t.createVertexBuffer("angle",i,1),i+=1):(e.angle=t.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(e.cellIndex=t.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(e.cellStartOffset=t.createVertexBuffer("cellStartOffset",i,1),i+=1));const r=this._engine.recordVertexArrayObject(e,null,this._updateEffect);return this._engine.bindArrayBuffer(null),r}});var o=i(93752),h=i(73821),c=i(83353);i(84577);(0,n.H)("BABYLON.ComputeShaderParticleSystem",class{constructor(t,e){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=t,this._engine=e}isUpdateBufferCreated(){return!!this._updateComputeShader}isUpdateBufferReady(){var t,e;return null!==(e=null===(t=this._updateComputeShader)||void 0===t?void 0:t.isReady())&&void 0!==e&&e}createUpdateBuffer(t){var e;const i={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(i.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(i.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(i.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(i.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(i.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(i.noiseTexture={group:1,binding:11}),this._updateComputeShader=new h.U("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:i,defines:t.split("\n")}),null===(e=this._simParamsComputeShader)||void 0===e||e.dispose(),this._simParamsComputeShader=new c.M(this._engine),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new a.c(this._simParamsComputeShader)}createVertexBuffers(t,e){this._renderVertexBuffers.push(e)}createParticleBuffer(t){const e=new o.N(this._engine,4*t.length,11);return e.update(t),this._bufferComputeShader.push(e),e.getBuffer()}bindDrawBuffers(t,e){this._engine.bindBuffers(this._renderVertexBuffers[t],null,e)}preUpdateParticleBuffer(){}updateParticleBuffer(t,e,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[t]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[1^t]),this._updateComputeShader.dispatch(Math.ceil(i/64))}releaseBuffers(){var t;for(let t=0;t<this._bufferComputeShader.length;++t)this._bufferComputeShader[t].dispose();this._bufferComputeShader.length=0,null===(t=this._simParamsComputeShader)||void 0===t||t.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null}releaseVertexBuffers(){this._renderVertexBuffers.length=0}});var d=i(4392),l=(i(74290),i(13514)),u=i(15631),m=i(73803),p=i(15210),_=i(45715),f=i(22672),g=i(51912);class y{static CreateDefault(t,e=500,i,r=!1){let s;return s=r?new d.h("default system",{capacity:e},i):new f.p("default system",e,i),s.emitter=t,s.particleTexture=new m.x("https://assets.babylonjs.com/textures/flare.png",s.getScene()),s.createConeEmitter(.1,Math.PI/4),s.color1=new u.HE(1,1,1,1),s.color2=new u.HE(1,1,1,1),s.colorDead=new u.HE(1,1,1,0),s.minSize=.1,s.maxSize=.1,s.minEmitPower=2,s.maxEmitPower=2,s.updateSpeed=1/60,s.emitRate=30,s}static CreateAsync(t,e,i=!1,r){e||(e=p.l.LastCreatedScene);const s={};return e.addPendingData(s),new Promise(((a,n)=>{if(i&&!d.h.IsSupported)return e.removePendingData(s),n("Particle system with GPU is not supported.");l.w1.LoadFile(`${y.BaseAssetsUrl}/systems/${t}.json`,(t=>{e.removePendingData(s);const n=JSON.parse(t.toString());return a(_.D.Parse(n,e,i,r))}),void 0,void 0,void 0,(()=>(e.removePendingData(s),n(`An error occurred with the creation of your particle system. Check if your type '${t}' exists.`))))}))}static ExportSet(t){const e=new _.D;for(const i of t)e.systems.push(i);return e}static ParseFromFileAsync(t,e,i,r=!1,s="",a){return new Promise(((n,o)=>{const h=new g.g;h.addEventListener("readystatechange",(()=>{if(4==h.readyState)if(200==h.status){const e=JSON.parse(h.responseText);let o;o=r?d.h.Parse(e,i,s,!1,a):f.p.Parse(e,i,s,!1,a),t&&(o.name=t),n(o)}else o("Unable to load the particle system")})),h.open("GET",e),h.send()}))}static ParseFromSnippetAsync(t,e,i=!1,r="",s){if("_BLANK"===t){const t=this.CreateDefault(null);return t.start(),Promise.resolve(t)}return new Promise(((a,n)=>{const o=new g.g;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const n=JSON.parse(JSON.parse(o.responseText).jsonPayload),h=JSON.parse(n.particleSystem);let c;c=i?d.h.Parse(h,e,r,!1,s):f.p.Parse(h,e,r,!1,s),c.snippetId=t,a(c)}else n("Unable to load the snippet "+t)})),o.open("GET",this.SnippetUrl+"/"+t.replace(/#/g,"/")),o.send()}))}}y.BaseAssetsUrl=_.D.BaseAssetsUrl,y.SnippetUrl="https://snippet.babylonjs.com",y.CreateFromSnippetAsync=y.ParseFromSnippetAsync;var S=i(91243),x=i(57755),b=i(37290),T=i(85627);i(24007);x.p.AddParser(T.l.NAME_PARTICLESYSTEM,((t,e,i,r)=>{const s=x.p.GetIndividualParser(T.l.NAME_PARTICLESYSTEM);if(s&&void 0!==t.particleSystems&&null!==t.particleSystems)for(let a=0,n=t.particleSystems.length;a<n;a++){const n=t.particleSystems[a];i.particleSystems.push(s(n,e,r))}})),x.p.AddIndividualParser(T.l.NAME_PARTICLESYSTEM,((t,e,i)=>{if(t.activeParticleCount){return d.h.Parse(t,e,i)}return f.p.Parse(t,e,i)})),b.D.prototype.createEffectForParticles=function(t,e=[],i=[],r="",s,a,n,o){var h;let c=[],d=[];const l=[];return o?o.fillUniformsAttributesAndSamplerNames(d,c,l):(c=f.p._GetAttributeNamesOrOptions(),d=f.p._GetEffectCreationOptions()),-1===r.indexOf(" BILLBOARD")&&(r+="\n#define BILLBOARD\n"),(null==o?void 0:o.isAnimationSheetEnabled)&&-1===r.indexOf(" ANIMATESHEET")&&(r+="\n#define ANIMATESHEET\n"),-1===i.indexOf("diffuseSampler")&&i.push("diffuseSampler"),this.createEffect({vertex:null!==(h=null==o?void 0:o.vertexShaderName)&&void 0!==h?h:"particles",fragmentElement:t},c,d.concat(e),l.concat(i),r,s,a,n)},S.Kj.prototype.getEmittedParticleSystems=function(){const t=new Array;for(let e=0;e<this.getScene().particleSystems.length;e++){const i=this.getScene().particleSystems[e];i.emitter===this&&t.push(i)}return t},S.Kj.prototype.getHierarchyEmittedParticleSystems=function(){const t=new Array,e=this.getDescendants();e.push(this);for(let i=0;i<this.getScene().particleSystems.length;i++){const r=this.getScene().particleSystems[i],s=r.emitter;s.position&&-1!==e.indexOf(s)&&t.push(r)}return t};i(58095),i(91859),i(14750),i(71419);i(72208),i(89209),i(42620),i(43048),i(68345),i(3085),i(91855);i(92993),i(84552),i(45680)},74290:(t,e,i)=>{i.d(e,{h:()=>n});var r=i(58095),s=i(15631),a=i(72739);class n{constructor(t){this.particleSystem=t,this.position=r.P.Zero(),this.direction=r.P.Zero(),this.color=new s.HE(0,0,0,0),this.colorStep=new s.HE(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new r.FM(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new s.HE(0,0,0,0),this._currentColor2=new s.HE(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=n._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}_updateCellInfoFromSystem(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let t=this.age,e=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(void 0===this._randomCellOffset&&(this._randomCellOffset=Math.random()*this.lifeTime),0===e?(e=1,t=this._randomCellOffset):t+=this._randomCellOffset);const i=this._initialEndSpriteCellID-this._initialStartSpriteCellID;let r;r=this._initialSpriteCellLoop?a.R.Clamp(t*e%this.lifeTime/this.lifeTime):a.R.Clamp(t*e/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+r*i|0}_inheritParticleInfoToSubEmitter(t){if(t.particleSystem.emitter.position){const e=t.particleSystem.emitter;if(e.position.copyFrom(this.position),t.inheritDirection){const t=r.jp.Vector3[0];this.direction.normalizeToRef(t),e.setDirection(t,0,Math.PI/2)}}else{t.particleSystem.emitter.copyFrom(this.position)}this.direction.scaleToRef(t.inheritedVelocityAmount/2,r.jp.Vector3[0]),t.particleSystem._inheritedVelocityOffset.copyFrom(r.jp.Vector3[0])}_inheritParticleInfoToSubEmitters(){this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach((t=>{this._inheritParticleInfoToSubEmitter(t)}))}_reset(){this.age=0,this.id=n._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0}copyTo(t){t.position.copyFrom(this.position),this._initialDirection?t._initialDirection?t._initialDirection.copyFrom(this._initialDirection):t._initialDirection=this._initialDirection.clone():t._initialDirection=null,t.direction.copyFrom(this.direction),this._localPosition&&(t._localPosition?t._localPosition.copyFrom(this._localPosition):t._localPosition=this._localPosition.clone()),t.color.copyFrom(this.color),t.colorStep.copyFrom(this.colorStep),t.lifeTime=this.lifeTime,t.age=this.age,t._randomCellOffset=this._randomCellOffset,t.size=this.size,t.scale.copyFrom(this.scale),t.angle=this.angle,t.angularSpeed=this.angularSpeed,t.particleSystem=this.particleSystem,t.cellIndex=this.cellIndex,t.id=this.id,t._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(t._currentColorGradient=this._currentColorGradient,t._currentColor1.copyFrom(this._currentColor1),t._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(t._currentSizeGradient=this._currentSizeGradient,t._currentSize1=this._currentSize1,t._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(t._currentAngularSpeedGradient=this._currentAngularSpeedGradient,t._currentAngularSpeed1=this._currentAngularSpeed1,t._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(t._currentVelocityGradient=this._currentVelocityGradient,t._currentVelocity1=this._currentVelocity1,t._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(t._currentLimitVelocityGradient=this._currentLimitVelocityGradient,t._currentLimitVelocity1=this._currentLimitVelocity1,t._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(t._currentDragGradient=this._currentDragGradient,t._currentDrag1=this._currentDrag1,t._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this._initialStartSpriteCellID,t._initialEndSpriteCellID=this._initialEndSpriteCellID,t._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(t.remapData&&this.remapData?t.remapData.copyFrom(this.remapData):t.remapData=new r.Lt(0,0,0,0)),this._randomNoiseCoordinates1&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),t._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(t._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),t._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))}}n._Count=0},22672:(t,e,i)=>{i.d(e,{p:()=>T});var r=i(4359),s=i(62897),a=i(58095),n=i(72739),o=i(72208),h=i(90622),c=i(46807),d=i(15210),l=i(61761),u=i(25846),m=i(74290),p=i(45680),_=i(96969),f=i(48620),g=i(67759),y=(i(82943),i(24007),i(15631)),S=i(61159),x=i(90360),b=(i(21352),i(77633));class T extends u.U{set onDispose(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)}get useRampGradients(){return this._useRampGradients}set useRampGradients(t){this._useRampGradients!==t&&(this._useRampGradients=t,this._resetEffect())}get particles(){return this._particles}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(t=0){var e,i;return null!==(i=null===(e=this._customWrappers[t])||void 0===e?void 0:e.effect)&&void 0!==i?i:this._customWrappers[0].effect}_getCustomDrawWrapper(t=0){var e;return null!==(e=this._customWrappers[t])&&void 0!==e?e:this._customWrappers[0]}setCustomEffect(t,e=0){this._customWrappers[e]=new g.q(this._engine),this._customWrappers[e].effect=t,this._customWrappers[e].drawContext&&(this._customWrappers[e].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new s.y$),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(t,e,i,o=null,h=!1,c=.01){super(t),this._emitterInverseWorldMatrix=a.y3.Identity(),this._inheritedVelocityOffset=new a.P,this.onDisposeObservable=new s.y$,this.onStoppedObservable=new s.y$,this._particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new y.HE(0,0,0,0),this._colorDiff=new y.HE(0,0,0,0),this._scaledDirection=a.P.Zero(),this._scaledGravity=a.P.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this.updateInAnimate=!0,this._rawTextureWidth=256,this._useRampGradients=!1,this._disposeEmitterOnDispose=!1,this.isLocal=!1,this.isGPU=!1,this._onBeforeDrawParticlesObservable=null,this.recycleParticle=t=>{const e=this._particles.pop();e!==t&&e.copyTo(t),this._stockParticles.push(e)},this._createParticle=()=>{let t;if(0!==this._stockParticles.length?(t=this._stockParticles.pop(),t._reset()):t=new m.h(this),this._subEmitters&&this._subEmitters.length>0){const e=this._subEmitters[Math.floor(Math.random()*this._subEmitters.length)];t._attachedSubEmitters=[],e.forEach((e=>{if(e.type===p.l.ATTACHED){const i=e.clone();t._attachedSubEmitters.push(i),i.particleSystem.start()}}))}return t},this._emitFromParticle=t=>{if(!this._subEmitters||0===this._subEmitters.length)return;const e=Math.floor(Math.random()*this._subEmitters.length);this._subEmitters[e].forEach((e=>{if(e.type===p.l.END){const i=e.clone();t._inheritParticleInfoToSubEmitter(i),i.particleSystem._rootParticleSystem=this,this.activeSubSystems.push(i.particleSystem),i.particleSystem.start()}}))},this._capacity=e,this._epsilon=c,this._isAnimationSheetEnabled=h,i&&"Scene"!==i.getClassName()?(this._engine=i,this.defaultProjectionMatrix=a.y3.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)):(this._scene=i||d.l.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._attachImageProcessingConfiguration(null),this._customWrappers={0:new g.q(this._engine)},this._customWrappers[0].effect=o,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new l.S3;let u=null;this.updateFunction=t=>{var e;let i=null;this.noiseTexture&&(i=this.noiseTexture.getSize(),null===(e=this.noiseTexture.getContent())||void 0===e||e.then((t=>{u=t})));for(let e=0;e<t.length;e++){const s=t[e];let o=this._scaledUpdateSpeed;const h=s.age;if(s.age+=o,s.age>s.lifeTime){const t=s.age-h;o=(s.lifeTime-h)*o/t,s.age=s.lifeTime}const c=s.age/s.lifeTime;this._colorGradients&&this._colorGradients.length>0?r.fR.GetCurrentGradient(c,this._colorGradients,((t,e,i)=>{t!==s._currentColorGradient&&(s._currentColor1.copyFrom(s._currentColor2),e.getColorToRef(s._currentColor2),s._currentColorGradient=t),y.HE.LerpToRef(s._currentColor1,s._currentColor2,i,s.color)})):(s.colorStep.scaleToRef(o,this._scaledColorStep),s.color.addInPlace(this._scaledColorStep),s.color.a<0&&(s.color.a=0)),this._angularSpeedGradients&&this._angularSpeedGradients.length>0&&r.fR.GetCurrentGradient(c,this._angularSpeedGradients,((t,e,i)=>{t!==s._currentAngularSpeedGradient&&(s._currentAngularSpeed1=s._currentAngularSpeed2,s._currentAngularSpeed2=e.getFactor(),s._currentAngularSpeedGradient=t),s.angularSpeed=n.R.Lerp(s._currentAngularSpeed1,s._currentAngularSpeed2,i)})),s.angle+=s.angularSpeed*o;let d=o;if(this._velocityGradients&&this._velocityGradients.length>0&&r.fR.GetCurrentGradient(c,this._velocityGradients,((t,e,i)=>{t!==s._currentVelocityGradient&&(s._currentVelocity1=s._currentVelocity2,s._currentVelocity2=e.getFactor(),s._currentVelocityGradient=t),d*=n.R.Lerp(s._currentVelocity1,s._currentVelocity2,i)})),s.direction.scaleToRef(d,this._scaledDirection),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&r.fR.GetCurrentGradient(c,this._limitVelocityGradients,((t,e,i)=>{t!==s._currentLimitVelocityGradient&&(s._currentLimitVelocity1=s._currentLimitVelocity2,s._currentLimitVelocity2=e.getFactor(),s._currentLimitVelocityGradient=t);const r=n.R.Lerp(s._currentLimitVelocity1,s._currentLimitVelocity2,i);s.direction.length()>r&&s.direction.scaleInPlace(this.limitVelocityDamping)})),this._dragGradients&&this._dragGradients.length>0&&r.fR.GetCurrentGradient(c,this._dragGradients,((t,e,i)=>{t!==s._currentDragGradient&&(s._currentDrag1=s._currentDrag2,s._currentDrag2=e.getFactor(),s._currentDragGradient=t);const r=n.R.Lerp(s._currentDrag1,s._currentDrag2,i);this._scaledDirection.scaleInPlace(1-r)})),this.isLocal&&s._localPosition?(s._localPosition.addInPlace(this._scaledDirection),a.P.TransformCoordinatesToRef(s._localPosition,this._emitterWorldMatrix,s.position)):s.position.addInPlace(this._scaledDirection),u&&i&&s._randomNoiseCoordinates1){const t=this._fetchR(s._randomNoiseCoordinates1.x,s._randomNoiseCoordinates1.y,i.width,i.height,u),e=this._fetchR(s._randomNoiseCoordinates1.z,s._randomNoiseCoordinates2.x,i.width,i.height,u),r=this._fetchR(s._randomNoiseCoordinates2.y,s._randomNoiseCoordinates2.z,i.width,i.height,u),n=a.jp.Vector3[0],h=a.jp.Vector3[1];n.copyFromFloats((2*t-1)*this.noiseStrength.x,(2*e-1)*this.noiseStrength.y,(2*r-1)*this.noiseStrength.z),n.scaleToRef(o,h),s.direction.addInPlace(h)}this.gravity.scaleToRef(o,this._scaledGravity),s.direction.addInPlace(this._scaledGravity),this._sizeGradients&&this._sizeGradients.length>0&&r.fR.GetCurrentGradient(c,this._sizeGradients,((t,e,i)=>{t!==s._currentSizeGradient&&(s._currentSize1=s._currentSize2,s._currentSize2=e.getFactor(),s._currentSizeGradient=t),s.size=n.R.Lerp(s._currentSize1,s._currentSize2,i)})),this._useRampGradients&&(this._colorRemapGradients&&this._colorRemapGradients.length>0&&r.fR.GetCurrentGradient(c,this._colorRemapGradients,((t,e,i)=>{const r=n.R.Lerp(t.factor1,e.factor1,i),a=n.R.Lerp(t.factor2,e.factor2,i);s.remapData.x=r,s.remapData.y=a-r})),this._alphaRemapGradients&&this._alphaRemapGradients.length>0&&r.fR.GetCurrentGradient(c,this._alphaRemapGradients,((t,e,i)=>{const r=n.R.Lerp(t.factor1,e.factor1,i),a=n.R.Lerp(t.factor2,e.factor2,i);s.remapData.z=r,s.remapData.w=a-r}))),this._isAnimationSheetEnabled&&s.updateCellIndex(),s._inheritParticleInfoToSubEmitters(),s.age>=s.lifeTime&&(this._emitFromParticle(s),s._attachedSubEmitters&&(s._attachedSubEmitters.forEach((t=>{t.particleSystem.disposeOnStop=!0,t.particleSystem.stop()})),s._attachedSubEmitters=null),this.recycleParticle(s),e--)}}}_addFactorGradient(t,e,i,s){const a=new r.b3(e,i,s);t.push(a),t.sort(((t,e)=>t.gradient<e.gradient?-1:t.gradient>e.gradient?1:0))}_removeFactorGradient(t,e){if(!t)return;let i=0;for(const r of t){if(r.gradient===e){t.splice(i,1);break}i++}}addLifeTimeGradient(t,e,i){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,t,e,i),this}removeLifeTimeGradient(t){return this._removeFactorGradient(this._lifeTimeGradients,t),this}addSizeGradient(t,e,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,t,e,i),this}removeSizeGradient(t){return this._removeFactorGradient(this._sizeGradients,t),this}addColorRemapGradient(t,e,i){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,t,e,i),this}removeColorRemapGradient(t){return this._removeFactorGradient(this._colorRemapGradients,t),this}addAlphaRemapGradient(t,e,i){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,t,e,i),this}removeAlphaRemapGradient(t){return this._removeFactorGradient(this._alphaRemapGradients,t),this}addAngularSpeedGradient(t,e,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,t,e,i),this}removeAngularSpeedGradient(t){return this._removeFactorGradient(this._angularSpeedGradients,t),this}addVelocityGradient(t,e,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,t,e,i),this}removeVelocityGradient(t){return this._removeFactorGradient(this._velocityGradients,t),this}addLimitVelocityGradient(t,e,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,t,e,i),this}removeLimitVelocityGradient(t){return this._removeFactorGradient(this._limitVelocityGradients,t),this}addDragGradient(t,e,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,t,e,i),this}removeDragGradient(t){return this._removeFactorGradient(this._dragGradients,t),this}addEmitRateGradient(t,e,i){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,t,e,i),this}removeEmitRateGradient(t){return this._removeFactorGradient(this._emitRateGradients,t),this}addStartSizeGradient(t,e,i){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,t,e,i),this}removeStartSizeGradient(t){return this._removeFactorGradient(this._startSizeGradients,t),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;const t=new Uint8Array(4*this._rawTextureWidth),e=y.zZ.Color3[0];for(let i=0;i<this._rawTextureWidth;i++){const s=i/this._rawTextureWidth;r.fR.GetCurrentGradient(s,this._rampGradients,((r,s,a)=>{y.Wo.LerpToRef(r.color,s.color,a,e),t[4*i]=255*e.r,t[4*i+1]=255*e.g,t[4*i+2]=255*e.b,t[4*i+3]=255}))}this._rampGradientsTexture=c.l.CreateRGBATexture(t,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){this._rampGradients&&(this._rampGradients.sort(((t,e)=>t.gradient<e.gradient?-1:t.gradient>e.gradient?1:0)),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(t,e){this._rampGradients||(this._rampGradients=[]);const i=new r.cw(t,e);return this._rampGradients.push(i),this._syncRampGradientTexture(),this}removeRampGradient(t){return this._removeGradientAndTexture(t,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(t,e,i){this._colorGradients||(this._colorGradients=[]);const s=new r.bK(t,e,i);return this._colorGradients.push(s),this._colorGradients.sort(((t,e)=>t.gradient<e.gradient?-1:t.gradient>e.gradient?1:0)),this}removeColorGradient(t){if(!this._colorGradients)return this;let e=0;for(const i of this._colorGradients){if(i.gradient===t){this._colorGradients.splice(e,1);break}e++}return this}resetDrawCache(){for(const t of this._drawWrappers)if(t)for(const e of t)null==e||e.dispose();this._drawWrappers=[]}_fetchR(t,e,i,r,s){return s[4*(((t=.5*Math.abs(t)+.5)*i%i|0)+((e=.5*Math.abs(e)+.5)*r%r|0)*i)]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),this._isBillboardBased&&this.billboardMode!==T.BILLBOARDMODE_STRETCHED&&this.billboardMode!==T.BILLBOARDMODE_STRETCHED_LOCAL||(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);const t=this._engine,e=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*e),this._vertexBuffer=new o.l(t,this._vertexData,!0,e);let i=0;const r=this._vertexBuffer.createVertexBuffer(o.o.PositionKind,i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[o.o.PositionKind]=r,i+=3;const s=this._vertexBuffer.createVertexBuffer(o.o.ColorKind,i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[o.o.ColorKind]=s,i+=4;const a=this._vertexBuffer.createVertexBuffer("angle",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=a,i+=1;const n=this._vertexBuffer.createVertexBuffer("size",i,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=n,i+=2,this._isAnimationSheetEnabled){const t=this._vertexBuffer.createVertexBuffer("cellIndex",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=t,i+=1}if(!this._isBillboardBased||this.billboardMode===T.BILLBOARDMODE_STRETCHED||this.billboardMode===T.BILLBOARDMODE_STRETCHED_LOCAL){const t=this._vertexBuffer.createVertexBuffer("direction",i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=t,i+=3}if(this._useRampGradients){const t=this._vertexBuffer.createVertexBuffer("remapData",i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=t,i+=4}let h;if(this._useInstancing){const e=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new o.l(t,e,!1,2),h=this._spriteBuffer.createVertexBuffer("offset",0,2)}else h=this._vertexBuffer.createVertexBuffer("offset",i,2,this._vertexBufferSize,this._useInstancing),i+=2;this._vertexBuffers.offset=h,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing)return;const t=[];let e=0;for(let i=0;i<this._capacity;i++)t.push(e),t.push(e+1),t.push(e+2),t.push(e),t.push(e+2),t.push(e+3),e+=4;this._indexBuffer=this._engine.createIndexBuffer(t)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_prepareSubEmitterInternalArray(){this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach((t=>{t instanceof T?this._subEmitters.push([new p.H(t)]):t instanceof p.H?this._subEmitters.push([t]):t instanceof Array&&this._subEmitters.push(t)}))}start(t=this.startDelay){var e;if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(t)setTimeout((()=>{this.start(0)}),t);else{if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&0!=this._subEmitters.length&&(this.activeSubSystems=new Array),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){-1!==(null===(e=this.emitter)||void 0===e?void 0:e.getClassName().indexOf("Mesh"))&&this.emitter.computeWorldMatrix(!0);const t=this.noiseTexture;if(t&&t.onGeneratedObservable)t.onGeneratedObservable.addOnce((()=>{setTimeout((()=>{for(let e=0;e<this.preWarmCycles;e++)this.animate(!0),t.render()}))}));else for(let t=0;t<this.preWarmCycles;t++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}}stop(t=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,t&&this._stopSubEmitters())}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(t,e,i,r){let s=t*this._vertexBufferSize;if(this._vertexData[s++]=e.position.x+this.worldOffset.x,this._vertexData[s++]=e.position.y+this.worldOffset.y,this._vertexData[s++]=e.position.z+this.worldOffset.z,this._vertexData[s++]=e.color.r,this._vertexData[s++]=e.color.g,this._vertexData[s++]=e.color.b,this._vertexData[s++]=e.color.a,this._vertexData[s++]=e.angle,this._vertexData[s++]=e.scale.x*e.size,this._vertexData[s++]=e.scale.y*e.size,this._isAnimationSheetEnabled&&(this._vertexData[s++]=e.cellIndex),this._isBillboardBased)this.billboardMode!==T.BILLBOARDMODE_STRETCHED&&this.billboardMode!==T.BILLBOARDMODE_STRETCHED_LOCAL||(this._vertexData[s++]=e.direction.x,this._vertexData[s++]=e.direction.y,this._vertexData[s++]=e.direction.z);else if(e._initialDirection){let t=e._initialDirection;this.isLocal&&(a.P.TransformNormalToRef(t,this._emitterWorldMatrix,a.jp.Vector3[0]),t=a.jp.Vector3[0]),0===t.x&&0===t.z&&(t.x=.001),this._vertexData[s++]=t.x,this._vertexData[s++]=t.y,this._vertexData[s++]=t.z}else{let t=e.direction;this.isLocal&&(a.P.TransformNormalToRef(t,this._emitterWorldMatrix,a.jp.Vector3[0]),t=a.jp.Vector3[0]),0===t.x&&0===t.z&&(t.x=.001),this._vertexData[s++]=t.x,this._vertexData[s++]=t.y,this._vertexData[s++]=t.z}this._useRampGradients&&e.remapData&&(this._vertexData[s++]=e.remapData.x,this._vertexData[s++]=e.remapData.y,this._vertexData[s++]=e.remapData.z,this._vertexData[s++]=e.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),0===r?r=this._epsilon:1===r&&(r=1-this._epsilon)),this._vertexData[s++]=i,this._vertexData[s++]=r)}_stopSubEmitters(){this.activeSubSystems&&(this.activeSubSystems.forEach((t=>{t.stop(!0)})),this.activeSubSystems=new Array)}_removeFromRoot(){if(!this._rootParticleSystem)return;const t=this._rootParticleSystem.activeSubSystems.indexOf(this);-1!==t&&this._rootParticleSystem.activeSubSystems.splice(t,1),this._rootParticleSystem=null}_update(t){if(this._alive=this._particles.length>0,this.emitter.position){const t=this.emitter;this._emitterWorldMatrix=t.getWorldMatrix()}else{const t=this.emitter;this._emitterWorldMatrix=a.y3.Translation(t.x,t.y,t.z)}let e;this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);for(let i=0;i<t&&this._particles.length!==this._capacity;i++){if(e=this._createParticle(),this._particles.push(e),this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){const t=n.R.Clamp(this._actualFrame/this.targetStopDuration);r.fR.GetCurrentGradient(t,this._lifeTimeGradients,((i,r)=>{const s=i,a=r,o=s.getFactor(),h=a.getFactor(),c=(t-s.gradient)/(a.gradient-s.gradient);e.lifeTime=n.R.Lerp(o,h,c)}))}else e.lifeTime=n.R.RandomRange(this.minLifeTime,this.maxLifeTime);const t=n.R.RandomRange(this.minEmitPower,this.maxEmitPower);if(this.startPositionFunction?this.startPositionFunction(this._emitterWorldMatrix,e.position,e,this.isLocal):this.particleEmitterType.startPositionFunction(this._emitterWorldMatrix,e.position,e,this.isLocal),this.isLocal&&(e._localPosition?e._localPosition.copyFrom(e.position):e._localPosition=e.position.clone(),a.P.TransformCoordinatesToRef(e._localPosition,this._emitterWorldMatrix,e.position)),this.startDirectionFunction?this.startDirectionFunction(this._emitterWorldMatrix,e.direction,e,this.isLocal):this.particleEmitterType.startDirectionFunction(this._emitterWorldMatrix,e.direction,e,this.isLocal,this._emitterInverseWorldMatrix),0===t?e._initialDirection?e._initialDirection.copyFrom(e.direction):e._initialDirection=e.direction.clone():e._initialDirection=null,e.direction.scaleInPlace(t),this._sizeGradients&&0!==this._sizeGradients.length?(e._currentSizeGradient=this._sizeGradients[0],e._currentSize1=e._currentSizeGradient.getFactor(),e.size=e._currentSize1,this._sizeGradients.length>1?e._currentSize2=this._sizeGradients[1].getFactor():e._currentSize2=e._currentSize1):e.size=n.R.RandomRange(this.minSize,this.maxSize),e.scale.copyFromFloats(n.R.RandomRange(this.minScaleX,this.maxScaleX),n.R.RandomRange(this.minScaleY,this.maxScaleY)),this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration){const t=this._actualFrame/this.targetStopDuration;r.fR.GetCurrentGradient(t,this._startSizeGradients,((t,i,r)=>{t!==this._currentStartSizeGradient&&(this._currentStartSize1=this._currentStartSize2,this._currentStartSize2=i.getFactor(),this._currentStartSizeGradient=t);const s=n.R.Lerp(this._currentStartSize1,this._currentStartSize2,r);e.scale.scaleInPlace(s)}))}if(this._angularSpeedGradients&&0!==this._angularSpeedGradients.length?(e._currentAngularSpeedGradient=this._angularSpeedGradients[0],e.angularSpeed=e._currentAngularSpeedGradient.getFactor(),e._currentAngularSpeed1=e.angularSpeed,this._angularSpeedGradients.length>1?e._currentAngularSpeed2=this._angularSpeedGradients[1].getFactor():e._currentAngularSpeed2=e._currentAngularSpeed1):e.angularSpeed=n.R.RandomRange(this.minAngularSpeed,this.maxAngularSpeed),e.angle=n.R.RandomRange(this.minInitialRotation,this.maxInitialRotation),this._velocityGradients&&this._velocityGradients.length>0&&(e._currentVelocityGradient=this._velocityGradients[0],e._currentVelocity1=e._currentVelocityGradient.getFactor(),this._velocityGradients.length>1?e._currentVelocity2=this._velocityGradients[1].getFactor():e._currentVelocity2=e._currentVelocity1),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&(e._currentLimitVelocityGradient=this._limitVelocityGradients[0],e._currentLimitVelocity1=e._currentLimitVelocityGradient.getFactor(),this._limitVelocityGradients.length>1?e._currentLimitVelocity2=this._limitVelocityGradients[1].getFactor():e._currentLimitVelocity2=e._currentLimitVelocity1),this._dragGradients&&this._dragGradients.length>0&&(e._currentDragGradient=this._dragGradients[0],e._currentDrag1=e._currentDragGradient.getFactor(),this._dragGradients.length>1?e._currentDrag2=this._dragGradients[1].getFactor():e._currentDrag2=e._currentDrag1),this._colorGradients&&0!==this._colorGradients.length)e._currentColorGradient=this._colorGradients[0],e._currentColorGradient.getColorToRef(e.color),e._currentColor1.copyFrom(e.color),this._colorGradients.length>1?this._colorGradients[1].getColorToRef(e._currentColor2):e._currentColor2.copyFrom(e.color);else{const t=n.R.RandomRange(0,1);y.HE.LerpToRef(this.color1,this.color2,t,e.color),this.colorDead.subtractToRef(e.color,this._colorDiff),this._colorDiff.scaleToRef(1/e.lifeTime,e.colorStep)}this._isAnimationSheetEnabled&&(e._initialStartSpriteCellID=this.startSpriteCellID,e._initialEndSpriteCellID=this.endSpriteCellID,e._initialSpriteCellLoop=this.spriteCellLoop),e.direction.addInPlace(this._inheritedVelocityOffset),this._useRampGradients&&(e.remapData=new a.Lt(0,1,0,1)),this.noiseTexture&&(e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),e._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(e._randomNoiseCoordinates1=new a.P(Math.random(),Math.random(),Math.random()),e._randomNoiseCoordinates2=new a.P(Math.random(),Math.random(),Math.random()))),e._inheritParticleInfoToSubEmitters()}}static _GetAttributeNamesOrOptions(t=!1,e=!1,i=!1){const r=[o.o.PositionKind,o.o.ColorKind,"angle","offset","size"];return t&&r.push("cellIndex"),e||r.push("direction"),i&&r.push("remapData"),r}static _GetEffectCreationOptions(t=!1,e=!1){const i=["invView","view","projection","textureMask","translationPivot","eyePosition"];return(0,b.qx)(i),t&&i.push("particlesInfos"),e&&i.push("logarithmicDepthConstant"),i}fillDefines(t,e){if(this._scene&&(0,b.AN)(this,this._scene,t),this._isAnimationSheetEnabled&&t.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&t.push("#define LOGARITHMICDEPTH"),e===T.BLENDMODE_MULTIPLY&&t.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&t.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(t.push("#define BILLBOARD"),this.billboardMode){case T.BILLBOARDMODE_Y:t.push("#define BILLBOARDY");break;case T.BILLBOARDMODE_STRETCHED:case T.BILLBOARDMODE_STRETCHED_LOCAL:t.push("#define BILLBOARDSTRETCHED"),this.billboardMode===T.BILLBOARDMODE_STRETCHED_LOCAL&&t.push("#define BILLBOARDSTRETCHED_LOCAL");break;case T.BILLBOARDMODE_ALL:t.push("#define BILLBOARDMODE_ALL")}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),t.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(t,e,i){e.push(...T._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==T.BILLBOARDMODE_STRETCHED&&this.billboardMode!==T.BILLBOARDMODE_STRETCHED_LOCAL,this._useRampGradients)),t.push(...T._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth)),i.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(h.$.PrepareUniforms(t,this._imageProcessingConfigurationDefines),h.$.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}_getWrapper(t){const e=this._getCustomDrawWrapper(t);if(null==e?void 0:e.effect)return e;const i=[];this.fillDefines(i,t);const r=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0;let s=this._drawWrappers[r];s||(s=this._drawWrappers[r]=[]);let a=s[t];a||(a=new g.q(this._engine),a.drawContext&&(a.drawContext.useInstancing=this._useInstancing),s[t]=a);const n=i.join("\n");if(a.defines!==n){const t=[],e=[],i=[];this.fillUniformsAttributesAndSamplerNames(e,t,i),a.setEffect(this._engine.createEffect("particles",t,e,i,n),n)}return a}animate(t=!1){var e;if(!this._started)return;if(!t&&this._scene){if(!this.isReady())return;if(this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}let i;if(this._scaledUpdateSpeed=this.updateSpeed*(t?this.preWarmStepOffset:(null===(e=this._scene)||void 0===e?void 0:e.getAnimationRatio())||1),this.manualEmitCount>-1)i=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let t=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){const e=this._actualFrame/this.targetStopDuration;r.fR.GetCurrentGradient(e,this._emitRateGradients,((e,i,r)=>{e!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=i.getFactor(),this._currentEmitRateGradient=e),t=n.R.Lerp(this._currentEmitRate1,this._currentEmitRate2,r)}))}i=t*this._scaledUpdateSpeed>>0,this._newPartsExcess+=t*this._scaledUpdateSpeed-i}if(this._newPartsExcess>1&&(i+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?i=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(i),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!t){let t=0;for(let e=0;e<this._particles.length;e++){const i=this._particles[e];this._appendParticleVertices(t,i),t+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}0===this.manualEmitCount&&this.disposeOnStop&&this.stop()}_appendParticleVertices(t,e){this._appendParticleVertex(t++,e,0,0),this._useInstancing||(this._appendParticleVertex(t++,e,1,0),this._appendParticleVertex(t++,e,1,1),this._appendParticleVertex(t++,e,0,1))}rebuild(){var t,e;this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),null===(t=this._spriteBuffer)||void 0===t||t._rebuild(),null===(e=this._vertexBuffer)||void 0===e||e._rebuild();for(const t in this._vertexBuffers)this._vertexBuffers[t]._rebuild();this.resetDrawCache()}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==T.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else{if(!this._getWrapper(T.BLENDMODE_MULTIPLY).effect.isReady())return!1;if(!this._getWrapper(T.BLENDMODE_ADD).effect.isReady())return!1}return!0}_render(t){var e,i;const r=this._getWrapper(t),s=r.effect,n=this._engine;n.enableEffect(r);const o=null!==(e=this.defaultViewMatrix)&&void 0!==e?e:this._scene.getViewMatrix();if(s.setTexture("diffuseSampler",this.particleTexture),s.setMatrix("view",o),s.setMatrix("projection",null!==(i=this.defaultProjectionMatrix)&&void 0!==i?i:this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){const t=this.particleTexture.getBaseSize();s.setFloat3("particlesInfos",this.spriteCellWidth/t.width,this.spriteCellHeight/t.height,this.spriteCellWidth/t.width)}if(s.setVector2("translationPivot",this.translationPivot),s.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){const t=this._scene.activeCamera;s.setVector3("eyePosition",t.globalPosition)}this._rampGradientsTexture&&(this._rampGradients&&this._rampGradients.length||(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),s.setTexture("rampSampler",this._rampGradientsTexture));const h=s.defines;switch(this._scene&&(0,b.an)(s,this,this._scene),h.indexOf("#define BILLBOARDMODE_ALL")>=0&&(o.invertToRef(a.jp.Matrix[0]),s.setMatrix("invView",a.jp.Matrix[0])),void 0!==this._vertexArrayObject?(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,s)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):n.bindBuffers(this._vertexBuffers,this._indexBuffer,s),this.useLogarithmicDepth&&this._scene&&x.G.BindLogDepth(h,s,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(s),t){case T.BLENDMODE_ADD:n.setAlphaMode(1);break;case T.BLENDMODE_ONEONE:n.setAlphaMode(6);break;case T.BLENDMODE_STANDARD:n.setAlphaMode(2);break;case T.BLENDMODE_MULTIPLY:n.setAlphaMode(4)}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(s),this._useInstancing?n.drawArraysType(7,0,4,this._particles.length):n.drawElementsType(0,0,6*this._particles.length),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;const t=this._engine;t.setState&&(t.setState(!1),this.forceDepthWrite&&t.setDepthWrite(!0));let e=0;return e=this.blendMode===T.BLENDMODE_MULTIPLYADD?this._render(T.BLENDMODE_MULTIPLY)+this._render(T.BLENDMODE_ADD):this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),e}dispose(t=!0){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),t&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),t&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length){for(let t=0;t<this._subEmitters.length;t++)for(const e of this._subEmitters[t])e.dispose();this._subEmitters=[],this.subEmitters=[]}if(this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){const t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()}clone(t,e,i=!1){const r={...this._customWrappers};let s=null;const a=this._engine;if(a.createEffectForParticles&&null!=this.customShader){s=this.customShader;const t=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join("\n"):"",e=a.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,t);r[0]?r[0].effect=e:this.setCustomEffect(e,0)}const n=this.serialize(i),o=T.Parse(n,this._scene||this._engine,this._rootUrl);return o.name=t,o.customShader=s,o._customWrappers=r,void 0===e&&(e=this.emitter),this.noiseTexture&&(o.noiseTexture=this.noiseTexture.clone()),o.emitter=e,this.preventAutoStart||o.start(),o}serialize(t=!1){const e={};if(T._Serialize(e,this,t),e.textureMask=this.textureMask.asArray(),e.customShader=this.customShader,e.preventAutoStart=this.preventAutoStart,this.subEmitters){e.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(const i of this._subEmitters){const r=[];for(const e of i)r.push(e.serialize(t));e.subEmitters.push(r)}}return e}static _Serialize(t,e,i){if(t.name=e.name,t.id=e.id,t.capacity=e.getCapacity(),t.disposeOnStop=e.disposeOnStop,t.manualEmitCount=e.manualEmitCount,e.emitter.position){const i=e.emitter;t.emitterId=i.id}else{const i=e.emitter;t.emitter=i.asArray()}e.particleEmitterType&&(t.particleEmitterType=e.particleEmitterType.serialize()),e.particleTexture&&(i?t.texture=e.particleTexture.serialize():(t.textureName=e.particleTexture.name,t.invertY=!!e.particleTexture._invertY)),t.isLocal=e.isLocal,_.p4.AppendSerializedAnimations(e,t),t.beginAnimationOnStart=e.beginAnimationOnStart,t.beginAnimationFrom=e.beginAnimationFrom,t.beginAnimationTo=e.beginAnimationTo,t.beginAnimationLoop=e.beginAnimationLoop,t.startDelay=e.startDelay,t.renderingGroupId=e.renderingGroupId,t.isBillboardBased=e.isBillboardBased,t.billboardMode=e.billboardMode,t.minAngularSpeed=e.minAngularSpeed,t.maxAngularSpeed=e.maxAngularSpeed,t.minSize=e.minSize,t.maxSize=e.maxSize,t.minScaleX=e.minScaleX,t.maxScaleX=e.maxScaleX,t.minScaleY=e.minScaleY,t.maxScaleY=e.maxScaleY,t.minEmitPower=e.minEmitPower,t.maxEmitPower=e.maxEmitPower,t.minLifeTime=e.minLifeTime,t.maxLifeTime=e.maxLifeTime,t.emitRate=e.emitRate,t.gravity=e.gravity.asArray(),t.noiseStrength=e.noiseStrength.asArray(),t.color1=e.color1.asArray(),t.color2=e.color2.asArray(),t.colorDead=e.colorDead.asArray(),t.updateSpeed=e.updateSpeed,t.targetStopDuration=e.targetStopDuration,t.blendMode=e.blendMode,t.preWarmCycles=e.preWarmCycles,t.preWarmStepOffset=e.preWarmStepOffset,t.minInitialRotation=e.minInitialRotation,t.maxInitialRotation=e.maxInitialRotation,t.startSpriteCellID=e.startSpriteCellID,t.spriteCellLoop=e.spriteCellLoop,t.endSpriteCellID=e.endSpriteCellID,t.spriteCellChangeSpeed=e.spriteCellChangeSpeed,t.spriteCellWidth=e.spriteCellWidth,t.spriteCellHeight=e.spriteCellHeight,t.spriteRandomStartCell=e.spriteRandomStartCell,t.isAnimationSheetEnabled=e.isAnimationSheetEnabled,t.useLogarithmicDepth=e.useLogarithmicDepth;const r=e.getColorGradients();if(r){t.colorGradients=[];for(const e of r){const i={gradient:e.gradient,color1:e.color1.asArray()};e.color2?i.color2=e.color2.asArray():i.color2=e.color1.asArray(),t.colorGradients.push(i)}}const s=e.getRampGradients();if(s){t.rampGradients=[];for(const e of s){const i={gradient:e.gradient,color:e.color.asArray()};t.rampGradients.push(i)}t.useRampGradients=e.useRampGradients}const a=e.getColorRemapGradients();if(a){t.colorRemapGradients=[];for(const e of a){const i={gradient:e.gradient,factor1:e.factor1};void 0!==e.factor2?i.factor2=e.factor2:i.factor2=e.factor1,t.colorRemapGradients.push(i)}}const n=e.getAlphaRemapGradients();if(n){t.alphaRemapGradients=[];for(const e of n){const i={gradient:e.gradient,factor1:e.factor1};void 0!==e.factor2?i.factor2=e.factor2:i.factor2=e.factor1,t.alphaRemapGradients.push(i)}}const o=e.getSizeGradients();if(o){t.sizeGradients=[];for(const e of o){const i={gradient:e.gradient,factor1:e.factor1};void 0!==e.factor2?i.factor2=e.factor2:i.factor2=e.factor1,t.sizeGradients.push(i)}}const h=e.getAngularSpeedGradients();if(h){t.angularSpeedGradients=[];for(const e of h){const i={gradient:e.gradient,factor1:e.factor1};void 0!==e.factor2?i.factor2=e.factor2:i.factor2=e.factor1,t.angularSpeedGradients.push(i)}}const c=e.getVelocityGradients();if(c){t.velocityGradients=[];for(const e of c){const i={gradient:e.gradient,factor1:e.factor1};void 0!==e.factor2?i.factor2=e.factor2:i.factor2=e.factor1,t.velocityGradients.push(i)}}const d=e.getDragGradients();if(d){t.dragGradients=[];for(const e of d){const i={gradient:e.gradient,factor1:e.factor1};void 0!==e.factor2?i.factor2=e.factor2:i.factor2=e.factor1,t.dragGradients.push(i)}}const l=e.getEmitRateGradients();if(l){t.emitRateGradients=[];for(const e of l){const i={gradient:e.gradient,factor1:e.factor1};void 0!==e.factor2?i.factor2=e.factor2:i.factor2=e.factor1,t.emitRateGradients.push(i)}}const u=e.getStartSizeGradients();if(u){t.startSizeGradients=[];for(const e of u){const i={gradient:e.gradient,factor1:e.factor1};void 0!==e.factor2?i.factor2=e.factor2:i.factor2=e.factor1,t.startSizeGradients.push(i)}}const m=e.getLifeTimeGradients();if(m){t.lifeTimeGradients=[];for(const e of m){const i={gradient:e.gradient,factor1:e.factor1};void 0!==e.factor2?i.factor2=e.factor2:i.factor2=e.factor1,t.lifeTimeGradients.push(i)}}const p=e.getLimitVelocityGradients();if(p){t.limitVelocityGradients=[];for(const e of p){const i={gradient:e.gradient,factor1:e.factor1};void 0!==e.factor2?i.factor2=e.factor2:i.factor2=e.factor1,t.limitVelocityGradients.push(i)}t.limitVelocityDamping=e.limitVelocityDamping}e.noiseTexture&&(t.noiseTexture=e.noiseTexture.serialize())}static _Parse(t,e,i,r){var s,n,o;let h;h=i instanceof S.B?null:i;const c=(0,f.q)("BABYLON.Texture");if(c&&h&&(t.texture?e.particleTexture=c.Parse(t.texture,h,r):t.textureName&&(e.particleTexture=new c(r+t.textureName,h,!1,void 0===t.invertY||t.invertY),e.particleTexture.name=t.textureName)),t.emitterId||0===t.emitterId||void 0!==t.emitter?t.emitterId&&h?e.emitter=h.getLastMeshById(t.emitterId):e.emitter=a.P.FromArray(t.emitter):e.emitter=a.P.Zero(),e.isLocal=!!t.isLocal,void 0!==t.renderingGroupId&&(e.renderingGroupId=t.renderingGroupId),void 0!==t.isBillboardBased&&(e.isBillboardBased=t.isBillboardBased),void 0!==t.billboardMode&&(e.billboardMode=t.billboardMode),void 0!==t.useLogarithmicDepth&&(e.useLogarithmicDepth=t.useLogarithmicDepth),t.animations){for(let i=0;i<t.animations.length;i++){const r=t.animations[i],s=(0,f.q)("BABYLON.Animation");s&&e.animations.push(s.Parse(r))}e.beginAnimationOnStart=t.beginAnimationOnStart,e.beginAnimationFrom=t.beginAnimationFrom,e.beginAnimationTo=t.beginAnimationTo,e.beginAnimationLoop=t.beginAnimationLoop}if(t.autoAnimate&&h&&h.beginAnimation(e,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),e.startDelay=0|t.startDelay,e.minAngularSpeed=t.minAngularSpeed,e.maxAngularSpeed=t.maxAngularSpeed,e.minSize=t.minSize,e.maxSize=t.maxSize,t.minScaleX&&(e.minScaleX=t.minScaleX,e.maxScaleX=t.maxScaleX,e.minScaleY=t.minScaleY,e.maxScaleY=t.maxScaleY),void 0!==t.preWarmCycles&&(e.preWarmCycles=t.preWarmCycles,e.preWarmStepOffset=t.preWarmStepOffset),void 0!==t.minInitialRotation&&(e.minInitialRotation=t.minInitialRotation,e.maxInitialRotation=t.maxInitialRotation),e.minLifeTime=t.minLifeTime,e.maxLifeTime=t.maxLifeTime,e.minEmitPower=t.minEmitPower,e.maxEmitPower=t.maxEmitPower,e.emitRate=t.emitRate,e.gravity=a.P.FromArray(t.gravity),t.noiseStrength&&(e.noiseStrength=a.P.FromArray(t.noiseStrength)),e.color1=y.HE.FromArray(t.color1),e.color2=y.HE.FromArray(t.color2),e.colorDead=y.HE.FromArray(t.colorDead),e.updateSpeed=t.updateSpeed,e.targetStopDuration=t.targetStopDuration,e.blendMode=t.blendMode,t.colorGradients)for(const i of t.colorGradients)e.addColorGradient(i.gradient,y.HE.FromArray(i.color1),i.color2?y.HE.FromArray(i.color2):void 0);if(t.rampGradients){for(const i of t.rampGradients)e.addRampGradient(i.gradient,y.Wo.FromArray(i.color));e.useRampGradients=t.useRampGradients}if(t.colorRemapGradients)for(const i of t.colorRemapGradients)e.addColorRemapGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(t.alphaRemapGradients)for(const i of t.alphaRemapGradients)e.addAlphaRemapGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(t.sizeGradients)for(const i of t.sizeGradients)e.addSizeGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(t.angularSpeedGradients)for(const i of t.angularSpeedGradients)e.addAngularSpeedGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(t.velocityGradients)for(const i of t.velocityGradients)e.addVelocityGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(t.dragGradients)for(const i of t.dragGradients)e.addDragGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(t.emitRateGradients)for(const i of t.emitRateGradients)e.addEmitRateGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(t.startSizeGradients)for(const i of t.startSizeGradients)e.addStartSizeGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(t.lifeTimeGradients)for(const i of t.lifeTimeGradients)e.addLifeTimeGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(t.limitVelocityGradients){for(const i of t.limitVelocityGradients)e.addLimitVelocityGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);e.limitVelocityDamping=t.limitVelocityDamping}if(t.noiseTexture&&h){const i=(0,f.q)("BABYLON.ProceduralTexture");e.noiseTexture=i.Parse(t.noiseTexture,h,r)}let d;if(t.particleEmitterType){switch(t.particleEmitterType.type){case"SphereParticleEmitter":d=new l.Ai;break;case"SphereDirectedParticleEmitter":d=new l.cE;break;case"ConeEmitter":case"ConeParticleEmitter":d=new l.LV;break;case"CylinderParticleEmitter":d=new l.kT;break;case"CylinderDirectedParticleEmitter":d=new l.z;break;case"HemisphericParticleEmitter":d=new l.VD;break;case"PointParticleEmitter":d=new l.cl;break;case"MeshParticleEmitter":d=new l.F3;break;default:d=new l.S3}d.parse(t.particleEmitterType,h)}else d=new l.S3,d.parse(t,h);e.particleEmitterType=d,e.startSpriteCellID=t.startSpriteCellID,e.endSpriteCellID=t.endSpriteCellID,e.spriteCellLoop=null===(s=t.spriteCellLoop)||void 0===s||s,e.spriteCellWidth=t.spriteCellWidth,e.spriteCellHeight=t.spriteCellHeight,e.spriteCellChangeSpeed=t.spriteCellChangeSpeed,e.spriteRandomStartCell=t.spriteRandomStartCell,e.disposeOnStop=null!==(n=t.disposeOnStop)&&void 0!==n&&n,e.manualEmitCount=null!==(o=t.manualEmitCount)&&void 0!==o?o:-1}static Parse(t,e,i,r=!1,s){const a=t.name;let n,o,h=null,c=null;if(e instanceof S.B?n=e:(o=e,n=o.getEngine()),t.customShader&&n.createEffectForParticles){c=t.customShader;const e=c.shaderOptions.defines.length>0?c.shaderOptions.defines.join("\n"):"";h=n.createEffectForParticles(c.shaderPath.fragmentElement,c.shaderOptions.uniforms,c.shaderOptions.samplers,e)}const d=new T(a,s||t.capacity,e,h,t.isAnimationSheetEnabled);if(d.customShader=c,d._rootUrl=i,t.id&&(d.id=t.id),t.subEmitters){d.subEmitters=[];for(const r of t.subEmitters){const t=[];for(const s of r)t.push(p.H.Parse(s,e,i));d.subEmitters.push(t)}}return T._Parse(t,d,e,i),t.textureMask&&(d.textureMask=y.HE.FromArray(t.textureMask)),t.preventAutoStart&&(d.preventAutoStart=t.preventAutoStart),r||d.preventAutoStart||d.start(),d}}T.BILLBOARDMODE_Y=2,T.BILLBOARDMODE_ALL=7,T.BILLBOARDMODE_STRETCHED=8,T.BILLBOARDMODE_STRETCHED_LOCAL=9,p.H._ParseParticleSystem=T.Parse},45715:(t,e,i)=>{i.d(e,{D:()=>c});var r=i(15631),s=i(48087),a=i(4392),n=i(15210),o=i(22672),h=i(3085);class c{constructor(){this._emitterNodeIsOwned=!0,this.systems=new Array}get emitterNode(){return this._emitterNode}set emitterNode(t){this._emitterNodeIsOwned&&this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!1);for(const e of this.systems)e.emitter=t;this._emitterNode=t}setEmitterAsSphere(t,e,i){this._emitterNodeIsOwned&&this._emitterNode&&this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!0,this._emitterCreationOptions={kind:"Sphere",options:t,renderingGroupId:e};const r=(0,s.Qk)("emitterSphere",{diameter:t.diameter,segments:t.segments},i);r.renderingGroupId=e;const a=new h.K("emitterSphereMaterial",i);a.emissiveColor=t.color,r.material=a;for(const t of this.systems)t.emitter=r;this._emitterNode=r}start(t){for(const e of this.systems)t&&(e.emitter=t),e.start()}dispose(){for(const t of this.systems)t.dispose();this.systems.length=0,this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNode=null)}serialize(t=!1){const e={systems:[]};for(const i of this.systems)e.systems.push(i.serialize(t));return this._emitterNode&&(e.emitter=this._emitterCreationOptions),e}static Parse(t,e,i=!1,s){const h=new c,d=this.BaseAssetsUrl+"/textures/";e=e||n.l.LastCreatedScene;for(const r of t.systems)h.systems.push(i?a.h.Parse(r,e,d,!0,s):o.p.Parse(r,e,d,!0,s));if(t.emitter){const i=t.emitter.options;if("Sphere"===t.emitter.kind)h.setEmitterAsSphere({diameter:i.diameter,segments:i.segments,color:r.Wo.FromArray(i.color)},t.emitter.renderingGroupId,e)}return h}}c.BaseAssetsUrl="https://assets.babylonjs.com/particles"},84552:(t,e,i)=>{i.d(e,{B:()=>f});var r,s=i(34389),a=i(58095),n=i(84318),o=i(72208),h=i(89209),c=i(91243),d=i(15210),l=i(92993),u=i(1316),m=i(3085),p=i(39126),_=i(72739);!function(t){t[t.Color=2]="Color",t[t.UV=1]="UV",t[t.Random=0]="Random",t[t.Stated=3]="Stated"}(r||(r={}));class f{get positions(){return this._positions32}get colors(){return this._colors32}get uvs(){return this._uvs32}constructor(t,e,i,r){this.particles=new Array,this.nbParticles=0,this.counter=0,this.vars={},this._promises=[],this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._updatable=!0,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._groups=new Array,this._groupCounter=0,this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeBoundingBox=!1,this._isReady=!1,this.name=t,this._size=e,this._scene=i||d.l.LastCreatedScene,r&&void 0!==r.updatable?this._updatable=r.updatable:this._updatable=!0}buildMeshAsync(t){return Promise.all(this._promises).then((()=>(this._isReady=!0,this._buildMesh(t))))}_buildMesh(t){0===this.nbParticles&&this.addPoints(1),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors);const e=new h.x;e.set(this._positions32,o.o.PositionKind),this._uvs32.length>0&&e.set(this._uvs32,o.o.UVKind);let i=0;this._colors32.length>0&&(i=1,e.set(this._colors32,o.o.ColorKind));const r=new c.Kj(this.name,this._scene);e.applyToMesh(r,this._updatable),this.mesh=r,this._positions=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0);let a=t;return a||(a=new m.K("point cloud material",this._scene),a.emissiveColor=new s.Wo(i,i,i),a.disableLighting=!0,a.pointsCloud=!0,a.pointSize=this._size),r.material=a,new Promise((t=>t(r)))}_addParticle(t,e,i,r){const s=new l.Q(t,e,i,r,this);return this.particles.push(s),s}_randomUnitVector(t){t.position=new a.P(Math.random(),Math.random(),Math.random()),t.color=new s.HE(1,1,1,1)}_getColorIndicesForCoord(t,e,i,r){const a=t._groupImageData,n=i*(4*r)+4*e,o=[n,n+1,n+2,n+3],h=o[1],c=o[2],d=o[3],l=a[o[0]],u=a[h],m=a[c],p=a[d];return new s.HE(l/255,u/255,m/255,p)}_setPointsColorOrUV(t,e,i,r,n,h,c){i&&t.updateFacetData();const d=2*t.getBoundingInfo().boundingSphere.radius;let l=t.getVerticesData(o.o.PositionKind);const m=t.getIndices(),p=t.getVerticesData(o.o.UVKind),f=t.getVerticesData(o.o.ColorKind),g=a.P.Zero();t.computeWorldMatrix();const y=t.getWorldMatrix();if(!y.isIdentity()){l=l.slice(0);for(let t=0;t<l.length/3;t++)a.P.TransformCoordinatesFromFloatsToRef(l[3*t],l[3*t+1],l[3*t+2],y,g),l[3*t]=g.x,l[3*t+1]=g.y,l[3*t+2]=g.z}let S=0,x=0,b=0,T=0,P=0,R=0,A=0,C=0,G=0,D=0,E=0,B=0,v=0;const M=a.P.Zero(),V=a.P.Zero(),w=a.P.Zero(),O=a.P.Zero(),z=a.P.Zero();let I=0,F=0,L=0,N=0,W=0,j=0;const U=a.FM.Zero(),k=a.FM.Zero(),H=a.FM.Zero(),Y=a.FM.Zero(),Z=a.FM.Zero();let Q=0,K=0,q=0,J=0,X=0,$=0,tt=0,et=0,it=0,rt=0,st=0,at=0;const nt=a.Lt.Zero(),ot=a.Lt.Zero(),ht=a.Lt.Zero(),ct=a.Lt.Zero(),dt=a.Lt.Zero();let lt,ut,mt=0,pt=0;c=c||0;let _t=new a.Lt(0,0,0,0),ft=a.P.Zero(),gt=a.P.Zero(),yt=a.P.Zero(),St=0,xt=a.P.Zero(),bt=0,Tt=0;const Pt=new u.z(a.P.Zero(),new a.P(1,0,0));let Rt,At=a.P.Zero();for(let o=0;o<m.length/3;o++){let u,g,y,Ct,Gt,Dt,Et,Bt;x=m[3*o],b=m[3*o+1],T=m[3*o+2],P=l[3*x],R=l[3*x+1],A=l[3*x+2],C=l[3*b],G=l[3*b+1],D=l[3*b+2],E=l[3*T],B=l[3*T+1],v=l[3*T+2],M.set(P,R,A),V.set(C,G,D),w.set(E,B,v),V.subtractToRef(M,O),w.subtractToRef(V,z),p&&(I=p[2*x],F=p[2*x+1],L=p[2*b],N=p[2*b+1],W=p[2*T],j=p[2*T+1],U.set(I,F),k.set(L,N),H.set(W,j),k.subtractToRef(U,Y),H.subtractToRef(k,Z)),f&&r&&(Q=f[4*x],K=f[4*x+1],q=f[4*x+2],J=f[4*x+3],X=f[4*b],$=f[4*b+1],tt=f[4*b+2],et=f[4*b+3],it=f[4*T],rt=f[4*T+1],st=f[4*T+2],at=f[4*T+3],nt.set(Q,K,q,J),ot.set(X,$,tt,et),ht.set(it,rt,st,at),ot.subtractToRef(nt,ct),ht.subtractToRef(ot,dt));const vt=new s.Wo(0,0,0),Mt=new s.Wo(0,0,0);let Vt,wt;for(let l=0;l<e._groupDensity[o];l++)S=this.particles.length,this._addParticle(S,e,this._groupCounter,o+l),wt=this.particles[S],mt=_.R.RandomRange(0,1),pt=_.R.RandomRange(0,1),lt=M.add(O.scale(mt)).add(z.scale(mt*pt)),i&&(ft=t.getFacetNormal(o).normalize().scale(-1),gt=O.clone().normalize(),yt=a.P.Cross(ft,gt),St=_.R.RandomRange(0,2*Math.PI),xt=gt.scale(Math.cos(St)).add(yt.scale(Math.sin(St))),St=_.R.RandomRange(.1,Math.PI/2),At=xt.scale(Math.cos(St)).add(ft.scale(Math.sin(St))),Pt.origin=lt.add(At.scale(1e-5)),Pt.direction=At,Pt.length=d,Rt=Pt.intersectsMesh(t),Rt.hit&&(Tt=Rt.pickedPoint.subtract(lt).length(),bt=_.R.RandomRange(0,1)*Tt,lt.addInPlace(At.scale(bt)))),wt.position=lt.clone(),this._positions.push(wt.position.x,wt.position.y,wt.position.z),void 0!==r?p&&(ut=U.add(Y.scale(mt)).add(Z.scale(mt*pt)),r?n&&null!==e._groupImageData?(u=e._groupImgWidth,g=e._groupImgHeight,Vt=this._getColorIndicesForCoord(e,Math.round(ut.x*u),Math.round(ut.y*g),u),wt.color=Vt,this._colors.push(Vt.r,Vt.g,Vt.b,Vt.a)):f?(_t=nt.add(ct.scale(mt)).add(dt.scale(mt*pt)),wt.color=new s.HE(_t.x,_t.y,_t.z,_t.w),this._colors.push(_t.x,_t.y,_t.z,_t.w)):(_t=nt.set(Math.random(),Math.random(),Math.random(),1),wt.color=new s.HE(_t.x,_t.y,_t.z,_t.w),this._colors.push(_t.x,_t.y,_t.z,_t.w)):(wt.uv=ut.clone(),this._uvs.push(wt.uv.x,wt.uv.y))):(h?(vt.set(h.r,h.g,h.b),y=_.R.RandomRange(-c,c),Ct=_.R.RandomRange(-c,c),Bt=vt.toHSV(),Gt=Bt.r,Dt=Bt.g+y,Et=Bt.b+Ct,Dt<0&&(Dt=0),Dt>1&&(Dt=1),Et<0&&(Et=0),Et>1&&(Et=1),s.Wo.HSVtoRGBToRef(Gt,Dt,Et,Mt),_t.set(Mt.r,Mt.g,Mt.b,1)):_t=nt.set(Math.random(),Math.random(),Math.random(),1),wt.color=new s.HE(_t.x,_t.y,_t.z,_t.w),this._colors.push(_t.x,_t.y,_t.z,_t.w))}}_colorFromTexture(t,e,i){if(null===t.material)return n.Y.Warn(t.name+"has no material."),e._groupImageData=null,void this._setPointsColorOrUV(t,e,i,!0,!1);const r=t.material.getActiveTextures();if(0===r.length)return n.Y.Warn(t.name+"has no usable texture."),e._groupImageData=null,void this._setPointsColorOrUV(t,e,i,!0,!1);const s=t.clone();s.setEnabled(!1),this._promises.push(new Promise((t=>{p.V.WhenAllReady(r,(()=>{let a=e._textureNb;a<0&&(a=0),a>r.length-1&&(a=r.length-1);const n=()=>{e._groupImgWidth=r[a].getSize().width,e._groupImgHeight=r[a].getSize().height,this._setPointsColorOrUV(s,e,i,!0,!0),s.dispose(),t()};e._groupImageData=null;const o=r[a].readPixels();o?o.then((t=>{e._groupImageData=t,n()})):n()}))})))}_calculateDensity(t,e,i){let r,s,n,o,h,c,d,l,u,m,p,_,f=new Array;const g=a.P.Zero(),y=a.P.Zero(),S=a.P.Zero(),x=a.P.Zero(),b=a.P.Zero(),T=a.P.Zero();let P,R,A,C,G;const D=new Array;let E=0;const B=i.length/3;for(let t=0;t<B;t++)r=i[3*t],s=i[3*t+1],n=i[3*t+2],o=e[3*r],h=e[3*r+1],c=e[3*r+2],d=e[3*s],l=e[3*s+1],u=e[3*s+2],m=e[3*n],p=e[3*n+1],_=e[3*n+2],g.set(o,h,c),y.set(d,l,u),S.set(m,p,_),y.subtractToRef(g,x),S.subtractToRef(y,b),S.subtractToRef(g,T),P=x.length(),R=b.length(),A=T.length(),C=(P+R+A)/2,G=Math.sqrt(C*(C-P)*(C-R)*(C-A)),E+=G,D[t]=G;let v=0;for(let e=0;e<B;e++)f[e]=Math.floor(t*D[e]/E),v+=f[e];const M=t-v,V=Math.floor(M/B),w=M%B;V>0&&(f=f.map((t=>t+V)));for(let t=0;t<w;t++)f[t]+=1;return f}addPoints(t,e=this._randomUnitVector){const i=new l.O(this._groupCounter,e);let r,s=this.nbParticles;for(let e=0;e<t;e++)r=this._addParticle(s,i,this._groupCounter,e),i&&i._positionFunction&&i._positionFunction(r,s,e),this._positions.push(r.position.x,r.position.y,r.position.z),r.color&&this._colors.push(r.color.r,r.color.g,r.color.b,r.color.a),r.uv&&this._uvs.push(r.uv.x,r.uv.y),s++;return this.nbParticles+=t,this._groupCounter++,this._groupCounter}addSurfacePoints(t,e,i,a,n){let h=i||r.Random;(isNaN(h)||h<0||h>3)&&(h=r.Random);const c=t.getVerticesData(o.o.PositionKind),d=t.getIndices();this._groups.push(this._groupCounter);const u=new l.O(this._groupCounter,null);switch(u._groupDensity=this._calculateDensity(e,c,d),h===r.Color?u._textureNb=a||0:a=a||new s.HE(1,1,1,1),h){case r.Color:this._colorFromTexture(t,u,!1);break;case r.UV:this._setPointsColorOrUV(t,u,!1,!1,!1);break;case r.Random:this._setPointsColorOrUV(t,u,!1);break;case r.Stated:this._setPointsColorOrUV(t,u,!1,void 0,void 0,a,n)}return this.nbParticles+=e,this._groupCounter++,this._groupCounter-1}addVolumePoints(t,e,i,a,n){let h=i||r.Random;(isNaN(h)||h<0||h>3)&&(h=r.Random);const c=t.getVerticesData(o.o.PositionKind),d=t.getIndices();this._groups.push(this._groupCounter);const u=new l.O(this._groupCounter,null);switch(u._groupDensity=this._calculateDensity(e,c,d),h===r.Color?u._textureNb=a||0:a=a||new s.HE(1,1,1,1),h){case r.Color:this._colorFromTexture(t,u,!0);break;case r.UV:this._setPointsColorOrUV(t,u,!0,!1,!1);break;case r.Random:this._setPointsColorOrUV(t,u,!0);break;case r.Stated:this._setPointsColorOrUV(t,u,!0,void 0,void 0,a,n)}return this.nbParticles+=e,this._groupCounter++,this._groupCounter-1}setParticles(t=0,e=this.nbParticles-1,i=!0){var r,s;if(!this._updatable||!this._isReady)return this;this.beforeUpdateParticles(t,e,i);const n=a.jp.Matrix[0],h=this.mesh,c=this._colors32,d=this._positions32,l=this._uvs32,u=a.jp.Vector3,m=u[5].copyFromFloats(1,0,0),p=u[6].copyFromFloats(0,1,0),_=u[7].copyFromFloats(0,0,1),f=u[8].setAll(Number.MAX_VALUE),g=u[9].setAll(-Number.MAX_VALUE);a.y3.IdentityToRef(n);let y=0;if((null===(r=this.mesh)||void 0===r?void 0:r.isFacetDataEnabled)&&(this._computeBoundingBox=!0),e=e>=this.nbParticles?this.nbParticles-1:e,this._computeBoundingBox&&(0!=t||e!=this.nbParticles-1)){const t=null===(s=this.mesh)||void 0===s?void 0:s.getBoundingInfo();t&&(f.copyFrom(t.minimum),g.copyFrom(t.maximum))}y=0;let S=0,x=0,b=0;for(let i=t;i<=e;i++){const t=this.particles[i];y=t.idx,S=3*y,x=4*y,b=2*y,this.updateParticle(t);const e=t._rotationMatrix,r=t.position,s=t._globalPosition;this._computeParticleRotation&&t.getRotationMatrix(n);if(null!==t.parentId){const i=this.particles[t.parentId],a=i._rotationMatrix,o=i._globalPosition,h=r.x*a[1]+r.y*a[4]+r.z*a[7],c=r.x*a[0]+r.y*a[3]+r.z*a[6],d=r.x*a[2]+r.y*a[5]+r.z*a[8];if(s.x=o.x+c,s.y=o.y+h,s.z=o.z+d,this._computeParticleRotation){const t=n.m;e[0]=t[0]*a[0]+t[1]*a[3]+t[2]*a[6],e[1]=t[0]*a[1]+t[1]*a[4]+t[2]*a[7],e[2]=t[0]*a[2]+t[1]*a[5]+t[2]*a[8],e[3]=t[4]*a[0]+t[5]*a[3]+t[6]*a[6],e[4]=t[4]*a[1]+t[5]*a[4]+t[6]*a[7],e[5]=t[4]*a[2]+t[5]*a[5]+t[6]*a[8],e[6]=t[8]*a[0]+t[9]*a[3]+t[10]*a[6],e[7]=t[8]*a[1]+t[9]*a[4]+t[10]*a[7],e[8]=t[8]*a[2]+t[9]*a[5]+t[10]*a[8]}}else if(s.x=0,s.y=0,s.z=0,this._computeParticleRotation){const t=n.m;e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10]}const a=u[11];t.translateFromPivot?a.setAll(0):a.copyFrom(t.pivot);const o=u[0];o.copyFrom(t.position);const h=o.x-t.pivot.x,c=o.y-t.pivot.y,l=o.z-t.pivot.z;let T=h*e[0]+c*e[3]+l*e[6],P=h*e[1]+c*e[4]+l*e[7],R=h*e[2]+c*e[5]+l*e[8];T+=a.x,P+=a.y,R+=a.z;const A=d[S]=s.x+m.x*T+p.x*P+_.x*R,C=d[S+1]=s.y+m.y*T+p.y*P+_.y*R,G=d[S+2]=s.z+m.z*T+p.z*P+_.z*R;if(this._computeBoundingBox&&(f.minimizeInPlaceFromFloats(A,C,G),g.maximizeInPlaceFromFloats(A,C,G)),this._computeParticleColor&&t.color){const e=t.color,i=this._colors32;i[x]=e.r,i[x+1]=e.g,i[x+2]=e.b,i[x+3]=e.a}if(this._computeParticleTexture&&t.uv){const e=t.uv,i=this._uvs32;i[b]=e.x,i[b+1]=e.y}}return h&&(i&&(this._computeParticleColor&&h.updateVerticesData(o.o.ColorKind,c,!1,!1),this._computeParticleTexture&&h.updateVerticesData(o.o.UVKind,l,!1,!1),h.updateVerticesData(o.o.PositionKind,d,!1,!1)),this._computeBoundingBox&&(h.hasBoundingInfo?h.getBoundingInfo().reConstruct(f,g,h._worldMatrix):h.buildBoundingInfo(f,g,h._worldMatrix))),this.afterUpdateParticles(t,e,i),this}dispose(){var t;null===(t=this.mesh)||void 0===t||t.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._uvs32=null,this._colors32=null}refreshVisibleSize(){var t;return this._isVisibilityBoxLocked||null===(t=this.mesh)||void 0===t||t.refreshBoundingInfo(),this}setVisibilityBox(t){if(!this.mesh)return;const e=t/2;this.mesh.buildBoundingInfo(new a.P(-e,-e,-e),new a.P(e,e,e))}get isAlwaysVisible(){return this._alwaysVisible}set isAlwaysVisible(t){this.mesh&&(this._alwaysVisible=t,this.mesh.alwaysSelectAsActiveMesh=t)}set computeParticleRotation(t){this._computeParticleRotation=t}set computeParticleColor(t){this._computeParticleColor=t}set computeParticleTexture(t){this._computeParticleTexture=t}get computeParticleColor(){return this._computeParticleColor}get computeParticleTexture(){return this._computeParticleTexture}set computeBoundingBox(t){this._computeBoundingBox=t}get computeBoundingBox(){return this._computeBoundingBox}initParticles(){}recycleParticle(t){return t}updateParticle(t){return t}beforeUpdateParticles(t,e,i){}afterUpdateParticles(t,e,i){}}},45680:(t,e,i)=>{i.d(e,{H:()=>o,l:()=>r});var r,s=i(58095),a=i(77851),n=i(48620);!function(t){t[t.ATTACHED=0]="ATTACHED",t[t.END=1]="END"}(r||(r={}));class o{constructor(t){if(this.particleSystem=t,this.type=r.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!t.emitter||!t.emitter.dispose){const e=(0,n.q)("BABYLON.AbstractMesh");t.emitter=new e("SubemitterSystemEmitter",t.getScene()),t._disposeEmitterOnDispose=!0}}clone(){let t=this.particleSystem.emitter;if(t){if(t instanceof s.P)t=t.clone();else if(-1!==t.getClassName().indexOf("Mesh")){t=new((0,n.q)("BABYLON.Mesh"))("",t.getScene()),t.isVisible=!1}}else t=new s.P;const e=new o(this.particleSystem.clone(this.particleSystem.name,t));return e.particleSystem.name+="Clone",e.type=this.type,e.inheritDirection=this.inheritDirection,e.inheritedVelocityAmount=this.inheritedVelocityAmount,e.particleSystem._disposeEmitterOnDispose=!0,e.particleSystem.disposeOnStop=!0,e}serialize(t=!1){const e={};return e.type=this.type,e.inheritDirection=this.inheritDirection,e.inheritedVelocityAmount=this.inheritedVelocityAmount,e.particleSystem=this.particleSystem.serialize(t),e}static _ParseParticleSystem(t,e,i,r=!1){throw(0,a.S)("ParseParticle")}static Parse(t,e,i){const r=t.particleSystem,s=new o(o._ParseParticleSystem(r,e,i,!0));return s.type=t.type,s.inheritDirection=t.inheritDirection,s.inheritedVelocityAmount=t.inheritedVelocityAmount,s.particleSystem._isSubEmitter=!0,s}dispose(){this.particleSystem.dispose()}}},52311:(t,e,i)=>{i(41631),i(36135);var r=i(84318),s=i(62897),a=i(85627),n=i(65273),o=i(62103),h=i(57933);n.x.prototype.getPhysicsEngine=function(){return this._physicsEngine},n.x.prototype.enablePhysics=function(t=null,e){if(this._physicsEngine)return!0;let i=this._getComponent(a.l.NAME_PHYSICSENGINE);i||(i=new c(this),this._addComponent(i));try{if(e&&1!==(null==e?void 0:e.getPluginVersion())){if(2!==(null==e?void 0:e.getPluginVersion()))throw new Error("Unsupported Physics plugin version.");this._physicsEngine=new h.T(t,e)}else this._physicsEngine=new o.T(t,e);return this._physicsTimeAccumulator=0,!0}catch(t){return r.Y.Error(t.message),!1}},n.x.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)},n.x.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},n.x.prototype.deleteCompoundImpostor=function(t){const e=t.parts[0].mesh;e.physicsImpostor&&(e.physicsImpostor.dispose(),e.physicsImpostor=null)},n.x.prototype._advancePhysicsEngineStep=function(t){if(this._physicsEngine){const e=this._physicsEngine.getSubTimeStep();if(e>0)for(this._physicsTimeAccumulator+=t;this._physicsTimeAccumulator>e;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=e;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class c{constructor(t){this.name=a.l.NAME_PHYSICSENGINE,this.scene=t,this.scene.onBeforePhysicsObservable=new s.y$,this.scene.onAfterPhysicsObservable=new s.y$,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?1e3*this.scene._physicsEngine.getTimeStep():1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}i(5214);var d,l,u=i(58095),m=(i(48087),i(62845)),p=i(1316);class _{constructor(t,e,i){this._scene=t,this._origin=e,this._options=i,this._originTop=u.P.Zero(),this._originDirection=u.P.Zero(),this._cylinderPosition=u.P.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options={...new g,...this._options},this._origin.addToRef(new u.P(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new u.P(0,this._options.height,0),this._originTop),this._options.updraftMode===l.Perpendicular&&(this._originDirection=this._origin.subtract(this._originTop).normalize()),this._tickCallback=this._tick.bind(this),this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(t=!0){this._cylinder&&(t?this._cylinder.dispose():setTimeout((()=>{this._dataFetched||this._cylinder.dispose()}),0))}_getHitData(t,e){let i;i=this._options.updraftMode===l.Perpendicular?this._originDirection:t.subtract(this._originTop);const r=u.P.Distance(this._origin,t),s=-1*this._options.strength,a=i.multiplyByFloats(s,s,s);e.force=a,e.contactPoint=t,e.distanceFromOrigin=r}_getBodyHitData(t,e){if("Mesh"!==t.transformNode.getClassName()&&"InstancedMesh"!==t.transformNode.getClassName())return!1;const i=t.transformNode;if(!this._intersectsWithCylinder(i))return!1;const r=t.getObjectCenter();return this._getHitData(r,e),!0}_getImpostorHitData(t,e){if(0===t.mass)return!1;const i=t.object;if(!this._intersectsWithCylinder(i))return!1;const r=t.getObjectCenter();return this._getHitData(r,e),!0}_tick(){const t=_.hitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach((e=>{this._getImpostorHitData(e,t)&&e.applyForce(t.force,t.contactPoint)})):this._physicsEngine.getBodies().forEach((e=>{this._getBodyHitData(e,t)&&e.applyForce(t.force,t.contactPoint)}))}_prepareCylinder(){this._cylinder||(this._cylinder=(0,m.wf)("updraftEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(t){return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(t,!0)}}_.hitData={force:new u.P,contactPoint:new u.P,distanceFromOrigin:0};class f{constructor(t,e,i){this._scene=t,this._origin=e,this._options=i,this._originTop=u.P.Zero(),this._cylinderPosition=u.P.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options={...new y,...this._options},this._origin.addToRef(new u.P(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new u.P(0,this._options.height,0),this._originTop),this._tickCallback=this._tick.bind(this),this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(t=!0){t?this._cylinder.dispose():setTimeout((()=>{this._dataFetched||this._cylinder.dispose()}),0)}_getHitData(t,e,i){const r=f.originOnPlane;r.set(this._origin.x,e.y,this._origin.z);const s=e.subtract(r),a=new p.z(r,s,this._options.radius).intersectsMesh(t),n=a.pickedPoint;if(!n)return!1;const o=a.distance/this._options.radius;let h,c,d,l=n.normalize();if(o>this._options.centripetalForceThreshold&&(l=l.negate()),o>this._options.centripetalForceThreshold)h=l.x*this._options.centripetalForceMultiplier,c=l.y*this._options.updraftForceMultiplier,d=l.z*this._options.centripetalForceMultiplier;else{const t=u.P.Cross(r,e).normalize();h=(t.x+l.x)*this._options.centrifugalForceMultiplier,c=this._originTop.y*this._options.updraftForceMultiplier,d=(t.z+l.z)*this._options.centrifugalForceMultiplier}let m=new u.P(h,c,d);return m=m.multiplyByFloats(this._options.strength,this._options.strength,this._options.strength),i.force=m,i.contactPoint=e,i.distanceFromOrigin=o,!0}_getBodyHitData(t,e){if("Mesh"!==t.transformNode.getClassName()&&"InstancedMesh"!==t.transformNode.getClassName())return!1;const i=t.transformNode;if(!this._intersectsWithCylinder(i))return!1;const r=t.getObjectCenter();return this._getHitData(i,r,e),!0}_getImpostorHitData(t,e){if(0===t.mass)return!1;if("Mesh"!==t.object.getClassName()&&"InstancedMesh"!==t.object.getClassName())return!1;const i=t.object;if(!this._intersectsWithCylinder(i))return!1;const r=t.getObjectCenter();return this._getHitData(i,r,e),!0}_tick(){const t=f.hitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach((e=>{this._getImpostorHitData(e,t)&&e.applyForce(t.force,t.contactPoint)})):this._physicsEngine.getBodies().forEach((e=>{this._getBodyHitData(e,t)&&e.applyForce(t.force,t.contactPoint)}))}_prepareCylinder(){this._cylinder||(this._cylinder=(0,m.wf)("vortexEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(t){return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(t,!0)}}f.originOnPlane=u.P.Zero(),f.hitData={force:new u.P,contactPoint:new u.P,distanceFromOrigin:0};class g{constructor(){this.radius=5,this.strength=10,this.height=10,this.updraftMode=l.Center}}class y{constructor(){this.radius=5,this.strength=10,this.height=10,this.centripetalForceThreshold=.7,this.centripetalForceMultiplier=5,this.centrifugalForceMultiplier=.5,this.updraftForceMultiplier=.02}}!function(t){t[t.Constant=0]="Constant",t[t.Linear=1]="Linear"}(d||(d={})),function(t){t[t.Center=0]="Center",t[t.Perpendicular=1]="Perpendicular"}(l||(l={}));i(60604)},60604:(t,e,i)=>{i.d(e,{d:()=>s});var r=i(58095);class s{constructor(){this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=r.P.Zero(),this._hitPointWorld=r.P.Zero(),this._rayFromWorld=r.P.Zero(),this._rayToWorld=r.P.Zero()}get hasHit(){return this._hasHit}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormalWorld}get hitPointWorld(){return this._hitPointWorld}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitData(t,e){this._hasHit=!0,this._hitNormalWorld=new r.P(t.x,t.y,t.z),this._hitPointWorld=new r.P(e.x,e.y,e.z)}setHitDistance(t){this._hitDistance=t}calculateHitDistance(){this._hitDistance=r.P.Distance(this._rayFromWorld,this._hitPointWorld)}reset(t=r.P.Zero(),e=r.P.Zero()){this._rayFromWorld=t,this._rayToWorld=e,this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=r.P.Zero(),this._hitPointWorld=r.P.Zero()}}},29189:()=>{},96584:(t,e,i)=>{i.d(e,{b:()=>p});var r=i(58095),s=i(84318),a=i(59715),n=i(75353),o=i(72208),h=i(89209),c=i(75159),d=i(9866),l=i(60604),u=i(72739),m=i(48154);class p{constructor(t=!0,e=Ammo,i=null){this._useDeltaForWorldStep=t,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new r._f,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new r.P,this._tmpContactNormal=new r.P,this._tmpVec3=new r.P,this._tmpMatrix=new r.y3,"function"!=typeof e?(this.bjsAMMO=e,this.isSupported()?(this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=i||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=t=>{const e=(t=this.bjsAMMO.wrapPointer(t,this.bjsAMMO.btManifoldPoint)).getPositionWorldOnA(),i=t.m_normalWorldOnB;this._tmpContactPoint.x=e.x(),this._tmpContactPoint.y=e.y(),this._tmpContactPoint.z=e.z(),this._tmpContactNormal.x=i.x(),this._tmpContactNormal.y=i.y(),this._tmpContactNormal.z=i.z(),this._tmpContactImpulse=t.getAppliedImpulse(),this._tmpContactDistance=t.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new l.d,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)):s.Y.Error("AmmoJS is not available. Please make sure you included the js file.")):s.Y.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.")}getPluginVersion(){return 1}setGravity(t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(t){this._timeStep=t}setFixedTimeStep(t){this._fixedTimeStep=t}setMaxSteps(t){this._maxSteps=t}getTimeStep(){return this._timeStep}_isImpostorInContact(t){return this._tmpContactCallbackResult=!1,this.world.contactTest(t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(t,e){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(t.physicsBody,e.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(t=1/60,e=10,i=1/60){if(0==e)this.world.stepSimulation(t,0);else for(;e>0&&t>0;)t-i<i?(this.world.stepSimulation(t,0),t=0):(t-=i,this.world.stepSimulation(i,0)),e--}executeStep(t,e){for(const t of e)t.soft||t.beforeStep();this._stepSimulation(this._useDeltaForWorldStep?t:this._timeStep,this._maxSteps,this._fixedTimeStep);for(const t of e)if(t.soft?this._afterSoftStep(t):t.afterStep(),t._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(t))for(const e of t._onPhysicsCollideCallbacks)for(const i of e.otherImpostors)(t.physicsBody.isActive()||i.physicsBody.isActive())&&this._isImpostorPairInContact(t,i)&&(t.onCollide({body:i.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),i.onCollide({body:t.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(t){t.type===a.Q.RopeImpostor?this._ropeStep(t):this._softbodyOrClothStep(t)}_ropeStep(t){const e=t.physicsBody.get_m_nodes(),i=e.size();let s,a,n,o,h;const l=new Array;for(let t=0;t<i;t++)s=e.at(t),a=s.get_m_x(),n=a.x(),o=a.y(),h=a.z(),l.push(new r.P(n,o,h));const u=t.object,m=t.getParam("shape");t._isFromLine?t.object=(0,d.nL)("lines",{points:l,instance:u}):t.object=(0,c.Gc)("ext",{shape:m,path:l,instance:u})}_softbodyOrClothStep(t){const e=t.type===a.Q.ClothImpostor?1:-1,i=t.object;let r=i.getVerticesData(o.o.PositionKind);r||(r=[]);let s=i.getVerticesData(o.o.NormalKind);s||(s=[]);const n=r.length/3,c=t.physicsBody.get_m_nodes();let d,l,u,m,p,_,f,g;for(let t=0;t<n;t++){d=c.at(t),l=d.get_m_x(),u=l.x(),m=l.y(),p=l.z()*e;const i=d.get_m_n();_=i.x(),f=i.y(),g=i.z()*e,r[3*t]=u,r[3*t+1]=m,r[3*t+2]=p,s[3*t]=_,s[3*t+1]=f,s[3*t+2]=g}const y=new h.x;y.positions=r,y.normals=s,y.uvs=i.getVerticesData(o.o.UVKind),y.colors=i.getVerticesData(o.o.ColorKind),i&&i.getIndices&&(y.indices=i.getIndices()),y.applyToMesh(i)}applyImpulse(t,e,i){if(t.soft)s.Y.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();const r=this._tmpAmmoVectorA,s=this._tmpAmmoVectorB;t.object&&t.object.getWorldMatrix&&i.subtractInPlace(t.object.getWorldMatrix().getTranslation()),r.setValue(i.x,i.y,i.z),s.setValue(e.x,e.y,e.z),t.physicsBody.applyImpulse(s,r)}}applyForce(t,e,i){if(t.soft)s.Y.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();const r=this._tmpAmmoVectorA,s=this._tmpAmmoVectorB;if(t.object&&t.object.getWorldMatrix){const e=t.object.getWorldMatrix().getTranslation();r.setValue(i.x-e.x,i.y-e.y,i.z-e.z)}else r.setValue(i.x,i.y,i.z);s.setValue(e.x,e.y,e.z),t.physicsBody.applyForce(s,r)}}generatePhysicsBody(t){if(t._pluginData.toDispose=[],t.parent)t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());else if(t.isBodyInitRequired()){const e=this._createShape(t),i=t.getParam("mass");if(t._pluginData.mass=i,t.soft)e.get_m_cfg().set_collisions(17),e.get_m_cfg().set_kDP(t.getParam("damping")),this.bjsAMMO.castObject(e,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(t.getParam("margin")),e.setActivationState(p._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(e,1,-1),t.physicsBody=e,t._pluginData.toDispose.push(e),this.setBodyPressure(t,0),t.type===a.Q.SoftbodyImpostor&&this.setBodyPressure(t,t.getParam("pressure")),this.setBodyStiffness(t,t.getParam("stiffness")),this.setBodyVelocityIterations(t,t.getParam("velocityIterations")),this.setBodyPositionIterations(t,t.getParam("positionIterations"));else{const r=new this.bjsAMMO.btVector3(0,0,0),s=new this.bjsAMMO.btTransform;t.object.computeWorldMatrix(!0),s.setIdentity(),0!==i&&e.calculateLocalInertia(i,r),this._tmpAmmoVectorA.setValue(t.object.position.x,t.object.position.y,t.object.position.z),this._tmpAmmoQuaternion.setValue(t.object.rotationQuaternion.x,t.object.rotationQuaternion.y,t.object.rotationQuaternion.z,t.object.rotationQuaternion.w),s.setOrigin(this._tmpAmmoVectorA),s.setRotation(this._tmpAmmoQuaternion);const n=new this.bjsAMMO.btDefaultMotionState(s),o=new this.bjsAMMO.btRigidBodyConstructionInfo(i,n,e,r),h=new this.bjsAMMO.btRigidBody(o);if(0===i&&(h.setCollisionFlags(h.getCollisionFlags()|p._KINEMATIC_FLAG),h.setActivationState(p._DISABLE_DEACTIVATION_FLAG)),t.type!=a.Q.NoImpostor||e.getChildShape||h.setCollisionFlags(h.getCollisionFlags()|p._DISABLE_COLLISION_FLAG),t.type!==a.Q.MeshImpostor&&t.type!==a.Q.NoImpostor){const e=t.object.getBoundingInfo();this._tmpVec3.copyFrom(t.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(e.boundingBox.centerWorld),this._tmpVec3.x/=t.object.scaling.x,this._tmpVec3.y/=t.object.scaling.y,this._tmpVec3.z/=t.object.scaling.z,t.setDeltaPosition(this._tmpVec3)}const c=t.getParam("group"),d=t.getParam("mask");c&&d?this.world.addRigidBody(h,c,d):this.world.addRigidBody(h),t.physicsBody=h,t._pluginData.toDispose=t._pluginData.toDispose.concat([h,o,n,s,r,e])}this.setBodyRestitution(t,t.getParam("restitution")),this.setBodyFriction(t,t.getParam("friction"))}}removePhysicsBody(t){this.world&&(t.soft?this.world.removeSoftBody(t.physicsBody):this.world.removeRigidBody(t.physicsBody),t._pluginData&&(t._pluginData.toDispose.forEach((t=>{this.bjsAMMO.destroy(t)})),t._pluginData.toDispose=[]))}generateJoint(t){const e=t.mainImpostor.physicsBody,i=t.connectedImpostor.physicsBody;if(!e||!i)return;const a=t.joint.jointData;let o;switch(a.mainPivot||(a.mainPivot=new r.P(0,0,0)),a.connectedPivot||(a.connectedPivot=new r.P(0,0,0)),t.joint.type){case n.q7.DistanceJoint:{const t=a.maxDistance;t&&(a.mainPivot=new r.P(0,-t/2,0),a.connectedPivot=new r.P(0,t/2,0)),o=new this.bjsAMMO.btPoint2PointConstraint(e,i,new this.bjsAMMO.btVector3(a.mainPivot.x,a.mainPivot.y,a.mainPivot.z),new this.bjsAMMO.btVector3(a.connectedPivot.x,a.connectedPivot.y,a.connectedPivot.z));break}case n.q7.HingeJoint:{a.mainAxis||(a.mainAxis=new r.P(0,0,0)),a.connectedAxis||(a.connectedAxis=new r.P(0,0,0));const t=new this.bjsAMMO.btVector3(a.mainAxis.x,a.mainAxis.y,a.mainAxis.z),s=new this.bjsAMMO.btVector3(a.connectedAxis.x,a.connectedAxis.y,a.connectedAxis.z);o=new this.bjsAMMO.btHingeConstraint(e,i,new this.bjsAMMO.btVector3(a.mainPivot.x,a.mainPivot.y,a.mainPivot.z),new this.bjsAMMO.btVector3(a.connectedPivot.x,a.connectedPivot.y,a.connectedPivot.z),t,s);break}case n.q7.BallAndSocketJoint:o=new this.bjsAMMO.btPoint2PointConstraint(e,i,new this.bjsAMMO.btVector3(a.mainPivot.x,a.mainPivot.y,a.mainPivot.z),new this.bjsAMMO.btVector3(a.connectedPivot.x,a.connectedPivot.y,a.connectedPivot.z));break;default:s.Y.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint"),o=new this.bjsAMMO.btPoint2PointConstraint(e,i,new this.bjsAMMO.btVector3(a.mainPivot.x,a.mainPivot.y,a.mainPivot.z),new this.bjsAMMO.btVector3(a.connectedPivot.x,a.connectedPivot.y,a.connectedPivot.z))}this.world.addConstraint(o,!t.joint.jointData.collision),t.joint.physicsJoint=o}removeJoint(t){this.world&&this.world.removeConstraint(t.joint.physicsJoint)}_addMeshVerts(t,e,i){let s=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let a=i.getIndices();a||(a=[]);let n,h=i.getVerticesData(o.o.PositionKind);if(h||(h=[]),e&&e!==i){let t;t=e.rotationQuaternion?e.rotationQuaternion:e.rotation?r._f.FromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z):r._f.Identity();r.y3.Compose(r.P.One(),t,e.position).invertToRef(this._tmpMatrix);n=i.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else r.y3.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),n=this._tmpMatrix;const c=a.length/3;for(let e=0;e<c;e++){const i=[];for(let t=0;t<3;t++){let s,o=new r.P(h[3*a[3*e+t]+0],h[3*a[3*e+t]+1],h[3*a[3*e+t]+2]);o=r.P.TransformCoordinates(o,n),s=0==t?this._tmpAmmoVectorA:1==t?this._tmpAmmoVectorB:this._tmpAmmoVectorC,s.setValue(o.x,o.y,o.z),i.push(s)}t.addTriangle(i[0],i[1],i[2]),s++}i.getChildMeshes().forEach((i=>{s+=this._addMeshVerts(t,e,i)}))}return s}_softVertexData(t){const e=t.object;if(e&&e.getIndices&&e.getWorldMatrix&&e.getChildMeshes){let t=e.getIndices();t||(t=[]);let i=e.getVerticesData(o.o.PositionKind);i||(i=[]);let s=e.getVerticesData(o.o.NormalKind);s||(s=[]),e.computeWorldMatrix(!1);const a=[],n=[];for(let t=0;t<i.length;t+=3){let o=new r.P(i[t],i[t+1],i[t+2]),h=new r.P(s[t],s[t+1],s[t+2]);o=r.P.TransformCoordinates(o,e.getWorldMatrix()),h=r.P.TransformNormal(h,e.getWorldMatrix()),a.push(o.x,o.y,o.z),n.push(h.x,h.y,h.z)}const c=new h.x;return c.positions=a,c.normals=n,c.uvs=e.getVerticesData(o.o.UVKind),c.colors=e.getVerticesData(o.o.ColorKind),e&&e.getIndices&&(c.indices=e.getIndices()),c.applyToMesh(e),e.position=r.P.Zero(),e.rotationQuaternion=null,e.rotation=r.P.Zero(),e.computeWorldMatrix(!0),c}return h.x.ExtractFromMesh(e)}_createSoftbody(t){const e=t.object;if(e&&e.getIndices){let i=e.getIndices();i||(i=[]);const s=this._softVertexData(t),a=s.positions,n=s.normals;if(null===a||null===n)return new this.bjsAMMO.btCompoundShape;{const t=[],s=[];for(let e=0;e<a.length;e+=3){const i=new r.P(a[e],a[e+1],a[e+2]),o=new r.P(n[e],n[e+1],n[e+2]);t.push(i.x,i.y,-i.z),s.push(o.x,o.y,-o.z)}const o=(new this.bjsAMMO.btSoftBodyHelpers).CreateFromTriMesh(this.world.getWorldInfo(),t,e.getIndices(),i.length/3,!0),h=a.length/3,c=o.get_m_nodes();let d,l;for(let t=0;t<h;t++)d=c.at(t),l=d.get_m_n(),l.setX(s[3*t]),l.setY(s[3*t+1]),l.setZ(s[3*t+2]);return o}}}_createCloth(t){const e=t.object;if(e&&e.getIndices){let i=e.getIndices();i||(i=[]);const r=this._softVertexData(t),s=r.positions,a=r.normals;if(null===s||null===a)return new this.bjsAMMO.btCompoundShape;{const e=s.length,i=Math.sqrt(e/3);t.segments=i;const r=i-1;this._tmpAmmoVectorA.setValue(s[0],s[1],s[2]),this._tmpAmmoVectorB.setValue(s[3*r],s[3*r+1],s[3*r+2]),this._tmpAmmoVectorD.setValue(s[e-3],s[e-2],s[e-1]),this._tmpAmmoVectorC.setValue(s[e-3-3*r],s[e-2-3*r],s[e-1-3*r]);return(new this.bjsAMMO.btSoftBodyHelpers).CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,i,i,t.getParam("fixedPoints"),!0)}}}_createRope(t){let e,i;const r=this._softVertexData(t),a=r.positions,n=r.normals;if(null===a||null===n)return new this.bjsAMMO.btCompoundShape;r.applyToMesh(t.object,!0),t._isFromLine=!0;if(0===n.map((t=>t*t)).reduce(((t,e)=>t+e)))e=a.length,i=e/3-1,this._tmpAmmoVectorA.setValue(a[0],a[1],a[2]),this._tmpAmmoVectorB.setValue(a[e-3],a[e-2],a[e-1]);else{t._isFromLine=!1;const r=t.getParam("path");if(null===t.getParam("shape"))return s.Y.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;e=r.length,i=e-1,this._tmpAmmoVectorA.setValue(r[0].x,r[0].y,r[0].z),this._tmpAmmoVectorB.setValue(r[e-1].x,r[e-1].y,r[e-1].z)}t.segments=i;let o=t.getParam("fixedPoints");o=o>3?3:o;const h=(new this.bjsAMMO.btSoftBodyHelpers).CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,i-1,o);return h.get_m_cfg().set_collisions(17),h}_createCustom(t){let e=null;return this.onCreateCustomShape&&(e=this.onCreateCustomShape(t)),null==e&&(e=new this.bjsAMMO.btCompoundShape),e}_addHullVerts(t,e,i){let s=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let a=i.getIndices();a||(a=[]);let n=i.getVerticesData(o.o.PositionKind);n||(n=[]),i.computeWorldMatrix(!1);const h=a.length/3;for(let e=0;e<h;e++){const o=[];for(let t=0;t<3;t++){let s,h=new r.P(n[3*a[3*e+t]+0],n[3*a[3*e+t]+1],n[3*a[3*e+t]+2]);r.y3.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),h=r.P.TransformCoordinates(h,this._tmpMatrix),s=0==t?this._tmpAmmoVectorA:1==t?this._tmpAmmoVectorB:this._tmpAmmoVectorC,s.setValue(h.x,h.y,h.z),o.push(s)}t.addPoint(o[0],!0),t.addPoint(o[1],!0),t.addPoint(o[2],!0),s++}i.getChildMeshes().forEach((i=>{s+=this._addHullVerts(t,e,i)}))}return s}_createShape(t,e=!1){const i=t.object;let n;const o=t.getObjectExtents();if(!e){const e=t.object.getChildMeshes?t.object.getChildMeshes(!0):[];n=new this.bjsAMMO.btCompoundShape;let i=0;if(e.forEach((t=>{const e=t.getPhysicsImpostor();if(e){if(e.type==a.Q.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";const s=this._createShape(e),o=t.parent.getWorldMatrix().clone(),h=new r.P;o.decompose(h),this._tmpAmmoTransform.getOrigin().setValue(t.position.x*h.x,t.position.y*h.y,t.position.z*h.z),this._tmpAmmoQuaternion.setValue(t.rotationQuaternion.x,t.rotationQuaternion.y,t.rotationQuaternion.z,t.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),n.addChildShape(this._tmpAmmoTransform,s),e.dispose(),i++}})),i>0){if(t.type!=a.Q.NoImpostor){const e=this._createShape(t,!0);e&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),n.addChildShape(this._tmpAmmoTransform,e))}return n}this.bjsAMMO.destroy(n),n=null}switch(t.type){case a.Q.SphereImpostor:if(u.R.WithinEpsilon(o.x,o.y,1e-4)&&u.R.WithinEpsilon(o.x,o.z,1e-4))n=new this.bjsAMMO.btSphereShape(o.x/2);else{const t=[new this.bjsAMMO.btVector3(0,0,0)],e=[1];n=new this.bjsAMMO.btMultiSphereShape(t,e,1),n.setLocalScaling(new this.bjsAMMO.btVector3(o.x/2,o.y/2,o.z/2))}break;case a.Q.CapsuleImpostor:{const t=o.x/2;n=new this.bjsAMMO.btCapsuleShape(t,o.y-2*t)}break;case a.Q.CylinderImpostor:this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),n=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case a.Q.PlaneImpostor:case a.Q.BoxImpostor:this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),n=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case a.Q.MeshImpostor:if(0==t.getParam("mass")){if(this.onCreateCustomMeshImpostor)n=this.onCreateCustomMeshImpostor(t);else{const e=new this.bjsAMMO.btTriangleMesh;t._pluginData.toDispose.push(e);const r=this._addMeshVerts(e,i,i);n=0==r?new this.bjsAMMO.btCompoundShape:new this.bjsAMMO.btBvhTriangleMeshShape(e)}break}case a.Q.ConvexHullImpostor:if(this.onCreateCustomConvexHullImpostor)n=this.onCreateCustomConvexHullImpostor(t);else{const e=new this.bjsAMMO.btConvexHullShape;0==this._addHullVerts(e,i,i)?(t._pluginData.toDispose.push(e),n=new this.bjsAMMO.btCompoundShape):n=e}break;case a.Q.NoImpostor:n=new this.bjsAMMO.btSphereShape(o.x/2);break;case a.Q.CustomImpostor:n=this._createCustom(t);break;case a.Q.SoftbodyImpostor:n=this._createSoftbody(t);break;case a.Q.ClothImpostor:n=this._createCloth(t);break;case a.Q.RopeImpostor:n=this._createRope(t);break;default:s.Y.Warn("The impostor type is not currently supported by the ammo plugin.")}return n}setTransformationFromPhysicsBody(t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),t.object.rotationQuaternion?t.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):t.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(t.object.rotation))}setPhysicsBodyTransformation(t,e,i){const r=t.physicsBody.getWorldTransform();if(Math.abs(r.getOrigin().x()-e.x)>m.kn||Math.abs(r.getOrigin().y()-e.y)>m.kn||Math.abs(r.getOrigin().z()-e.z)>m.kn||Math.abs(r.getRotation().x()-i.x)>m.kn||Math.abs(r.getRotation().y()-i.y)>m.kn||Math.abs(r.getRotation().z()-i.z)>m.kn||Math.abs(r.getRotation().w()-i.w)>m.kn)if(this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),r.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(i.x,i.y,i.z,i.w),r.setRotation(this._tmpAmmoQuaternion),t.physicsBody.setWorldTransform(r),0==t.mass){const e=t.physicsBody.getMotionState();e&&e.setWorldTransform(r)}else t.physicsBody.activate()}isSupported(){return void 0!==this.bjsAMMO}setLinearVelocity(t,e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),t.soft?t.physicsBody.linearVelocity(this._tmpAmmoVectorA):t.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(t,e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),t.soft?t.physicsBody.angularVelocity(this._tmpAmmoVectorA):t.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(t){let e;if(e=t.soft?t.physicsBody.linearVelocity():t.physicsBody.getLinearVelocity(),!e)return null;const i=new r.P(e.x(),e.y(),e.z());return this.bjsAMMO.destroy(e),i}getAngularVelocity(t){let e;if(e=t.soft?t.physicsBody.angularVelocity():t.physicsBody.getAngularVelocity(),!e)return null;const i=new r.P(e.x(),e.y(),e.z());return this.bjsAMMO.destroy(e),i}setBodyMass(t,e){t.soft?t.physicsBody.setTotalMass(e,!1):t.physicsBody.setMassProps(e),t._pluginData.mass=e}getBodyMass(t){return t._pluginData.mass||0}getBodyFriction(t){return t._pluginData.friction||0}setBodyFriction(t,e){t.soft?t.physicsBody.get_m_cfg().set_kDF(e):t.physicsBody.setFriction(e),t._pluginData.friction=e}getBodyRestitution(t){return t._pluginData.restitution||0}setBodyRestitution(t,e){t.physicsBody.setRestitution(e),t._pluginData.restitution=e}getBodyPressure(t){return t.soft?t._pluginData.pressure||0:(s.Y.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(t,e){t.soft?t.type===a.Q.SoftbodyImpostor?(t.physicsBody.get_m_cfg().set_kPR(e),t._pluginData.pressure=e):(t.physicsBody.get_m_cfg().set_kPR(0),t._pluginData.pressure=0):s.Y.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(t){return t.soft?t._pluginData.stiffness||0:(s.Y.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(t,e){t.soft?(e=(e=e<0?0:e)>1?1:e,t.physicsBody.get_m_materials().at(0).set_m_kLST(e),t._pluginData.stiffness=e):s.Y.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(t){return t.soft?t._pluginData.velocityIterations||0:(s.Y.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(t,e){t.soft?(e=e<0?0:e,t.physicsBody.get_m_cfg().set_viterations(e),t._pluginData.velocityIterations=e):s.Y.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(t){return t.soft?t._pluginData.positionIterations||0:(s.Y.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(t,e){t.soft?(e=e<0?0:e,t.physicsBody.get_m_cfg().set_piterations(e),t._pluginData.positionIterations=e):s.Y.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(t,e,i,r,s=1,a=!1){const n=t.segments,o=Math.round((n-1)*i)+n*(n-1-Math.round((n-1)*r));t.physicsBody.appendAnchor(o,e.physicsBody,a,s)}appendHook(t,e,i,r=1,s=!1){const a=Math.round(t.segments*i);t.physicsBody.appendAnchor(a,e.physicsBody,s,r)}sleepBody(t){t.physicsBody.forceActivationState(0)}wakeUpBody(t){t.physicsBody.activate()}updateDistanceJoint(){s.Y.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(t,e,i){t.physicsJoint.enableAngularMotor(!0,e,i)}setLimit(){s.Y.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(t,e){e.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.position.x=this._tmpAmmoTransform.getOrigin().x(),t.position.y=this._tmpAmmoTransform.getOrigin().y(),t.position.z=this._tmpAmmoTransform.getOrigin().z(),t.rotationQuaternion&&(t.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),t.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),t.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),t.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(t){return t.getObjectExtents().x/2}getBoxSizeToRef(t,e){const i=t.getObjectExtents();e.x=i.x,e.y=i.y,e.z=i.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(t,e){return this.raycastToRef(t,e,this._raycastResult),this._raycastResult}raycastToRef(t,e,i){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(t.x,t.y,t.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(e.x,e.y,e.z);const r=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,r),i.reset(t,e),r.hasHit()&&(i.setHitData({x:r.get_m_hitNormalWorld().x(),y:r.get_m_hitNormalWorld().y(),z:r.get_m_hitNormalWorld().z()},{x:r.get_m_hitPointWorld().x(),y:r.get_m_hitPointWorld().y(),z:r.get_m_hitPointWorld().z()}),i.calculateHitDistance()),this.bjsAMMO.destroy(r),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB)}}p._DISABLE_COLLISION_FLAG=4,p._KINEMATIC_FLAG=2,p._DISABLE_DEACTIVATION_FLAG=4}}]);