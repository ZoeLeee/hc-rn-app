"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[877],{82460:(e,t,s)=>{s.d(t,{s:()=>p});var i=s(84318),r=s(58095),o=s(72208),n=s(59715),a=s(75353),h=s(60604),l=s(62103),c=s(48154);class p{constructor(e=!0,t=10,s=CANNON){this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new r._f,this._minus90X=new r._f(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new r._f(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=r.P.Zero(),this._tmpDeltaPosition=r.P.Zero(),this._tmpUnityRotation=new r._f,this.BJSCANNON=s,this.isSupported()?(this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new h.d):i.Y.Error("CannonJS is not available. Please make sure you included the js file.")}getPluginVersion(){return 1}setGravity(e){const t=e;this.world.gravity.set(t.x,t.y,t.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame){this._firstFrame=!1;for(const e of t)e.type!=n.Q.HeightmapImpostor&&e.type!==n.Q.PlaneImpostor&&e.beforeStep()}this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach((e=>{"function"==typeof this.world.removeBody?this.world.removeBody(e):this.world.remove(e)})),this._physicsBodiesToRemoveAfterStep.length=0)}applyImpulse(e,t,s){const i=new this.BJSCANNON.Vec3(s.x,s.y,s.z),r=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(r,i)}applyForce(e,t,s){const i=new this.BJSCANNON.Vec3(s.x,s.y,s.z),r=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(r,i)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){const t=this._createShape(e);if(!t)return void i.Y.Warn("It was not possible to create a physics body for this object.");const s=e.physicsBody;s&&this.removePhysicsBody(e);const r=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),o={mass:e.getParam("mass"),material:r},n=e.getParam("nativeOptions");for(const e in n)Object.prototype.hasOwnProperty.call(n,e)&&(o[e]=n[e]);e.physicsBody=new this.BJSCANNON.Body(o),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),"function"==typeof this.world.addBody?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),s&&["force","torque","velocity","angularVelocity"].forEach((function(t){const i=s[t];e.physicsBody[t].set(i.x,i.y,i.z)})),this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}}_processChildMeshes(e){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],s=e.object.rotationQuaternion;if(s?s.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){const s=t=>{if(!t.rotationQuaternion)return;const i=t.getPhysicsImpostor();if(i){if(i.parent!==e&&t.parent){const s=t.getAbsolutePosition().subtract(t.parent.getAbsolutePosition()),r=t.rotationQuaternion.multiply(this._tmpQuaternion);i.physicsBody&&(this.removePhysicsBody(i),i.physicsBody=null),i.parent=e,i.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(i),new this.BJSCANNON.Vec3(s.x,s.y,s.z),new this.BJSCANNON.Quaternion(r.x,r.y,r.z,r.w)),e.physicsBody.mass+=i.getParam("mass")}}t.getChildMeshes(!0).filter((e=>!!e.physicsImpostor)).forEach(s)};t.filter((e=>!!e.physicsImpostor)).forEach(s)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),-1===this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,s=e.connectedImpostor.physicsBody;if(!t||!s)return;let i;const r=e.joint.jointData,o={pivotA:r.mainPivot?(new this.BJSCANNON.Vec3).set(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z):null,pivotB:r.connectedPivot?(new this.BJSCANNON.Vec3).set(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z):null,axisA:r.mainAxis?(new this.BJSCANNON.Vec3).set(r.mainAxis.x,r.mainAxis.y,r.mainAxis.z):null,axisB:r.connectedAxis?(new this.BJSCANNON.Vec3).set(r.connectedAxis.x,r.connectedAxis.y,r.connectedAxis.z):null,maxForce:r.nativeParams.maxForce,collideConnected:!!r.collision};switch(e.joint.type){case a.q7.HingeJoint:case a.q7.Hinge2Joint:i=new this.BJSCANNON.HingeConstraint(t,s,o);break;case a.q7.DistanceJoint:i=new this.BJSCANNON.DistanceConstraint(t,s,r.maxDistance||2);break;case a.q7.SpringJoint:{const e=r;i=new this.BJSCANNON.Spring(t,s,{restLength:e.length,stiffness:e.stiffness,damping:e.damping,localAnchorA:o.pivotA,localAnchorB:o.pivotB});break}case a.q7.LockJoint:i=new this.BJSCANNON.LockConstraint(t,s,o);break;case a.q7.PointToPointJoint:case a.q7.BallAndSocketJoint:default:i=new this.BJSCANNON.PointToPointConstraint(t,o.pivotA,s,o.pivotB,o.maxForce)}i.collideConnected=!!r.collision,e.joint.physicsJoint=i,e.joint.type!==a.q7.SpringJoint?this.world.addConstraint(i):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){i.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==a.q7.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,s){let i,r;for(i=0;i<this._physicsMaterials.length;i++)if(r=this._physicsMaterials[i],r.friction===t&&r.restitution===s)return r;const o=new this.BJSCANNON.Material(e);return o.friction=t,o.restitution=s,this._physicsMaterials.push(o),o}_checkWithEpsilon(e){return e<c.kn?c.kn:e}_createShape(e){const t=e.object;let s;const a=e.getObjectExtents();switch(e.type){case n.Q.SphereImpostor:{const e=a.x,t=a.y,i=a.z;s=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(e),this._checkWithEpsilon(t),this._checkWithEpsilon(i))/2);break}case n.Q.CylinderImpostor:{let t=e.getParam("nativeOptions");t||(t={});const i=void 0!==t.radiusTop?t.radiusTop:this._checkWithEpsilon(a.x)/2,r=void 0!==t.radiusBottom?t.radiusBottom:this._checkWithEpsilon(a.x)/2,o=void 0!==t.height?t.height:this._checkWithEpsilon(a.y),n=void 0!==t.numSegments?t.numSegments:16;s=new this.BJSCANNON.Cylinder(i,r,o,n);const h=new this.BJSCANNON.Quaternion;h.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);const l=new this.BJSCANNON.Vec3(0,0,0);s.transformAllPoints(l,h);break}case n.Q.BoxImpostor:{const e=a.scale(.5);s=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(e.x),this._checkWithEpsilon(e.y),this._checkWithEpsilon(e.z)));break}case n.Q.PlaneImpostor:i.Y.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),s=new this.BJSCANNON.Plane;break;case n.Q.MeshImpostor:{const n=t.getVerticesData?t.getVerticesData(o.o.PositionKind):[],a=t.getIndices?t.getIndices():[];if(!n)return void i.Y.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");const h=t.position.clone(),l=t.rotation&&t.rotation.clone(),c=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace();const p=t.computeWorldMatrix(!0),u=new Array;let d;for(d=0;d<n.length;d+=3)r.P.TransformCoordinates(r.P.FromArray(n,d),p).toArray(u,d);i.Y.Warn("MeshImpostor only collides against spheres."),s=new this.BJSCANNON.Trimesh(u,a),t.position.copyFrom(h),l&&t.rotation&&t.rotation.copyFrom(l),c&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(c);break}case n.Q.HeightmapImpostor:{const i=t.position.clone(),r=t.rotation&&t.rotation.clone(),o=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace(),t.rotationQuaternion&&t.rotationQuaternion.multiplyInPlace(this._minus90X),s=this._createHeightmap(t),t.position.copyFrom(i),r&&t.rotation&&t.rotation.copyFrom(r),o&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(o),t.computeWorldMatrix(!0);break}case n.Q.ParticleImpostor:s=new this.BJSCANNON.Particle;break;case n.Q.NoImpostor:s=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0))}return s}_createHeightmap(e,t){let s=e.getVerticesData(o.o.PositionKind);const i=e.computeWorldMatrix(!0),n=new Array;let a;for(a=0;a<s.length;a+=3)r.P.TransformCoordinates(r.P.FromArray(s,a),i).toArray(n,a);s=n;const h=new Array,l=t||~~(Math.sqrt(s.length/3)-1),c=e.getBoundingInfo(),p=Math.min(c.boundingBox.extendSizeWorld.x,c.boundingBox.extendSizeWorld.y),u=c.boundingBox.extendSizeWorld.z,d=2*p/l;for(let e=0;e<s.length;e+=3){const t=Math.round(s[e+0]/d+l/2),i=Math.round(-1*(s[e+1]/d-l/2)),r=-s[e+2]+u;h[t]||(h[t]=[]),h[t][i]||(h[t][i]=r),h[t][i]=Math.max(r,h[t][i])}for(let e=0;e<=l;++e){if(!h[e]){let t=1;for(;!h[(e+t)%l];)t++;h[e]=h[(e+t)%l].slice()}for(let t=0;t<=l;++t)if(!h[e][t]){let s,i=1;for(;void 0===s;)s=h[e][(t+i++)%l];h[e][t]=s}}const g=new this.BJSCANNON.Heightfield(h,{elementSize:d});return g.minY=u,g}_updatePhysicsBodyTransformation(e){const t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;const s=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(s)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(s);let i=t.rotationQuaternion;if(i){if(e.type!==n.Q.PlaneImpostor&&e.type!==n.Q.HeightmapImpostor||(i=i.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===n.Q.HeightmapImpostor){const e=t;let i=e.getBoundingInfo();const o=e.rotationQuaternion;e.rotationQuaternion=this._tmpUnityRotation,e.computeWorldMatrix(!0);const n=s.clone();let a=e.getPivotMatrix();a=a?a.clone():r.y3.Identity();const h=r.y3.Translation(i.boundingBox.extendSizeWorld.x,0,-i.boundingBox.extendSizeWorld.z);e.setPreTransformMatrix(h),e.computeWorldMatrix(!0),i=e.getBoundingInfo();const l=i.boundingBox.centerWorld.subtract(s).subtract(e.position).negate();this._tmpPosition.copyFromFloats(l.x,l.y-i.boundingBox.extendSizeWorld.y,l.z),this._tmpDeltaPosition.copyFrom(i.boundingBox.centerWorld.subtract(n)),this._tmpDeltaPosition.y+=i.boundingBox.extendSizeWorld.y,e.rotationQuaternion=o,e.setPreTransformMatrix(a),e.computeWorldMatrix(!0)}else e.type===n.Q.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){const t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,s){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(s.x,s.y,s.z,s.w)}isSupported(){return void 0!==this.BJSCANNON}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.velocity;return t?new r.P(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new r.P(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,s,i){i||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),s&&this.setLimit(e,s))}setLimit(e,t,s){e.physicsJoint.motorEquation.maxForce=s,e.physicsJoint.motorEquation.minForce=void 0===t?-t:t}syncMeshWithImpostor(e,t){const s=t.physicsBody;e.position.x=s.position.x,e.position.y=s.position.y,e.position.z=s.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=s.quaternion.x,e.rotationQuaternion.y=s.quaternion.y,e.rotationQuaternion.z=s.quaternion.z,e.rotationQuaternion.w=s.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){const s=e.physicsBody.shapes[0];t.x=2*s.halfExtents.x,t.y=2*s.halfExtents.y,t.z=2*s.halfExtents.z}dispose(){}_extendNamespace(){const e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(s,i,r){if(r=r||10,0===(i=i||0))this.internalStep(s),this.time+=s;else{let o=Math.floor((this.time+i)/s)-Math.floor(this.time/s);o=Math.min(o,r)||1;const n=performance.now();for(let e=0;e!==o&&(this.internalStep(s),!(performance.now()-n>1e3*s));e++);this.time+=i;const a=this.time%s/s,h=e,l=this.bodies;for(let e=0;e!==l.length;e++){const s=l[e];s.type!==t.Body.STATIC&&s.sleepState!==t.Body.SLEEPING?(s.position.vsub(s.previousPosition,h),h.scale(a,h),s.position.vadd(h,s.interpolatedPosition)):(s.interpolatedPosition.set(s.position.x,s.position.y,s.position.z),s.interpolatedQuaternion.set(s.quaternion.x,s.quaternion.y,s.quaternion.z,s.quaternion.w))}}}}raycast(e,t){return this._raycastResult.reset(e,t),this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,s){this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),s.reset(e,t),this._cannonRaycastResult.hasHit&&(s.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),s.setHitDistance(this._cannonRaycastResult.distance))}}l.T.DefaultPluginFactory=()=>new p},90371:(e,t,s)=>{s.d(t,{A:()=>l});var i=s(59715),r=s(75353),o=s(58095),n=s(84318),a=s(60604),h=s(48154);class l{constructor(e=!0,t,s=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=o.P.Zero(),this.BJSOIMO=s,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new a.d}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){t.forEach((function(e){e.beforeStep()})),this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step(),t.forEach((e=>{e.afterStep(),this._tmpImpostorsArray[e.uniqueId]=e}));let s=this.world.contacts;for(;null!==s;){if(s.touching&&!s.body1.sleeping&&!s.body2.sleeping){s=s.next;continue}const e=this._tmpImpostorsArray[+s.body1.name],t=this._tmpImpostorsArray[+s.body2.name];e&&t?(e.onCollide({body:t.physicsBody,point:null,distance:0,impulse:0,normal:null}),t.onCollide({body:e.physicsBody,point:null,distance:0,impulse:0,normal:null}),s=s.next):s=s.next}}applyImpulse(e,t,s){const i=e.physicsBody.mass;e.physicsBody.applyImpulse(s.scale(this.world.invScale),t.scale(this.world.invScale*i))}applyForce(e,t,s){n.Y.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,s)}generatePhysicsBody(e){if(e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){const t={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:0!==e.getParam("mass"),density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},s=[e];(e=>{e.getChildMeshes&&e.getChildMeshes().forEach((function(e){e.physicsImpostor&&s.push(e.physicsImpostor)}))})(e.object);const r=e=>Math.max(e,h.kn),a=new o._f;s.forEach((s=>{if(!s.object.rotationQuaternion)return;const o=s.object.rotationQuaternion;a.copyFrom(o),s.object.rotationQuaternion.set(0,0,0,1),s.object.computeWorldMatrix(!0);const h=a.toEulerAngles(),l=s.getObjectExtents(),c=57.29577951308232;if(s===e){const s=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(s,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),t.pos.push(s.x),t.pos.push(s.y),t.pos.push(s.z),t.posShape.push(0,0,0),t.rotShape.push(0,0,0)}else{const e=s.object.position.clone();t.posShape.push(e.x),t.posShape.push(e.y),t.posShape.push(e.z),t.rotShape.push(h.x*c,h.y*c,h.z*c)}switch(s.object.rotationQuaternion.copyFrom(a),s.type){case i.Q.ParticleImpostor:n.Y.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case i.Q.SphereImpostor:{const e=l.x,s=l.y,i=l.z,o=Math.max(r(e),r(s),r(i))/2;t.type.push("sphere"),t.size.push(o),t.size.push(o),t.size.push(o);break}case i.Q.CylinderImpostor:{const e=r(l.x)/2,s=r(l.y);t.type.push("cylinder"),t.size.push(e),t.size.push(s),t.size.push(s);break}case i.Q.PlaneImpostor:case i.Q.BoxImpostor:default:{const e=r(l.x),s=r(l.y),i=r(l.z);t.type.push("box"),t.size.push(e),t.size.push(s),t.size.push(i);break}}s.object.rotationQuaternion=o})),e.physicsBody=this.world.add(t),e.physicsBody.resetQuaternion(a),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,s=e.connectedImpostor.physicsBody;if(!t||!s)return;const i=e.joint.jointData,o=i.nativeParams||{};let a;const h={body1:t,body2:s,axe1:o.axe1||(i.mainAxis?i.mainAxis.asArray():null),axe2:o.axe2||(i.connectedAxis?i.connectedAxis.asArray():null),pos1:o.pos1||(i.mainPivot?i.mainPivot.asArray():null),pos2:o.pos2||(i.connectedPivot?i.connectedPivot.asArray():null),min:o.min,max:o.max,collision:o.collision||i.collision,spring:o.spring,world:this.world};switch(e.joint.type){case r.q7.BallAndSocketJoint:a="jointBall";break;case r.q7.SpringJoint:{n.Y.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");const e=i;h.min=e.length||h.min,h.max=Math.max(h.min,h.max)}case r.q7.DistanceJoint:a="jointDistance",h.max=i.maxDistance;break;case r.q7.PrismaticJoint:a="jointPrisme";break;case r.q7.SliderJoint:a="jointSlide";break;case r.q7.WheelJoint:a="jointWheel";break;case r.q7.HingeJoint:default:a="jointHinge"}h.type=a,e.joint.physicsJoint=this.world.add(h)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(e){n.Y.Warn(e)}}isSupported(){return void 0!==this.BJSOIMO}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{const t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){const t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,s){const i=e.physicsBody;e.physicsBody.shapes.next||(i.position.set(t.x,t.y,t.z),i.orientation.set(s.x,s.y,s.z,s.w),i.syncShapes(),i.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.linearVelocity;return t?new o.P(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new o.P(t.x,t.y,t.z):null}setBodyMass(e,t){const s=0===t;e.physicsBody.shapes.density=s?1:t,e.physicsBody.setupMass(s?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,s){e.physicsJoint.limitMotor.upperLimit=t,void 0!==s&&(e.physicsJoint.limitMotor.lowerLimit=s)}setMotor(e,t,s,i){void 0!==s?n.Y.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):s=1e6,t*=-1;const r=i?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;r&&r.setMotor(t,s)}setLimit(e,t,s,i){const r=i?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;r&&r.setLimit(t,void 0===s?-t:s)}syncMeshWithImpostor(e,t){const s=t.physicsBody;e.position.x=s.position.x,e.position.y=s.position.y,e.position.z=s.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=s.orientation.x,e.rotationQuaternion.y=s.orientation.y,e.rotationQuaternion.z=s.orientation.z,e.rotationQuaternion.w=s.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){const s=e.physicsBody.shapes;t.x=2*s.halfWidth,t.y=2*s.halfHeight,t.z=2*s.halfDepth}dispose(){this.world.clear()}raycast(e,t){return n.Y.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}raycastToRef(e,t,s){n.Y.Warn("raycast is not currently supported by the Oimo physics plugin"),s.reset(e,t)}}},41631:(e,t,s)=>{s(29189),s(62103),s(5214),s(59715),s(75353),s(82460),s(96584),s(90371)},62103:(e,t,s)=>{s.d(t,{T:()=>o});var i=s(58095),r=s(77851);class o{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw(0,r.S)("CannonJSPlugin")}constructor(e,t=o.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new i.P(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach((function(e){e.dispose()})),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){const t=this._impostors.indexOf(e);if(t>-1){this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}}addJoint(e,t,s){const i={mainImpostor:e,connectedImpostor:t,joint:s};s.physicsPlugin=this._physicsPlugin,this._joints.push(i),this._physicsPlugin.generateJoint(i)}removeJoint(e,t,s){const i=this._joints.filter((function(i){return i.connectedImpostor===t&&i.joint===s&&i.mainImpostor===e}));i.length&&this._physicsPlugin.removeJoint(i[0])}_step(e){this._impostors.forEach((e=>{e.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(e)})),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,s){return this._physicsPlugin.raycastToRef(e,t,s)}}},5214:(e,t,s)=>{var i=s(71419),r=s(75353);Object.defineProperty(i.x.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(e){this._physicsImpostor!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add((()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)}))))},enumerable:!0,configurable:!0}),i.x.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},i.x.prototype.applyImpulse=function(e,t){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(e,t),this):this},i.x.prototype.setPhysicsLinkWith=function(e,t,s,i){return this.physicsImpostor&&e.physicsImpostor?(this.physicsImpostor.createJoint(e.physicsImpostor,r.q7.HingeJoint,{mainPivot:t,connectedPivot:s,nativeParams:i}),this):this}},59715:(e,t,s)=>{s.d(t,{Q:()=>c});var i=s(84318),r=s(48939),o=s(58095),n=s(71419),a=s(91243),h=s(75353),l=s(43048);a.Kj._PhysicsImpostorParser=function(e,t,s){return new c(t,s.physicsImpostor,{mass:s.physicsMass,friction:s.physicsFriction,restitution:s.physicsRestitution},e)};class c{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,s={mass:0},r){this.object=e,this.type=t,this._options=s,this._scene=r,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=o.P.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new o._f,this._tmpQuat2=new o._f,this.beforeStep=()=>{this._physicsEngine&&(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new o._f),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach((e=>{e(this)})))},this.afterStep=()=>{this._physicsEngine&&(this._onAfterPhysicsStepCallbacks.forEach((e=>{e(this)})),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,c._TmpVecs[0]),this.object.translate(c._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=e=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent)return;if(!this._physicsEngine)return;const t=this._physicsEngine.getImpostorWithPhysicsBody(e.body);t&&(this.onCollideEvent&&this.onCollideEvent(this,t),this._onPhysicsCollideCallbacks.filter((e=>-1!==e.otherImpostors.indexOf(t))).forEach((s=>{s.callback(this,t,e.point,e.distance,e.impulse,e.normal)})))},this.object?(this.object.parent&&0!==s.mass&&i.Y.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=o._f.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new o._f),this._options.mass=void 0===s.mass?0:s.mass,this._options.friction=void 0===s.friction?.2:s.friction,this._options.restitution=void 0===s.restitution?.2:s.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=void 0===s.pressure?200:s.pressure,this._options.stiffness=void 0===s.stiffness?1:s.stiffness,this._options.velocityIterations=void 0===s.velocityIterations?20:s.velocityIterations,this._options.positionIterations=void 0===s.positionIterations?20:s.positionIterations,this._options.fixedPoints=void 0===s.fixedPoints?0:s.fixedPoints,this._options.margin=void 0===s.margin?0:s.margin,this._options.damping=void 0===s.damping?0:s.damping,this._options.path=void 0===s.path?null:s.path,this._options.shape=void 0===s.shape?null:s.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&i.Y.Warn("You must affect impostors to children before affecting impostor to parent.")):i.Y.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))):i.Y.Error("No object was provided. A physics object is obligatory")}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),this._isDisposed||this.parent&&!this._options.ignoreParent||this._physicsEngine.addImpostor(this))}_getPhysicsParent(){if(this.object.parent instanceof n.x){return this.object.parent.physicsImpostor}return null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){const e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=c.IDENTITY_QUATERNION;const s=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);s&&s.decompose(t,void 0,void 0);const i=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return i.x=Math.abs(i.x),i.y=Math.abs(i.y),i.z=Math.abs(i.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),i}return c.DEFAULT_OBJECT_SIZE}getObjectCenter(){if(this.object.getBoundingInfo){return this.object.getBoundingInfo().boundingBox.centerWorld}return this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):o.P.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):o.P.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){const t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):i.Y.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){const t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):i.Y.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){const s=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:s})}unregisterOnPhysicsCollide(e,t){const s=e instanceof Array?e:[e];let r=-1;this._onPhysicsCollideCallbacks.some(((e,i)=>{if(e.callback===t&&e.otherImpostors.length===s.length){const t=e.otherImpostors.every((e=>s.indexOf(e)>-1));return t&&(r=i),t}return!1}))?this._onPhysicsCollideCallbacks.splice(r,1):i.Y.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):o._f.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,s){const i=new h.q7(t,s);return this.addJoint(e,i),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,s,i,r){if(!this._physicsEngine)return this;const o=this._physicsEngine.getPhysicsPlugin();return o.appendAnchor?(this._physicsEngine&&o.appendAnchor(this,e,t,s,i,r),this):this}addHook(e,t,s,i){if(!this._physicsEngine)return this;const r=this._physicsEngine.getPhysicsPlugin();return r.appendAnchor?(this._physicsEngine&&r.appendHook(this,e,t,s,i),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new c(e,this.type,this._options,this._scene):null}dispose(){this._physicsEngine&&(this._joints.forEach((e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)})),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new o._f),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,s,i,r){const o=c._TmpVecs[0],n=this.object;if(n.rotationQuaternion)if(r){const s=c._TmpQuat;n.rotationQuaternion.multiplyToRef(r,s),e.setRotationQuaternion(s,l.T.WORLD,t)}else e.setRotationQuaternion(n.rotationQuaternion,l.T.WORLD,t);o.x=0,o.y=0,o.z=0,s&&(o.x=s.x,o.y=s.y,o.z=s.z,e.getDirectionToRef(o,t,o),null==i&&(i=s.length()),o.x*=i,o.y*=i,o.z*=i),e.getParent()?(o.addInPlace(n.getAbsolutePosition()),e.setAbsolutePosition(o,t)):(t.setAbsolutePosition(n.getAbsolutePosition()),t.position.x-=o.x,t.position.y-=o.y,t.position.z-=o.z)}syncImpostorWithBone(e,t,s,i,r,o){const n=this.object;if(n.rotationQuaternion)if(r){const s=c._TmpQuat;e.getRotationQuaternionToRef(l.T.WORLD,t,s),s.multiplyToRef(r,n.rotationQuaternion)}else e.getRotationQuaternionToRef(l.T.WORLD,t,n.rotationQuaternion);const a=c._TmpVecs[0],h=c._TmpVecs[1];o||((o=c._TmpVecs[2]).x=0,o.y=1,o.z=0),e.getDirectionToRef(o,t,h),e.getAbsolutePositionToRef(t,a),null==i&&s&&(i=s.length()),null!=i&&(a.x+=h.x*i,a.y+=h.y*i,a.z+=h.z*i),n.setAbsolutePosition(a)}}c.DEFAULT_OBJECT_SIZE=new o.P(1,1,1),c.IDENTITY_QUATERNION=o._f.Identity(),c._TmpVecs=r.B.BuildArray(3,o.P.Zero),c._TmpQuat=o._f.Identity(),c.NoImpostor=0,c.SphereImpostor=1,c.BoxImpostor=2,c.PlaneImpostor=3,c.MeshImpostor=4,c.CapsuleImpostor=6,c.CylinderImpostor=7,c.ParticleImpostor=8,c.HeightmapImpostor=9,c.ConvexHullImpostor=10,c.CustomImpostor=100,c.RopeImpostor=101,c.ClothImpostor=102,c.SoftbodyImpostor=103},75353:(e,t,s)=>{s.d(t,{q7:()=>i});class i{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint,this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}i.DistanceJoint=0,i.HingeJoint=1,i.BallAndSocketJoint=2,i.WheelJoint=3,i.SliderJoint=4,i.PrismaticJoint=5,i.UniversalJoint=6,i.Hinge2Joint=i.WheelJoint,i.PointToPointJoint=8,i.SpringJoint=9,i.LockJoint=10},36135:(e,t,s)=>{s(57933);var i,r,o,n,a,h=s(58095);class l{constructor(e,t){if(this._pluginData=void 0,this._pluginDataInstances=[],this.disablePreStep=!0,!t)return;const s=t.getPhysicsEngine();if(!s)throw new Error("No Physics Engine available.");if(this._physicsEngine=s,2!=s.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const i=s.getPhysicsPlugin();if(!i)throw new Error("No Physics Plugin available.");this._physicsPlugin=i,e.rotationQuaternion||(e.rotationQuaternion=h._f.FromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z));const r=e;r.hasThinInstances?this._physicsPlugin.initBodyInstances(this,r):this._physicsPlugin.initBody(this,e.position,e.rotationQuaternion),this.transformNode=e,e.physicsBody=this,s.addBody(this)}setShape(e){this._physicsPlugin.setShape(this,e)}getShape(){return this._physicsPlugin.getShape(this)}setFilterGroup(e){this._physicsPlugin.setFilterGroup(this,e)}getFilterGroup(){return this._physicsPlugin.getFilterGroup(this)}setEventMask(e){this._physicsPlugin.setEventMask(this,e)}getEventMask(){return this._physicsPlugin.getEventMask(this)}setMassProperties(e){this._physicsPlugin.setMassProperties(this,e)}getMassProperties(){return this._physicsPlugin.getMassProperties(this)}setLinearDamping(e){this._physicsPlugin.setLinearDamping(this,e)}getLinearDamping(){return this._physicsPlugin.getLinearDamping(this)}setAngularDamping(e){this._physicsPlugin.setAngularDamping(this,e)}getAngularDamping(){return this._physicsPlugin.getAngularDamping(this)}setLinearVelocity(e){this._physicsPlugin.setLinearVelocity(this,e)}getLinearVelocityToRef(e){return this._physicsPlugin.getLinearVelocityToRef(this,e)}setAngularVelocity(e){this._physicsPlugin.setAngularVelocity(this,e)}getAngularVelocityToRef(e){return this._physicsPlugin.getAngularVelocityToRef(this,e)}applyImpulse(e,t){this._physicsPlugin.applyImpulse(this,e,t)}applyForce(e,t){this._physicsPlugin.applyForce(this,e,t)}getGeometry(){return this._physicsPlugin.getBodyGeometry(this)}registerOnCollide(e){return this._physicsPlugin.registerOnBodyCollide(this,e)}unregisterOnCollide(e){return this._physicsPlugin.unregisterOnBodyCollide(this,e)}getObjectExtents(){const e=this.transformNode;if(e.getBoundingInfo){const t=this.transformNode.rotationQuaternion,s=this.transformNode.scaling.clone();this.transformNode.rotationQuaternion=l._IDENTITY_QUATERNION;const i=this.transformNode.computeWorldMatrix&&this.transformNode.computeWorldMatrix(!0);i&&i.decompose(s,void 0,void 0);const r=e.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(s);return r.x=Math.abs(r.x),r.y=Math.abs(r.y),r.z=Math.abs(r.z),this.transformNode.rotationQuaternion=t,this.transformNode.computeWorldMatrix&&this.transformNode.computeWorldMatrix(!0),r}return l._DEFAULT_OBJECT_SIZE}getObjectCenter(){return new h.P(0,0,0)}addConstraint(e,t){this._physicsPlugin.addConstraint(this,e,t)}dispose(){this._physicsEngine.removeBody(this),this._physicsPlugin.removeBody(this),this._physicsPlugin.disposeBody(this),this._pluginData=null,this._pluginDataInstances.length=0}}l._DEFAULT_OBJECT_SIZE=new h.P(1,1,1),l._IDENTITY_QUATERNION=h._f.Identity(),function(e){e[e.FREE=0]="FREE",e[e.LIMITED=1]="LIMITED",e[e.LOCKED=2]="LOCKED",e[e.NONE=3]="NONE"}(i||(i={})),function(e){e[e.LINEAR_X=0]="LINEAR_X",e[e.LINEAR_Y=1]="LINEAR_Y",e[e.LINEAR_Z=2]="LINEAR_Z",e[e.ANGULAR_X=3]="ANGULAR_X",e[e.ANGULAR_Y=4]="ANGULAR_Y",e[e.ANGULAR_Z=5]="ANGULAR_Z",e[e.LINEAR_DISTANCE=6]="LINEAR_DISTANCE"}(r||(r={})),function(e){e[e.BALL_AND_SOCKET=1]="BALL_AND_SOCKET",e[e.DISTANCE=2]="DISTANCE",e[e.HINGE=3]="HINGE",e[e.SLIDER=4]="SLIDER",e[e.LOCK=5]="LOCK",e[e.PRISMATIC=6]="PRISMATIC"}(o||(o={})),function(e){e[e.SPHERE=0]="SPHERE",e[e.CAPSULE=1]="CAPSULE",e[e.CYLINDER=2]="CYLINDER",e[e.BOX=3]="BOX",e[e.CONVEX_HULL=4]="CONVEX_HULL",e[e.CONTAINER=5]="CONTAINER",e[e.MESH=6]="MESH",e[e.HEIGHTFIELD=7]="HEIGHTFIELD"}(n||(n={})),function(e){e[e.NONE=0]="NONE",e[e.VELOCITY=1]="VELOCITY",e[e.POSITION=2]="POSITION"}(a||(a={}));s(84318),s(72739)},57933:(e,t,s)=>{s.d(t,{T:()=>n});var i=s(58095),r=s(60604),o=s(77851);class n{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw(0,o.S)("")}constructor(e,t=n.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new i.P(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){const t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,s){this._physicsPlugin.raycast(e,t,s)}raycast(e,t){const s=new r.d;return this._physicsPlugin.raycast(e,t,s),s}}},33404:(e,t,s)=>{s.d(t,{e:()=>b});var i=s(72433),r=s(96969),o=s(62897),n=s(84318),a=s(73803),h=s(19442),l=s(88422),c=s(90216),p=s(63609),u=s(203),d=s(30374),g=s(30485),_=s(67439),f=s(78554),m=s(14563),P=s(48620),y=s(15210),S=s(13514);s(31691);class b extends g.${get automaticBuild(){return this._buildAllowed}set automaticBuild(e){this._buildAllowed=e}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){const e=this.bloom;this.bloom=new m.r(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;const t=this.depthOfField;this.depthOfField=new f.J(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let e=0;e<this._cameras.length;e++)t.disposeEffects(this._cameras[e]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new h.c("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return null!=this._glowLayer}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}constructor(e="",t=!0,s=y.l.LastCreatedScene,i,r=!0){super(s.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=f.z.Low,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new o.y$,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=i||s.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=r,this._scene=s;const n=this._scene.getEngine().getCaps();this._hdr=t&&(n.textureHalfFloatRender||n.textureFloatRender),this._hdr?n.textureHalfFloatRender?this._defaultPipelineTextureType=2:n.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,s.postProcessRenderPipelineManager.addPipeline(this);const h=this._scene.getEngine();this.sharpen=new l.V("sharpen",1,null,a.x.BILINEAR_SAMPLINGMODE,h,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new _.L(h,this.SharpenPostProcessId,(()=>this.sharpen),!0),this.depthOfField=new f.J(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this._hardwareScaleLevel=h.getHardwareScalingLevel(),this._resizeObserver=h.onResizeObservable.add((()=>{this._hardwareScaleLevel=h.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel})),this.bloom=new m.r(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new p.n("ChromaticAberration",h.getRenderWidth(),h.getRenderHeight(),1,null,a.x.BILINEAR_SAMPLINGMODE,h,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new _.L(h,this.ChromaticAberrationPostProcessId,(()=>this.chromaticAberration),!0),this.grain=new u.p("Grain",1,null,a.x.BILINEAR_SAMPLINGMODE,h,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new _.L(h,this.GrainPostProcessId,(()=>this.grain),!0),this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add((()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,S.w1.SetImmediate((()=>{this._buildPipeline()})))})),this._buildPipeline()}getClassName(){return"DefaultRenderingPipeline"}prepare(){const e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;const e=this._scene.getEngine();if(this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(const e of this._cameras){this._scene.enableDepthRenderer(e).useOnlyInActiveCamera=!0}this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add((e=>{this._cameras.indexOf(e.activeCamera)>-1&&(this.depthOfField.depthTexture=e.enableDepthRenderer(e.activeCamera).getDepthMap())}))}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);const e=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=e.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new c.z("imageProcessing",1,null,a.x.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new _.L(e,this.ImageProcessingPostProcessId,(()=>this.imageProcessing),!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._cameras&&0!==this._cameras.length||(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new d.P("fxaa",1,null,a.x.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new _.L(e,this.FxaaPostProcessId,(()=>this.fxaa),!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera))&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add((()=>{this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera)&&(this._scene.autoClear=!0)}))),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add((()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)}))),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&n.Y.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){const s=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(s),this.fxaa&&this.fxaa.dispose(s),e&&(this.sharpen&&this.sharpen.dispose(s),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(s)),this.bloom&&this.bloom.disposeEffects(s),this.chromaticAberration&&this.chromaticAberration.dispose(s),this.grain&&this.grain.dispose(s),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._buildAllowed=!1,this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){const e=r.p4.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,s){return r.p4.Parse((()=>new b(e._name,e._name._hdr,t)),e,t,s)}}(0,i.gn)([(0,r.qC)()],b.prototype,"sharpenEnabled",null),(0,i.gn)([(0,r.qC)()],b.prototype,"bloomKernel",null),(0,i.gn)([(0,r.qC)()],b.prototype,"_bloomWeight",void 0),(0,i.gn)([(0,r.qC)()],b.prototype,"_bloomThreshold",void 0),(0,i.gn)([(0,r.qC)()],b.prototype,"_hdr",void 0),(0,i.gn)([(0,r.qC)()],b.prototype,"bloomWeight",null),(0,i.gn)([(0,r.qC)()],b.prototype,"bloomThreshold",null),(0,i.gn)([(0,r.qC)()],b.prototype,"bloomScale",null),(0,i.gn)([(0,r.qC)()],b.prototype,"bloomEnabled",null),(0,i.gn)([(0,r.qC)()],b.prototype,"depthOfFieldEnabled",null),(0,i.gn)([(0,r.qC)()],b.prototype,"depthOfFieldBlurLevel",null),(0,i.gn)([(0,r.qC)()],b.prototype,"fxaaEnabled",null),(0,i.gn)([(0,r.qC)()],b.prototype,"samples",null),(0,i.gn)([(0,r.qC)()],b.prototype,"imageProcessingEnabled",null),(0,i.gn)([(0,r.qC)()],b.prototype,"glowLayerEnabled",null),(0,i.gn)([(0,r.qC)()],b.prototype,"chromaticAberrationEnabled",null),(0,i.gn)([(0,r.qC)()],b.prototype,"grainEnabled",null),(0,P.H)("BABYLON.DefaultRenderingPipeline",b)},67439:(e,t,s)=>{s.d(t,{L:()=>r});var i=s(13514);class r{constructor(e,t,s,i){this._name=t,this._singleInstance=i||!0,this._getPostProcesses=s,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(const e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){const t=this._postProcesses[e];for(let e=0;e<t.length;e++)if(!t[e].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t;const s=i.w1.MakeArray(e||this._cameras);if(s)for(let e=0;e<s.length;e++){const i=s[e];if(!i)continue;const r=i.name;if(t=this._singleInstance?0:r,!this._postProcesses[t]){const e=this._getPostProcesses();e&&(this._postProcesses[t]=Array.isArray(e)?e:[e])}this._indicesForCamera[r]||(this._indicesForCamera[r]=[]),this._postProcesses[t].forEach((e=>{const t=i.attachPostProcess(e);this._indicesForCamera[r].push(t)})),this._cameras[r]||(this._cameras[r]=i)}}_detachCameras(e){const t=i.w1.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const s=t[e],i=s.name,r=this._postProcesses[this._singleInstance?0:i];r&&r.forEach((e=>{s.detachPostProcess(e)})),this._cameras[i]&&(this._cameras[i]=null)}}_enable(e){const t=i.w1.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const s=t[e],i=s.name;for(let r=0;r<this._indicesForCamera[i].length;r++)void 0!==s._postProcesses[this._indicesForCamera[i][r]]&&null!==s._postProcesses[this._indicesForCamera[i][r]]||this._postProcesses[this._singleInstance?0:i].forEach((s=>{t[e].attachPostProcess(s,this._indicesForCamera[i][r])}))}}_disable(e){const t=i.w1.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const s=t[e],i=s.name;this._postProcesses[this._singleInstance?0:i].forEach((e=>{s.detachPostProcess(e)}))}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}},30485:(e,t,s)=>{s.d(t,{$:()=>n});var i=s(72433),r=s(13514),o=s(96969);class n{get name(){return this._name}get cameras(){return this._cameras}constructor(e,t){this._engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(const e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){const s=this._renderEffects[e];s&&s._enable(r.w1.MakeArray(t||this._cameras))}_disableEffect(e,t){const s=this._renderEffects[e];s&&s._disable(r.w1.MakeArray(t||this._cameras))}_attachCameras(e,t){const s=r.w1.MakeArray(e||this._cameras);if(!s)return;const i=[];let o;for(o=0;o<s.length;o++){const e=s[o];e&&(-1===this._cameras.indexOf(e)?this._cameras.push(e):t&&i.push(o))}for(o=0;o<i.length;o++)s.splice(i[o],1);for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._attachCameras(s)}_detachCameras(e){const t=r.w1.MakeArray(e||this._cameras);if(t){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._detachCameras(t);for(let e=0;e<t.length;e++)this._cameras.splice(this._cameras.indexOf(t[e]),1)}}_update(){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;const t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;const t=Object.keys(this._renderEffects);if(t.length>0){const s=this._renderEffects[t[0]].getPostProcesses();s&&(s[0].samples=e)}return!0}setPrePassRenderer(e){return!1}dispose(){}}(0,i.gn)([(0,o.qC)()],n.prototype,"_name",void 0)},97193:(e,t,s)=>{s.d(t,{a:()=>i});class i{constructor(){this._renderPipelines={}}get supportedPipelines(){const e=[];for(const t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){const s=this._renderPipelines[t];s.isSupported&&e.push(s)}return e}addPipeline(e){this._renderPipelines[e._name]=e}attachCamerasToRenderPipeline(e,t,s=!1){const i=this._renderPipelines[e];i&&i._attachCameras(t,s)}detachCamerasFromRenderPipeline(e,t){const s=this._renderPipelines[e];s&&s._detachCameras(t)}enableEffectInPipeline(e,t,s){const i=this._renderPipelines[e];i&&i._enableEffect(t,s)}disableEffectInPipeline(e,t,s){const i=this._renderPipelines[e];i&&i._disableEffect(t,s)}update(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){const t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){this._renderPipelines[e]._rebuild()}}dispose(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){this._renderPipelines[e].dispose()}}}},31691:(e,t,s)=>{var i=s(85627),r=s(97193),o=s(65273);Object.defineProperty(o.x.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let e=this._getComponent(i.l.NAME_POSTPROCESSRENDERPIPELINEMANAGER);e||(e=new n(this),this._addComponent(e)),this._postProcessRenderPipelineManager=new r.a}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class n{constructor(e){this.name=i.l.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(i.l.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}},92151:(e,t,s)=>{s.d(t,{k:()=>o});var i=s(16142),r=(s(41209),s(48620));class o extends i.D{getClassName(){return"AnaglyphPostProcess"}constructor(e,t,s,i,r,o){super(e,"anaglyph",null,["leftSampler"],t,s[1],i,r,o),this._passedProcess=s[0]._rigPostProcess,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("leftSampler",this._passedProcess)}))}}(0,r.H)("BABYLON.AnaglyphPostProcess",o)},14563:(e,t,s)=>{s.d(t,{r:()=>l});var i=s(67439),r=s(68561),o=s(442),n=s(65932),a=s(58095),h=s(73803);class l extends i.L{get threshold(){return this._downscale.threshold}set threshold(e){this._downscale.threshold=e}get weight(){return this._merge.weight}set weight(e){this._merge.weight=e}get kernel(){return this._blurX.kernel/this._bloomScale}set kernel(e){this._blurX.kernel=e*this._bloomScale,this._blurY.kernel=e*this._bloomScale}constructor(e,t,s,i,l=0,c=!1){super(e.getEngine(),"bloom",(()=>this._effects),!0),this._bloomScale=t,this._effects=[],this._downscale=new r.m("highlights",1,null,h.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,l,c),this._blurX=new o.i("horizontal blur",new a.FM(1,0),10,t,null,h.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,l,void 0,c),this._blurX.alwaysForcePOT=!0,this._blurX.autoClear=!1,this._blurY=new o.i("vertical blur",new a.FM(0,1),10,t,null,h.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,l,void 0,c),this._blurY.alwaysForcePOT=!0,this._blurY.autoClear=!1,this.kernel=i,this._effects=[this._downscale,this._blurX,this._blurY],this._merge=new n.G("bloomMerge",this._downscale,this._blurY,s,t,null,h.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,l,c),this._merge.autoClear=!1,this._effects.push(this._merge)}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}},65932:(e,t,s)=>{s.d(t,{G:()=>a});var i=s(72433),r=s(16142),o=(s(89055),s(48620)),n=s(96969);class a extends r.D{getClassName(){return"BloomMergePostProcess"}constructor(e,t,s,i,r,o,n,a,h,l=0,c=!1){super(e,"bloomMerge",["bloomWeight"],["bloomBlur"],r,o,n,a,h,null,l,void 0,null,!0),this.weight=1,this.weight=i,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("bloomBlur",s),e.setFloat("bloomWeight",this.weight)})),c||this.updateEffect()}}(0,i.gn)([(0,n.qC)()],a.prototype,"weight",void 0),(0,o.H)("BABYLON.BloomMergePostProcess",a)},442:(e,t,s)=>{s.d(t,{i:()=>h});var i=s(72433),r=s(16142),o=s(73803),n=(s(51299),s(53790),s(48620)),a=s(96969);class h extends r.D{set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,s,i,r,n=o.x.BILINEAR_SAMPLINGMODE,a,h,l=0,c="",p=!1,u=5){super(e,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],i,r,n,a,h,null,l,"kernelBlur",{varyingCount:0,depCount:0},!0,u),this._blockCompilation=p,this._packedFloat=!1,this._staticDefines="",this._staticDefines=c,this.direction=t,this.onApplyObservable.add((e=>{this._outputTexture?e.setFloat2("delta",1/this._outputTexture.width*this.direction.x,1/this._outputTexture.height*this.direction.y):e.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)})),this.kernel=s}updateEffect(e=null,t=null,s=null,i,r,o){this._updateParameters(r,o)}_updateParameters(e,t){const s=this._kernel,i=(s-1)/2;let r=[],o=[],n=0;for(let e=0;e<s;e++){const t=e/(s-1),a=this._gaussianWeight(2*t-1);r[e]=e-i,o[e]=a,n+=a}for(let e=0;e<o.length;e++)o[e]/=n;const a=[],h=[],l=[];for(let e=0;e<=i;e+=2){const t=Math.min(e+1,Math.floor(i));if(e===t)l.push({o:r[e],w:o[e]});else{const s=t===i,n=o[e]+o[t]*(s?.5:1),a=r[e]+1/(1+o[e]/o[t]);0===a?(l.push({o:r[e],w:o[e]}),l.push({o:r[e+1],w:o[e+1]})):(l.push({o:a,w:n}),l.push({o:-a,w:n}))}}for(let e=0;e<l.length;e++)h[e]=l[e].o,a[e]=l[e].w;r=h,o=a;const c=this.getEngine().getCaps().maxVaryingVectors,p=Math.max(c,0)-1;let u=Math.min(r.length,p),d="";d+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(d+=`#define CENTER_WEIGHT ${this._glslFloat(o[u-1])}\r\n`,u--);for(let e=0;e<u;e++)d+=`#define KERNEL_OFFSET${e} ${this._glslFloat(r[e])}\r\n`,d+=`#define KERNEL_WEIGHT${e} ${this._glslFloat(o[e])}\r\n`;let g=0;for(let e=p;e<r.length;e++)d+=`#define KERNEL_DEP_OFFSET${g} ${this._glslFloat(r[e])}\r\n`,d+=`#define KERNEL_DEP_WEIGHT${g} ${this._glslFloat(o[e])}\r\n`,g++;this.packedFloat&&(d+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,super.updateEffect(d,null,null,{varyingCount:u,depCount:g},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const e of[t,t-1,t+1,t-2,t+2])if(e%2!=0&&Math.floor(e/2)%2==0&&e>0)return Math.max(e,3);return Math.max(t,3)}_gaussianWeight(e){const t=1/3,s=-e*e/(2*t*t);return 1/(Math.sqrt(2*Math.PI)*t)*Math.exp(s)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}static _Parse(e,t,s,i){return a.p4.Parse((()=>new h(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable,e.textureType,void 0,!1)),e,s,i)}}(0,i.gn)([(0,a.qC)("kernel")],h.prototype,"_kernel",void 0),(0,i.gn)([(0,a.qC)("packedFloat")],h.prototype,"_packedFloat",void 0),(0,i.gn)([(0,a.QC)()],h.prototype,"direction",void 0),(0,n.H)("BABYLON.BlurPostProcess",h)},63609:(e,t,s)=>{s.d(t,{n:()=>h});var i=s(72433),r=s(58095),o=s(16142),n=(s(95217),s(48620)),a=s(96969);class h extends o.D{getClassName(){return"ChromaticAberrationPostProcess"}constructor(e,t,s,i,o,n,a,h,l=0,c=!1){super(e,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],i,o,n,a,h,null,l,void 0,null,c),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new r.FM(.707,.707),this.centerPosition=new r.FM(.5,.5),this.screenWidth=t,this.screenHeight=s,this.onApplyObservable.add((e=>{e.setFloat("chromatic_aberration",this.aberrationAmount),e.setFloat("screen_width",t),e.setFloat("screen_height",s),e.setFloat("radialIntensity",this.radialIntensity),e.setFloat2("direction",this.direction.x,this.direction.y),e.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)}))}static _Parse(e,t,s,i){return a.p4.Parse((()=>new h(e.name,e.screenWidth,e.screenHeight,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable,e.textureType,!1)),e,s,i)}}(0,i.gn)([(0,a.qC)()],h.prototype,"aberrationAmount",void 0),(0,i.gn)([(0,a.qC)()],h.prototype,"radialIntensity",void 0),(0,i.gn)([(0,a.qC)()],h.prototype,"direction",void 0),(0,i.gn)([(0,a.qC)()],h.prototype,"centerPosition",void 0),(0,i.gn)([(0,a.qC)()],h.prototype,"screenWidth",void 0),(0,i.gn)([(0,a.qC)()],h.prototype,"screenHeight",void 0),(0,n.H)("BABYLON.ChromaticAberrationPostProcess",h)},26060:(e,t,s)=>{s.d(t,{N:()=>h});var i=s(72433),r=s(16142),o=s(84318),n=(s(6603),s(48620)),a=s(96969);class h extends r.D{getClassName(){return"CircleOfConfusionPostProcess"}constructor(e,t,s,i,r,n,a,h=0,l=!1){super(e,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],s,i,r,n,a,null,h,void 0,null,l),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50,this._depthTexture=null,this._depthTexture=t,this.onApplyObservable.add((e=>{if(!this._depthTexture)return void o.Y.Warn("No depth texture set on CircleOfConfusionPostProcess");e.setTexture("depthSampler",this._depthTexture);const t=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);e.setFloat("focusDistance",this.focusDistance),e.setFloat("cocPrecalculation",t);const s=this._depthTexture.activeCamera;e.setFloat2("cameraMinMaxZ",s.minZ,s.maxZ-s.minZ)}))}set depthTexture(e){this._depthTexture=e}}(0,i.gn)([(0,a.qC)()],h.prototype,"lensSize",void 0),(0,i.gn)([(0,a.qC)()],h.prototype,"fStop",void 0),(0,i.gn)([(0,a.qC)()],h.prototype,"focusDistance",void 0),(0,i.gn)([(0,a.qC)()],h.prototype,"focalLength",void 0),(0,n.H)("BABYLON.CircleOfConfusionPostProcess",h)},86856:(e,t,s)=>{s.d(t,{T:()=>h});var i=s(72433),r=s(73803),o=s(442),n=s(48620),a=s(96969);class h extends o.i{getClassName(){return"DepthOfFieldBlurPostProcess"}constructor(e,t,s,i,o,n,a,h=null,l=r.x.BILINEAR_SAMPLINGMODE,c,p,u=0,d=!1,g=5){super(e,s,i,o,n,2,c,p,u,"#define DOF 1\r\n",d,g),this.direction=s,this.externalTextureSamplerBinding=!!h,this.onApplyObservable.add((e=>{null!=h&&e.setTextureFromPostProcess("textureSampler",h),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",a)}))}}(0,i.gn)([(0,a.qC)()],h.prototype,"direction",void 0),(0,n.H)("BABYLON.DepthOfFieldBlurPostProcess",h)},78554:(e,t,s)=>{s.d(t,{J:()=>c,z:()=>i});var i,r=s(58095),o=s(73803),n=s(67439),a=s(26060),h=s(86856),l=s(60869);!function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(i||(i={}));class c extends n.L{set focalLength(e){this._circleOfConfusion.focalLength=e}get focalLength(){return this._circleOfConfusion.focalLength}set fStop(e){this._circleOfConfusion.fStop=e}get fStop(){return this._circleOfConfusion.fStop}set focusDistance(e){this._circleOfConfusion.focusDistance=e}get focusDistance(){return this._circleOfConfusion.focusDistance}set lensSize(e){this._circleOfConfusion.lensSize=e}get lensSize(){return this._circleOfConfusion.lensSize}constructor(e,t,s=i.Low,n=0,c=!1){super(e.getEngine(),"depth of field",(()=>this._effects),!0),this._effects=[];const p=e.getEngine(),u=p.isWebGPU||p.webGLVersion>1?6:5;this._circleOfConfusion=new a.N("circleOfConfusion",t,1,null,o.x.BILINEAR_SAMPLINGMODE,p,!1,n,c),this._depthOfFieldBlurY=[],this._depthOfFieldBlurX=[];let d=1,g=15;switch(s){case i.High:d=3,g=51;break;case i.Medium:d=2,g=31;break;default:g=15,d=1}const _=g/Math.pow(2,d-1);let f=1;for(let t=0;t<d;t++){const s=new h.T("vertical blur",e,new r.FM(0,1),_,f,null,this._circleOfConfusion,0==t?this._circleOfConfusion:null,o.x.BILINEAR_SAMPLINGMODE,p,!1,n,c,0==t?u:5);s.autoClear=!1,f=.75/Math.pow(2,t);const i=new h.T("horizontal blur",e,new r.FM(1,0),_,f,null,this._circleOfConfusion,null,o.x.BILINEAR_SAMPLINGMODE,p,!1,n,c);i.autoClear=!1,this._depthOfFieldBlurY.push(s),this._depthOfFieldBlurX.push(i)}this._effects=[this._circleOfConfusion];for(let e=0;e<this._depthOfFieldBlurX.length;e++)this._effects.push(this._depthOfFieldBlurY[e]),this._effects.push(this._depthOfFieldBlurX[e]);this._dofMerge=new l.f("dofMerge",this._circleOfConfusion,this._circleOfConfusion,this._depthOfFieldBlurX,f,null,o.x.BILINEAR_SAMPLINGMODE,p,!1,n,c),this._dofMerge.autoClear=!1,this._effects.push(this._dofMerge)}getClassName(){return"DepthOfFieldEffect"}set depthTexture(e){this._circleOfConfusion.depthTexture=e}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}},60869:(e,t,s)=>{s.d(t,{f:()=>r});var i=s(16142);s(99594);class r extends i.D{getClassName(){return"DepthOfFieldMergePostProcess"}constructor(e,t,s,i,r,o,n,a,h,l=0,c=!1){super(e,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],r,o,n,a,h,null,l,void 0,null,!0),this._blurSteps=i,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",s),i.forEach(((t,s)=>{e.setTextureFromPostProcessOutput("blurStep"+(i.length-s-1),t)}))})),c||this.updateEffect()}updateEffect(e=null,t=null,s=null,i,r,o){e||(e="",e+="#define BLUR_LEVEL "+(this._blurSteps.length-1)+"\n"),super.updateEffect(e,t,s,i,r,o)}}},68561:(e,t,s)=>{s.d(t,{m:()=>h});var i=s(72433),r=s(16142),o=s(48154),n=(s(25655),s(96969)),a=s(48620);class h extends r.D{getClassName(){return"ExtractHighlightsPostProcess"}constructor(e,t,s,i,r,n,a=0,h=!1){super(e,"extractHighlights",["threshold","exposure"],null,t,s,i,r,n,null,a,void 0,null,h),this.threshold=.9,this._exposure=1,this._inputPostProcess=null,this.onApplyObservable.add((e=>{this.externalTextureSamplerBinding=!!this._inputPostProcess,this._inputPostProcess&&e.setTextureFromPostProcess("textureSampler",this._inputPostProcess),e.setFloat("threshold",Math.pow(this.threshold,o.zp)),e.setFloat("exposure",this._exposure)}))}}(0,i.gn)([(0,n.qC)()],h.prototype,"threshold",void 0),(0,a.H)("BABYLON.ExtractHighlightsPostProcess",h)},30374:(e,t,s)=>{s.d(t,{P:()=>a});var i=s(73803),r=s(16142),o=(s(94245),s(67495),s(48620)),n=s(96969);class a extends r.D{getClassName(){return"FxaaPostProcess"}constructor(e,t,s=null,r,o,n,a=0){super(e,"fxaa",["texelSize"],null,t,s,r||i.x.BILINEAR_SAMPLINGMODE,o,n,null,a,"fxaa",void 0,!0);const h=this._getDefines();this.updateEffect(h),this.onApplyObservable.add((e=>{const t=this.texelSize;e.setFloat2("texelSize",t.x,t.y)}))}_getDefines(){const e=this.getEngine();if(!e)return null;const t=e.getGlInfo();return t&&t.renderer&&t.renderer.toLowerCase().indexOf("mali")>-1?"#define MALI 1\n":null}static _Parse(e,t,s,i){return n.p4.Parse((()=>new a(e.name,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable)),e,s,i)}}(0,o.H)("BABYLON.FxaaPostProcess",a)},203:(e,t,s)=>{s.d(t,{p:()=>a});var i=s(72433),r=s(16142),o=(s(67362),s(48620)),n=s(96969);class a extends r.D{getClassName(){return"GrainPostProcess"}constructor(e,t,s,i,r,o,n=0,a=!1){super(e,"grain",["intensity","animatedSeed"],[],t,s,i,r,o,null,n,void 0,null,a),this.intensity=30,this.animated=!1,this.onApplyObservable.add((e=>{e.setFloat("intensity",this.intensity),e.setFloat("animatedSeed",this.animated?Math.random()+1:1)}))}static _Parse(e,t,s,i){return n.p4.Parse((()=>new a(e.name,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable)),e,s,i)}}(0,i.gn)([(0,n.qC)()],a.prototype,"intensity",void 0),(0,i.gn)([(0,n.qC)()],a.prototype,"animated",void 0),(0,o.H)("BABYLON.GrainPostProcess",a)},90216:(e,t,s)=>{s.d(t,{z:()=>h});var i=s(72433),r=s(96969),o=s(90622),n=s(16142),a=s(15210);s(37328),s(80196);class h extends n.D{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,t=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let e=null;const t=this.getEngine(),s=this.getCamera();if(s)e=s.getScene();else if(t&&t.scenes){const s=t.scenes;e=s[s.length-1]}else e=a.l.LastCreatedScene;this._imageProcessingConfiguration=e?e.imageProcessingConfiguration:new o.$}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._updateParameters()}))),t||this._updateParameters()}}get isSupported(){const e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}constructor(e,t,s=null,i,r,o,n=0,a){super(e,"imageProcessing",[],[],t,s,i,r,o,null,n,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},a?(a.applyByPostProcess=!0,this._attachImageProcessingConfiguration(a,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=e=>{this.imageProcessingConfiguration.bind(e,this.aspectRatio)}}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(const t in this._defines)this._defines[t]&&(e+=`#define ${t};\r\n`);const t=["textureSampler"],s=["scale"];o.$&&(o.$.PrepareSamplers(t,this._defines),o.$.PrepareUniforms(s,this._defines)),this.updateEffect(e,s,t)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}(0,i.gn)([(0,r.qC)()],h.prototype,"_fromLinearSpace",void 0)},34898:(e,t,s)=>{s(92151);var i=s(72433),r=s(16142),o=(s(62620),s(48620)),n=s(96969);class a extends r.D{getClassName(){return"BlackAndWhitePostProcess"}constructor(e,t,s,i,r,o){super(e,"blackAndWhite",["degree"],null,t,s,i,r,o),this.degree=1,this.onApplyObservable.add((e=>{e.setFloat("degree",this.degree)}))}static _Parse(e,t,s,i){return n.p4.Parse((()=>new a(e.name,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable)),e,s,i)}}(0,i.gn)([(0,n.qC)()],a.prototype,"degree",void 0),(0,o.H)("BABYLON.BlackAndWhitePostProcess",a);s(14563),s(65932);var h=s(442),l=(s(63609),s(26060),s(73803));s(58907);class c extends r.D{getClassName(){return"ColorCorrectionPostProcess"}constructor(e,t,s,i,r,o,n){super(e,"colorCorrection",null,["colorTable"],s,i,r,o,n);const a=(null==i?void 0:i.getScene())||null;this._colorTableTexture=new l.x(t,a,!0,!1,l.x.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=l.x.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=l.x.CLAMP_ADDRESSMODE,this.colorTableUrl=t,this.onApply=e=>{e.setTexture("colorTable",this._colorTableTexture)}}static _Parse(e,t,s,i){return n.p4.Parse((()=>new c(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable)),e,s,i)}}(0,i.gn)([(0,n.qC)()],c.prototype,"colorTableUrl",void 0),(0,o.H)("BABYLON.ColorCorrectionPostProcess",c);s(94132);class p extends r.D{getClassName(){return"ConvolutionPostProcess"}constructor(e,t,s,i,r,o,n,a=0){super(e,"convolution",["kernel","screenSize"],null,s,i,r,o,n,null,a),this.kernel=t,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setArray("kernel",this.kernel)}}static _Parse(e,t,s,i){return n.p4.Parse((()=>new p(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable,e.textureType)),e,s,i)}}p.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],p.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],p.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],p.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],p.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],p.GaussianKernel=[0,1,0,1,1,1,0,1,0],(0,i.gn)([(0,n.qC)()],p.prototype,"kernel",void 0),(0,o.H)("BABYLON.ConvolutionPostProcess",p);s(86856),s(78554),s(60869),s(31548);class u extends r.D{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,s,i,r,o){super(e,"displayPass",["passSampler"],["passSampler"],t,s,i,r,o)}static _Parse(e,t,s,i){return n.p4.Parse((()=>new u(e.name,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable)),e,s,i)}}(0,o.H)("BABYLON.DisplayPassPostProcess",u);s(68561),s(66583);class d extends r.D{getClassName(){return"FilterPostProcess"}constructor(e,t,s,i,r,o,n){super(e,"filter",["kernelMatrix"],null,s,i,r,o,n),this.kernelMatrix=t,this.onApply=e=>{e.setMatrix("kernelMatrix",this.kernelMatrix)}}static _Parse(e,t,s,i){return n.p4.Parse((()=>new d(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable)),e,s,i)}}(0,i.gn)([(0,n.oQ)()],d.prototype,"kernelMatrix",void 0),(0,o.H)("BABYLON.FilterPostProcess",d);var g=s(30374);s(203),s(12926);s(90216);var _=s(84318),f=s(58095),m=s(73067),P=s(219);s(83534),s(91085),s(39255);class y extends r.D{get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this._motionBlurSamples=e,this._updateEffect()}get isObjectBased(){return this._isObjectBased}set isObjectBased(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}constructor(e,t,s,i,r,o,n,a=0,h=!1,l=!1){super(e,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection","projection"],["velocitySampler","depthSampler"],s,i,r,o,n,"#define GEOMETRY_SUPPORTED\n#define SAMPLES 64.0\n#define OBJECT_BASED",a,void 0,null,h),this.motionStrength=1,this._motionBlurSamples=32,this._isObjectBased=!0,this._forceGeometryBuffer=!1,this._invViewProjection=null,this._previousViewProjection=null,this._forceGeometryBuffer=l,this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=!0)):(t.enablePrePassRenderer(),this._prePassRenderer&&(this._prePassRenderer.markAsDirty(),this._prePassEffectConfiguration=new P.p)),this._applyMode()}excludeSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}t.push(e)}}removeExcludedSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}const s=t.indexOf(e);-1!==s&&t.splice(s,1)}}dispose(e){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),super.dispose(e)}_applyMode(){if(!this._geometryBufferRenderer&&!this._prePassRenderer)return _.Y.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=e=>this._onApplyObjectBased(e)):(this._invViewProjection=f.y3.Identity(),this._previousViewProjection=this._scene.getTransformMatrix().clone(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=e=>this._onApplyScreenBased(e))}_onApplyObjectBased(e){if(e.setVector2("screenSize",new f.FM(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(m.m.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[t])}}_onApplyScreenBased(e){const t=f.jp.Matrix[0];if(t.copyFrom(this._scene.getTransformMatrix()),t.invertToRef(this._invViewProjection),e.setMatrix("inverseViewProjection",this._invViewProjection),e.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection.copyFrom(t),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setVector2("screenSize",new f.FM(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(m.m.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[t])}}_updateEffect(){if(this._geometryBufferRenderer||this._prePassRenderer){const e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join("\n"))}}static _Parse(e,t,s,i){return n.p4.Parse((()=>new y(e.name,s,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable,e.textureType,!1)),e,s,i)}}(0,i.gn)([(0,n.qC)()],y.prototype,"motionStrength",void 0),(0,i.gn)([(0,n.qC)()],y.prototype,"motionBlurSamples",null),(0,i.gn)([(0,n.qC)()],y.prototype,"isObjectBased",null),(0,o.H)("BABYLON.MotionBlurPostProcess",y);var S=s(89815);s(1421),s(84243);class b extends r.D{get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}constructor(e,t,s,i,r,o,n,a,h,c){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],o,n,a,h,c),this._ownRefractionTexture=!0,this.color=s,this.depth=i,this.colorLevel=r,this.refractionTextureUrl=t,this.onActivateObservable.add((e=>{this._refTexture=this._refTexture||new l.x(t,e.getScene())})),this.onApplyObservable.add((e=>{e.setColor3("baseColor",this.color),e.setFloat("depth",this.depth),e.setFloat("colorLevel",this.colorLevel),e.setTexture("refractionSampler",this._refTexture)}))}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,s,i){return n.p4.Parse((()=>new b(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable)),e,s,i)}}(0,i.gn)([(0,n.qC)()],b.prototype,"color",void 0),(0,i.gn)([(0,n.qC)()],b.prototype,"depth",void 0),(0,i.gn)([(0,n.qC)()],b.prototype,"colorLevel",void 0),(0,i.gn)([(0,n.qC)()],b.prototype,"refractionTextureUrl",void 0),(0,o.H)("BABYLON.RefractionPostProcess",b);s(33404);var E=s(93980),x=s(30485),C=s(67439);s(31691),s(95217),s(75883),s(50940);var v=s(2055),R=s(15210),T=s(11563);s(23866),s(42115);class B extends x.${set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set expensiveBlur(e){this._blurHPostProcess.updateEffect("#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16\n#define EXPENSIVE "+(e?"1":"0")+"\n",null,["textureSampler","depthSampler"]),this._blurVPostProcess.updateEffect("#define BILATERAL_BLUR\n#define SAMPLES 16\n#define EXPENSIVE "+(e?"1":"0")+"\n",null,["textureSampler","depthSampler"]),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){const e=R.l.LastCreatedEngine;return!!e&&e._features.supportSSAO2}get scene(){return this._scene}constructor(e,t,s,i,r=!1,o=0){if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this._expensiveBlur=!0,this.radius=2,this.base=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=s,this._forceGeometryBuffer=r,!this.isSupported)return void _.Y.Error("The current engine does not support SSAO 2.");const n=this._ratio.ssaoRatio||s,a=this._ratio.blurRatio||s;this._forceGeometryBuffer?t.enableGeometryBufferRenderer():t.enablePrePassRenderer(),this._createRandomTexture(),this._originalColorPostProcess=new S.Q("SSAOOriginalSceneColor",1,null,l.x.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,o),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,o),this._createBlurPostProcess(n,a,o),this._createSSAOCombinePostProcess(a,o),this.addEffect(new C.L(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new C.L(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new C.L(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new C.L(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new C.L(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),i&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,i)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e,t,s){this._samplerOffsets=[];const i=this.expensiveBlur;for(let e=-8;e<8;e++)this._samplerOffsets.push(2*e+.5);this._blurHPostProcess=new r.D("BlurH","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],e,null,l.x.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16\n#define EXPENSIVE "+(i?"1":"0")+"\n",s),this._blurHPostProcess.onApply=e=>{this._scene.activeCamera&&(e.setFloat("outSize",this._ssaoCombinePostProcess.width>0?this._ssaoCombinePostProcess.width:this._originalColorPostProcess.width),e.setFloat("near",this._scene.activeCamera.minZ),e.setFloat("far",this._scene.activeCamera.maxZ),e.setFloat("radius",this.radius),this._geometryBufferRenderer?e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),e.setArray("samplerOffsets",this._samplerOffsets))},this._blurVPostProcess=new r.D("BlurV","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],t,null,l.x.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_V\n#define SAMPLES 16\n#define EXPENSIVE "+(i?"1":"0")+"\n",s),this._blurVPostProcess.onApply=e=>{this._scene.activeCamera&&(e.setFloat("outSize",this._ssaoCombinePostProcess.height>0?this._ssaoCombinePostProcess.height:this._originalColorPostProcess.height),e.setFloat("near",this._scene.activeCamera.minZ),e.setFloat("far",this._scene.activeCamera.maxZ),e.setFloat("radius",this.radius),this._geometryBufferRenderer?e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),e.setArray("samplerOffsets",this._samplerOffsets))},this._blurHPostProcess.samples=this.textureSamples,this._blurVPostProcess.samples=this.textureSamples}_rebuild(){super._rebuild()}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(1431655765&this._bits[0])<<1|(2863311530&this._bits[0])>>>1>>>0,this._bits[0]=(858993459&this._bits[0])<<2|(3435973836&this._bits[0])>>>2>>>0,this._bits[0]=(252645135&this._bits[0])<<4|(4042322160&this._bits[0])>>>4>>>0,this._bits[0]=(16711935&this._bits[0])<<8|(4278255360&this._bits[0])>>>8>>>0,2.3283064365386963e-10*this._bits[0]}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){const s=2*t*Math.PI,i=1-.85*e,r=Math.sqrt(1-i*i);return new f.P(Math.cos(s)*r,Math.sin(s)*r,i)}_generateHemisphere(){const e=this.samples,t=[];let s,i=0;for(;i<e;){if(e<16)s=this._hemisphereSample_uniform(Math.random(),Math.random());else{const t=this._hammersley(i,e);s=this._hemisphereSample_uniform(t[0],t[1])}t.push(s.x,s.y,s.z),i++}return t}_getDefinesForSSAO(){return"#define SAMPLES "+this.samples+"\n#define SSAO"}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();const s=this._getDefinesForSSAO();this._ssaoPostProcess=new r.D("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","far","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],["randomSampler","depthSampler","normalSampler"],e,null,l.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s,t),this._ssaoPostProcess.onApply=e=>{var t,s,i,r;if(this._scene.activeCamera){if(e.setArray3("sampleSphere",this._sampleSphere),e.setFloat("randTextureTiles",32),e.setFloat("samplesFactor",1/this.samples),e.setFloat("totalStrength",this.totalStrength),e.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),e.setFloat("radius",this.radius),e.setFloat("maxZ",this.maxZ),e.setFloat("minZAspect",this.minZAspect),e.setFloat("base",this.base),e.setFloat("near",this._scene.activeCamera.minZ),e.setFloat("far",this._scene.activeCamera.maxZ),this._scene.activeCamera.mode===v.V.PERSPECTIVE_CAMERA)e.setMatrix3x3("depthProjection",B.PERSPECTIVE_DEPTH_PROJECTION),e.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),e.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{const o=this._scene.getEngine().getRenderWidth()/2,n=this._scene.getEngine().getRenderHeight()/2,a=null!==(t=this._scene.activeCamera.orthoLeft)&&void 0!==t?t:-o,h=null!==(s=this._scene.activeCamera.orthoRight)&&void 0!==s?s:o,l=null!==(i=this._scene.activeCamera.orthoBottom)&&void 0!==i?i:-n,c=null!==(r=this._scene.activeCamera.orthoTop)&&void 0!==r?r:n;e.setMatrix3x3("depthProjection",B.ORTHO_DEPTH_PROJECTION),e.setFloat("xViewport",.5*(h-a)),e.setFloat("yViewport",.5*(c-l))}e.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),e.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),e.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),e.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new T.M)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new r.D("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,l.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t),this._ssaoCombinePostProcess.onApply=e=>{const t=this._scene.activeCamera.viewport;e.setVector4("viewport",f.jp.Vector4[0].copyFromFloats(t.x,t.y,t.width,t.height)),e.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){this._randomTexture=new E.c("SSAORandomTexture",128,this._scene,!1,l.x.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=l.x.WRAP_ADDRESSMODE,this._randomTexture.wrapV=l.x.WRAP_ADDRESSMODE;const e=this._randomTexture.getContext(),t=(e,t)=>Math.random()*(t-e)+e,s=f.P.Zero();for(let i=0;i<128;i++)for(let r=0;r<128;r++)s.x=t(0,1),s.y=t(0,1),s.z=0,s.normalize(),s.scaleInPlace(255),s.x=Math.floor(s.x),s.y=Math.floor(s.y),e.fillStyle="rgb("+s.x+", "+s.y+", "+s.z+")",e.fillRect(i,r,1,1);this._randomTexture.update(!1)}serialize(){const e=n.p4.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,s){return n.p4.Parse((()=>new B(e._name,t,e._ratio)),e,t,s)}}B.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],B.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],(0,i.gn)([(0,n.qC)()],B.prototype,"totalStrength",void 0),(0,i.gn)([(0,n.qC)()],B.prototype,"maxZ",void 0),(0,i.gn)([(0,n.qC)()],B.prototype,"minZAspect",void 0),(0,i.gn)([(0,n.qC)("samples")],B.prototype,"_samples",void 0),(0,i.gn)([(0,n.qC)("textureSamples")],B.prototype,"_textureSamples",void 0),(0,i.gn)([(0,n.qC)()],B.prototype,"_ratio",void 0),(0,i.gn)([(0,n.qC)("expensiveBlur")],B.prototype,"_expensiveBlur",void 0),(0,i.gn)([(0,n.qC)()],B.prototype,"radius",void 0),(0,i.gn)([(0,n.qC)()],B.prototype,"base",void 0),(0,o.H)("BABYLON.SSAO2RenderingPipeline",B);s(80969);class A extends x.${get scene(){return this._scene}constructor(e,t,s,i){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();const r=s.ssaoRatio||s,o=s.combineRatio||s;this._originalColorPostProcess=new S.Q("SSAOOriginalSceneColor",o,null,l.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(r),this._createBlurPostProcess(r),this._createSSAOCombinePostProcess(o),this.addEffect(new C.L(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new C.L(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new C.L(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new C.L(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new C.L(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),i&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,i)}_attachCameras(e,t){super._attachCameras(e,t);for(const e of this._cameras)this._scene.enableDepthRenderer(e).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new h.i("BlurH",new f.FM(1,0),16,e,null,l.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new h.i("BlurV",new f.FM(0,1),16,e,null,l.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add((()=>{const e=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*e})),this._blurVPostProcess.onActivateObservable.add((()=>{const e=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*e}))}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){const t=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];this._ssaoPostProcess=new r.D("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,l.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES 16\n#define SSAO"),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=e=>{this._firstUpdate&&(e.setArray3("sampleSphere",t),e.setFloat("samplesFactor",.0625),e.setFloat("randTextureTiles",4)),e.setFloat("totalStrength",this.totalStrength),e.setFloat("radius",this.radius),e.setFloat("area",this.area),e.setFloat("fallOff",this.fallOff),e.setFloat("base",this.base),e.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),e.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new r.D("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,l.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=e=>{e.setVector4("viewport",f.jp.Vector4[0].copyFromFloats(0,0,1,1)),e.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){this._randomTexture=new E.c("SSAORandomTexture",512,this._scene,!1,l.x.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=l.x.WRAP_ADDRESSMODE,this._randomTexture.wrapV=l.x.WRAP_ADDRESSMODE;const e=this._randomTexture.getContext(),t=(e,t)=>Math.random()*(t-e)+e,s=f.P.Zero();for(let i=0;i<512;i++)for(let r=0;r<512;r++)s.x=Math.floor(255*Math.max(0,t(-1,1))),s.y=Math.floor(255*Math.max(0,t(-1,1))),s.z=Math.floor(255*Math.max(0,t(-1,1))),e.fillStyle="rgb("+s.x+", "+s.y+", "+s.z+")",e.fillRect(i,r,1,1);this._randomTexture.update(!1)}}(0,i.gn)([(0,n.qC)()],A.prototype,"totalStrength",void 0),(0,i.gn)([(0,n.qC)()],A.prototype,"radius",void 0),(0,i.gn)([(0,n.qC)()],A.prototype,"area",void 0),(0,i.gn)([(0,n.qC)()],A.prototype,"fallOff",void 0),(0,i.gn)([(0,n.qC)()],A.prototype,"base",void 0);var O=s(72739),M=s(74405);s(47613);class I extends r.D{get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}constructor(e,t,s,i,r,o,n,a=0,h=!1,l=!1){if(super(e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],s,i,r,o,n,"#define SSR_SUPPORTED\n#define REFLECTION_SAMPLES 64\n#define SMOOTH_STEPS 5\n",a,void 0,null,h),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this._forceGeometryBuffer=!1,this._enableSmoothReflections=!1,this._reflectionSamples=64,this._smoothSteps=5,this._forceGeometryBuffer=l,this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&e.isSupported&&(e.enablePosition=!0,e.enableReflectivity=!0)}else{const e=t.enablePrePassRenderer();null==e||e.markAsDirty(),this._prePassEffectConfiguration=new M.y}this._updateEffectDefines(),this.onApply=e=>{const s=this._geometryBufferRenderer,i=this._prePassRenderer;if(!i&&!s)return;if(s){const t=s.getTextureIndex(m.m.POSITION_TEXTURE_TYPE),i=s.getTextureIndex(m.m.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",s.getGBuffer().textures[1]),e.setTexture("positionSampler",s.getGBuffer().textures[t]),e.setTexture("reflectivitySampler",s.getGBuffer().textures[i])}else if(i){const t=i.getIndex(1),s=i.getIndex(3),r=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[r]),e.setTexture("positionSampler",i.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",i.getRenderTarget().textures[s])}const r=t.activeCamera;if(!r)return;const o=r.getViewMatrix(!0),n=r.getProjectionMatrix(!0);e.setMatrix("projection",n),e.setMatrix("view",o),e.setFloat("threshold",this.threshold),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("roughnessFactor",this.roughnessFactor)},this._isSceneRightHanded=t.useRightHandedSystem}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get reflectionSamples(){return this._reflectionSamples}set reflectionSamples(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())}get smoothSteps(){return this._smoothSteps}set smoothSteps(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())}_updateEffectDefines(){const e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(this._reflectionSamples>>0)),e.push("#define SMOOTH_STEPS "+(this._smoothSteps>>0)),this.updateEffect(e.join("\n"))}static _Parse(e,t,s,i){return n.p4.Parse((()=>new I(e.name,s,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.textureType,e.reusable)),e,s,i)}}(0,i.gn)([(0,n.qC)()],I.prototype,"threshold",void 0),(0,i.gn)([(0,n.qC)()],I.prototype,"strength",void 0),(0,i.gn)([(0,n.qC)()],I.prototype,"reflectionSpecularFalloffExponent",void 0),(0,i.gn)([(0,n.qC)()],I.prototype,"step",void 0),(0,i.gn)([(0,n.qC)()],I.prototype,"roughnessFactor",void 0),(0,i.gn)([(0,n.qC)()],I.prototype,"enableSmoothReflections",null),(0,i.gn)([(0,n.qC)()],I.prototype,"reflectionSamples",null),(0,i.gn)([(0,n.qC)()],I.prototype,"smoothSteps",null),(0,o.H)("BABYLON.ScreenSpaceReflectionPostProcess",I);s(82298);class F extends x.${get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){const t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join("\n"))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){const t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e){if(!this._scene.enableGeometryBufferRenderer())return void _.Y.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline")}this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}constructor(e,t,s,i=null,r){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=r||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=i,this._ratio=s,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}_buildPipeline(){const e=this._ratio,t=this._scene;this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new I("HDRPass",t,e,null,l.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess})),this.addEffect(new C.L(t.getEngine(),"HDRScreenSpaceReflections",(()=>this.screenSpaceReflectionPostProcess),!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new r.D("HDRPass","standard",[],[],e,null,l.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.originalPostProcess})),this.addEffect(new C.L(t.getEngine(),"HDRPassPostProcess",(()=>this.originalPostProcess),!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new r.D("HDRDepthOfFieldSource","standard",[],[],e,null,l.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new C.L(t.getEngine(),"HDRBaseDepthOfFieldSource",(()=>this.textureAdderFinalPostProcess),!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new r.D("HDRVLSFinal","standard",[],[],e,null,l.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new C.L(t.getEngine(),"HDRVLSFinal",(()=>this.volumetricLightFinalPostProcess),!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new r.D("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,l.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new C.L(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",(()=>this.lensFlareFinalPostProcess),!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new r.D("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,l.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new C.L(t.getEngine(),"HDRPostHDReDepthOfFieldSource",(()=>this.hdrFinalPostProcess),!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new g.P("fxaa",1,null,l.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new C.L(t.getEngine(),"HDRFxaa",(()=>this.fxaaPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&_.Y.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){const s=new Array(32);this.downSampleX4PostProcess=new r.D("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=e=>{let t=0;const i=this.downSampleX4PostProcess.width,r=this.downSampleX4PostProcess.height;for(let e=-2;e<2;e++)for(let o=-2;o<2;o++)s[t]=(e+.5)*(1/i),s[t+1]=(o+.5)*(1/r),t+=2;e.setArray2("dsOffsets",s)},this.addEffect(new C.L(e.getEngine(),"HDRDownSampleX4",(()=>this.downSampleX4PostProcess),!0))}_createBrightPassPostProcess(e,t){const s=new Array(8);this.brightPassPostProcess=new r.D("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=e=>{const t=1/this.brightPassPostProcess.width,i=1/this.brightPassPostProcess.height;s[0]=-.5*t,s[1]=.5*i,s[2]=.5*t,s[3]=.5*i,s[4]=-.5*t,s[5]=-.5*i,s[6]=.5*t,s[7]=-.5*i,e.setArray2("dsOffsets",s),e.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new C.L(e.getEngine(),"HDRBrightPass",(()=>this.brightPassPostProcess),!0))}_createBlurPostProcesses(e,t,s,i="blurWidth"){const r=e.getEngine(),o=new h.i("HDRBlurH_"+s,new f.FM(1,0),this[i],t,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),n=new h.i("HDRBlurV_"+s,new f.FM(0,1),this[i],t,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);o.onActivateObservable.add((()=>{const e=o.width/r.getRenderWidth();o.kernel=this[i]*e})),n.onActivateObservable.add((()=>{const e=n.height/r.getRenderHeight();n.kernel=this.horizontalBlur?64*e:this[i]*e})),this.addEffect(new C.L(e.getEngine(),"HDRBlurH"+s,(()=>o),!0)),this.addEffect(new C.L(e.getEngine(),"HDRBlurV"+s,(()=>n),!0)),this.blurHPostProcesses.push(o),this.blurVPostProcesses.push(n)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new r.D("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),e.setTexture("lensSampler",this.lensTexture),e.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new C.L(e.getEngine(),"HDRTextureAdder",(()=>this.textureAdderPostProcess),!0))}_createVolumetricLightPostProcess(e,t){const s=e.enableGeometryBufferRenderer();s.enablePosition=!0;const i=s.getGBuffer();this.volumetricLightPostProcess=new r.D("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLS\n#define NB_STEPS "+this._volumetricLightStepsCount.toFixed(1));const o=f.FM.Zero();this.volumetricLightPostProcess.onApply=e=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){const t=this.sourceLight.getShadowGenerator();e.setTexture("shadowMapSampler",t.getShadowMap()),e.setTexture("positionSampler",i.textures[2]),e.setColor3("sunColor",this.sourceLight.diffuse),e.setVector3("sunDirection",this.sourceLight.getShadowDirection()),e.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),e.setMatrix("shadowViewProjection",t.getTransformMatrix()),e.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),e.setFloat("scatteringPower",this.volumetricLightPower),o.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),o.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),e.setVector2("depthValues",o)}},this.addEffect(new C.L(e.getEngine(),"HDRVLS",(()=>this.volumetricLightPostProcess),!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new r.D("HDRVLSMerge","standard",[],["originalSampler"],t,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=e=>{e.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new C.L(e.getEngine(),"HDRVLSMerge",(()=>this.volumetricLightMergePostProces),!0))}_createLuminancePostProcesses(e,t){let s=Math.pow(3,F.LuminanceSteps);this.luminancePostProcess=new r.D("HDRLuminance","standard",["lumOffsets"],[],{width:s,height:s},null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);const i=[];this.luminancePostProcess.onApply=e=>{const t=1/this.luminancePostProcess.width,s=1/this.luminancePostProcess.height;i[0]=-.5*t,i[1]=.5*s,i[2]=.5*t,i[3]=.5*s,i[4]=-.5*t,i[5]=-.5*s,i[6]=.5*t,i[7]=-.5*s,e.setArray2("lumOffsets",i)},this.addEffect(new C.L(e.getEngine(),"HDRLuminance",(()=>this.luminancePostProcess),!0));for(let i=F.LuminanceSteps-1;i>=0;i--){s=Math.pow(3,i);let o="#define LUMINANCE_DOWN_SAMPLE\n";0===i&&(o+="#define FINAL_DOWN_SAMPLER");const n=new r.D("HDRLuminanceDownSample"+i,"standard",["dsOffsets","halfDestPixelSize"],[],{width:s,height:s},null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,o,t);this.luminanceDownSamplePostProcesses.push(n)}let o=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(((t,s)=>{const i=new Array(18);t.onApply=e=>{if(!o)return;let r=0;for(let e=-1;e<2;e++)for(let t=-1;t<2;t++)i[r]=e/o.width,i[r+1]=t/o.height,r+=2;e.setArray2("dsOffsets",i),e.setFloat("halfDestPixelSize",.5/o.width),o=s===this.luminanceDownSamplePostProcesses.length-1?this.luminancePostProcess:t},s===this.luminanceDownSamplePostProcesses.length-1&&(t.onAfterRender=()=>{const t=e.getEngine().readPixels(0,0,1,1),s=new f.Lt(1/16581375,1/65025,1/255,1);t.then((e=>{const t=new Uint8Array(e.buffer);this._hdrCurrentLuminance=(t[0]*s.x+t[1]*s.y+t[2]*s.z+t[3]*s.w)/100}))}),this.addEffect(new C.L(e.getEngine(),"HDRLuminanceDownSample"+s,(()=>t),!0))}))}_createHdrPostProcess(e,t){const s=["#define HDR"];this._hdrAutoExposure&&s.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new r.D("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s.join("\n"),0);let i=1,o=0,n=0;this.hdrPostProcess.onApply=t=>{if(t.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),o+=e.getEngine().getDeltaTime(),i<0)i=this._hdrCurrentLuminance;else{const e=(n-o)/1e3;this._hdrCurrentLuminance<i+this.hdrDecreaseRate*e?i+=this.hdrDecreaseRate*e:this._hdrCurrentLuminance>i-this.hdrIncreaseRate*e?i-=this.hdrIncreaseRate*e:i=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/i:(i=O.R.Clamp(i,this.hdrMinimumLuminance,1e20),t.setFloat("averageLuminance",i)),n=o,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new C.L(e.getEngine(),"HDR",(()=>this.hdrPostProcess),!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new r.D("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new C.L(e.getEngine(),"HDRLensFlare",(()=>this.lensFlarePostProcess),!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new r.D("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new C.L(e.getEngine(),"HDRLensFlareCompose",(()=>this.lensFlareComposePostProcess),!0));const s=new f.FM(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=e=>{e.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),e.setTexture("lensColorSampler",this.lensColorTexture),e.setFloat("strength",this.lensFlareStrength),e.setFloat("ghostDispersal",this.lensFlareGhostDispersal),e.setFloat("haloWidth",this.lensFlareHaloWidth),s.x=this.lensFlarePostProcess.width,s.y=this.lensFlarePostProcess.height,e.setVector2("resolution",s),e.setFloat("distortionStrength",this.lensFlareDistortionStrength)};const i=f.y3.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),o=f.y3.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=e=>{if(!this._scene.activeCamera)return;e.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),e.setTexture("lensDirtSampler",this.lensFlareDirtTexture),e.setTexture("lensStarSampler",this.lensStarTexture);const t=this._scene.activeCamera.getViewMatrix().getRow(0),s=this._scene.activeCamera.getViewMatrix().getRow(2);let r=f.P.Dot(t.toVector3(),new f.P(1,0,0))+f.P.Dot(s.toVector3(),new f.P(0,0,1));r*=4;const n=f.y3.FromValues(.5*Math.cos(r),-Math.sin(r),0,0,Math.sin(r),.5*Math.cos(r),0,0,0,0,1,0,0,0,0,1),a=o.multiply(n).multiply(i);e.setMatrix("lensStarMatrix",a),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new r.D("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),e.setTexture("depthSampler",this._getDepthTexture()),e.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new C.L(e.getEngine(),"HDRDepthOfField",(()=>this.depthOfFieldPostProcess),!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){const s=new y("HDRMotionBlur",e,t,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);s.motionStrength=this.motionStrength,s.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=s}else{this.motionBlurPostProcess=new r.D("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,l.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),0);let s=0,i=f.y3.Identity();const o=f.y3.Identity();let n=f.y3.Identity();const a=f.FM.Zero();this.motionBlurPostProcess.onApply=t=>{n=e.getProjectionMatrix().multiply(e.getViewMatrix()),n.invertToRef(o),t.setMatrix("inverseViewProjection",o),t.setMatrix("prevViewProjection",i),i=n,a.x=this.motionBlurPostProcess.width,a.y=this.motionBlurPostProcess.height,t.setVector2("screenSize",a),s=e.getEngine().getFps()/60,t.setFloat("motionScale",s),t.setFloat("motionStrength",this.motionStrength),t.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new C.L(e.getEngine(),"HDRMotionBlur",(()=>this.motionBlurPostProcess),!0))}_getDepthTexture(){if(this._scene.getEngine().getCaps().drawBuffersExtension){return this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]}return this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let e=0;e<this.luminanceDownSamplePostProcesses.length;e++)this.luminanceDownSamplePostProcesses[e].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let e=0;e<this.blurHPostProcesses.length;e++)this.blurHPostProcesses[e].dispose(t);for(let e=0;e<this.blurVPostProcesses.length;e++)this.blurVPostProcesses[e].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}serialize(){const e=n.p4.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=n.p4.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,s){const i=n.p4.Parse((()=>new F(e._name,t,e._ratio)),e,t,s);return e.sourceLightId&&(i.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&n.p4.Parse((()=>i.screenSpaceReflectionPostProcess),e.screenSpaceReflectionPostProcess,t,s),i}}F.LuminanceSteps=6,(0,i.gn)([(0,n.qC)()],F.prototype,"brightThreshold",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"blurWidth",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"horizontalBlur",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"exposure",null),(0,i.gn)([(0,n.oU)("lensTexture")],F.prototype,"lensTexture",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"volumetricLightCoefficient",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"volumetricLightPower",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"volumetricLightBlurScale",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"hdrMinimumLuminance",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"hdrDecreaseRate",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"hdrIncreaseRate",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"hdrAutoExposure",null),(0,i.gn)([(0,n.oU)("lensColorTexture")],F.prototype,"lensColorTexture",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"lensFlareStrength",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"lensFlareGhostDispersal",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"lensFlareHaloWidth",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"lensFlareDistortionStrength",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"lensFlareBlurWidth",void 0),(0,i.gn)([(0,n.oU)("lensStarTexture")],F.prototype,"lensStarTexture",void 0),(0,i.gn)([(0,n.oU)("lensFlareDirtTexture")],F.prototype,"lensFlareDirtTexture",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"depthOfFieldDistance",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"depthOfFieldBlurWidth",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"motionStrength",null),(0,i.gn)([(0,n.qC)()],F.prototype,"objectBasedMotionBlur",null),(0,i.gn)([(0,n.qC)()],F.prototype,"_ratio",void 0),(0,i.gn)([(0,n.qC)()],F.prototype,"BloomEnabled",null),(0,i.gn)([(0,n.qC)()],F.prototype,"DepthOfFieldEnabled",null),(0,i.gn)([(0,n.qC)()],F.prototype,"LensFlareEnabled",null),(0,i.gn)([(0,n.qC)()],F.prototype,"HDREnabled",null),(0,i.gn)([(0,n.qC)()],F.prototype,"VLSEnabled",null),(0,i.gn)([(0,n.qC)()],F.prototype,"MotionBlurEnabled",null),(0,i.gn)([(0,n.qC)()],F.prototype,"fxaaEnabled",null),(0,i.gn)([(0,n.qC)()],F.prototype,"screenSpaceReflectionsEnabled",null),(0,i.gn)([(0,n.qC)()],F.prototype,"volumetricLightStepsCount",null),(0,i.gn)([(0,n.qC)()],F.prototype,"motionBlurSamples",null),(0,i.gn)([(0,n.qC)()],F.prototype,"samples",null),(0,o.H)("BABYLON.StandardRenderingPipeline",F);var w=s(36734),L=s(42585);s(15006),s(64932),s(10255);const D=f.y3.Compose(new f.P(.5,.5,.5),f._f.Identity(),new f.P(.5,.5,.5)),N=f.y3.Compose(new f.P(.5,.5,1),f._f.Identity(),new f.P(.5,.5,0));class j extends x.${set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}get blurDispersionStrength(){return this._blurDispersionStrength}set blurDispersionStrength(e){if(e===this._blurDispersionStrength)return;const t=0===e&&0!==this._blurDispersionStrength||0!==e&&0===this._blurDispersionStrength;this._blurDispersionStrength=e,t&&this._buildPipeline()}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._buildPipeline())}get backfaceDepthRenderer(){return this._depthRenderer}get backfaceDepthTextureSizeFactor(){return this._backfaceDepthTextureSizeFactor}set backfaceDepthTextureSizeFactor(e){this._backfaceDepthTextureSizeFactor!==e&&(this._backfaceDepthTextureSizeFactor=e,this._resizeDepthRenderer())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._buildPipeline())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get scene(){return this._scene}constructor(e,t,s,i=!1,r=0){if(super(t.getEngine(),e),this.SSRRenderEffect="SSRRenderEffect",this.SSRBlurRenderEffect="SSRBlurRenderEffect",this.SSRCombineRenderEffect="SSRCombineRenderEffect",this._samples=1,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this._blurDispersionStrength=.05,this.blurQuality=2,this._enableSmoothReflections=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._enableAutomaticThicknessComputation=!1,this._backfaceDepthTextureSizeFactor=1,this._isEnabled=!0,this._debug=!1,this._forceGeometryBuffer=!1,this._isDirty=!1,this._camerasToBeAttached=[],this._cameras=s||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=r,this._forceGeometryBuffer=i,this.isSupported){if(t.postProcessRenderPipelineManager.addPipeline(this),this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&(e.enableReflectivity=!0)}else{const e=t.enablePrePassRenderer();null==e||e.markAsDirty()}this._buildPipeline()}else _.Y.Error("The current engine does not support SSR.")}getClassName(){return"SSRRenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(e=!1){this._disposeDepthRenderer(),this._disposePostProcesses(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}_getTextureSize(){const e=this._scene.getEngine(),t=this._geometryBufferRenderer,s=this._prePassRenderer;let i={width:e.getRenderWidth(),height:e.getRenderHeight()};if(t)i=t.getGBuffer().textures[0].getSize();else if(s){const e=s.getIndex(5),t=s.getRenderTarget();t&&t.textures&&(i=t.textures[e].getSize())}return i}_updateEffectDefines(){var e;const t=[];(this._geometryBufferRenderer||this._prePassRenderer)&&t.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&t.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&t.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._environmentTexture&&(t.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&t.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC")),this._environmentTextureIsProbe&&t.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&t.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&t.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&t.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateFacingCamera&&t.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&t.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&t.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this._blurDispersionStrength>0&&t.push("#define SSR_USE_BLUR"),this._debug&&t.push("#define SSRAYTRACE_DEBUG"),null===(e=this._ssrPostProcess)||void 0===e||e.updateEffect(t.join("\n"))}_buildPipeline(){var e;if(!this._isEnabled)return void(this._isDirty=!0);this._isDirty=!1;const t=this._scene.getEngine();if(this._disposeDepthRenderer(),this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._enableAutomaticThicknessComputation){const t=null===(e=this._cameras)||void 0===e?void 0:e[0];t&&(this._depthRendererCamera=t,this._depthRenderer=new L.g(this._scene,void 0,void 0,void 0,1,!0,"SSRBackDepth"),this._depthRenderer.clearColor.r=1e8,this._depthRenderer.reverseCulling=!0,this._depthRenderer.getDepthMap().noPrePassRenderer=!0,this._resizeDepthRenderer(),t.customRenderTargets.push(this._depthRenderer.getDepthMap()))}this._createSSRPostProcess(),this.addEffect(new C.L(t,this.SSRRenderEffect,(()=>this._ssrPostProcess),!0)),this._blurDispersionStrength>0&&(this._createBlurAndCombinerPostProcesses(),this.addEffect(new C.L(t,this.SSRBlurRenderEffect,(()=>[this._blurPostProcessX,this._blurPostProcessY]),!0)),this.addEffect(new C.L(t,this.SSRCombineRenderEffect,(()=>this._blurCombinerPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_resizeDepthRenderer(){if(!this._depthRenderer)return;const e=this._getTextureSize(),t=this._depthRenderer.getDepthMap().getSize(),s=Math.floor(e.width/this._backfaceDepthTextureSizeFactor),i=Math.floor(e.height/this._backfaceDepthTextureSizeFactor);t.width===s&&t.height===i||this._depthRenderer.getDepthMap().resize({width:s,height:i})}_disposeDepthRenderer(){var e;if(this._depthRenderer){if(this._depthRendererCamera){const t=null!==(e=this._depthRendererCamera.customRenderTargets.indexOf(this._depthRenderer.getDepthMap()))&&void 0!==e?e:-1;-1!==t&&this._depthRendererCamera.customRenderTargets.splice(t,1)}this._depthRendererCamera=null,this._depthRenderer.getDepthMap().dispose()}this._depthRenderer=null}_disposePostProcesses(){var e,t,s,i;for(let r=0;r<this._cameras.length;r++){const o=this._cameras[r];null===(e=this._ssrPostProcess)||void 0===e||e.dispose(o),null===(t=this._blurPostProcessX)||void 0===t||t.dispose(o),null===(s=this._blurPostProcessY)||void 0===s||s.dispose(o),null===(i=this._blurCombinerPostProcess)||void 0===i||i.dispose(o)}this._ssrPostProcess=null,this._blurPostProcessX=null,this._blurPostProcessY=null,this._blurCombinerPostProcess=null}_createSSRPostProcess(){this._ssrPostProcess=new r.D("ssr","screenSpaceReflection2",["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor"],["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"],1,null,this._textureType,this._scene.getEngine(),!1,"",this._textureType),this._updateEffectDefines(),this._ssrPostProcess.onApply=e=>{this._resizeDepthRenderer();const t=this._geometryBufferRenderer,s=this._prePassRenderer;if(!s&&!t)return;if(t){const s=t.getTextureIndex(m.m.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",t.getGBuffer().textures[1]),e.setTexture("reflectivitySampler",t.getGBuffer().textures[s]),e.setTexture("depthSampler",t.getGBuffer().textures[0])}else if(s){const t=s.getIndex(5),i=s.getIndex(3),r=s.getIndex(6);e.setTexture("normalSampler",s.getRenderTarget().textures[r]),e.setTexture("depthSampler",s.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",s.getRenderTarget().textures[i])}this._enableAutomaticThicknessComputation&&this._depthRenderer&&(e.setTexture("backDepthSampler",this._depthRenderer.getDepthMap()),e.setFloat("backSizeFactor",this._backfaceDepthTextureSizeFactor));const i=this._scene.activeCamera;if(!i)return;const r=i.getViewMatrix(!0),o=i.getProjectionMatrix(!0);o.invertToRef(f.jp.Matrix[0]),r.invertToRef(f.jp.Matrix[1]),e.setMatrix("projection",o),e.setMatrix("view",r),e.setMatrix("invView",f.jp.Matrix[1]),e.setMatrix("invProjectionMatrix",f.jp.Matrix[0]),e.setFloat("thickness",this.thickness),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("maxSteps",this.maxSteps),e.setFloat("roughnessFactor",this.roughnessFactor),e.setFloat("nearPlaneZ",i.minZ),e.setFloat("maxDistance",this.maxDistance),e.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip);const n=this._getTextureSize();f.y3.ScalingToRef(n.width,n.height,1,f.jp.Matrix[2]),o.multiplyToRef(this._scene.getEngine().isWebGPU?N:D,f.jp.Matrix[3]),f.jp.Matrix[3].multiplyToRef(f.jp.Matrix[2],f.jp.Matrix[4]),e.setMatrix("projectionPixel",f.jp.Matrix[4]),this._environmentTexture&&(e.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(e.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),e.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))},this._ssrPostProcess.samples=this.samples,this._forceGeometryBuffer||(this._ssrPostProcess._prePassEffectConfiguration=new w.g)}_createBlurAndCombinerPostProcesses(){const e=this._scene.getEngine();this._blurPostProcessX=new r.D("SSRblurX","screenSpaceReflection2Blur",["blurQuality","texelOffsetScale"],["textureSampler"],1,null,2,e,!1,"",this._textureType),this._blurPostProcessX.autoClear=!1,this._blurPostProcessX.onApplyObservable.add((e=>{var t,s;let i=this._scene.getEngine().getRenderWidth();if(this._prePassRenderer){const e=this._prePassRenderer.getIndex(4),t=this._prePassRenderer.getRenderTarget();t&&t.textures&&(i=t.textures[e].getSize().width)}else i=null!==(s=null===(t=this._ssrPostProcess)||void 0===t?void 0:t.inputTexture.width)&&void 0!==s?s:i;e.setFloat("blurQuality",this.blurQuality),e.setFloat2("texelOffsetScale",this._blurDispersionStrength/i,0)})),this._blurPostProcessY=new r.D("SSRblurY","screenSpaceReflection2Blur",["blurQuality","texelOffsetScale"],["textureSampler"],1,null,2,e,!1,"",this._textureType),this._blurPostProcessY.autoClear=!1,this._blurPostProcessY.onApplyObservable.add((e=>{var t,s;let i=this._scene.getEngine().getRenderHeight();if(this._prePassRenderer){const e=this._prePassRenderer.getIndex(4),t=this._prePassRenderer.getRenderTarget();t&&t.textures&&(i=t.textures[e].getSize().height)}else i=null!==(s=null===(t=this._ssrPostProcess)||void 0===t?void 0:t.inputTexture.height)&&void 0!==s?s:i;e.setFloat("blurQuality",this.blurQuality),e.setFloat2("texelOffsetScale",0,this._blurDispersionStrength/i)})),this._blurCombinerPostProcess=new r.D("SSRblurCombiner","screenSpaceReflection2BlurCombiner",["strength","reflectionSpecularFalloffExponent"],["textureSampler","mainSampler","reflectivitySampler"],1,null,1,e,!1,"",this._textureType),this._blurCombinerPostProcess.autoClear=!1,this._blurCombinerPostProcess.onApplyObservable.add((e=>{const t=this._geometryBufferRenderer,s=this._prePassRenderer;if(s||t){if(s){const t=s.getIndex(4),i=s.getRenderTarget();i&&i.textures&&e.setTexture("mainSampler",i.textures[t])}else e._bindTexture("mainSampler",this._ssrPostProcess.inputTexture.texture);if(t){const s=t.getTextureIndex(m.m.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("reflectivitySampler",t.getGBuffer().textures[s])}else if(s){const t=s.getIndex(3);e.setTexture("reflectivitySampler",s.getRenderTarget().textures[t])}e.setFloat("strength",this.strength),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent)}}))}serialize(){const e=n.p4.Serialize(this);return e.customType="SSRRenderingPipeline",e}static Parse(e,t,s){return n.p4.Parse((()=>new j(e._name,t,e._ratio)),e,t,s)}}(0,i.gn)([(0,n.qC)()],j.prototype,"samples",null),(0,i.gn)([(0,n.qC)()],j.prototype,"maxDistance",void 0),(0,i.gn)([(0,n.qC)()],j.prototype,"step",void 0),(0,i.gn)([(0,n.qC)()],j.prototype,"thickness",void 0),(0,i.gn)([(0,n.qC)()],j.prototype,"strength",void 0),(0,i.gn)([(0,n.qC)()],j.prototype,"reflectionSpecularFalloffExponent",void 0),(0,i.gn)([(0,n.qC)()],j.prototype,"maxSteps",void 0),(0,i.gn)([(0,n.qC)()],j.prototype,"roughnessFactor",void 0),(0,i.gn)([(0,n.qC)()],j.prototype,"selfCollisionNumSkip",void 0),(0,i.gn)([(0,n.qC)("blurDispersionStrength")],j.prototype,"_blurDispersionStrength",void 0),(0,i.gn)([(0,n.qC)()],j.prototype,"blurQuality",void 0),(0,i.gn)([(0,n.qC)("enableSmoothReflections")],j.prototype,"_enableSmoothReflections",void 0),(0,i.gn)([(0,n.qC)("environmentTexture")],j.prototype,"_environmentTexture",void 0),(0,i.gn)([(0,n.qC)("environmentTextureIsProbe")],j.prototype,"_environmentTextureIsProbe",void 0),(0,i.gn)([(0,n.qC)("attenuateScreenBorders")],j.prototype,"_attenuateScreenBorders",void 0),(0,i.gn)([(0,n.qC)("attenuateIntersectionDistance")],j.prototype,"_attenuateIntersectionDistance",void 0),(0,i.gn)([(0,n.qC)("attenuateFacingCamera")],j.prototype,"_attenuateFacingCamera",void 0),(0,i.gn)([(0,n.qC)("attenuateBackfaceReflection")],j.prototype,"_attenuateBackfaceReflection",void 0),(0,i.gn)([(0,n.qC)("clipToFrustum")],j.prototype,"_clipToFrustum",void 0),(0,i.gn)([(0,n.qC)("enableAutomaticThicknessComputation")],j.prototype,"_enableAutomaticThicknessComputation",void 0),(0,i.gn)([(0,n.qC)("backfaceDepthTextureSizeFactor")],j.prototype,"_backfaceDepthTextureSizeFactor",void 0),(0,i.gn)([(0,n.qC)("isEnabled")],j.prototype,"_isEnabled",void 0),(0,i.gn)([(0,n.qC)("debug")],j.prototype,"_debug",void 0),(0,o.H)("BABYLON.SSRRenderingPipeline",j);var z;s(97193),s(88422),s(280),s(74295);!function(e){e[e.Hable=0]="Hable",e[e.Reinhard=1]="Reinhard",e[e.HejiDawson=2]="HejiDawson",e[e.Photographic=3]="Photographic"}(z||(z={}));var V=s(72208),k=s(71419),H=s(98163),q=s(90360),G=s(3085),W=s(63784),Q=s(46719),U=(s(4902),s(44327),s(94864),s(88228),s(15631)),J=s(66513);class Y extends r.D{get useDiffuseColor(){return _.Y.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){_.Y.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,s,i,r=100,o=l.x.BILINEAR_SAMPLINGMODE,n,a,h){var c,p;super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,s,o,n,a,"#define NUM_SAMPLES "+r),this._screenCoordinates=f.FM.Zero(),this.customMeshPosition=f.P.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=new Array,this.includedMeshes=new Array,this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,n=(h=null!==(p=null!==(c=null==s?void 0:s.getScene())&&void 0!==c?c:h)&&void 0!==p?p:this._scene).getEngine(),this._viewPort=new J.l(0,0,1,1).toGlobal(n.getRenderWidth(),n.getRenderHeight()),this.mesh=null!=i?i:Y.CreateDefaultMesh("VolumetricLightScatteringMesh",h),this._createPass(h,t.passRatio||t),this.onActivate=e=>{this.isSupported||this.dispose(e),this.onActivate=null},this.onApplyObservable.add((e=>{this._updateMeshScreenCoordinates(h),e.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),e.setFloat("exposure",this.exposure),e.setFloat("decay",this.decay),e.setFloat("weight",this.weight),e.setFloat("density",this.density),e.setVector2("meshPositionOnScreen",this._screenCoordinates)}))}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){var s;const i=e.getMesh();if(i===this.mesh&&i.material)return i.material.isReady(i);const r=null===(s=i._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===s?void 0:s[this._scene.getEngine().currentRenderPassId];if(r)return r.isReadyForSubMesh(i,e,t);const o=[],n=[V.o.PositionKind],a=e.getMaterial();a&&(a.needAlphaTesting()&&o.push("#define ALPHATEST"),i.isVerticesDataPresent(V.o.UVKind)&&(n.push(V.o.UVKind),o.push("#define UV1")),i.isVerticesDataPresent(V.o.UV2Kind)&&(n.push(V.o.UV2Kind),o.push("#define UV2"))),i.useBones&&i.computeBonesUsingShaders?(n.push(V.o.MatricesIndicesKind),n.push(V.o.MatricesWeightsKind),o.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),o.push("#define BonesPerMesh "+(i.skeleton?i.skeleton.bones.length+1:0))):o.push("#define NUM_BONE_INFLUENCERS 0"),t&&(o.push("#define INSTANCES"),q.G.PushAttributesForInstances(n),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES"));const h=e._getDrawWrapper(void 0,!0),l=h.defines,c=o.join("\n");return l!==c&&h.setEffect(i.getScene().getEngine().createEffect("volumetricLightScatteringPass",n,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],c,void 0,void 0,void 0,{maxSimultaneousMorphTargets:i.numBoneInfluencers}),c),h.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){const t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);-1!==t&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&-1===this.includedMeshes.indexOf(e)||this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)}_createPass(e,t){const s=e.getEngine();this._volumetricLightScatteringRTT=new W._("volumetricLightScatteringMap",{width:s.getRenderWidth()*t,height:s.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=l.x.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=l.x.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;const i=this.getCamera();i?i.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);const r=e=>{var t;const s=e.getRenderingMesh(),i=e.getEffectiveMesh();if(this._meshExcluded(s))return;i._internalAbstractMeshDataInfo._isActiveIntermediate=!1;const r=e.getMaterial();if(!r)return;const o=s.getScene(),n=o.getEngine();n.setState(r.backFaceCulling,void 0,void 0,void 0,r.cullBackFaces);const a=s._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(a.mustReturn)return;const h=n.getCaps().instancedArrays&&(null!==a.visibleInstances[e._id]||s.hasThinInstances);if(this._isReady(e,h)){const l=null===(t=i._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===t?void 0:t[n.currentRenderPassId];let c=e._getDrawWrapper();if(s!==this.mesh||c||(c=r._getDrawWrapper()),!c)return;const p=c.effect;if(n.enableEffect(c),h||s._bind(e,p,r.fillMode),s===this.mesh)r.bind(i.getWorldMatrix(),s);else if(l)l.bindForSubMesh(i.getWorldMatrix(),i,e);else{if(p.setMatrix("viewProjection",o.getTransformMatrix()),r&&r.needAlphaTesting()){const e=r.getAlphaTestTexture();p.setTexture("diffuseSampler",e),e&&p.setMatrix("diffuseMatrix",e.getTextureMatrix())}s.useBones&&s.computeBonesUsingShaders&&s.skeleton&&p.setMatrices("mBones",s.skeleton.getTransformMatrices(s))}h&&s.hasThinInstances&&p.setMatrix("world",i.getWorldMatrix()),s._processRendering(i,e,p,H.F.TriangleFillMode,a,h,((e,t)=>{e||p.setMatrix("world",t)}))}};let o;const n=new U.HE(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add((()=>{o=e.clearColor,e.clearColor=n})),this._volumetricLightScatteringRTT.onAfterRenderObservable.add((()=>{e.clearColor=o})),this._volumetricLightScatteringRTT.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const i=e.subMeshes[t],r=i.getMaterial(),o=i.getRenderingMesh();if(!r)continue;const n=o._getInstancesRenderList(i._id,!!i.getReplacementMesh()),a=s.getCaps().instancedArrays&&(null!==n.visibleInstances[i._id]||o.hasThinInstances);if(!this._isReady(i,a))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(t,s,i,o)=>{const n=e.getEngine();let a;if(o.length){for(n.setColorWrite(!1),a=0;a<o.length;a++)r(o.data[a]);n.setColorWrite(!0)}for(a=0;a<t.length;a++)r(t.data[a]);for(a=0;a<s.length;a++)r(s.data[a]);if(i.length){for(a=0;a<i.length;a++){const t=i.data[a],s=t.getBoundingInfo();s&&e.activeCamera&&(t._alphaIndex=t.getMesh().alphaIndex,t._distanceToCamera=s.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}const t=i.data.slice(0,i.length);for(t.sort(((e,t)=>e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0)),n.setAlphaMode(2),a=0;a<t.length;a++)r(t[a]);n.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){const t=e.getTransformMatrix();let s;s=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const i=f.P.Project(s,f.y3.Identity(),t,this._viewPort);this._screenCoordinates.x=i.x/this._viewPort.width,this._screenCoordinates.y=i.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){const s=(0,Q.pT)(e,{size:1},t);s.billboardMode=k.x.BILLBOARDMODE_ALL;const i=new G.K(e+"Material",t);return i.emissiveColor=new U.Wo(1,1,1),s.material=i,s}}(0,i.gn)([(0,n.hd)()],Y.prototype,"customMeshPosition",void 0),(0,i.gn)([(0,n.qC)()],Y.prototype,"useCustomMeshPosition",void 0),(0,i.gn)([(0,n.qC)()],Y.prototype,"invert",void 0),(0,i.gn)([(0,n.RR)()],Y.prototype,"mesh",void 0),(0,i.gn)([(0,n.qC)()],Y.prototype,"excludedMeshes",void 0),(0,i.gn)([(0,n.qC)()],Y.prototype,"includedMeshes",void 0),(0,i.gn)([(0,n.qC)()],Y.prototype,"exposure",void 0),(0,i.gn)([(0,n.qC)()],Y.prototype,"decay",void 0),(0,i.gn)([(0,n.qC)()],Y.prototype,"weight",void 0),(0,i.gn)([(0,n.qC)()],Y.prototype,"density",void 0),(0,o.H)("BABYLON.VolumetricLightScatteringPostProcess",Y);s(16325),s(43792),s(35802);class X extends r.D{getClassName(){return"ScreenSpaceCurvaturePostProcess"}constructor(e,t,s,i,r,o,n,a=0,h=!1){super(e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],s,i,r,o,n,void 0,a,void 0,null,h),this.ridge=1,this.valley=1,this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?this.onApply=e=>{e.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),e.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));const t=this._geometryBufferRenderer.getGBuffer().textures[1];e.setTexture("normalSampler",t)}:_.Y.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}static get IsSupported(){const e=R.l.LastCreatedEngine;return!!e&&e.getCaps().drawBuffersExtension}static _Parse(e,t,s,i){return n.p4.Parse((()=>new X(e.name,s,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.textureType,e.reusable)),e,s,i)}}(0,i.gn)([(0,n.qC)()],X.prototype,"ridge",void 0),(0,i.gn)([(0,n.qC)()],X.prototype,"valley",void 0),(0,o.H)("BABYLON.ScreenSpaceCurvaturePostProcess",X)},89815:(e,t,s)=>{s.d(t,{Q:()=>a});var i=s(16142),r=s(37290),o=(s(38731),s(91465),s(48620)),n=s(96969);class a extends i.D{getClassName(){return"PassPostProcess"}constructor(e,t,s=null,i,r,o,n=0,a=!1){super(e,"pass",null,null,t,s,i,r,o,void 0,n,void 0,null,a)}static _Parse(e,t,s,i){return n.p4.Parse((()=>new a(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable)),e,s,i)}}(0,o.H)("BABYLON.PassPostProcess",a);r.D._RescalePostProcessFactory=e=>new a("rescale",1,null,2,e,!1,0)},16142:(e,t,s)=>{s.d(t,{D:()=>u});var i=s(72433),r=s(7788),o=s(62897),n=s(58095),a=(s(80196),s(37290)),h=(s(13534),s(96969)),l=s(48620),c=s(67759),p=s(41659);class u{static RegisterShaderCodeProcessing(e,t){t?u._CustomShaderCodeProcessing[null!=e?e:""]=t:delete u._CustomShaderCodeProcessing[null!=e?e:""]}static _GetShaderCodeProcessing(e){var t;return null!==(t=u._CustomShaderCodeProcessing[e])&&void 0!==t?t:u._CustomShaderCodeProcessing[""]}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach((e=>{e.setSamples(this._samples)}))}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,s,i,a,h,l=1,u,d,g=null,_=0,f="postprocess",m,P=!1,y=5,S=p.x.GLSL){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new r.t(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new n.FM(1,1),this._texelSize=n.FM.Zero(),this.onActivateObservable=new o.y$,this.onSizeChangedObservable=new o.y$,this.onApplyObservable=new o.y$,this.onBeforeRenderObservable=new o.y$,this.onAfterRenderObservable=new o.y$,this.name=e,null!=h?(this._camera=h,this._scene=h.getScene(),h.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):u&&(this._engine=u,this._engine.postProcesses.push(this)),this._options=a,this.renderTargetSamplingMode=l||1,this._reusable=d||!1,this._textureType=_,this._textureFormat=y,this._shaderLanguage=S,this._samplers=i||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=f,this._parameters=s||[],this._parameters.push("scale"),this._indexParameters=m,this._drawWrapper=new c.q(this._engine),P||this.updateEffect(g)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){0==this._textures.length&&(this._textures=new r.t(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,s=null,i,r,o,n,a){var h,l;const c=u._GetShaderCodeProcessing(this.name);if(null==c?void 0:c.defineCustomBindings){const i=null!==(h=null==t?void 0:t.slice())&&void 0!==h?h:[];i.push(...this._parameters);const r=null!==(l=null==s?void 0:s.slice())&&void 0!==l?l:[];r.push(...this._samplers),e=c.defineCustomBindings(this.name,e,i,r),t=i,s=r}this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:null!=n?n:this._vertexUrl,fragment:null!=a?a:this._fragmentUrl},{attributes:["position"],uniformsNames:t||this._parameters,uniformBuffersNames:[],samplers:s||this._samplers,defines:null!==e?e:"",fallbacks:null,onCompiled:null!=r?r:null,onError:null!=o?o:null,indexParameters:i||this._indexParameters,processCodeAfterIncludes:(null==c?void 0:c.processCodeAfterIncludes)?(e,t)=>c.processCodeAfterIncludes(this.name,e,t):null,processFinalCode:(null==c?void 0:c.processFinalCode)?(e,t)=>c.processFinalCode(this.name,e,t):null,shaderLanguage:this._shaderLanguage},this._engine)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,s=0){for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture.width===e.width&&this._textureCache[i].texture.height===e.height&&this._textureCache[i].postProcessChannel===s&&this._textureCache[i].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[i].texture.samples===t.samples)return this._textureCache[i].texture;const i=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:i,postProcessChannel:s,lastUsedRenderId:-1}),i}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let e=!1;for(let s=0;s<this._textures.length;s++)if(this._textures.data[s]===this._textureCache[t].texture){e=!0;break}e||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}_resize(e,t,s,i,r){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let o=null;for(let e=0;e<s._postProcesses.length;e++)if(null!==s._postProcesses[e]){o=s._postProcesses[e];break}const n={width:this.width,height:this.height},a={generateMipMaps:i,generateDepthBuffer:r||o===this,generateStencilBuffer:(r||o===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples};this._textures.push(this._createRenderTargetTexture(n,a,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(n,a,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}activate(e,t=null,s){var i,r;const o=(e=e||this._camera).getScene(),n=o.getEngine(),h=n.getCaps().maxTextureSize;let l=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0;const c=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0,p=e.parent;!p||p.leftCamera!=e&&p.rightCamera!=e||(l/=2);let u=this._options.width||l,d=this._options.height||c;const g=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const e=n.currentViewport;e&&(u*=e.width,d*=e.height)}(g||this.alwaysForcePOT)&&(this._options.width||(u=n.needPOTTextures?a.D.GetExponentOfTwo(u,h,this.scaleMode):u),this._options.height||(d=n.needPOTTextures?a.D.GetExponentOfTwo(d,h,this.scaleMode):d)),this.width===u&&this.height===d||this._resize(u,d,e,g,s),this._textures.forEach((e=>{e.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(e,this.samples)})),this._flushTextureCache(),this._renderId++}let _;if(this._shareOutputWithPostProcess)_=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)_=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let e;_=this.inputTexture;for(let t=0;t<this._textureCache.length;t++)if(this._textureCache[t].texture===_){e=this._textureCache[t];break}e&&(e.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(l/u,c/d),this._engine.bindFramebuffer(_,0,l,c,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(_,0,void 0,void 0,this.forceFullscreenViewport)),null===(r=(i=this._engine)._debugInsertMarker)||void 0===r||r.call(i,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&0===this.alphaMode&&this._engine.clear(this.clearColor?this.clearColor:o.clearColor,o._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),_}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){var e,t;return null!==(t=null===(e=this._drawWrapper.effect)||void 0===e?void 0:e.isReady())&&void 0!==t&&t}apply(){var e,t,s;if(!(null===(e=this._drawWrapper.effect)||void 0===e?void 0:e.isReady()))return null;let i;return this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),i=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",null==i?void 0:i.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),null===(s=null===(t=u._GetShaderCodeProcessing(this.name))||void 0===t?void 0:t.bindCustomBindings)||void 0===s||s.call(t,this.name,this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(e){let t;if(e=e||this._camera,this._disposeTextures(),this._scene&&(t=this._scene.postProcesses.indexOf(this),-1!==t&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const e=this._parentContainer.postProcesses.indexOf(this);e>-1&&this._parentContainer.postProcesses.splice(e,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),-1!==t&&this._engine.postProcesses.splice(t,1),e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),0===t&&e._postProcesses.length>0){const e=this._camera._getFirstPostProcess();e&&e.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){const e=h.p4.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=u.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,s){const i=(0,l.q)(e.customType);if(!i||!i._Parse)return null;const r=t?t.getCameraById(e.cameraId):null;return i._Parse(e,r,t,s)}static _Parse(e,t,s,i){return h.p4.Parse((()=>new u(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat)),e,s,i)}}u._CustomShaderCodeProcessing={},(0,i.gn)([(0,h.qC)()],u.prototype,"uniqueId",void 0),(0,i.gn)([(0,h.qC)()],u.prototype,"name",void 0),(0,i.gn)([(0,h.qC)()],u.prototype,"width",void 0),(0,i.gn)([(0,h.qC)()],u.prototype,"height",void 0),(0,i.gn)([(0,h.qC)()],u.prototype,"renderTargetSamplingMode",void 0),(0,i.gn)([(0,h.XX)()],u.prototype,"clearColor",void 0),(0,i.gn)([(0,h.qC)()],u.prototype,"autoClear",void 0),(0,i.gn)([(0,h.qC)()],u.prototype,"alphaMode",void 0),(0,i.gn)([(0,h.qC)()],u.prototype,"alphaConstants",void 0),(0,i.gn)([(0,h.qC)()],u.prototype,"enablePixelPerfectMode",void 0),(0,i.gn)([(0,h.qC)()],u.prototype,"forceFullscreenViewport",void 0),(0,i.gn)([(0,h.qC)()],u.prototype,"scaleMode",void 0),(0,i.gn)([(0,h.qC)()],u.prototype,"alwaysForcePOT",void 0),(0,i.gn)([(0,h.qC)("samples")],u.prototype,"_samples",void 0),(0,i.gn)([(0,h.qC)()],u.prototype,"adaptScaleToCurrentViewport",void 0),(0,l.H)("BABYLON.PostProcess",u)},1421:(e,t,s)=>{s.d(t,{O:()=>r});var i=s(72208);class r{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[i.o.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[i.o.PositionKind]=new i.o(this._scene.getEngine(),e,i.o.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[i.o.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const s=this._scene.activeCamera;return!!s&&(!(!(t=t||s._postProcesses.filter((e=>null!=e)))||0===t.length||!this._scene.postProcessesEnabled)&&(t[0].activate(s,e,null!=t),!0))}directRender(e,t=null,s=!1,i=0,r=0,o=!1){var n;const a=this._scene.getEngine();for(let h=0;h<e.length;h++){h<e.length-1?e[h+1].activate(this._scene.activeCamera,null==t?void 0:t.texture):(t?a.bindFramebuffer(t,i,void 0,void 0,s,r):o||a.restoreDefaultFramebuffer(),null===(n=a._debugInsertMarker)||void 0===n||n.call(a,`post process ${e[h].name} output`));const l=e[h],c=l.apply();c&&(l.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,c),a.drawElementsType(0,0,6),l.onAfterRenderObservable.notifyObservers(c))}a.setDepthBuffer(!0),a.setDepthWrite(!0)}_finalizeFrame(e,t,s,i,r=!1){var o;const n=this._scene.activeCamera;if(!n)return;if(0===(i=i||n._postProcesses.filter((e=>null!=e))).length||!this._scene.postProcessesEnabled)return;const a=this._scene.getEngine();for(let h=0,l=i.length;h<l;h++){const c=i[h];if(h<l-1?c._outputTexture=i[h+1].activate(n,null==t?void 0:t.texture):(t?(a.bindFramebuffer(t,s,void 0,void 0,r),c._outputTexture=t):(a.restoreDefaultFramebuffer(),c._outputTexture=null),null===(o=a._debugInsertMarker)||void 0===o||o.call(a,`post process ${i[h].name} output`)),e)break;const p=c.apply();p&&(c.onBeforeRenderObservable.notifyObservers(p),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,p),a.drawElementsType(0,0,6),c.onAfterRenderObservable.notifyObservers(p))}a.setDepthBuffer(!0),a.setDepthWrite(!0),a.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[i.o.PositionKind];e&&(e.dispose(),this._vertexBuffers[i.o.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}},88422:(e,t,s)=>{s.d(t,{V:()=>a});var i=s(72433),r=s(16142),o=(s(56861),s(48620)),n=s(96969);class a extends r.D{getClassName(){return"SharpenPostProcess"}constructor(e,t,s,i,r,o,n=0,a=!1){super(e,"sharpen",["sharpnessAmounts","screenSize"],null,t,s,i,r,o,null,n,void 0,null,a),this.colorAmount=1,this.edgeAmount=.3,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}static _Parse(e,t,s,i){return n.p4.Parse((()=>new a(e.name,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.textureType,e.reusable)),e,s,i)}}(0,i.gn)([(0,n.qC)()],a.prototype,"colorAmount",void 0),(0,i.gn)([(0,n.qC)()],a.prototype,"edgeAmount",void 0),(0,o.H)("BABYLON.SharpenPostProcess",a)},280:(e,t,s)=>{s.d(t,{i:()=>o});var i=s(58095),r=s(16142);s(32942);class o extends r.D{getClassName(){return"StereoscopicInterlacePostProcessI"}constructor(e,t,s,r,o,n,a){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],o,n,a,r?"#define IS_STEREOSCOPIC_INTERLACED 1":s?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new i.FM(1/this.width,1/this.height),this.onSizeChangedObservable.add((()=>{this._stepSize=new i.FM(1/this.width,1/this.height)})),this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("camASampler",this._passedProcess),e.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)}))}}},46340:(e,t,s)=>{s.d(t,{J:()=>n});var i=s(73803),r=s(16142),o=s(84318);s(37328),s(72656),s(80196);class n extends r.D{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(e,t,s,r=null,n,a,h,l=0){super(e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],s,r,n||i.x.BILINEAR_SAMPLINGMODE,a,h,null,l,"postprocess",void 0,!0),this._scene=t,this.updateEffect(),this.onApplyObservable.add((e=>{if(!t.prePassRenderer||!t.subSurfaceConfiguration)return void o.Y.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");const s=this.texelSize;e.setFloat("metersPerUnit",t.subSurfaceConfiguration.metersPerUnit),e.setFloat2("texelSize",s.x,s.y),e.setTexture("irradianceSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(0)]),e.setTexture("depthSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(5)]),e.setTexture("albedoSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(7)]),e.setFloat2("viewportSize",Math.tan(t.activeCamera.fov/2)*t.getEngine().getAspectRatio(t.activeCamera,!0),Math.tan(t.activeCamera.fov/2)),e.setArray3("diffusionS",t.subSurfaceConfiguration.ssDiffusionS),e.setArray("diffusionD",t.subSurfaceConfiguration.ssDiffusionD),e.setArray("filterRadii",t.subSurfaceConfiguration.ssFilterRadii)}))}}},16325:(e,t,s)=>{s.d(t,{T:()=>n});var i=s(58095),r=s(73803),o=s(16142);s(80208);class n extends o.D{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,s,o){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,o.postProcessScaleFactor,t,r.x.BILINEAR_SAMPLINGMODE),this._isRightEye=s,this._distortionFactors=o.distortionK,this._postProcessScaleFactor=o.postProcessScaleFactor,this._lensCenterOffset=o.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add((()=>{this._scaleIn=new i.FM(2,2/this.aspectRatio),this._scaleFactor=new i.FM(1/this._postProcessScaleFactor*.5,1/this._postProcessScaleFactor*.5*this.aspectRatio),this._lensCenter=new i.FM(this._isRightEye?.5-.5*this._lensCenterOffset:.5+.5*this._lensCenterOffset,.5)})),this.onApplyObservable.add((e=>{e.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),e.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),e.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),e.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])}))}}},43792:(e,t,s)=>{s.d(t,{E:()=>o});var i=s(73803),r=s(16142);s(52377),s(74649);class o extends r.D{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,s){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],s,t,i.x.BILINEAR_SAMPLINGMODE);const r=null!=t?t:this.getCamera();this.onSizeChangedObservable.add((()=>{})),this.onApplyObservable.add((e=>{r._scene.activeCamera&&r._scene.activeCamera.isLeftCamera?e.setInt("imageIndex",0):e.setInt("imageIndex",1),e.setTexture("multiviewSampler",r._multiviewTexture)}))}}}}]);