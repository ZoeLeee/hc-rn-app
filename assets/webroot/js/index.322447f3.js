(()=>{"use strict";var t,e={55495:(t,e,i)=>{var s={};i.r(s),i.d(s,{begin:()=>Ft,end:()=>kt,getFunctionName:()=>It});var a={};i.r(a),i.d(a,{AllObjectData:()=>xt,BaseDatabase:()=>Pt,BaseObject:()=>pt,BlockTableRecord:()=>jt,CommandHistoryRecord:()=>Mt,CreateObjectData:()=>mt,DeepCloneFiler:()=>J,EraseEntityData:()=>ut,EventDispatcher:()=>ot,Factory:()=>Y,HCFactory:()=>K,HCFiler:()=>X,HistoricManager:()=>Ot,HistoryRecord:()=>gt,ObjectAllDataHistoryRecord:()=>St,ObjectCollection:()=>wt,ObjectId:()=>q,ObjectRecord:()=>Bt,RecordTable:()=>Nt,RemoveObjectData:()=>_t,arrayLast:()=>at,arrayRemoveIf:()=>nt,removeOne:()=>rt});var r={};i.r(r),i.d(r,{AbstractMesh:()=>Ti.x,ActionEvent:()=>_i.V,ActionManager:()=>wi.k,AdvancedDynamicTexture:()=>qe.i,Animatable:()=>Ni.H,Animation:()=>Gi.f,AnimationGroup:()=>Xi.O,ArcRotateCamera:()=>Vi.Y,ArcRotateCameraMouseWheelInput:()=>re.F,ArcRotateCameraPointersInput:()=>ae.H,AssetContainer:()=>Bi.TJ,AssetsManager:()=>Xt.Sp,AxesViewer:()=>Wi.w,Axis:()=>oe.RD,BaseCameraPointersInput:()=>se.O,BaseParticleSystem:()=>ge.U,BaseTexture:()=>Li.V,BoundingBox:()=>mi.k,BoundingBoxGizmo:()=>Te.C,Camera:()=>Zi.V,CloudPoint:()=>Qi.Q,Color3:()=>xi.Wo,Color4:()=>xi.HE,ConeParticleEmitter:()=>pe.L,Container:()=>Re.W,Control:()=>ai.o,CreateBox:()=>Ee.NR,CreateBoxVertexData:()=>Ee.aR,CreateCapsuleVertexData:()=>Ae.VF,CreateCylinder:()=>Ie.wf,CreateCylinderVertexData:()=>Ie.zD,CreateDisc:()=>Be.uH,CreateGround:()=>Pe.$6,CreateGroundVertexData:()=>Pe.kt,CreateLineSystem:()=>qt.xW,CreateLines:()=>qt.nL,CreatePlane:()=>Oe.pT,CreatePlaneVertexData:()=>Oe.Hq,CreatePolyhedron:()=>ee.sh,CreateSphereVertexData:()=>Me.jY,CreateTorus:()=>ze.eu,CreateTorusVertexData:()=>ze.h5,CreateTube:()=>te._,CubeTexture:()=>ti.B,Curve3:()=>Jt.j_,CylinderDirectedParticleEmitter:()=>ue.z,CylinderParticleEmitter:()=>ue.k,DefaultRenderingPipeline:()=>Ne.e,DepthOfFieldEffectBlurLevel:()=>Yt.z,DirectionalLight:()=>Se.O,DynamicTexture:()=>He.c,Effect:()=>Fe.Q,Ellipse:()=>Xe.P,Engine:()=>Ui.D,EngineStore:()=>oi.l,ExecuteCodeAction:()=>yi.fQ,FilesInput:()=>ui.P,FilesInputStore:()=>pi.X,FramingBehavior:()=>di.d,FreeCamera:()=>li.c,Frustum:()=>Ke.i,Gizmo:()=>si.t,GlowLayer:()=>$e.c,GridMaterial:()=>he.D,HDRCubeTexture:()=>ei.e,HemisphericLight:()=>Hi.e,HemisphericParticleEmitter:()=>de.V,HighlightLayer:()=>Ii.H,Image:()=>ni.E,KeyboardEventTypes:()=>Ri.OG,Layer:()=>Qe.m,LinesMesh:()=>Ce._,Material:()=>bi.F,Matrix:()=>ki.y3,Measure:()=>ri.U,Mesh:()=>Ki.Kj,MeshBuilder:()=>Yi.V,MirrorTexture:()=>vi.h,MultiLine:()=>be.g,MultiLinePoint:()=>fe.s,Node:()=>Pi.N,NodeMaterial:()=>ke.O,Observable:()=>zi.y$,Observer:()=>zi.Qj,PBRMaterial:()=>fi.Y,ParticleSystem:()=>Ze.p,ParticleSystemSet:()=>_e.D,PickingInfo:()=>Qt.p,Plane:()=>Si.J,PointLight:()=>ve.c,PointerDragBehavior:()=>Mi.M,PointerEventTypes:()=>Di.kD,PointerInfo:()=>Di.R5,PointsCloudSystem:()=>We.B,PositionGizmo:()=>Ci.X,Quaternion:()=>ki._f,Ray:()=>$t.z,ReflectionProbe:()=>ii.x,RotationGizmo:()=>Ai.x,Scalar:()=>ne.R,ScaleGizmo:()=>Ei.q,Scene:()=>ci.x,SceneLoader:()=>Zt.n,ShaderMaterial:()=>je.j,ShadowGenerator:()=>xe.uX,SixDofDragBehavior:()=>De.K,Size:()=>gi.$,SkyMaterial:()=>ie.f,Space:()=>oe.T,SphereParticleEmitter:()=>ce.A,SpotLight:()=>Je.P,StackPanel:()=>we.e,StandardMaterial:()=>Oi.K,StringTools:()=>le.Ml,SubEmitter:()=>me.H,SubEmitterType:()=>me.l,TargetCamera:()=>Ue.C,TextBlock:()=>ye.a,Texture:()=>Fi.x,Tools:()=>Wt.w1,TransformNode:()=>ji.Y,UtilityLayerRenderer:()=>qi.x,Vector2:()=>ki.FM,Vector3:()=>ki.P,VertexData:()=>Le.x,VideoTexture:()=>Ve.f,Viewport:()=>Ye.l,WaterMaterial:()=>Ge.H,_forceSceneHelpersToBundle:()=>$i.y,debugLayer:()=>Vt,serialize:()=>hi.qC});var n={};i.r(n),i.d(n,{Arc2d:()=>Na,Box3:()=>ra,Color3:()=>xi.Wo,Color4:()=>xi.HE,ColorPalette:()=>ya,Container:()=>Re.W,Error:()=>La,FileSystem:()=>Js,KeyBoard:()=>$s,KeyCode:()=>Qs,Log:()=>Ia,MouseKey:()=>Xs,Warn:()=>Fa,angle:()=>Ha,arrayLast:()=>ta,arrayRemoveIf:()=>ia,asVector2:()=>Wa,asVector3:()=>Za,b64toBlob:()=>As,clampRad:()=>qa,deg2rad:()=>sa,disposePoint:()=>sr,equaln:()=>Ps,firstLower:()=>Ts,firstUpper:()=>Rs,generateOcean:()=>Da,getAreaByPoints:()=>$a,getCanvasTexture:()=>la,getClosestPoint:()=>Ya,getColor3:()=>ba,getColor4:()=>fa,getColorInfo:()=>Aa,getDeterminantFor2V:()=>Xa,getEntity:()=>Ss,getGuiContainer:()=>pa,getImageTexture:()=>ua,getMax:()=>ha,getMin:()=>oa,getNodeMetaData:()=>er,getOcean:()=>Ta,getOrthPoint:()=>Ua,getPointToLineDistance:()=>Ka,getPolylineCenter:()=>Ba,getRoot:()=>Ms,getVideoTexture:()=>ca,getWaterPlane:()=>Ra,hexToRgba:()=>Ea,isNone:()=>Ds,isParallelTo:()=>Va,isTextureAsset:()=>Os,mirrorMaterial:()=>da,parseColorString:()=>Ca,parseHexColor:()=>Oa,parseRgbaColor:()=>Pa,polar:()=>Ga,rad2Deg:()=>aa,removeOne:()=>ea,renderPoints:()=>ir,rgbaToHex:()=>za,setDracoConfig:()=>Ja,setNodeMetaData:()=>tr,simpleObjectEqual:()=>Es,sleep:()=>Cs,toHex:()=>va,toHexString:()=>xa,toRgbString:()=>Sa,toRgbaString:()=>Ma,unionBoundbox:()=>na,updateQueryStringParameter:()=>zs});var o={};i.r(o),i.d(o,{CommandManager:()=>fc,CommandWrap:()=>Sc,commandManager:()=>vc,registerCommand:()=>xc});var h={};i.r(h),i.d(h,{Compare:()=>Fd,Condition:()=>Nd,DataFeedback:()=>gd,Dispatch:()=>Od,Display:()=>qc,Highlight:()=>yd,Interaction:()=>Rd,Move:()=>Gc,MoveCamera:()=>sd,Opacity:()=>zd,Open:()=>jc,Rotate:()=>Uc,Scale:()=>td,Select:()=>ud,SetVariable:()=>nd,Wait:()=>ld});var l={};i.r(l),i.d(l,{ActionManagerType:()=>Bs,Animation:()=>pr,AnimationGroup:()=>wr,AppConfig:()=>Ji,AppEvent:()=>Mr,AppStore:()=>zr,Application:()=>uc,ArcRotateCameraControl:()=>No,BJS:()=>r,BaseCamera:()=>Co,BaseDom:()=>Tr,BaseGui:()=>Bn,BaseTextureRecord:()=>Br,BaseWidget:()=>po,Box:()=>Ih,CMD:()=>o,CameraEnable:()=>Ns,CameraManager:()=>Vo,CameraType:()=>Ho,CameraViewMode:()=>Gs,CanvasControl:()=>Su,Capsule:()=>al,CenterType:()=>Zs,CollectionRecord:()=>ip,CommonMaterials:()=>zh,CompareType:()=>Ys,Component:()=>lo,ConeEmitter:()=>zu,Control:()=>ai.o,Curve:()=>Lh,CustomArcRotateCameraPointersInput:()=>zo,Cylinder:()=>Qh,CylinderEmitter:()=>Iu,DXFLoader:()=>dp,DataBind:()=>Wd,DataBindType:()=>Zd,Database:()=>cc,DirectedCylinder:()=>ku,DirectionalLight:()=>Bl,Door:()=>Yl,EConditionType:()=>Ws,EDataType:()=>Hs,Editor:()=>bo,EditorStatus:()=>In,Emiter:()=>Cu,EmiterShape:()=>Vu,EmiterType:()=>Zu,Entity:()=>Er,EventEnum:()=>ys,FilePreviewer:()=>_c,FreeCameraControl:()=>Go,GetPointService:()=>_o,Ground:()=>cl,GroupRecord:()=>rp,HC3DFileLoader:()=>is,HemisphericEmiter:()=>Nu,HemisphericLight:()=>Ol,HighlightManager:()=>Oo,ISPROXYKEY:()=>io,ImportEntity:()=>Ln,Interaction:()=>h,KeyboardControl:()=>to,Light:()=>wl,Line:()=>Vh,Lines:()=>Nh,LockSizeType:()=>Dn,MaterialAnimation:()=>Ic,MaterialRecord:()=>ks,MaterialViewer:()=>wc,MouseControl:()=>eo,MoveAction:()=>zc,MoveAnimation:()=>mr,MoveType:()=>Ks,MultiLine2:()=>Fn,PBRMaterialRecord:()=>Pn,Particle:()=>ec,ParticleSystem:()=>Xu,ParticleSystemGroup:()=>Ju,PathAnimation:()=>fr,Plane:()=>el,PointLight:()=>xl,PointTypeEnum:()=>js,PointerEventTypes:()=>Di.kD,Polyline:()=>Uh,RadiusEmiter:()=>Du,RegisterComponent:()=>co,RenderType:()=>Us,RotateAnimation:()=>Sr,SceneControl:()=>Jo,SceneHelper:()=>Ch,SelectControl:()=>Vn,SelectType:()=>Fs,ServiceStatus:()=>Rn,SkyboxMode:()=>qs,Solid3D:()=>Dh,Sphere:()=>qh,SphereEmiter:()=>Wu,SpotLight:()=>Il,StackPanelGui:()=>Yd,StandardMaterialRecord:()=>Ec,SubEmitter:()=>Pu,TextureRecord:()=>Ur,Torus:()=>ol,TransformControl:()=>Jn,TransformMode:()=>Vs,Tube:()=>Zl,UnRegisterComponent:()=>uo,UpdateFlag:()=>ws,UpdateSceneFlag:()=>Qo,Utils:()=>n,Video:()=>hu,VideoGui:()=>du,Viewer:()=>Eh,Wall:()=>tc,WallPlane:()=>$l,Win:()=>Xl,autoRecord:()=>ro,autoUpdate:()=>ao,compareLeft:()=>ql,defineProperty:()=>so});var c=i(60606),d=i.n(c),u=i(10558),p=i.n(u),m=i(76900),g=i.n(m),_=i(24806),w=i.n(_),y=i(3852),b=i.n(y),f=i(57533),v=i.n(f),x=i(70776),S=i.n(x),M=i(85016),O=i.n(M),P=i(93213),C=i(29911),A=i.n(C),E=i(60559),z=i.n(E),D=i(4539),T=i.n(D),R=i(68702),I=i.n(R),L=i(12193),F=i.n(L),k=i(29743),j=i.n(k),B=i(42219),N=i.n(B),G=i(32735),H=i.n(G),V=i(59880),Z=i.n(V),W=i(29013),U=i.n(W);class K{constructor(){this.objectNameMap=new(U())}static RegisterObject(t){const e=t.type;if(!e)throw new Error(t.name+"\u5b9e\u4f53\u7f3a\u5c11\u6ce8\u518c\u7c7b\u578b");this.factory.objectNameMap.has(e)?console.warn("\u65e0\u9700\u91cd\u590d\u6ce8\u518c"+e):this.factory.objectNameMap.set(e,t)}static RegisterObjectAlias(t,e){this.factory.objectNameMap.set(e,t)}static CreateObject(t,e){let i=this.factory.objectNameMap.get(t);if(i)return new i(e)}static isRegister(t){return this.factory.objectNameMap.has(t)}static RegisterComponent(t){this.factory.objectNameMap.set(t.type,t)}static RemoveComponent(t){this.factory.objectNameMap.delete(t)}}function Y(t){K.RegisterObject(t)}K.factory=new K;class q{constructor(t=-1,e){this.index=void 0,this.object=void 0,this.index=t,this.object=e}get isErase(){return!this.object||this.object.IsErase}set Object(t){this.object=t}get Object(){return this.object}get Index(){return this.index}set Index(t){this.index=t}toJSON(){return this.index}}class X{constructor(t=[]){this._datas=t,this.database=void 0,this.readIndex=0}get Data(){return this._datas}set Data(t){this._datas=t,this.reset()}clear(){return this._datas.length=0,this.reset()}reset(){return this.readIndex=0,this}write(t){return t instanceof q?this._datas.push(t.Index):this._datas.push(t),this}read(){return this._datas[this.readIndex++]}writeObjectId(t){return t?this.write(t.Index):this.write(0),this}readObjectId(){let t=this.read();if(this.database)return this.database.getObjectId(t)}writeSoftObjectId(t){return this.writeObjectId(t)}readSoftObjectId(){return this.readObjectId()}writeHardObjectId(t){return this.writeObjectId(t)}readHardObjectId(){return this.readObjectId()}writeObject(t){if(t)return this.writeString(t.constructor.type||t.constructor.name),t.writeFile(this),this;this.write("")}readObject(t){let e=this.readString();if(e)return void 0===t&&(!(t=K.CreateObject(e))&&H()(e).call(e,"CustomComponent")&&(t=K.CreateObject("Component"),console.error(e+"\u5df2\u4e22\u5931")),void 0!==this.database&&"_SetDefaultDb"in t&&t._SetDefaultDb(this.database)),t.readFile(this),t}writeString(t){return this._datas.push(t),this}readString(){return this._datas[this.readIndex++]}writeArray(t){this.write(t.length);for(const e of t)this.write(e)}readArray(t){var e;let i=Z()(e=this._datas).call(e,this.readIndex,this.readIndex+t);return this.readIndex+=t,i}writeAnyArray(t,e){this.write(t.length);for(const i of t)e.call(this,i)}readAnyArray(t){const e=this.read();for(let i=0;i<e;i++)t.call(this)}readAnyArrayAndPush(t,e){t.length=0;const i=this.read();for(let s=0;s<i;s++){const i=e.call(this);t.push(i)}}writeVector3(t){this.write(t?.x),this.write(t?.y),this.write(t?.z)}readVector3(t){const e=this.read(),i=this.read(),s=this.read();t.x=e,t.y=i,t.z=s}}var $=i(57046),Q=i.n($);class J extends X{constructor(t=new(U())){super(),this.idMaping=t,this.hardObjectIds=new(Q()),this.cloned=new(Q())}readObjectId(){let t=this.read();if(t<=0)return;let e=this.idMaping.get(t);return e||(e=new q,this.idMaping.set(t,e),e)}readSoftObjectId(){return this.readObjectId()}readHardObjectId(){return this.readObjectId()}writeHardObjectId(t){return t&&t.Index>=100&&!this.cloned.has(t.Index)&&this.hardObjectIds.add(t.Index),this.writeObjectId(t)}}var tt=i(5134),et=i.n(tt),it=i(94825),st=i.n(it);function at(t){return t[t.length-1]}function rt(t,e){let i=0;for(let s=0,a=t.length;s<a;s++)t[s]!==e&&(t[i++]=t[s]);return t.length=i,t}function nt(t,e){let i=0;for(let s=0,a=t.length;s<a;s++)e(t[s])||(t[i++]=t[s]);return t.length=i,t}class ot{constructor(){this._listeners=new(U())}on(t,e,i){let s=this._listeners.get(t);return s||(s=[],this._listeners.set(t,s)),-1===et()(s).call(s,e)&&(i&&(e.__customOption__=i),s.push(e)),()=>this.off(t,e)}once(t,e,i){return e.__isOnce__=!0,this.on(t,e,i)}hasEventListener(t,e){let i=this._listeners.get(t);return!!i&&-1!==et()(i).call(i,e)}off(t,e){let i=this._listeners.get(t);if(i){const t=et()(i).call(i,e);-1!==t&&st()(i).call(i,t,1)}}trigger(t){let e=this._listeners.get(t.type);if(e){t.target||(t.target=this);const i=Z()(e).call(e,0);for(let e=0,s=i.length;e<s;e++){const s=i[e].__customOption__;s&&(s.userData&&(t.data=s.userData),!s.condition?.(t))||i[e].call(this,t)}nt(e,(t=>t.__isOnce__))}}}var ht,lt,ct=i(91267),dt=i.n(ct);class ut{constructor(t=!0){this.isErase=t}readFile(t){return this.isErase=t.read(),this}writeFile(t){return t.write(this.isErase),this}}class pt extends ot{constructor(...t){super(...t),this._ver=void 0,this._Owner=void 0,this._db=void 0,this._id=void 0,this._erase=!1,this._name=void 0}set Owner(t){this._Owner=t}get Owner(){return this._Owner}get IsErase(){return this._erase}get ObjectId(){return this._id}set ObjectId(t){this._id=t}get Id(){return this._id?.Index}get DB(){return this._db}get Name(){return this._name}get Type(){return this.constructor.type}erase(t=!0){if(this._erase===t)return;this._erase=t;const e=this.UndoRecord;e&&e.createEraseHistory(this,t)}clone(){const t=new this.constructor,e=this._id;this._id=null;let i=new X;return i.database=this._db,this.writeFile(i),t.readFile(i),t._db=void 0,t._id=null,this._id=e,t}copyFrom(t){let e=this._id,i=this._Owner;this.writeSnapshoot();let s=new X;return t.writeFile(s),this.readFile(s),this._id=e,this._Owner=i,this}replace(...t){}destory(t){this._db=void 0}writeFile(t){t.write(3),t.writeObjectId(this._id),t.write(this._erase),t.writeObjectId(this._Owner)}readFile(t){this._ver=t.read();const e=t.readObjectId();!this._id&&e&&(this._id=e,this._id.Object=this),this._erase=t.read(),this._Owner=t.readObjectId()}_SetOwnerDatabase(t){return this._db?console.warn("\u91cd\u590d\u8bbe\u7f6e\u6e90Database!"):(this._db=t,this._id=t.allocateId(),this._id.Object=this),this}_SetDefaultDb(t){return this._db?console.warn("\u91cd\u590d\u8bbe\u7f6e\u9ed8\u8ba4Database!"):this._db=t,this}_SetDatabase(t){this._db=t}_applyHistoryRecord(t){t instanceof ut&&(this._erase=t.isErase)}get UndoRecord(){if(!this._db)return;return this._db.HistoryManager.LastCmdRecord}writeSnapshoot(){const t=this.UndoRecord;t&&t.writeObjectSnapshoot(this)}}pt.type="";class mt{constructor(t){this.Object=t,this.filer=new X}save(){return this.Object&&0===this.filer.Data.length&&this.filer.writeObject(this.Object),this}getObject(t){return this.filer.reset(),this.filer.database=t,this.Object=this.filer.readObject(),this.filer.reset(),this.Object}readFile(t){t.read();let e=t.read();this.filer.Data=e}writeFile(t){t.write(1),t.write(this.filer.Data)}}class gt{constructor(){this.undoData=void 0,this.redoData=void 0}writeFile(t){}readFile(t){}}class _t{constructor(t){this.index=void 0,this.removeObject=void 0,this.index=t}get Index(){return this.index}readFile(t){t.read(),this.index=t.read()}writeFile(t){t.write(1),t.write(this.index)}}let wt=Y(((lt=class extends pt{constructor(...t){super(...t),this.objects=[]}append(t){this._db&&!t.ObjectId?t._SetOwnerDatabase(this._db):t._SetDatabase(this._db),t.Owner=this._Owner,this.objects.push(t);let e=this.UndoRecord;if(e){let i=new gt;i.redoData=new mt(t).save(),i.undoData=new _t(this.objects.length-1),e.writeObjectHistoryPath(this,i)}return this.appendEvent(t),t.ObjectId}appendEvent(t){}remove(t){var e;let i=et()(e=this.objects).call(e,t);this.removeIndex(i)}removeIndex(t){var e;if(-1===t)return;let i=this.objects[t];return st()(e=this.objects).call(e,t,1),i&&i.destory(),i}replace(t,e){var i;const s=et()(i=this.objects).call(i,t);s>-1&&(this.objects[s]=e,t.replace(e),this.appendEvent(e))}destory(){super.destory();for(const t of this.objects)t.destory(!0);this.objects.length=0}readFile(t){super.readFile(t);t.read();let e=t.read();this.objects=[];for(let i=0;i<e;i++){let e=t.readObject();e&&this.objects.push(e)}}writeFile(t,e){super.writeFile(t),t.write(1),t.write(this.objects.length);const i=[...this.objects];e?.sort&&dt()(i).call(i,dt()(e));for(let e of i)t.writeObject(e)}_applyHistoryRecord(t){if(t instanceof mt){let e=t.getObject(this._db);this.objects.push(e),this.appendEvent(e)}else if(t instanceof _t){let e=this.removeIndex(t.Index);t.removeObject=e}}}).type="ObjectCollection",ht=lt))||ht;var yt,bt,ft=i(58293),vt=i.n(ft);class xt{constructor(t){this.filer=new X,t&&(this.filer.database=t.DB,t.writeFile(this.filer))}get Filer(){const t=new X(this.filer.Data);return t.database=this.filer.database,t}readFile(t){t.read(),this.filer.Data=t.read(),this.filer.reset()}writeFile(t){t.write(1),t.write(this.filer.Data)}}class St extends gt{constructor(t){super(),this.id=t,this.writeUndo()}writeUndo(){this.undoData=new xt(this.id.Object)}writeRedo(){this.redoData=new xt(this.id.Object)}writeFile(t){t.write(1),t.writeObjectId(this.id)}readFile(t){t.read(),this.id=t.readObjectId()}}let Mt=Y(((bt=class extends pt{constructor(t=""){super(),this.commandName=t,this._HistoryList=new(U()),this._CreateObjects=new(U())}get HistoryList(){return this._HistoryList}getObjectAllDataRecord(t){let e=[];for(const i of t)i instanceof St&&e.push(i);return e}writeObjectSnapshoot(t){if(!t.ObjectId)return void console.warn("\u751f\u6210\u5bf9\u8c61\u6570\u636e\u9519\u8bef\uff0c\u5bf9\u8c61\u8fd8\u6ca1\u5206\u914dID");if(this._CreateObjects.has(t))return;let e=this.getObjectHistoryList(t.ObjectId);if(this.getObjectAllDataRecord(e)?.length)return;let i=new St(t.ObjectId);e.push(i)}getObjectHistoryList(t){return this._HistoryList.has(t)||this._HistoryList.set(t,[]),this._HistoryList.get(t)}createEraseHistory(t,e){let i=new gt;i.undoData=new ut(!e),i.redoData=new ut(e),this.writeObjectHistoryPath(t,i)}writeObjectHistoryPath(t,e){if(this._CreateObjects.has(t))return;let i=this.getObjectHistoryList(t.ObjectId);this.getObjectAllDataRecord(i)?.length||(e.redoData instanceof mt&&this._CreateObjects.set(e.redoData.Object,e),i.push(e))}destory(){}writeFile(t){t.write(1),t.write(this.commandName)}readFile(t){t.read(),this.commandName=t.read()}}).type="CommandHistoryRecord",yt=bt))||yt;class Ot extends pt{constructor(...t){super(...t),this.historyRecordList=[],this.doing=!1,this.cursor=-1,this.isEnable=!0}startCmd(t){var e;st()(e=this.historyRecordList).call(e,this.cursor+1,this.historyRecordList.length-(this.cursor+1)),this.historyRecordList.push(new Mt(t)),this.cursor=this.historyRecordList.length-1}endCmd(){let t=this.historyRecordList[this.cursor];if(t){for(const[,e]of t.HistoryList)for(const t of e)t instanceof St&&t.writeRedo();return this.endCmdEvent(!0),!0}return this.endCmdEvent(!1),!1}get HasUndo(){return!!this.historyRecordList[this.cursor]}get HasRedo(){return!!this.historyRecordList[this.cursor+1]}endCmdEvent(t){}undo(){let t=this.historyRecordList[this.cursor];if(!t)return!1;this.doing=!0;for(let[e,i]of t.HistoryList)for(let t=i.length;t--;)e.Object._applyHistoryRecord(i[t].undoData);return this.cursor--,this.doing=!1,this.undoEvent(t),!0}undoEvent(t){}redo(){let t=this.historyRecordList[this.cursor+1];if(!t)return!1;this.doing=!0;for(let[e,i]of t.HistoryList)for(let t=i.length;t--;)e.Object._applyHistoryRecord(i[t].redoData);return this.cursor++,this.doing=!1,this.redoEvent(t),!0}redoEvent(t){}clear(){this.historyRecordList.length=0,this.cursor=-1}destory(){super.destory();for(const t of this.historyRecordList)t.destory();this.historyRecordList.length=0,this.cursor=-1}get LastCmdRecord(){if(!this.doing&&this.isEnable)return at(this.historyRecordList)}writeFile(t){t.write(1),t.write(this.historyRecordList.length);for(const e of this.historyRecordList)e.writeFile(t)}readFile(t){t.read();const e=t.read();this.historyRecordList.length=0;for(let i=0;i<e;i++){const e=new Mt;e.readFile(t),this.historyRecordList.push(e)}}}class Pt{constructor(t=!1){this.preview=t,this.idIndex=1,this.idMap=new(U()),this.HistoryManager=void 0,this.HistoryManager=(new Ot)._SetOwnerDatabase(this),this.idIndex=100}get AllObjects(){const t=[];for(const[e,i]of this.idMap)e<100||t.push(i.Object);return t}allocateId(){return this.getObjectId(this.idIndex++)}getObjectId(t){if(0===t)return;let e=this.idMap.get(t);return e||(e=new q(t),this.idMap.set(t,e),e)}findObjectById(t){return this.idMap.get(t)?.Object}findObjectByName(t,e=!0,i){const s=[];i||(i=t=>!1);for(const[,r]of this.idMap){var a;if(!r.isErase)if(r.Object?.Name&&!i(r.Object))if(e)vt()(a=r.Object.Name).call(a,t)&&s.push(r.Object);else r.Object.Name===t&&s.push(r.Object)}return s}reset(){}writeFile(t){return t}readFile(t){return this}destory(){}}var Ct,At=i(9010),Et=i.n(At),zt=i(14461),Dt=i.n(zt);function Tt(t,e,i,...s){let a=t[Lt(e,i)];if(a)for(let e of a)if(e.call(t,...s))return}function Rt(t){return function(e,i,s){let a=It(e,i),r=Lt(a,t);!function(t,e){const i=Dt()("__aopinit__"+e);if(!t.hasOwnProperty(i)){t[i]=!0;let s=t[e];t[e]=function(...i){Tt(t,e,Ct.begin,...i);let a=s.call(t,...i);return i.push(a),Tt(t,e,Ct.end,...i),a}}}(e,a);let n=function(t,e){return t.hasOwnProperty(e)||(t[e]=[]),t[e]}(e,r);return n.unshift(s),n.length>20&&console.warn("aop\u6ce8\u5165\u51fd\u6570\u4e2a\u6570\u8d85\u8fc720",s),function(){let t=et()(n).call(n,s);-1!==t&&st()(n).call(n,t,1)}}}function It(t,e){if(e.name)return e.name;for(let i in t)if(t[i]===e)return i}function Lt(t,e){return Dt()(e+t)}!function(t){t.begin="__begin__",t.end="__end__"}(Ct||(Ct={}));const Ft=Rt(Ct.begin),kt=Rt(Ct.end);class jt extends pt{constructor(){super(),this.entityCol=new wt,this.checkout=void 0,kt(this.entityCol,this.entityCol.appendEvent,(t=>{this.appendEvent(t)}))}get Entitys(){var t;return Z()(t=this.entityCol.objects).call(t)}IsVaildObject(t){var e;return Et()(e=jt.ObjectType).call(e,(e=>t instanceof e))}setCheckout(t){return this.checkout=t,this}append(t){this.checkout&&!this.checkout(t)||!this.IsVaildObject(t)?console.error("\u52a0\u5165\u7684\u5b9e\u4f53\u548c\u6b64\u5757\u8868\u4e0d\u5339\u914d"):this.entityCol.append(t)}appendEvent(t){}remove(t){this.entityCol.remove(t)}_SetOwnerDatabase(t){return super._SetOwnerDatabase(t),this.entityCol._SetOwnerDatabase(t),this.entityCol.Owner=this.ObjectId,this}replace(t,e){this.entityCol.replace(t,e)}writeFile(t,e){super.writeFile(t),t.write(1),this.entityCol.writeFile(t,e)}readFile(t){super.readFile(t);t.read();this.entityCol.readFile(t)}destory(){super.destory(),this.entityCol.destory()}}jt.ObjectType=[];class Bt extends pt{constructor(...t){super(...t),this._name=""}get Name(){return this._name}set Name(t){this._name=t}writeFile(t){super.writeFile(t),t.write(1),t.write(this._name)}readFile(t){if(super.readFile(t),this._ver<3)return;t.read();this._name=t.read()}}class Nt extends pt{constructor(...t){super(...t),this.records=[]}get Objects(){return[...this.records]}append(t,e=!0){e?t._SetOwnerDatabase(this.DB):t._SetDefaultDb(this.DB),t.Owner=this.ObjectId,this.add(t)}add(t){this.records.push(t)}remove(t){return nt(this.records,(e=>e.Id===t))}writeFile(t){super.writeFile(t),t.write(1),t.write(this.records.length);for(const e of this.records)t.writeObject(e)}readFile(t){if(super.readFile(t),this._ver<2)return;t.read();this.records.length=0;const e=t.read();for(let i=0;i<e;i++){const e=t.readObject();this.records.push(e)}}destory(){super.destory();for(const t of this.Objects)t.destory();this.Objects.length=0}}window.requestIdleCallback=window.requestIdleCallback||function(t){const e=z()();return I()((function(){t({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(z()()-e))}})}),1)},window.cancelIdleCallback=window.cancelIdleCallback||function(t){clearTimeout(t)};var Gt=i(62359),Ht=i.n(Gt),Vt=i(22933),Zt=(i(76764),i(65301),i(5515),i(63407)),Wt=i(13514),Ut=i(21055),Kt=i(88862),Yt=(i(54904),i(77118),i(43185),i(72225),i(78554)),qt=i(9866),Xt=i(10440),$t=i(1316),Qt=i(5292),Jt=i(74742),te=i(42387),ee=i(57891),ie=i(87813),se=i(23592),ae=i(75105),re=i(20462),ne=i(72739),oe=i(43048),he=i(66453),le=i(29972),ce=i(54095),de=i(50091),ue=i(4570),pe=i(69212),me=i(45680),ge=i(25846),_e=i(45715),we=i(99938),ye=i(90194),be=i(71258),fe=i(49083),ve=i(65064),xe=i(89118),Se=i(258),Me=i(48087),Oe=i(46719),Pe=i(41525),Ce=i(37852),Ae=i(6588),Ee=i(8451),ze=i(49353),De=i(52597),Te=i(57178),Re=i(90558),Ie=i(62845),Le=i(89209),Fe=i(58445),ke=i(97163),je=i(54067),Be=i(42620),Ne=i(33404),Ge=i(17724),He=i(93980),Ve=i(9100),Ze=i(22672),We=i(84552),Ue=i(86121),Ke=i(84319),Ye=i(66513),qe=i(31652),Xe=i(16489),$e=i(19442),Qe=i(15772),Je=i(96761),ti=i(44394),ei=i(85790),ii=i(4323),si=i(20440),ai=i(76728),ri=i(42238),ni=i(26633),oi=i(15210),hi=i(96969),li=i(78098),ci=i(65273),di=i(81989),ui=i(92839),pi=i(64436),mi=i(33178),gi=i(76144),_i=i(23954),wi=i(85619),yi=i(31919),bi=i(98163),fi=i(47914),vi=i(92159),xi=i(15631),Si=i(62464),Mi=i(63654),Oi=i(3085),Pi=i(17834),Ci=i(29915),Ai=i(37724),Ei=i(99382),zi=i(62897),Di=i(76324),Ti=i(71419),Ri=i(63737),Ii=i(34912),Li=i(39126),Fi=i(73803),ki=i(58095),ji=i(30700),Bi=i(7701),Ni=i(83534),Gi=i(18770),Hi=i(51356),Vi=i(78443),Zi=i(2055),Wi=i(13566),Ui=i(37290),Ki=i(91243),Yi=i(85737),qi=i(85527),Xi=i(4849),$i=i(49861),Qi=i(92993);const Ji={debugger:!1,loadPlugins:new(Q()),assetURL:"",Texture_URL:"",SkyBox_URL:"",lowPerformance:!1,isEncrypt:!0,clearCacheKeys:[]},ts=new TextDecoder("utf-8");class es{constructor(t){this._completePromises=new Array,this._assetContainer=null,this._parent=void 0,this._disposed=!1,this._rootUrl=null,this._babylonScene=void 0,this._parent=t}async loadAssetContainerAsync(t,e,i,s){if(this._rootUrl=i,this._babylonScene=t,Ji.isEncrypt){const a=await this._loadAsync(i,e);return Zt.n.LoadAssetContainerAsync(i,a,t,s)}{const a=e.entry.replace(".mod","."+e.type);return Zt.n.LoadAssetContainerAsync(i,a,t,s)}}async importMeshAsync(t,e,i,s,a,r){this._rootUrl=s,this._babylonScene=e;const n=await this._loadAsync(s,i);return Zt.n.ImportMeshAsync(t,s,n,e,a)}async loadAsync(t,e,i,s,a){this._rootUrl=i,this._babylonScene=t;const r=await this._loadAsync(i,e);return Zt.n.LoadAsync(i,r,t.getEngine(),s).then()}_loadAsync(t,e){return this.loadModFile(e).catch((t=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(t),this._parent.onErrorObservable.clear(),this.dispose()),t}))}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._parent.dispose())}async loadModFile(t){const e=await this._parent.constructor.LoadPromise,i=await this._babylonScene._loadFileAsync(this._rootUrl+t.entry,(()=>{}),!0,!0),s=e(new Uint8Array(i),"hctest");if("glb"!==t.type){const e=ts.decode(s);return new File([e],"temp."+t.type)}return new File([s],"temp."+t.type)}}class is{static LoadWasm(){if(!this.DecodeConfig.exec_url)throw new Error("wasm\u6267\u884c\u6587\u4ef6\u4e22\u5931");if(!this.DecodeConfig.wasm_url)throw new Error("wasm\u6587\u4ef6\u4e22\u5931");this.LoadPromise=new(N())((t=>{Wt.w1.LoadScript(this.DecodeConfig.exec_url,(()=>{(function(t){const e=new window.Go;return e.importObject.env["syscall/js.finalizeRef"]=()=>{},new(N())(((i,s)=>{WebAssembly.instantiateStreaming(fetch(t),e.importObject).then((t=>{e.run(t.instance),i(t.instance)})).catch((t=>{s(t)}))}))})(this.DecodeConfig.wasm_url).then((()=>{this.Decode=window.decode,t(this.Decode)}))}))}))}constructor(){this._gltfLoader=void 0,this._objLoader=void 0,this._requests=new Array,this._loader=null,this.name="hc3d",this.extensions=".hc3d",this.onErrorObservable=new zi.y$,this._loader=new es(this)}get GLTFLoader(){return this._gltfLoader||(this._gltfLoader=new Kt.ey),this._gltfLoader}get OBJLoader(){return this._objLoader||(this._objLoader=(new Ut.mp).createPlugin()),this._objLoader}createPlugin(){return new is}getFileLoader(t){switch(t){case"gltf":case"glb":return this.GLTFLoader;case"obj":return this.OBJLoader;default:return null}}loadAssetContainerAsync(t,e,i,s,a){return this._loader.loadAssetContainerAsync(t,JSON.parse(e),i,s)}importMeshAsync(t,e,i,s,a){return this._loader.importMeshAsync(t,e,JSON.parse(i),s,a)}loadAsync(t,e,i,s,a){return this._loader.loadAsync(t,JSON.parse(e),i,s,a)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const t of this._requests)t.abort();this._requests.length=0}}is.DecodeConfig={exec_url:"",wasm_url:""},is.Decode=void 0,is.LoadPromise=void 0,Zt.n.RegisterPlugin(new is);var ss=i(34848),as=i.n(ss),rs=i(15507),ns=i.n(rs),os=i(94043),hs=i(77328),ls=i(39200),cs=i.n(ls),ds=i(32967),us=i.n(ds),ps=i(41461),ms=i.n(ps),gs=i(92714),_s=i.n(gs);let ws,ys;!function(t){t[t.None=0]="None",t[t.Matrix=1]="Matrix",t[t.Geometry=2]="Geometry",t[t.Material=4]="Material",t[t.All=127]="All"}(ws||(ws={})),function(t){t.UpdateMaterial="update-material",t.Update="update",t.AddAnimation="addAnimation",t.UpdateMatrix="matrix",t.Remove="remove",t.UpdateName="updateName",t.LoadFile="loadFile",t.LoadComplete="loadComplete",t.StartLoad="startLoad",t.NewFile="newFile",t.UpdateVisiable="updateVisiable",t.UpdateShadow="update-shadow",t.Load="load",t.Loading="loading",t.UpdateScene="UpdateScene",t.ServiceStatus="ServiceStatus"}(ys||(ys={}));var bs,fs,vs=i(60456),xs=i(41843);function Ss(t){for(;t&&!t.metadata?.Entity;)t=t.parent;return t?.metadata?.Entity}function Ms(t){for(;t.parent;)t=t.parent;return t}function Os(t){const e=et()(t).call(t,"?");return-1!==e&&(t=t.substring(0,e)),le.Ml.EndsWith(t,".ktx")||le.Ml.EndsWith(t,".ktx2")||le.Ml.EndsWith(t,".png")||le.Ml.EndsWith(t,".jpg")||le.Ml.EndsWith(t,".jpeg")}function Ps(t,e,i=1e-5){return Math.abs(t-e)<=i}function Cs(t){return new(N())((e=>I()(e,t)))}function As(t){const e=t.split(",")[0].split(":")[1].split(";")[0],i=atob(t.split(",")[1]),s=new ArrayBuffer(i.length),a=new Uint8Array(s);for(let t=0;t<i.length;t++)a[t]=i.charCodeAt(t);return new Blob([a],{type:e})}function Es(t,e){for(const i in t){if(!e.hasOwnProperty(i))return!1;if(t[i]!==e[i])return!1}return!0}function zs(t,e,i){if(void 0===i)return t;const s=new RegExp("([?&])"+e+"=.*?(&|$)","i"),a=-1!==et()(t).call(t,"?")?"&":"?";return t.match(s)?t.replace(s,"$1"+e+"="+i+"$2"):t+a+e+"="+i}function Ds(t){return void 0===t||!t&&0!==t}function Ts(t){return t.replace(t[0],t[0].toLowerCase())}function Rs(t){return t.replace(t[0],t[0].toUpperCase())}function Is(t,e){return(i,s)=>Ls(i,s,t,e)}function Ls(t,e,i,s){i||(i=t=>t),s||(s=t=>t);const a="_"+Ts(e),r=Ts(e);O()(t,e,{set:function(t){if(this[a]!==(t=s(t)))if(this.writeSnapshoot(),this[a]=t,this.init){if(this.isOwn){const t=this.material[r];this[a]=i(t)}}else{if(this.isOwn){let i=this.entity.diffMaterials.get(this.material.id);i||(i={},this.entity.diffMaterials.set(this.material.id,i)),i[e]=t}this.update()}},get:function(){return this[a]},enumerable:!0,configurable:!0})}let Fs,ks=(bs=class extends Bt{constructor(t,e){super(),this.entity=e,(0,vs.Z)(this,"BackFaceCulling",fs,this),this.isOwn=!1,this.linkEntitys=new(Q()),this.material=void 0,this.init=!1,this.init=!0,this.material=t,t&&(this._name=t.name),this.isOwn=!!t}get Material(){return this.material}get AllTextures(){return[]}get Name(){return this._name}set Name(t){this._name=t,this.material&&(this.material.name=t)}updateFromDiff(){const t=this.entity.diffMaterials.get(this.material.id);if(t){for(const e in t)if(e in this)vt()(e).call(e,"Texture")&&"number"==typeof t[e]?this[e]=this.entity.DB.getObjectId(t[e]):this[e]=t[e];else if(as()(e).call(e,"Texture")){const i=this[Rs(e)];if(i.Object&&t[e]){for(const s in t[e])i.Object.Texture[s]=t[e][s];i.Object.readFromTexture()}}this.update()}}updateMaterial(){this.material.backFaceCulling=this.BackFaceCulling}update(){this.updateMaterial()}async waitRender(){return!0}initByOwnMaterial(t){for(let e in this){const i=Z()(e).call(e,1),s=Rs(i);H()(e).call(e,"_")&&s in this&&(this[s]=t[i])}}readFile(t){super.readFile(t),t.read(),this.BackFaceCulling=t.read()}writeFile(t){super.writeFile(t),t.write(1),t.write(this.BackFaceCulling)}showMeshBox(t){const e=this.material.getBindedMeshes();b()(e).call(e,(e=>e.showBoundingBox=t??!e.showBoundingBox))}destory(){super.destory(),this.material&&this.material.dispose()}importOwnTextures(){}},fs=(0,xs.Z)(bs.prototype,"BackFaceCulling",[Ls],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bs);!function(t){t[t.None=0]="None",t[t.C=1]="C",t[t.W=2]="W"}(Fs||(Fs={}));const js={[Di.kD.POINTERDOWN]:"pointerDown",[Di.kD.POINTERUP]:"pointerUp",[Di.kD.POINTERMOVE]:"pointerMove",[Di.kD.POINTERPICK]:"pointerPick",[Di.kD.POINTERWHEEL]:"pointerWheel",[Di.kD.POINTERTAP]:"pointerTap",[Di.kD.POINTERDOUBLETAP]:"pointerDoubleTap"},Bs={pointerOver:wi.k.OnPointerOverTrigger,pointerOut:wi.k.OnPointerOutTrigger,pointerLongPress:wi.k.OnLongPressTrigger};let Ns,Gs,Hs,Vs,Zs,Ws,Us,Ks,Ys,qs,Xs,$s,Qs,Js;function ta(t){return t[t.length-1]}function ea(t,e){let i=0;for(let s=0,a=t.length;s<a;s++)t[s]!==e&&(t[i++]=t[s]);return t.length=i,t}function ia(t,e){let i=0;for(let s=0,a=t.length;s<a;s++)e(t[s])||(t[i++]=t[s]);return t.length=i,t}function sa(t){return Wt.w1.ToRadians(t)}function aa(t){return Wt.w1.ToDegrees(t)}!function(t){t[t.None=0]="None",t[t.Pan=1]="Pan",t[t.Roate=2]="Roate",t[t.Zoom=4]="Zoom",t[t.All=7]="All"}(Ns||(Ns={})),function(t){t[t.Up=1]="Up",t[t.Down=2]="Down",t[t.Left=3]="Left",t[t.Right=4]="Right",t[t.Front=5]="Front",t[t.Back=6]="Back",t[t.SW=7]="SW"}(Gs||(Gs={})),function(t){t[t.FLOAT=Gi.f.ANIMATIONTYPE_FLOAT]="FLOAT",t[t.COLOR=Gi.f.ANIMATIONTYPE_COLOR3]="COLOR",t[t.COLOR4=Gi.f.ANIMATIONTYPE_COLOR4]="COLOR4"}(Hs||(Hs={})),function(t){t[t.None=0]="None",t[t.Translate=1]="Translate",t[t.Rotate=2]="Rotate",t[t.Scale=4]="Scale",t[t.All=7]="All"}(Vs||(Vs={})),function(t){t[t.Center=0]="Center",t[t.Bottom=1]="Bottom",t[t.Top=2]="Top",t[t.Left=3]="Left",t[t.Right=4]="Right",t[t.Front=5]="Front",t[t.Back=6]="Back",t[t.LFB=351]="LFB",t[t.RFB=451]="RFB",t[t.LBB=361]="LBB",t[t.RBB=461]="RBB"}(Zs||(Zs={})),function(t){t[t.Equal=0]="Equal",t[t.Greater=1]="Greater",t[t.Less=2]="Less",t[t.GreEqu=3]="GreEqu",t[t.LessEqu=4]="LessEqu"}(Ws||(Ws={})),function(t){t[t.Wireframe=1]="Wireframe",t[t.Conceptual=2]="Conceptual",t[t.Physical=3]="Physical"}(Us||(Us={})),function(t){t[t.Offset=0]="Offset",t[t.To=1]="To"}(Ks||(Ks={})),function(t){t[t.Equal=0]="Equal",t[t.UnEqual=1]="UnEqual",t[t.Great=2]="Great",t[t.Less=3]="Less",t[t.GtEqual=4]="GtEqual",t[t.LessEqual=5]="LessEqual",t[t.Include=6]="Include",t[t.UnInclude=7]="UnInclude",t[t.Is=8]="Is",t[t.IsNot=9]="IsNot"}(Ys||(Ys={})),function(t){t[t.None=0]="None",t[t.Sun=1]="Sun",t[t.Image=2]="Image",t[t.Env=3]="Env",t[t.Skybox=4]="Skybox"}(qs||(qs={})),function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right"}(Xs||(Xs={})),function(t){t[t.Digit1=49]="Digit1",t[t.Digit2=50]="Digit2",t[t.Digit3=51]="Digit3",t[t.Digit4=52]="Digit4",t[t.Digit5=53]="Digit5",t[t.Digit6=54]="Digit6",t[t.Digit7=55]="Digit7",t[t.Digit8=56]="Digit8",t[t.Digit9=57]="Digit9",t[t.Digit0=58]="Digit0",t[t.KeyA=65]="KeyA",t[t.KeyB=66]="KeyB",t[t.KeyC=67]="KeyC",t[t.KeyD=68]="KeyD",t[t.KeyE=69]="KeyE",t[t.KeyF=70]="KeyF",t[t.KeyG=71]="KeyG",t[t.KeyH=72]="KeyH",t[t.KeyI=73]="KeyI",t[t.KeyJ=74]="KeyJ",t[t.KeyK=75]="KeyK",t[t.KeyL=76]="KeyL",t[t.KeyM=77]="KeyM",t[t.KeyN=78]="KeyN",t[t.KeyO=79]="KeyO",t[t.KeyP=80]="KeyP",t[t.KeyQ=81]="KeyQ",t[t.KeyR=82]="KeyR",t[t.KeyS=83]="KeyS",t[t.KeyT=84]="KeyT",t[t.KeyU=85]="KeyU",t[t.KeyV=86]="KeyV",t[t.KeyW=87]="KeyW",t[t.KeyX=88]="KeyX",t[t.KeyY=89]="KeyY",t[t.KeyZ=90]="KeyZ",t[t.Comma=188]="Comma",t[t.CommaChrome=229]="CommaChrome",t[t.Period=190]="Period",t[t.Semicolon=186]="Semicolon",t[t.Quote=222]="Quote",t[t.BracketLeft=219]="BracketLeft",t[t.BracketRight=220]="BracketRight",t[t.Backquote=192]="Backquote",t[t.Backslash=220]="Backslash",t[t.Minus=189]="Minus",t[t.Equal=187]="Equal",t[t.IntlRo=193]="IntlRo",t[t.IntlYen=255]="IntlYen",t[t.Alt=18]="Alt",t[t.CapsLock=20]="CapsLock",t[t.Control=17]="Control",t[t.OSLeft=91]="OSLeft",t[t.OSRight=92]="OSRight",t[t.Shift=16]="Shift",t[t.ContextMenu=93]="ContextMenu",t[t.Enter=13]="Enter",t[t.Space=32]="Space",t[t.Backspace=8]="Backspace",t[t.Tab=9]="Tab",t[t.Delete=46]="Delete",t[t.End=35]="End",t[t.Home=36]="Home",t[t.Insert=45]="Insert",t[t.PageDown=34]="PageDown",t[t.PageUp=33]="PageUp",t[t.ArrowDown=40]="ArrowDown",t[t.ArrowLeft=37]="ArrowLeft",t[t.ArrowRight=39]="ArrowRight",t[t.ArrowUp=38]="ArrowUp",t[t.Escape=27]="Escape",t[t.PrintScreen=44]="PrintScreen",t[t.ScrollLock=145]="ScrollLock",t[t.Pause=19]="Pause",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NumLock=114]="NumLock",t[t.Numpad0=96]="Numpad0",t[t.Numpad1=97]="Numpad1",t[t.Numpad2=98]="Numpad2",t[t.Numpad3=99]="Numpad3",t[t.Numpad4=100]="Numpad4",t[t.Numpad5=101]="Numpad5",t[t.Numpad6=102]="Numpad6",t[t.Numpad7=103]="Numpad7",t[t.Numpad8=104]="Numpad8",t[t.Numpad9=105]="Numpad9",t[t.NumpadAdd=107]="NumpadAdd",t[t.NumpadDivide=111]="NumpadDivide",t[t.NumpadEqual=12]="NumpadEqual",t[t.NumpadMultiply=106]="NumpadMultiply",t[t.NumpadSubtract=109]="NumpadSubtract",t[t.NumpadDot=110]="NumpadDot",t[t.NumpadDot1=190]="NumpadDot1"}($s||($s={})),function(t){t.Digit1="Digit1",t.Digit2="Digit2",t.Digit3="Digit3",t.Digit4="Digit4",t.Digit5="Digit5",t.Digit6="Digit6",t.Digit7="Digit7",t.Digit8="Digit8",t.Digit9="Digit9",t.Digit0="Digit0",t.KeyA="KeyA",t.KeyB="KeyB",t.KeyC="KeyC",t.KeyD="KeyD",t.KeyE="KeyE",t.KeyF="KeyF",t.KeyG="KeyG",t.KeyH="KeyH",t.KeyI="KeyI",t.KeyJ="KeyJ",t.KeyK="KeyK",t.KeyL="KeyL",t.KeyM="KeyM",t.KeyN="KeyN",t.KeyO="KeyO",t.KeyP="KeyP",t.KeyQ="KeyQ",t.KeyR="KeyR",t.KeyS="KeyS",t.KeyT="KeyT",t.KeyU="KeyU",t.KeyV="KeyV",t.KeyW="KeyW",t.KeyX="KeyX",t.KeyY="KeyY",t.KeyZ="KeyZ",t.Comma="Comma",t.CommaChrome="CommaChrome",t.Period="Period",t.Semicolon="Semicolon",t.Quote="Quote",t.BracketLeft="BracketLeft",t.BracketRight="BracketRight",t.Backquote="Backquote",t.Backslash="Backslash",t.Minus="Minus",t.Equal="Equal",t.IntlRo="IntlRo",t.IntlYen="IntlYen",t.Alt="Alt",t.AltLeft="AltLeft",t.CapsLock="CapsLock",t.Control="Control",t.ControlLeft="ControlLeft",t.OSLeft="OSLeft",t.OSRight="OSRight",t.Shift="Shift",t.ShiftLeft="ShiftLeft",t.ShiftRight="ShiftRight",t.ContextMenu="ContextMenu",t.Enter="Enter",t.Space="Space",t.Backspace="Backspace",t.Tab="Tab",t.Delete="Delete",t.End="End",t.Home="Home",t.Insert="Insert",t.PageDown="PageDown",t.PageUp="PageUp",t.ArrowDown="ArrowDown",t.ArrowLeft="ArrowLeft",t.ArrowRight="ArrowRight",t.ArrowUp="ArrowUp",t.Escape="Escape",t.PrintScreen="PrintScreen",t.ScrollLock="ScrollLock",t.Pause="Pause",t.F1="F1",t.F2="F2",t.F3="F3",t.F5="F5",t.F6="F6",t.F7="F7",t.F8="F8",t.F9="F9",t.F10="F10",t.F11="F11",t.F12="F12",t.NumLock="NumLock",t.Numpad0="Numpad0",t.Numpad1="Numpad1",t.Numpad2="Numpad2",t.Numpad3="Numpad3",t.Numpad4="Numpad4",t.Numpad5="Numpad5",t.Numpad6="Numpad6",t.Numpad7="Numpad7",t.Numpad8="Numpad8",t.Numpad9="Numpad9",t.NumpadAdd="NumpadAdd",t.NumpadDivide="NumpadDivide",t.NumpadEqual="NumpadEqual",t.NumpadMultiply="NumpadMultiply",t.NumpadSubtract="NumpadSubtract",t.NumpadDot="NumpadDot",t.NumpadDot1="NumpadDot1"}(Qs||(Qs={})),function(t){let e;t.writeFile=function(t,e){let i=new Blob([e],{type:"octet/stream"}),s=document.createElement("a");s.download=t,s.href=Ht().createObjectURL(i),s.style.display="none",s.onclick=function(){document.body.removeChild(s)},document.body.appendChild(s),s.click()},t.chooseFile=function({filter:t,multiple:i=!1,callback:s}){e&&e.remove(),e=document.createElement("input"),e.type="file",e.style.display="none",document.body.appendChild(e),e.accept=t,e.onchange=()=>{e.files.length>0&&s(e.files)},e.multiple=i,e.click()}}(Js||(Js={}));class ra extends mi.k{static GetCenterFromPoints(t){if(t.length<=1)return t[0];const e=oa(t[0],t[1]),i=ha(t[0],t[1]),s=new ra(e,i);return t.length>2&&s.setFromPoints(Z()(t).call(t,2)),s.center}constructor(t=ki.P.Zero(),e=ki.P.Zero(),i){super(t,e,i)}get Size(){return this.extendSize.scale(2)}get SizeWorld(){return this.extendSizeWorld.scale(2)}union(t){const e=this.minimumWorld.clone(),i=t.minimumWorld.clone();e.set(Math.min(e.x,i.x),Math.min(e.y,i.y),Math.min(e.z,i.z));const s=this.maximumWorld.clone(),a=t.maximumWorld.clone();return s.set(Math.max(s.x,a.x),Math.max(s.y,a.y),Math.max(s.z,a.z)),this.reConstruct(e,s),this}expandByPoint(t){return this.min(this.minimum,t),this.max(this.maximum,t),this.reConstruct(this.minimum,this.maximum,this.getWorldMatrix()),this}setFromPoints(t){for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this.reConstruct(this.minimum,this.maximum,this.getWorldMatrix()),this}min(t,e){return t.x=Math.min(t.x,e.x),t.y=Math.min(t.y,e.y),t.z=Math.min(t.z,e.z),this}max(t,e){return t.x=Math.max(t.x,e.x),t.y=Math.max(t.y,e.y),t.z=Math.max(t.z,e.z),this}}function na(t,e){const i=t.minimum,s=e.minimum;t.minimum.set(Math.min(i.x,s.x),Math.min(i.y,s.y),Math.min(i.z,s.z));const a=t.maximum,r=e.maximum;return t.maximum.set(Math.max(a.x,r.x),Math.max(a.y,r.y),Math.max(a.z,r.z)),t}function oa(t,e){const i=new ki.P;return i.x=Math.min(t.x,e.x),i.y=Math.min(t.y,e.y),i.z=Math.min(t.z,e.z),i}function ha(t,e){const i=new ki.P;return i.x=Math.max(t.x,e.x),i.y=Math.max(t.y,e.y),i.z=Math.max(t.z,e.z),i}function la(t,e,i){return new He.c(t,e,i)}function ca(t,e,i){return new Ve.f(t,e,i)}function da(t,e,i){const s=t.material;if(!s)return;i.blockMaterialDirtyMechanism=!1;const a=t.getWorldMatrix(),r=t.getVerticesData("normal");let n=new ki.P(r[0],r[1],r[2]),o=ki.P.TransformNormal(n,a);const h=Si.J.FromPositionAndNormal(t.absolutePosition,o.scale(-1)),l=new vi.h("mirror"+this.Id,1024,i,!0);s.reflectionTexture=l,l.mirrorPlane=h,l.renderList=e,l.level=1,i.blockMaterialDirtyMechanism=!0}function ua(t,e){return new Fi.x(t,e)}function pa(t){return new Re.W(t)}var ma=i(55799),ga=i.n(ma),_a=i(40698),wa=i.n(_a);const ya=[[0,0,0,0],[255,0,0,255],[255,255,0,255],[0,255,0,255],[0,255,255,255],[0,0,255,255],[255,0,255,255],[255,255,255,255],[128,128,128,255],[192,192,192,255],[255,0,0,255],[255,127,127,255],[165,0,0,255],[165,82,82,255],[127,0,0,255],[127,63,63,255],[76,0,0,255],[76,38,38,255],[38,0,0,255],[38,19,19,255],[255,63,0,255],[255,159,127,255],[165,41,0,255],[165,103,82,255],[127,31,0,255],[127,79,63,255],[76,19,0,255],[76,47,38,255],[38,9,0,255],[38,23,19,255],[255,127,0,255],[255,191,127,255],[165,82,0,255],[165,124,82,255],[127,63,0,255],[127,95,63,255],[76,38,0,255],[76,57,38,255],[38,19,0,255],[38,28,19,255],[255,191,0,255],[255,223,127,255],[165,124,0,255],[165,145,82,255],[127,95,0,255],[127,111,63,255],[76,57,0,255],[76,66,38,255],[38,28,0,255],[38,33,19,255],[255,255,0,255],[255,255,127,255],[165,165,0,255],[165,165,82,255],[127,127,0,255],[127,127,63,255],[76,76,0,255],[76,76,38,255],[38,38,0,255],[38,38,19,255],[191,255,0,255],[223,255,127,255],[124,165,0,255],[145,165,82,255],[95,127,0,255],[111,127,63,255],[57,76,0,255],[66,76,38,255],[28,38,0,255],[33,38,19,255],[127,255,0,255],[191,255,127,255],[82,165,0,255],[124,165,82,255],[63,127,0,255],[95,127,63,255],[38,76,0,255],[57,76,38,255],[19,38,0,255],[28,38,19,255],[63,255,0,255],[159,255,127,255],[41,165,0,255],[103,165,82,255],[31,127,0,255],[79,127,63,255],[19,76,0,255],[47,76,38,255],[9,38,0,255],[23,38,19,255],[0,255,0,255],[127,255,127,255],[0,165,0,255],[82,165,82,255],[0,127,0,255],[63,127,63,255],[0,76,0,255],[38,76,38,255],[0,38,0,255],[19,38,19,255],[0,255,63,255],[127,255,159,255],[0,165,41,255],[82,165,103,255],[0,127,31,255],[63,127,79,255],[0,76,19,255],[38,76,47,255],[0,38,9,255],[19,38,23,255],[0,255,127,255],[127,255,191,255],[0,165,82,255],[82,165,124,255],[0,127,63,255],[63,127,95,255],[0,76,38,255],[38,76,57,255],[0,38,19,255],[19,38,28,255],[0,255,191,255],[127,255,223,255],[0,165,124,255],[82,165,145,255],[0,127,95,255],[63,127,111,255],[0,76,57,255],[38,76,66,255],[0,38,28,255],[19,38,33,255],[0,255,255,255],[127,255,255,255],[0,165,165,255],[82,165,165,255],[0,127,127,255],[63,127,127,255],[0,76,76,255],[38,76,76,255],[0,38,38,255],[19,38,38,255],[0,191,255,255],[127,223,255,255],[0,124,165,255],[82,145,165,255],[0,95,127,255],[63,111,127,255],[0,57,76,255],[38,66,76,255],[0,28,38,255],[19,33,38,255],[0,127,255,255],[127,191,255,255],[0,82,165,255],[82,124,165,255],[0,63,127,255],[63,95,127,255],[0,38,76,255],[38,57,76,255],[0,19,38,255],[19,28,38,255],[0,63,255,255],[127,159,255,255],[0,41,165,255],[82,103,165,255],[0,31,127,255],[63,79,127,255],[0,19,76,255],[38,47,76,255],[0,9,38,255],[19,23,38,255],[0,0,255,255],[127,127,255,255],[0,0,165,255],[82,82,165,255],[0,0,127,255],[63,63,127,255],[0,0,76,255],[38,38,76,255],[0,0,38,255],[19,19,38,255],[63,0,255,255],[159,127,255,255],[41,0,165,255],[103,82,165,255],[31,0,127,255],[79,63,127,255],[19,0,76,255],[47,38,76,255],[9,0,38,255],[23,19,38,255],[127,0,255,255],[191,127,255,255],[82,0,165,255],[124,82,165,255],[63,0,127,255],[95,63,127,255],[38,0,76,255],[57,38,76,255],[19,0,38,255],[28,19,38,255],[191,0,255,255],[223,127,255,255],[124,0,165,255],[145,82,165,255],[95,0,127,255],[111,63,127,255],[57,0,76,255],[66,38,76,255],[28,0,38,255],[33,19,38,255],[255,0,255,255],[255,127,255,255],[165,0,165,255],[165,82,165,255],[127,0,127,255],[127,63,127,255],[76,0,76,255],[76,38,76,255],[38,0,38,255],[38,19,38,255],[255,0,191,255],[255,127,223,255],[165,0,124,255],[165,82,145,255],[127,0,95,255],[127,63,111,255],[76,0,57,255],[76,38,66,255],[38,0,28,255],[38,19,33,255],[255,0,127,255],[255,127,191,255],[165,0,82,255],[165,82,124,255],[127,0,63,255],[127,63,95,255],[76,0,38,255],[76,38,57,255],[38,0,19,255],[38,19,28,255],[255,0,63,255],[255,127,159,255],[165,0,41,255],[165,82,103,255],[127,0,31,255],[127,63,79,255],[76,0,19,255],[76,38,47,255],[38,0,9,255],[38,19,23,255],[84,84,84,255],[118,118,118,255],[152,152,152,255],[186,186,186,255],[220,220,220,255],[255,255,255,255],[0,0,0,0]];function ba(t){return"string"==typeof t?xi.Wo.FromHexString(t):xi.Wo.FromHexString(t.toString())}function fa(t){return"string"==typeof t?xi.HE.FromHexString(t):xi.HE.FromHexString(t.toString())}const va=t=>`${t>15?"":0}${t.toString(16)}`,xa=t=>{const{r:e,g:i,b:s,a=1}=t;return`#${va(e)}${va(i)}${va(s)}${1===a?"":va(Math.floor(255*a))}`},Sa=t=>{const{r:e,g:i,b:s}=t;return`rgb(${e},${i},${s})`},Ma=(t,e=1e4)=>{const{r:i,g:s,b:a,a:r=1}=t;return`rgba(${i},${s},${a},${Math.floor(r*e)/e})`},Oa=t=>{let e=Z()(t).call(t,1),i=1;3===e.length&&(e=`${e[0]}${e[0]}${e[1]}${e[1]}${e[2]}${e[2]}`),8===e.length&&(i=ga()(Z()(e).call(e,6),16)/255,e=Z()(e).call(e,0,6));const s=ga()(e,16);return{r:s>>16&255,g:s>>8&255,b:255&s,a:i}},Pa=t=>{const e=t.match(/(\d(\.\d+)?)+/g)||[],i=wa()(e).call(e,(t=>ga()(t,10)));return{r:i[0],g:i[1],b:i[2],a:ns()(e[3]??"1")}},Ca=t=>{if(H()(t).call(t,"#"))return Oa(t);if(H()(t).call(t,"rgb"))return Pa(t);if("transparent"===t)return Oa("#00000000");throw new Error(`color string error: ${t}`)},Aa=t=>{const e=Ca(t);return{hex:xa(e),rgba:Ma(e),rgb:Sa(e),rgbaObj:e}},Ea=t=>{const e=Ca(t);return Ma(e)},za=t=>{const e=Ca(t);return xa(e)};async function Da(t,e){const i=Yi.V.CreateGround("ground",{width:1,height:1,subdivisions:128},t);i.scaling=new ki.P(e,e,e),i.position.y=-e/4;const s=await ke.O.ParseFromFileAsync("waterMaterial","https://hcwl-cdn.cdn.bcebos.com/hc3d/envs/water.json",t);i.material=s;const a=new Ne.e("defaultPipeline",!1,t,[t.activeCamera]);return a.bloomEnabled=!0,a.bloomThreshold=0,a.bloomKernel=.35,a.bloomScale=.5,a.grainEnabled=!0,a.grain.intensity=8,a.grain.animated=!0,a.chromaticAberrationEnabled=!0,a.chromaticAberration.aberrationAmount=65.1,a.chromaticAberration.radialIntensity=2,a.sharpenEnabled=!0,a.sharpen.edgeAmount=.15,i}function Ta(t,e){let i=Yi.V.CreateGround("ground",{width:t,height:t},e),s=new je.j("test",e,{vertex:"myshader",fragment:"myshader"},{needAlphaBlending:!0,attributes:["position"],uniforms:["world","view","viewProjection","vFogInfos","vFogColor","time","mouse","resolution"],samplers:[]});i.material=s;let a=.1;s.onBind=function(t){let e=s.getEffect();e.setFloat("time",a+=.001),e.setVector2("mouse",new ki.FM(.8,.5)),e.setVector2("resolution",new ki.FM(1024,1024))}}function Ra(t,e,i=[],s){const a=(0,Be.uH)("waterMesh",{radius:e},t);a.rotation.x=Math.PI/2;const r=new Ge.H("water",t,new ki.FM(512,512));return r.backFaceCulling=!0,r.bumpTexture=new Fi.x("https://hcwl-cdn.cdn.bcebos.com/hc3d/textures/waterbump.png",t),r.windForce=-10,r.waveHeight=2,r.bumpHeight=.2,r.windDirection=new ki.FM(1,0),r.waterColor=new xi.Wo(.1,.1,.6),r.colorBlendFactor=0,b()(i).call(i,(t=>r.addToRenderList(t))),s?.[0]&&(r.waterColor=xi.Wo.FromHexString(s[0])),s?.[1]&&(r.waterColor2=xi.Wo.FromHexString(s[1])),a.material=r,[a,r]}function Ia(t){Wt.w1.Log(t)}function La(t){Wt.w1.Error(t)}function Fa(t){Wt.w1.Warn(t)}Fe.Q.ShadersStore.myshaderVertexShader="\n         attribute vec3 position;                \n         uniform mat4 world;                    \n         uniform mat4 view;                    \n         uniform mat4 viewProjection;          \n         varying float fFogDistance;\n         void main(void) {\n                 vec4 worldPosition = world * vec4(position, 1.0);\n                 fFogDistance = (view * worldPosition).z;\n                 gl_Position =  viewProjection * worldPosition;\n         }",Fe.Q.ShadersStore.myshaderFragmentShader='\n      #ifdef GL_ES\n  precision mediump float;\n  #endif\n  \n  uniform float time;\n  uniform vec2 mouse;\n  uniform vec2 resolution;\n  \n  // "Seascape" by Alexander Alekseev aka TDM - 2014\n  // License Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.\n  \n  const int NUM_STEPS = 12;\n  const float PI\t \t= 3.1415;\n  const float EPSILON\t= 1e-3;\n  float EPSILON_NRM\t= 0.;\n  \n  // sea\n  const int ITER_GEOMETRY = 3;\n  const int ITER_FRAGMENT = 5;\n  const float SEA_HEIGHT = 0.6;\n  const float SEA_CHOPPY = 4.0;\n  const float SEA_SPEED = 0.8;\n  const float SEA_FREQ = 0.16;\n  const vec3 SEA_BASE = vec3(0.1,0.19,0.22);\n  const vec3 SEA_WATER_COLOR = vec3(0.8,0.9,0.6);\n  float SEA_TIME = 0.;\n  mat2 octave_m = mat2(1.6,1.2,-1.2,1.6);\n  \n  // math\n  mat3 fromEuler(vec3 ang) {\n      vec2 a1 = vec2(sin(ang.x),cos(ang.x));\n      vec2 a2 = vec2(sin(ang.y),cos(ang.y));\n      vec2 a3 = vec2(sin(ang.z),cos(ang.z));\n      mat3 m;\n      m[0] = vec3(a1.y*a3.y+a1.x*a2.x*a3.x,a1.y*a2.x*a3.x+a3.y*a1.x,-a2.y*a3.x);\n      m[1] = vec3(-a2.y*a1.x,a1.y*a2.y,a2.x);\n      m[2] = vec3(a3.y*a1.x*a2.x+a1.y*a3.x,a1.x*a3.x-a1.y*a3.y*a2.x,a2.y*a3.y);\n      return m;\n  }\n  float hash( vec2 p ) {\n      float h = dot(p,vec2(127.1,311.7));\t\n      return fract(sin(h)*43758.5453123);\n  }\n  float noise( in vec2 p ) {\n      vec2 i = floor( p );\n      vec2 f = fract( p );\t\n      vec2 u = f*f*(3.0-2.0*f);\n      return -1.0+2.0*mix( mix( hash( i + vec2(0.0,0.0) ), \n                       hash( i + vec2(1.0,0.0) ), u.x),\n                  mix( hash( i + vec2(0.0,1.0) ), \n                       hash( i + vec2(1.0,1.0) ), u.x), u.y);\n  }\n  \n  // lighting\n  float diffuse(vec3 n,vec3 l,float p) {\n      return pow(dot(n,l) * 0.4 + 0.6,p);\n  }\n  float specular(vec3 n,vec3 l,vec3 e,float s) {    \n      float nrm = (s + 8.0) / (3.1415 * 8.0);\n      return pow(max(dot(reflect(e,n),l),0.0),s) * nrm;\n  }\n  \n  // sky\n  vec3 getSkyColor(vec3 e) {\n      e.y = max(e.y,0.0);\n      vec3 ret;\n      ret.x = pow(1.0-e.y,2.0);\n      ret.y = 1.0-e.y;\n      ret.z = 0.6+(1.0-e.y)*0.4;\n      return ret;\n  }\n  \n  // sea\n  float sea_octave(vec2 uv, float choppy) {\n      uv += noise(uv);        \n      vec2 wv = 1.0-abs(sin(uv));\n      vec2 swv = abs(cos(uv));    \n      wv = mix(wv,swv,wv);\n      return pow(1.0-pow(wv.x * wv.y,0.65),choppy);\n  }\n  \n  float map(vec3 p) {\n      float freq = SEA_FREQ;\n      float amp = SEA_HEIGHT;\n      float choppy = SEA_CHOPPY;\n      vec2 uv = p.xz; uv.x *= 0.75;\n      \n      float d, h = 0.0;    \n      for(int i = 0; i < ITER_GEOMETRY; i++) {        \n          d = sea_octave((uv+SEA_TIME)*freq,choppy);\n          d += sea_octave((uv-SEA_TIME)*freq,choppy);\n          h += d * amp;        \n          uv *= octave_m; freq *= 1.9; amp *= 0.22;\n          choppy = mix(choppy,1.0,0.2);\n      }\n      return p.y - h;\n  }\n  \n  float map_detailed(vec3 p) {\n      float freq = SEA_FREQ;\n      float amp = SEA_HEIGHT;\n      float choppy = SEA_CHOPPY;\n      vec2 uv = p.xz; uv.x *= 0.75;\n      \n      float d, h = 0.0;    \n      for(int i = 0; i < ITER_FRAGMENT; i++) {        \n          d = sea_octave((uv+SEA_TIME)*freq,choppy);\n          d += sea_octave((uv-SEA_TIME)*freq,choppy);\n          h += d * amp;        \n          uv *= octave_m; freq *= 1.9; amp *= 0.22;\n          choppy = mix(choppy,1.0,0.2);\n      }\n      return p.y - h;\n  }\n  \n  vec3 getSeaColor(vec3 p, vec3 n, vec3 l, vec3 eye, vec3 dist) {  \n      float fresnel = 1.0 - max(dot(n,-eye),0.0);\n      fresnel = pow(fresnel,3.0) * 0.65;\n          \n      vec3 reflected = getSkyColor(reflect(eye,n));    \n      vec3 refracted = SEA_BASE + diffuse(n,l,80.0) * SEA_WATER_COLOR * 0.12; \n      \n      vec3 color = mix(refracted,reflected,fresnel);\n      \n      float atten = max(1.0 - dot(dist,dist) * 0.001, 0.0);\n      color += SEA_WATER_COLOR * (p.y - SEA_HEIGHT) * 0.18 * atten;\n      \n      color += vec3(specular(n,l,eye,60.0));\n      \n      return color;\n  }\n  \n  // tracing\n  vec3 getNormal(vec3 p, float eps) {\n      vec3 n;\n      n.y = map_detailed(p);    \n      n.x = map_detailed(vec3(p.x+eps,p.y,p.z)) - n.y;\n      n.z = map_detailed(vec3(p.x,p.y,p.z+eps)) - n.y;\n      n.y = eps;\n      return normalize(n);\n  }\n  \n  float heightMapTracing(vec3 ori, vec3 dir, out vec3 p) {  \n      float tm = 0.0;\n      float tx = 1000.0;    \n      float hx = map(ori + dir * tx);\n      if(hx > 0.0) return tx;   \n      float hm = map(ori + dir * tm);    \n      float tmid = 0.0;\n      for(int i = 0; i < NUM_STEPS; i++) {\n          tmid = mix(tm,tx, hm/(hm-hx));                   \n          p = ori + dir * tmid;                   \n          float hmid = map(p);\n          if(hmid < 0.0) {\n              tx = tmid;\n              hx = hmid;\n          } else {\n              tm = tmid;\n              hm = hmid;\n          }\n      }\n      return tmid;\n  }\n  \n  // main\n  void main() {\n      EPSILON_NRM = 0.1 / resolution.x;\n      SEA_TIME = time * SEA_SPEED;\n      \n      vec2 uv = gl_FragCoord.xy / resolution.xy;\n      uv = uv * 2.0 - 1.0;\n      uv.x *= resolution.x / resolution.y;  \n      float time2 = 0.0;\n      time2 = time * 0.1 + (mouse.x*10.0);\n          \n      // ray\n      vec3 ang = vec3(sin(time2*3.0)*0.1,sin(time2)*0.2+0.3,time2);    \n      vec3 ori = vec3(0.0,3.5,time*5.0);\n      vec3 dir = normalize(vec3(uv.xy,-2.0)); \n      dir.z += length(uv) * 0.15;\n      dir = normalize(dir) * fromEuler(ang);\n      \n      // tracing\n      vec3 p;\n      heightMapTracing(ori,dir,p);\n      vec3 dist = p - ori;\n      vec3 n = getNormal(p, dot(dist,dist) * EPSILON_NRM);\n      vec3 light = normalize(vec3(0.0,1.0,0.8)); \n               \n      // color\n      vec3 color = mix(\n          getSkyColor(dir),\n          getSeaColor(p,n,light,dir,dist),\n          pow(smoothstep(0.0,-0.05,dir.y),0.3));\n          \n      // post\n      gl_FragColor = vec4(pow(color,vec3(0.75)), 1.0);\n  }';var ka=i(82165),ja=i.n(ka);function Ba(t,e,i){return new Na(t,e,i).MidPoint}class Na{constructor(t,e,i){this.bul=i,this.StartAngle=void 0,this.EndAngle=void 0,this.StartPoint=void 0,this.EndPoint=void 0,this.Center=void 0,this.Radius=void 0,this.MidPoint=void 0,this.StartPoint=t.clone(),this.EndPoint=e.clone();let s=e.subtract(t),a=s.length(),r=Ha(s);this.Radius=Math.abs(a/Math.sin(2*Math.atan(i))/2);let n=Math.abs(i*a/2),o=this.Radius-n;r+=.5*Math.PI*ja()(i),this.Center=ki.FM.Center(t,e),this.MidPoint=this.Center.clone(),Ga(this.Center,r,o),Ga(this.MidPoint,r+Math.PI,n),this.StartAngle=Ha(t.clone().subtract(this.Center)),this.EndAngle=Ha(e.clone().subtract(this.Center)),i<0&&(this.StartAngle-=Math.PI,this.EndAngle-=Math.PI)}get AllAngle(){return 4*Math.atan(this.bul)}}function Ga(t,e,i){return t.x+=Math.cos(e)*i,t.y+=Math.sin(e)*i,t}function Ha(t){return Math.atan2(-t.y,-t.x)+Math.PI}function Va(t,e,i=1e-8){return t.clone().cross(e).lengthSquared()<i}function Za(t){return new ki.P(t.x,t.y)}function Wa(t){return new ki.FM(t.x,t.y)}function Ua(t,e){const i=new ki.FM(t.x,t.y),s=Ha(new ki.FM(e.x,e.y).subtract(i));return s<=Math.PI/4||s>=7*Math.PI/4?e.y=t.y:s>Math.PI/4&&s<=3*Math.PI/4?e.x=t.x:s>3*Math.PI/4&&s<=5*Math.PI/4?e.y=t.y:e.x=t.x,e}function Ka(t,e){let[i,s]=t;return i.x===s.x?Math.abs(e.x-i.x):i.y===s.y?Math.abs(e.y-i.y):Math.abs((i.y-s.y)*e.x+(s.x-i.x)*e.y+i.x*s.y-i.y*s.x)/Math.sqrt((i.y-s.y)*(i.y-s.y)+(i.x-s.x)*(i.x-s.x))}function Ya(t,e,i){if(t.equalsWithEpsilon(i)||e.equalsWithEpsilon(i))return{closestPt:i,dist:0};const s=e.subtract(t);let a=s.length();if(Ps(a,0))return{closestPt:t,dist:0};s.scaleInPlace(1/a);let r=i.subtract(t),n=ki.FM.Dot(s,r);const o=t.add(s.scale(n));return{closestPt:o,dist:ki.FM.Distance(i,o)}}function qa(t){return(t%=2*Math.PI)<0&&(t+=2*Math.PI),t}function Xa(t,e){return t.x*e.y-t.y*e.x}function $a(t){let e=0;for(let i=0;i<t.length-1;i++){e+=Xa(t[i],t[i+1])}return e}var Qa=i(73737);function Ja(t){Qa.Jlu.Configuration={decoder:{wasmUrl:t+"libs/draco/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:t+"libs/draco/draco_decoder_gltf.wasm",fallbackUrl:t+"libs/draco/draco_decoder_gltf.js"}}}function tr(t,e,i){t.metadata?"object"==typeof t.metadata&&(t.metadata[e]=i):t.metadata={[e]:i}}function er(t,e){return t.metadata&&"object"==typeof t.metadata?t.metadata[e]:null}function ir(t,e){let i=new We.B("pcs",12,e);i.addPoints(t.length,(function(e,i){e.position=t[i],e.color=new xi.HE(Math.random(),Math.random(),Math.random(),Math.random()),e.pivot=ki.P.Zero()})),i.buildMeshAsync()}function sr(){}new ki.P(1/0,1/0,1/0),new ki.P(-1/0,-1/0,-1/0);const ar=new ki.P;function rr(t){return ki.P.FromArray([t.x??0,t.y??0,t.z??0])}function nr(t,e){t.x=e.x??t.x,t.y=e.y??t.y,"z"in t&&"z"in e&&(t.z=e.z??t.z)}function or(t,e){return Ps(t.x,e.x)&&Ps(t.y,e.y)&&Ps(t.z,e.z)}function hr(t){return{x:t.x,y:t.y,z:t.z}}var lr,cr,dr=i(14228),ur=i.n(dr);class pr{constructor(t,e){this._name="\u672a\u547d\u540d",this._animation=void 0,this._animatable=void 0,this._entity=void 0,this._speedRadio=1,this._time=1,this._loop=!1,this._frame=30,this._loopCount=void 0,this._speed=void 0,this.completeCallback=void 0,this._meshId=void 0;let{time:i=1,loop:s=!1,frame:a=30,loopCount:r}=e;this.completeCallback=e?.complete,this._meshId=e?.meshId,this._entity=t,this._time=i,this._loop=s,this._frame=a,this._loopCount=r}get Animation(){return this._animation}get name(){return this._name}set name(t){this._name=t}getNodeByMeshId(t){const e=this._entity.DrawObject.getChildMeshes();return F()(e).call(e,(e=>{var i;return vt()(i=e.name).call(i,t)}))}get Target(){return this._meshId?this.getNodeByMeshId(this._meshId):this._entity?.isPart?this._entity.RenderObject:this._entity.DrawObject}init(){}start(){this.Target?.getScene?.()&&(this._animatable=this.Target.getScene().beginAnimation(this.Target,0,this._time*this._frame,this._loop,this._speedRadio),this.completeCallback&&this._animatable.onAnimationEndObservable.add(this.completeCallback),this._loopCount&&this._loop&&this.setLoopCount(this._loopCount))}pause(){this._animatable&&this._animatable.pause()}restart(){this._animatable&&this._animatable.restart()}stop(){this._animatable&&this._animatable.stop()}reset(){this._animatable&&this._animatable.reset()}clear(){const t=this._entity?.RenderObject;t&&ea(t.animations,this._animation)}writeFile(t){t.write(1),t.write(this._name),t.write(this._time),t.write(this._loop),t.write(this._frame),t.write(this._speedRadio),t.write(this._loopCount)}readFile(t){t.read(),this._name=t.read(),this._time=t.read(),this._loop=t.read(),this._frame=t.read(),this._speedRadio=t.read(),this._loopCount=t.read()}setLoopCount(t){let e;if(t){let i=0;e=this._animatable.onAnimationLoopObservable.add((s=>{i++,i===t&&(s.stop(),this._animatable.onAnimationEndObservable.remove(e))}))}return()=>{e&&this._animatable.onAnimationEndObservable.remove(e)}}}let mr=Y(((cr=class extends pr{constructor(t,e){super(t,e),this._name="\u672a\u547d\u540d\u79fb\u52a8",this._points=[];let{path:i,time:s=1,loop:a=!1,frame:r=30,loopCount:n,speed:o}=e;this._time=s,this._loop=a,this._frame=r,this._loopCount=n,this._speed=o,this._points=ur()(i)?i:i.Points,e.name&&(this._name=e.name),this.init()}init(){this._entity.removeAnimation(this._name);const t=this.Target,e=new Gi.f(this._name,"position",this._frame,Gi.f.ANIMATIONTYPE_VECTOR3),i=[];let s;const a=this._points;this._speed&&(this._time=this.totalDistance(this._points)/this._speed);for(let t=0;t<a.length;t++){var r;s=this.totalDistance(Z()(r=this._points).call(r,0,t+1))/this.totalDistance(this._points)*this._time,i.push({frame:this._frame*s,value:new ki.P(a[t].x,a[t].y,a[t].z)})}e.setKeys(i),t.animations.push(e),this._animation=e}totalDistance(t){let e=0;for(let i=0;i<t.length-1;i++)e+=this.distance(new ki.P(t[i].x,t[i].y,t[i].z),new ki.P(t[i+1].x,t[i+1].y,t[i+1].z));return e}distance(t,e){return ki.P.Distance(t,e)}writeFile(t){super.writeFile(t),t.write(1),t.write(this._points.length);for(const e of this._points)t.write(e.x),t.write(e.y),t.write(e.z)}readFile(t){super.readFile(t),t.read();const e=t.read();this._points.length=0;for(let i=0;i<e;i++){const e={x:0,y:0,z:0};e.x=t.read(),e.y=t.read(),e.z=t.read(),this._points.push(e)}}}).type="MoveAnimation",lr=cr))||lr;var gr,_r;let wr=Y(((_r=class{constructor(t){this._entity=t,this._animation=[],this._group=void 0,this._name="\u52a8\u753b\u7ec4",this.init()}get AnimationGroup(){return this._group}get Target(){return this._entity instanceof Zi.V?this._entity:this._entity.RenderObject.parent||this._entity.RenderObject}init(){const t=new Xi.O(this.name);for(const e of this._animation)t.addTargetedAnimation(e.Animation,this.Target);this._group=t}get name(){return this._name}set name(t){this._name=t}start(){this._group.start()}startAync(){return this.start(),new(N())((t=>{this._group.onAnimationGroupEndObservable.add(t)}))}pause(){this._group.pause()}restart(){this._group.restart()}stop(){this._group.stop()}reset(){this._group.reset()}append(t){this._group.addTargetedAnimation(t.Animation,this.Target)}writeFile(t){t.write(1);const e=this._entity instanceof Zi.V;t.write(e),e||t.writeHardObjectId(this._entity.ObjectId),t.writeAnyArray(this._animation,t.writeObject)}readFile(t){if(t.read(),!t.read()){const e=t.readHardObjectId();this._entity=e.Object}t.readAnyArrayAndPush(this._animation,t.readObject),this.init()}}).type="AnimationGroup",gr=_r))||gr;var yr,br;let fr=Y(((br=class extends wr{constructor(t,e){var i;(super(t),this._entity=t,this.option=e,this.path=void 0,this._name="\u8def\u5f84\u52a8\u753b",e?.path?.length)&&(this.path=wa()(i=e.path).call(i,rr));e?.curve&&(this.path=e.curve.Object?.Shape??[]),e?.name&&(this.name=e.name),t&&e&&this.init()}writeFile(t){super.writeFile(t),t.write(1),t.write(this.option.time),t.write(this.option.frame),t.write(this.option.loop),t.writeVector3(this.option.forward),t.writeAnyArray(this.option.path??[],t.writeVector3),t.writeHardObjectId(this.option.curve)}readFile(t){super.readFile(t),t.read(),this.option||(this.option={}),this.option.time=t.read()??1,this.option.frame=t.read()??30,this.option.loop=t.read()??!1;const e={};t.readVector3(e),void 0!==e.x&&(this.option.forward=e);const i=[];t.readAnyArray((()=>{const e={};t.readVector3(e),i.push(e)})),i.length&&(this.option.path=i),this.option.curve=t.readHardObjectId(),requestIdleCallback((()=>{const t=this.option;var e;t?.path?.length&&(this.path=wa()(e=t.path).call(e,rr));t?.curve&&(this.path=t.curve.Object?.Shape??[]),this.init()}))}init(){if(!this.option)return;if(0===this.path?.length)return;let{time:t=1,loop:e=!1,frame:i=30,loopCount:s,forward:a}=this.option;const r=new Xi.O(this.name),n=this.Target,o=n instanceof Zi.V,h=o?new ki.P(0,0,1):n.forward,l=o?new ki.P(1):n.right,c=o?new ki.P(0,1):n.up;let d=0;if(a){const t=rr(a).normalize();ki.P.TransformCoordinatesToRef(t,n.getWorldMatrix().getRotationMatrix(),t),d=Math.acos(ki.P.Dot(t,h));d*=ja()(ki.P.Cross(h,t).y)}const u=new Gi.f(this._name,o?"target":"rotationQuaternion",i,o?Gi.f.ANIMATIONTYPE_VECTOR3:Gi.f.ANIMATIONTYPE_QUATERNION),p=new Gi.f(this._name,"position",i,Gi.f.ANIMATIONTYPE_VECTOR3),m=[],g=[],_=t*i/this.getDistance();let w=0;m.push({frame:w,value:this.path[0]}),o&&(n.position=this.path[0],n.target=this.path[1]);for(let t=0;t<this.path.length-1;t++){let e=this.path[t],s=this.path[t+1];const a=s.subtract(e).normalize();ki.P.CrossToRef(c,a,l);let r=ki.y3.FromXYZAxesToRef(l,c,a,new ki.y3);ki.y3.RotationAxis(c,d).multiplyToRef(r,r),o?(w+=i,g.push({frame:w,value:s})):(g.push({frame:w,value:ki._f.FromRotationMatrix(r)}),g.push({frame:w,value:ki._f.FromRotationMatrix(r)})),w+=_*ki.P.Distance(e,s),m.push({frame:w,value:s}),o?(g.push({frame:w,value:s}),this.path[t+2]||(w+=i,g.push({frame:w,value:s.add(a)}))):g.push({frame:w,value:ki._f.FromRotationMatrix(r)})}p.setKeys(m),u.setKeys(g),r.addTargetedAnimation(p,n),r.addTargetedAnimation(u,n),this._group=r}getDistance(){let t=0;for(let e=0;e<this.path.length-1;e++){let i=this.path[e],s=this.path[e+1];t+=ki.P.Distance(i,s)}return t}}).type="PathAnimation",yr=br))||yr;var vr,xr;let Sr=Y((xr=class extends pr{constructor(t,e){super(t,e),this._name="\u672a\u547d\u540d\u65cb\u8f6c",this._from=0,this._angle=0,this._angles=[],this._dir=void 0,this._origin=void 0;let{angle:i,dir:s={x:0,y:1,z:0},time:a=1,frame:r=30,loop:n=!0,from:o=0,angles:h=[],loopCount:l,origin:c}=e;this._time=a,this._loop=n,this._frame=r,this._loopCount=l,this._dir=s,this._angle=i,this._from=o,e.name&&(this._name=e.name),this._origin=c,this._angles=h,this.init()}init(){this._entity.removeAnimation(this._name);const t=this.Target,e=new Gi.f(this._name,"rotationQuaternion",this._frame,Gi.f.ANIMATIONTYPE_QUATERNION);t.rotationQuaternion||(t.rotationQuaternion=t.rotation.toQuaternion(),t.rotation.setAll(0));const i=ki.P.FromArray(ms()(this._dir)).normalize(),s=[];if(this._angles?.length){const t=this._time/this._angles.length;for(let e=0;e<this._angles.length;e++)s.push({frame:this._frame*e*t,value:ki._f.RotationAxis(i,this._angles[e])})}else{s.push({frame:0,value:ki._f.RotationAxis(i,this._from)});const t=Math.abs(this._from-this._angle);if(t>2*Math.PI-.001){const e=Math.PI/4,a=Math.round(t/e),r=this._time/a;for(let t=1;t<=a;t++){const a=ki._f.RotationAxis(i,this._from+t*e);s.push({frame:this._frame*(r*t),value:a})}}}if(e.setKeys(s),this._origin){const e=ki.P.FromArray(ms()(this._origin)).negate(),i=rr(this._entity?this._entity.Position:ki.P.Zero()).add(e);t.setPivotMatrix(ki.y3.Translation(i.x,i.y,i.z))}t.animations.push(e),this._animation=e}writeFile(t){super.writeFile(t),t.write(1)}readFile(t){super.readFile(t),t.read();t.read()}},xr.type="RotateAnimation",vr=xr))||vr;const Mr=new ot;var Or=(0,hs.Z)("visibility"),Pr=(0,hs.Z)("enableEdge"),Cr=(0,hs.Z)("edgeWidth"),Ar=(0,hs.Z)("edgeColor");class Er extends pt{constructor(){super(),this.isAsync=!1,this.isLight=!1,this.isPart=!1,this.IsSelect=!1,this._enableShadow=!0,this._matrix=ki.y3.Identity(),this._scale=new ki.P(1,1,1),this._rotation=new ki.P,this._rotationQuaternion=new ki._f,this._position=new ki.P,this._drawObject=void 0,this._isVisiable=!0,this._colorIndex=9,this._color=void 0,this._renderType=void 0,this._materialMap=new(U()),this._cacheDrawObject=new(U()),this._animations=[],this._isPickable=!0,this.modelAnimations=void 0,this._name=void 0,this._highlight=!1,this._opacity=1,this._animationing=[],this._ownMaterials=[],this.GroupId=void 0,this.updateFlag=ws.None,this.AutoUpdate=!0,this.registerAfterRenderFun=void 0,this.TempData=void 0,this.diffMaterials=new(U()),this._material=void 0,O()(this,Or,{writable:!0,value:1}),O()(this,Pr,{writable:!0,value:!1}),O()(this,Cr,{writable:!0,value:1}),O()(this,Ar,{writable:!0,value:new xi.HE(1,1,1,1)})}get UniqueName(){return this.constructor.type+this.Id}get Name(){return this._name??this.UniqueName}set Name(t){this._name=t,this.trigger2({type:ys.UpdateName,target:this})}get CanUpdate(){return!!this.ObjectId?.Index&&!this._erase}get RenderType(){return this._renderType??Er.renderType}get IsPickable(){return this._isPickable}set IsPickable(t){var e;this._isPickable=t,this._drawObject&&b()(e=this._drawObject.getChildMeshes()).call(e,(e=>e.isPickable=t))}get Highlight(){return this._highlight}get IsComponent(){return!1}get DrawObject(){if(this._drawObject)return this._drawObject;const t=this.GetDrawObjectFromRenderType(this._renderType??Er.renderType);return this._drawObject=new ji.Y(this.Name??this._id?.Index.toString(),Er.Scene,!1),this.isPart||(t.parent=this._drawObject,this._drawObject.metadata={Entity:this}),this.update(),this._drawObject}get Scene(){return this._drawObject?.getScene?.()}get RenderObject(){return this._drawObject||this.isPart?this.GetDrawObjectFromRenderType(this.RenderType):null}get ColorIndex(){return this._colorIndex}set ColorIndex(t){this._colorIndex!==t&&(this.writeSnapshoot(),this._colorIndex=t,this.update())}get Matrix(){return this._matrix.clone()}set Matrix(t){this.writeSnapshoot(),this._matrix.copyFrom(t),this._matrix.decompose(this._scale,this._rotationQuaternion,this._position),this._rotationQuaternion.toEulerAnglesToRef(this._rotation),this.update()}get MatrixInv(){return this._matrix.invert()}get TransfromFromMtx(){const t=new ki.P,e=new ki._f,i=new ki.P;return this._matrix.decompose(i,e,t),{position:t,rotation:e.toEulerAngles(),scale:i}}get BoundingVectors(){return this._drawObject?this._drawObject.getHierarchyBoundingVectors():{min:new ki.P,max:new ki.P}}get BoundingBox(){if(this.RenderObject){const t=this.RenderObject.getBoundingInfo().boundingBox;return new ra(t.minimum,t.maximum,t.getWorldMatrix())}return new ra}get Opacity(){return this._opacity}set Opacity(t){t!==this._opacity&&(this.writeSnapshoot(),this._opacity=t,this.update(ws.Geometry))}get Color(){return this._color}set Color(t){t!==this._color&&(this.writeSnapshoot(),this._color=t,this.update(ws.Material))}get Position(){return{x:this._position.x,y:this._position.y,z:this._position.z}}set Position(t){this.writeSnapshoot(),nr(this._position,t),this.updateEntityMatrix(),this.update()}get Rotation(){return{x:this._rotation.x,y:this._rotation.y,z:this._rotation.z}}set Rotation(t){this.writeSnapshoot(),nr(this._rotation,t),ki._f.FromEulerAnglesToRef(this._rotation.x,this._rotation.y,this._rotation.z,this._rotationQuaternion),this.updateEntityMatrix(),this.update()}get Scale(){return{x:this._scale.x,y:this._scale.y,z:this._scale.z}}set Scale(t){this.writeSnapshoot(),nr(this._scale,t),this._scale.copyFromFloats(t.x,t.y,t.z),this.updateEntityMatrix(),this.update()}get Visiable(){return this._isVisiable&&!this.IsErase}set Visiable(t){t!==this._isVisiable&&(this.writeSnapshoot(),this._isVisiable=t,this._drawObject?.setEnabled(!this._erase&&this._isVisiable),this.trigger2({type:ys.UpdateVisiable,target:this}))}get AnimationNames(){var t;const e=[];var i;this.modelAnimations&&b()(i=this.modelAnimations).call(i,(t=>e.push(t.name)));return b()(t=this._animations).call(t,(t=>e.push(t.name))),e}get Animations(){const t=[...this._animations];return this.modelAnimations?.length&&t.push(...this.modelAnimations),t}get EnableShadow(){return this._enableShadow}set EnableShadow(t){this._enableShadow!==t&&(this._enableShadow=t,Mr.trigger({type:ys.UpdateShadow,target:this}))}get MaterialMap(){return this._materialMap}get Material(){return this._material?.Object}set Material(t){this.trigger2({type:ys.UpdateMaterial,target:this}),this._material=t instanceof ks?t.ObjectId:t,this.update(ws.Material)}get OwnMaterials(){return[...this._ownMaterials]}get AllMaterils(){if(this.Material)return[this.Material];{const t=new(Q());for(const[e,i]of this._materialMap)t.add(i.Object);if(this.RenderObject){const e=this.RenderObject.getChildMeshes();for(const i of e)if(i.geometry&&i.material&&!this._materialMap.has(i.id)){const e=i.material.metadata?.record;e&&t.add(e)}}return cs()(t)}}get Visibility(){return(0,os.Z)(this,Or)[Or]}set Visibility(t){t!==(0,os.Z)(this,Or)[Or]&&(this.writeSnapshoot(),(0,os.Z)(this,Or)[Or]=t,this.update(ws.Geometry))}get EnableEdge(){return(0,os.Z)(this,Pr)[Pr]}set EnableEdge(t){t!==(0,os.Z)(this,Pr)[Pr]&&(this.writeSnapshoot(),(0,os.Z)(this,Pr)[Pr]=t,this.update(ws.Geometry))}get EdgeWidth(){return(0,os.Z)(this,Cr)[Cr]}set EdgeWidth(t){t!==(0,os.Z)(this,Cr)[Cr]&&(this.writeSnapshoot(),(0,os.Z)(this,Cr)[Cr]=t,this.update(ws.Geometry))}get EdgeColor(){return Ea((0,os.Z)(this,Ar)[Ar].toHexString())}set EdgeColor(t){this.writeSnapshoot();const e=Ca(t);(0,os.Z)(this,Ar)[Ar]=new xi.HE(e.r/255,e.g/255,e.b/255,e.a),this.update(ws.Geometry)}setMaterial(t,e){this.trigger2({type:ys.UpdateMaterial,target:this}),this._materialMap.set(t,e.ObjectId),this.update(ws.Material)}getAllMesh(t=(t=>!!t.geometry)){var e;return g()(e=this.RenderObject.getChildMeshes()).call(e,t)}highlight(t){var e;const i=Er.Scene.getHighlightLayerByName("select-entity");b()(e=this._drawObject.getChildMeshes()).call(e,(e=>t?i.addMesh(e,xi.Wo.FromHexString(t)):i.removeMesh(e)))}translate(t){this.writeSnapshoot(),this.Position=this._position.add(rr(t))}GetDrawObjectFromRenderType(t=Us.Conceptual){if(this._cacheDrawObject.has(t)){const e=this._cacheDrawObject.get(t);return e.setEnabled(!0),e}{const e=this.initDrawObject(t);if(!e)return;return this._cacheDrawObject.set(t,e),e}}lookAt(t){this._drawObject.lookAt(rr(t)),this._drawObject.rotationQuaternion?(this._rotationQuaternion.copyFrom(this._drawObject.rotationQuaternion),this._rotation.copyFrom(this._rotationQuaternion.toEulerAngles())):(this._rotation.copyFrom(this._drawObject.rotation),this._rotationQuaternion.copyFrom(this._rotation.toQuaternion())),this.updateEntityMatrix()}setAlphaIndex(t,e){if(!this._drawObject)return;const i=this._drawObject.getChildMeshes();for(const s of i)e&&!us()(e).call(e,(t=>{var e;return vt()(e=s.name).call(e,t)}))||(s.alphaIndex=t)}setRenderGroupId(t=0){if(!this._drawObject)return;const e=this._drawObject.getChildMeshes();for(const i of e)i.renderingGroupId=t}removeAnimation(t){var e;const i=F()(e=this._animations).call(e,(e=>e.name===t));i&&(i.clear(),ea(this._animations,i))}startAnimates(t,e){const{loop:i=!0,speedRatio:s=1,onComplete:a=(()=>{})}=e??{};for(const e of this.Animations)t===e.name&&(e instanceof Xi.O&&e.onAnimationEndObservable.addOnce(a),e.start(i,s))}stopAnimates(t){for(const e of this.Animations)t&&!vt()(t).call(t,e.name)||e.stop()}clearAnimatable(){this.RenderObject.animations.length=0;for(const t of this._animations)t.pause(),t.stop(),t.reset();this._animations.length=0,this.stopAnimates()}appendAnimation(t){this.writeSnapshoot(),this._animations.push(t),this.trigger2({type:ys.AddAnimation,target:this})}mirrorMaterial(t,e){const i=t.material;if(!i)return;const s=t.getWorldMatrix(),a=t.getVerticesData("normal");let r=new ki.P(a[0],a[1],a[2]),n=ki.P.TransformNormal(r,s);const o=Si.J.FromPositionAndNormal(t.position,n.scale(-1)),h=new vi.h("mirror"+this.Id,1024,Er.Scene,!0);i.reflectionTexture=h,h.mirrorPlane=o,h.renderList=e,h.level=1}moveAnimate(t){const e=new mr(this,t);return this.appendAnimation(e),e}followAnimate(t){var e;let i=[];b()(e=t.path).call(e,(t=>{i.push(new ki.P(t.x,t.y,t.z))}));let s=new Jt.$B(i).getNormals(),a=Math.acos(ki.P.Dot(oe.RD.X,s[0]));this._drawObject.rotate(oe.RD.Y,a,oe.T.WORLD),this.Scene.registerAfterRender(this.updateRotateAndPosition(i,s,t))}totalDistance(t){let e=0;for(let i=0;i<t.length-1;i++)e+=ki.P.Distance(t[i],t[i+1]);return e}updateRotateAndPosition(t,e,i){let s,a,r,n,o=0,h=new Date,l=i?.time;return this.registerAfterRenderFun=()=>{if(o===t.length-1){if(!i?.loop)return i?.complete?.(),void this.Scene.unregisterAfterRender(this.registerAfterRenderFun);{o=0,h=new Date;let t=Math.acos(ki.P.Dot(oe.RD.X,e[0]));this._drawObject.rotate(oe.RD.Y,t,oe.T.WORLD)}}if(s=new Date,a=(s-h)/1e3,r=this.totalDistance(t),n=this.totalDistance(Z()(t).call(t,0,o+1))/r,a<n*l)return;let c=Math.acos(ki.P.Dot(e[o],e[o+1])),d=ki.P.Cross(e[o],e[o+1]).y;d=0===d?d:d/Math.abs(d),this._drawObject.position.x=t[o].x,this._drawObject.position.z=t[o].z,this._drawObject.rotate(oe.RD.Y,d*c,oe.T.WORLD),o+=1},this.registerAfterRenderFun}rotateAnimate(t){const e=new Sr(this,t);return this.appendAnimation(e),e}scaleAnimate(t){const{scale:e,time:i=1,frame:s=30,loop:a=!1,loopCount:r,complete:n}=t,o=ki.P.FromArray([e.x??this._scale.x,e.y??this._scale.y,e.z??this._scale.z]),h=this.RenderObject,l=h.getScene(),c=new Gi.f("rotate-animate","scaling",30,Gi.f.ANIMATIONTYPE_VECTOR3);c.setKeys([{frame:0,value:this._scale.clone()},{frame:i*s,value:o}]),h.animations.push(c);const d=l.beginAnimation(h,0,i*s,a);d.onAnimationEndObservable.addOnce((()=>{n?.()}));let u=this.setLoopCount(r,d);return{clear:()=>{d.stop(),u?.(),ea(h.animations,c)},restart:()=>d.restart(),stop:()=>d.stop(),pause:()=>d.pause(),reset:()=>d.reset()}}moveByPath(t){const e=new fr(this,t);return this.appendAnimation(e),e}moveTo(t,e=!0,i){return new(N())((s=>{if(i){const{time:a=1,startTime:r=0}=i,n=this._drawObject.position.clone(),o=[{frame:30*r,value:n},{frame:30*(a+r),value:e?n.clone().add(rr(t)):rr(t)}];if(or(o[0].value,o[1].value))return void s(null);const h=new Gi.f("move-animate","position",30,Gi.f.ANIMATIONTYPE_VECTOR3);h.setKeys(o),this._animationing.push(h),this._drawObject.animations.push(h);this._drawObject.getScene().beginDirectAnimation(this._drawObject,this._animationing,30*r,30*(a+r),!1).onAnimationEndObservable.addOnce((()=>{ea(this._drawObject.animations,h),ea(this._animationing,h),this._position=o[1].value,s(null)}))}else e?this.applyMatrix(ki.y3.Translation(t.x??0,t.y??0,t.z??0)):this.Position=t,s(null)}))}rotateTo(t){return new(N())((e=>{const{time:i=1,dir:s={x:0,y:1,z:0},angle:a,animation:r,isOffset:n,pivot:o,startTime:h=0}=t,l=ki.P.FromArray(ms()(s)).normalize();if(r){const t=(this._drawObject.rotationQuaternion||ki._f.FromEulerVector(this._drawObject.rotation)).clone(),s=[{frame:30*h,value:t.clone()}];if(!n){if(this._drawObject.metadata?.rotation&&this._drawObject.metadata.rotation===a)return void e(!0);this._drawObject.metadata.rotation=a}if(a>2*Math.PI-.001){const e=Math.PI/4,r=Math.round(a/e),o=i/r;for(let i=1;i<=r;i++){const a=ki._f.RotationAxis(l,i*e);s.push({frame:30*(h+o*i),value:n?t.multiply(a):a})}}else{const e=ki._f.RotationAxis(l,a);s.push({frame:30*(h+i),value:n?t.multiply(e):e})}if(2===s.length&&or(s[0].value,s[1].value))return void e(null);o&&this._drawObject.setPivotPoint(rr(o));const r=new Gi.f("rotate-animation","rotationQuaternion",30,Gi.f.ANIMATIONTYPE_QUATERNION);this._animationing.push(r),r.setKeys(s),this._drawObject.animations.push(r);this._drawObject.getScene().beginDirectAnimation(this._drawObject,this._animationing,30*h,30*(h+i),!1).onAnimationEndObservable.addOnce((()=>{ea(this._drawObject.animations,r),ea(this._animationing,r),this._rotation=at(s).value.toEulerAngles(),e(null)}))}else{const t=ki._f.RotationAxis(l,a).toEulerAngles();n?this.applyMatrix(ki.y3.RotationAxis(l,a)):this.Rotation=t,e(null)}}))}scaleTo(t){const{scale:e,time:i,animation:s,isOffset:a,pivot:r,startTime:n}=t;return new(N())((t=>{if(s){const s=this._drawObject;if(!s)return void t(null);const o=s.getScene(),h=30,l=[{frame:30*n,value:this._scale.clone()},{frame:(i+n)*h,value:rr(a?this._scale.multiplyByFloats(e.x,e.y,e.z):e)}];if(or(l[0].value,l[1].value))return void t(null);const c=new Gi.f("scale-animate","scaling",30,Gi.f.ANIMATIONTYPE_VECTOR3);this._animationing.push(c),c.setKeys(l),s.animations.push(c),r&&s.setPivotPoint(rr(r));o.beginDirectAnimation(s,this._animationing,n*h,h*(i+n),!1).onAnimationEndObservable.addOnce((()=>{ea(this._drawObject.animations,c),ea(this._animationing,c),this._scale=l[1].value,t(null)}))}else this.Scale=e,t(null)}))}opacityTo(t){return new(N())((e=>{const{opacity:i,time:s,startTime:a}=t,r=[{frame:30*a,value:this._opacity},{frame:30*(a+s),value:i}];if(r[0].value===r[1].value)return void e(!1);const n=new Gi.f("opacity"+this.UniqueName,"Opacity",30,Gi.f.ANIMATIONTYPE_FLOAT);this._animationing.push(n),n.setKeys(r);this.Scene.beginDirectAnimation(this,this._animationing,30*a,30*(s+a)).onAnimationEndObservable.add((()=>{this._opacity=r[1].value,e(!0)}))}))}updateRenderType(t){if(this._renderType!==t||this._drawObject&&0===this._drawObject.getChildMeshes().length){var e;b()(e=this._drawObject.getChildren()).call(e,(t=>{t.setEnabled(!1)})),this._renderType=t;const i=this.GetDrawObjectFromRenderType(t);i&&(i.parent||(i.parent=this._drawObject))}}updateEntityMatrix(){ki.y3.ComposeToRef(this._scale,this._rotationQuaternion,this._position,this._matrix),this.trigger2({type:ys.UpdateMatrix,target:this})}updateMatrix(){this._drawObject&&(this._drawObject.position.copyFrom(this._position),this._drawObject.rotation.copyFrom(this._rotation),this._drawObject.scaling.copyFrom(this._scale))}updatePart(){if(this.isPart){const t=this.GetDrawObjectFromRenderType(this.RenderType);t.position.copyFrom(this._position),t.rotation.copyFrom(this._rotation),t.scaling.copyFrom(this._scale)}}update(t=ws.All){var e;if(this.updateFlag|=t,this.AutoUpdate)if(this.isPart)this.updatePart();else if(this.CanUpdate&&this._drawObject){var i;if(this.updateFlag&ws.Matrix&&(this._drawObject.position.copyFrom(this._position),this._drawObject.rotation.copyFrom(this._rotation),this._drawObject.scaling.copyFrom(this._scale),this._drawObject.setEnabled(this._isVisiable)),this.updateFlag&ws.Geometry)if(b()(i=this._drawObject.getChildMeshes()).call(i,(t=>t.isPickable=this._isPickable)),this.updateDrawObject(this._renderType??Er.renderType,this.RenderObject),this.RenderObject){var s;const t=_s()(s=this.RenderObject.getChildMeshes()).call(s,this.RenderObject);for(const e of t)e.geometry&&(e.visibility=(0,os.Z)(this,Or)[Or],(0,os.Z)(this,Pr)[Pr]?(e.enableEdgesRendering(),e.edgesWidth=(0,os.Z)(this,Cr)[Cr],e.edgesColor=(0,os.Z)(this,Ar)[Ar]):e.disableEdgesRendering())}this.updateFlag&ws.Material&&(this.updateMaterial(),this._drawObject.setEnabled(this._isVisiable&&!this._erase)),b()(e=this._drawObject.getChildMeshes()).call(e,(t=>t.isPickable=this._isPickable)),this.trigger2({type:ys.Update,target:this}),this.updateFlag=ws.None}}applyMatrix(t){this._matrix.multiplyToRef(t,this._matrix);const e=new ki._f;this._matrix.decompose(this._scale,e,this._scale),e.toEulerAnglesToRef(this._rotation),this.update()}initDrawObject(t){return null}updateDrawObject(t,e){}updateMaterial(){}erase(t=!0){t!==this._erase&&(super.erase(t),this._drawObject&&this._drawObject.setEnabled(!t),this.trigger2({type:ys.Remove,target:this}))}replace(t){this.erase(),t.ObjectId=this.ObjectId,t.ObjectId.Object=t,t._SetDefaultDb(this._db),t._position=this._position,t._rotation=this._rotation,t._scale=this._scale,t._listeners=this._listeners,"isRead"in t&&(t.isRead=!0)}destory(t=!1){super.destory(),this.registerAfterRenderFun&&(this.Scene.unregisterAfterRender(this.registerAfterRenderFun),this.registerAfterRenderFun=null);for(const[e,i]of this._cacheDrawObject)i.dispose(!1,t);this._cacheDrawObject.clear(),this._drawObject&&this._drawObject.dispose(!1,t),this._drawObject=null}registerAction(t,e){const i=Bs[t];let s=this.RenderObject;if(s instanceof Ki.Kj){if(!s.geometry){var a;let t=F()(a=s.getChildren()).call(a,(t=>"actionHelper"===t.name));if(!t){let e=s.getHierarchyBoundingVectors();e.min.divideToRef(this._scale,e.min),e.max.divideToRef(this._scale,e.max);const i=e.max.y-e.min.y;t=Yi.V.CreateBox("actionHelper",{width:e.max.x-e.min.x,height:i,depth:e.max.z-e.min.z},Er.Scene),t.visibility=0,t.parent=s,t.position.y=i/2}s=t}s.actionManager||(s.actionManager=new wi.k(this.Scene));const t=s.actionManager.registerAction(new yi.fQ({trigger:i,parameter:"r"},e));return()=>{s.actionManager.unregisterAction(t)}}}move2Zero(t){const e=this.RenderObject;t||(t=e.getHierarchyBoundingVectors().min);const i=this._position.clone().subtract(t);this.Position=i}renderEdge(t=10,e="#ffffff"){if(this._drawObject){const i=this._drawObject.getChildMeshes();for(const s of i)s.geometry&&(s.enableEdgesRendering(),s.edgesWidth=t,s.edgesColor=xi.HE.FromHexString(e))}}cloneMaterial(){if(this._drawObject){const t=this._drawObject.getChildMeshes();for(const e of t)e.material&&(e.material=e.material.clone(e.material.name+z()()))}}emissive(t){if(this._drawObject){const e=t?xi.Wo.FromHexString(t):xi.Wo.Black(),i=this._drawObject.getChildMeshes();for(const t of i)t.material&&(t.material instanceof fi.Y||t.material instanceof Oi.K)&&(er(t.material,"emissiveColor")||tr(t.material,"emissiveColor",t.material.emissiveColor),t.material.emissiveColor=e)}}resetEmissive(){if(this._drawObject){const t=this._drawObject.getChildMeshes();for(const e of t)if(e.material&&(e.material instanceof fi.Y||e.material instanceof Oi.K)){const t=er(e.material,"emissiveColor");t&&(e.material.emissiveColor=t)}}}disabledRenderEdge(){if(this._drawObject){const t=this._drawObject.getChildMeshes();for(const e of t)e.geometry&&e.disableEdgesRendering()}}getDragPoints(){return[]}moveDragPoint(t,e){}getReady(){return N().resolve()}writeFile(t){super.writeFile(t),t.write(4),t.write(this._name),t.write(this._colorIndex),t.writeArray(this._position.asArray()),t.writeArray(this._rotation.asArray()),t.writeArray(this._scale.asArray()),t.write(this._isPickable),t.write(this._isVisiable),t.write(this._color),t.writeObjectId(this.GroupId),t.write(this._materialMap.size);for(const[e,i]of this._materialMap)t.write(e),t.writeObjectId(i);t.write(this.diffMaterials.size);for(const[e,i]of this.diffMaterials)t.write(e),t.write(j()(i));t.writeObjectId(this._material),t.writeAnyArray(this._animations,t.writeObject),t.write((0,os.Z)(this,Or)[Or]),t.write((0,os.Z)(this,Pr)[Pr]),t.write((0,os.Z)(this,Ar)[Ar].toHexString()),t.write((0,os.Z)(this,Cr)[Cr])}readFile(t){super.readFile(t);const e=t.read();this._name=t.read(),this._colorIndex=t.read();let i=t.read(),s=t.readArray(i);if(this._position.fromArray(s),i=t.read(),s=t.readArray(i),this._rotation.fromArray(s),ki._f.FromEulerVectorToRef(this._rotation,this._rotationQuaternion),i=t.read(),s=t.readArray(i),this._scale.fromArray(s),this._isPickable=t.read(),this._isVisiable=t.read(),this._color=t.read(),e>1&&(this.GroupId=t.readObjectId()),e>2){this._materialMap.clear();let e=t.read();for(let i=0;i<e;i++){const e=t.read(),i=t.readObjectId();this._materialMap.set(e,i)}e=t.read(),this.diffMaterials.clear();for(let i=0;i<e;i++){const e=t.read(),i=JSON.parse(t.read());this.diffMaterials.set(e,i)}this._material=t.readObjectId()}if(e>3){t.readAnyArrayAndPush(this._animations,t.readObject),(0,os.Z)(this,Or)[Or]=t.read(),(0,os.Z)(this,Pr)[Pr]=t.read();let e=t.read();(0,os.Z)(this,Ar)[Ar].copyFrom(xi.HE.FromHexString(e)),(0,os.Z)(this,Cr)[Cr]=t.read()}this.updateEntityMatrix()}_applyHistoryRecord(t){super._applyHistoryRecord(t),t instanceof ut?this._drawObject.setEnabled(!this._erase):t instanceof xt&&this.readFile(t.Filer)}on(t,e,i){return t===js[Di.kD.POINTERMOVE]&&this.RenderObject&&(this.RenderObject.enablePointerMoveEvents=!0),super.on(t,e,i)}trigger2(t){super.trigger(t),Mr.trigger(t)}setLoopCount(t,e){let i;if(t){let s=0;i=e.onAnimationLoopObservable.add((e=>{s++,s===t&&e.stop()}))}return()=>{i&&e.onAnimationEndObservable.remove(i)}}}Er.type=void 0,Er.renderType=Us.Conceptual,Er.Scene=void 0;class zr{static get MainViewer(){return this._MainViewer}static set MainViewer(t){this._MainViewer=t,this._MainScene=t.Scene}static get MainScene(){return this._MainScene}static get Scene(){return this._Scene}static set Scene(t){this._Scene=t,Er.Scene=t}static StartWait(){this.waiting=!0}static Wait(){if(!this.waiting)return()=>{};let t;const e=new(N())((e=>{t=e}));return this.waitList.push(e),t}static async WaitComplete(){return N().all(this.waitList).then((t=>(this.waiting=!1,this.waitList.length=0,t)))}static getLastPromise(){return ta(this.waitList)}static ToggleScene(t,e){const i=this.Scene;this.Scene=t,e(),this.Scene=i}}function Dr(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}zr._MainViewer=void 0,zr._MainScene=void 0,zr._Scene=void 0,zr.waitList=[],zr.waiting=!1,zr.Application=void 0,zr.PreviewMode=!1,zr.Reading=!1,zr.GlobalVariables=[];class Tr extends pt{constructor(...t){super(...t),this._drawObject=void 0,this._width=void 0,this._height=void 0,this._start=void 0,this._position={x:"0",y:"0"},this._rotation=0,this._scale={x:1,y:1},this.isSelect=!1,this._name=void 0,this._isVisiable=!0,this._horAlign=0,this._verAlign=0,this._isPickable=!0,this._hasTransition=!1,this.GroupId=void 0}get Name(){return this._name??"\u56fe\u6807"+this.Id}set Name(t){this._name=t,Mr.trigger({type:"updateName",target:this})}get DrawObject(){return this._drawObject||(this._drawObject=this.initDrawObject(),this._drawObject.metadata={entity:this},this._drawObject.style.display=this._isVisiable&&!this._erase?"block":"none"),this._drawObject}get Visiable(){return this._isVisiable}set Visiable(t){t!==this._isVisiable&&(this.writeSnapshoot(),this._isVisiable=t,this.update())}get IsPickable(){return this._isPickable}set IsPickable(t){this._isPickable=t,this.update()}get Position(){return function(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=Dr(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=Dr(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}({},this._position)}set Position(t){Es(this._position,t)||(this.writeSnapshoot(),this._position.x=t.x,this._position.y=t.y,this.update())}get Rotation(){return this._rotation}set Rotation(t){t!==this._rotation&&(this.writeSnapshoot(),this._rotation=t,this.update())}get Scale(){return this._scale}set Scale(t){Es(this._scale,t)||(this.writeSnapshoot(),this._scale=t,this.update())}get IsSelect(){return this.isSelect}set IsSelect(t){t!==this.isSelect&&(this.isSelect=t,this._drawObject&&(this._drawObject.style.outline=t?"2px solid #cccccc":"none"))}get Draging(){return!!this._start}get Width(){return this._width}set Width(t){t!==this._width&&(this.writeSnapshoot(),this._width=t,this.update())}get Height(){return this._height}set Height(t){t!==this._height&&(this.writeSnapshoot(),this._height=t,this.update())}get HorAlign(){return this._horAlign}set HorAlign(t){t!==this._horAlign&&(this.writeSnapshoot(),this._horAlign=t,this.update())}get VerAlign(){return this._verAlign}set VerAlign(t){t!==this._verAlign&&(this.writeSnapshoot(),this._verAlign=t,this.update())}get HasTransition(){return this._hasTransition}set HasTransition(t){t!==this._hasTransition&&(this.writeSnapshoot(),this._hasTransition=t,this.update())}start(t,e){this._db&&this._db.HistoryManager.startCmd("\u62d6\u62fdDOM"),this.writeSnapshoot(),this._start=new ki.FM(t,e)}end(){this._start=null,this._db&&this._db.HistoryManager.endCmd()}move(t,e,i=this._drawObject){if(!i)return;let s=t-this._start.x,a=e-this._start.y;const r=this.convertValue(this._position.x,zr.MainViewer.Width),n=this.convertValue(this._position.y,zr.MainViewer.Height);let o=2===this._horAlign?r-s:r+s,h=(this._verAlign,n+a);this.Position={x:o/zr.MainViewer.Width*100+"%",y:h/zr.MainViewer.Height*100+"%"},this._start.set(t,e)}initDrawObject(){return null}updateDrawObject(t){t.style.width=this.convertValue(this._width,zr.MainViewer.Width)+"px",t.style.height=this.convertValue(this._height,zr.MainViewer.Height)+"px",this.setPosition(t),t.style.zIndex="2",t.style.overflow="hidden",t.style.transform=`rotate(${this._rotation}deg) scale(${this._scale.x},${this._scale.y})`,t.style.transition=this._hasTransition?"all .1s":"",t.style.display=this._isVisiable?"block":"none",t.style.pointerEvents=this._isPickable?"auto":"none",this.isSelect?this._drawObject.style.outline="2px solid #cccccc":this._drawObject.style.outline="none"}update(){this._drawObject&&(this.updateDrawObject(this._drawObject),this.trigger({type:"update",target:this}),Mr.trigger({type:"update",target:this}))}erase(t=!0){t!==this._erase&&(super.erase(t),this._drawObject.style.display=t?"none":"block",Mr.trigger({type:"remove",target:this}),this.trigger({type:"remove",target:this}))}destory(){super.destory(),this._drawObject&&this._drawObject.remove(),this._drawObject=null}writeFile(t){super.writeFile(t),t.write(6),t.write(this._position.x),t.write(this._position.y),t.write(this._rotation),t.write(this._scale.x),t.write(this._scale.y),t.write(this._width),t.write(this._height),t.write(this._isVisiable),t.write(this._name),t.write(this._horAlign),t.write(this._verAlign),t.write(this._isPickable),t.write(this._hasTransition),t.writeObjectId(this.GroupId)}readFile(t){super.readFile(t);const e=t.read();this._position.x=t.read(),this._position.y=t.read(),this._rotation=t.read(),this._scale.x=t.read(),this._scale.y=t.read(),this._width=t.read(),this._height=t.read(),this._isVisiable=t.read(),e>1&&(this._name=t.read()),e>2&&(this._horAlign=t.read(),this._verAlign=t.read()),e>3&&(this._isPickable=t.read()),e>4&&(this._hasTransition=t.read()),e>5&&(this.GroupId=t.readObjectId())}_applyHistoryRecord(t){super._applyHistoryRecord(t),t instanceof ut?this._drawObject.style.display=this._erase?"none":"block":t instanceof xt&&this.readFile(t.Filer)}convertValue(t,e){return"string"==typeof t?as()(t).call(t,"%")?ns()(t)/100*e:ns()(t):t}setPosition(t){const e=this.convertValue(this._position.x,zr.MainViewer.Width),i=this.convertValue(this._position.y,zr.MainViewer.Height),s=this.convertValue(this._width,zr.MainViewer.Width),a=this.convertValue(this._height,zr.MainViewer.Height);0===this._horAlign?(t.style.left=e+"px",t.style.right="auto"):2===this._horAlign?(t.style.right=e+"px",t.style.left="auto"):(t.style.left=zr.MainViewer.Width/2-s/2+"px",t.style.right="auto"),0===this._verAlign?(t.style.top=i+"px",t.style.bottom="auto"):2===this._verAlign?(t.style.bottom=i+"px",t.style.top="auto"):(t.style.top=zr.MainViewer.Height/2-a/2+"px",t.style.bottom="auto")}}class Rr{constructor(t){this.viewer=t,t.Scene.onPointerObservable.add((t=>{const e={x:t.event.offsetX,y:t.event.offsetY};if(t.type===Di.kD.POINTERDOWN)if(0===t.event.button){const t=this.getGui(e);t&&t.click(e)}}))}getGui(t){const e=this.viewer.GuiContainer.getChildren()[0]?.children;for(const i of e)if(i.metadata?.entity&&i.isVisible&&i.isEnabled&&i.contains(t.x,t.y))return i.metadata.entity;return null}}const Ir=new class{constructor(){this.assestPromiseCache=new(U())}getAssetPromise(t){return this.assestPromiseCache.get(t)}setAssetPromise(t,e){this.assestPromiseCache.set(t,e)}clear(){this.assestPromiseCache.clear()}};var Lr=i(35004),Fr=i.n(Lr),kr=i(11143),jr=i.n(kr);class Br extends Bt{constructor(){super(),this._isLoading=!1,this.wrapU=Fi.x.WRAP_ADDRESSMODE,this.wrapV=Fi.x.WRAP_ADDRESSMODE,this.scale=[1,1],this.rotation=[0,0,0],this.offset=[0,0],this.texture=void 0}get Texture(){return this.texture}async getTexture(){return this.texture}get Scale(){return this.scale}set Scale(t){t[0]===this.scale[0]&&t[1]===this.scale[1]||(this.writeSnapshoot(),this.scale=t,this.update())}get Offset(){return this.offset}set Offset(t){t[0]===this.offset[0]&&t[1]===this.offset[1]||(this.writeSnapshoot(),this.offset=t,this.update())}get Rotation(){return this.rotation}set Rotation(t){t[0]===this.rotation[0]&&t[1]===this.rotation[1]&&t[2]===this.rotation[2]||(this.writeSnapshoot(),this.rotation=t,this.update())}update(){this.texture&&(this.texture.name=this._name,this.texture.wrapU=this.wrapU,this.texture.wrapV=this.wrapV)}writeFile(t){super.writeFile(t),t.write(1),t.write(this.wrapU),t.write(this.wrapV),t.write(this.scale[0]),t.write(this.scale[1]),t.write(this.rotation[0]),t.write(this.rotation[1]),t.write(this.rotation[2]),t.write(this.offset[0]),t.write(this.offset[1])}readFile(t){super.readFile(t);t.read();this.wrapU=t.read(),this.wrapV=t.read(),this.scale[0]=t.read(),this.scale[1]=t.read(),this.rotation[0]=t.read(),this.rotation[1]=t.read(),this.rotation[2]=t.read(),this.offset[0]=t.read(),this.offset[1]=t.read()}}function Nr(t){t.blockMaterialDirtyMechanism=!1,I()((()=>{t.blockMaterialDirtyMechanism=!0}),0)}const Gr=/[0-9a-f]{8}(-[0-9a-f]{4}){3}-[0-9a-f]{12}/;var Hr,Vr;let Zr,Wr,Ur=Y(((Vr=class extends Br{constructor(t="",e){super(),this.url=t,this.texture=void 0,this.triggerLoading=()=>{this.trigger({type:"loading",title:"\u52a0\u8f7d\u8d34\u56fe",target:this}),Mr.trigger({type:"loading",title:"\u52a0\u8f7d\u8d34\u56fe",target:this})},this.onLoad=t=>{this._isLoading=!1,this.trigger({type:"load",target:this,object:t??this.texture}),Mr.trigger({type:"load",target:this,object:t??this.texture})},e?(this.texture=e,this.readFromTexture()):(this.texture=new Fi.x(this.Url2,zr.Scene),this.texture.isBlocking=!1,this.texture.onLoadObservable.add(this.onLoad),this.texture.name="TextureRecord",this.triggerLoading())}get Texture(){return this.texture}get Url(){return this.url}set Url(t){t!==this.url&&(this.writeSnapshoot(),this.url=t,this.triggerLoading(),this.update())}get Url2(){var t;return this.url?H()(t=this.url).call(t,"http")?this.url:Gr.test(this.url)?Ji.assetURL+this.url:Ji.Texture_URL+this.url:""}update(){Nr(this.texture.getScene()),this.texture.url!==this.Url2&&(this._isLoading=!0,this.texture.updateURL(this.Url2,null,this.onLoad)),this.texture.name=this._name,this.texture.wrapU=this.wrapU,this.texture.wrapV=this.wrapV,this.texture.uScale=this.scale[0],this.texture.vScale=this.scale[1],this.texture.uOffset=this.offset[0],this.texture.vOffset=this.offset[1],this.texture.uAng=sa(this.rotation[0]),this.texture.vAng=sa(this.rotation[1]),this.texture.wAng=sa(this.rotation[2])}async waitUpdate(){return new(N())((t=>{if(!this._isLoading)return t(!0),!0;this.once("load",(()=>{t(!0)}))}))}writeFile(t){super.writeFile(t),t.write(1),t.write(this.url)}readFile(t){super.readFile(t);t.read();this.url=t.read(),this.update()}readFromTexture(){this.wrapU=this.texture.wrapU,this.wrapV=this.texture.wrapV,this.scale[0]=this.texture.uScale,this.scale[1]=this.texture.vScale,this.offset[0]=this.texture.uOffset,this.offset[1]=this.texture.vOffset,this.rotation[0]=aa(this.texture.uAng),this.rotation[1]=aa(this.texture.vAng),this.rotation[2]=aa(this.texture.wAng)}}).type="TextureRecord",Hr=Vr))||Hr;!function(t){t[t.OPAQUE=bi.F.MATERIAL_OPAQUE]="OPAQUE",t[t.ALPHATEST=bi.F.MATERIAL_ALPHATEST]="ALPHATEST",t[t.ALPHABLEND=bi.F.MATERIAL_ALPHABLEND]="ALPHABLEND",t[t.ALPHATESTANDBLEND=bi.F.MATERIAL_ALPHATESTANDBLEND]="ALPHATESTANDBLEND"}(Zr||(Zr={})),function(t){t[t.ALPHA_DISABLE=Ui.D.ALPHA_DISABLE]="ALPHA_DISABLE",t[t.ALPHA_ADD=Ui.D.ALPHA_ADD]="ALPHA_ADD",t[t.ALPHA_COMBINE=Ui.D.ALPHA_COMBINE]="ALPHA_COMBINE",t[t.ALPHA_SUBTRACT=Ui.D.ALPHA_SUBTRACT]="ALPHA_SUBTRACT",t[t.ALPHA_MULTIPLY=Ui.D.ALPHA_MULTIPLY]="ALPHA_MULTIPLY",t[t.ALPHA_MAXIMIZED=Ui.D.ALPHA_MAXIMIZED]="ALPHA_MAXIMIZED",t[t.ALPHA_ONEONE=Ui.D.ALPHA_ONEONE]="ALPHA_ONEONE",t[t.ALPHA_PREMULTIPLIED=Ui.D.ALPHA_PREMULTIPLIED]="ALPHA_PREMULTIPLIED",t[t.ALPHA_PREMULTIPLIED_PORTERDUFF=Ui.D.ALPHA_PREMULTIPLIED_PORTERDUFF]="ALPHA_PREMULTIPLIED_PORTERDUFF",t[t.ALPHA_INTERPOLATE=Ui.D.ALPHA_INTERPOLATE]="ALPHA_INTERPOLATE",t[t.ALPHA_SCREENMODE=Ui.D.ALPHA_SCREENMODE]="ALPHA_SCREENMODE"}(Wr||(Wr={}));const Kr=t=>t instanceof Ur?t.ObjectId:t,Yr=t=>null;var qr,Xr,$r,Qr,Jr,tn,en,sn,an,rn,nn,on,hn,ln,cn,dn,un,pn,mn,gn,_n,wn,yn,bn,fn,vn,xn,Sn,Mn,On;let Pn=(qr=Is((t=>t.toHexString())),Xr=Is((t=>t.toHexString())),$r=Is((t=>t.toHexString())),Qr=Is((t=>t.toHexString())),Jr=Is(Yr,Kr),tn=Is(Yr,Kr),en=Is(Yr,Kr),sn=Is(Yr,Kr),an=Is(Yr,Kr),rn=Is((t=>null)),Y((On=class extends ks{constructor(t,e){super(t,e),(0,vs.Z)(this,"AlbedoColor",hn,this),(0,vs.Z)(this,"ReflectivityColor",ln,this),(0,vs.Z)(this,"EmissiveColor",cn,this),(0,vs.Z)(this,"AmbientColor",dn,this),(0,vs.Z)(this,"Metallic",un,this),(0,vs.Z)(this,"Roughness",pn,this),(0,vs.Z)(this,"Alpha",mn,this),(0,vs.Z)(this,"MicroSurface",gn,this),(0,vs.Z)(this,"UseAlphaFromAlbedoTexture",_n,this),(0,vs.Z)(this,"TransparencyMode",wn,this),(0,vs.Z)(this,"AlphaMode",yn,this),(0,vs.Z)(this,"AlbedoTexture",bn,this),(0,vs.Z)(this,"MetallicTexture",fn,this),(0,vs.Z)(this,"BumpTexture",vn,this),(0,vs.Z)(this,"EmissiveTexture",xn,this),(0,vs.Z)(this,"LightmapTexture",Sn,this),(0,vs.Z)(this,"ReflectionTexture",Mn,this),this._name||(this._name="\u7269\u7406\u6750\u8d28"),t?this.importOwnTextures():(this.material=new fi.Y(this._name,zr.Scene),this.updateMaterial()),this.init=!1,this.material.metadata||(this.material.metadata={}),this.material.metadata.record=this}get AllTextures(){const t=[];for(const e of this.AllTextureKeys)if(this[e]){const i=this[e];i?.Object&&t.push(i.Object)}return t}copyFrom(t){let e=this._id,i=this._Owner;const s=this.AllTextureKeys;let a=wa()(s).call(s,(t=>this[t]));this.writeSnapshoot();let r=new X;t.writeFile(r),this.readFile(r),this._id=e,this._Owner=i;const n=new(U());for(let e=0;e<a.length;e++){const i=s[e],r=a[e];if(r)t[i]?(t[i].Object&&r.Object.copyFrom(t[i].Object),this[i]=r):this[i]=null;else if(t[i]?.Object)if(t._db===this._db)this[i]=t[i];else{let e;if(n.has(t[i]))e=n.get(t[i]);else{const s=t[i].Object.clone();this.DB.getObjectId(s.Owner.Index).Object.append(s),n.set(t[i],s.ObjectId),e=s.ObjectId}this[i]=e}}return this.update(),this}updateMaterial(){super.updateMaterial(),this.material.name=this._name,this.material.albedoColor=ba(this.AlbedoColor),this.material.reflectivityColor=ba(this.ReflectivityColor),this.material.emissiveColor=ba(this.EmissiveColor),this.material.ambientColor=ba(this.AmbientColor),this.material.alpha=this.Alpha,this.material.metallic=this.Metallic,this.material.roughness=this.Roughness,this.material.microSurface=this.MicroSurface,this.material.transparencyMode=this.TransparencyMode,this.material.alphaMode=this.AlphaMode,this.material.useAlphaFromAlbedoTexture=this.UseAlphaFromAlbedoTexture}updateTextures(){if(!this.isOwn){{const t=this.AlbedoTexture?.Object;this.material.albedoTexture=t?.Texture}{const t=this.BumpTexture?.Object;this.material.bumpTexture=t?.Texture}{const t=this.MetallicTexture?.Object;this.material.metallicTexture=t?.Texture}{const t=this.EmissiveTexture?.Object;this.material.emissiveTexture=t?.Texture}{const t=this.LightmapTexture?.Object;this.material.lightmapTexture=t?.Texture}{const t=this.ReflectionTexture?.Object;this.material.reflectionTexture=t?.Texture}}}update(){this.material&&(this.material.getScene().blockMaterialDirtyMechanism=!1,super.update(),this.updateTextures(),this.material.getScene().blockMaterialDirtyMechanism=!0)}async waitRender(){const t=[];for(const e of this.AllTextureKeys)if(this[e]){const i=this[e];t.push(i.Object.waitUpdate())}return await N().all(t),new(N())((t=>{this.material.onBind=e=>{this.material.onBind=null,t(!0)},this.material.onError=e=>{this.material.onError=null,t(!1)}}))}writeFile(t){super.writeFile(t),t.write(1),t.write(this.AlbedoColor),t.write(this.ReflectivityColor),t.write(this.EmissiveColor),t.write(this.AmbientColor),t.write(this.Alpha),t.write(this.UseAlphaFromAlbedoTexture),t.write(this.TransparencyMode),t.write(this.AlphaMode),t.write(this.Metallic),t.write(this.Roughness),t.write(this.MicroSurface),t.writeHardObjectId(this.AlbedoTexture),t.writeHardObjectId(this.BumpTexture),t.writeHardObjectId(this.MetallicTexture),t.writeHardObjectId(this.EmissiveTexture),t.writeHardObjectId(this.LightmapTexture),t.writeHardObjectId(this.ReflectionTexture)}readFile(t){super.readFile(t);t.read();this.AlbedoColor=t.read(),this.ReflectivityColor=t.read(),this.EmissiveColor=t.read(),this.AmbientColor=t.read(),this.Alpha=t.read(),this.UseAlphaFromAlbedoTexture=t.read(),this.TransparencyMode=t.read(),this.AlphaMode=t.read(),this.Metallic=t.read(),this.Roughness=t.read(),this.MicroSurface=t.read(),this.AlbedoTexture=t.readObjectId(),this.BumpTexture=t.readObjectId(),this.MetallicTexture=t.readObjectId(),this.EmissiveTexture=t.readObjectId(),this.LightmapTexture=t.readObjectId(),this.ReflectionTexture=t.readObjectId(),this.update()}_SetOwnerDatabase(t){return super._SetOwnerDatabase(t),this.material.name=`pbr-${this.Id}`,this.material.id=`pbr-${this.Id}`,this}get AllTextureKeys(){return["AlbedoTexture","BumpTexture","MetallicTexture","EmissiveTexture","LightmapTexture","ReflectionTexture"]}importOwnTextures(){if(this.isOwn){var t;const e=["name"],i=this.entity,s=this.material;b()(t=this.AllTextureKeys).call(t,(t=>{const a=Ts(t),r=this.material[a];if(r){let t=r.url,n=!0;H()(t).call(t,"data:")&&(t=t.replace("data:","")),r.url=t;const o=new Proxy(r,{get:(t,e,i)=>Fr()(t,e,i),set(t,r,o,h){if(n||vt()(e).call(e,r)||"function"==typeof o||t[r]===o)return jr()(t,r,o,h);let l=i.diffMaterials.get(s.id);return l||(l={},i.diffMaterials.set(s.id,l)),l[a]||(l[a]={}),l[a][r]=o,jr()(t,r,o,h)}}),h=new Ur(t,o);this["_"+a]=new q(-r.uniqueId,h),n=!1}}))}}},On.type="PBRMaterialRecord",on=On,hn=(0,xs.Z)(on.prototype,"AlbedoColor",[qr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"#ffffff"}}),ln=(0,xs.Z)(on.prototype,"ReflectivityColor",[Xr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"#000000"}}),cn=(0,xs.Z)(on.prototype,"EmissiveColor",[$r],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"#000000"}}),dn=(0,xs.Z)(on.prototype,"AmbientColor",[Qr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"#000000"}}),un=(0,xs.Z)(on.prototype,"Metallic",[Ls],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pn=(0,xs.Z)(on.prototype,"Roughness",[Ls],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mn=(0,xs.Z)(on.prototype,"Alpha",[Ls],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),gn=(0,xs.Z)(on.prototype,"MicroSurface",[Ls],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_n=(0,xs.Z)(on.prototype,"UseAlphaFromAlbedoTexture",[Ls],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wn=(0,xs.Z)(on.prototype,"TransparencyMode",[Ls],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yn=(0,xs.Z)(on.prototype,"AlphaMode",[Ls],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wr.ALPHA_COMBINE}}),bn=(0,xs.Z)(on.prototype,"AlbedoTexture",[Jr],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fn=(0,xs.Z)(on.prototype,"MetallicTexture",[tn],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),vn=(0,xs.Z)(on.prototype,"BumpTexture",[en],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),xn=(0,xs.Z)(on.prototype,"EmissiveTexture",[sn],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Sn=(0,xs.Z)(on.prototype,"LightmapTexture",[an],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Mn=(0,xs.Z)(on.prototype,"ReflectionTexture",[rn],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),nn=on))||nn);var Cn,An,En;function zn(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}let Dn;!function(t){t[t.None=0]="None",t[t.X=1]="X",t[t.Y=2]="Y",t[t.Z=4]="Z",t[t.All=7]="All"}(Dn||(Dn={}));let Tn,Rn,In,Ln=Y((En=(0,hs.Z)("isReady"),An=class extends Er{constructor(t={url:""}){super(),O()(this,En,{writable:!0,value:!0}),this.__ver=void 0,this.isRead=!1,this.url=void 0,this._preSize={x:10,y:10,z:10},this.isAsync=!0,this.originBoundbox=void 0,this.lockSizeType=Dn.X,this.url=t?.url??""}get isVaildUrl(){return this.url&&"string"==typeof this.url}get Opacity(){return this._opacity}set Opacity(t){if(t===this._opacity)return;this.writeSnapshoot(),this._opacity=t;const e=this._drawObject.getChildMeshes();for(const i of e)i.material&&(i.material.transparencyMode=bi.F.MATERIAL_ALPHABLEND,i.material.alpha=t)}get Source(){return this.url}set Source(t){if(t===this.url)return;this.writeSnapshoot(),this.url||this.once("load",(t=>{I()((()=>{const e=t.target,i=e.originBoundbox.Size,s=e.Scale,a={x:1,y:1,z:1};this.lockSizeType&Dn.X&&(a.x=Math.abs(e.PreSize.x)/Math.abs(i.x),a.y=a.x*s.y,a.z=a.x*s.z,a.x*=s.x),this.lockSizeType&Dn.Y&&(a.y=Math.abs(e.PreSize.y)/Math.abs(i.y)*s.y),this.lockSizeType&Dn.Z&&(a.z=Math.abs(e.PreSize.z)/Math.abs(i.z)*s.z),e.Scale=a}),100)})),this.url=t;const e=this.RenderObject;if(e){const t=e.getChildren();for(const e of t)e.dispose()}this.isRead=!0,this.load(this.RenderType,this.RenderObject)}get PreSize(){return function(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=zn(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=zn(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}({},this._preSize)}set PreSize(t){if(A()(this._preSize,t),!this.isVaildUrl&&this.Id){const t=this.RenderObject;if(t){var e;const i=F()(e=t.getChildren()).call(e,(t=>"\u865a\u62df\u6a21\u578b\u76d2\u5b50"===t.name));if(i){(0,Ee.aR)({width:this._preSize.x,height:this._preSize.y,depth:this._preSize.z}).applyToMesh(i,!0),i.enableEdgesRendering()}}}}get WorldPreSize(){const t=rr(this._preSize);return ki.P.TransformCoordinatesToRef(t,this.Matrix.getRotationMatrix(),t),t}move2Zero(t){const e=this.RenderObject;if(!t){const e=this.BoundingVectors;(t=ki.P.Center(e.min,e.max).negate()).y=0}return this.Position=e.position.add(t),t}get BoundingBox(){const{min:t,max:e}=this.BoundingVectors;return new ra(t,e)}get LocalBoundingBox(){const{min:t,max:e}=this.BoundingVectors;return new ra(t,e,this.Matrix.invert())}initDrawObject(t){const e=new Ki.Kj("import"+this.Id,Er.Scene);if(e.doNotSyncBoundingInfo=!0,this.isVaildUrl)this.load(t,e,!0);else{const t=Yi.V.CreateBox("\u865a\u62df\u6a21\u578b\u76d2\u5b50",{width:this._preSize.x,height:this._preSize.y,depth:this._preSize.z},Er.Scene);t.bakeTransformIntoVertices(ki.y3.Translation(0,this._preSize.y/2,0)),t.visibility=.2,t.enableEdgesRendering(),t.edgesColor=xi.Wo.Gray().toColor4(),t.edgesWidth=8,e.addChild(t)}return e}updateDrawObject(t,e){super.updateDrawObject(t,e)}updateMaterial(t,e){const i=(e??this.RenderObject).getChildMeshes();for(const t of i){const e=this._materialMap.get(t.id);e?e.Object?.Material&&(t.metadata={oldMtl:t.material},t.material=e.Object.Material):t.metadata?.oldMtl&&(t.material=t.metadata.oldMtl)}}getReady(){return new(N())((t=>{(0,os.Z)(this,En)[En]&&t(!0),this.once(ys.Load,(()=>t(!0)))}))}writeFile(t){super.writeFile(t),t.write(2),t.write(this.url),t.writeVector3(this._preSize)}readFile(t){this.isRead=!0,super.readFile(t);const e=t.read();this.url=t.read(),Ji.isEncrypt&&this.encrypt(),e>1&&t.readVector3(this._preSize),this.update()}model2Zero(t){const e=t.getHierarchyBoundingVectors(),i=ki.P.Center(e.min,e.max);i.y=e.min.y;const s=i.negate();t.position=s,this.isRead||(this.Position=s.negate(),this.isRead=!1),this.originBoundbox=new ra(e.min,e.max)}handleAssetContainer(t){var e;let i,s=t.instantiateModelsToScene((t=>t+(this.Id??"")));var a;(this.modelAnimations=s.animationGroups,1===s.rootNodes.length)?i=s.rootNodes[0]:(i=new ji.Y("assetContainerRootMesh",Er.Scene),b()(a=s.rootNodes).call(a,(t=>{t.parent||(t.parent=i)})));b()(e=i.getChildMeshes()).call(e,(t=>{t.isPickable=this.IsPickable})),this._ownMaterials.length=0;for(const e of t.materials)if(e instanceof fi.Y){const t=new Pn(e,this);t.Name=e.name,t.updateFromDiff(),this._ownMaterials.push(t)}return i}load(t,e,i=!1){if(this.url&&e){var s;(0,os.Z)(this,En)[En]=!1,this.encrypt();let a=H()(s=this.url).call(s,"http")?this.url:Ji.assetURL+this.url;this.Name||(this.Name=ta(this.url.split("/")).split(".")[0]);const r=a+"&"+Er.Scene.uid,n=Ir.getAssetPromise(r);if(n)n.then((i=>{if(i){const s=this.handleAssetContainer(i);this.model2Zero(s),s.parent=e,this.updateMaterial(t,e),this.update(ws.Geometry)}(0,os.Z)(this,En)[En]=!0,this.trigger2({type:"load",target:this})}));else{let s;i&&(s=zr.Wait()),Ir.setAssetPromise(r,zr.getLastPromise());const n=Zt.n.LoadAssetContainer(a,void 0,Er.Scene,(i=>{var a;if(!this.isPart&&!this._db&&Er.Scene===zr.MainScene)return;for(const t of i.materials)t instanceof Oi.K&&(t.diffuseColor=xi.Wo.White(),t.ambientColor=xi.Wo.White()),t.alpha=this._opacity;const r=e;i.textures.length=0,b()(a=i.meshes).call(a,(t=>t instanceof Ki.Kj&&(t.receiveShadows=!0)));const n=this.handleAssetContainer(i);var o;t===Us.Wireframe&&b()(o=i.materials).call(o,(t=>t.wireframe=!0));this.model2Zero(n),n.parent=r,this.trigger2({type:ys.Load,target:this}),(0,os.Z)(this,En)[En]=!0,this.updateMaterial(t,e),this.update(ws.Geometry),s?.(i)}),(t=>{const e=t.lengthComputable?Math.floor(t.loaded/t.total*100):0;this.trigger2({type:ys.Loading,target:this,percentage:e})}),((t,e,i)=>{console.error("innerError: ",i.innerError),console.error("err_msg: ",e),(this.isPart||this._db||Er.Scene!==zr.MainScene)&&(s?.(!1),this.trigger({type:ys.Load,target:this,error:i.innerError}),Mr.trigger({type:ys.Load,target:this,error:e}),(0,os.Z)(this,En)[En]=!0)}));Ji.loadPlugins.add(n)}}}encrypt(){var t,e;as()(t=this.url).call(t,".hc3d")||Ji.isEncrypt&&b()(e=[".gltf",".glb",".obj",".STL"]).call(e,(t=>this.url=this.url.replace(t,".hc3d")))}},An.type="ImportEntity",Cn=An))||Cn;class Fn extends be.g{_draw(t){var e;t.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(t.shadowColor=this.shadowColor,t.shadowBlur=this.shadowBlur,t.shadowOffsetX=this.shadowOffsetX,t.shadowOffsetY=this.shadowOffsetY),this._applyStates(t),t.strokeStyle=this.color,t.lineWidth=this.lineWidth,t.setLineDash(this.dash),t.beginPath();let i,s=!0,a=Z()(e=this._points).call(e);if(2===a.length){a[0].control&&(a[0]._point._isDirty=!0,a[0]._point.y+=a[0].control._currentMeasure.height/3,a[0]._point._isDirty=!1);const t=a[0]._point,e=a[1]._point;if(!Ps(t.x,e.x)&&!Ps(t.y,e.y)){const i=ki.P.Center(t,e);a=[a[0],{_point:{x:t.x,y:i.y,z:i.z}},{_point:{x:e.x,y:i.y,z:i.z}},a[1]]}}b()(a).call(a,(e=>{e&&(s?(t.moveTo(e._point.x,e._point.y),s=!1):e._point.z<1&&i.z<1?t.lineTo(e._point.x,e._point.y):t.moveTo(e._point.x,e._point.y),i=e._point)})),t.stroke(),t.restore()}}function kn(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}function jn(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=kn(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=kn(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}class Bn extends pt{constructor(...t){super(...t),this.Is3D=!1,this._color="#000000",this._fontSize="12px",this._width="200px",this._height="30px",this._rotation=0,this._scale={x:1,y:1},this._zIndex=0,this._alpha=.9,this.linkEntity=void 0,this._drawObject=void 0,this._start=void 0,this._end=new ki.FM,this._position={x:"0",y:"0"},this._isSelect=!1,this._name="",this.dataList=[],this._isVisiable=!0,this._isPickable=!0,this.lines=[],this.timeID=void 0,this.GroupId=void 0,this.drag=t=>{if(!this._start)return;const e=this._start.subtract(new ki.FM(t.x,t.y));let[i,s]=[-e.x+this._end.x,-e.y+this._end.y];this.move({x:i,y:s})}}get DataList(){return[...this.dataList]}set DataList(t){this.dataList=t}get UniqueName(){return this.constructor.type+this.Id}get Name(){return this._name||this.UniqueName}set Name(t){this._name=t,Mr.trigger({type:"updateName",target:this})}get Position(){return jn({},this._position)}set Position(t){this.writeSnapshoot(),this._position.x=t.x,this._position.y=t.y,this.move(t)}get Rotation(){return this._rotation}set Rotation(t){this.writeSnapshoot(),this._rotation=t,this._drawObject.rotation=t}get Scale(){return jn({},this._scale)}set Scale(t){this.writeSnapshoot(),A()(this._scale,t),this._drawObject.scaleX=t.x,this._drawObject.scaleY=t.y}get Width(){return this._width}set Width(t){t!==this._width&&(this.writeSnapshoot(),this._width=t,this.update())}get Height(){return this._height}set Height(t){t!==this._height&&(this.writeSnapshoot(),this._height=t,this.update())}get DrawObject(){return this._drawObject||(this._drawObject=this.initDrawObject(),this._drawObject.metadata={entity:this},this._drawObject.isVisible=this._isVisiable&&!this._erase,this.supportDrag()),this._drawObject}get Draging(){return!!this._start}get IsSelect(){return this._isSelect}set IsSelect(t){this._isSelect=t,this._drawObject&&(this._drawObject.shadowColor=t?"#000000":"#168df8")}get Visiable(){return this._isVisiable}set Visiable(t){t!==this._isVisiable&&(this.writeSnapshoot(),this._isVisiable=t,this.trigger2({type:ys.UpdateVisiable,target:this}),this.update())}get IsPickable(){return this._isPickable}set IsPickable(t){this.writeSnapshoot(),this._isPickable=t}attachEntity(t){this.linkEntity=t}initDrawObject(){return null}setProp(t,e){for(const i of this.dataList)i.key===t&&(i.value=e)}updateDrawObject(t){var e;t.width=this._width,t.color=this._color,t.rotation=this._rotation,t.scaleX=this._scale.x,t.scaleY=this._scale.y,t.zIndex=this._zIndex,t.fontSize=this._fontSize,t.alpha=this._alpha,t.isVisible=this._isVisiable,b()(e=this.lines).call(e,(t=>t.isVisible=this._isVisiable)),this.move(this._position,t)}update(){this._drawObject&&(this.updateDrawObject(this._drawObject),this.trigger2({type:"update",target:this}))}click(t){this._isPickable&&(this.trigger({type:"pointerDownGui",target:this,point:t}),Mr.trigger({type:"pointerDownGui",target:this,point:t}))}startDrag(t){if(!this._isPickable)return;if(zr.PreviewMode)return;this._db&&this._db.HistoryManager.startCmd("\u62d6\u62fdGUI"),this.writeSnapshoot(),this._start=new ki.FM(t.x,t.y);let e=this._drawObject.left,i=this._drawObject.top;this.linkEntity&&(e=this._drawObject.linkOffsetX,i=this._drawObject.linkOffsetY);const s=zr.MainViewer.Width,a=zr.MainViewer.Height;let r=this.getPositionValue(e,s),n=this.getPositionValue(i,a);this._end=new ki.FM(r,n)}endDrag(t){Mr.trigger({type:"pointerUpGui",target:this,point:t}),this._start=null,this._db&&this._db.HistoryManager.endCmd()}move(t,e=this._drawObject){if(!e)return;const i=zr.MainViewer.Width,s=zr.MainViewer.Height;this.linkEntity?(e.linkOffsetX=t.x,e.linkOffsetY=t.y,this._position.x=t.x.toString(),this._position.y=t.y.toString()):("number"==typeof t.x?(e.left=t.x/i*100+"%",this._position.x=t.x/i*100+"%"):(e.left=t.x,this._position.x=t.x),"number"==typeof t.y?(e.top=t.y/s*100+"%",this._position.y=t.y/s*100+"%"):(e.top=t.y,this._position.y=t.y)),Mr.trigger({type:"update",target:this}),this.trigger({type:"update",target:this})}erase(t=!0){var e;t!==this._erase&&(super.erase(t),this._drawObject.isVisible=!t,b()(e=this.lines).call(e,(e=>e.isVisible=!t)),Mr.trigger({type:"remove",target:this}),this.trigger({type:"remove",target:this}))}ptInContainer(t){return!!this._drawObject&&this._drawObject.contains(t.x,t.y)}destory(){var t;super.destory(),this.timeID&&clearTimeout(this.timeID),this._drawObject&&this._drawObject.dispose(),this._drawObject=null,b()(t=this.lines).call(t,(t=>t.dispose())),this.lines.length=0}writeFile(t){super.writeFile(t),t.write(4),t.write(this._position.x),t.write(this._position.y),t.write(this._rotation),t.write(this._scale.x),t.write(this._scale.y),t.write(this._name),t.write(this._width),t.write(this._height),t.write(this._color),t.write(this._zIndex),t.write(this._fontSize),t.write(this._alpha),t.writeObjectId(this.linkEntity),t.writeAnyArray(this.dataList,(e=>{t.write(e.key),t.write(e.label),t.write(e.value),t.write(e.unit)})),t.write(this._isVisiable),t.write(this._isPickable),t.writeObjectId(this.GroupId)}readFile(t){super.readFile(t);const e=t.read();this._position.x=t.read(),this._position.y=t.read(),this._rotation=t.read(),this._scale.x=t.read(),this._scale.y=t.read(),this._name=t.read(),this._width=t.read(),this._height=t.read(),this._color=t.read(),this._zIndex=t.read(),this._fontSize=t.read(),this._alpha=t.read(),this.linkEntity=t.readObjectId(),this.dataList.length=0,t.readAnyArray((()=>{const e={};e.key=t.read(),e.label=t.read(),e.value=t.read(),e.unit=t.read(),this.dataList.push(e)})),e>1&&(this._isVisiable=t.read()),e>2&&(this._isPickable=t.read()),e>3&&(this.GroupId=t.readObjectId())}_applyHistoryRecord(t){super._applyHistoryRecord(t),t instanceof ut?this._drawObject.isVisible=!this._erase:t instanceof xt&&this.readFile(t.Filer)}trigger2(t){super.trigger(t),Mr.trigger(t)}getPositionValue(t,e){return"string"==typeof t?as()(t).call(t,"%")?ns()(t)/100*e:ns()(t):t}supportDrag(){this._drawObject.isPointerBlocker=!1}generateLinkLine(t,e=0){this.timeID&&clearTimeout(this.timeID),this.timeID=I()((()=>{if(this.linkEntity?.Object&&t?.parent){const e=new Fn("linkLine"+this.Id);e.isVisible=this._isVisiable,e.color="rgba(14,232,210,0.2)",e.lineWidth=2,e.add(t);e.getAt(1).mesh=this.linkEntity.Object.RenderObject,t.zIndex=1,t.parent.addControl(e),t.linkWithMesh(this.linkEntity.Object.DrawObject),this.move(this.Position,t),this.lines.push(e)}}),e)}}!function(t){t.SelectMarquee="32"}(Tn||(Tn={}));class Nn{constructor(t){this.start=new ki.FM,this.end=new ki.FM,this.selectType=Fs.None,this.rightColor="rgba(225, 240, 255, 0.5)",this.leftColor="rgba(225, 240, 255, 0.4)",this.rightBorder="1px dashed rgb(179, 179, 245)",this.leftBorder="1px solid rgb(179, 179, 245)",this.dom=void 0,this.width=void 0,this.height=void 0,this.dom=document.createElement("div"),t.appendChild(this.dom);let e=this.dom.style;e.position="absolute",e.zIndex=Tn.SelectMarquee,e.background="rgba(0, 63, 255, 0.2)",e.margin="0",e.pointerEvents="none",e.top="460px",e.left="100px",e.width="100px",e.height="200px",e.display="none",e.border=this.leftBorder}show(){this.dom.style.display="block"}hide(){this.dom.style.display="none"}update(){this.dom.style.top=Math.min(this.start.y,this.end.y)+"px",this.dom.style.left=Math.min(this.start.x,this.end.x)+"px",this.width=Math.abs(this.start.x-this.end.x),this.height=Math.abs(this.start.y-this.end.y),this.dom.style.width=this.width+"px",this.dom.style.height=this.height+"px";let t=this.selectType;this.selectType===Fs.None&&(t=this.start.x>this.end.x?Fs.C:Fs.W),t===Fs.C?(this.dom.style.background=this.leftColor,this.dom.style.border=this.leftBorder):(this.dom.style.background=this.rightColor,this.dom.style.border=this.rightBorder)}setStart(t,e){this.start.set(t,e)}setEnd(t,e){this.end.set(t,e),this.update()}}!function(t){t[t.Ok=1]="Ok",t[t.Cancel=0]="Cancel",t[t.Error=-1]="Error",t[t.KeyWord=2]="KeyWord"}(Rn||(Rn={})),function(t){t[t.None=0]="None",t[t.GetPoint=1]="GetPoint",t[t.Select=2]="Select",t[t.Drag=4]="Drag",t[t.All=63]="All"}(In||(In={}));class Gn extends class{constructor(t){this._viewer=t,this.selectList=new(Q()),this._tempPlane=void 0}get Plane(){if(this._tempPlane)return this._tempPlane;const t=Yi.V.CreatePlane("get-point",{size:1e3});return t.setEnabled(!1),this._tempPlane=t,t}select(t){}destoryTempPlane(){this._tempPlane&&(this._tempPlane.dispose(),this._tempPlane=null)}world2screen(t){const e=ki.P.Project(t,ki.y3.IdentityReadOnly,this._viewer.Scene.getTransformMatrix(),this._viewer.Camera.viewport.toGlobal(this._viewer.Scene.getEngine().getRenderWidth(),this._viewer.Scene.getEngine().getRenderHeight()));return e.z=0,e}screen2World(t,e=!0){const i=this._viewer.Scene.createPickingRay(t.x,t.y,this._viewer.Scene.getViewMatrix(),this._viewer.cameraManager.Camera,!0);this._viewer.ground&&(this._viewer.ground.isPickable=!0);const s=i.intersectsMesh(this._viewer.ground||this.Plane);return this._viewer.ground&&(this._viewer.ground.isPickable=!1),e&&this.destoryTempPlane(),s.hit?s.pickedPoint:null}get SelectEntitys(){const t=[];for(const e of this.selectList)t.push(e.metadata.Entity);return t}get SelectMeshs(){return[...this.selectList]}}{constructor(t,e,i){var s;super(t),this._Viewer=t,this.start=e,this.end=i,this._SelectType=void 0,this.activeMeshes=new(Q());const a=this._Viewer.Scene.getActiveMeshes();this.activeMeshes=new(Q())(Z()(s=a.data).call(s,0,a.length))}select(t){t=t??this._Viewer.Scene.rootNodes;for(const e of t)this.targetIsSelect(e)&&this.selectList.add(e)}targetIsSelect(t){var e;if(!t.metadata?.Entity?.Visiable)return!1;if(!t.metadata?.Entity?.IsPickable)return!1;if("WORLD_GROUND"===t.name)return!1;if(this._SelectType===Fs.None)return!1;const i=this.start,s=this.end,a=Math.min(i.x,s.x),r=Math.min(i.y,s.y),n=Math.max(i.x,s.x),o=Math.max(i.y,s.y),h=t.metadata?.Entity,l=h.BoundingBox,c=wa()(e=l.vectorsWorld).call(e,(t=>this.world2screen(t))),d=new ra(c[0],c[1]);d.setFromPoints(c);const u=new ra(new ki.P(a,r),new ki.P(n,o));if(!mi.k.Intersects(d,u))return!1;const p=t.getChildMeshes();for(const t of p){if(!t.geometry)continue;if(!this.activeMeshes.has(t))continue;const e=t.getPositionData(),i=t.getWorldMatrix();for(let t=0;t<e.length;t+=3){const s=new ki.P(e[t],e[t+1],e[t+2]);ki.P.TransformCoordinatesToRef(s,i,s);const a=this.world2screen(s);if(u.intersectsPoint(a))return!0}}return!1}}class Hn{constructor(){this._selectSetList=new(Q())}get SelectMeshs(){return[...this._selectSetList]}get SelectEntitys(){var t;return wa()(t=this.SelectMeshs).call(t,(t=>t.metadata.Entity))}add(t){for(const i of t){if(i.metadata?.Entity?.GroupId){var e;const t=i.metadata?.Entity?.GroupId?.Object,s=wa()(e=t.entitys).call(e,(t=>t.Object));for(const t of s)t instanceof Er&&t.Visiable&&t.DrawObject&&this._selectSetList.add(t.DrawObject)}this._selectSetList.add(i)}}addEns(t){b()(t).call(t,(t=>this._selectSetList.add(t.DrawObject)))}remove(){}clear(){var t;b()(t=this._selectSetList).call(t,(t=>{t?.metadata?.Entity&&(t.metadata.Entity.IsSelect=!1)})),this._selectSetList.clear()}}class Vn{constructor(t,e){this._viewer=t,this.editor=e,this.selectMarquee=void 0,this.selectSet=new Hn,this.doing=!1,this.selectObserable=new zi.y$,this._SelectType=Fs.None,this._selectGui=void 0,this._selectDOM=void 0,this._selectParticle=void 0,this._selectGroupRecord=void 0,this.selectMarquee=new Nn(t.canvas.parentElement),this._registerEvent()}get isReady(){return this.editor.Status===In.None||!!(this.editor.Status&In.Select)}set SelectType(t){this._SelectType=t,this.selectMarquee.selectType=t}set SelectEntitys(t){this.setSelectEntitys(t)}do(t){return!!this.isReady&&(this.onPointerDown(t),!0)}cancel(){this.reset(),this.clearSelect(!0)}reset(){this.doing=!1,this.selectMarquee.hide(),this.editor.Status&=~In.Select}setSelectEntitys(t,e=!0){this.clearSelect();const i=new Hn;i.addEns(t),this.selectSet=i,this.update(e)}get SelectMeshs(){return this._selectGui||this._selectDOM?[]:this.selectSet.SelectMeshs}get SelectObjects(){return this._selectGui?[this._selectGui]:this._selectDOM?[this._selectDOM]:this._selectParticle?[this._selectParticle]:this._selectGroupRecord?[this._selectGroupRecord]:this.selectSet.SelectEntitys}onPointerDown(t){if(!this.SelectGui?.Draging&&0===t.event.button){const e=this.SelectMeshs??[];if(this.clearSelect(),t.pickInfo.pickedMesh){const i=Ms(t.pickInfo.pickedMesh);if(i.metadata?.Entity)return t.event.ctrlKey||t.event.metaKey?vt()(e).call(e,i)?(ea(e,i),this.selectSet.add(e)):this.selectSet.add([i,...e]):this.selectSet.add([i]),void this.update()}this.doing=!0,this.editor.Status=In.Select,this.selectMarquee.show(),this.selectMarquee.setStart(this._viewer.Scene.pointerX,this._viewer.Scene.pointerY),this.selectMarquee.setEnd(this._viewer.Scene.pointerX,this._viewer.Scene.pointerY),this.selectMarquee.update()}}onPointerMove(t){this.doing&&(this.SelectGui?.Draging||(this.selectMarquee.setEnd(this._viewer.Scene.pointerX,this._viewer.Scene.pointerY),this._SelectType=this.selectMarquee.end.x>this.selectMarquee.start.x?Fs.W:Fs.C))}onPointerUp(t){0===t.event.button&&this.doing&&(this.selectByMarquee(),this.reset())}clearSelect(t=!1){this._selectGui&&(this._selectGui.IsSelect=!1,this._selectGui=null),this._selectParticle&&(this._selectParticle.IsSelect=!1,this._selectParticle=null),this._selectDOM&&(this._selectDOM.IsSelect=!1,this._selectDOM=null),this._selectGroupRecord&&(this._selectGroupRecord.IsSelect=!1,this._selectGroupRecord=null),this._viewer.highlightManager.clear(),this.selectSet.clear(),t&&this.update()}on(t){const e=this.selectObserable.add(t);return()=>{this.selectObserable.remove(e)}}onSelect(t){const e=this.selectObserable.add(t);return()=>{this.selectObserable.remove(e)}}update(t=!0){var e;b()(e=this.selectSet.SelectEntitys).call(e,(t=>t.IsSelect=!0)),this._viewer.highlightManager.addMeshs(this.selectSet.SelectMeshs),this.selectObserable.notifyObservers({type:"select",meshs:this.SelectMeshs,entitys:this.SelectObjects,isUserInput:t})}get SelectGroupRecord(){return this._selectGroupRecord}set SelectGroupRecord(t){this.clearSelect(),this._selectGroupRecord=t,t.IsSelect=!0,this.update()}get SelectParticle(){return this._selectParticle}set SelectParticle(t){this.clearSelect(),this._selectParticle=t,t.IsSelect=!0,this.update()}get SelectGui(){return this._selectGui}set SelectGui(t){this.clearSelect(),this._selectGui=t,t.IsSelect=!0,this.update()}get SelectDOM(){return this._selectDOM}set SelectDOM(t){this.clearSelect(),this._selectDOM=t,t.IsSelect=!0,this.update()}selectByMarquee(){const t=new Gn(this._viewer,this.selectMarquee.start,this.selectMarquee.end);t._SelectType=this._SelectType,t.select(),this.selectSet.add(t.SelectMeshs),this.update()}_registerEvent(){this._viewer.Scene.onPointerObservable.add((t=>{switch(t.type){case Di.kD.POINTERDOWN:break;case Di.kD.POINTERUP:this.SelectGui?.Draging?this.SelectGui.endDrag({x:t.event.offsetX,y:t.event.offsetY}):this.onPointerUp(t);break;case Di.kD.POINTERMOVE:this.SelectGui?.Draging?this.SelectGui.drag({x:t.event.offsetX,y:t.event.offsetY}):this.onPointerMove(t)}})),this._viewer.canvas.parentElement.addEventListener("mousemove",(t=>{this.SelectDOM?.Draging&&this.SelectDOM.move(t.clientX,t.clientY)})),Mr.on("pointerDownGui",(t=>{this.SelectGui=t.target,this.SelectGui.startDrag(t.point)})),document.addEventListener("mouseup",(()=>{this.SelectDOM?.Draging&&this.SelectDOM.end()}))}}class Zn extends si.t{constructor(...t){super(...t),this._attachedNodes=null,this._tempVector_=new ki.P,this.gizmoPosition=null}_attachedNodesChanged(t){}get attachedNode(){return super.attachedNode}set attachedNode(t){this._attachedNodes=null,super.attachedNode=t}get attachedMesh(){return super.attachedMesh}set attachedMesh(t){this._attachedNodes=null,super.attachedMesh=t}get AttachedNodes(){let t;return this.attachedNode?t=[this.attachedNode]:this.attachedNodes&&(t=this.attachedNodes),t}get attachedNodes(){return this._attachedNodes}set attachedNodes(t){this._attachedNode=null,this._attachedMesh=null,this._attachedNodes=t,this._rootMesh.setEnabled(!!t),this._attachedNodesChanged(t),this.setGizmosPosition(),this.gizmoPosition&&this._rootMesh.position.copyFrom(this.gizmoPosition)}setGizmosPosition(){if(this.attachedNodes){let t=this.attachedNodes;const e=wa()(t).call(t,(t=>t.getWorldMatrix().getRow(3))),i=wa()(e).call(e,(t=>t?t.toVector3():new ki.P(0,0,0)));1===i.length?this.gizmoPosition=null:this.gizmoPosition=ra.GetCenterFromPoints(i)}else this.gizmoPosition=null}_nodeMatrixChanged(t){let e=this._attachedNode;this._attachedNode=t,this._matrixChanged(),this._attachedNode=e}_handlePivots(){const t=this._attachedNodes;for(const e of t)e.isUsingPivotMatrix&&e.isUsingPivotMatrix()&&e.getWorldMatrix().setTranslation(e.position)}_update(){if(super._update(),this.attachedNodes){let t=this.attachedNodes;if(this.updateGizmoPositionToMatchAttachedMesh&&(this.setGizmosPosition(),this.gizmoPosition&&this._rootMesh.position.copyFrom(this.gizmoPosition)),this.updateGizmoRotationToMatchAttachedMesh&&this._rootMesh.rotationQuaternion.set(0,0,0,1),this.updateScale){const e=this.gizmoLayer.utilityLayerScene.activeCamera;let i=e.globalPosition;e.devicePosition&&(i=e.devicePosition),this._rootMesh.position.subtractToRef(i,this._tempVector_);const s=this._tempVector_.length()*this.scaleRatio;this._rootMesh.scaling.set(s,s,s),Et()(t).call(t,(t=>t._getWorldMatrixDeterminant()<0))&&!si.t.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}else this.gizmoPosition=null;if(this.updateScale){const t=this.gizmoLayer.utilityLayerScene.activeCamera;if(t.mode===Zi.V.ORTHOGRAPHIC_CAMERA){const e=t.metadata?.size;if(!e)return;this._rootMesh.scaling.set(2*e,2*e,2*e)}}}setNodesPovits(t){if(t?.length>1&&this.gizmoPosition){const e=this.gizmoPosition;for(const i of t)if(i instanceof ji.Y){const t=i.absolutePosition.clone();i.setPivotPoint(e,oe.T.WORLD),i.computeWorldMatrix(!0);const s=i.absolutePosition.subtract(t);i.setAbsolutePosition(t.subtract(s))}}}resetNodesPovits(t){if(t?.length>1)for(const e of t)if(e instanceof ji.Y){const t=e.absolutePosition.clone();e.setPivotMatrix(ki.y3.Identity()),e.setAbsolutePosition(t)}}}class Wn extends Zn{static _CreateArrow(t,e,i=1,s=!1){const a=new ji.Y("arrow",t),r=(0,Ie.wf)("cylinder",{diameterTop:0,height:.075,diameterBottom:.0375*(1+(i-1)/4),tessellation:96},t),n=(0,Ie.wf)("cylinder",{diameterTop:.005*i,height:.275,diameterBottom:.005*i,tessellation:96},t);return r.parent=a,r.material=e,r.rotation.x=Math.PI/2,r.position.z+=.3,n.parent=a,n.material=e,n.position.z+=.1375,n.rotation.x=Math.PI/2,s&&(n.visibility=0,r.visibility=0),a}static _CreateArrowInstance(t,e){const i=new ji.Y("arrow",t);for(const t of e.getChildMeshes()){t.createInstance(t.name).parent=i}return i}constructor(t,e=xi.Wo.Gray(),i=qi.x.DefaultUtilityLayer,s=null,a=1){var r;super(i),this.dragBehavior=void 0,this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new zi.y$,this._isEnabled=!0,this._parent=null,this._gizmoMesh=void 0,this._coloredMaterial=void 0,this._hoverMaterial=void 0,this._disableMaterial=void 0,this._dragging=!1,this._parent=s,this._coloredMaterial=new Oi.K("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=e,this._coloredMaterial.specularColor=e.subtract(new xi.Wo(.1,.1,.1)),this._hoverMaterial=new Oi.K("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=xi.Wo.Yellow(),this._disableMaterial=new Oi.K("",i.utilityLayerScene),this._disableMaterial.diffuseColor=xi.Wo.Gray(),this._disableMaterial.alpha=.4;const n=Wn._CreateArrow(i.utilityLayerScene,this._coloredMaterial,a),o=Wn._CreateArrow(i.utilityLayerScene,this._coloredMaterial,a+4,!0);this._gizmoMesh=new Ki.Kj("",i.utilityLayerScene),this._gizmoMesh.addChild(n),this._gizmoMesh.addChild(o),this._gizmoMesh.lookAt(this._rootMesh.position.add(t)),this._gizmoMesh.scaling.scaleInPlace(1/3),this._gizmoMesh.parent=this._rootMesh;let h=0;const l=new ki.P,c=new ki.P,d={snapDistance:0};this.dragBehavior=new Mi.M({dragAxis:t});let u=kt(this.dragBehavior,this.dragBehavior.attach,(()=>{const t=this.dragBehavior._dragPlane;(0,Oe.Hq)({size:1e8,sideOrientation:Ki.Kj.DOUBLESIDE}).applyToMesh(t,!1),u(),u=null}));this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior),this.dragBehavior.onDragObservable.add((t=>{let e;if(this.attachedNode?(this._handlePivot(),e=[this.attachedNode]):this.attachedNodes&&(this._handlePivots(),e=this.attachedNodes),e){for(const i of e){let e=!1;if(0===this.snapDistance)i.getWorldMatrix().getTranslationToRef(c),c.addInPlace(t.delta),this.dragBehavior.validateDrag(c)&&(i.position&&i.position.addInPlaceFromFloats(t.delta.x,t.delta.y,t.delta.z),i.getWorldMatrix().addTranslationFromFloats(t.delta.x,t.delta.y,t.delta.z),i.updateCache(),e=!0);else if(h+=t.dragDistance,Math.abs(h)>this.snapDistance){const s=Math.floor(Math.abs(h)/this.snapDistance);h%=this.snapDistance,t.delta.normalizeToRef(l),l.scaleInPlace(this.snapDistance*s),i.getWorldMatrix().getTranslationToRef(c),c.addInPlace(l),this.dragBehavior.validateDrag(c)&&(i.getWorldMatrix().addTranslationFromFloats(l.x,l.y,l.z),i.updateCache(),d.snapDistance=this.snapDistance*s,this.onSnapObservable.notifyObservers(d),e=!0)}e&&(this._attachedNode=i,this._matrixChanged())}this.attachedNodes&&(this._attachedNode=null)}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1}));const p=i._getSharedGizmoLight();p.includedOnlyMeshes=_s()(r=p.includedOnlyMeshes).call(r,this._rootMesh.getChildMeshes(!1));const m={gizmoMeshes:n.getChildMeshes(),colliderMeshes:o.getChildMeshes(),material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(o,m),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((t=>{var e;if(!this._customMeshSet&&(this._isHovered=!(-1===et()(e=m.colliderMeshes).call(e,t?.pickInfo?.pickedMesh)),!this._parent)){const t=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(m.gizmoMeshes,t)}})),this.dragBehavior.onEnabledObservable.add((t=>{this._setGizmoMeshMaterial(m.gizmoMeshes,t?m.material:m.disableMaterial)}))}_attachedNodeChanged(t){this.dragBehavior&&(this.dragBehavior.enabled=!!t)}_attachedNodesChanged(t){this.dragBehavior&&(this.dragBehavior.enabled=!!t)}set isEnabled(t){this._isEnabled=t,t?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){var t;this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),b()(t=[this._coloredMaterial,this._hoverMaterial,this._disableMaterial]).call(t,(t=>{t&&t.dispose()})),super.dispose()}lookAt(t){this._gizmoMesh.lookAt(t)}}class Un extends Zn{static _CreatePlane(t,e){const i=new ji.Y("plane",t),s=(0,Oe.pT)("dragPlane",{width:.1375,height:.1375,sideOrientation:2},t);return s.material=e,s.parent=i,s.visibility=.3,i}constructor(t,e=xi.Wo.Gray(),i=qi.x.DefaultUtilityLayer,s=null){var a;super(i),this.dragBehavior=void 0,this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new zi.y$,this._gizmoMesh=void 0,this._coloredMaterial=void 0,this._hoverMaterial=void 0,this._disableMaterial=void 0,this._isEnabled=!1,this._parent=null,this._dragging=!1,this._parent=s,this._coloredMaterial=new Oi.K("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=e,this._coloredMaterial.specularColor=e.subtract(new xi.Wo(.1,.1,.1)),this._hoverMaterial=new Oi.K("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=xi.Wo.Yellow(),this._disableMaterial=new Oi.K("",i.utilityLayerScene),this._disableMaterial.diffuseColor=xi.Wo.Gray(),this._disableMaterial.alpha=.4,this._gizmoMesh=Un._CreatePlane(i.utilityLayerScene,this._coloredMaterial),this._gizmoMesh.lookAt(this._rootMesh.position.add(t)),this._gizmoMesh.scaling.scaleInPlace(1/3),this._gizmoMesh.parent=this._rootMesh;let r=0;const n=new ki.P,o={snapDistance:0};this.dragBehavior=new Mi.M({dragPlaneNormal:t}),this.dragBehavior.moveAttached=!1,this._rootMesh.addBehavior(this.dragBehavior),this.dragBehavior.onDragObservable.add((t=>{let e;if(this.attachedNode?(this._handlePivot(),e=[this.attachedNode]):this.attachedNodes&&(e=this.attachedNodes),e){for(const i of e){if(0===this.snapDistance)i.getWorldMatrix().addTranslationFromFloats(t.delta.x,t.delta.y,t.delta.z);else if(r+=t.dragDistance,Math.abs(r)>this.snapDistance){const e=Math.floor(Math.abs(r)/this.snapDistance);r%=this.snapDistance,t.delta.normalizeToRef(n),n.scaleInPlace(this.snapDistance*e),i.getWorldMatrix().addTranslationFromFloats(n.x,n.y,n.z),o.snapDistance=this.snapDistance*e,this.onSnapObservable.notifyObservers(o)}this._attachedNode=i,this._matrixChanged()}this.attachedNodes&&(this._attachedNode=null)}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1}));const h=i._getSharedGizmoLight();h.includedOnlyMeshes=_s()(a=h.includedOnlyMeshes).call(a,this._rootMesh.getChildMeshes(!1));const l={gizmoMeshes:this._gizmoMesh.getChildMeshes(),colliderMeshes:this._gizmoMesh.getChildMeshes(),material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(this._gizmoMesh,l),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((t=>{var e;if(!this._customMeshSet&&(this._isHovered=!(-1===et()(e=l.colliderMeshes).call(e,t?.pickInfo?.pickedMesh)),!this._parent)){const t=l.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(l.gizmoMeshes,t)}})),this.dragBehavior.onEnabledObservable.add((t=>{this._setGizmoMeshMaterial(l.gizmoMeshes,t?this._coloredMaterial:this._disableMaterial)}))}_attachedNodeChanged(t){this.dragBehavior&&(this.dragBehavior.enabled=!!t)}_attachedNodesChanged(t){this.dragBehavior&&(this.dragBehavior.enabled=!!t)}set isEnabled(t){this._isEnabled=t,t?this._parent&&(this.attachedNode=this._parent.attachedNode):this.attachedNode=null}get isEnabled(){return this._isEnabled}dispose(){var t;this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),super.dispose(),this._gizmoMesh&&this._gizmoMesh.dispose(),b()(t=[this._coloredMaterial,this._hoverMaterial,this._disableMaterial]).call(t,(t=>{t&&t.dispose()}))}}class Kn extends si.t{get attachedMesh(){return this._meshAttached}set attachedMesh(t){var e;this._nodeAttacheds=null,this._meshAttached=t,this._nodeAttached=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo]).call(e,(e=>{e.isEnabled?e.attachedMesh=t:e.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(t){var e;this._meshAttached=null,this._nodeAttacheds=null,this._nodeAttached=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo]).call(e,(e=>{e.isEnabled?e.attachedNode=t:e.attachedNode=null}))}get attachedNodes(){return this._nodeAttacheds}set attachedNodes(t){var e;this._meshAttached=null,this._nodeAttached=null,this._nodeAttacheds=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo]).call(e,(e=>{e.isEnabled?e.attachedNodes=t:e.attachedNodes=null}))}get isHovered(){var t;let e=!1;return b()(t=[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo]).call(t,(t=>{e=e||t.isHovered})),e}constructor(t=qi.x.DefaultUtilityLayer,e=1,i){var s;super(t),this.xGizmo=void 0,this.yGizmo=void 0,this.zGizmo=void 0,this.xPlaneGizmo=void 0,this.yPlaneGizmo=void 0,this.zPlaneGizmo=void 0,this._meshAttached=null,this._nodeAttached=null,this._nodeAttacheds=null,this._snapDistance=void 0,this._observables=[],this._gizmoAxisCache=new(U()),this.onDragStartObservable=new zi.y$,this.onDragEndObservable=new zi.y$,this._planarGizmoEnabled=!1,this.xGizmo=new Wn(new ki.P(1,0,0),xi.Wo.Red().scale(.5),t,this,e),this.yGizmo=new Wn(new ki.P(0,1,0),xi.Wo.Green().scale(.5),t,this,e),this.zGizmo=new Wn(new ki.P(0,0,1),xi.Wo.Blue().scale(.5),t,this,e),this.xPlaneGizmo=new Un(new ki.P(1,0,0),xi.Wo.Red().scale(.5),this.gizmoLayer,this),this.yPlaneGizmo=new Un(new ki.P(0,1,0),xi.Wo.Green().scale(.5),this.gizmoLayer,this),this.zPlaneGizmo=new Un(new ki.P(0,0,1),xi.Wo.Blue().scale(.5),this.gizmoLayer,this),b()(s=[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo]).call(s,(t=>{t.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),t.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,i?i.addToAxisCache(this._gizmoAxisCache):si.t.GizmoAxisPointerObserver(t,this._gizmoAxisCache)}set planarGizmoEnabled(t){var e;this._planarGizmoEnabled=t,b()(e=[this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo]).call(e,(e=>{e&&(e.isEnabled=t,t&&(e.attachedMesh?e.attachedMesh=this.attachedMesh:e.attachedNode=this.attachedNode))}),this)}get planarGizmoEnabled(){return this._planarGizmoEnabled}set updateGizmoRotationToMatchAttachedMesh(t){var e;this._updateGizmoRotationToMatchAttachedMesh=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo]).call(e,(e=>{e&&(e.updateGizmoRotationToMatchAttachedMesh=t)}))}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set snapDistance(t){var e;this._snapDistance=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo]).call(e,(e=>{e&&(e.snapDistance=t)}))}get snapDistance(){return this._snapDistance}set scaleRatio(t){var e;this._scaleRatio=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo]).call(e,(e=>{e&&(e.scaleRatio=t)}))}get scaleRatio(){return this._scaleRatio}addToAxisCache(t,e){this._gizmoAxisCache.set(t,e)}dispose(){var t,e;b()(t=[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo]).call(t,(t=>{t&&t.dispose()})),b()(e=this._observables).call(e,(t=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(t)})),this.onDragStartObservable.clear(),this.onDragEndObservable.clear()}setCustomMesh(){console.error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo,gizmo.xPlaneGizmo, gizmo.yPlaneGizmo, gizmo.zPlaneGizmo)")}}class Yn extends Zn{constructor(t,e=xi.Wo.Gray(),i=qi.x.DefaultUtilityLayer,s=32,a=null,r=!1,n=1){var o;super(i),this.dragBehavior=void 0,this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new zi.y$,this.angle=0,this._isEnabled=!0,this._parent=null,this._coloredMaterial=void 0,this._hoverMaterial=void 0,this._disableMaterial=void 0,this._gizmoMesh=void 0,this._rotationDisplayPlane=void 0,this._dragging=!1,this._angles=new ki.P,this._rotationShaderMaterial=void 0,this._parent=a,this._coloredMaterial=new Oi.K("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=e,this._coloredMaterial.specularColor=e.subtract(new xi.Wo(.1,.1,.1)),this._hoverMaterial=new Oi.K("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=xi.Wo.Yellow(),this._disableMaterial=new Oi.K("",i.utilityLayerScene),this._disableMaterial.diffuseColor=xi.Wo.Gray(),this._disableMaterial.alpha=.4,this._gizmoMesh=new Ki.Kj("",i.utilityLayerScene);const{rotationMesh:h,collider:l}=this._createGizmoMesh(this._gizmoMesh,n,s);this._rotationDisplayPlane=(0,Oe.pT)("rotationDisplay",{size:.6,updatable:!1},this.gizmoLayer.utilityLayerScene),this._rotationDisplayPlane.rotation.z=.5*Math.PI,this._rotationDisplayPlane.parent=this._gizmoMesh,this._rotationDisplayPlane.setEnabled(!1),Fe.Q.ShadersStore.rotationGizmoVertexShader=Yn._RotationGizmoVertexShader,Fe.Q.ShadersStore.rotationGizmoFragmentShader=Yn._RotationGizmoFragmentShader,this._rotationShaderMaterial=new je.j("shader",this.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles"]}),this._rotationShaderMaterial.backFaceCulling=!1,this._rotationDisplayPlane.material=this._rotationShaderMaterial,this._rotationDisplayPlane.visibility=.999,this._gizmoMesh.lookAt(this._rootMesh.position.add(t)),this._rootMesh.addChild(this._gizmoMesh,si.t.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3),this.dragBehavior=new Mi.M({dragPlaneNormal:t});let c=kt(this.dragBehavior,this.dragBehavior.attach,(()=>{const t=this.dragBehavior._dragPlane;(0,Oe.Hq)({size:1e8,sideOrientation:Ki.Kj.DOUBLESIDE}).applyToMesh(t,!1),c(),c=null}));this.dragBehavior.moveAttached=!1,this.dragBehavior.maxDragAngle=Yn.MaxDragAngle,this.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,this._rootMesh.addBehavior(this.dragBehavior);const d=new ki.P,u=new ki.y3,p=new ki.P;let m=new ki.P;this.dragBehavior.onDragStartObservable.add((t=>{let e=this.AttachedNodes;e&&(this.setNodesPovits(e),d.copyFrom(t.dragPlanePoint),this._rotationDisplayPlane.setEnabled(!0),this._rotationDisplayPlane.getWorldMatrix().invertToRef(u),ki.P.TransformCoordinatesToRef(t.dragPlanePoint,u,d),this._angles.x=Math.atan2(d.y,d.x)+Math.PI,this._angles.y=0,this._angles.z=this.updateGizmoRotationToMatchAttachedMesh?1:0,this._dragging=!0,d.copyFrom(t.dragPlanePoint),this._rotationShaderMaterial.setVector3("angles",this._angles),this.angle=0)})),this.dragBehavior.onDragEndObservable.add((()=>{this.resetNodesPovits(this.AttachedNodes),this._dragging=!1,this._rotationDisplayPlane.setEnabled(!1)}));const g={snapDistance:0};let _=0;const w=new ki.y3,y=new ki._f;this.dragBehavior.onDragObservable.add((e=>{let s=this.AttachedNodes;if(this.attachedNode?this._handlePivot():this._handlePivots(),s){const a=new ki.P(1,1,1),r=new ki._f(0,0,0,1),n=new ki.P(0,0,0);s.length>1?this.gizmoPosition&&n.copyFrom(this.gizmoPosition):s[0].getWorldMatrix().decompose(a,r,n);const o=e.dragPlanePoint.subtract(n).normalize(),h=d.subtract(n).normalize(),l=ki.P.Cross(o,h),c=ki.P.Dot(o,h);let b=Math.atan2(l.length(),c);p.copyFrom(t),m.copyFrom(t);let f=!1,v=!1;if(this.updateGizmoRotationToMatchAttachedMesh&&(r.toRotationMatrix(u),m=ki.P.TransformCoordinates(p,u)),i.utilityLayerScene.activeCamera){const t=i.utilityLayerScene.activeCamera.position.subtract(n).normalize();ki.P.Dot(t,m)>0&&(p.scaleInPlace(-1),m.scaleInPlace(-1),v=!0)}if(0!==this.snapDistance)if(_+=b,Math.abs(_)>this.snapDistance){let t=Math.floor(Math.abs(_)/this.snapDistance);_<0&&(t*=-1),_%=this.snapDistance,b=this.snapDistance*t,f=!0}else b=0;ki.P.Dot(m,l)>0&&(b=-b);const x=Math.sin(b/2);if(y.set(p.x*x,p.y*x,p.z*x,Math.cos(b/2)),w.determinant()>0){const t=new ki.P;y.toEulerAnglesToRef(t),ki._f.RotationYawPitchRollToRef(t.y,-t.x,-t.z,y)}this._angles.y+=b,this._rotationShaderMaterial.setVector3("angles",this._angles);for(const t of s){let e=new ki.P;1===s.length?e=n:t.getWorldMatrix().decompose(a,r,e),this.updateGizmoRotationToMatchAttachedMesh?r.multiplyToRef(y,r):y.multiplyToRef(r,r),t.getWorldMatrix().copyFrom(ki.y3.Compose(a,r,e)),this._nodeMatrixChanged(t)}f&&(g.snapDistance=b,this.onSnapObservable.notifyObservers(g)),d.copyFrom(e.dragPlanePoint)}}));const b=i._getSharedGizmoLight();b.includedOnlyMeshes=_s()(o=b.includedOnlyMeshes).call(o,this._rootMesh.getChildMeshes(!1));const f={colliderMeshes:[l],gizmoMeshes:[h],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(this._gizmoMesh,f),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((t=>{var e;if(!this._customMeshSet&&(this.dragBehavior.maxDragAngle=Yn.MaxDragAngle,this._isHovered=!(-1===et()(e=f.colliderMeshes).call(e,t?.pickInfo?.pickedMesh)),!this._parent)){const t=f.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(f.gizmoMeshes,t)}})),this.dragBehavior.onEnabledObservable.add((t=>{this._setGizmoMeshMaterial(f.gizmoMeshes,t?this._coloredMaterial:this._disableMaterial)}))}_createGizmoMesh(t,e,i){const s=(0,ze.eu)("ignore",{diameter:.6,thickness:.03*e,tessellation:i},this.gizmoLayer.utilityLayerScene);s.visibility=0;const a=(0,ze.eu)("",{diameter:.6,thickness:.005*e,tessellation:i},this.gizmoLayer.utilityLayerScene);return a.material=this._coloredMaterial,a.rotation.x=Math.PI/2,s.rotation.x=Math.PI/2,t.addChild(a,si.t.PreserveScaling),t.addChild(s,si.t.PreserveScaling),{rotationMesh:a,collider:s}}_attachedNodeChanged(t){this.updateGizmoPositionToMatchAttachedMesh=!0,this.updateGizmoRotationToMatchAttachedMesh=!0,this.dragBehavior&&(this.dragBehavior.enabled=!!t)}_attachedNodesChanged(t){this.updateGizmoPositionToMatchAttachedMesh=!1,this.updateGizmoRotationToMatchAttachedMesh=!1,this.dragBehavior&&(this.dragBehavior.enabled=!!t)}set isEnabled(t){this._isEnabled=t,t?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null}get isEnabled(){return this._isEnabled}dispose(){var t;this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),b()(t=[this._coloredMaterial,this._hoverMaterial,this._disableMaterial]).call(t,(t=>{t&&t.dispose()})),super.dispose()}}Yn.MaxDragAngle=9*Math.PI/20,Yn._RotationGizmoVertexShader="\n        precision highp float;\n        attribute vec3 position;\n        attribute vec2 uv;\n        uniform mat4 worldViewProjection;\n        varying vec3 vPosition;\n        varying vec2 vUV;\n        void main(void) {\n            gl_Position = worldViewProjection * vec4(position, 1.0);\n            vUV = uv;\n        }",Yn._RotationGizmoFragmentShader="\n        precision highp float;\n        varying vec2 vUV;\n        varying vec3 vPosition;\n        uniform vec3 angles;\n        #define twopi 6.283185307\n        void main(void) {\n            vec2 uv = vUV - vec2(0.5);\n            float angle = atan(uv.y, uv.x) + 3.141592;\n            float delta = gl_FrontFacing ? angles.y : -angles.y;\n            float begin = angles.x - delta * angles.z;\n            float start = (begin < (begin + delta)) ? begin : (begin + delta);\n            float end = (begin > (begin + delta)) ? begin : (begin + delta);\n            float len = sqrt(dot(uv,uv));\n            float opacity = 1. - step(0.5, len);\n\n            float base = abs(floor(start / twopi)) * twopi;\n            start += base;\n            end += base;\n\n            float intensity = 0.;\n            for (int i = 0; i < 5; i++)\n            {\n                intensity += max(step(start, angle) - step(end, angle), 0.);\n                angle += twopi;\n            }\n            gl_FragColor = vec4(1.,1.,0., min(intensity * 0.25, 0.8)) * opacity;\n        }";class qn extends si.t{get attachedMesh(){return this._meshAttached}set attachedMesh(t){var e;this._meshAttached=t,this._nodeAttached=t,this._checkBillboardTransform(),b()(e=[this.xGizmo,this.yGizmo,this.zGizmo]).call(e,(e=>{e.isEnabled?e.attachedMesh=t:e.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(t){var e;this._meshAttached=null,this._nodeAttached=t,this._checkBillboardTransform(),b()(e=[this.xGizmo,this.yGizmo,this.zGizmo]).call(e,(e=>{e.isEnabled?e.attachedNode=t:e.attachedNode=null}))}get attachedNodes(){return this._nodeAttacheds}set attachedNodes(t){var e;this._meshAttached=null,this._nodeAttached=null,this._nodeAttacheds=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo]).call(e,(e=>{e.isEnabled?e.attachedNodes=t:e.attachedNodes=null}))}_checkBillboardTransform(){this._nodeAttached&&this._nodeAttached.billboardMode}get isHovered(){var t;let e=!1;return b()(t=[this.xGizmo,this.yGizmo,this.zGizmo]).call(t,(t=>{e=e||t.isHovered})),e}constructor(t=qi.x.DefaultUtilityLayer,e=32,i=!1,s=1,a,r){var n;super(t),this.xGizmo=void 0,this.yGizmo=void 0,this.zGizmo=void 0,this.onDragStartObservable=new zi.y$,this.onDragEndObservable=new zi.y$,this._meshAttached=void 0,this._nodeAttached=void 0,this._nodeAttacheds=void 0,this._observables=[],this._gizmoAxisCache=new(U());const o=r&&r.xOptions&&r.xOptions.color?r.xOptions.color:xi.Wo.Red().scale(.5),h=r&&r.yOptions&&r.yOptions.color?r.yOptions.color:xi.Wo.Green().scale(.5),l=r&&r.zOptions&&r.zOptions.color?r.zOptions.color:xi.Wo.Blue().scale(.5);this.xGizmo=new Yn(new ki.P(1,0,0),o,t,e,this,i,s),this.yGizmo=new Yn(new ki.P(0,1,0),h,t,e,this,i,s),this.zGizmo=new Yn(new ki.P(0,0,1),l,t,e,this,i,s),b()(n=[this.xGizmo,this.yGizmo,this.zGizmo]).call(n,(t=>{r&&void 0!==r.updateScale&&(t.updateScale=r.updateScale),t.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),t.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,this.attachedNode=null,a?a.addToAxisCache(this._gizmoAxisCache):si.t.GizmoAxisPointerObserver(t,this._gizmoAxisCache)}set updateGizmoRotationToMatchAttachedMesh(t){this.xGizmo&&(this.xGizmo.updateGizmoRotationToMatchAttachedMesh=t,this.yGizmo.updateGizmoRotationToMatchAttachedMesh=t,this.zGizmo.updateGizmoRotationToMatchAttachedMesh=t)}get updateGizmoRotationToMatchAttachedMesh(){return this.xGizmo.updateGizmoRotationToMatchAttachedMesh}set snapDistance(t){this.xGizmo&&(this.xGizmo.snapDistance=t,this.yGizmo.snapDistance=t,this.zGizmo.snapDistance=t)}get snapDistance(){return this.xGizmo.snapDistance}set scaleRatio(t){this.xGizmo&&(this.xGizmo.scaleRatio=t,this.yGizmo.scaleRatio=t,this.zGizmo.scaleRatio=t)}get scaleRatio(){return this.xGizmo.scaleRatio}addToAxisCache(t,e){this._gizmoAxisCache.set(t,e)}dispose(){var t;this.xGizmo.dispose(),this.yGizmo.dispose(),this.zGizmo.dispose(),this.onDragStartObservable.clear(),this.onDragEndObservable.clear(),b()(t=this._observables).call(t,(t=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(t)}))}setCustomMesh(){console.error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo)")}}class Xn extends Zn{constructor(t,e=xi.Wo.Gray(),i=qi.x.DefaultUtilityLayer,s=null,a=1){var r;super(i),this.dragBehavior=void 0,this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new zi.y$,this.uniformScaling=!1,this.sensitivity=1,this.dragScale=1,this._isEnabled=!0,this._parent=null,this._gizmoMesh=void 0,this._coloredMaterial=void 0,this._hoverMaterial=void 0,this._disableMaterial=void 0,this._dragging=!1,this._tmpVector=new ki.P,this._tmpMatrix=new ki.y3,this._tmpMatrix2=new ki.y3,this._parent=s,this._coloredMaterial=new Oi.K("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=e,this._coloredMaterial.specularColor=e.subtract(new xi.Wo(.1,.1,.1)),this._hoverMaterial=new Oi.K("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=xi.Wo.Yellow(),this._disableMaterial=new Oi.K("",i.utilityLayerScene),this._disableMaterial.diffuseColor=xi.Wo.Gray(),this._disableMaterial.alpha=.4,this._gizmoMesh=new Ki.Kj("axis",i.utilityLayerScene);const{arrowMesh:n,arrowTail:o}=this._createGizmoMesh(this._gizmoMesh,a),h=this._createGizmoMesh(this._gizmoMesh,a+4,!0);this._gizmoMesh.lookAt(this._rootMesh.position.add(t)),this._rootMesh.addChild(this._gizmoMesh,si.t.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3);const l=n.position.clone(),c=o.position.clone(),d=o.scaling.clone(),u=t=>{const e=t*(3/this._rootMesh.scaling.length())*6;n.position.z+=e/3.5,o.scaling.y+=e,this.dragScale=o.scaling.y,o.position.z=n.position.z/2},p=()=>{n.position.set(l.x,l.y,l.z),o.position.set(c.x,c.y,c.z),o.scaling.set(d.x,d.y,d.z),this.dragScale=o.scaling.y,this._dragging=!1,this.resetNodesPovits(this.attachedNodes)};this.dragBehavior=new Mi.M({dragAxis:t});let m=kt(this.dragBehavior,this.dragBehavior.attach,(()=>{const t=this.dragBehavior._dragPlane;(0,Oe.Hq)({size:1e8,sideOrientation:Ki.Kj.DOUBLESIDE}).applyToMesh(t,!1),m(),m=null}));this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior);let g=0;const _=new ki.P,w={snapDistance:0};this.dragBehavior.onDragObservable.add((e=>{let i=this.AttachedNodes;if(this.attachedNode?this._handlePivot():this._handlePivots(),i){const s=this.sensitivity*e.dragDistance*(3*this.scaleRatio/this._rootMesh.scaling.length());let a=!1,r=0;this.uniformScaling?_.setAll(.57735):_.copyFrom(t),0===this.snapDistance?_.scaleToRef(s,_):(g+=s,Math.abs(g)>this.snapDistance?(r=Math.floor(Math.abs(g)/this.snapDistance),g<0&&(r*=-1),g%=this.snapDistance,_.scaleToRef(this.snapDistance*r,_),a=!0):_.scaleInPlace(0)),ki.y3.ScalingToRef(1+_.x,1+_.y,1+_.z,this._tmpMatrix2);for(const t of i){this._tmpMatrix2.multiplyToRef(t.getWorldMatrix(),this._tmpMatrix);const e=t._isMesh?t:void 0;this._tmpMatrix.decompose(this._tmpVector,void 0,void 0,si.t.PreserveScaling?e:void 0);const i=1e5;Math.abs(this._tmpVector.x)<i&&Math.abs(this._tmpVector.y)<i&&Math.abs(this._tmpVector.z)<i&&t.getWorldMatrix().copyFrom(this._tmpMatrix),a&&(w.snapDistance=this.snapDistance*r,this.onSnapObservable.notifyObservers(w)),this._attachedNode=t,this._matrixChanged()}this.attachedNodes&&(this._attachedNode=null)}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0,this.setNodesPovits(this.attachedNodes)})),this.dragBehavior.onDragObservable.add((t=>u(t.dragDistance))),this.dragBehavior.onDragEndObservable.add(p),s?.uniformScaleGizmo?.dragBehavior?.onDragObservable?.add((t=>u(t.delta.y))),s?.uniformScaleGizmo?.dragBehavior?.onDragEndObservable?.add(p);const y={gizmoMeshes:[n,o],colliderMeshes:[h.arrowMesh,h.arrowTail],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(this._gizmoMesh,y),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((t=>{var e;if(!this._customMeshSet&&(this._isHovered=!(-1===et()(e=y.colliderMeshes).call(e,t?.pickInfo?.pickedMesh)),!this._parent)){const t=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(y.gizmoMeshes,t)}})),this.dragBehavior.onEnabledObservable.add((t=>{this._setGizmoMeshMaterial(y.gizmoMeshes,t?this._coloredMaterial:this._disableMaterial)}));const b=i._getSharedGizmoLight();b.includedOnlyMeshes=_s()(r=b.includedOnlyMeshes).call(r,this._rootMesh.getChildMeshes())}_createGizmoMesh(t,e,i=!1){const s=(0,Ee.NR)("yPosMesh",{size:.4*(1+(e-1)/4)},this.gizmoLayer.utilityLayerScene),a=(0,Ie.wf)("cylinder",{diameterTop:.005*e,height:.275,diameterBottom:.005*e,tessellation:96},this.gizmoLayer.utilityLayerScene);return s.scaling.scaleInPlace(.1),s.material=this._coloredMaterial,s.rotation.x=Math.PI/2,s.position.z+=.3,a.material=this._coloredMaterial,a.position.z+=.1375,a.rotation.x=Math.PI/2,i&&(s.visibility=0,a.visibility=0),t.addChild(s),t.addChild(a),{arrowMesh:s,arrowTail:a}}_attachedNodeChanged(t){this.dragBehavior&&(this.dragBehavior.enabled=!!t)}_attachedNodesChanged(t){this.dragBehavior&&(this.dragBehavior.enabled=!!t)}set isEnabled(t){this._isEnabled=t,t?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){var t;this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),b()(t=[this._coloredMaterial,this._hoverMaterial,this._disableMaterial]).call(t,(t=>{t&&t.dispose()})),super.dispose()}setCustomMesh(t,e=!1){var i;(super.setCustomMesh(t),e)&&(b()(i=this._rootMesh.getChildMeshes()).call(i,(t=>{t.material=this._coloredMaterial,t.color&&(t.color=this._coloredMaterial.diffuseColor)})),this._customMeshSet=!1)}}class $n extends si.t{get attachedMesh(){return this._meshAttached}set attachedMesh(t){var e;this._meshAttached=t,this._nodeAttached=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo]).call(e,(e=>{e.isEnabled?e.attachedMesh=t:e.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(t){var e;this._meshAttached=null,this._nodeAttached=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo]).call(e,(e=>{e.isEnabled?e.attachedNode=t:e.attachedNode=null}))}get attachedNodes(){return this._nodeAttacheds}set attachedNodes(t){var e;this._meshAttached=null,this._nodeAttached=null,this._nodeAttacheds=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo]).call(e,(e=>{e.isEnabled?e.attachedNodes=t:e.attachedNodes=null}))}get isHovered(){var t;let e=!1;return b()(t=[this.xGizmo,this.yGizmo,this.zGizmo]).call(t,(t=>{e=e||t.isHovered})),e}constructor(t=qi.x.DefaultUtilityLayer,e=1,i){var s;super(t),this.xGizmo=void 0,this.yGizmo=void 0,this.zGizmo=void 0,this.uniformScaleGizmo=void 0,this._meshAttached=null,this._nodeAttached=null,this._nodeAttacheds=void 0,this._snapDistance=void 0,this._uniformScalingMesh=void 0,this._octahedron=void 0,this._sensitivity=1,this._coloredMaterial=void 0,this._hoverMaterial=void 0,this._disableMaterial=void 0,this._observables=[],this._gizmoAxisCache=new(U()),this.onDragStartObservable=new zi.y$,this.onDragEndObservable=new zi.y$,this.uniformScaleGizmo=this._createUniformScaleMesh(),this.xGizmo=new Xn(new ki.P(1,0,0),xi.Wo.Red().scale(.5),t,this,e),this.yGizmo=new Xn(new ki.P(0,1,0),xi.Wo.Green().scale(.5),t,this,e),this.zGizmo=new Xn(new ki.P(0,0,1),xi.Wo.Blue().scale(.5),t,this,e),b()(s=[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo]).call(s,(t=>{t.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),t.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,this.attachedNode=null,i?i.addToAxisCache(this._gizmoAxisCache):si.t.GizmoAxisPointerObserver(t,this._gizmoAxisCache)}_createUniformScaleMesh(){var t;this._coloredMaterial=new Oi.K("",this.gizmoLayer.utilityLayerScene),this._coloredMaterial.diffuseColor=xi.Wo.Gray(),this._hoverMaterial=new Oi.K("",this.gizmoLayer.utilityLayerScene),this._hoverMaterial.diffuseColor=xi.Wo.Yellow(),this._disableMaterial=new Oi.K("",this.gizmoLayer.utilityLayerScene),this._disableMaterial.diffuseColor=xi.Wo.Gray(),this._disableMaterial.alpha=.4;const e=new Xn(new ki.P(0,1,0),xi.Wo.Gray().scale(.5),this.gizmoLayer,this);e.updateGizmoRotationToMatchAttachedMesh=!1,e.uniformScaling=!0,this._uniformScalingMesh=(0,ee.sh)("uniform",{type:1},e.gizmoLayer.utilityLayerScene),this._uniformScalingMesh.scaling.scaleInPlace(.01),this._uniformScalingMesh.visibility=0,this._octahedron=(0,ee.sh)("",{type:1},e.gizmoLayer.utilityLayerScene),this._octahedron.scaling.scaleInPlace(.007),this._uniformScalingMesh.addChild(this._octahedron),e.setCustomMesh(this._uniformScalingMesh,!0);const i=this.gizmoLayer._getSharedGizmoLight();i.includedOnlyMeshes=_s()(t=i.includedOnlyMeshes).call(t,this._octahedron);const s={gizmoMeshes:[this._octahedron,this._uniformScalingMesh],colliderMeshes:[this._uniformScalingMesh],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:e.dragBehavior};return this.addToAxisCache(e._rootMesh,s),e}set updateGizmoRotationToMatchAttachedMesh(t){var e;t?(this._updateGizmoRotationToMatchAttachedMesh=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo]).call(e,(e=>{e&&(e.updateGizmoRotationToMatchAttachedMesh=t)}))):console.warn("Setting updateGizmoRotationToMatchAttachedMesh = false on scaling gizmo is not supported.")}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set snapDistance(t){var e;this._snapDistance=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo]).call(e,(e=>{e&&(e.snapDistance=t)}))}get snapDistance(){return this._snapDistance}set scaleRatio(t){var e;this._scaleRatio=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo]).call(e,(e=>{e&&(e.scaleRatio=t)}))}get scaleRatio(){return this._scaleRatio}set sensitivity(t){var e;this._sensitivity=t,b()(e=[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo]).call(e,(e=>{e&&(e.sensitivity=t)}))}get sensitivity(){return this._sensitivity}addToAxisCache(t,e){this._gizmoAxisCache.set(t,e)}dispose(){var t,e,i,s;b()(t=[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo]).call(t,(t=>{t&&t.dispose()})),b()(e=this._observables).call(e,(t=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(t)})),this.onDragStartObservable.clear(),this.onDragEndObservable.clear(),b()(i=[this._uniformScalingMesh,this._octahedron]).call(i,(t=>{t&&t.dispose()})),b()(s=[this._coloredMaterial,this._hoverMaterial,this._disableMaterial]).call(s,(t=>{t&&t.dispose()}))}}class Qn{get keepDepthUtilityLayer(){return this._defaultKeepDepthUtilityLayer}get utilityLayer(){return this._defaultUtilityLayer}get isHovered(){let t=!1;for(const e in this.gizmos){const i=this.gizmos[e];if(i&&i.isHovered){t=!0;break}}return t}set scaleRatio(t){var e;this._scaleRatio=t,b()(e=[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo]).call(e,(e=>{e&&(e.scaleRatio=t)}))}get scaleRatio(){return this._scaleRatio}constructor(t,e=1,i=qi.x.DefaultUtilityLayer,s=qi.x.DefaultKeepDepthUtilityLayer){this._scene=t,this.gizmos=void 0,this.clearGizmoOnEmptyPointerEvent=!1,this.enableAutoPicking=!0,this.onAttachedToMeshObservable=new zi.y$,this.onAttachedToNodeObservable=new zi.y$,this._gizmosEnabled={positionGizmo:!1,rotationGizmo:!1,scaleGizmo:!1,boundingBoxGizmo:!1},this._pointerObservers=[],this._attachedMesh=null,this._attachedNode=null,this._attachedNodes=null,this._boundingBoxColor=xi.Wo.FromHexString("#0984e3"),this._defaultUtilityLayer=void 0,this._defaultKeepDepthUtilityLayer=void 0,this._thickness=1,this._scaleRatio=1,this._gizmoAxisCache=new(U()),this.boundingBoxDragBehavior=new De.K,this.attachableMeshes=null,this.attachableNodes=null,this.usePointerToAttachGizmos=!0,this._defaultUtilityLayer=i,this._defaultKeepDepthUtilityLayer=s,this._defaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,this._thickness=e,this.gizmos={positionGizmo:null,rotationGizmo:null,scaleGizmo:null,boundingBoxGizmo:null};const a=this._attachToMeshPointerObserver(t),r=si.t.GizmoAxisPointerObserver(this._defaultUtilityLayer,this._gizmoAxisCache);this._pointerObservers=[a,r]}_attachToMeshPointerObserver(t){const e=t.onPointerObservable.add((t=>{if(this.usePointerToAttachGizmos&&t.type===Di.kD.POINTERDOWN)if(t.pickInfo&&t.pickInfo.pickedMesh){if(this.enableAutoPicking){let i=t.pickInfo.pickedMesh;if(null===this.attachableMeshes)for(;i&&null!==i.parent;)i=i.parent;else{var e;let t=!1;b()(e=this.attachableMeshes).call(e,(e=>{i&&(i===e||i.isDescendantOf(e))&&(i=e,t=!0)})),t||(i=null)}i instanceof Ti.x?this._attachedMesh!==i&&this.attachToMesh(i):this.clearGizmoOnEmptyPointerEvent&&this.attachToMesh(null)}}else this.clearGizmoOnEmptyPointerEvent&&this.attachToMesh(null)}));return e}attachToMesh(t){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=t,this._attachedNode=null;for(const e in this.gizmos){const i=this.gizmos[e];i&&this._gizmosEnabled[e]&&(i.attachedMesh=t)}this.boundingBoxGizmoEnabled&&this._attachedMesh&&this._attachedMesh.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToMeshObservable.notifyObservers(t)}attachToNode(t){var e;(this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedNodes)&&b()(e=this._attachedNodes).call(e,(t=>t.removeBehavior(this.boundingBoxDragBehavior)));this._attachedMesh=null,this._attachedNodes=null,this._attachedNode=t;for(const e in this.gizmos){const i=this.gizmos[e];i&&this._gizmosEnabled[e]&&(i.attachedNode=t)}this.boundingBoxGizmoEnabled&&this._attachedNode&&this._attachedNode.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToNodeObservable.notifyObservers(t)}attachToNodes(t){if(!t?.length)return this._attachedNodes=null,void this.attachToNode(null);if(1!==t?.length){var e;if(this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedNodes)b()(e=this._attachedNodes).call(e,(t=>t.removeBehavior(this.boundingBoxDragBehavior)));this._attachedMesh=null,this._attachedNode=null,this._attachedNodes=t;for(const e in this.gizmos){const i=this.gizmos[e];i&&this._gizmosEnabled[e]&&("attachedNodes"in i?i.attachedNodes=t:i.attachedNode=t[0])}this.boundingBoxGizmoEnabled&&this._attachedNode&&this._attachedNode.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToNodeObservable.notifyObservers(t)}else this.attachToNode(t[0])}set positionGizmoEnabled(t){t?(this.gizmos.positionGizmo||(this.gizmos.positionGizmo=new Kn(this._defaultUtilityLayer,this._thickness,this)),this._attachedNode?this.gizmos.positionGizmo.attachedNode=this._attachedNode:this._attachedNodes?this.gizmos.positionGizmo.attachedNodes=this._attachedNodes:this.gizmos.positionGizmo.attachedMesh=this._attachedMesh):this.gizmos.positionGizmo&&(this.gizmos.positionGizmo.attachedNode=null,this.gizmos.positionGizmo.attachedNodes=null),this._gizmosEnabled.positionGizmo=t}get positionGizmoEnabled(){return this._gizmosEnabled.positionGizmo}set rotationGizmoEnabled(t){t?(this.gizmos.rotationGizmo||(this.gizmos.rotationGizmo=new qn(this._defaultUtilityLayer,32,!1,this._thickness,this)),this._attachedNode?this.gizmos.rotationGizmo.attachedNode=this._attachedNode:this._attachedNodes?this.gizmos.rotationGizmo.attachedNodes=this._attachedNodes:this.gizmos.rotationGizmo.attachedMesh=this._attachedMesh):this.gizmos.rotationGizmo&&(this.gizmos.rotationGizmo.attachedNode=null,this.gizmos.rotationGizmo.attachedNodes=null),this._gizmosEnabled.rotationGizmo=t}get rotationGizmoEnabled(){return this._gizmosEnabled.rotationGizmo}set scaleGizmoEnabled(t){t?(this.gizmos.scaleGizmo=this.gizmos.scaleGizmo||new $n(this._defaultUtilityLayer,this._thickness,this),this._attachedNode?this.gizmos.scaleGizmo.attachedNode=this._attachedNode:this._attachedNodes?this.gizmos.scaleGizmo.attachedNodes=this._attachedNodes:this.gizmos.scaleGizmo.attachedMesh=this._attachedMesh):this.gizmos.scaleGizmo&&(this.gizmos.scaleGizmo.attachedNode=null,this.gizmos.scaleGizmo.attachedNodes=null),this._gizmosEnabled.scaleGizmo=t}get scaleGizmoEnabled(){return this._gizmosEnabled.scaleGizmo}set boundingBoxGizmoEnabled(t){t?(this.gizmos.boundingBoxGizmo=this.gizmos.boundingBoxGizmo||new Te.C(this._boundingBoxColor,this._defaultKeepDepthUtilityLayer),this._attachedMesh?this.gizmos.boundingBoxGizmo.attachedMesh=this._attachedMesh:this.gizmos.boundingBoxGizmo.attachedNode=this._attachedNode,this._attachedMesh?(this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh.addBehavior(this.boundingBoxDragBehavior)):this._attachedNode&&(this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode.addBehavior(this.boundingBoxDragBehavior))):this.gizmos.boundingBoxGizmo&&(this._attachedMesh?this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior):this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this.gizmos.boundingBoxGizmo.attachedNode=null),this._gizmosEnabled.boundingBoxGizmo=t}get boundingBoxGizmoEnabled(){return this._gizmosEnabled.boundingBoxGizmo}addToAxisCache(t){t.size>0&&b()(t).call(t,((t,e)=>{this._gizmoAxisCache.set(e,t)}))}dispose(){var t;b()(t=this._pointerObservers).call(t,(t=>{this._scene.onPointerObservable.remove(t)}));for(const t in this.gizmos){const e=this.gizmos[t];e&&e.dispose()}this._defaultKeepDepthUtilityLayer!==qi.x._DefaultKeepDepthUtilityLayer&&this._defaultKeepDepthUtilityLayer?.dispose(),this._defaultUtilityLayer!==qi.x._DefaultUtilityLayer&&this._defaultUtilityLayer?.dispose(),this.boundingBoxDragBehavior.detach(),this.onAttachedToMeshObservable.clear()}}class Jn{constructor(t){this._viewer=t,this._mode=Vs.Translate,this.gizmoManager=void 0,this.attachNodes=void 0,this.positionGizmo=void 0,this.rotationGizmo=void 0,this.scaleGizmo=void 0,this.gizmoManager=new Qn(this._viewer.Scene,1,t.utilLayer),this.positionGizmo=new Kn(t.utilLayer,1),this.positionGizmo.planarGizmoEnabled=!0,this.rotationGizmo=new qn(t.utilLayer),this.scaleGizmo=new $n(t.utilLayer,1),this.gizmoManager.gizmos.positionGizmo=this.positionGizmo,this.gizmoManager.gizmos.rotationGizmo=this.rotationGizmo,this.gizmoManager.gizmos.scaleGizmo=this.scaleGizmo,this.gizmoManager.usePointerToAttachGizmos=!1,this.Mode=this._mode,this._register()}get Mode(){return this._mode}set Mode(t){this._mode=t,this.gizmoManager.positionGizmoEnabled=!!(t&Vs.Translate),this.gizmoManager.rotationGizmoEnabled=!!(t&Vs.Rotate),this.gizmoManager.scaleGizmoEnabled=!!(t&Vs.Scale),this.gizmoManager.positionGizmoEnabled&&this.gizmoManager.scaleGizmoEnabled&&(this.gizmoManager.gizmos.positionGizmo.scaleRatio=1.5)}attachMeshs(t){this.detachMeshs(),0!==t.length&&(this.attachNodes=t,this.gizmoManager.attachToNodes([...t]))}detachMeshs(){this.attachNodes=null,this.gizmoManager.attachToNode(null)}_register(){const t=t=>{if(!t)return;const e=Ss(t?.[0]);e?.DB&&e.DB.HistoryManager.startCmd("\u5b9e\u4f53\u53d8\u6362");for(const e of t){if(!e){console.error("\u672a\u7ed1\u5b9a\u6709\u6548\u5b9e\u4f53");continue}Ss(e).Matrix=e._worldMatrix}e?.DB&&e.DB.HistoryManager.endCmd()};this.positionGizmo.onDragEndObservable.add((e=>{t(this.attachNodes)})),this.rotationGizmo.onDragEndObservable.add((e=>{t(this.attachNodes)})),this.scaleGizmo.onDragEndObservable.add((e=>{t(this.attachNodes)}))}}class to{constructor(t){this._viewer=t,this.keyeunm={keydown:Ri.OG.KEYDOWN,keyup:Ri.OG.KEYUP},this.keydownEvents=new(Q()),this.keyupEvents=new(Q()),this._ctrlKey=!1,this._shiftKey=!1,this._altKey=!1,this._register()}get IsCtrl(){return this._ctrlKey}get IsShift(){return this._shiftKey}get IsAlt(){return this._altKey}on(t,e){if(this.keyeunm[t]===Ri.OG.KEYDOWN)this.keydownEvents.add(e);else{if(this.keyeunm[t]!==Ri.OG.KEYUP)throw new TypeError("\u4e8b\u4ef6\u7c7b\u578b\u9519\u8bef");this.keyupEvents.add(e)}return()=>{this.off(t,e)}}off(t,e){this.keyeunm[t]===Ri.OG.KEYDOWN?this.keydownEvents.delete(e):this.keyeunm[t]===Ri.OG.KEYUP&&this.keyupEvents.delete(e)}removeAll(){this.keydownEvents.clear(),this.keyupEvents.clear()}_register(){this._viewer.Scene.onKeyboardObservable.add((t=>{if(t.type===Ri.OG.KEYDOWN){this._ctrlKey=t.event.ctrlKey,this._shiftKey=t.event.shiftKey,this._altKey=t.event.altKey;for(const e of this.keydownEvents)e(t.event)}else for(const e of this.keyupEvents)this._ctrlKey=t.event.ctrlKey,this._shiftKey=t.event.shiftKey,this._altKey=t.event.altKey,e(t.event);Mr.trigger({type:["keydown","keyup"][t.type-1],event:t.event,target:null})}))}}class eo{constructor(t){this._viewer=t,this._pointerdownEvs=new(Q()),this._pointermoveEvs=new(Q()),this._pointerupEvs=new(Q()),this._pointerwheelEvs=new(Q()),this._pointerPickEvs=new(Q()),this._pointerTapEvs=new(Q()),this._pointerDbTapEvs=new(Q()),this._register()}get Scene(){return this._viewer.Scene}get ScreenPoint(){return{x:this.Scene.pointerX,y:this.Scene.pointerY}}get WorldPoint(){this._viewer.ground&&(this._viewer.ground.isPickable=!0);const t=this.Scene.pick(this.Scene.pointerX,this.Scene.pointerY,(t=>"WORLD_GROUND"===t.name));return this._viewer.ground&&(this._viewer.ground.isPickable=!1),t.hit?t.pickedPoint:null}getCurrentEntity(t,e){const i=this.ScreenPoint,s=this.Scene.pick(t??i.x,e??i.y);if(s?.hit&&s?.pickedMesh){return{entity:Ss(Ms(s.pickedMesh)),pickMesh:s.pickedMesh}}return null}on(t,e){switch(Di.kD[t.toUpperCase()]){case Di.kD.POINTERDOWN:this._pointerdownEvs.add(e);break;case Di.kD.POINTERMOVE:this._pointermoveEvs.add(e);break;case Di.kD.POINTERUP:this._pointerupEvs.add(e);break;case Di.kD.POINTERWHEEL:this._pointerwheelEvs.add(e);break;case Di.kD.POINTERPICK:this._pointerPickEvs.add(e);break;case Di.kD.POINTERTAP:this._pointerTapEvs.add(e);break;case Di.kD.POINTERDOUBLETAP:this._pointerDbTapEvs.add(e)}return()=>{this.off(t,e)}}off(t,e){if(!t)return;switch(Di.kD[t.toUpperCase()]){case Di.kD.POINTERDOWN:this._pointerdownEvs.delete(e);break;case Di.kD.POINTERMOVE:this._pointermoveEvs.delete(e);break;case Di.kD.POINTERUP:this._pointerupEvs.delete(e);break;case Di.kD.POINTERWHEEL:this._pointerwheelEvs.delete(e);break;case Di.kD.POINTERPICK:this._pointerPickEvs.delete(e);break;case Di.kD.POINTERTAP:this._pointerTapEvs.delete(e);break;case Di.kD.POINTERDOUBLETAP:this._pointerDbTapEvs.delete(e)}}getEvent(t){let e,i,s;return t.pickInfo?.hit&&t.pickInfo?.pickedMesh&&(e=Ms(t.pickInfo.pickedMesh),i=Ss(e),s=t.pickInfo.pickedMesh),{type:js[t.type],screenX:this.Scene.pointerX,screenY:this.Scene.pointerY,worldPoint:this.WorldPoint,target:i,object:e,event:t.event,pickedMesh:s,pickInfo:t.pickInfo}}_register(){this._viewer.Scene.onPointerObservable.add((t=>{const e=this.getEvent(t);let i;switch(e.target&&e.target.trigger(e),t.type){case Di.kD.POINTERDOWN:i=this._pointerdownEvs;break;case Di.kD.POINTERUP:i=this._pointerupEvs;break;case Di.kD.POINTERMOVE:i=this._pointermoveEvs;break;case Di.kD.POINTERWHEEL:i=this._pointerwheelEvs;break;case Di.kD.POINTERPICK:i=this._pointerPickEvs;break;case Di.kD.POINTERTAP:i=this._pointerTapEvs;break;case Di.kD.POINTERDOUBLETAP:i=this._pointerDbTapEvs}b()(i).call(i,(t=>t(e))),Mr.trigger(e)}))}}const io="_isProxy",so=(t,e,i,s=!1)=>{O()(t,e,{set:function(t){if(t instanceof Array)if(this[i]){let e=this[i];e.length=0,e.push(...t)}else t[io]?this[i]=t:this[i]=new Proxy(t,{set:(t,e,i,a)=>{Fr()(t,e,a)!==i&&this.writeSnapshoot();const r=jr()(t,e,i,a);return s&&this.update(),r},get:(t,e,i)=>e===io||("splice"!==e&&"pop"!==e&&"shift"!==e||this.writeSnapshoot(),Fr()(t,e,i))});else{this[i]!==t&&(this.writeSnapshoot(),this[i]=t,s&&this.update())}},get:function(){return this[i]},enumerable:!0,configurable:!0})};function ao(t,e,i){so(t,e,"__"+e,!0)}function ro(t,e,i){so(t,e,"__"+e,!1)}var no,oo;function ho(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}let lo=Y((oo=class extends Er{constructor(){super(),this.data={},this.entitys=void 0,this.initData(),this.entitys=this.initComponents()}getData(){return{}}get Schema(){return this.constructor.Schema}get IsComponent(){return!0}get AnimationNames(){const t=super.AnimationNames;for(const e of this.entitys)t.push(...e.AnimationNames);return t}get BoundingBox(){const{min:t,max:e}=this.BoundingVectors;return new ra(t,e)}startAnimates(t,e){super.startAnimates(t,e);for(const i of this.entitys)i.startAnimates(t,e)}stopAnimates(t){super.stopAnimates(t);for(const e of this.entitys)e.stopAnimates(t)}initData(t){const e=this;this.data=new Proxy(t??this.getData(),{get:(t,e)=>t[e],set(t,i,s){let a=t.hasOwnProperty(i)&&s!==t[i];return e.writeSnapshoot(),t[i]=s,a&&(e.play(),e.update(),e.trigger({type:"change",target:this,key:i})),!0}})}initComponents(){return[]}initDrawObject(t){const e=new Ki.Kj(this.UniqueName,Er.Scene);return this.updateDrawObject(t,e),this.watchLoad().then((t=>{this.play(),this.mounted()})).catch((t=>{console.error("err: ",t),this.componentCatch(t)})).finally((()=>{this.trigger2({type:ys.Load,target:this})})),e}updateDrawObject(t,e){for(let i of this.entitys){i.isPart=!0;let s=i.GetDrawObjectFromRenderType(t);s&&(i.updatePart(),s.parent=e)}}updateMaterial(){var t;b()(t=this.entitys).call(t,(t=>t.updateMaterial()))}play(){}mounted(){}componentCatch(t){}destory(){super.destory();for(const t of this.entitys)t.destory()}writeFile(t){super.writeFile(t),t.write(1),t.write(j()(function(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=ho(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=ho(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}({},this.data))),t.write(this.entitys.length);for(const e of this.entitys)t.writeObject(e)}readFile(t){super.readFile(t),t.read();const e=t.read();this.initData(JSON.parse(e));const i=t.read();for(const t of this.entitys)t.destory();this.entitys.length=0;for(let e=0;e<i;e++){const e=t.readObject();this.entitys.push(e)}this.update(),this.watchLoad().then((t=>{this.play()}))}watchLoad(){const t=[];for(const e of this.entitys)e.isAsync&&t.push(new(N())((t=>{e.on("load",(()=>t(!0)))})));return N().all(t)}getReady(){return this.watchLoad()}},oo.type="Component",oo.component=!0,oo.Schema=void 0,no=oo))||no;function co(t){K.RegisterComponent(t)}function uo(t){K.RemoveComponent(t)}X.prototype.writeWidgetValue=function(t){this.write(t?.type),"entity"===t?.type?this.writeObjectId(t?.value):this.write(t?.value),this.write(t?.entityKey)},X.prototype.readWidgetValue=function(t){t.type=this.read(),"entity"===t.type?t.value=this.readObjectId():t.value=this.read(),t.entityKey=this.read()};class po{constructor(){this.IsContainer=!1,this.startTime=0}get Type(){return this.constructor.type}do(){return null}destory(){}fromJSON(t){}readFile(t){}writeFile(t){}}function mo(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}function go(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=mo(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=mo(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}po.schema={};class _o{constructor(t){this.editor=t,this.isReady=!1,this.resolve=void 0,this.cleaners=[],this.auxiliaryLine=void 0,this.option=void 0,this._UpdatePoint=void 0}async start(t){var e;if(this.editor.Status!==In.GetPoint)return this.option=t,this.isReady=!0,this.editor.Status=In.GetPoint,this.editor.focus(),this._UpdatePoint=t?.getPointCallback,this.initAuxiliaryLine(),this.initMouseEvent(),this.initKeyDownEvent(),Mr.trigger({type:ys.ServiceStatus,msg:this.option?.msg??"\u8bf7\u9009\u62e9\u70b9",keywords:_s()(e=this.option?.keywordList??[]).call(e,[{label:"\u9000\u51fa",key:"ESC"}])}),new(N())((t=>{this.resolve=t}))}do(t){return t.event.button===Xs.Left&&this.returnPoint({worldPoint:t.worldPoint,screenPoint:{x:t.screenX,y:t.screenY},pickInfo:t.pickInfo,entity:t.target}),!0}returnPoint(t){this.resolve&&(this.resolve(go({status:Rn.Ok},t)),this.reset())}returnKeyWord(t){this.resolve&&(this.resolve(go({status:Rn.KeyWord},t)),this.reset())}cancel(){this.resolve&&(this.resolve({status:Rn.Cancel}),this.reset())}initAuxiliaryLine(){this.option?.hasAuxiliaryLine&&this.option?.basePoint&&(this.auxiliaryLine||(this.auxiliaryLine=Yi.V.CreateDashedLines("auxiliaryLine",{points:[new ki.P,new ki.P(1)],updatable:!0,dashSize:1e3,gapSize:800,dashNb:50},zr.MainScene),this.auxiliaryLine.color=xi.Wo.Green()),this.auxiliaryLine.setEnabled(!0))}updateAuxiliaryLine(t){this.auxiliaryLine?.isEnabled?.()&&Yi.V.CreateDashedLines(null,{points:[rr(this.option.basePoint),rr(t)],updatable:!0,instance:this.auxiliaryLine})}reset(){var t;this.isReady=!1,this.editor.Status&=~In.GetPoint,this.resolve=null,this._UpdatePoint=null,b()(t=this.cleaners).call(t,(t=>t())),this.option=null,this.cleaners.length=0,Mr.trigger({type:ys.ServiceStatus}),this.auxiliaryLine&&this.auxiliaryLine.setEnabled(!1)}initMouseEvent(){this.cleaners.push(this.editor.mouseCtrl.on("pointermove",(t=>{this.updateAuxiliaryLine(t.worldPoint),this._UpdatePoint?.(t.worldPoint)})))}initKeyDownEvent(){this.option?.keywordList?.length&&this.cleaners.push(this.editor.keyboardCtrl.on("keydown",(t=>{for(const e of this.option.keywordList)if(e.key.toUpperCase()===t.key.toUpperCase())return void this.returnKeyWord({key:e.key})})))}}class wo{constructor(){this._pcsList=new(U()),this.color=new xi.HE(0,122/255,.8,1)}intersect(t){const e=t.direction,i=t.origin,s=[];for(const[t,a]of this._pcsList)for(let r=0;r<a.particles.length;r++){const n=a.particles[r].position.subtract(i),o=ki.P.Dot(n.normalize(),e);if(Ps(o,0,.001)||Ps(o,1,.001)){s.push([t,r]);break}}return s}append(t){if(this._pcsList.has(t))return;const e=t.getDragPoints();if(0===e.length)return;const i=new We.B("pac"+t.Id,12,zr.MainScene);this._pcsList.set(t,i),i.addPoints(e.length,((t,i)=>{t.position=e[i],t.color=this.color})),i.buildMeshAsync()}update(){for(const[t,e]of this._pcsList){const i=t.getDragPoints();if(0===i.length)return;e.mesh.setEnabled(!0);for(let t=0;t<e.particles.length;t++)e.particles[t].position.copyFrom(i[t]);e.setParticles()}}hide(){for(const[t,e]of this._pcsList)e.mesh.setEnabled(!1)}clear(){for(let[t,e]of this._pcsList)e.dispose(),this._pcsList.delete(t),t=null;this._pcsList.clear()}}class yo{constructor(t){this._editor=t,this.isReady=!1,this.manager=new wo,this.startPoint=new ki.P,this.cleaner=[],this._dragList=[],this.move=t=>{this.manager.hide();const e=rr(t.worldPoint),i=e.subtract(this.startPoint);this.startPoint.copyFrom(e);for(const[t,e]of this._dragList)t.moveDragPoint(i,e)},this.moveEnd=()=>{this.manager.update(),this.unRegister(),this._editor.Status=In.None,this._dragList.length=0}}attach(t){if(t?.length){this.isReady=!0;for(const e of t)this.manager.append(e)}else this.cancel()}do(t){const e=this.manager.intersect(t.pickInfo.ray);return 0!==e.length&&(this._editor.Status=In.Drag,this.register(),this.startPoint.copyFrom(rr(t.worldPoint)),this._dragList.push(...e),!0)}update(){this.manager.update()}cancel(){this.isReady=!1,this.manager.clear(),this.unRegister(),this._dragList.length=0}register(){this.cleaner.push(this._editor.mouseCtrl.on("pointerMove",this.move),this._editor.mouseCtrl.on("pointerUp",this.moveEnd))}unRegister(){var t;b()(t=this.cleaner).call(t,(t=>t())),this.cleaner.length=0}}class bo{constructor(t,e=!1){this._viewer=t,this.editorMode=e,this.selectControl=void 0,this.transformControl=void 0,this.keyboardCtrl=void 0,this.mouseCtrl=void 0,this.dragCtrlService=void 0,this.getPointService=void 0,this.status=In.None,this.services=[],this.onTransfromDragStart=()=>{this.dragCtrlService.manager.hide()},this.onTransfromDragEnd=()=>{this.dragCtrlService.manager.update()},this.onKeyDownCtrl=t=>{if(t.code===Qs.Escape)for(const t of this.services)t.cancel()},this.onSelect=t=>{var e;"select"===t.type&&(this.transformControl.attachMeshs(t.meshs),this.dragCtrlService.attach(g()(e=t.entitys).call(e,(t=>t instanceof Er))))},this.onPointerDown=async t=>{for(const e of this.services)if(e.isReady){if(await e.do(t))break}},this.keyboardCtrl=new to(t),this.mouseCtrl=new eo(t),this.getPointService=new _o(this),e&&this.initEditor(),this.services.push(this.getPointService,this.dragCtrlService,this.selectControl)}get Status(){return this.status}set Status(t){switch(this.status=t,t){case In.GetPoint:this._viewer.setCursor("progress");break;case In.Select:this._viewer.setCursor("crosshair");break;case In.Drag:this._viewer.setCursor("pointer");break;default:this._viewer.setCursor("default")}}initEditor(){this._viewer.initEditor(),this.selectControl=new Vn(this._viewer,this),this.transformControl=new Jn(this._viewer),this.dragCtrlService=new yo(this),this._register()}getPoint(t){return this.getPointService.start(t)}focus(){this._viewer.focus()}_register(){this.selectControl.on(this.onSelect),this.mouseCtrl.on("pointerDown",this.onPointerDown),this.keyboardCtrl.on("keydown",this.onKeyDownCtrl),this.transformControl.positionGizmo.onDragStartObservable.add(this.onTransfromDragStart),this.transformControl.positionGizmo.onDragEndObservable.add(this.onTransfromDragEnd),this.transformControl.rotationGizmo.onDragStartObservable.add(this.onTransfromDragStart),this.transformControl.rotationGizmo.onDragEndObservable.add(this.onTransfromDragEnd),this.transformControl.scaleGizmo.onDragStartObservable.add(this.onTransfromDragStart),this.transformControl.scaleGizmo.onDragEndObservable.add(this.onTransfromDragEnd)}}const fo=1e7,vo=1e3,xo=.25*Math.PI,So=.45*Math.PI,Mo=1e5;class Oo{constructor(t){this._highlightLayer=void 0,this._color=xi.Wo.White(),this._highlightLayer=new Ii.H("select-entity",t.Scene),this._highlightLayer.innerGlow=!1}exclude(t){this._highlightLayer.addExcludedMesh(t)}addMeshs(t,e){for(const i of t){const t=i.getChildMeshes();b()(t).call(t,(t=>this._highlightLayer.addMesh(t,e??this._color)))}}addEnitys(t,e){for(const i of t)this.addMeshs([i.DrawObject],e)}clear(){this._highlightLayer.removeAllMeshes()}}class Po{constructor(t){this._attachedCamera=t,this._radiusScale=1,this._positionScale=.5}zoomOnBoundingInfo(t,e,i=!1,s=null){let a;if(!this._attachedCamera)return;const r=t.y,n=r+(e.y-r)*this._positionScale,o=e.subtract(t).scale(.5),h=t.add(o);a=new ki.P(h.x,n,h.z),this._attachedCamera.target=a;const l=this._calculateLowerRadiusFromModelBoundingSphere(t,e);this._attachedCamera.position=a.add(new ki.P(0,0,l))}_calculateLowerRadiusFromModelBoundingSphere(t,e){const i=e.subtract(t).length(),s=this._getFrustumSlope(),a=.5*i*this._radiusScale,r=a*Math.sqrt(1+1/(s.x*s.x)),n=a*Math.sqrt(1+1/(s.y*s.y));let o=Math.max(r,n);return this._attachedCamera?o:0}_getFrustumSlope(){const t=this._attachedCamera;if(!t)return ki.FM.Zero();const e=t.getScene().getEngine().getAspectRatio(t),i=Math.tan(t.fov/2),s=i*e;return new ki.FM(s,i)}}class Co{constructor(t,e){this._scene=t,this._canvas=e,this._enable=Ns.All,this._camera=void 0,this._position=new ki.P(0,0,10),this._target=ki.P.Zero(),this._mode=Zi.V.PERSPECTIVE_CAMERA,this.wheelSpeed=20,this.wheelDeltaPercentage=.05,this._flying=!1,this.size=vo,this.customWheel=void 0,this._pointerInput=void 0,this._animateGroup=void 0,this.customFramingBehavior=void 0,this.onRadiusChangeObserver=new zi.y$,this.onZommScaleChangeObserver=new zi.y$,this.zoomScale=1}get CurrentCamera(){return this._camera}get Position(){return{x:this._position.x,y:this._position.y,z:this._position.z}}set Position(t){nr(this._position,t)}get Target(){return this._target}set Target(t){nr(this._target,t)}get Alpha(){return 0}set Alpha(t){}get Beta(){return 0}set Beta(t){}get Radius(){return ki.P.Distance(this._target,this._position)}set Radius(t){const e=this._position.subtract(this._target).normalize().scale(t);this._position=this._position.add(e),this._camera.position.copyFrom(this._position)}get Aspect(){return this._canvas.width/this._canvas.height}get Enable(){return this._enable!==Ns.None}set Enable(t){this._enable=t?Ns.All:Ns.None}get EnableZoom(){return!!(this._enable&Ns.Zoom)}set EnableZoom(t){t!==this.EnableZoom&&(t?this._enable|=Ns.Zoom:this._enable&=~Ns.Zoom,this._mode===Zi.V.PERSPECTIVE_CAMERA&&(t?this._camera.inputs.attached.mousewheel.attachControl():this._camera.inputs.attached.mousewheel.detachControl()))}get Mode(){return this._mode}set Mode(t){this._mode=t}set Size(t){t&&(this.size=t,this._camera.orthoTop=this.size*this.zoomScale,this._camera.orthoBottom=-this.size*this.zoomScale,this._camera.orthoLeft=-this.size*this.zoomScale*this.Aspect,this._camera.orthoRight=this.size*this.zoomScale*this.Aspect)}active(){this._scene.activeCamera=this._camera,this.attachControl()}attachControl(){}detachControl(){this._camera.detachControl()}zoomByBoundBox(t,e,i=!1){const s=this._camera,a=s.getBehaviorByName("Framing");a?(a.framingTime=10,a.elevationReturnTime=-1,a.autoCorrectCameraLimitsAndSensibility=i,a.zoomOnBoundingInfo(t,e,!1,(()=>{i&&"radius"in s&&(s.minZ=.01*s.radius)}))):(this.customFramingBehavior||(this.customFramingBehavior=new Po(this._camera)),this.customFramingBehavior.zoomOnBoundingInfo(t,e))}zoomAll(t=!1){var e;const i=t=>t.isVisible&&t.isEnabled()&&"WORLD_GROUND"!==t.name&&!t.getBoundingInfo().boundingBox.extendSize.equalsWithEpsilon(ki.P.Zero());if(g()(e=this._scene.meshes).call(e,i).length){const e=this._scene.getWorldExtends(i),{max:s,min:a}=e;if(s.equalsWithEpsilon(a,.001))return;this.zoomByBoundBox(a,s,t)}}zoomToEntity(t){const{extendSize:e,minimumWorld:i,maximumWorld:s}=t.BoundingBox;e.equalsWithEpsilon(ki.P.Zero())||this.zoomByBoundBox(i,s)}initOrthCamera(){this.updateOrthCamera(),this._camera.inputs.attached.mousewheel.detachControl(),this.customWheel=this._scene.onPointerObservable.add((t=>{if(!this.EnableZoom)return;const e=t.event;let i=0;i=e.wheelDelta?-e.wheelDelta:60*-(e.deltaY||e.detail),this.zoomScale+=i/(100*this.wheelSpeed),this.zoomScale<0?this.zoomScale=.001:(this.updateOrthCamera(),this.onZommScaleChangeObserver.notifyObservers(this.zoomScale))}),Di.kD.POINTERWHEEL)}updateOrthCamera(){this._camera.orthoTop=this.Radius*this.zoomScale,this._camera.orthoBottom=-this.Radius*this.zoomScale,this._camera.orthoLeft=-this.Radius*this.zoomScale*this.Aspect,this._camera.orthoRight=this.Radius*this.zoomScale*this.Aspect,this._camera.metadata={zoomScale:this.zoomScale,size:this.Radius*this.zoomScale}}flyTo(t){this._animateGroup&&(this._animateGroup.dispose(),this._animateGroup=null);let{target:e,position:i,time:s=1,complete:a,loop:r=!1}=t;if(!e)return void console.error("\u5fc5\u987b\u4f20\u5165\u76ee\u6807\u70b9");const n=e instanceof Er?e.Position:rr(e),o=new Xi.O("camera-fly-group"),h=new Gi.f("camera-fly-target","target",30,Gi.f.ANIMATIONTYPE_VECTOR3);if(h.setKeys([{frame:0,value:this._camera.target.clone()},{frame:30*s,value:n}]),o.addTargetedAnimation(h,this._camera),i){const t=new Gi.f("camera-fly-position","position",30,Gi.f.ANIMATIONTYPE_VECTOR3),e=[{frame:0,value:this._camera.position.clone()},{frame:30*s,value:rr(i)}];t.setKeys(e),o.addTargetedAnimation(t,this._camera)}return o.normalize(0,100),o.play(r),o.onAnimationGroupPlayObservable.add((()=>{this._flying=!0})),o.onAnimationEndObservable.add((()=>{a?.(),this._flying=!1})),this._animateGroup=o,{clear:()=>{o.dispose(),this._animateGroup=null},stop:()=>o.stop(),pause:()=>o.pause(),reset:()=>o.reset(),restart:()=>o.restart()}}moveTo(t){return null}moveByPath(t){}destory(){this._camera&&this._camera.dispose()}writeFile(t){t.write(2),t.write(this._target.x),t.write(this._target.y),t.write(this._target.z),t.write(this.zoomScale),t.write(this.size),t.write(this._mode),t.write(this._enable)}readFile(t){const e=t.read();this._target.x=t.read(),this._target.y=t.read(),this._target.z=t.read(),this.zoomScale=t.read(),this.size=t.read(),this._mode=t.read(),e>1&&(this._enable=t.read())}}var Ao=i(98174),Eo=i.n(Ao);class zo extends ae.H{constructor(...t){super(...t),this.panningSensibility=1e3,this._button=-1,this.twoFingerActivityCount=0,this.isPinching=!1,this.enablePan=!1,this.enableRotate=!0,this.panPercentage=.1,this.useTouchForRotating=!1,this.useNaturalPan=!0,this.pinchToPanMaxDistance=125}getPanSpeedPercent(){return this.camera.mode===Zi.V.PERSPECTIVE_CAMERA?1e3/(this.panPercentage*this.camera.radius):500*this.panPercentage}onButtonDown(t){this._button=t.button}onTouch(t,e,i){0!==this.panningSensibility&&(this._ctrlKey||this._altKey)&&1===this._button?this.pan(e,i):(1===this._button||this.useTouchForRotating&&"touch"===t.type)&&this.rotate(e,i)}onMultiTouch(t,e,i,s,a,r){0===i&&null===a||0===s&&null===r||(this.multiTouchPanAndZoom?(this.computePinchZoom(i,s),this.computeMultiTouchPanning(a,r)):this.multiTouchPanning&&this.pinchZoom?(this.twoFingerActivityCount++,1===this.twoFingerActivityCount&&(this.isPinching=this.getDistanceBetweenFingers(t,e)>=this.pinchToPanMaxDistance),this.isPinching?(this.computePinchZoom(i,s),this.isPinching=!0):this.computeMultiTouchPanning(a,r)):this.multiTouchPanning?this.computeMultiTouchPanning(a,r):this.pinchZoom&&this.computePinchZoom(i,s))}onButtonUp(){super.onButtonUp(),this.twoFingerActivityCount=0,this.isPinching=!1}onLostFocus(){super.onLostFocus(),this.twoFingerActivityCount=0,this.isPinching=!1}pan(t,e){if(!this.enablePan)return;const i=this.getPanSpeedPercent();this.camera.inertialPanningX+=-t/i,this.camera.inertialPanningY+=e/i}rotate(t,e){this.enableRotate&&(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=e/this.angularSensibilityY)}computeMultiTouchPanning(t,e){if(0!==this.panningSensibility&&t&&e){const i=e.x-t.x,s=e.y-t.y;if(this.useNaturalPan){const t=Math.max(this.camera.radius,-Eo());this.camera.inertialPanningX+=-i*t/1750,this.camera.inertialPanningY+=s*t/1750}else this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=s/this.panningSensibility}}computePinchZoom(t,e){const i=this.camera.radius||ae.H.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(t)/Math.sqrt(e):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=.001*(e-t)*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(e-t)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}getDistanceBetweenFingers(t,e){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)}}var Do=i(49671),To=i(48154);function Ro(t){const e=t.wheelDeltaX,i=t.wheelDeltaY,s=e=>null!=e&&0!==e&&e/t.deltaX==-3&&e%120!=0;return!!s(e)||!!s(i)}class Io extends re.F{get angularSpeed(){return this._isRotationEnabled?this._angularSpeed:0}set angularSpeed(t){this._angularSpeed=t}get panningSensibility(){return this._isPanningEnabled?this._panningSensibility:Eo()}set panningSensibility(t){this._panningSensibility=t}constructor(t=!1){super(),this.useMousewheelName=t,this._panningSensibility=50,this._angularSpeed=.01,this._isPanningEnabled=!0,this._isRotationEnabled=!0,this.wheel=void 0,this.observer=void 0,this.hitPlane=void 0,this.verticalAngularSpeedRatio=.5,this.panningX=0,this.alphaDelta=0,this.panningY=0,this.betaDelta=0,this.inertialPanning=ki.P.Zero()}enablePanning(t=!0){this._isPanningEnabled=t}disablePanning(){this._isPanningEnabled=!1}enableRotation(t=!0){this._isRotationEnabled=t}disableRotation(){this._isRotationEnabled=!1}attachControl(t){t=Wt.w1.BackCompatCameraNoPreventDefault(arguments),this.wheel=e=>{if(e.type!==Di.kD.POINTERWHEEL)return;const i=e.event;if(i.ctrlKey&&i.preventDefault(),Ro(i)){i.preventDefault();const t=ja()(i.deltaX),e=ja()(i.deltaY);return void(i.altKey?(this.panningX+=t/this.panningSensibility,this.panningY+=-e/this.panningSensibility):(this.alphaDelta+=t*this.angularSpeed,this.betaDelta+=e*this.angularSpeed*this.verticalAngularSpeedRatio))}let s=0;const a=i.deltaMode===Do.G.DOM_DELTA_LINE?40:1,r=-i.deltaY*a;if(this.customComputeDeltaFromMouseWheel)s=this.customComputeDeltaFromMouseWheel(r,this,i);else if(this.wheelDeltaPercentage){if(s=this._computeDeltaFromMouseWheelLegacyEvent(r,this.camera.radius),s>0){let t=this.camera.radius,e=this.camera.inertialRadiusOffset+s;for(let i=0;i<20&&Math.abs(e)>.001;i++)t-=e,e*=this.camera.inertia;t=ne.R.Clamp(t,0,Number.MAX_VALUE),s=this._computeDeltaFromMouseWheelLegacyEvent(r,t)}}else s=r/(40*this.wheelPrecision);s&&(this.zoomToMouseLocation&&this.hitPlane?this.zoomToMouse(s):this.camera.inertialRadiusOffset+=s),i.preventDefault&&(t||i.preventDefault())},this.observer=this.camera.getScene().onPointerObservable.add(this.wheel,Di.kD.POINTERWHEEL),this.zoomToMouseLocation&&this.inertialPanning.setAll(0)}detachControl(){this.observer&&(this.camera.getScene().onPointerObservable.remove(this.observer),this.observer=null,this.wheel=null)}checkInputs(){const t=this.camera;if(t.inertialAlphaOffset+=this.alphaDelta,t.inertialBetaOffset+=this.betaDelta,t.inertialPanningX+=this.panningX,t.inertialPanningY+=this.panningY,this.alphaDelta=0,this.betaDelta=0,this.panningX=0,this.panningY=0,!this.zoomToMouseLocation)return;0+t.inertialAlphaOffset+t.inertialBetaOffset+t.inertialRadiusOffset&&(this.updateHitPlane(),t.target.addInPlace(this.inertialPanning),this.inertialPanning.scaleInPlace(t.inertia),this.zeroIfClose(this.inertialPanning))}getClassName(){return this.useMousewheelName?super.getClassName():"ArcRotateCameraTrackpadInput"}getSimpleName(){return this.useMousewheelName?super.getSimpleName():"trackpad"}updateHitPlane(){const t=this.camera,e=t.target.subtract(t.position);this.hitPlane=Si.J.FromPositionAndNormal(t.target,e)}getPosition(){const t=this.camera,e=t.getScene(),i=e.createPickingRay(e.pointerX,e.pointerY,ki.y3.Identity(),t,!1);let s=0;return this.hitPlane&&(s=i.intersectsPlane(this.hitPlane)??0),i.origin.addInPlace(i.direction.scaleInPlace(s))}zoomToMouse(t){const e=this.camera,i=1-e.inertia;if(e.lowerRadiusLimit){const s=e.lowerRadiusLimit??0;e.radius-(e.inertialRadiusOffset+t)/i<s&&(t=(e.radius-s)*i-e.inertialRadiusOffset)}if(e.upperRadiusLimit){const s=e.upperRadiusLimit??0;e.radius-(e.inertialRadiusOffset+t)/i>s&&(t=(e.radius-s)*i-e.inertialRadiusOffset)}const s=t/i/e.radius,a=this.getPosition(),r=ki.jp.Vector3[6];a.subtractToRef(e.target,r),r.scaleInPlace(s),r.scaleInPlace(i),this.inertialPanning.addInPlace(r),e.inertialRadiusOffset+=t}zeroIfClose(t){Math.abs(t.x)<To.kn&&(t.x=0),Math.abs(t.y)<To.kn&&(t.y=0),Math.abs(t.z)<To.kn&&(t.z=0)}}var Lo,Fo=i(73321),ko=i(23402),jo=i(34389);!function(t){t[t.MoveRelative=0]="MoveRelative",t[t.RotateRelative=1]="RotateRelative",t[t.MoveScene=2]="MoveScene"}(Lo||(Lo={}));class Bo extends ko.Y{getClassName(){return this.useMousewheelName?"FreeCameraMouseWheelInput":"FreeCameraTrackpadInput"}getSimpleName(){return this.useMousewheelName?super.getSimpleName():"trackpad"}set wheelXMoveRelative(t){null===t&&this._wheelXAction!==Lo.MoveRelative||(this._wheelXAction=Lo.MoveRelative,this._wheelXActionCoordinate=t)}get wheelXMoveRelative(){return this._wheelXAction!==Lo.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(t){null===t&&this._wheelYAction!==Lo.MoveRelative||(this._wheelYAction=Lo.MoveRelative,this._wheelYActionCoordinate=t)}get wheelYMoveRelative(){return this._wheelYAction!==Lo.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(t){null===t&&this._wheelZAction!==Lo.MoveRelative||(this._wheelZAction=Lo.MoveRelative,this._wheelZActionCoordinate=t)}get wheelZMoveRelative(){return this._wheelZAction!==Lo.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(t){null===t&&this._wheelXAction!==Lo.RotateRelative||(this._wheelXAction=Lo.RotateRelative,this._wheelXActionCoordinate=t)}get wheelXRotateRelative(){return this._wheelXAction!==Lo.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(t){null===t&&this._wheelYAction!==Lo.RotateRelative||(this._wheelYAction=Lo.RotateRelative,this._wheelYActionCoordinate=t)}get wheelYRotateRelative(){return this._wheelYAction!==Lo.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(t){null===t&&this._wheelZAction!==Lo.RotateRelative||(this._wheelZAction=Lo.RotateRelative,this._wheelZActionCoordinate=t)}get wheelZRotateRelative(){return this._wheelZAction!==Lo.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(t){null===t&&this._wheelXAction!==Lo.MoveScene||(this._wheelXAction=Lo.MoveScene,this._wheelXActionCoordinate=t)}get wheelXMoveScene(){return this._wheelXAction!==Lo.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(t){null===t&&this._wheelYAction!==Lo.MoveScene||(this._wheelYAction=Lo.MoveScene,this._wheelYActionCoordinate=t)}get wheelYMoveScene(){return this._wheelYAction!==Lo.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(t){null===t&&this._wheelZAction!==Lo.MoveScene||(this._wheelZAction=Lo.MoveScene,this._wheelZActionCoordinate=t)}get wheelZMoveScene(){return this._wheelZAction!==Lo.MoveScene?null:this._wheelZActionCoordinate}constructor(t=!0){super(),this.useMousewheelName=t,this.camera=void 0,this.wheel=null,this.observer=null,this._moveRelative=jo.P.Zero(),this._rotateRelative=jo.P.Zero(),this._moveScene=jo.P.Zero(),this._wheelXAction=Lo.MoveRelative,this._wheelXActionCoordinate=jo.c7.X,this._wheelYAction=Lo.MoveRelative,this._wheelYActionCoordinate=jo.c7.Z,this._wheelZAction=null,this._wheelZActionCoordinate=null,this.ffMultiplier=12,this.normalize=120}attachControl(t){t=Wt.w1.BackCompatCameraNoPreventDefault(arguments),this.wheel=e=>{if(e.type!==Di.kD.POINTERWHEEL)return;const i=e.event;i.ctrlKey?(i.preventDefault(),this.wheelXMoveRelative=jo.c7.X,this.wheelYMoveRelative=jo.c7.Z):Ro(i)?(i.preventDefault(),this.wheelXRotateRelative=jo.c7.Y,this.wheelYRotateRelative=jo.c7.X):(this.wheelXMoveRelative=jo.c7.X,this.wheelYMoveRelative=jo.c7.Z);const s=i.deltaMode===Do.G.DOM_DELTA_LINE?this.ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*s*i.deltaX/this.normalize,this._wheelDeltaY-=this.wheelPrecisionY*s*i.deltaY/this.normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*s*i.deltaZ/this.normalize,i.preventDefault&&(t||i.preventDefault())},this.observer=this.camera.getScene().onPointerObservable.add(this.wheel,Di.kD.POINTERWHEEL)}detachControl(){this.observer&&(this.camera.getScene().onPointerObservable.remove(this.observer),this.observer=null,this.wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){if(0===this._wheelDeltaX&&0===this._wheelDeltaY&&0==this._wheelDeltaZ)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const t=jo.y3.Zero();this.camera.getViewMatrix().invertToRef(t);const e=jo.P.Zero();jo.P.TransformNormalToRef(this._moveRelative,t,e),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(e),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(t,e,i){if(0===t)return;if(null===e||null===i)return;let s=null;switch(e){case Lo.MoveRelative:s=this._moveRelative;break;case Lo.RotateRelative:s=this._rotateRelative;break;case Lo.MoveScene:s=this._moveScene}switch(i){case jo.c7.X:s.set(t,s.y,s.z);break;case jo.c7.Y:s.set(s.x,t,s.z);break;case jo.c7.Z:s.set(s.x,s.y,t)}}}Fo.u.FreeCameraTrackpadInput=Bo;class No extends Co{constructor(t,e){super(t,e),this._scene=t,this._canvas=e,this._camera=void 0,this._pointerInput=void 0,this._radius=120,this._alpha=xo,this._beta=So,this._lowerRadiusLimit=.01,this._upperRadiusLimit=void 0,this._lowerAlphaLimit=void 0,this._upperAlphaLimit=void 0,this._lowerBetaLimit=void 0,this._upperBetaLimit=void 0,this._panningAxis=new ki.P(1,1,0),this._originPanTarget=ki.P.Zero(),this._panDistance=null,this._minZ=1,this._maxZ=fo,this.onRadiusChangeObserver=new zi.y$,t&&e&&(this.init(),this._camera.onViewMatrixChangedObservable.add((t=>{this._alpha=t.alpha,this._beta=t.beta,this._target.copyFrom(t.target),t.radius!==this._radius&&this.onRadiusChangeObserver.notifyObservers(t),this._mode===Zi.V.PERSPECTIVE_CAMERA&&(this._radius=t.radius),Mr.trigger({type:"CameraUpdate",target:this})})))}get Alpha(){return this._alpha}set Alpha(t){this._alpha=t,this._camera.alpha=t}get Beta(){return this._beta}set Beta(t){this._beta=t,this._camera.beta=t}get Aspect(){return this._canvas.width/this._canvas.height}get EnablePan(){return!!(this._enable&Ns.Pan)}set EnablePan(t){t?this._enable|=Ns.Pan:this._enable&=~Ns.Pan,this._pointerInput.enablePan=t}get EnableRotate(){return!!(this._enable&Ns.Roate)}set EnableRotate(t){t?this._enable|=Ns.Roate:this._enable&=~Ns.Roate,this._pointerInput.enableRotate=t}get EnableZoom(){return!!(this._enable&Ns.Zoom)}set EnableZoom(t){t!==this.EnableZoom&&(t?this._enable|=Ns.Zoom:this._enable&=~Ns.Zoom,this._mode===Zi.V.PERSPECTIVE_CAMERA&&(t?this._camera.inputs.attached.mousewheel.attachControl():this._camera.inputs.attached.mousewheel.detachControl()))}get Radius(){return this._radius}set Radius(t){this._radius=t,this._camera.radius=t}get IsFlying(){return this._flying}get Position(){return{x:this._camera.position.x,y:this._camera.position.y,z:this._camera.position.z}}set Position(t){const e=new ki.P;nr(e,t),this._camera.setPosition(e),this._position.copyFrom(e)}get Target(){return{x:this._target.x,y:this._target.y,z:this._target.z}}set Target(t){nr(this._target,t),this._camera.setTarget(this._target)}get LowerRadiusLimit(){return this._lowerRadiusLimit}set LowerRadiusLimit(t){t!==this._lowerRadiusLimit&&(this._lowerRadiusLimit=t,this.update())}get UpperRadiusLimit(){return this._upperRadiusLimit}set UpperRadiusLimit(t){t!==this._upperRadiusLimit&&(this._upperRadiusLimit=t,this.update())}get LowerAlphaLimit(){return this._lowerAlphaLimit}set LowerAlphaLimit(t){t!==this._lowerAlphaLimit&&(this._lowerAlphaLimit=t,this.update())}get UpperAlphaLimit(){return this._upperAlphaLimit}set UpperAlphaLimit(t){t!==this._upperAlphaLimit&&(this._upperAlphaLimit=t,this.update())}get LowerBetaLimit(){return this._lowerBetaLimit}set LowerBetaLimit(t){t!==this._lowerBetaLimit&&(this._lowerBetaLimit=t,this.update())}get UpperBetaLimit(){return this._upperBetaLimit}set UpperBetaLimit(t){t!==this._upperBetaLimit&&(this._upperBetaLimit=t,this.update())}get PanningAxis(){return hr(this._panningAxis)}set PanningAxis(t){nr(this._panningAxis,t),this.update()}get OriginPanTarget(){return hr(this._originPanTarget)}set OriginPanTarget(t){nr(this._originPanTarget,t),this.update()}get PanDistance(){return this._panDistance}set PanDistance(t){t!==this._panDistance&&(this._panDistance=t,this.update())}get MinZ(){return this._minZ}set MinZ(t){t!==this._minZ&&(this._minZ=t,this.update())}get MaxZ(){return this._maxZ}set MaxZ(t){t!==this._maxZ&&(this._maxZ=t,this.update())}get UseNaturalPinchZoom(){return this._pointerInput.useNaturalPinchZoom}set UseNaturalPinchZoom(t){this._pointerInput.useNaturalPinchZoom=t}get UseTouchForRotating(){return this._pointerInput.useTouchForRotating}set UseTouchForRotating(t){this._pointerInput.useTouchForRotating=t}zoomTo(t,e){this._camera.setTarget(new ki.P(t.x,t.y)),this.Mode===Zi.V.ORTHOGRAPHIC_CAMERA?(this.zoomScale=1.2,this.Size=Math.max(...e.asArray())/2,this._camera.position=new ki.P(t.x,t.y,1)):(this._camera.alpha=0,this._camera.beta=0,this._camera.radius=Math.max(...e.asArray())*this.Aspect,this._camera.position=new ki.P(t.x,t.y,this._camera.radius))}zoomByBoundBox(t,e,i=!1){const s=this._camera;s.useFramingBehavior=!0,super.zoomByBoundBox(t,e,i),s.useFramingBehavior=!1,i||(s.lowerRadiusLimit=this._lowerRadiusLimit)}zoomAll(t=!1){var e;const i=t=>t.isVisible&&t.isEnabled()&&"WORLD_GROUND"!==t.name&&!t.getBoundingInfo().boundingBox.extendSize.equalsWithEpsilon(ki.P.Zero());if(g()(e=this._scene.meshes).call(e,i).length){const e=this._scene.getWorldExtends(i),{max:s,min:a}=e;if(s.equalsWithEpsilon(a,.001))return;this.zoomByBoundBox(a,s,t)}}init(){const t=new Vi.Y("MainArcRotateCamera",this._alpha,this._beta,this._radius,this._target,this._scene);this._camera=t,t.mode=this._mode,t.wheelPrecision=this.wheelSpeed,t.wheelDeltaPercentage=this.wheelDeltaPercentage,t.maxZ=this._maxZ,t.minZ=this._minZ,t.inertia=.5,t.panningInertia=.5,t.lowerRadiusLimit=this._lowerRadiusLimit,/Mobi|Android|iPhone/i.test(navigator.userAgent)?(this._pointerInput=t.inputs.attached.pointers,this._pointerInput.panningSensibility=1,this._pointerInput.pinchPrecision=.1,this._pointerInput.multiTouchPanAndZoom=!1):(this._pointerInput=new zo,this._pointerInput.multiTouchPanAndZoom=!1,t.inputs.removeByType("ArcRotateCameraPointersInput"),this._pointerInput.enableRotate=this.EnableRotate,this._pointerInput.enablePan=this.EnablePan,t.inputs.add(this._pointerInput),t.inputs.removeByType("ArcRotateCameraMouseWheelInput"),t.inputs.add(new Io(!0)));const e=t.inputs.attached.mousewheel;e&&(e.customComputeDeltaFromMouseWheel=(e,i,s)=>{if(!this.EnableZoom)return 0;let a=0;if(this.wheelDeltaPercentage&&!s.altKey){if(a=this._computeDeltaFromMouseWheelLegacyEvent(e,t.radius),a>0){let i=t.radius,s=t.inertialRadiusOffset+a;for(let e=0;e<20&&Math.abs(s)>.001;e++)i-=s,s*=t.inertia;i=ne.R.Clamp(i,0,Number.MAX_VALUE),a=this._computeDeltaFromMouseWheelLegacyEvent(e,i)}}else a=e/(40*t.wheelPrecision);return a}),this._mode===Zi.V.ORTHOGRAPHIC_CAMERA?this.initOrthCamera():this.initPerCamera()}set WheelSpeed(t){this._camera.wheelPrecision=this.wheelSpeed}get Mode(){return this._mode}set Mode(t){t!==Zi.V.ORTHOGRAPHIC_CAMERA&&t!==Zi.V.PERSPECTIVE_CAMERA||(this._mode=t,this._camera.mode=t,t===Zi.V.ORTHOGRAPHIC_CAMERA?(this._camera.radius=vo,this.initOrthCamera()):(this._camera.radius=this._radius,this.initPerCamera()))}set ViewMode(t){switch(t){case Gs.Up:this._camera.position=this._camera.target.clone().add(new ki.P(0,0,10));break;case Gs.Down:this._camera.position=this._camera.target.clone().add(new ki.P(0,0,-10));break;case Gs.Left:this._camera.position=this._camera.target.clone().add(new ki.P(-10));break;case Gs.Right:this._camera.position=this._camera.target.clone().add(new ki.P(10));break;case Gs.Front:this._camera.position=this._camera.target.clone().add(new ki.P(0,10));break;case Gs.Back:this._camera.position=this._camera.target.clone().add(new ki.P(0,-10));break;case Gs.SW:this._camera.position=this._camera.target.clone().add(new ki.P(10,10,10))}}initPerCamera(){this.customWheel&&(this._scene.onPointerObservable.remove(this.customWheel),this.customWheel=null,this.EnableZoom&&this._camera.inputs.attached.mousewheel.attachControl())}attachControl(){this._camera.attachControl(this._canvas,!0,!0)}detachControl(){this._camera.detachControl()}lookAt(t){this._camera.setTarget(rr(t))}rotateAround(t){const{target:e,angleX:i,angleY:s,frame:a=30,time:r=10,loop:n=!1}=t;if(!i&&!s)return void console.error("angleX\u548cangleY\u81f3\u5c11\u6709\u4e00\u4e2a\u5fc5\u586b");e&&this._camera.target.copyFrom(rr(e));const o=new Xi.O("camera-around-group");if(i){const t=new Gi.f("camera-around","alpha",a,Gi.f.ANIMATIONTYPE_FLOAT);this._camera.inertialAlphaOffset;t.setKeys([{frame:0,value:0},{frame:r/2*a,value:i/2},{frame:r*a,value:i}]),o.addTargetedAnimation(t,this._camera)}if(s){const t=new Gi.f("camera-around","beta",a,Gi.f.ANIMATIONTYPE_FLOAT);t.setKeys([{frame:0,value:0},{frame:r/2*a,value:s/2},{frame:r*a,value:s}]),o.addTargetedAnimation(t,this._camera)}return o.play(n),{clear:()=>{o.dispose(),this._animateGroup=null},stop:()=>o.stop(),pause:()=>o.pause(),reset:()=>o.reset(),restart:()=>o.restart()}}moveTo(t){let{alpha:e,beta:i,radius:s,target:a,time:r=1,entity:n}=t;if(void 0===e&&void 0===i&&void 0===s&&void 0===a)return;const o=new Xi.O("camera-move-to",this._scene),h=30;if(void 0!==e){const t=new Gi.f("alpha-a","alpha",h,Gi.f.ANIMATIONTYPE_FLOAT);t.setKeys([{frame:0,value:this._camera.alpha},{frame:r*h,value:e}]),o.addTargetedAnimation(t,this._camera)}if(void 0!==i){const t=new Gi.f("beta-a","beta",h,Gi.f.ANIMATIONTYPE_FLOAT);t.setKeys([{frame:0,value:this._camera.beta},{frame:r*h,value:i}]),o.addTargetedAnimation(t,this._camera)}if(void 0!==s){const t=new Gi.f("radius-a","radius",h,Gi.f.ANIMATIONTYPE_FLOAT);t.setKeys([{frame:0,value:this._camera.radius},{frame:r*h,value:s}]),o.addTargetedAnimation(t,this._camera)}if(!a&&n){const{extendSize:t,minimumWorld:e,maximumWorld:i}=n.BoundingBox;if(!t.equalsWithEpsilon(ki.P.Zero())){const t=e.y,s=t+.5*(i.y-t),r=i.subtract(e).scale(.5),n=e.add(r);a={x:n.x,y:s,z:n.z}}}if(void 0!==a){const t=new Gi.f("target-a","target",h,Gi.f.ANIMATIONTYPE_VECTOR3);t.setKeys([{frame:0,value:this._camera.target},{frame:r*h,value:rr(a)}]),o.addTargetedAnimation(t,this._camera)}return{start:()=>(o.start(),new(N())((t=>o.onAnimationEndObservable.add(t)))),clear:()=>{o.dispose(),this._animateGroup=null},stop:()=>o.stop(),pause:()=>o.pause(),reset:()=>o.reset(),restart:()=>o.restart()}}update(){this._camera.mode=this._mode,this._camera.setTarget(this._target),this._camera.alpha=this._alpha,this._camera.beta=this._beta,this._camera.lowerRadiusLimit=this._lowerRadiusLimit,this._camera.upperRadiusLimit=this._upperRadiusLimit,this._camera.lowerAlphaLimit=this._lowerAlphaLimit,this._camera.upperAlphaLimit=this._upperAlphaLimit,this._camera.lowerBetaLimit=this._lowerBetaLimit,this._camera.upperBetaLimit=this._upperBetaLimit,this._camera.minZ=this._minZ,this._camera.maxZ=this._maxZ,this._camera.panningOriginTarget.copyFrom(this._originPanTarget),this._camera.panningAxis.copyFrom(this._panningAxis),this._camera.panningDistanceLimit=this.PanDistance,this._mode===Zi.V.PERSPECTIVE_CAMERA?this._camera.radius=this._radius:this._camera.radius=vo,this._pointerInput.enablePan=this.EnablePan,this._pointerInput.enableRotate=this.EnableRotate,this._pointerInput.multiTouchPanning=this.EnablePan,this._pointerInput.pinchZoom=this.EnableZoom,this._mode===Zi.V.PERSPECTIVE_CAMERA&&(this.EnableZoom?this._camera.inputs.attached.mousewheel.attachControl():this._camera.inputs.attached.mousewheel.detachControl())}reset(){this._target.copyFrom(ki.P.Zero()),this._alpha=xo,this._beta=So,this._radius=120,this._lowerRadiusLimit=.01,this._upperRadiusLimit=void 0,this._lowerAlphaLimit=void 0,this._upperAlphaLimit=void 0,this._lowerBetaLimit=void 0,this._upperBetaLimit=void 0,this._minZ=1,this._maxZ=fo,this.update()}writeFile(t){t.write(5),super.writeFile(t),t.write(this._alpha),t.write(this._beta),t.write(this._radius),t.write(this._lowerRadiusLimit),t.write(this._upperRadiusLimit),t.write(this._lowerAlphaLimit),t.write(this._upperAlphaLimit),t.write(this._lowerBetaLimit),t.write(this._upperBetaLimit),t.write(this._panDistance),t.write(this._panningAxis.x),t.write(this._panningAxis.y),t.write(this._panningAxis.z),t.write(this._originPanTarget.x),t.write(this._originPanTarget.y),t.write(this._originPanTarget.z),t.write(this._minZ),t.write(this._maxZ)}readFile(t){const e=t.read();e>1&&super.readFile(t),this._alpha=t.read(),this._beta=t.read(),this._radius=t.read(),e>2&&(this._lowerRadiusLimit=t.read(),this._upperRadiusLimit=t.read(),this._lowerAlphaLimit=t.read(),this._upperAlphaLimit=t.read(),this._lowerBetaLimit=t.read(),this._upperBetaLimit=t.read()),e>3&&(this._panDistance=t.read(),this._panningAxis.x=t.read(),this._panningAxis.y=t.read(),this._panningAxis.z=t.read(),this._originPanTarget.x=t.read(),this._originPanTarget.y=t.read(),this._originPanTarget.z=t.read()),e>4&&(this._minZ=t.read(),this._maxZ=t.read()),this._mode===Zi.V.ORTHOGRAPHIC_CAMERA&&this.initOrthCamera(),this.update()}_computeDeltaFromMouseWheelLegacyEvent(t,e){let i=0;const s=.01*t*this.wheelDeltaPercentage*e;return i=t>0?s/(1+this.wheelDeltaPercentage):s*(1+this.wheelDeltaPercentage),i}}class Go extends Co{constructor(t,e){super(t,e),this._scene=t,this._canvas=e,this._camera=void 0,this.customWheel=void 0,t&&e&&(this.init(),this._camera.onViewMatrixChangedObservable.add((t=>{this._position.copyFrom(t.position),this._target.copyFrom(t.target),Mr.trigger({type:"CameraUpdate",target:this})})))}get EnableZoom(){return!!(this._enable&Ns.Zoom)}set EnableZoom(t){t!==this.EnableZoom&&(t?this._enable|=Ns.Zoom:this._enable&=~Ns.Zoom,this._mode===Zi.V.PERSPECTIVE_CAMERA&&(t?this._camera.inputs.attached.mousewheel.attachControl():this._camera.inputs.attached.mousewheel.detachControl()))}get IsFlying(){return this._flying}get Position(){return{x:this._camera.position.x,y:this._camera.position.y,z:this._camera.position.z}}set Position(t){const e=new ki.P;nr(e,t),this._camera.position.copyFromFloats(e.x,e.y,e.z)}get Target(){return{x:this._target.x,y:this._target.y,z:this._target.z}}set Target(t){nr(this._target,t),this._camera.setTarget(this._target)}zoomTo(t,e){this._camera.setTarget(new ki.P(t.x,t.y))}zoomByBoundBox(t,e){super.zoomByBoundBox(t,e)}init(){const t=new li.c("MainFreeCamera",this._position,this._scene);t.inputs._mouseInput.buttons=[1],t.keysDown=[$s.KeyS],t.keysDownward=[$s.ArrowDown],t.keysUp=[$s.KeyW],t.keysUpward=[$s.ArrowUp],t.keysLeft=[$s.KeyA],t.keysRight=[$s.KeyD],t.inputs.addMouseWheel(),t.maxZ=fo,this._camera=t,this._mode===Zi.V.ORTHOGRAPHIC_CAMERA?this.initOrthCamera():this.initPerCamera()}set ViewMode(t){switch(t){case Gs.Up:this._camera.position=this._camera.target.clone().add(new ki.P(0,0,10));break;case Gs.Down:this._camera.position=this._camera.target.clone().add(new ki.P(0,0,-10));break;case Gs.Left:this._camera.position=this._camera.target.clone().add(new ki.P(-10));break;case Gs.Right:this._camera.position=this._camera.target.clone().add(new ki.P(10));break;case Gs.Front:this._camera.position=this._camera.target.clone().add(new ki.P(0,10));break;case Gs.Back:this._camera.position=this._camera.target.clone().add(new ki.P(0,-10));break;case Gs.SW:this._camera.position=this._camera.target.clone().add(new ki.P(10,10,10))}}initOrthCamera(){this._camera.orthoTop=this.size,this._camera.orthoBottom=-this.size,this._camera.orthoLeft=-this.size*this.Aspect,this._camera.orthoRight=this.size*this.Aspect,this._camera.inputs.attached.mousewheel.detachControl(),this.customWheel=this._scene.onPointerObservable.add((t=>{if(!this.EnableZoom)return;const e=t.event;let i=0;i=e.wheelDelta?-e.wheelDelta:60*-(e.deltaY||e.detail),this.zoomScale+=i/(100*this.wheelSpeed),this.zoomScale<0?this.zoomScale=.001:this.updateOrthCamera()}),Di.kD.POINTERWHEEL)}initPerCamera(){this.customWheel&&(this._scene.onPointerObservable.remove(this.customWheel),this.customWheel=null,this.EnableZoom&&this._camera.inputs.attached.mousewheel.attachControl())}attachControl(){this._camera.attachControl(this._canvas,!0)}detachControl(){this._camera.detachControl()}lookAt(t){this._camera.setTarget(rr(t))}moveTo(t){const{target:e,time:i=1,position:s}=t;if(void 0===s&&void 0===e)return;const a=new Xi.O("camera-move-to",this._scene);if(void 0!==e){const t=new Gi.f("target-a","target",30,Gi.f.ANIMATIONTYPE_VECTOR3);t.setKeys([{frame:0,value:this._camera.target.clone()},{frame:30*i,value:rr(e)}]),a.addTargetedAnimation(t,this._camera)}if(void 0!==s){const t=new Gi.f("position","position",30,Gi.f.ANIMATIONTYPE_VECTOR3);t.setKeys([{frame:0,value:this._camera.position.clone()},{frame:30*i,value:rr(s)}]),a.addTargetedAnimation(t,this._camera)}return{start:()=>(a.start(!1,1,0,30*i),new(N())((t=>a.onAnimationGroupEndObservable.add(t)))),clear:()=>{a.dispose(),this._animateGroup=null},stop:()=>a.stop(),pause:()=>a.pause(),reset:()=>a.reset(),restart:()=>a.restart()}}moveByPath(t){var e;if(0===t.path.length)return N().resolve(!1);const i=t.time,s=wa()(e=t.path).call(e,rr);return new fr(this._camera,{path:s,time:i})}update(){this._camera.mode=this._mode,this._camera.setTarget(this._target),this._camera.position=this._position,this._mode===Zi.V.ORTHOGRAPHIC_CAMERA&&this.updateOrthCamera()}reset(){this._target.copyFrom(ki.P.Zero()),this.update()}updateOrthCamera(){this._camera.orthoTop=this.size*this.zoomScale,this._camera.orthoBottom=-this.size*this.zoomScale,this._camera.orthoLeft=-this.size*this.zoomScale*this.Aspect,this._camera.orthoRight=this.size*this.zoomScale*this.Aspect}writeFile(t){t.write(2),super.writeFile(t),t.write(this._position.x),t.write(this._position.y),t.write(this._position.z)}readFile(t){t.read()>1&&super.readFile(t),this._position.x=t.read(),this._position.y=t.read(),this._position.z=t.read(),this.update()}}let Ho;!function(t){t[t.ArcRotate=0]="ArcRotate",t[t.FreeCamera=1]="FreeCamera",t[t.Follow=2]="Follow"}(Ho||(Ho={}));class Vo{constructor(t,e){this._scene=t,this._canvas=e,this._type=Ho.ArcRotate,this._control=void 0,this.ArcRotateControl=void 0,this.FreeControl=void 0,this.init()}get Type(){return this._type}set Type(t){this._type=t,this.switch()}get Control(){return this._control}get Camera(){return this._control.CurrentCamera}get ArcRotateCamera(){return this.ArcRotateControl.CurrentCamera}get FreeCamera(){return this.FreeControl.CurrentCamera}get Alpha(){return this._control.Alpha}set Alpha(t){this._control.Alpha=t}get Beta(){return this._control.Beta}set Beta(t){this._control.Beta=t}get Radius(){return this.ArcRotateControl.Radius}set Radius(t){this.ArcRotateControl.Radius=t}get Position(){return this.Control.Position}set Position(t){this.Control.Position=t}get Target(){return this.Control.Target}set Target(t){this.Control.Target=t}get Mode(){return this.Control.Mode}set Mode(t){this.Control.Mode=t}get ZoomScale(){return this.Control.zoomScale}init(){this.ArcRotateControl=new No(this._scene,this._canvas),this.FreeControl=new Go(this._scene,this._canvas),this._control=this.ArcRotateControl,this._control.active()}switch(){switch(this._control.detachControl(),this._type){case Ho.ArcRotate:this._control=this.ArcRotateControl;break;case Ho.FreeCamera:this._control=this.FreeControl;case Ho.Follow:}this._control.active(),this.switchEvent(this)}switchEvent(t){}zoomAll(t=!1){this._control.zoomAll(t)}zoomToEntity(t){this._control.zoomToEntity(t)}reset(){this.ArcRotateControl.reset(),this.FreeControl.reset()}destory(){this.ArcRotateControl.destory(),this.FreeControl.destory()}writeFile(t){t.write(1),t.write(this._type),this.ArcRotateControl.writeFile(t),this.FreeControl.writeFile(t)}readFile(t){t.read(),this._type=t.read(),this.ArcRotateControl.readFile(t),this.FreeControl.readFile(t),this.switch()}}var Zo=i(92941),Wo=i.n(Zo);class Uo{static LoadSkyboxPathTexture(t){const e=Math.max(0,class{static ReadLocalStorageValue(t,e){return"undefined"!=typeof Storage&&null!==localStorage.getItem(t)?ga()(localStorage.getItem(t)):e}}.ReadLocalStorageValue("defaultSkyboxId",0)),i=this.SkyboxPath||this.Skyboxes[e];return et()(i).call(i,".hdr")===i.length-4?new ei.e(i,t,256,!1,!0,!1,!0):ti.B.CreateFromPrefilteredData(i,t)}}function Ko(t,e,i,s){const a=[{frame:0,value:t},{frame:30*s,value:e}],r=new Gi.f("animation"+z()(),i,30,Gi.f.ANIMATIONTYPE_FLOAT,Gi.f.ANIMATIONLOOPMODE_CONSTANT);return r.setKeys(a),r}function Yo(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}Uo.SkyboxPath="",Uo.Skyboxes=["https://hcwl-cdn.cdn.bcebos.com/hc3d/envs/environmentSpecular.env","https://hcwl-cdn.cdn.bcebos.com/hc3d/envs/studio.env"],Uo.SkyboxesNames=["Default","Studio"];const qo=["groundMaterial","skyMaterial","skyBox","default material"],Xo=["px.jpg","py.jpg","pz.jpg","nx.jpg","ny.jpg","nz.jpg"],$o=new xi.HE(0,0,0);let Qo;!function(t){t[t.None=0]="None",t[t.Mode=1]="Mode",t[t.Env=2]="Env",t[t.Param=4]="Param",t[t.All=127]="All"}(Qo||(Qo={}));class Jo{constructor(t){this._scene=void 0,this._skybox="",this._image="",this._skyboxMesh=void 0,this._standMaterial=void 0,this._pbrMaterial=void 0,this._skyMaterial=void 0,this._glowLayer=void 0,this._mode=qs.None,this._reflectionProbe=void 0,this._turbidity=10,this._luminance=1,this._rayleigh=2,this._sunPosition=new ki.P(0,100,0),this._inclination=0,this._azimuth=.25,this._mieDirectionalG=.8,this._mieCoefficient=.005,this._isReflect=!1,this._layer=void 0,this.reslove=void 0,this._env=void 0,this._iblIntensity=1,this._cacheEnv="",this._envTextureOption={rotationY:0,level:1},this._skyTextureOption={rotationY:0,level:1},this._isShadow=!1,this.LoadObserable=new zi.y$,this.ToggleShadowObserable=new zi.y$,this.watchMaterial=t=>{I()((()=>{this.reflectMaterial(t)}),0)},this.onLoad=()=>{Mr.trigger({type:"loadBackground",target:null}),this.LoadObserable.notifyObservers(!0),this.reslove&&(this.reslove(),this.reslove=null)},t&&(this._scene=new ci.x(t,{useMaterialMeshMap:!Ji.lowPerformance,useClonedMeshMap:!Ji.lowPerformance,useGeometryUniqueIdsMap:!Ji.lowPerformance}),this._scene.ambientColor=xi.Wo.FromHexString("#222222"),this._scene.useRightHandedSystem=!0,this.BlockMaterialUpdate=!0,this._scene.clearColor=$o,this.initReflection(),this.init())}init(){const t=new $e.c("glow",this._scene);t.intensity=.5,this._glowLayer=t}initReflection(){this._reflectionProbe&&this._reflectionProbe.dispose();const t=new ii.x("ref",512,this._scene);this._reflectionProbe=t}get IsExistEnv(){return this._env||this._cacheEnv}get Scene(){return this._scene}get Mode(){return this._mode}set Mode(t){t!==this._mode&&(this._mode=t,this.update(Qo.Mode))}get Skybox(){return this._skybox}set Skybox(t){this._skybox!==t&&(this._skybox=t,this.showSkyBox())}set BackgroundUrl(t){this.isImageType(t)?(this.Image=t,this.Mode=qs.Image):(this.Skybox=t,this.Mode=qs.Skybox)}get Image(){return this._image}set Image(t){this._image!==t&&(this._image=t,this.showImage())}get AmbientColor(){return this._scene.ambientColor.toHexString()}set AmbientColor(t){this.Scene.ambientColor=xi.Wo.FromHexString(t)}get EmissiveIntensity(){return this._glowLayer.intensity}set EmissiveIntensity(t){this._glowLayer.intensity=t}get Background(){const t=this.Scene.clearColor.toHexString();return as()(t).call(t,"FF")?Z()(t).call(t,0,7):Ea(t)}set Background(t){if(t)if("string"==typeof t){if(H()(t).call(t,"#"))this.Scene.clearColor=xi.HE.FromHexString(t);else if(H()(t).call(t,"rgb")){const e=Pa(t);this.Scene.clearColor=new xi.HE(e.r/255,e.g/255,e.b/255,e.a)}}else ur()(t)?this.Scene.clearColor=new xi.HE(t[0]/255,t[1]/255,t[2]/255,t[3]??1):this.Scene.clearColor=t}get Turbidity(){return this._turbidity}set Turbidity(t){t!==this._turbidity&&(this._turbidity=t,this.update(Qo.Mode))}get Rayleigh(){return this._rayleigh}set Rayleigh(t){t!==this._rayleigh&&(this._rayleigh=t,this.update(Qo.Mode))}get Luminance(){return this._luminance}set Luminance(t){t!==this._luminance&&(this._luminance=t,this.update(Qo.Mode))}get SunPosition(){return{x:this._sunPosition.x,y:this._sunPosition.y,z:this._sunPosition.z}}set SunPosition(t){nr(this._sunPosition,t),this.update(Qo.Mode)}get Inclination(){return this._inclination}set Inclination(t){t!==this._inclination&&(this._inclination=t,this.update(Qo.Mode))}get Azimuth(){return this._azimuth}set Azimuth(t){t!==this._azimuth&&(this._azimuth=t,this.update(Qo.Mode))}get IsReflect(){return this._isReflect}set IsReflect(t){t!==this._isReflect&&(this._isReflect=t,t?(this._scene.onNewMaterialAddedObservable.add(this.watchMaterial),this.reflect()):(this._scene.onNewMaterialAddedObservable.removeCallback(this.watchMaterial),this.cancelReflect()))}get BlockMaterialUpdate(){return this._scene.blockMaterialDirtyMechanism}set BlockMaterialUpdate(t){this._scene.blockMaterialDirtyMechanism=t}get Env(){return this._env}set Env(t){t!==this._env&&(this._env=t,this.update(Qo.Env))}get IBLIntensity(){return this._iblIntensity}set IBLIntensity(t){this._iblIntensity=t,this.update(Qo.Param)}get EnvRotation(){return this._envTextureOption.rotationY}set EnvRotation(t){this._envTextureOption.rotationY=t,this.update(Qo.Param)}get IsShadow(){return this._isShadow}set IsShadow(t){this._isShadow!==t&&(this._isShadow=t,this.ToggleShadowObserable.notifyObservers(t))}debugger(t={}){Ji.debugger&&this._scene.debugLayer.show(function(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=Yo(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=Yo(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}({embedMode:!0},t))}toggleShowEnv(){this._env?(this._cacheEnv=this._env,this._env=""):this._env=this._cacheEnv,this.loadEnv()}render(){this._scene.activeCamera&&this._scene.render()}update(t=Qo.All){if(t&Qo.Mode)switch(this._mode){case qs.Image:this.showImage();break;case qs.Skybox:this.showSkyBox();break;case qs.Sun:this.getSkyBox(),this._skyMaterial.inclination=this._inclination,this._skyMaterial.azimuth=this._azimuth,this._skyMaterial.rayleigh=this._rayleigh,this._skyMaterial.turbidity=this._turbidity,this._skyMaterial.luminance=this._luminance,this._skyMaterial.mieDirectionalG=this._mieDirectionalG,this._skyMaterial.mieCoefficient=this._mieCoefficient;break;case qs.Env:break;default:this.hiddenSkyBox()}t&Qo.Env&&this.loadEnv(),t&Qo.Param&&(this._scene.environmentIntensity=this._iblIntensity,this._scene.environmentTexture&&(this._scene.environmentTexture.rotationY=this._envTextureOption.rotationY)),Mr.trigger({type:ys.UpdateScene,target:null})}async reflect(){this.BlockMaterialUpdate=!1;let t=0;for(const e of this._scene.materials)vt()(qo).call(qo,e.name)||(this.reflectMaterial(e),5===t?(await Cs(100),t=0):t++);this.BlockMaterialUpdate=!0}async cancelReflect(){this.BlockMaterialUpdate=!1;let t=0;for(const e of this._scene.materials)vt()(qo).call(qo,e.name)||(this.cancelReflectMaterial(e),5===t?(await Cs(100),t=0):t++);this.BlockMaterialUpdate=!0}createDefaultEnv(){this._scene.environmentTexture=Uo.LoadSkyboxPathTexture(this._scene),this._scene.createDefaultSkybox(this._scene.environmentTexture,!0,(this._scene.activeCamera.maxZ-this._scene.activeCamera.minZ)/2,.3,!1)}loadEnv(t=this._env){if(I()((()=>{this.BlockMaterialUpdate=!0}),100),this.BlockMaterialUpdate=!1,t){const e=ti.B.CreateFromPrefilteredData(Ji.SkyBox_URL+t,this._scene);return e.onLoadObservable.add(this.onLoad),this._scene.environmentTexture=e,e}return this._scene.environmentTexture=null,null}reset(){this._skybox="",this._env="",this._cacheEnv="",this._image="",this._isReflect=!1,this._isShadow=!1,this._mode=qs.None,this._scene.clearColor=$o,this._scene.ambientColor=xi.Wo.FromHexString("#222222"),this._reflectionProbe.dispose(),this._reflectionProbe=new ii.x("ref",512,this._scene),this.update()}writeFile(t){t.write(6),t.write(this._skybox),t.write(this.EmissiveIntensity),t.write(this.Background),t.write(this.AmbientColor),t.write(this._mode),t.write(this._turbidity),t.write(this._luminance),t.write(this._rayleigh),t.write(this._sunPosition.x),t.write(this._sunPosition.y),t.write(this._sunPosition.z),t.write(this._isReflect),t.write(this._inclination),t.write(this._azimuth),t.write(this._image),t.write(this._env),t.write(this._envTextureOption.rotationY),t.write(this._iblIntensity),t.write(this._isShadow)}readFile(t){this.initReflection();const e=t.read();this._skybox=t.read(),this.EmissiveIntensity=t.read(),this.Background=t.read(),this.AmbientColor=t.read(),this._mode=t.read(),this._turbidity=t.read(),this._luminance=t.read(),this._rayleigh=t.read(),this._sunPosition.x=t.read(),this._sunPosition.y=t.read(),this._sunPosition.z=t.read(),this.IsReflect=t.read(),e>1&&(this._inclination=t.read(),this._azimuth=t.read()),e>2&&(this._image=t.read()),!this._image&&this.isImageType(this._skybox)&&(this._image=this._skybox,this._skybox="",this._mode=qs.Image),e>3&&(this._env=t.read(),this._envTextureOption.rotationY=t.read()),e>4&&(this._iblIntensity=t.read()),e>5&&(this.IsShadow=t.read()),this.update()}testLights(){var t;let[e,i,s]=[275,30,180],[a,r]=[225,146],[n,o]=[80,148],[h,l]=[-71,190];const c=[new ki.P(e,i,s-36),new ki.P(a-43,i,r),new ki.P(a-43,i,r-30),new ki.P(n-43,i,o),new ki.P(h,i,l-43)];let d=1;b()(t=this._scene.materials).call(t,(t=>t.maxSimultaneousLights=c.length+1));for(const t of c){const e=new Je.P("s"+d++,t,new ki.P(0,-1),2*Math.PI,2,this._scene);e.intensity=3e3,e.range=1e3}}day2Evening(t=!1){if(!this._skyMaterial)return;const e=[this._turbidity,1],i=[this._rayleigh,0],s=[this._luminance,.8],a=[this._inclination,-.48],r=[this._inclination,-.48],n=[1,-.1];t&&(Wo()(e).call(e),Wo()(i).call(i),Wo()(s).call(s),Wo()(a).call(a),Wo()(r).call(r),Wo()(n).call(n));const o=new Xi.O("d2e"),h=Ko(e[0],e[1],"material.turbidity",6),l=Ko(i[0],i[1],"material.rayleigh",6),c=Ko(s[0],s[1],"material.luminance",6),d=Ko(a[0],a[1],"material.inclination",6),u=Ko(r[0],r[1],"material.azimuth",6),p=this._scene.lights[0],m=Ko(n[0],n[1],"intensity",6);this._scene.stopAnimation(this._skyboxMesh),this._scene.stopAnimation(p);for(const t of[h,l,c,d,u])o.addTargetedAnimation(t,this._skyboxMesh);o.addTargetedAnimation(m,p),o.start(!1,1,0,180)}showFog(t=200,e=1e3){this._scene.fogMode=ci.x.FOGMODE_LINEAR,this._scene.fogColor=new xi.Wo(.9,.9,.85),this._scene.fogDensity=.01,this._scene.fogStart=t,this._scene.fogEnd=e}isImageType(t){var e;return Et()(e=["png","jpg","jpeg"]).call(e,(e=>as()(t).call(t,e)))}showSkyBox(){var t;this._skybox?(this.hiddenLayer(),as()(t=this._skybox).call(t,"hdr")?this.setSkyboxByHdr(Ji.SkyBox_URL+this._skybox):(this.reslove=zr.Wait(),Mr.trigger({type:"loadingBackground",target:null}),this.setEnvTexture(new ti.B(Ji.SkyBox_URL+this._skybox,this._scene,Xo,void 0,null,this.onLoad)))):this.hiddenSkyBox()}showImage(){this._image?(this.hiddenBox(),this._layer?(this.reslove=zr.Wait(),Mr.trigger({type:"loadingBackground",target:null}),this._layer.isEnabled=!0,this._layer.texture.updateURL(Ji.SkyBox_URL+this._image,null,this.onLoad)):this._layer=new Qe.m("GlobalBackground",Ji.SkyBox_URL+this._image,this._scene,!0)):this.hiddenSkyBox()}hiddenLayer(){this._layer&&(this._layer.isEnabled=!1)}hiddenBox(){this._skyboxMesh&&this._skyboxMesh.setEnabled(!1)}hiddenSkyBox(){this.hiddenBox(),this.hiddenLayer()}setSkyboxByHdr(t){const e=new ei.e(t,this._scene,512);this.setEnvTexture(e)}getSkyBox(){const t=this.createSkybox();return t.setEnabled(!0),this._mode===qs.Sun?t.material=this.getSkyMaterial():this._mode===qs.Env?t.material=this.getPBRMaterial():t.material=this.getStandMaterial(),t}createSkybox(){if(this._skyboxMesh)return this._skyboxMesh;const t=(0,Ee.NR)("skybox",{size:fo},this._scene);return t.isPickable=!1,t.infiniteDistance=!0,t.ignoreCameraMaxZ=!0,this._reflectionProbe.renderList.push(t),this._skyboxMesh=t,this._skyboxMesh}getStandMaterial(){if(this._standMaterial)return this._standMaterial;const t=new Oi.K("skyBox",this._scene);return this._standMaterial=t,t.backFaceCulling=!1,t.disableLighting=!0,this._standMaterial=t,this._standMaterial}getPBRMaterial(){if(this._pbrMaterial)return this._pbrMaterial;const t=new fi.Y("skyBox",this._scene);return t.backFaceCulling=!1,t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=Fi.x.SKYBOX_MODE),t.microSurface=1,t.disableLighting=!0,t.twoSidedLighting=!0,this._pbrMaterial=t,this._pbrMaterial}getSkyMaterial(){if(this._skyMaterial)return this._skyMaterial;const t=new ie.f("skyMaterial",this._scene);return t.backFaceCulling=!1,this._skyMaterial=t,this._skyMaterial}setEnvTexture(t){const e=this.getSkyBox().material;e.reflectionTexture=t,e.reflectionTexture&&(e.reflectionTexture.coordinatesMode=Fi.x.SKYBOX_MODE)}reflectMaterial(t){if(!vt()(qo).call(qo,t.name)&&(t instanceof Oi.K||t instanceof fi.Y)){this.BlockMaterialUpdate=!1;const e=t.reflectionTexture;t.metadata=e,t.reflectionTexture=this._reflectionProbe.cubeTexture,t instanceof fi.Y&&(t.realTimeFiltering=!0),this.BlockMaterialUpdate=!0}}cancelReflectMaterial(t){vt()(qo).call(qo,t.name)||(t instanceof Oi.K||t instanceof fi.Y)&&(t.reflectionTexture=t.metadata,t.metadata=null,t.realTimeFiltering=!1)}}var th=i(90622),eh=(0,hs.Z)("pipeline"),ih=(0,hs.Z)("bloomEnabled"),sh=(0,hs.Z)("bloomThreshold"),ah=(0,hs.Z)("bloomWeight"),rh=(0,hs.Z)("bloomKernel"),nh=(0,hs.Z)("bloomScale"),oh=(0,hs.Z)("depthOfFieldEnabled"),hh=(0,hs.Z)("depthOfFieldBlurLevel"),lh=(0,hs.Z)("focusDistance"),ch=(0,hs.Z)("focalLength"),dh=(0,hs.Z)("fStop"),uh=(0,hs.Z)("lensSize"),ph=(0,hs.Z)("vignetteEnabled"),mh=(0,hs.Z)("vignetteBlendMode"),gh=(0,hs.Z)("vignetteColor"),_h=(0,hs.Z)("vignetteWeight"),wh=(0,hs.Z)("imageProcessingEnabled"),yh=(0,hs.Z)("contrast"),bh=(0,hs.Z)("exposure"),fh=(0,hs.Z)("sharpenEnabled"),vh=(0,hs.Z)("edgeAmount"),xh=(0,hs.Z)("colorAmount");class Sh{constructor(t,e){this.scene=t,this.camera=e,O()(this,eh,{writable:!0,value:void 0}),O()(this,ih,{writable:!0,value:!1}),O()(this,sh,{writable:!0,value:.9}),O()(this,ah,{writable:!0,value:.15}),O()(this,rh,{writable:!0,value:64}),O()(this,nh,{writable:!0,value:1}),O()(this,oh,{writable:!0,value:!1}),O()(this,hh,{writable:!0,value:Yt.z.Low}),O()(this,lh,{writable:!0,value:2e3}),O()(this,ch,{writable:!0,value:50}),O()(this,dh,{writable:!0,value:1.4}),O()(this,uh,{writable:!0,value:50}),O()(this,ph,{writable:!0,value:!1}),O()(this,mh,{writable:!0,value:th.$.VIGNETTEMODE_MULTIPLY}),O()(this,gh,{writable:!0,value:new xi.HE(0,0,0,0)}),O()(this,_h,{writable:!0,value:1.5}),O()(this,wh,{writable:!0,value:!0}),O()(this,yh,{writable:!0,value:1}),O()(this,bh,{writable:!0,value:1}),O()(this,fh,{writable:!0,value:!1}),O()(this,vh,{writable:!0,value:1}),O()(this,xh,{writable:!0,value:.3}),this.init()}get Pipeline(){return(0,os.Z)(this,eh)[eh]}get EnableBloom(){return(0,os.Z)(this,ih)[ih]}set EnableBloom(t){(0,os.Z)(this,ih)[ih]=t,this.update()}get BloomThreshold(){return(0,os.Z)(this,sh)[sh]}set BloomThreshold(t){(0,os.Z)(this,sh)[sh]=t,this.update()}get BloomWeight(){return(0,os.Z)(this,ah)[ah]}set BloomWeight(t){(0,os.Z)(this,ah)[ah]=t,this.update()}get BloomKernel(){return(0,os.Z)(this,rh)[rh]}set BloomKernel(t){(0,os.Z)(this,rh)[rh]=t,this.update()}get BloomScale(){return(0,os.Z)(this,nh)[nh]}set BloomScale(t){t?((0,os.Z)(this,nh)[nh]=t,this.update()):Wt.w1.Error("\u503c\u5fc5\u987b\u5927\u4e8e1")}get DepthOfFieldEnabled(){return(0,os.Z)(this,oh)[oh]}set DepthOfFieldEnabled(t){(0,os.Z)(this,oh)[oh]=t,this.update()}get DepthOfFieldBlurLevel(){return(0,os.Z)(this,hh)[hh]}set DepthOfFieldBlurLevel(t){(0,os.Z)(this,hh)[hh]=t,this.update()}get FocusDistance(){return(0,os.Z)(this,lh)[lh]}set FocusDistance(t){(0,os.Z)(this,lh)[lh]=t,this.update()}get FocalLength(){return(0,os.Z)(this,ch)[ch]}set FocalLength(t){(0,os.Z)(this,ch)[ch]=t,this.update()}get FStop(){return(0,os.Z)(this,dh)[dh]}set FStop(t){(0,os.Z)(this,dh)[dh]=t,this.update()}get LensSize(){return(0,os.Z)(this,uh)[uh]}set LensSize(t){(0,os.Z)(this,uh)[uh]=t,this.update()}get VignetteEnabled(){return(0,os.Z)(this,ph)[ph]}set VignetteEnabled(t){(0,os.Z)(this,ph)[ph]=t,this.update()}get VignetteBlendMode(){return(0,os.Z)(this,mh)[mh]}set VignetteBlendMode(t){(0,os.Z)(this,mh)[mh]=t,this.update()}get VignetteColor(){return(0,os.Z)(this,gh)[gh].toHexString()}set VignetteColor(t){(0,os.Z)(this,gh)[gh]=xi.HE.FromHexString(t),this.update()}get VignetteWeight(){return(0,os.Z)(this,_h)[_h]}set VignetteWeight(t){(0,os.Z)(this,_h)[_h]=t,this.update()}get ImageProcessEnable(){return(0,os.Z)(this,wh)[wh]}set ImageProcessEnable(t){(0,os.Z)(this,wh)[wh]=t,this.update()}get Contrast(){return(0,os.Z)(this,yh)[yh]}set Contrast(t){(0,os.Z)(this,yh)[yh]=t,this.update()}get Exposure(){return(0,os.Z)(this,bh)[bh]}set Exposure(t){(0,os.Z)(this,bh)[bh]=t,this.update()}get SharpenEnabled(){return(0,os.Z)(this,fh)[fh]}set SharpenEnabled(t){(0,os.Z)(this,fh)[fh]=t,this.update()}get EdgeAmount(){return(0,os.Z)(this,vh)[vh]}set EdgeAmount(t){(0,os.Z)(this,vh)[vh]=t,this.update()}get ColorAmount(){return(0,os.Z)(this,xh)[xh]}set ColorAmount(t){(0,os.Z)(this,xh)[xh]=t,this.update()}init(){(0,os.Z)(this,eh)[eh]=new Ne.e("\u9ed8\u8ba4\u6e32\u67d3\u7ba1\u7ebf",!1,this.scene,[this.camera])}update(){if((0,os.Z)(this,eh)[eh]){Nr(this.scene),(0,os.Z)(this,eh)[eh].bloomEnabled=(0,os.Z)(this,ih)[ih],(0,os.Z)(this,eh)[eh].bloomThreshold=(0,os.Z)(this,sh)[sh],(0,os.Z)(this,eh)[eh].bloomWeight=(0,os.Z)(this,ah)[ah],(0,os.Z)(this,eh)[eh].bloomKernel=(0,os.Z)(this,rh)[rh],(0,os.Z)(this,eh)[eh].bloomScale=(0,os.Z)(this,nh)[nh],(0,os.Z)(this,eh)[eh].depthOfFieldEnabled=(0,os.Z)(this,oh)[oh],(0,os.Z)(this,eh)[eh].depthOfFieldBlurLevel=(0,os.Z)(this,hh)[hh],(0,os.Z)(this,eh)[eh].imageProcessingEnabled=(0,os.Z)(this,wh)[wh],(0,os.Z)(this,eh)[eh].sharpenEnabled=(0,os.Z)(this,fh)[fh],(0,os.Z)(this,eh)[eh].sharpen&&((0,os.Z)(this,eh)[eh].sharpen.edgeAmount=(0,os.Z)(this,vh)[vh],(0,os.Z)(this,eh)[eh].sharpen.colorAmount=(0,os.Z)(this,xh)[xh]),(0,os.Z)(this,eh)[eh].depthOfField&&((0,os.Z)(this,eh)[eh].depthOfField.focusDistance=(0,os.Z)(this,lh)[lh],(0,os.Z)(this,eh)[eh].depthOfField.focalLength=(0,os.Z)(this,ch)[ch],(0,os.Z)(this,eh)[eh].depthOfField.fStop=(0,os.Z)(this,dh)[dh],(0,os.Z)(this,eh)[eh].depthOfField.lensSize=(0,os.Z)(this,uh)[uh]);const t=()=>{(0,os.Z)(this,eh)[eh].imageProcessing&&(Nr(this.scene),(0,os.Z)(this,eh)[eh].imageProcessing.contrast=(0,os.Z)(this,yh)[yh],(0,os.Z)(this,eh)[eh].imageProcessing.exposure=(0,os.Z)(this,bh)[bh],(0,os.Z)(this,eh)[eh].imageProcessing.vignetteEnabled=(0,os.Z)(this,ph)[ph],(0,os.Z)(this,eh)[eh].imageProcessing.vignetteBlendMode=(0,os.Z)(this,mh)[mh],(0,os.Z)(this,eh)[eh].imageProcessing.vignetteColor=(0,os.Z)(this,gh)[gh],(0,os.Z)(this,eh)[eh].imageProcessing.vignetteWeight=(0,os.Z)(this,_h)[_h])};(0,os.Z)(this,eh)[eh].imageProcessing?t():(0,os.Z)(this,eh)[eh].onBuildObservable.addOnce(t)}}reset(){(0,os.Z)(this,ih)[ih]=!1,(0,os.Z)(this,oh)[oh]=!1,(0,os.Z)(this,wh)[wh]=!1,(0,os.Z)(this,ph)[ph]=!1,(0,os.Z)(this,fh)[fh]=!1,this.update()}readFile(t){t.read(),(0,os.Z)(this,ih)[ih]=t.read(),(0,os.Z)(this,sh)[sh]=t.read(),(0,os.Z)(this,ah)[ah]=t.read(),(0,os.Z)(this,rh)[rh]=t.read(),(0,os.Z)(this,nh)[nh]=t.read(),(0,os.Z)(this,oh)[oh]=t.read(),(0,os.Z)(this,hh)[hh]=t.read(),(0,os.Z)(this,lh)[lh]=t.read(),(0,os.Z)(this,ch)[ch]=t.read(),(0,os.Z)(this,dh)[dh]=t.read(),(0,os.Z)(this,uh)[uh]=t.read(),(0,os.Z)(this,wh)[wh]=t.read(),(0,os.Z)(this,yh)[yh]=t.read(),(0,os.Z)(this,bh)[bh]=t.read(),(0,os.Z)(this,ph)[ph]=t.read(),(0,os.Z)(this,mh)[mh]=t.read();const e=t.read();(0,os.Z)(this,gh)[gh]=xi.HE.FromHexString(e),(0,os.Z)(this,_h)[_h]=t.read(),(0,os.Z)(this,fh)[fh]=t.read(),(0,os.Z)(this,vh)[vh]=t.read(),(0,os.Z)(this,xh)[xh]=t.read(),requestIdleCallback((()=>{this.update()}))}writeFile(t){t.write(1),t.write((0,os.Z)(this,ih)[ih]),t.write((0,os.Z)(this,sh)[sh]),t.write((0,os.Z)(this,ah)[ah]),t.write((0,os.Z)(this,rh)[rh]),t.write((0,os.Z)(this,nh)[nh]),t.write((0,os.Z)(this,oh)[oh]),t.write((0,os.Z)(this,hh)[hh]),t.write((0,os.Z)(this,lh)[lh]),t.write((0,os.Z)(this,ch)[ch]),t.write((0,os.Z)(this,dh)[dh]),t.write((0,os.Z)(this,uh)[uh]),t.write((0,os.Z)(this,wh)[wh]),t.write((0,os.Z)(this,yh)[yh]),t.write((0,os.Z)(this,bh)[bh]),t.write((0,os.Z)(this,ph)[ph]),t.write((0,os.Z)(this,mh)[mh]),t.write((0,os.Z)(this,gh)[gh].toHexString()),t.write((0,os.Z)(this,_h)[_h]),t.write((0,os.Z)(this,fh)[fh]),t.write((0,os.Z)(this,vh)[vh]),t.write((0,os.Z)(this,xh)[xh])}}function Mh({color:t,dir:e,height:i,cameraHeight:s,scene:a,cm:r,reverse:n=!1},o){const h=n?-1:1,l=new ji.Y(`${n?"-":""}${e}-label`,a);l.position[e]=i*h;const c=new Xe.P;c.isPointerBlocker=!0,c.width="120px",c.height="120px",c.thickness=4,c.color=t,c.background=t;const d=new ye.a(e,(n?"-":"")+e.toUpperCase());d.fontSize=70,d.fontWeight="400",d.color="#000000",c.addControl(d);const u=a.activeCamera;return c.onPointerClickObservable.add((t=>{u.restoreState();const i=new ki.P,a=new ki.P;if(a[e]=s*h,r.Camera instanceof Vi.Y){const t=r.Camera,s=t.radius;i[e]=s*h,r.Position=t.target.add(i)}else if(r.Camera instanceof li.c){const t=ki.P.Distance(r.Camera.target,r.Camera.position);i[e]=t*h,r.Target=r.Camera.position.add(i)}u.setPosition(a)})),c.onPointerEnterObservable.add((()=>{d.color="#ffffff"})),c.onPointerOutObservable.add((()=>{d.color="#000000"})),o.addControl(c),c.linkWithMesh(l),c}function Oh(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}function Ph(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=Oh(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=Oh(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}class Ch{constructor(t,e,i){this.engine=t,this.cameraManger=i,this._scene=void 0,this._cameraHeight=3.2,this.ellipses=[],this.FreeObserver=void 0,this.stopRender=!1,this.onArcRotateChange=t=>{const e=this.Scene.activeCamera;e instanceof Vi.Y&&(e.alpha=t.alpha,e.beta=t.beta)},this.onFreeChange=t=>{const e=this.Scene.activeCamera;if(e instanceof Vi.Y){const i=t.position.subtract(t.target).normalize().scale(this._cameraHeight);e.position=i}},this.init(),this.initViewHelper();const s=Ke.i.GetPlanes(this._scene.getTransformMatrix());this._scene.registerBeforeRender((()=>{var t;b()(t=this.ellipses).call(t,(t=>{t.linkedMesh&&this.isInFrustum(s,t.linkedMesh.position)&&this.changeZIndex(t,t.linkedMesh,Math.round(1e3/e.activeCamera.position.subtract(t.linkedMesh.position).length()))}))})),e.onActiveCameraChanged.add((t=>{t.activeCamera instanceof li.c&&!this.FreeObserver&&(this.FreeObserver=e.activeCamera.onViewMatrixChangedObservable.add(this.onFreeChange))})),this._scene.activeCamera instanceof Vi.Y&&e.activeCamera instanceof Vi.Y&&(this._scene.activeCamera.alpha=e.activeCamera.alpha,this._scene.activeCamera.beta=e.activeCamera.beta),e.activeCamera.onViewMatrixChangedObservable.add(this.onArcRotateChange)}get Scene(){return this._scene}render(){this._scene.activeCamera&&!this.stopRender&&this._scene.render()}init(){const t=new ci.x(this.engine);t.autoClear=!1,t.ambientColor=xi.Wo.White(),t.createDefaultCamera(!0,!0,!0),t.useRightHandedSystem=!0;const e=t.activeCamera;e.viewport=new Ye.l(.85,.85,.15,.15),e.detachControl(),e.target=ki.P.Zero(),e.setPosition(new ki.P(0,0,this._cameraHeight)),this._scene=t}initViewHelper(){const t={diameter:.05,height:1,tessellation:96},e=new ji.Y("viewerHelper",this._scene),i="#ff3653",s="#8adb00",a="#2c8fff",r=(0,Ie.wf)("x-line",t,this._scene);r.position.x+=.5,r.rotation.z=Math.PI/2,r.parent=e;const n=new Oi.K("",this._scene);n.ambientColor=xi.Wo.FromHexString(i),r.material=n;const o=(0,Ie.wf)("y-line",t,this._scene),h=new Oi.K("",this._scene);h.ambientColor=xi.Wo.FromHexString(s),o.material=h,o.position.y+=.5;const l=(0,Ie.wf)("z-line",t,this._scene),c=new Oi.K("",this._scene);c.ambientColor=xi.Wo.FromHexString(a),l.material=c,l.rotation.x=Math.PI/2,l.position.z+=.5;const d=qe.i.CreateFullscreenUI("UI",!0,this._scene),u={height:1,cameraHeight:this._cameraHeight,scene:this._scene,cm:this.cameraManger};this.ellipses.push(Mh(Ph(Ph({},u),{},{dir:"x",color:i}),d),Mh(Ph(Ph({},u),{},{dir:"x",color:i,reverse:!0}),d),Mh(Ph(Ph({},u),{},{dir:"y",color:s}),d),Mh(Ph(Ph({},u),{},{dir:"y",color:s,reverse:!0}),d),Mh(Ph(Ph({},u),{},{dir:"z",color:a}),d),Mh(Ph(Ph({},u),{},{dir:"z",color:a,reverse:!0}),d))}changeZIndex(t,e,i){t.zIndex=i,t.linkWithMesh(e)}isInFrustum(t,e){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}}var Ah=(0,hs.Z)("sceneEffectManager");class Eh{constructor(t,e=!1,i={defaultLight:!1}){this.canvas=t,this.preview=e,this._option=i,this.engine=void 0,this.sceneControl=void 0,this.cameraManager=void 0,this.ground=void 0,this.utilLayer=void 0,this.hemisphericLight=void 0,this.highlightManager=void 0,this._showWorldAxes=!1,this._worldAxes=void 0,this._engineOption={preserveDrawingBuffer:!1,stencil:!0,useHighPrecisionMatrix:!0,premultipliedAlpha:!1,antialias:!Ji.lowPerformance,forceSRGBBufferSupportState:!1,doNotHandleContextLost:Ji.lowPerformance},this._sceneHelper=void 0,this._advancedDynamicTexture=void 0,this.Reading=!1,this.pauseRender=!1,this.sceneObjects=[],O()(this,Ah,{writable:!0,value:void 0}),this.renderFunction=()=>{this.renderEvent(),this.Reading||this.pauseRender||(this.sceneControl.render(),this._sceneHelper&&this._sceneHelper.render())},this.init(),this._regiser(),this.render()}get Scene(){return this.sceneControl.Scene}get ShowAxesViewer(){return this._showWorldAxes}set ShowAxesViewer(t){this._showWorldAxes=t,this._worldAxes&&(this._worldAxes.xAxis.setEnabled(t),this._worldAxes.yAxis.setEnabled(t),this._worldAxes.zAxis.setEnabled(t))}get AmbientColor(){return this.Scene.ambientColor}set AmibentColor(t){this.Scene.ambientColor=xi.Wo.FromHexString(t)}get GuiContainer(){return this._advancedDynamicTexture}get PauseRender(){return this.PauseRender}set PauseRender(t){t!==this.pauseRender&&(this.pauseRender=t,t&&I()((()=>{this.engine.clear(this.Scene.clearColor,this.Scene.autoClear||this.Scene.forceWireframe||this.Scene.forcePointsCloud,this.Scene.autoClearDepthAndStencil,this.Scene.autoClearDepthAndStencil)}),0))}get IsPreview(){return this.preview}async getPreviewUrl(t=!1,e=400,i=!1){var s,a;this._sceneHelper&&(this._sceneHelper.stopRender=!0),this.utilLayer&&b()(s=this.utilLayer.utilityLayerScene.rootNodes).call(s,(t=>{t.metadata=t.isEnabled(),t.setEnabled(!1)}));let[r,n]="number"==typeof e?[e,e]:[e.width??e.height,e.height??e.width];t&&(this.setSize(r,n),this.stopRender(),this.sceneControl.render());const o=this.canvas.toDataURL();return t&&(this.setSize(),this.render()),this._sceneHelper&&(this._sceneHelper.stopRender=!1),this.utilLayer&&b()(a=this.utilLayer.utilityLayerScene.rootNodes).call(a,(t=>{t.setEnabled(t.metadata)})),o}async getBlob(t=!1){return As(await this.getPreviewUrl(t))}get ShowGround(){return this.ground.isEnabled()}set ShowGround(t){this.ground.setEnabled(t)}get EffectManager(){return(0,os.Z)(this,Ah)[Ah]}init(){this._initEngine(),this._initScene(),this._initCamera(),this._option.defaultLight&&this._initLight(),this.preview||this._initSceneHelper(),zr.Scene=this.Scene,this.highlightManager=new Oo(this),this.setSize();const t=qe.i.CreateFullscreenUI("MainGuiContainer",!0,this.Scene);this._advancedDynamicTexture=t,(0,os.Z)(this,Ah)[Ah]=new Sh(this.Scene,this.Camera)}initEditor(){this.utilLayer=new qi.x(this.Scene),this._worldAxes=new Wi.w(this.utilLayer.utilityLayerScene,1,0),this._worldAxes.xAxis.setEnabled(this._showWorldAxes),this._worldAxes.yAxis.setEnabled(this._showWorldAxes),this._worldAxes.zAxis.setEnabled(this._showWorldAxes),this.cameraManager.ArcRotateControl.onRadiusChangeObserver.add((t=>{this.updateAxes()})),this.cameraManager.ArcRotateControl.onZommScaleChangeObserver.add((t=>{this.updateAxes()}));const t=Yi.V.CreateGround("WORLD_GROUND",{width:Mo,height:Mo},this.Scene);t.isPickable=!1;const e=new he.D("groundMaterial",this.Scene);e.lineColor=new xi.Wo(79/255,79/255,79/255),e.mainColor=new xi.Wo(61/255,61/255,61/255),e.opacity=.98,e.backFaceCulling=!1,e.gridRatio=10,e.freeze(),t.material=e,this.ground=t,this.highlightManager.exclude(t),Ft(this.cameraManager,this.cameraManager.switchEvent,(t=>{if(this._worldAxes){const e=this._showWorldAxes&&t.Type===Ho.ArcRotate;this._worldAxes.xAxis.setEnabled(e),this._worldAxes.yAxis.setEnabled(e),this._worldAxes.zAxis.setEnabled(e)}}))}get Width(){return this.engine.getRenderWidth()}get Height(){return this.engine.getRenderHeight()}get Camera(){return this.cameraManager.Camera}get FPS(){return this.engine.getFps()}setSize(t,e){this.engine.setSize(t??this.canvas.parentElement.clientWidth,e??this.canvas.parentElement.clientHeight)}world2screen(t){return ki.P.Project(rr(t),ki.y3.IdentityReadOnly,this.Scene.getTransformMatrix(),this.Camera.viewport.toGlobal(this.Scene.getEngine().getRenderWidth(),this.Scene.getEngine().getRenderHeight()))}screen2World(t){const e=this.Scene.createPickingRay(t.x,t.y,this.Scene.getViewMatrix(),this.cameraManager.Camera,!0);this.ground&&(this.ground.isPickable=!0);const i=e.intersectsMesh(this.ground||this.Plane);return this.ground&&(this.ground.isPickable=!1),i.hit?i.pickedPoint:null}render(){this.engine.runRenderLoop(this.renderFunction)}stopRender(){this.engine.stopRenderLoop()}destory(){this.Scene!==zr.MainScene&&zr.Scene===this.Scene&&(console.info("\u5207\u6362\u56de\u4e3b\u573a\u666f"),zr.Scene=zr.MainScene),this.cameraManager.destory(),this.engine.dispose()}on(t,e){let i;return"rendered"===t?(i=this.Scene.onAfterRenderObservable.add(e),()=>{this.Scene.onAfterRenderObservable.remove(i)}):()=>{}}zoomAll(t=!1){this.cameraManager.zoomAll(t)}reset(){this.cameraManager.reset(),this.sceneControl.reset(),(0,os.Z)(this,Ah)[Ah].reset(),this.updateAxes(!0)}setCursor(t){this.canvas.parentElement.style.cursor=t}loadGroundImage(t){let e;e="string"==typeof t?new Fi.x(t,this.Scene):Fi.x.LoadFromDataString("ground-image",t,this.Scene);const i=new Oi.K("ground-image-mtl",this.Scene);return i.specularColor=xi.Wo.Black(),i.diffuseTexture=e,i.backFaceCulling=!1,e.vAng=Math.PI,e.wAng=Math.PI,new(N())((t=>{e.onLoadObservable.addOnce((e=>{const s=Yi.V.CreateGround("ground-iamge",e.getSize(),this.Scene);s.material=i,s.freezeWorldMatrix(),i.freeze(),this.sceneObjects.push(s),t(s)}))}))}destoryGroundImage(){var t;b()(t=this.sceneObjects).call(t,(t=>t.dispose(!1,!0))),this.sceneObjects.length=0}focus(){this.canvas.focus()}_regiser(){}_initEngine(){const t=new Ui.D(this.canvas,!Ji.lowPerformance,this._engineOption);this.engine=t}_initScene(){this.sceneControl=new Jo(this.engine)}_initCamera(){this.cameraManager=new Vo(this.Scene,this.canvas)}_initLight(){new Hi.e("global-light",new ki.P(1,1,1),this.Scene)}_initSceneHelper(){this._sceneHelper=new Ch(this.engine,this.Scene,this.cameraManager)}updateAxes(t=!1){if(!this.utilLayer)return;const e=this.utilLayer.utilityLayerScene.activeCamera.globalPosition;this._worldAxes.xAxis.position.subtractToRef(e,ar);const i=ar.length();if(this.Camera.mode===Zi.V.ORTHOGRAPHIC_CAMERA){const t=this.cameraManager.ZoomScale;this._worldAxes.xAxis.scaling.setAll(100*t),this._worldAxes.yAxis.scaling.setAll(100*t),this._worldAxes.zAxis.scaling.setAll(100*t)}else if(t)this._worldAxes.xAxis.scaling.setAll(1),this._worldAxes.yAxis.scaling.setAll(1),this._worldAxes.zAxis.scaling.setAll(1);else{const t=15;this._worldAxes.xAxis.scaling.setAll(i/t*4),this._worldAxes.yAxis.scaling.setAll(i/t*4),this._worldAxes.zAxis.scaling.setAll(i/t*4)}}renderEvent(){}clearScene(){for(const t of this.Scene.rootNodes)t.metadata?.needDispose&&t.dispose(!1,!0)}writeFile(t){t.write(2),this.cameraManager.writeFile(t),this.sceneControl.writeFile(t),(0,os.Z)(this,Ah)[Ah].writeFile(t)}readFile(t){this.Reading=!0;const e=t.read();this.cameraManager.readFile(t),this.sceneControl.readFile(t),e>1?(0,os.Z)(this,Ah)[Ah].readFile(t):(0,os.Z)(this,Ah)[Ah].reset(),this.Reading=!1,this.updateAxes(!0)}clearCache(){this.Scene.cleanCachedTextureBuffer(),this.engine.clearInternalTexturesCache()}}let zh;Oi.K.AmbientTextureEnabled=!1,function(t){const e=new(U()),i=new(U());let s;function a(t){var e;return xi.Wo.FromArray(wa()(e=ya[t]).call(e,(t=>t/255)))}function r(t,i){if(e.has(t))return e.get(t);let s=new Oi.K("__common_color_"+t,i);return s.backFaceCulling=!1,s.diffuseColor=a(t),e.set(t,s),s}t.getColor3=a,t.getColor4=function(t){var e;return xi.HE.FromArray(wa()(e=ya[t]).call(e,(t=>t/255)))},t.getColor3fromHex=function(t){return xi.Wo.FromHexString(t)},t.getColorArray=function(t){var e;return wa()(e=ya[t]).call(e,(t=>t/255))},t.getStandMaterial=r,t.getWireframeStandMaterial=function(t,e){if(i.has(t))return i.get(t);let s=new Oi.K("__common__wf_color_"+t,e);return s.diffuseColor=a(t),s.alpha=0,i.set(t,s),s},t.clear=function(){e.clear(),i.clear()},t.getDefaultStandardMaterial=function(){return s||(s=r(9,zr.Scene)),s}}(zh||(zh={}));class Dh extends Er{constructor(){super()}get VertextData(){return null}initDrawObject(t=Us.Conceptual){const e=new Ki.Kj(this.UniqueName,Er.Scene);return this.VertextData.applyToMesh(e),t===Us.Wireframe&&(e.enableEdgesRendering(),e.edgesColor=xi.HE.FromArray(ya[this.ColorIndex])),this.updateMaterial(t,e),e.receiveShadows=!0,requestIdleCallback((()=>{Mr.trigger({type:"load",target:this}),this.trigger({type:"load",target:this})})),e}updateDrawObject(t,e){e&&(e.geometry.setAllVerticesData(this.VertextData),e.visibility=this._opacity)}updateMaterial(t,e){const i=e??this.RenderObject;switch(t??this.RenderType){case Us.Wireframe:i.material=zh.getWireframeStandMaterial(this._colorIndex,Er.Scene);break;case Us.Physical:case Us.Conceptual:{const t=zh.getStandMaterial(this.ColorIndex,Er.Scene);i.material=t;break}}this.Material&&(i.material=this.Material.Material,this.Color&&(i.material instanceof Oi.K?i.material.diffuseColor=ba(this.Color):i.material instanceof fi.Y&&(i.material.albedoColor=ba(this.Color))));for(const[t,e]of this._materialMap)i.id===t&&e.Object?.Material&&(i.material=e.Object.Material)}}var Th,Rh;Dh.VertexDataCache=new(U());let Ih=Y((Rh=class t extends Dh{constructor(t={width:10,height:10,depth:10,center:Zs.Center}){super(),this.width=10,this.height=10,this.depth=10,this._center=Zs.Center,this._name="\u76d2\u5b50",this.width=t.width??this.width,this.height=t.height??this.height,this.depth=t.depth??this.depth,this._center=t.center??Zs.Center}get Width(){return this.width}set Width(t){t!==this.width&&(this.writeSnapshoot(),this.width=t,this.update())}get Height(){return this.height}set Height(t){t!==this.height&&(this.writeSnapshoot(),this.height=t,this.update())}get Depth(){return this.depth}set Depth(t){t!==this.depth&&(this.writeSnapshoot(),this.depth=t,this.update())}get CenterPosition(){return this._center}set CenterPosition(t){t!==this.depth&&(this.writeSnapshoot(),this._center=t,this.update())}get TranslateMtx(){let[t,e,i]=[0,0,0];switch(this._center){case Zs.Center:break;case Zs.Bottom:i=this.depth/2;break;case Zs.Top:i=-this.depth/2;break;case Zs.Left:t=this.width/2;break;case Zs.Right:t=-this.width/2;break;case Zs.Front:e=-this.Height/2;break;case Zs.Back:e=this.Height/2;break;case Zs.LFB:[t,e,i]=[this.width/2,this.height/2,this.depth/2];break;case Zs.RFB:[t,e,i]=[-this.width/2,this.height/2,this.depth/2];break;case Zs.LBB:[t,e,i]=[this.width/2,-this.height/2,this.depth/2];break;case Zs.RBB:[t,e,i]=[-this.width/2,-this.height/2,this.depth/2]}return ki.y3.Translation(t,e,i)}get VertextData(){const e=`${this.width}-${this.height}-${this.depth}-${this._center}`;let i=t.VertexDataCache.get(e);return i||(i=(0,Ee.aR)({width:this.width,height:this.height,depth:this.depth}),i.transform(this.TranslateMtx),t.VertexDataCache.set(e,i)),i}writeFile(t){super.writeFile(t),t.write(1),t.write(this.width),t.write(this.height),t.write(this.depth),t.write(this._center)}readFile(t){super.readFile(t);t.read();this.width=t.read(),this.height=t.read(),this.depth=t.read(),this._center=t.read(),this.update()}},Rh.type="Box",Th=Rh))||Th;class Lh extends Er{updateMaterial(){this.RenderObject.color=zh.getColor3(this.ColorIndex)}get Points(){return[]}get Shape(){return this.Points}get AllPoints(){return this.Points}get StartPoint(){return new ki.P}get EndPoint(){return new ki.P}get MidPoint(){return new ki.P}get Length(){return 0}reverse(){return this}}var Fh,kh,jh=i(81701),Bh=i.n(jh);let Nh=Y(((kh=class extends Lh{constructor(t){super(),this.points=[],this.points=t?.points?t?.points.map(rr):[new ki.P,new ki.P(1)]}get Points(){var t;return wa()(t=this.points).call(t,rr)}get StartPoint(){return rr(this.points[0])}get EndPoint(){return rr(ta(this.points))}get Length(){var t;return Bh()(t=this.points).call(t,((t,e,i)=>0===i?0:t+ki.P.Distance(rr(this.points[i-1]),rr(e))),0)}addPoint(t){this.points.push(t),this.update(ws.Geometry)}updatePointByIndex(t,e){const i=this.points[t];return!!i&&(i.x=e.x,i.y=e.y,i.z=e.z,this.update(ws.Geometry),!0)}pop(){this.points.pop(),this.update(ws.Geometry)}initDrawObject(t){var e;const i=Yi.V.CreateLines("line"+this.Id,{points:wa()(e=this.points).call(e,(t=>rr(t))),updatable:!0},Er.Scene);return i.isNearPickable=!0,i.intersectionThreshold=1,i}updateDrawObject(t,e){if(!e)return;(0,Qa.eWS)({lines:[this.Points]}).applyToMesh(e)}writeFile(t){super.writeFile(t),t.write(1),t.write(this.points.length);for(const e of this.points)t.writeVector3(e)}readFile(t){super.readFile(t);t.read();const e=t.read();this.points.length=0;for(let i=0;i<e;i++){const e=new ki.P;t.readVector3(e),this.points.push(e)}this.update()}getDragPoints(){var t;return wa()(t=this.Points).call(t,(t=>ki.P.TransformCoordinates(t,this.Matrix)))}moveDragPoint(t,e){for(let i=0;i<this.points.length;i++)if(i===e){const e=rr(this.points[i]);e.addToRef(t,e),A()(this.points[i],hr(e));break}this.update(ws.Geometry)}}).type="Lines",Fh=kh))||Fh;var Gh,Hh;let Vh=Y(((Hh=class extends Lh{constructor(t){super(),this.start=new ki.P,this.end=new ki.P,this.start=t?.start?rr(t.start):this.start,this.end=t?.end?rr(t.end):this.end}get Points(){return[this.start,this.end]}get StartPoint(){return this.start}get EndPoint(){return this.end}get MidPoint(){return ki.P.Center(this.start,this.end)}get Length(){return ki.P.Distance(this.start,this.end)}initDrawObject(t){const e=Yi.V.CreateLines("line"+this.Id,{points:[this.start,this.end],updatable:!0},Er.Scene);return e.isNearPickable=!0,e.intersectionThreshold=1,e}updateDrawObject(t,e){e&&Yi.V.CreateLines("line"+this.Id,{points:[this.start,this.end],updatable:!0,instance:e},Er.Scene)}reverse(){return[this.start,this.end]=[this.end,this.start],this}writeFile(t){super.writeFile(t),t.write(1)}readFile(t){super.readFile(t),this.update()}getDragPoints(){var t;return wa()(t=this.Points).call(t,(t=>ki.P.TransformCoordinates(t,this.Matrix)))}moveDragPoint(t,e){}}).type="Line",Gh=Hh))||Gh;var Zh,Wh;i(74370);let Uh=Y(((Wh=class extends Lh{constructor(t){var e;(super(),this._name="\u591a\u6bb5\u7ebf",this.dataList=[],t?.dataList)&&(this.dataList=wa()(e=t.dataList).call(e,(t=>this.toPolylineData(t))))}get Vertices(){return[...this.dataList]}get VertexCount(){return this.dataList.length}get Points(){var t;let e=[];return b()(t=this.dataList).call(t,((t,i)=>{if(i>0){const s=this.dataList[i-1].pt,a=t.pt,r=Ba(s,a,this.dataList[i-1].bulge);e=t.bulge?[...e,...Jt.j_.ArcThru3Points(new ki.P(s.x,0,s.y),new ki.P(r.x,0,r.y),new ki.P(a.x,0,a.y)).getPoints()]:[...e,new ki.P(r.x,0,r.y),new ki.P(a.x,0,a.y)]}else e.push(new ki.P(t.pt.x,0,t.pt.y))})),e}get Shape(){let t=[];for(let e=0;e<this.dataList.length-1;e++){const i=this.dataList[e],s=this.dataList[e+1],a=i.pt,r=s.pt;if(Ps(i.bulge,0))t.push(new ki.P(a.x,0,a.y));else{const e=Ba(a,r,i.bulge),s=Jt.j_.ArcThru3Points(new ki.P(a.x,0,a.y),new ki.P(e.x,0,e.y),new ki.P(r.x,0,r.y)).getPoints();s.pop(),t.push(...s)}e+1===this.dataList.length-1&&t.push(new ki.P(r.x,0,r.y))}return t}get AllPoints(){var t;return wa()(t=this.Shape).call(t,(t=>ki.P.TransformCoordinates(t,this.Matrix)))}initDrawObject(t=Us.Wireframe){const e=Yi.V.CreateLines(this.UniqueName,{points:this.Shape,updatable:!0},Er.Scene);return e.isNearPickable=!0,e.intersectionThreshold=1,e}updateDrawObject(t,e){if(!e)return;(0,Qa.eWS)({lines:[this.Shape]}).applyToMesh(e)}writeFile(t){super.writeFile(t),t.write(1),t.writeAnyArray(this.dataList,(e=>{t.write(e.pt.x),t.write(e.pt.y),t.write(e.bulge)}))}readFile(t){super.readFile(t),t.read(),t.readAnyArray((()=>{const e={pt:new ki.FM,bulge:0};e.pt.x=t.read(),e.pt.y=t.read(),e.bulge=t.read(),this.dataList.push(e)})),this.update()}appendVertex(...t){this.dataList.push(...wa()(t).call(t,(t=>this.toPolylineData(t)))),this.update()}updateVertexAt(t,e){const i=[...this.dataList];i[t]&&(st()(i).call(i,t,1,this.toPolylineData(e)),this.dataList=i,this.update())}removeVertexAt(t){var e;this.dataList.at(t)&&(st()(e=this.dataList).call(e,t,1),this.update())}toPolylineData(t){return{pt:new ki.FM(t.pt.x,t.pt.y),bulge:t.bulge}}}).type="Polyline",Zh=Wh))||Zh;var Kh,Yh;let qh=Y(((Yh=class extends Dh{constructor(t={diameter:1,arc:1}){super(),this._name="\u7403",this.diameter=10,this.arc=10,this.diameter=t.diameter??this.diameter,this.arc=t.arc??this.arc}get Diameter(){return this.diameter}set Diameter(t){t!==this.diameter&&(this.writeSnapshoot(),this.diameter=t,this.update())}get VertextData(){return(0,Me.jY)({diameter:this.diameter,arc:this.arc})}writeFile(t){super.writeFile(t),t.write(1),t.write(this.diameter),t.write(this.arc)}readFile(t){super.readFile(t);t.read();this.diameter=t.read(),this.arc=t.read(),this.update()}}).type="Sphere",Kh=Yh))||Kh;var Xh,$h;let Qh=Y((($h=class extends Dh{constructor(t={diameterTop:10,diameterBottom:10,height:10,arc:10}){super(),this._name="\u5706\u67f1",this.diameterTop=10,this.diameterBottom=10,this.height=10,this.tessellation=void 0,this.arc=10,this.diameterTop=t.diameterTop??10,this.diameterBottom=t.diameterBottom??10,this.height=t.height??10,this.arc=t.arc??10}get DiameterTop(){return this.diameterTop}set DiameterTop(t){t!==this.diameterTop&&(this.writeSnapshoot(),this.diameterTop=t,this.update())}get DiameterBottom(){return this.diameterBottom}set DiameterBottom(t){t!==this.diameterBottom&&(this.writeSnapshoot(),this.diameterBottom=t,this.update())}get Height(){return this.height}set Height(t){t!==this.height&&(this.writeSnapshoot(),this.height=t,this.update())}get Tessellation(){return this.tessellation}set Tessellation(t){t!==this.tessellation&&(this.writeSnapshoot(),this.tessellation=t,this.update())}get VertextData(){return(0,Ie.zD)({diameterTop:this.diameterTop,diameterBottom:this.diameterBottom,height:this.height,arc:this.arc,tessellation:this.tessellation})}writeFile(t){super.writeFile(t),t.write(1),t.write(this.diameterTop),t.write(this.diameterBottom),t.write(this.height),t.write(this.tessellation),t.write(this.arc)}readFile(t){super.readFile(t);t.read();this.diameterTop=t.read(),this.diameterBottom=t.read(),this.height=t.read(),this.tessellation=t.read(),this.arc=t.read(),this.update()}}).type="Cylinder",Xh=$h))||Xh;var Jh,tl;let el=Y(((tl=class extends Dh{constructor(t){super(),this._name="\u5e73\u9762",this.width=10,this.height=10,this.width=t?.width??this.width,this.height=t?.height??this.height}get Width(){return this.width}set Width(t){t!==this.width&&(this.writeSnapshoot(),this.width=t,this.update())}get Height(){return this.height}set Height(t){t!==this.height&&(this.writeSnapshoot(),this.height=t,this.update())}get VertextData(){return(0,Oe.Hq)({width:this.width,height:this.height})}writeFile(t){super.writeFile(t),t.write(1),t.write(this.width),t.write(this.height)}readFile(t){super.readFile(t);t.read();this.width=t.read(),this.height=t.read(),this.update()}}).type="Plane",Jh=tl))||Jh;var il,sl;let al=Y(((sl=class extends Dh{constructor(t={radius:1,radiusTop:void 0,radiusBottom:void 0,height:1,subdivisions:2,tessellation:2,capSubdivisions:6}){super(),this.radius=void 0,this.radiusTop=void 0,this.radiusBottom=void 0,this.height=void 0,this.subdivisions=20,this.tessellation=16,this.capSubdivisions=6,this.topCapSubdivisions=void 0,this.bottomCapSubdivisions=void 0,this.height=t.height??20,this.radius=t.radius??5,this.subdivisions=t.subdivisions??2,this.tessellation=t.tessellation??16,this.capSubdivisions=t.capSubdivisions??6,this.radiusTop=t.radiusTop,this.radiusBottom=t.radiusBottom,this.topCapSubdivisions=t.topCapSubdivisions,this.bottomCapSubdivisions=t.bottomCapSubdivisions}get Radius(){return this.radius}set Radius(t){t!==this.radius&&(this.writeSnapshoot(),this.radius=t,this.update())}get RadiusTop(){return this.radiusTop}set RadiusTop(t){t!==this.radiusTop&&(this.writeSnapshoot(),this.radiusTop=t,this.update())}get RadiusBottom(){return this.radiusBottom}set RadiusBottom(t){t!==this.radiusBottom&&(this.writeSnapshoot(),this.radiusBottom=t,this.update())}get CapSubdivisions(){return this.capSubdivisions}set CapSubdivisions(t){t!==this.capSubdivisions&&(this.writeSnapshoot(),this.capSubdivisions=t,this.update())}get TopCapSubdivisions(){return this.topCapSubdivisions}set TopCapSubdivisions(t){t!==this.topCapSubdivisions&&(this.writeSnapshoot(),this.topCapSubdivisions=t,this.update())}get BottomCapSubdivisions(){return this.bottomCapSubdivisions}set BottomCapSubdivisions(t){t!==this.bottomCapSubdivisions&&(this.writeSnapshoot(),this.bottomCapSubdivisions=t,this.update())}get Height(){return this.height}set Height(t){t!==this.height&&(this.writeSnapshoot(),this.height=t,this.update())}get Subdivisions(){return this.subdivisions}set Subdivisions(t){t!==this.subdivisions&&(this.writeSnapshoot(),this.subdivisions=t,this.update())}get Tessellation(){return this.tessellation}set Tessellation(t){t!==this.tessellation&&(this.writeSnapshoot(),this.tessellation=t,this.update())}get VertextData(){return(0,Ae.VF)({radius:this.radius,radiusTop:this.radiusTop,radiusBottom:this.radiusBottom,height:this.height,subdivisions:this.subdivisions,tessellation:this.tessellation,capSubdivisions:this.capSubdivisions,topCapSubdivisions:this.topCapSubdivisions,bottomCapSubdivisions:this.bottomCapSubdivisions})}writeFile(t){super.writeFile(t),t.write(1),t.write(this.radius),t.write(this.height),t.write(this.subdivisions),t.write(this.tessellation),t.write(this.capSubdivisions),t.write(this.radiusTop),t.write(this.radiusBottom),t.write(this.topCapSubdivisions),t.write(this.bottomCapSubdivisions)}readFile(t){super.readFile(t);t.read();this.radius=t.read(),this.height=t.read(),this.subdivisions=t.read(),this.tessellation=t.read(),this.capSubdivisions=t.read(),this.radiusTop=t.read(),this.radiusBottom=t.read(),this.topCapSubdivisions=t.read(),this.bottomCapSubdivisions=t.read(),this.update()}}).type="Capsule",il=sl))||il;var rl,nl;let ol=Y(((nl=class extends Dh{constructor(t={diameter:1,tessellation:2,thickness:.1}){super(),this.diameter=1,this.tessellation=void 0,this.thickness=.1,this.diameter=t.diameter??1,this.tessellation=t.tessellation??32,this.thickness=t.thickness??.1}get Diameter(){return this.diameter}set Diameter(t){t!==this.diameter&&(this.writeSnapshoot(),this.diameter=t,this.update())}get Tthickness(){return this.thickness}set Tthickness(t){t!==this.thickness&&(this.writeSnapshoot(),this.thickness=t,this.update())}get Tessellation(){return this.tessellation}set Tessellation(t){t!==this.tessellation&&(this.writeSnapshoot(),this.tessellation=t,this.update())}get VertextData(){return(0,ze.h5)({diameter:this.diameter,tessellation:this.tessellation,thickness:this.thickness})}writeFile(t){super.writeFile(t),t.write(1),t.write(this.diameter),t.write(this.thickness),t.write(this.tessellation)}readFile(t){super.readFile(t);t.read();this.diameter=t.read(),this.thickness=t.read(),this.tessellation=t.read(),this.update()}}).type="Torus",rl=nl))||rl;var hl,ll;let cl=Y(((ll=class extends Dh{constructor(t){super(),this._name="\u5730\u9762",this.width=10,this.height=10,this.onlyGround=!1,this.width=t?.width??this.width,this.height=t?.height??this.height}get Width(){return this.width}set Width(t){t!==this.width&&(this.writeSnapshoot(),this.width=t,this.update(ws.Geometry))}get Height(){return this.height}set Height(t){t!==this.height&&(this.writeSnapshoot(),this.height=t,this.update(ws.Geometry))}get VertextData(){return(0,Pe.kt)({width:this.width,height:this.height})}loadGroundImage(t,e=!0){let i;this.onlyGround=!0,i="string"==typeof t?new Fi.x(t,this.Scene):Fi.x.LoadFromDataString("ground-image",t,this.Scene);const s=new Oi.K("ground-image-mtl",this.Scene);return s.specularColor=xi.Wo.Black(),s.diffuseTexture=i,s.backFaceCulling=!1,i.vAng=Math.PI,i.wAng=Math.PI,new(N())((t=>{i.onLoadObservable.addOnce((i=>{const a=i.getSize();e&&(this.width=a.width,this.Height=a.height),this.RenderObject.material=s,s.freeze(),t(this)}))}))}updateMaterial(t,e){this.onlyGround||super.updateMaterial(t,e)}writeFile(t){super.writeFile(t),t.write(1),t.write(this.width),t.write(this.height)}readFile(t){super.readFile(t);t.read();this.width=t.read(),this.height=t.read(),this.update()}}).type="Ground",hl=ll))||hl;var dl,ul,pl,ml,gl,_l=i(63784);let wl=(dl=class extends Er{constructor(...t){super(...t),this.isLight=!0,(0,vs.Z)(this,"Intensity",ul,this),(0,vs.Z)(this,"Diffuse",pl,this),(0,vs.Z)(this,"Specular",ml,this),(0,vs.Z)(this,"VisiableHelper",gl,this),this._bias=1e-4,this._normalBias=0,this._filteringQuality=xe.uX.QUALITY_MEDIUM,this._darkness=0,this._color="#ffffff",this.helper=void 0,this._shadowGenerator=void 0}get HasShadowGenerator(){return!!this._shadowGenerator}get Color(){return this._color}set Color(t){t!==this._color&&(this.writeSnapshoot(),this._color=t,this.update())}get Bias(){return this._bias}set Bias(t){t!==this._bias&&(this.writeSnapshoot(),this._bias=t,this.updateShadowCaster())}get NormalBias(){return this._normalBias}set NormalBias(t){t!==this._normalBias&&(this.writeSnapshoot(),this._normalBias=t,this.updateShadowCaster())}get Darkness(){return this._darkness}set Darkness(t){t!==this._darkness&&(this.writeSnapshoot(),this._darkness=t,this.updateShadowCaster())}get FilteringQuality(){return this._filteringQuality}set FilteringQuality(t){t!==this._filteringQuality&&(this.writeSnapshoot(),this._filteringQuality=t,this.updateShadowCaster())}addShadowCaster(t){if(this._shadowGenerator){for(const e of t)if(e.Visiable&&e.EnableShadow){const t=e.DrawObject.getChildMeshes();for(const e of t)this._shadowGenerator.addShadowCaster(e)}this.updateShadowCaster()}}updateShadowCaster(){this._shadowGenerator&&(this._shadowGenerator.filteringQuality=this._filteringQuality,this._shadowGenerator.bias=this._bias,this._shadowGenerator.normalBias=this._normalBias,this._shadowGenerator.darkness=this._darkness,this._shadowGenerator.getShadowMap().resetRefreshCounter())}removeShadowCaster(t){if(this._shadowGenerator)if(t)for(const e of t){const t=e.DrawObject.getChildMeshes();for(const e of t)this._shadowGenerator.removeShadowCaster(e)}else{var e;const t=Z()(e=this._shadowGenerator.getShadowMap().renderList).call(e);for(const e of t)this._shadowGenerator.removeShadowCaster(e)}}writeFile(t){super.writeFile(t),t.write(3),t.write(this.Intensity),t.write(this.Diffuse),t.write(this.Specular),t.write(this.HasShadowGenerator),this.HasShadowGenerator&&(t.write(this._bias),t.write(this._normalBias),t.write(this._darkness),t.write(this._filteringQuality))}readFile(t){super.readFile(t);const e=t.read();if(this.Intensity=t.read(),e>1&&(this.Diffuse=t.read(),this.Specular=t.read()),e>2){t.read()&&(this._bias=t.read(),this._normalBias=t.read(),this._darkness=t.read(),this._filteringQuality=t.read())}}initShadowGenerator(t){this._shadowGenerator=new xe.uX(2048,t,!0),this._shadowGenerator.useExponentialShadowMap=!1,this._shadowGenerator.usePercentageCloserFiltering=!0,this._shadowGenerator.filteringQuality=xe.uX.QUALITY_MEDIUM,this._shadowGenerator.getShadowMap().refreshRate=_l._.REFRESHRATE_RENDER_ONCE,this.updateShadowCaster()}createHelper(t){if(zr.MainViewer.IsPreview)return;const e=this.getHelper();e&&(e.parent=t)}getHelper(){return null}updateHelper(t){}},ul=(0,xs.Z)(dl.prototype,"Intensity",[ao],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pl=(0,xs.Z)(dl.prototype,"Diffuse",[ao],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"#ffffff"}}),ml=(0,xs.Z)(dl.prototype,"Specular",[ao],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"#ffffff"}}),gl=(0,xs.Z)(dl.prototype,"VisiableHelper",[ao],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dl);var yl,bl,fl,vl;let xl=Y((vl=class extends wl{constructor(...t){super(...t),this._name="\u70b9\u5149\u6e90",(0,vs.Z)(this,"Range",fl,this)}initDrawObject(t=Us.Conceptual){const e=new Ki.Kj(this.UniqueName+"_root",Er.Scene),i=new ve.c(this.UniqueName,ki.P.Zero(),Er.Scene);return i.parent=e,this.createHelper(e),this.initShadowGenerator(i),e}updateDrawObject(t,e){if(!e||0===e.getChildren().length)return;const i=e.getChildren()[0];i.diffuse=zh.getColor3fromHex(this.Diffuse),i.specular=zh.getColor3fromHex(this.Specular),i.intensity=this.Intensity,i.range=this.Range,this.updateHelper(e.getChildren()[1])}writeFile(t){super.writeFile(t),t.write(2),t.write(this.Range)}readFile(t){super.readFile(t);t.read();this.Range=t.read(),this.update()}getHelper(){return Yi.V.CreateSphere("helper_"+this.UniqueName,{diameter:.5},Er.Scene)}updateHelper(t){t&&t.setEnabled(this.VisiableHelper)}},vl.type="PointLight",bl=vl,fl=(0,xs.Z)(bl.prototype,"Range",[ao],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),yl=bl))||yl;var Sl,Ml;let Ol=Y((Ml=class extends wl{constructor(...t){super(...t),this._dir=[1,1,1],this._name="\u5168\u5c40\u5149"}initDrawObject(t){const e=new Ki.Kj(this.UniqueName,Er.Scene),i=new Hi.e(this.UniqueName+"-1",ki.P.FromArray(this._dir),Er.Scene);return i.parent=e,i.diffuse=xi.Wo.FromHexString(this.Color),e}updateDrawObject(t,e){if(!e||0===e.getChildren().length)return;const i=e.getChildren()[0];i.intensity=this.Intensity,i.direction.fromArray(this._dir),i.diffuse=xi.Wo.FromHexString(this.Color)}readFile(t){super.readFile(t),this.update()}},Ml.type="HemisphericLight",Sl=Ml))||Sl;var Pl,Cl,Al,El,zl,Dl,Tl;const Rl=100;let Il=Y((Tl=class extends wl{constructor(...t){super(...t),this._name="\u5c04\u706f",this.gizmo=void 0,this.points=[],(0,vs.Z)(this,"Range",Al,this),(0,vs.Z)(this,"Height",El,this),(0,vs.Z)(this,"Direction",zl,this),(0,vs.Z)(this,"Angle",Dl,this)}get BDirection(){return rr(this.Direction)}get Points(){return[new ki.P(0,0,this.Height/2),new ki.P(0,0,this.Range)]}get Radius(){return this.Height*Math.tan(this.Angle/2)}initDrawObject(){const t=new Ki.Kj(this.UniqueName+"_root",Er.Scene),e=new Je.P(this.UniqueName,ki.P.Zero(),this.BDirection,this.Angle,2,Er.Scene);return e.parent=t,e.diffuse=zh.getColor3(this.ColorIndex),e.intensity=this.Intensity,e.range=this.Range,this.initShadowGenerator(e),this.createHelper(t),t}updateDrawObject(t,e){const i=e.getChildren(),s=i[0];s.intensity=this.Intensity,s.range=this.Range,s.direction.copyFrom(this.BDirection),s.diffuse=zh.getColor3fromHex(this.Diffuse),s.specular=zh.getColor3fromHex(this.Specular),s.angle=this.Angle,this.updateHelper(i[1])}getDragPoints(){var t;const e=this.RenderObject.getChildren()[1];return wa()(t=this.Points).call(t,(t=>{let i=ki.P.TransformCoordinates(t,e.getWorldMatrix());return this.points.push(i),i}))}moveDragPoint(t,e){const i=this.points[e];i.addToRef(t,i),0===e?this.Direction=hr(i.subtract(this._position).normalize()):this.Range=ki.P.Distance(i,this._position)}writeFile(t){super.writeFile(t),t.write(1),t.write(this.Range),t.writeVector3(this.Direction),t.write(this.Angle)}readFile(t){super.readFile(t);t.read();this.Range=t.read(),t.readVector3(this.Direction),this.Angle=t.read(),this.update()}destory(){super.destory(),this.gizmo&&this.gizmo.dispose()}getHelper(){const t=new ji.Y("root"),e=[],i=xi.Wo.Green();let s=Yi.V.CreateLines("lines",{points:[new ki.P,new ki.P],updatable:!0},Er.Scene);s.color=i,s.isPickable=!1;const a=Yi.V.CreateSphere("light_helper_range",{diameter:.5},Er.Scene);let r=new qi.x(Er.Scene),n=new Wn(new ki.P(0,0,1),zh.getColor3(2),r);this.gizmo=n,n.updateGizmoPositionToMatchAttachedMesh=!0;const o=n.dragBehavior;o.dragDeltaRatio=1,o.onDragObservable.add((t=>{let e=ki.P.Distance(t.dragPlanePoint,this._position);e=e>Rl?Rl:e,this.Height=Rl-e;let i=e/Rl*180;this.Angle=i*(Math.PI/180)})),n.attachedMesh=a;const h=Yi.V.CreateLines("lines",{points:cs()({length:33},(()=>new ki.P)),updatable:!0},Er.Scene);h.color=i;let l=Yi.V.CreateLines("lines",{points:[new ki.P,new ki.P,new ki.P],updatable:!0},Er.Scene);l.color=i,l.isPickable=!1;let c=Yi.V.CreateLines("lines",{points:[new ki.P,new ki.P,new ki.P],updatable:!0},Er.Scene);return c.color=i,c.isPickable=!1,e.push(s,a,h,l,c),b()(e).call(e,(e=>{e.parent=t})),t}updateHelper(t){if(!t)return;t.setEnabled(this.VisiableHelper);const e=t.getChildren(),i=e[0];Yi.V.CreateLines("lines",{points:[new ki.P,new ki.P(0,0,this.Range)],instance:i});e[1].position.z=this.Height/2;const s=e[2];s.position.z=this.Height;const a=this.Radius,r=Jt.j_.ArcThru3Points(new ki.P(a),new ki.P(0,a),new ki.P(-a),32,!0,!0);Yi.V.CreateLines(null,{points:r.getPoints(),instance:s});const n=e[3];Yi.V.CreateLines(null,{instance:n,points:[new ki.P(-a,0,this.Height),new ki.P,new ki.P(a,0,this.Height)],updatable:!0});const o=e[4];Yi.V.CreateLines(null,{instance:o,points:[new ki.P(0,a,this.Height),new ki.P,new ki.P(0,-a,this.Height)],updatable:!0}),t.lookAt(this.BDirection)}},Tl.type="SpotLight",Cl=Tl,Al=(0,xs.Z)(Cl.prototype,"Range",[ao],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 150}}),El=(0,xs.Z)(Cl.prototype,"Height",[ao],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),zl=(0,xs.Z)(Cl.prototype,"Direction",[ao],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:0,y:-1,z:0}}}),Dl=(0,xs.Z)(Cl.prototype,"Angle",[ao],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Math.PI/3}}),Pl=Cl))||Pl;var Ll,Fl,kl,jl;let Bl=Y((jl=class extends wl{constructor(...t){super(...t),this._name="\u65b9\u5411\u5149",this._position=new ki.P(0,100),(0,vs.Z)(this,"Direction",kl,this)}get BDirection(){return rr(this.Direction)}initDrawObject(){const t=new Ki.Kj(this.UniqueName+"_root",Er.Scene),e=new Se.O(this.UniqueName,this.BDirection,Er.Scene);return e.parent=t,e.autoCalcShadowZBounds=!0,this.initShadowGenerator(e),this.createHelper(t),t}updateDrawObject(t,e){const i=e.getChildren(),s=i[0];s.direction=this.BDirection,s.diffuse=zh.getColor3fromHex(this.Diffuse),s.specular=zh.getColor3fromHex(this.Specular),s.intensity=this.Intensity,this.updateHelper(i[1]),this.updateShadowCaster()}getDragPoints(){return[]}moveDragPoint(t){this.Direction=hr(t.subtract(this.RenderObject.absolutePosition).normalize())}writeFile(t){super.writeFile(t),t.write(1),t.writeVector3(this.Direction)}readFile(t){super.readFile(t);t.read();t.readVector3(this.Direction),this.update()}getHelper(){const t=new ji.Y("root"),e=Yi.V.CreateCylinder("light_helper",{diameterBottom:0,diameterTop:5,height:10},Er.Scene);e.parent=t,e.rotation.x=-Math.PI/2;let i=Yi.V.CreateLines("lines",{points:[new ki.P(0,0,-500),new ki.P(0,0,500)]},Er.Scene);return i.color=xi.Wo.Green(),i.isPickable=!1,i.parent=t,t}updateHelper(t){t&&(t.setEnabled(this.VisiableHelper),t.lookAt(this.BDirection))}},jl.type="DirectionalLight",Fl=jl,kl=(0,xs.Z)(Fl.prototype,"Direction",[ao],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:-1,y:-1,z:-1}}}),Ll=Fl))||Ll;var Nl,Gl,Hl,Vl;let Zl=Y(((Vl=class extends Dh{constructor(t){super(),this._curve=void 0,(0,vs.Z)(this,"Radius",Hl,this),this.Radius=t?.radius??10,this._curve=t?.curve??new Nh}get Curve(){return this._curve}initDrawObject(t=Us.Conceptual){return(0,te._)(this.UniqueName,{path:this._curve.Points,sideOrientation:Ki.Kj.DOUBLESIDE,updatable:!0},Er.Scene)}updateDrawObject(t,e){(0,te._)(this.UniqueName,{path:this._curve.Points,instance:e})}morph(t,e=.01){if(!t)return;const i=this._curve.Points;let s=0,a=!1;const r=wa()(i).call(i,(t=>t.clone())),n=()=>{a||(t(r,s),(0,te._)(null,{path:r,instance:this.RenderObject}),s+=e)};return Er.Scene.registerBeforeRender(n),{stop:()=>{Er.Scene.unregisterBeforeRender(n),this.update()},pause:()=>{a=!0},restart:()=>{a=!1}}}writeFile(t){super.writeFile(t),t.write(1)}readFile(t){super.readFile(t),t.read(),this.update()}}).type="Tube",Gl=Vl,Hl=(0,xs.Z)(Gl.prototype,"Radius",[ro],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Nl=Gl))||Nl;var Wl=i(86230),Ul=i(4517),Kl=i.n(Ul);class Yl{constructor(t){this.left=0,this.width=1,this.height=1,this.position=ki.P.Zero(),this.url="",this.left=t?.left??0,this.width=t?.width??1,this.height=t?.height??1}fromJSON(t){this.left=t?.left??this.left,this.width=t?.width??this.width,this.height=t?.height??this.height}writeFile(t){t.write(1),t.write(this.left),t.write(this.width),t.write(this.height)}readFile(t){t.read(),this.left=t.read(),this.width=t.read(),this.height=t.read()}}Yl.type="Door";const ql=function(t,e){return t.left-e.left};class Xl{constructor(t){this.left=0,this.bottom=0,this.width=1,this.height=1,this.position=ki.P.Zero(),this.url="",this.left=t?.left??0,this.bottom=t?.bottom??0,this.width=t?.width??1,this.height=t?.height??1}fromJSON(t){this.left=t?.left??0,this.bottom=t?.bottom??0,this.width=t?.width??1,this.height=t?.height??1}writeFile(t){t.write(1),t.write(this.left),t.write(this.bottom),t.write(this.width),t.write(this.height)}readFile(t){t.read(),this.left=t.read(),this.bottom=t.read(),this.width=t.read(),this.height=t.read()}}Xl.type="Win";class $l{constructor(t=new ki.P){this.corner=void 0,this.doors=[],this.windows=[],this.corner=t}writeFile(t){t.write(1),t.writeVector3(this.corner),t.writeAnyArray(this.doors,t.writeObject),t.writeAnyArray(this.windows,t.writeObject)}readFile(t){t.read(),t.readVector3(this.corner),t.readAnyArrayAndPush(this.doors,(()=>t.readObject(new Yl))),t.readAnyArrayAndPush(this.windows,(()=>t.readObject(new Xl)))}}var Ql,Jl;$l.type="WallPlane",window.earcut=Kl();let tc=Y((Jl=class extends Dh{constructor(t){var e;(super(),this._thickness=2,this._height=10,this.walls=[],this.options={interiorUV:new ki.Lt(0,0,1,1),exteriorUV:new ki.Lt(0,0,1,1),interiorColor:new xi.HE(1,1,1,1),outeriorColor:new xi.HE(1,1,1,1),exteriorColor:new xi.HE(1,1,1,1),interior:!1},this._outerOutline=[],this._innerOutline=[],this._name="\u5899",t?.outline)&&(this.walls=wa()(e=t.outline).call(e,(t=>new $l(new ki.P(t.x,t.y,t.z)))),!this.options.interior&&this.walls.length>2&&!this.walls[0].corner.equalsWithEpsilon(ta(this.walls).corner)&&this.walls.push(this.walls[0]));t?.height&&(this._height=t.height),t?.thickness&&(this._thickness=t.thickness)}get VertextData(){return this.build()}get Thickness(){return this._thickness}set Thickness(t){t!==this._thickness&&(this.writeSnapshoot(),this._thickness=t,this.update(ws.Geometry))}get Height(){return this._height}set Height(t){t!==this._height&&(this.writeSnapshoot(),this._height=t,this.update(ws.Geometry))}addWindowOrDoorByPosition(t,e=!1){for(let i=0;i<this.walls.length-1;i++){let s=this.walls[i].corner,a=this.walls[i+1].corner,r=new ki.FM(s.x,s.z);const n=Ya(r,new ki.FM(a.x,a.z),new ki.FM(t.x,t.z));if(Ps(n.dist,this._thickness)){e?this.addDoor(i,{left:ki.FM.Distance(n.closestPt,r),width:ki.P.Distance(s,a)/8,height:t.y}):this.addWindow(i,{left:ki.FM.Distance(n.closestPt,r),width:ki.P.Distance(s,a)/10,height:this._height/10,bottom:t.y}),this.update(ws.Geometry);break}}}initDrawObject(t=Us.Conceptual){return super.initDrawObject(t)}updateDrawObject(t,e){var i;(super.updateDrawObject(t,e),e)&&(b()(i=e.getChildren()).call(i,(t=>t.dispose())),this.updateWinsAndDoors(e),this.updateGround(e))}updateMaterial(t,e){super.updateMaterial(t,e);const i=(e??this.RenderObject).getChildMeshes();for(const t of i){const e=this._materialMap.get(t.id);e?e.Object?.Material&&(t.metadata={oldMtl:t.material},t.material=e.Object.Material):t.metadata?.oldMtl&&(t.material=t.metadata.oldMtl)}}addWindow(t,e){this.walls[t].windows.push(new Xl(e))}addDoor(t,e){this.walls[t].doors.push(new Yl(e))}updateWinsAndDoors(t){for(let e=0;e<this.walls.length-1;e++){const i=this.walls[e],s=this.walls[e+1].corner.subtract(i.corner).normalize(),a=s.cross(oe.RD.Y),r=new ki.y3;ki.y3.FromXYZAxesToRef(s,oe.RD.Y,a,r);for(const e of i.windows){const s=new ki.P(e.left+e.width/2,e.bottom+e.height/2,-this._thickness);ki.P.TransformCoordinatesToRef(s,r,s);const a=Yi.V.CreatePlane("\u7a97\u6237",{width:e.width,height:e.height,sideOrientation:Ki.Kj.DOUBLESIDE},t.getScene());a.metadata={win:e},a.parent=t;r.clone().setTranslation(i.corner.add(s)).decomposeToTransformNode(a),a.visibility=.8}for(const e of i.doors){const s=new ki.P(e.left+e.width/2,e.height/2,-this._thickness);ki.P.TransformCoordinatesToRef(s,r,s);const a=Yi.V.CreatePlane("\u95e8",{width:e.width,height:e.height,sideOrientation:Ki.Kj.DOUBLESIDE},t.getScene());a.metadata={door:e},a.parent=t;r.clone().setTranslation(i.corner.add(s)).decomposeToTransformNode(a),a.visibility=.2}}}updateGround(t){const e=this._innerOutline;if(e.length>0){new Wl.z("\u5730\u677f",wa()(e).call(e,(t=>new ki.FM(t.x,t.z))),Er.Scene).build().parent=t}}build(){const{outerBaseCorners:t,innerBaseCorners:e}=this.getInOutContours(),{innerTopCorners:i,outerTopCorners:s}=this.getTBContours(t,e);return this._outerOutline=t,this._innerOutline=e,this.generateWallVetexData(t,e,i,s)}removeWinOrDoor(t){for(const s of this.walls){var e,i;if(t instanceof Xl){if(vt()(e=s.windows).call(e,t)){ea(s.windows,t);break}}else if(vt()(i=s.doors).call(i,t)){ea(s.doors,t);break}}this.update()}writeFile(t){super.writeFile(t),t.write(1),t.write(this.Height),t.write(this.Thickness),t.writeAnyArray(this.walls,t.writeObject)}readFile(t){super.readFile(t);t.read();this._height=t.read(),this._thickness=t.read(),t.readAnyArrayAndPush(this.walls,(()=>t.readObject(new $l))),this.update()}generateWallVetexData(t,e,i,s){let a=[],r=[],n=[],o=[];const h=this._thickness;let l,c=this.options.interiorUV,d=this.options.exteriorUV,u=this.options.interiorColor,p=this.options.exteriorColor;const m=this.walls.length,g=this.walls;let _,w,y,f=this._height,v=this._height,x=[],S=[],M=[],O=[],P=0;for(let t=0;t<this.walls.length-1;t++)P=Math.max(e[t+1].subtract(e[t]).length(),P);let C,A,E,z,D,T,R,I=ki.P.Zero(),L=ki.P.Zero();for(let W=0;W<m-1;W++){var F,k,j,B,N,G,H;const U=g[W],K=g[W+1];var V;if(K.corner.subtractToRef(U.corner,I),C=I.length(),I.normalize(),L.x=I.z,L.z=-1*I.x,A=t[W+1].subtract(t[W]).length(),R=A-C,U.doors)dt()(V=U.doors).call(V,ql);let Y=U.doors.length;_=[],_.push(new ki.FM(0,0));for(let t=0;t<Y;t++)_.push(new ki.FM(U.doors[t].left,0)),_.push(new ki.FM(U.doors[t].left,U.doors[t].height)),_.push(new ki.FM(U.doors[t].left+U.doors[t].width,U.doors[t].height)),_.push(new ki.FM(U.doors[t].left+U.doors[t].width,0));_.push(new ki.FM(C,0)),_.push(new ki.FM(C,f)),_.push(new ki.FM(0,f)),w=new Wl.z("\u5899\u4f53\u6784\u5efa",_,Er.Scene,Kl());let q=U.windows.length,X=[];for(let t=0;t<q;t++){const e=U.windows[t];let i=[];i.push(new ki.FM(e.left,e.bottom)),i.push(new ki.FM(e.left+e.width,e.bottom)),i.push(new ki.FM(e.left+e.width,e.height+e.bottom)),i.push(new ki.FM(e.left,e.height+e.bottom)),X.push(i)}for(let t=0;t<X.length;t++)w.addHole(X[t]);y=this.wallBuilder(w,U,K);let $=a.length/3;b()(F=w._points.elements).call(F,(function(t){D=c.x+t.x*(c.z-c.x)/P,T=c.y+t.y*(c.w-c.y)/f,n.push(D,T),o.push(u.r,u.g,u.b,u.a)})),a.push(...y.positions),r.push(...wa()(k=y.indices).call(k,(t=>t+$))),l=a.length/3,z=Z()(j=y.positions).call(j,12*(Y+1)),E=Z()(B=y.positions).call(B,3,3*(4*Y+1));let Q=[],J=[];for(let t=0;t<E.length/12;t++){let e=[],i=[];for(let s=0;s<4;s++){let a=3*s+12*t,r=3*s+12*t+1,n=3*s+12*t+2;e.push(new ki.P(E[a],E[r],E[n])),E[a]+=h*L.x,E[n]+=h*L.z,i.push(new ki.P(E[a],E[r],E[n]))}Q.push(e),J.push(i)}x.push(Q),S.push(J);let tt=[],et=[];for(let t=0;t<z.length/12;t++){let e=[],i=[];for(let s=0;s<4;s++){let a=3*s+12*t,r=3*s+12*t+1,n=3*s+12*t+2;e.push(new ki.P(z[a],z[r],z[n])),z[3*s+12*t]+=h*L.x,z[n]+=h*L.z,i.push(new ki.P(z[a],z[r],z[n]))}tt.push(e),et.push(i)}M.push(tt),O.push(et),y.positions=[],y.positions.push(t[W].x,t[W].y,t[W].z),y.positions.push(...E),y.positions.push(t[W+1].x,t[W+1].y,t[(W+1)%m].z),y.positions.push(s[W+1].x,s[W+1].y,s[(W+1)%m].z),y.positions.push(s[W].x,s[W].y,s[W].z),y.positions.push(...z),b()(N=w._points.elements).call(N,(function(t){D=0===t.x?d.x:C-t.x<1e-6?d.x+(R+t.x)*(d.z-d.x)/(P+R):d.x+(.5*R+t.x)*(d.z-d.x)/(P+R),T=d.y+t.y*(d.w-d.y)/f,n.push(D,T)})),$=a.length/3,a.push(...y.positions),Wo()(G=y.indices).call(G),r.push(...wa()(H=y.indices).call(H,(t=>t+$)));let it=Y,st=0;for(it>0&&($=a.length/3,a.push(e[W].x,e[W].y,e[W].z),a.push(t[W].x,t[W].y,t[W].z),a.push(x[W][st][0].x,x[W][st][0].y,x[W][st][0].z),a.push(S[W][st][0].x,S[W][st][0].y,S[W][st][0].z),n.push(d.x,d.y+(d.w-d.y)*h/v),n.push(d.x,d.y),n.push(d.x+(d.z-d.x)*U.doors[st].left/P,d.y+(d.w-d.y)*h/v),n.push(d.x+(d.z-d.x)*U.doors[st].left/P,d.y),r.push($,$+2,$+3,$+3,$+1,$),$=a.length/3,a.push(x[W][st][0].x,x[W][st][0].y,x[W][st][0].z),a.push(x[W][st][1].x,x[W][st][1].y,x[W][st][1].z),a.push(S[W][st][0].x,S[W][st][0].y,S[W][st][0].z),a.push(S[W][st][1].x,S[W][st][1].y,S[W][st][1].z),n.push(d.x+(d.z-d.x)*h/P,d.y),n.push(d.x+(d.z-d.x)*h/P,d.y+(d.w-d.y)*U.doors[st].height/v),n.push(d.x,d.y),n.push(d.x,d.y+(d.w-d.y)*g[W].doors[st].height/v),r.push($,$+1,$+3,$,$+3,$+2),$=a.length/3,a.push(x[W][st][1].x,x[W][st][1].y,x[W][st][1].z),a.push(x[W][st][2].x,x[W][st][2].y,x[W][st][2].z),a.push(S[W][st][1].x,S[W][st][1].y,S[W][st][1].z),a.push(S[W][st][2].x,S[W][st][2].y,S[W][st][2].z),n.push(d.x,d.y),n.push(d.x+(d.z-d.x)*g[W].doors[st].width/P,d.y),n.push(d.x,d.y+(d.w-d.y)*h/v),n.push(d.x+(d.z-d.x)*g[W].doors[st].width/P,d.y+(d.w-d.y)*h/v),r.push($+2,$+1,$+3,$+2,$,$+1),$=a.length/3,a.push(x[W][st][2].x,x[W][st][2].y,x[W][st][2].z),a.push(x[W][st][3].x,x[W][st][3].y,x[W][st][3].z),a.push(S[W][st][2].x,S[W][st][2].y,S[W][st][2].z),a.push(S[W][st][3].x,S[W][st][3].y,S[W][st][3].z),n.push(d.x,d.y+(d.w-d.y)*g[W].doors[st].height/v),n.push(d.x,d.y),n.push(d.x+(d.z-d.x)*h/P,d.y+(d.w-d.y)*g[W].doors[st].height/v),n.push(d.x+(d.z-d.x)*h/P,d.y),r.push($,$+3,$+2,$,$+1,$+3)),it--,st++;it>0;)$=a.length/3,a.push(x[W][st-1][3].x,x[W][st-1][3].y,x[W][st-1][3].z),a.push(x[W][st][0].x,x[W][st][0].y,x[W][st][0].z),a.push(S[W][st-1][3].x,S[W][st-1][3].y,S[W][st-1][3].z),a.push(S[W][st][0].x,S[W][st][0].y,S[W][st][0].z),n.push(d.x,d.y),n.push(d.x+(d.z-d.x)*(g[W].doors[st].left-(g[W].doors[st-1].left+g[W].doors[st-1].width))/P/P,d.y),n.push(d.x,d.y+(d.w-d.y)*h/v),n.push(d.x+(d.z-d.x)*(g[W].doors[st].left-(g[W].doors[st-1].left+g[W].doors[st-1].width))/P,d.y+(d.w-d.y)*h/v),r.push($,$+1,$+3,$+3,$+2,$),$=a.length/3,a.push(x[W][st][0].x,x[W][st][0].y,x[W][st][0].z),a.push(x[W][st][1].x,x[W][st][1].y,x[W][st][1].z),a.push(S[W][st][0].x,S[W][st][0].y,S[W][st][0].z),a.push(S[W][st][1].x,S[W][st][1].y,S[W][st][1].z),n.push(d.x+(d.z-d.x)*h/P,d.y),n.push(d.x+(d.z-d.x)*h/P,d.y+(d.w-d.y)*g[W].doors[st].height/v),n.push(d.x,d.y),n.push(d.x,d.y+(d.w-d.y)*g[W].doors[st].height/v),r.push($,$+1,$+3,$,$+3,$+2),$=a.length/3,a.push(x[W][st][1].x,x[W][st][1].y,x[W][st][1].z),a.push(x[W][st][2].x,x[W][st][2].y,x[W][st][2].z),a.push(S[W][st][1].x,S[W][st][1].y,S[W][st][1].z),a.push(S[W][st][2].x,S[W][st][2].y,S[W][st][2].z),n.push(d.x,d.y),n.push(d.x+(d.z-d.x)*g[W].doors[st].width/P,d.y),n.push(d.x,d.y+(d.w-d.y)*h/v),n.push(d.x+(d.z-d.x)*g[W].doors[st].width/P,d.y+(d.w-d.y)*h/v),r.push($+2,$+1,$+3,$+2,$,$+1),$=a.length/3,a.push(x[W][st][2].x,x[W][st][2].y,x[W][st][2].z),a.push(x[W][st][3].x,x[W][st][3].y,x[W][st][3].z),a.push(S[W][st][2].x,S[W][st][2].y,S[W][st][2].z),a.push(S[W][st][3].x,S[W][st][3].y,S[W][st][3].z),n.push(d.x,d.y+(d.w-d.y)*g[W].doors[st].height/v),n.push(d.x,d.y),n.push(d.x+(d.z-d.x)*h/P,d.y+(d.w-d.y)*g[W].doors[st].height/v),n.push(d.x+(d.z-d.x)*h/P,d.y),r.push($,$+3,$+2,$,$+1,$+3),it--,st++;st--,$=a.length/3,Y>0?(a.push(x[W][st][3].x,x[W][st][3].y,x[W][st][3].z),a.push(e[W+1].x,e[W+1].y,e[W+1].z),a.push(S[W][st][3].x,S[W][st][3].y,S[W][st][3].z),a.push(t[W+1].x,t[W+1].y,t[W+1].z),n.push(d.x,d.y),n.push(d.x+(d.z-d.x)*(C-(g[W].doors[st].left+g[W].doors[st].width))/P,d.y),n.push(d.x,d.y+(d.w-d.y)*h/v),n.push(d.x+(d.z-d.x)*(C-(g[W].doors[st].left+g[W].doors[st].width))/P,d.y+(d.w-d.y)*h/v)):(a.push(e[W].x,e[W].y,e[W].z),a.push(e[W+1].x,e[W+1].y,e[W+1].z),a.push(t[W].x,t[W].y,t[W].z),a.push(t[W+1].x,t[W+1].y,t[W+1].z),n.push(d.x,d.y),n.push(d.x+(d.z-d.x)*C/P,d.y),n.push(d.x,d.y+(d.w-d.y)*h/v),n.push(d.x+(d.z-d.x)*C/P,d.y+(d.w-d.y)*h/v)),r.push($,$+1,$+3,$+3,$+2,$);for(let t=0;t<M[W].length;t++)$=a.length/3,a.push(M[W][t][3].x,M[W][t][3].y,M[W][t][3].z),a.push(M[W][t][0].x,M[W][t][0].y,M[W][t][0].z),a.push(O[W][t][3].x,O[W][t][3].y,O[W][t][3].z),a.push(O[W][t][0].x,O[W][t][0].y,O[W][t][0].z),n.push(d.x+(d.z-d.x)*h/P,d.y+(d.w-d.y)*g[W].windows[t].height/v),n.push(d.x+(d.z-d.x)*h/P,d.y),n.push(d.x,d.y+(d.w-d.y)*g[W].windows[t].height/v),n.push(d.x,d.y),r.push($+1,$,$+3,$+2,$+3,$),$=a.length/3,a.push(M[W][t][0].x,M[W][t][0].y,M[W][t][0].z),a.push(M[W][t][1].x,M[W][t][1].y,M[W][t][1].z),a.push(O[W][t][0].x,O[W][t][0].y,O[W][t][0].z),a.push(O[W][t][1].x,O[W][t][1].y,O[W][t][1].z),n.push(d.x,d.y+(d.w-d.y)*h/v),n.push(d.x+(d.z-d.x)*g[W].windows[t].width/P,d.y+(d.w-d.y)*h/v),n.push(d.x,d.y),n.push(d.x+(d.z-d.x)*g[W].windows[t].width/P,d.y),r.push($+1,$,$+3,$+3,$,$+2),$=a.length/3,a.push(M[W][t][1].x,M[W][t][1].y,M[W][t][1].z),a.push(M[W][t][2].x,M[W][t][2].y,M[W][t][2].z),a.push(O[W][t][1].x,O[W][t][1].y,O[W][t][1].z),a.push(O[W][t][2].x,O[W][t][2].y,O[W][t][2].z),n.push(d.x,d.y),n.push(d.x,d.y+(d.w-d.y)*g[W].windows[t].height/v),n.push(d.x+(d.z-d.x)*h/P,d.y),n.push(d.x+(d.z-d.x),d.y+(d.w-d.y)*g[W].windows[t].height/v),r.push($+1,$+2,$+3,$,$+2,$+1),$=a.length/3,a.push(M[W][t][2].x,M[W][t][2].y,M[W][t][2].z),a.push(M[W][t][3].x,M[W][t][3].y,M[W][t][3].z),a.push(O[W][t][2].x,O[W][t][2].y,O[W][t][2].z),a.push(O[W][t][3].x,O[W][t][3].y,O[W][t][3].z),n.push(d.x+(d.z-d.x)*g[W].windows[t].width/P,d.y),n.push(d.x,d.y),n.push(d.x+(d.z-d.x)*g[W].windows[t].width/P,d.y+(d.w-d.y)*h/v),n.push(d.x,d.y+(d.w-d.y)*h/v),r.push($+3,$,$+2,$+1,$,$+3);$=a.length/3,a.push(i[W].x,i[W].y,i[W].z),a.push(i[W+1].x,i[W+1].y,i[W+1].z),a.push(s[W].x,s[W].y,s[W].z),a.push(s[W+1].x,s[W+1].y,s[W+1].z),D=d.x+.5*R*(d.z-d.x)/P,n.push(D,d.y+(d.w-d.y)*h/v),D=d.x+(.5*R+C)*(d.z-d.x)/P,n.push(D,d.y+(d.w-d.y)*h/v),n.push(d.x,d.y),n.push(d.x+(d.z-d.x)*A/(P+R),d.y),r.push($+1,$,$+3,$+2,$+3,$);for(let t=l;t<a.length/3;t++)o.push(p.r,p.g,p.b,p.a)}let W=[];Le.x.ComputeNormals(a,r,W),Le.x._ComputeSides(Ki.Kj.FRONTSIDE,a,r,W,n);const U=new Le.x;return U.positions=a,U.indices=r,U.normals=W,U.uvs=n,U.colors=o,U}wallBuilder(t,e,i){var s;let a=[],r=i.corner.subtract(e.corner).normalize(),n=Math.acos(r.x);0!==r.z&&(n*=r.z/Math.abs(r.z)),b()(s=t._points.elements).call(s,(function(t){a.push(t.x*Math.cos(n)+e.corner.x,t.y,t.x*Math.sin(n)+e.corner.z)}));let o=[],h=Kl()(t._epoints,t._eholes,2);for(let t=h.length;t>0;t--)o.push(h[t-1]);return{positions:a,indices:o}}getInOutContours(){const t=this._thickness,e=(this._height,this.walls),i=this.options;let s,a=[],r=[],n=0,o=0,h=ki.P.Zero(),l=ki.P.Zero();const c=i.interior;let d=e.length;if(2===d)e[1].corner.subtractToRef(e[0].corner,h),s=new ki.P(h.z,0,-1*h.x).normalize(),h.normalize(),a[0]=e[0].corner,r[0]=e[0].corner.add(s.scale(t)),a[1]=e[1].corner,r[1]=e[1].corner.add(s.scale(t));else if(d>2){for(let i=0;i<d-1;i++)e[i+1].corner.subtractToRef(e[i].corner,l),n=Math.PI-Math.acos(ki.P.Dot(h,l)/(h.length()*l.length())),o=ki.P.Cross(l,h).normalize().y,s=new ki.P(h.z,0,-1*h.x).normalize(),h.normalize(),a[i]=e[i].corner,r[i]=e[i].corner.add(s.scale(t)).add(h.scale(o*t/Math.tan(n/2))),h=l.clone();c?(s=new ki.P(h.z,0,-1*h.x).normalize(),h.normalize(),a[d-1]=e[d-1].corner,r[d-1]=e[d-1].corner.add(s.scale(t)),e[1].corner.subtractToRef(e[0].corner,h),s=new ki.P(h.z,0,-1*h.x).normalize(),h.normalize(),a[0]=e[0].corner,r[0]=e[0].corner.add(s.scale(t))):(e[1].corner.subtractToRef(e[0].corner,l),n=Math.PI-Math.acos(ki.P.Dot(h,l)/(h.length()*l.length())),o=ki.P.Cross(l,h).normalize().y,s=new ki.P(h.z,0,-1*h.x).normalize(),h.normalize(),a[0]=e[0].corner,r[0]=e[0].corner.add(s.scale(t)).add(h.scale(o*t/Math.tan(n/2))),a[d-1]=a[0],r[d-1]=r[0])}return{outerBaseCorners:r,innerBaseCorners:a}}getTBContours(t,e){const i=[],s=[],a=this.walls.length,r=this._height;for(let n=0;n<a;n++)i.push(new ki.P(e[n].x,r,e[n].z)),s.push(new ki.P(t[n].x,r,t[n].z));return{innerTopCorners:i,outerTopCorners:s}}},Jl.type="Wall",Ql=Jl))||Ql;class ec extends pt{constructor(){super(),this._name="\u7c92\u5b50\u7279\u6548",this._isSelect=!1,this._isStart=!0}get IsSelect(){return this._isSelect}set IsSelect(t){this._isSelect=t}get Name(){return this._name}set Name(t){this._name=t}get UniupeName(){return this.Name+this.Id}get IsStart(){return this._isStart}set IsStart(t){this.writeSnapshoot(),t!==this._isStart&&(this._isStart=t,this.updateStatus())}get SceneSize(){var t;const e=t=>t.isVisible&&t.isEnabled()&&"WORLD_GROUND"!==t.name&&!t.getBoundingInfo().boundingBox.extendSize.equalsWithEpsilon(ki.P.Zero());if(g()(t=Er.Scene.meshes).call(t,e).length){const t=Er.Scene.getWorldExtends(e),{max:i,min:s}=t;return i.equalsWithEpsilon(s,.001)?null:new ra(s,i)}return null}start(){}stop(){}destory(){}fillScene(t){}updateStatus(){this._isStart?this.start():this.stop()}update(){}fromJSON(t){return this}writeFile(t){super.writeFile(t),t.write(2),t.write(this._name),t.write(this._isStart)}readFile(t){super.readFile(t);const e=t.read();this._name=t.read(),e>1&&(this._isStart=t.read())}}var ic,sc;let ac=Y(((sc=class extends pt{constructor(...t){super(...t),this.list=[]}append(t){this.list.push(t)}do(){for(const t of this.list)t.do()}remove(t){ea(this.list,t)}destory(){super.destory();for(const t of this.list)t.destory()}writeFile(t){t.write(1),t.writeAnyArray(this.list,t.writeObject)}readFile(t){t.read(),t.readAnyArrayAndPush(this.list,t.readObject)}}).type="DataBindTable",ic=sc))||ic;var rc,nc;let oc=Y(((nc=class extends wt{append(t){let e=super.append(t);return e&&(t.Owner=this.ObjectId),e}readFile(t){t.read();super.readFile(t)}writeFile(t){t.write(1),super.writeFile(t)}}).type="GroupRecordTable",rc=nc))||rc;class hc extends pt{constructor(){super(),this.objects=[],this.cleaners=[],this.doing=!1,this._pause=!1,this.queues=[],this.preventDbTimeId=void 0,this.lastClickTimeStap=void 0,this.resolveFun=[],this.callback=async(t,e)=>{if(this.doing)t.isChild&&(t.isEnd?this.queues.length=0:this.queues.push((()=>this.callback(t,e))));else{this.doing=!0;for(const t of this.objects)t.Target||e(t)&&await t.do();if(this.doing=!1,this.queues.length>0&&!this.Pause){this.queues.pop()()}}},this.pointerCallback=t=>{if(this.lastClickTimeStap){let e=t.event.timeStamp-this.lastClickTimeStap;if(this.lastClickTimeStap=null,e<200&&this.preventDbTimeId)return void clearTimeout(this.preventDbTimeId)}else this.lastClickTimeStap=t.event.timeStamp;const e=()=>{const e=2===t.event.button;this.lastClickTimeStap=null,this.callback(t,(i=>!("RightClick"!==i.TriggerType||!e)||("Click"===i.TriggerType&&0===t.event.button||void 0)))};t.isChild?e():this.preventDbTimeId=I()((()=>{e()}),200)},this.pointerDbClick=async t=>{await this.callback(t,(t=>"DoubleClick"===t.TriggerType))},this.onKeydown=async t=>{await this.callback(t,(t=>"KeyDown"===t.TriggerType))},this.onKeyup=async t=>{await this.callback(t,(t=>"KeyUp"===t.TriggerType))},this.onLoad=async t=>{await Cs(100),await this.callback(t,(t=>"Load"===t.TriggerType))},this.onUpdate=async t=>{await this.callback(t,(t=>"Update"===t.TriggerType))}}get Pause(){return this._pause}start(){var t,e;(this._pause=!1,this.resolveFun.length>0)&&(b()(e=this.resolveFun).call(e,(t=>t(!0))),this.resolveFun.length=0);if(b()(t=zr.MainScene.animatables).call(t,(t=>t.restart())),this.queues.length>0){this.queues.pop()()}}stop(){var t;this._pause=!0,b()(t=zr.MainScene.animatables).call(t,(t=>t.pause()))}wait(){return new(N())((t=>this.resolveFun.push(t)))}append(t){t._SetOwnerDatabase(this._db),this.objects.push(t)}removeAll(){var t;b()(t=this.objects).call(t,(t=>t.destory())),this.objects.length=0}remove(t){let e;e=ur()(t)?t:[t];for(const t of e)t.destory();ia(this.objects,(t=>vt()(e).call(e,t)))}destory(){var t;super.destory(),b()(t=this.objects).call(t,(t=>t.destory())),this.objects.length=0,this.doing=!1}watch(){this.cleaners.push(Mr.on("pointerTap",this.pointerCallback),Mr.on("pointerDoubleTap",this.pointerDbClick),Mr.on("keydown",this.onKeydown),Mr.on("keyup",this.onKeyup),Mr.on("loadComplete",this.onLoad),Mr.on("update",this.onUpdate)),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this.start(),"hidden"===document.visibilityState&&this.stop()}))}writeFile(t){super.writeFile(t),t.write(1),t.writeAnyArray(this.objects,t.writeObject)}readFile(t){super.readFile(t),t.read(),t.readAnyArrayAndPush(this.objects,t.readObject)}}function lc(t){return t.x*t.z}jt.ObjectType=[Er,Bn,Tr,ec];class cc extends Pt{constructor(t=!1){super(t),this.preview=t,this.ModelSpace=void 0,this.LightSpace=void 0,this.TextureTable=void 0,this.MaterialTable=void 0,this.HistoryManager=void 0,this.InteractionTable=void 0,this.DataBindTable=void 0,this.GuiSpace=void 0,this.DomSpace=void 0,this.ParticleSystemSpace=void 0,this.GroupTable=void 0,this.Tables=[],this.idIndex=1,this.idMap=new(U()),this.ModelSpace=(new jt)._SetOwnerDatabase(this),this.LightSpace=(new jt)._SetOwnerDatabase(this).setCheckout((t=>t.isLight)),this.TextureTable=(new Nt)._SetOwnerDatabase(this),this.MaterialTable=(new Nt)._SetOwnerDatabase(this),this.HistoryManager=(new Ot)._SetOwnerDatabase(this),this.InteractionTable=(new hc)._SetOwnerDatabase(this),t&&this.InteractionTable.watch(),this.DataBindTable=(new ac)._SetOwnerDatabase(this),this.GuiSpace=(new jt)._SetOwnerDatabase(this),this.DomSpace=(new jt)._SetOwnerDatabase(this),this.ParticleSystemSpace=(new jt)._SetOwnerDatabase(this),this.GroupTable=(new oc)._SetOwnerDatabase(this),this.Tables.push(this.ModelSpace,this.LightSpace,this.TextureTable,this.MaterialTable,this.InteractionTable,this.DataBindTable,this.GuiSpace,this.DomSpace,this.ParticleSystemSpace,this.GroupTable),this.idIndex=100}get AllObjects(){const t=[];for(const[e,i]of this.idMap)e<100||t.push(i.Object);return t}allocateId(){return this.getObjectId(this.idIndex++)}getObjectId(t){if(0===t)return;let e=this.idMap.get(t);return e||(e=new q(t),this.idMap.set(t,e),e)}findObjectById(t){return this.idMap.get(t)?.Object}findObjectByName(t,e=!0,i){const s=[];i||(i=t=>!1);for(const[,r]of this.idMap){var a;if(!r.isErase)if(r.Object?.Name&&!i(r.Object))if(e)vt()(a=r.Object.Name).call(a,t)&&s.push(r.Object);else r.Object.Name===t&&s.push(r.Object)}return s}replace(t,e){e.ObjectId?console.error("\u5df2\u7ecf\u6dfb\u52a0\u5230\u6570\u636e\u5e93\u7684\u5bf9\u8c61\u65e0\u6cd5\u66ff\u6362"):t instanceof Er&&e instanceof Er?t.Owner.Object instanceof jt&&t.Owner.Object.replace(t,e):console.error("\u8bf7\u4f20\u5165\u5b9e\u4f53")}cloneMaterial2Database(t){const e=t.MaterialTable.Objects,i=new(U());for(const t of e){const e=t.Id-100;i.set(e,t),this.MaterialTable.add(t)}const s=t.TextureTable.Objects;for(const t of s){const e=t.Id-100;i.set(e,t),this.TextureTable.add(t)}for(let t=0;t<i.size;t++){const e=this.allocateId(),s=i.get(t);this.idMap.set(e.Index,s.ObjectId),s.ObjectId.Index=e.Index,s._SetDatabase(this)}return e}cloneBlockObjects(t,e,i){let s=new J;for(const a of t)this.cloneBlockObject(a,e,i,s);return wa()(t).call(t,(t=>i.get(t.ObjectId).Object))}cloneBlockObject(t,e,i,s){let a=s.idMaping.get(t.Id);if(a&&a.Object)return;s.Data.length=0,s.cloned.add(t.Id),s.writeObject(t),this.cloneBlockReferenceObject(t,s,i),s.reset();let r=s.readObject();this.allocationObjectId(r),e.append(r,!1),i.set(t.ObjectId,r.ObjectId)}cloneBlockReferenceObject(t,e,i){let s=e.Data;e.Data=[];let a=t.DB,r=e.hardObjectIds;e.hardObjectIds=new(Q());for(let t of r){let s=a.getObjectId(t);if(!s?.Object)continue;let r=this.getObjectId(s.Object.Owner.Index).Object;this.cloneBlockObject(s.Object,r,i,e)}e.Data=s}allocationObjectId(t){t.ObjectId.Index=this.idIndex++,this.idMap.set(t.Id,t.ObjectId)}writeFile(t){return t||(t=new X),t.write(2),t.write(this.idIndex),this.ModelSpace.writeFile(t,{sort:(t,e)=>{const i=t.BoundingVectors,s=e.BoundingVectors;if(!i&&!s)return 0;if(!i)return 1;if(!s)return-1;const a=lc(i.max.subtract(i.min));return lc(s.max.subtract(s.min))-a}}),this.LightSpace.writeFile(t),this.TextureTable.writeFile(t),this.MaterialTable.writeFile(t),this.InteractionTable.writeFile(t),this.DataBindTable.writeFile(t),this.GuiSpace.writeFile(t),this.DomSpace.writeFile(t),this.ParticleSystemSpace.writeFile(t),this.GroupTable.writeFile(t),t}readFile(t){this.destory(),this.reset(),t.database=this;let e=t.read();return this.idIndex=t.read(),this.ModelSpace.readFile(t),this.LightSpace.readFile(t),this.TextureTable.readFile(t),this.MaterialTable.readFile(t),this.InteractionTable.readFile(t),this.DataBindTable.readFile(t),this.GuiSpace.readFile(t),this.DomSpace.readFile(t),this.ParticleSystemSpace.readFile(t),e>1&&this.GroupTable.readFile(t),this.preview&&this.DataBindTable.do(),this}destory(){var t;this.idMap.clear(),this.HistoryManager.destory(),b()(t=this.Tables).call(t,(t=>t.destory())),this.idIndex=1}reset(){var t;b()(t=this.Tables).call(t,(t=>t._SetOwnerDatabase(this))),this.idIndex=100}}var dc=i(79245);Zt.n.ShowLoadingScreen=!1,dc.rN.PreprocessUrl=t=>{if(H()(t).call(t,"http")&&Ji.clearCacheKeys.length){var e;const i=F()(e=Ji.clearCacheKeys).call(e,(e=>vt()(t).call(t,e.key)));if(i){const e=new(Ht())(t);return e.searchParams.append("t",i.timestamp),e.href}}return t};class uc{constructor(t){return this.Editor=void 0,this.Viewer=void 0,this.Database=void 0,this.isReady=!0,this._domContainer=void 0,this._IsShadow=!1,this.cleaners=[],this.guiSelectTool=void 0,void 0!==t.lowPerformance&&(Ji.lowPerformance=t.lowPerformance),uc.Intance||(zr.Application=this,this.Viewer=new Eh(t.canvas,!t.editor),this.guiSelectTool=new Rr(this.Viewer),this.Editor=new bo(this.Viewer,t.editor),t.domContainer?this._domContainer=t.domContainer:this._domContainer=document.getElementById("2d")||t.canvas.parentElement,zr.PreviewMode=!t.editor,this.Database=new cc(!t.editor),zr.MainViewer=this.Viewer,this._register(),this.initLight(),t.skybox&&(this.Viewer.sceneControl.Mode=t.skybox),t.cameraRadius&&(this.Viewer.cameraManager.Radius=t.cameraRadius),Ji.debugger=t.debug,uc.Intance=this),uc.Intance}get IsShadow(){return this.Viewer.sceneControl.IsShadow}set IsShadow(t){this.Viewer.sceneControl.IsShadow=t}create(t){const e=K.CreateObject(t.type,t);if(e)return t.name&&(e.Name=t.name),t.position&&(e.Position=t.position,e instanceof Ln&&(e.isRead=!0)),void 0!==t.colorIndex&&(e.ColorIndex=t.colorIndex),e instanceof Bn?this.Database.GuiSpace.append(e):e instanceof Tr?this.Database.DomSpace.append(e):e instanceof Er&&(e.isLight?this.Database.LightSpace.append(e):this.Database.ModelSpace.append(e)),t.loading&&e.on("loading",t.loading),t.complete&&(e.isAsync?e.once("load",t.complete):t.complete({type:"load",target:e})),e;console.error(t.type+"\u7c7b\u578b\u5b9e\u4f53\u4e0d\u5b58\u5728")}createGui(t,e){const i=K.CreateObject(t,e);if(i)return this.Database.GuiSpace.append(i),i;console.error(e.type+"\u7c7b\u578b\u5b9e\u4f53\u4e0d\u5b58\u5728")}createParticle(t,e){const i=K.CreateObject(t,e);if(i)return this.Database.ParticleSystemSpace.append(i),i;console.error(e.type+"\u7279\u6548\u4e0d\u5b58\u5728")}createPBR(){const t=new Pn;return this.Database.MaterialTable.append(t),t}createTexture(t,e){const i=new Ur(t);return e&&i.once("load",e),this.Database.TextureTable.append(i),i}get SelectObjects(){return[...this.SelectEntitys,...this.SelectGuis,...this.SelectDoms,...this.SelectParticles]}get SelectEntitys(){return this.Editor?.selectControl.selectSet.SelectEntitys}get SelectParticles(){const t=this.Editor?.selectControl?.SelectParticle;return t?[t]:[]}get SelectGuis(){const t=this.Editor?.selectControl?.SelectGui;return t?[t]:[]}get SelectDoms(){const t=this.Editor?.selectControl?.SelectDOM;return t?[t]:[]}zoomAll(){this.Viewer.cameraManager.zoomAll()}changeRenderType(t){var e;void 0!==t&&b()(e=this.Database.ModelSpace.Entitys).call(e,(e=>e.updateRenderType(t)))}new(t=!0){this.Editor?.transformControl&&this.Editor.transformControl.detachMeshs(),this.Viewer.reset(),this.Database.readFile((new cc).writeFile()),this.initLight(),t&&Mr.trigger({type:ys.NewFile,target:null})}saveFile(){const t=this.Database.writeFile();return this.Viewer.writeFile(t),t.Data}loadFile(t){var e;(this.isReady=!1,zr.StartWait(),this.Viewer.Scene.blockfreeActiveMeshesAndRenderingGroups=!0,this.Viewer.stopRender(),this.Viewer.reset(),this.Editor?.transformControl&&this.Editor.transformControl.detachMeshs(),Ir.clear(),Mr.trigger({type:ys.StartLoad,target:null}),Ji.loadPlugins.size>0)&&(b()(e=Ji.loadPlugins).call(e,(t=>t?.dispose?.())),Ji.loadPlugins.clear());if(this.Viewer.clearScene(),t){var i;zr.Reading=!0;const e=new X(t);this.Database.readFile(e),this.Viewer.readFile(e),this.Viewer.hemisphericLight=F()(i=this.Database.LightSpace.Entitys).call(i,(t=>t instanceof Ol)),zr.Reading=!1}else this.new(!1);this.Viewer.Scene.blockfreeActiveMeshesAndRenderingGroups=!1,this.Viewer.render(),Mr.trigger({type:ys.LoadFile,target:null}),zr.WaitComplete().then((t=>{Mr.trigger({type:ys.LoadComplete,target:null}),this.isReady=!0,this.Viewer.sceneControl.ToggleShadowObserable.notifyObservers(this.IsShadow)}))}destory(){var t;this.Viewer.Scene.blockfreeActiveMeshesAndRenderingGroups=!0,this.Database.destory(),this.Viewer.Scene.blockfreeActiveMeshesAndRenderingGroups=!1,this.Viewer.destory(),uc.Intance=null,zh.clear(),b()(t=this.cleaners).call(t,(t=>t())),this.cleaners.length=0}clearCache(){Ir.clear()}createView(t,e){return new Eh(t,!0,e)}openShadow(){const t=this.Database.LightSpace.Entitys,e=this.Database.ModelSpace.Entitys;for(const i of t)i.HasShadowGenerator&&i.addShadowCaster(e)}closeShadow(){const t=this.Database.LightSpace.Entitys;for(const e of t)e.HasShadowGenerator&&e.removeShadowCaster()}on(t,e){return Mr.on(t,e)}off(t,e){Mr.off(t,e)}initLight(){const t=new Ol;this.Viewer.hemisphericLight=t,this.Database.LightSpace.append(t)}_register(){const t=()=>{var t,e;this.Viewer.setSize(),b()(t=this.Database.DomSpace.Entitys).call(t,(t=>t.update())),b()(e=this.Database.GuiSpace.Entitys).call(e,(t=>t.update()))};window.addEventListener("resize",t);const e=this.Viewer.sceneControl.ToggleShadowObserable.add((t=>{this.isReady&&(t?this.openShadow():this.closeShadow())}));this.cleaners.push(kt(this.Database.ModelSpace,this.Database.ModelSpace.appendEvent,(t=>{this.Viewer.Scene.addTransformNode(t.DrawObject)})),kt(this.Database.LightSpace,this.Database.LightSpace.appendEvent,(t=>{this.Viewer.Scene.addTransformNode(t.DrawObject),this._IsShadow&&t.EnableShadow&&t.addShadowCaster(this.Database.ModelSpace.Entitys)})),kt(this.Database.GuiSpace,this.Database.GuiSpace.appendEvent,(t=>{this.Viewer.GuiContainer.addControl(t.DrawObject)})),kt(this.Database.DomSpace,this.Database.DomSpace.appendEvent,(t=>{this._domContainer.appendChild(t.DrawObject)})),kt(this.Database.ParticleSystemSpace,this.Database.ParticleSystemSpace.appendEvent,(t=>{const e=Er.Scene;Er.Scene=zr.MainScene,t.IsErase||t.Intance,Er.Scene=e})),kt(this.Database,this.Database.readFile,(async()=>{for(const t of this.Database.ModelSpace.Entitys)t.IsErase||this.Viewer.Scene.addTransformNode(t.DrawObject);for(const t of this.Database.LightSpace.Entitys)t.IsErase||this.Viewer.Scene.addTransformNode(t.DrawObject);for(const t of this.Database.GuiSpace.Entitys)t.IsErase||this.Viewer.GuiContainer.addControl(t.DrawObject);for(const t of this.Database.DomSpace.Entitys)t.IsErase||this._domContainer.appendChild(t.DrawObject);const t=Er.Scene;Er.Scene=zr.MainScene;for(const t of this.Database.ParticleSystemSpace.Entitys)t.IsErase||t.Intance;Er.Scene=t})),this.on("update-shadow",(t=>{const e=t.target,i=this.Database.LightSpace.Entitys;for(const t of i)t.HasShadowGenerator&&(e.EnableShadow?t.addShadowCaster([e]):t.removeShadowCaster([e]))})),this.on("remove",(t=>{var e;this.Editor.selectControl&&vt()(e=this.Editor.selectControl.SelectObjects).call(e,t.target)&&this.Editor.selectControl.clearSelect(!0)})),(()=>{window.removeEventListener("resize",t)}),(()=>{this.Viewer.sceneControl.ToggleShadowObserable.remove(e)}))}}uc.Intance=void 0;var pc=i(81281),mc=i.n(pc);const gc=new class{constructor(){this.loadingUIBackgroundColor=void 0,this.loadingUIText=void 0}displayLoadingUI(){this.displayLoadingUIEvnet()}displayLoadingUIEvnet(){}hideLoadingUI(){this.hideLoadingUIEvent()}hideLoadingUIEvent(){}};class _c{constructor(t,e=!1){this.defaultEnv=e,this.filesInput=void 0,this.engine=void 0,this.scene=void 0,this.onFileLoadedObserver=new zi.y$,this.onFileProgressObserver=new zi.y$,this.onFileErrorObserver=new zi.y$,this.isRendered=!1,this.engine=new Ui.D(t,!1,{premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1}),this.engine.loadingScreen=gc,this.scene=new ci.x(this.engine),this.scene.clearColor=new xi.HE(1,1,1,1),this.scene.createDefaultCameraOrLight(!0,!0),this.scene.useRightHandedSystem=!0,this.scene.activeCamera.maxZ=1e8,e&&this.createDefaultEnv(),this.scene.executeWhenReady((()=>{this.engine.hideLoadingUI(),this.engine.runRenderLoop((()=>{this.scene.activeCamera&&this.scene.render()}))})),pi.X.FilesToLoad=new Proxy(pi.X.FilesToLoad,{get:(t,e)=>t[e],set:(t,e,i)=>(t[e]=i,!0)});let i=new ui.P(this.engine,null,((t,e)=>{var i,s,a;this.scene=e;const r=as()(i=t.name).call(i,".glb")||as()(s=t.name).call(s,".gltf");this.prepareCamera(r),b()(a=e.materials).call(a,(t=>{t.diffuseColor=xi.Wo.White(),t.backFaceCulling=!1,t.emissiveColor=xi.Wo.Black()})),this.onFileLoadedObserver.notifyObservers(t)}),(t=>{this.onFileProgressObserver.notifyObservers(t)}),(()=>{this.isRendered=!0}),(t=>{}),(t=>{}),null,((t,e,i)=>{this.onFileErrorObserver.notifyObservers({file:t,scene:e,message:i})}));this.filesInput=i}prepareCamera(t=!1){this.scene.createDefaultCameraOrLight(!0,!0),this.scene.activeCamera.maxZ=1e8;const e=this.scene.activeCamera;this.defaultEnv&&!this.scene.metadata&&this.createDefaultEnv(),e.useFramingBehavior=!0;const i=e.getBehaviorByName("Framing");if(i.framingTime=0,i.elevationReturnTime=-1,this.scene.meshes.length){e.lowerRadiusLimit=null;const t=this.scene.getWorldExtends((function(t){return t.isVisible&&t.isEnabled()&&t.geometry&&"hdrSkyBox"!==t.name}));i.zoomOnBoundingInfo(t.min,t.max),e.useFramingBehavior=!1}e.pinchPrecision=200/e.radius,e.upperRadiusLimit=5*e.radius,e.wheelDeltaPercentage=.01,e.pinchDeltaPercentage=.01,e.attachControl(),e.alpha=Math.PI/4,e.beta=Math.PI/3}loadLocalFile(t){this.isRendered=!1,this.filesInput.loadFiles(t)}async loadFile(t){this.disposeImportMeshes();try{var e;this.isRendered=!1;const i=await Zt.n.LoadAssetContainerAsync(t,"",this.scene);return i.addAllToScene(),this.prepareCamera(),b()(e=i.materials).call(e,(t=>{t.diffuseColor=xi.Wo.White(),t.backFaceCulling=!1,t.emissiveColor=xi.Wo.Black()})),!0}catch(t){return!1}finally{this.isRendered=!0}}async getPreviewUrl(t=400){return await this.waitRendered(),Wt.w1.CreateScreenshotAsync(this.engine,this.scene.activeCamera,t)}async getBlob(){this.scene.clearColor=new xi.HE(1,1,1,1),await this.waitRendered();return As(await this.getPreviewUrl())}async waitRendered(){return new(N())((t=>{let e=mc()((()=>{this.isRendered&&(clearInterval(e),t(null))}),100)}))}onLoaded(t){const e=this.onFileLoadedObserver.add(t);return()=>{this.onFileLoadedObserver.remove(e)}}onError(t){const e=this.onFileErrorObserver.add(t);return()=>{this.onFileErrorObserver.remove(e)}}onProgress(t){const e=this.onFileProgressObserver.add(t);return()=>{this.onFileProgressObserver.remove(e)}}destory(){this.filesInput.dispose(),this.onFileLoadedObserver.clear(),this.engine.dispose()}disposeImportMeshes(){for(const t of this.scene.rootNodes)"__root__"===t.name&&t.dispose(!1,!0)}createDefaultEnv(){this.scene.environmentTexture=Uo.LoadSkyboxPathTexture(this.scene),this.scene.activeCamera&&this.scene.createDefaultSkybox(this.scene.environmentTexture,!0,1e8,.3,!1),this.scene.metadata="ok"}}class wc{constructor(t){this.canvas=t,this.viewer=void 0,this.TempDatabase=new cc(!1),this.showObjects=[],this.showIndex=0,this._material=void 0,this.viewer=new Eh(t,!0,{defaultLight:!0}),this.viewer.sceneControl.createDefaultEnv(),this.viewer.cameraManager.Radius=2,this.viewer.cameraManager.ArcRotateControl.LowerRadiusLimit=1.5,this.viewer.sceneControl.BlockMaterialUpdate=!1,this.showObjects.push((0,Me.Qk)("show-sphere",{diameter:1},this.scene),(0,Ee.NR)("show-box",{size:1},this.scene),(0,Oe.pT)("show-plane",{size:1},this.scene)),this.toggleObject()}init(t){t||(t=new Pn,this.TempDatabase.MaterialTable.append(t)),this.Material=t}get scene(){return this.viewer.Scene}get Material(){return this._material}set Material(t){zr.ToggleScene(this.scene,(()=>{if(t.DB===this.TempDatabase)this._material=t;else if(t.DB){const e=this.TempDatabase.cloneBlockObjects([t],this.TempDatabase.MaterialTable,new(U()))[0];this._material=e}else this.TempDatabase.MaterialTable.append(t),this._material=t;this.update()}))}get ShowIndex(){return this.showIndex}set ShowIndex(t){this.showIndex=t,this.toggleObject()}destory(){this.viewer.destory()}debugger(t={}){this.viewer.sceneControl.debugger(t)}update(){for(const t of this.showObjects)t.material=this._material.Material}async waitRender(){return this.Material instanceof Pn&&await this.Material.waitRender(),!0}toJSON(){const t=new cc;return t.cloneBlockObjects([this.Material],t.MaterialTable,new(U())),t.writeFile().Data}toggleObject(){for(let t=0;t<this.showObjects.length;t++)this.showObjects[t].setEnabled(t===this.showIndex)}}class yc{constructor(){this.noHistory=!0}exec(){uc.Intance.Database.HistoryManager.undo()}}class bc{constructor(){this.noHistory=!0}exec(){uc.Intance.Database.HistoryManager.redo()}}class fc{constructor(){this.CommandMap=new(U()),this.LastCmd=void 0,this._CommandNameList=new(Q()),this.doing=!1}async ExecCommand(t){if(this.CommandMap.has(t)){let e=this.CommandMap.get(t);if(this.doing)return;this.CommandStart(t,e.noHistory);let i=!0;try{i=await e.exec()}catch(t){Mr.trigger({type:"error",target:null,error:t})}await this.CommandEnd(e.noHistory)}else console.error("\u672a\u77e5\u547d\u4ee4")}RegisterCommand(t,e){t=t.toUpperCase(),this.CommandMap.set(t,e),this._CommandNameList.add(t)}RemoveCommand(t){t&&(t=t.toUpperCase(),this.CommandMap.delete(t),this._CommandNameList.delete(t))}CommandStart(t,e=!1){return!this.doing&&(this.LastCmd=t,this.doing=!0,e||uc.Intance.Database.HistoryManager.startCmd(t),!0)}async CommandEnd(t=!1){this.doing=!1,t||uc.Intance.Database.HistoryManager.endCmd()}get CommandNameList(){return this._CommandNameList}}const vc=new fc;function xc(t=[]){vc.RegisterCommand("undo",new yc),vc.RegisterCommand("redo",new bc);for(const e of t)vc.RegisterCommand(e[0],e[1])}async function Sc(t,e=""){if(!vc.CommandStart(e))return;let i=!0;try{const e=await t();i="boolean"==typeof e&&e}catch(t){}await vc.CommandEnd(i)}var Mc,Oc,Pc,Cc,Ac;let Ec=(Mc=Is(Yr,Kr),Y(((Ac=class extends ks{constructor(t,e){super(t,e),this._name="\u6807\u51c6\u6750\u8d28",(0,vs.Z)(this,"DiffuseTexture",Cc,this),t||(this.material=new Oi.K("\u6807\u51c6\u6750\u8d28",zr.Scene),this.updateMaterial()),this.init=!1,this.material.metadata||(this.material.metadata={}),this.material.metadata.record=this}updateMaterial(){this.material&&super.updateMaterial()}updateTextures(){if(this.DiffuseTexture?.Object){const t=this.DiffuseTexture.Object;this.material.diffuseTexture=t.Texture}}update(){super.update(),this.updateTextures()}writeFile(t){super.writeFile(t),t.write(1),t.writeObjectId(this.DiffuseTexture)}readFile(t){super.readFile(t);t.read();this.DiffuseTexture=t.readObjectId(),this.update()}_SetOwnerDatabase(t){return super._SetOwnerDatabase(t),this.material.name=`standardmtl-${this.Id}`,this.material.id=`standardmtl-${this.Id}`,this}}).type="StandardMaterialRecord",Pc=Ac,Cc=(0,xs.Z)(Pc.prototype,"DiffuseTexture",[Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Oc=Pc))||Oc);class zc extends class{do(){}}{constructor(t=[],e={x:0,y:0,z:0}){super(),this.entitys=t,this.target=e,this.animateType="",this.isOffset=!0,this.time=1}do(){const t=[];for(const e of this.entitys){const i=e.Object;t.push(i.moveTo(this.target,this.isOffset,{time:1}))}return N().all(t)}}var Dc,Tc,Rc;let Ic=Y((Rc=(0,hs.Z)("name"),(Tc=class{constructor(t,e){this.mtl=t,this.options=e,O()(this,Rc,{writable:!0,value:"\u6750\u8d28\u52a8\u753b"}),this._animatable=void 0,this._animation=void 0,this.init()}get Material(){if(this.mtl)return"string"==typeof this.mtl?Er.Scene.getMaterialById(this.mtl):this.mtl.Object?.Material}get name(){return(0,os.Z)(this,Rc)[Rc]}set name(t){(0,os.Z)(this,Rc)[Rc]=t,this._animation&&(this._animation.name=t)}get Animatable(){return this._animatable}get Animation(){return this._animation}init(){const t=this.Material;if(!t)return;this.clear();const e=this.options;if(!e)return;const{name:i,frame:s=30,defaultStart:a=!1,range:r=[0,1],dataType:n}=e;i&&((0,os.Z)(this,Rc)[Rc]=i);const o=new Gi.f((0,os.Z)(this,Rc)[Rc],e.targetKey,e.frame??30,n??Gi.f.ANIMATIONTYPE_FLOAT),h=this.generateKeys();o.setKeys(h),t.animations||(t.animations=[]),t.animations.push(o),this._animation=o,a&&zr.PreviewMode&&this.start()}start(){const{time:t=1,frame:e=30,loop:i=!0,speed:s=1}=this.options;this._animatable=Er.Scene.beginDirectAnimation(this.Material,[this.Animation],0,t*e,i,s)}pause(){this._animatable&&this._animatable.pause()}restart(){this._animatable&&this._animatable.restart()}stop(){this._animatable&&this._animatable.stop()}reset(){this._animatable&&this._animatable.reset()}clear(){const t=this.Material;t&&(this._animatable&&(this._animatable.disposeOnEnd=!0,this._animatable.stop(),this._animatable=null),this._animation&&ea(t.animations,this._animation))}writeFile(t){t.write(1),t.write("string"==typeof this.mtl),"string"==typeof this.mtl?t.write(this.mtl):t.writeHardObjectId(this.mtl),t.write(this.name),t.write(this.options)}readFile(t){t.read();let e=t.read();this.mtl=e?t.read():t.readHardObjectId(),this.name=t.read(),this.options=t.read(),requestIdleCallback((()=>{this.init()}))}getValue(){const t=this.options.targetKey.split(".");let e=this.Material;for(const i of t)e=e[i];return e}generateKeys(){const{time:t=1,frame:e=30,range:i=[0,1],dataType:s=Gi.f.ANIMATIONTYPE_FLOAT}=this.options;switch(s){case Gi.f.ANIMATIONTYPE_FLOAT:return[{frame:0,value:i[0]},{frame:t*e,value:i[1]}];case Gi.f.ANIMATIONTYPE_COLOR3:return[{frame:0,value:xi.Wo.FromHexString(i[0])},{frame:t*e,value:xi.Wo.FromHexString(i[1])}];default:return[]}}}).type="MaterialAnimation",Dc=Tc))||Dc;var Lc,Fc;function kc(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}let jc=Y(((Fc=class extends po{constructor(...t){super(...t),this.data={type:"url",value:"",target:"_blank"}}do(){switch(this.data.type){case"url":this.openUrl(this.data.value);break;case"file":this.openUrl(zs(location.href,"id",this.data.value)+"&time="+z()());break;case"back":history.back();break;case"reload":location.reload()}return!0}readFile(t){t.read(),this.data=JSON.parse(t.read())}writeFile(t){t.write(1),t.write(j()(this.data))}toJSON(){return function(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=kc(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=kc(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}({},this.data)}fromJSON(t){A()(this.data,t)}openUrl(t){const e="OpenWidgetHref";let i=document.getElementById(e);i||(i=document.createElement("a"),document.body.appendChild(i),i.setAttribute("id",e)),i.setAttribute("target",this.data.target),i.setAttribute("href",t),i.click()}}).type="Open",Fc.schema={label:"\u6253\u5f00\u94fe\u63a5"},Lc=Fc))||Lc;var Bc,Nc;let Gc=Y(((Nc=class extends po{constructor(...t){super(...t),this._list=[]}get List(){return[...this._list]}async do(){const t=[];for(const e of this._list){const i=e.objectId.Object;i&&t.push(i.moveTo(e.target,e.type===Ks.Offset,{time:e.time,startTime:this.startTime}))}return N().all(t).then((t=>!0))}add(t){this._list.push(t)}fromJSON(t){this._list.length=0;for(const e of t)this._list.push({objectId:e.objectId,time:e.time,target:e.target,type:e.type,animationType:e.animationType})}readFile(t){t.read();const e=t.read();this._list.length=0;for(let i=0;i<e;i++){const e={target:{x:0,y:0,z:0}};e.objectId=t.readObjectId(),e.type=t.read(),e.target.x=t.read(),e.target.y=t.read(),e.target.z=t.read(),e.time=t.read(),e.animationType=t.read(),this._list.push(e)}}writeFile(t){t.write(1),t.write(this._list.length);for(const e of this._list)t.writeObjectId(e.objectId),t.write(e.type),t.write(e.target.x),t.write(e.target.y),t.write(e.target.z),t.write(e.time),t.write(e.animationType)}}).type="Move",Nc.schema={label:"\u79fb\u52a8"},Bc=Nc))||Bc;const Hc=eval;function Vc(t,e){if(!t)return 0;let i="";if(e)for(let t in e)i+=`let ${t} = ${e[t]};`;i+=t;let s=Hc(i);return"function"==typeof s?s():Number(s)}var Zc,Wc;let Uc=Y(((Wc=class extends po{constructor(...t){super(...t),this._List=[]}get List(){return[...this._List]}async do(){const t=[];for(const e of this._List){const i=e.objectId.Object;if(!i)continue;const s=i.BoundingBox.extendSize.scale(2),a={x:s.x,X:s.x,y:s.y,Y:s.y,z:s.z,Z:s.z},r={x:Vc(e.pivot.x,a),y:Vc(e.pivot.y,a),z:Vc(e.pivot.z,a)},n={x:ns()(e.axis.x)||0,y:ns()(e.axis.y)||0,z:ns()(e.axis.z)||0};t.push(i.rotateTo({angle:0===e.dir?-1*e.angle:e.angle,time:e.time,isOffset:e.type===Ks.Offset,animation:!0,pivot:r,startTime:this.startTime,dir:n}))}return N().all(t).then((t=>!0))}add(t){this._List.push(t)}fromJSON(t){this._List.length=0;for(const e of t)this._List.push({objectId:e.objectId,time:e.time,angle:e.angle,type:e.type,animationType:e.animationType,dir:e.dir,pivot:e.pivot,axis:e.axis})}readFile(t){const e=t.read(),i=t.read();this._List.length=0;for(let s=0;s<i;s++){const i={pivot:{x:"",y:"",z:""},axis:{x:"0",y:"1",z:"0"}};i.objectId=t.readObjectId(),i.type=t.read(),i.time=t.read(),i.animationType=t.read(),i.angle=t.read(),i.dir=t.read(),i.pivot.x=t.read(),i.pivot.y=t.read(),i.pivot.z=t.read(),e>1&&(i.axis.x=t.read(),i.axis.y=t.read(),i.axis.z=t.read()),this._List.push(i)}}writeFile(t){t.write(2),t.write(this._List.length);for(const e of this._List)t.writeObjectId(e.objectId),t.write(e.type),t.write(e.time),t.write(e.animationType),t.write(e.angle),t.write(e.dir),t.write(e.pivot.x),t.write(e.pivot.y),t.write(e.pivot.z),t.write(e.axis.x),t.write(e.axis.y),t.write(e.axis.z)}}).type="Rotate",Wc.schema={label:"\u65cb\u8f6c"},Zc=Wc))||Zc;var Kc,Yc;let qc=Y(((Yc=class extends po{constructor(...t){super(...t),this.List=[]}async do(){for(const t of this.List){const{type:e,objectId:i}=t;switch(e){case"Show":i.Object.Visiable=!0;break;case"Hidden":i.Object.Visiable=!1;break;case"Toggle":i.Object.Visiable=!i.Object.Visiable}}return!0}fromJSON(t){this.List=t}readFile(t){t.read(),this.List.length=0,t.readAnyArray((()=>{const e={};e.type=t.read(),e.objectId=t.readObjectId(),this.List.push(e)}))}writeFile(t){t.write(1),t.writeAnyArray(this.List,(e=>{t.write(e.type),t.writeObjectId(e.objectId)}))}}).type="Display",Yc.schema={label:"\u663e\u793a/\u9690\u85cf"},Kc=Yc))||Kc;var Xc,$c;function Qc(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}function Jc(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=Qc(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=Qc(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}let td=Y((($c=class extends po{constructor(...t){super(...t),this._List=[]}get List(){return[...this._List]}async do(){const t=[];for(const e of this._List){const i=e.objectId.Object;if(!i)continue;let s,a,r;const n=i.BoundingBox.extendSize.scale(2),o=e.bySize?i.BoundingBox.extendSizeWorld.scale(2):i.Scale,h={x:o.x,X:o.x,y:o.y,Y:o.y,z:o.z,Z:o.z},l={x:n.x,X:n.x,y:n.y,Y:n.y,z:n.z,Z:n.z};s=Vc(e.scale.x,h),a=Vc(e.scale.y,h),r=Vc(e.scale.z,h),e.bySize&&(s/=o.x,a/=o.y,r/=o.z);const c={x:Vc(e.pivot.x,l),y:Vc(e.pivot.y,l),z:Vc(e.pivot.z,l)};t.push(i.scaleTo({scale:new ki.P(s,a,r),time:e.time,animation:!0,isOffset:e.bySize,pivot:c,startTime:this.startTime}))}return N().all(t).then((t=>!0))}add(t){this._List.push(t)}toJSON(){return{}}fromJSON(t){this._List.length=0;for(const e of t)this._List.push(Jc({},e))}readFile(t){t.read(),this._List.length=0,t.readAnyArray((()=>{const e={scale:{x:"1",y:"1",z:"1"},pivot:{x:"x/2",y:"y/2",z:"z/2"}};e.objectId=t.readObjectId(),e.scale.x=t.read(),e.scale.y=t.read(),e.scale.z=t.read(),e.pivot.x=t.read(),e.pivot.y=t.read(),e.pivot.z=t.read(),e.type=t.read(),e.time=t.read(),e.animationType=t.read(),e.bySize=t.read(),this._List.push(e)}))}writeFile(t){t.write(1),t.writeAnyArray(this._List,(e=>{t.writeObjectId(e.objectId),t.write(e.scale.x),t.write(e.scale.y),t.write(e.scale.z),t.write(e.pivot.x),t.write(e.pivot.y),t.write(e.pivot.z),t.write(e.type),t.write(e.time),t.write(e.animationType),t.write(e.bySize)}))}}).type="Scale",$c.schema={label:"\u7f29\u653e"},Xc=$c))||Xc;var ed,id;let sd=Y(((id=class extends po{constructor(){super(),this.current=!1,this._alpha=void 0,this._beta=void 0,this._radius=void 0,this._target={x:void 0,y:void 0,z:void 0},this._time=1e3}async do(){const t=zr.MainViewer.cameraManager.Control.moveTo({alpha:this._alpha,beta:this._beta,target:this._target,radius:this._radius,time:this._time});return await t.start(),!0}fromJSON(t){this._alpha=t.alpha??this._alpha,this._beta=t.beta??this._beta,this._radius=t.radius??this._radius,this._target=t.target??this._target,this._time=t.time??this._time}readFile(t){t.read(),this._alpha=t.read(),this._beta=t.read(),this._radius=t.read(),this._target.x=t.read(),this._target.y=t.read(),this._target.z=t.read(),this._time=t.read()}writeFile(t){t.write(1),t.write(this._alpha),t.write(this._beta),t.write(this._radius),t.write(this._target.x),t.write(this._target.y),t.write(this._target.z),t.write(this._time)}}).type="MoveCamera",id.schema={label:"\u79fb\u52a8\u76f8\u673a\u5230"},ed=id))||ed;var ad,rd;let nd=Y(((rd=class extends po{constructor(...t){super(...t),this.list=[]}get List(){return[...this.list]}do(){for(const i of this.list){var t;const s=F()(t=zr.GlobalVariables).call(t,(t=>t.key===i.key));if(s)if("value"===i.value.type)s.value=i.value.value;else if("param"===i.value.type){var e;const t=F()(e=zr.GlobalVariables).call(e,(t=>t.key===i.value.value));s.value=t.value}else"entity"===i.value.type&&(s.value=i.value.value.Object[i.value.entityKey])}return localStorage.setItem("variables",j()(zr.GlobalVariables)),!0}add(t){this.list.push(t)}fromJSON(t){this.list=t}readFile(t){t.read(),this.list.length=0,t.readAnyArray((()=>{const e={key:"",value:{type:null,value:null}};e.key=t.read(),t.readWidgetValue(e.value),this.list.push(e)}))}writeFile(t){t.write(1),t.writeAnyArray(this.list,(e=>{t.write(e.key),t.writeWidgetValue(e.value)}))}}).type="SetVariable",rd.schema={label:"\u8bbe\u7f6e\u53d8\u91cf\u503c"},ad=rd))||ad;var od,hd;let ld=Y(((hd=class extends po{constructor(...t){super(...t),this._time=1e3}do(){return new(N())((t=>I()(t,this._time)))}fromJSON(t){this._time=t.time}readFile(t){t.read(),this._time=t.read()}writeFile(t){t.write(1),t.write(this._time)}}).type="Wait",hd.schema={label:"\u7b49\u5f85"},od=hd))||od;var cd,dd;let ud=Y(((dd=class extends po{constructor(){super(),this._list=[]}get List(){return[...this._list]}async do(){for(const t of this._list)switch(t.type){case"select":t.objectId.Object.IsSelect=!0;break;case"unSelect":t.objectId.Object.IsSelect=!1;break;case"toggle":t.objectId.Object.IsSelect=!t.objectId.Object.IsSelect}return!0}fromJSON(t){this._list.length=0;for(const e of t)e.type&&e.objectId&&this._list.push({type:e.type,objectId:e.objectId});return this}readFile(t){t.read(),this._list.length=0,t.readAnyArray((()=>{const e={type:"",objectId:null};e.type=t.read(),e.objectId=t.readObjectId(),this._list.push(e)}))}writeFile(t){t.write(1),t.writeAnyArray(this._list,(e=>{t.write(e.type),t.writeObjectId(e.objectId)}))}}).type="Select",dd.schema={label:"\u8bbe\u7f6e\u9009\u4e2d"},cd=dd))||cd;var pd,md;let gd=Y(((md=class extends po{do(){return!0}readFile(t){t.read()}writeFile(t){t.write(1)}}).type="DataFeedback",md.schema={label:"\u6570\u636e\u53cd\u9988"},pd=md))||pd;var _d,wd;let yd=Y(((wd=class extends po{constructor(...t){super(...t),this._list=[]}get List(){return[...this._list]}async do(){for(const t of this._list){t.objectId.Object.highlight(t.color)}return!0}fromJSON(t){this._list=t}readFile(t){t.read(),this._list.length=0,t.readAnyArray((()=>{const e={color:"",objectId:null};e.color=t.read(),e.objectId=t.readObjectId(),this._list.push(e)}))}writeFile(t){t.write(1),t.writeAnyArray(this._list,(e=>{t.write(e.color),t.writeObjectId(e.objectId)}))}}).type="Highlight",wd.schema={label:"\u663e\u793a\u9ad8\u4eae\u8fb9\u6846"},_d=wd))||_d;function bd(t,e=[]){if(t){if("value"===t.type)return t.value;if("param"===t.type){return F()(e).call(e,(e=>e.key===t.value))?.value}return"entity"===t.type?(t.entityKey,t.value?.Object?.[t.entityKey]):void 0}}function fd(t){return"RightClick"===t||"Click"===t?"pointerTap":"Load"===t?"load":t}var vd,xd;function Sd(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}function Md(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=Sd(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=Sd(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}let Od=Y(((xd=class extends po{constructor(...t){super(...t),this._list=[]}get List(){return[...this._list]}do(){for(const i of this._list){const s=i.objectId?.Object;var t,e;if(s)b()(t=i.triggerNames).call(t,(t=>{const e=Md(Md({},this.getTriggerEvent(t)),{},{type:fd(t),target:s});s.trigger(e)}));else b()(e=i.triggerNames).call(e,(t=>{const e=this.getTriggerEvent(t);Mr.trigger(e)}))}return!0}fromJSON(t){this._list=t}readFile(t){t.read(),this._list.length=0,t.readAnyArray((()=>{let e={triggerNames:[],objectId:null};t.readAnyArrayAndPush(e.triggerNames,t.read),e.objectId=t.readObjectId(),this._list.push(e)}))}writeFile(t){t.write(1),t.writeAnyArray(this._list,(e=>{t.writeAnyArray(e.triggerNames,t.write),t.writeObjectId(e.objectId)}))}getTriggerEvent(t,e){switch(t){case"Click":return{type:"pointerTap",event:{button:0},isChild:!0,target:e};case"RightClick":return{type:"pointerTap",event:{button:2},isChild:!0,isEnd:!0,target:e};case"DoubleClick":return{type:"pointerDoubleTap",event:{button:0},isChild:!0,target:e};case"Load":return{type:"loadFile",isChild:!0,target:e};default:return{type:t,target:e,isChild:!0}}}}).type="Dispatch",xd.schema={label:"\u89e6\u53d1\u4e8b\u4ef6"},vd=xd))||vd;var Pd,Cd;function Ad(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}function Ed(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=Ad(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=Ad(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}let zd=Y(((Cd=class extends po{constructor(...t){super(...t),this.List=[]}async do(){const t=[];for(const e of this.List){const i=e.objectId?.Object;i&&t.push(i.opacityTo(Ed(Ed({},e),{},{startTime:this.startTime})))}return N().all(t)}fromJSON(t){this.List=t}readFile(t){t.read(),this.List.length=0,t.readAnyArray((()=>{const e={};e.opacity=t.read(),e.time=t.read(),e.animationType=t.read(),e.objectId=t.readObjectId(),this.List.push(e)}))}writeFile(t){t.write(1),t.writeAnyArray(this.List,(e=>{t.write(e.opacity),t.write(e.time),t.write(e.animationType),t.writeObjectId(e.objectId)}))}}).type="Opacity",Cd.schema={label:"\u8bbe\u7f6e\u4e0d\u900f\u660e"},Pd=Cd))||Pd;var Dd,Td;let Rd=Y(((Td=class extends pt{constructor(t,e=null){super(),this._triggerType=t,this.target=e,this.list=[],this._cleaners=[],this.watch()}get DB(){return this._db}get TriggerType(){return this._triggerType}get List(){return[...this.list]}set List(t){this.list=t}get Target(){return this.target}async do(){const t=[];let e=0;for(const i of this.list)if(this.DB.InteractionTable.Pause&&(await this.DB.InteractionTable.wait(),await N().all(t).then((e=>{t.length=0}))),"Wait"===i.Type)await i.do(),e+=i._time/1e3;else if(i.IsContainer){if(await i.do())return}else i.startTime=e,t.push(i.do());return N().all(t).then((t=>{}))}add(t){this.list.push(t)}destory(){super.destory(),this.clearWatch();for(const t of this.list)t.destory()}readFile(t){super.readFile(t),t.read(),this._triggerType=t.read(),t.readAnyArrayAndPush(this.list,t.readObject),this.target=t.readObjectId(),I()((()=>{this.watch()}),0)}writeFile(t){super.writeFile(t),t.write(1),t.write(this._triggerType),t.writeAnyArray(this.list,t.writeObject),t.writeObjectId(this.target)}clearWatch(){var t;b()(t=this._cleaners).call(t,(t=>t())),this._cleaners.length=0}watch(){if(this.clearWatch(),this.target?.Object&&zr.PreviewMode){let t=fd(this._triggerType);if(Bs[t])return void this._cleaners.push(this.target.Object.registerAction(t,(async t=>{this.check(t.sourceEvent)&&(this.DB.InteractionTable.doing||await this.doList())})));this._cleaners.push(this.target.Object.on(t,(async t=>{this.DB.InteractionTable.doing&&"load"!==t.type&&!t.isChild||this.check(t)&&await this.doList()})))}}check(t){return!t||("RightClick"===this._triggerType?2===t.event.button:void 0===t.event?.button||t.event.button<=0)}async doList(){this.DB.InteractionTable.Pause?this.DB.InteractionTable.queues.push((async()=>{this.DB.InteractionTable.doing=!0,await this.do(),this.DB.InteractionTable.doing=!1})):(this.DB.InteractionTable.doing=!0,await this.do(),this.DB.InteractionTable.doing=!1)}}).type="Interaction",Dd=Td))||Dd;var Id,Ld;let Fd=Y(((Ld=class{constructor(){this._Params=void 0,this.type=Ys.Equal,this.value1=void 0,this.value2=void 0}check(){return this.compare()}writeFile(t){t.write(1),t.writeWidgetValue(this.value1),t.writeWidgetValue(this.value2),t.write(this.type)}readFile(t){t.read(),this.value1||(this.value1={}),t.readWidgetValue(this.value1),this.value2||(this.value2={}),t.readWidgetValue(this.value2),this.type=t.read()}compare(){const t=bd(this.value1,this._Params),e=bd(this.value2,this._Params);switch(this.type){case Ys.Equal:return t===e;case Ys.UnEqual:return t!==e;case Ys.Great:return t>e;case Ys.Less:return t<e;case Ys.GtEqual:return t>=e;case Ys.LessEqual:return t<=e;case Ys.Include:case Ys.UnInclude:case Ys.Is:case Ys.IsNot:default:return!1}}}).type="Compare",Id=Ld))||Id;var kd,jd;let Bd=0,Nd=Y(((jd=class extends po{constructor(...t){super(...t),this.IsContainer=!0,this.isAll=!0,this.compares=[],this.list=[],this.Name="\u60c5\u5f62"+Bd++}check(){var t,e,i;return b()(t=this.compares).call(t,(t=>t._Params=zr.GlobalVariables)),this.isAll?us()(e=this.compares).call(e,(t=>t.check())):Et()(i=this.compares).call(i,(t=>t.check()))}async do(){if(!this.check())return!1;let t=0;const e=[];for(const i of this.list)"Wait"===i.Type?(await i.do(),t+=i._time/1e3):(i.startTime=t,e.push(i.do()));return N().all(e).then((()=>!0))}add(t){this.list.push(t)}addCompare(t){this.compares.push(t)}writeFile(t){t.write(1),t.write(this.isAll),t.write(this.Name),t.writeAnyArray(this.list,t.writeObject),t.writeAnyArray(this.compares,t.writeObject)}readFile(t){t.read(),this.isAll=t.read(),this.Name=t.read(),t.readAnyArrayAndPush(this.list,t.readObject),t.readAnyArrayAndPush(this.compares,t.readObject)}}).type="Condition",kd=jd))||kd;var Gd,Hd;function Vd(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}let Zd;!function(t){t.Ws="1",t.Api="2"}(Zd||(Zd={}));let Wd=Y((Hd=class t{constructor(t,e){this.target=t,this.targetKey=e,this._time=void 0,this.data=void 0,this.type=Zd.Ws}do(){this.type===Zd.Api?this.startApiRequest():this.startWs()}setEntityValue(t){const e=this.target.Object;if(e){const i=this.targetKey.split("/");let s=e;const a=i.pop();for(const t of i)s=s[t];"setProp"in s?s.setProp(a,t):s[a]=t}}destory(){if(this._time&&clearTimeout(this._time),"ws"in this.data){const e=t.WSList.get(this.data.ws);e&&(e.close(),t.WSList.delete(this.data.ws))}}writeFile(t){t.write(1),t.writeObjectId(this.target),t.write(this.targetKey),t.write(this.type),t.write(j()(this.data))}readFile(t){t.read(),this.target=t.readObjectId(),this.targetKey=t.read(),this.type=t.read();const e=t.read();e&&(this.data=JSON.parse(e))}async startApiRequest(){const{type:t,params:e,time:i,url:s,filter:a,interfaceSource:r,select:n}=this.data;let o=t=>t;try{const t=new Function("return "+a);t&&(o=t())}catch(t){}const h={};if(e)for(const t of e)h[t.key]=t.value;let l;"custom"===r?(l=await function(t,e){const i={method:e.method??"GET",body:e?.data?j()(e.data):void 0};if(e.params){let i="?";for(const t in e.params)i+=`${t}=${e.params[t]}`;t+=i}return fetch(t,i).then((t=>t.json()))}(s,function(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=Vd(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=Vd(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}({method:t},"POST"===t?{data:h}:{params:h})),l=o(l)):l=await this.queryService(o),this.setEntityValue(l[n]),i&&i>0&&(this._time=I()((()=>{this.startApiRequest()}),1e3*i))}async queryService(t){try{let e;return e=new Function("return "+this.data.queryDataStr)(),t(await e(this.data))}catch(t){}}startWs(){const e=this.data;if(!e.ws)return;let i=t.WSList.get(e.ws);if(!i){var s;let a=e.ws;if(H()(s=e.ws).call(s,"//")){a=("https:"===location.protocol?"wss:":"ws:")+e.ws}i=new WebSocket(a),t.WSList.set(e.ws,i)}i.addEventListener("message",(t=>{if(!t.data)return;const i=JSON.parse(t.data),s=String(e.source);"0"===s?i?.params&&e.key in i.params&&this.setEntityValue(i.params[e.key]):"1"===s&&i&&e.key in i&&this.setEntityValue(i[e.key].value)}))}},Hd.type="DataBind",Hd.WSList=new(U()),Gd=Hd))||Gd;var Ud,Kd;let Yd=Y(((Kd=class extends Bn{constructor(...t){super(...t),this._background="#4a4b4b"}get Visiable(){return super.Visiable}set Visiable(t){var e;super.Visiable=t,b()(e=this.lines).call(e,(e=>e.isVisible=!this._erase&&t))}setProp(t,e){super.setProp(t,e);const i=this._drawObject,s=i.children,a=s.length;let r=0;for(;r<this.dataList.length;r++){const t=this.dataList[r];if(s[r])s[r].text=t.label+"\uff1a"+t.value+" "+t.unit;else{const e=new ye.a(t.key,t.label+"\uff1a"+t.value+" "+t.unit);e.height=this._height,e.color="#fff",i.addControl(e)}}for(;r<a;r++)i.removeControl(s[r])}initDrawObject(){const t=new we.e(this.UniqueName);return t.shadowOffsetX=1,t.shadowOffsetY=1,t.shadowBlur=8,t.shadowColor="#168df8",t.background=this._background,this.updateDrawObject(t),this.generateLinkLine(t),t}updateDrawObject(t){super.updateDrawObject(t),t.background=this._background;const e=t.children,i=e.length;let s=0;for(;s<this.dataList.length;s++){const i=this.dataList[s];if(e[s])e[s].text=i.label+"\uff1a"+i.value+" "+i.unit;else{const e=new ye.a(i.key,i.label+"\uff1a"+i.value+" "+i.unit);e.height=this._height,e.color="#fff",t.addControl(e)}}for(;s<i;s++)t.removeControl(e[s])}readFile(t){super.readFile(t),t.read(),this._background=t.read(),this.update()}writeFile(t){super.writeFile(t),t.write(1),t.write(this._background)}}).type="StackPanelGui",Ud=Kd))||Ud;var qd,Xd,$d,Qd,Jd,tu,eu,iu,su,au,ru,nu;function ou(t){for(;t.firstChild;)t.removeChild(t.firstChild);t.srcObject=null,t.src="",t.removeAttribute("src")}let hu=(qd=(0,hi.qC)(),Xd=(0,hi.qC)(),$d=(0,hi.qC)(),Qd=(0,hi.qC)(),Jd=(0,hi.qC)(),tu=(0,hi.qC)(),eu=(0,hi.qC)(),iu=(0,hi.qC)(),su=(0,hi.qC)(),au=(0,hi.qC)(),ru=(0,hi.qC)(),nu=class extends ai.o{get isLoaded(){return this._loaded}get detectPointerOnOpaqueOnly(){return this._detectPointerOnOpaqueOnly}set detectPointerOnOpaqueOnly(t){this._detectPointerOnOpaqueOnly!==t&&(this._detectPointerOnOpaqueOnly=t)}get sourceLeft(){return this._sourceLeft}set sourceLeft(t){this._sourceLeft!==t&&(this._sourceLeft=t,this._markAsDirty())}get sourceTop(){return this._sourceTop}set sourceTop(t){this._sourceTop!==t&&(this._sourceTop=t,this._markAsDirty())}get sourceWidth(){return this._sourceWidth}set sourceWidth(t){this._sourceWidth!==t&&(this._sourceWidth=t,this._markAsDirty())}get sourceHeight(){return this._sourceHeight}set sourceHeight(t){this._sourceHeight!==t&&(this._sourceHeight=t,this._markAsDirty())}get imageWidth(){return this._videoWidth}get imageHeight(){return this._videoHeight}get svgAttributesComputationCompleted(){return this._svgAttributesComputationCompleted}get autoScale(){return this._autoScale}set autoScale(t){this._autoScale!==t&&(this._autoScale=t,t&&this._loaded&&this.synchronizeSizeWithContent())}get keepSize(){return this._autoScale}set keepSize(t){this._keepSize!==t&&(this._keepSize=t,t&&this._loaded&&this.synchronizeSizeWithContent())}set VideoDom(t){this._video=t,this._loaded=!1,this._imageDataCache.data=null,this._video.width?this._onImageLoaded():this._video.onload=()=>{this._onImageLoaded()}}get VideoDom(){return this._video}_onImageLoaded(){this._imageDataCache.data=null,this._videoWidth=this._video.videoWidth,this._videoHeight=this._video.videoHeight,this._loaded=!0,this._autoScale&&this.synchronizeSizeWithContent(),this.onImageLoadedObservable.notifyObservers(this),this._markAsDirty()}_getVideo(t){if(t.isNative)return t;if(t instanceof HTMLVideoElement)return Wt.w1.SetCorsBehavior(t.currentSrc,t),t;const e=document.createElement("video");return"string"==typeof t?(Wt.w1.SetCorsBehavior(t,e),e.src=t):(Wt.w1.SetCorsBehavior(t[0],e),b()(t).call(t,(t=>{const i=document.createElement("source");i.src=t,e.appendChild(i)}))),this.onDisposeObservable.addOnce((()=>{ou(e)})),e}get source(){return this._source}set source(t){this._source!==t&&(this._loaded=!1,this._source=t,this._imageDataCache.data=null,this._video=this._getVideo(t),this._video.crossOrigin="anonymous",this._video.width=400,this._video.height=400,this._video.muted=!0,this._video.autoplay=!0,this._video.loop=!0,t&&(this._video.play(),this._video.addEventListener("play",(()=>{this._onImageLoaded()})),this._video.addEventListener("seeked",(()=>{this._onImageLoaded()})),this._video.addEventListener("canPlay",(()=>{this._onImageLoaded()})),this._video.addEventListener("loadedData",(()=>{this._onImageLoaded()}))))}get cellWidth(){return this._cellWidth}set cellWidth(t){this._cellWidth!==t&&(this._cellWidth=t,this._markAsDirty())}get cellHeight(){return this._cellHeight}set cellHeight(t){this._cellHeight!==t&&(this._cellHeight=t,this._markAsDirty())}get cellId(){return this._cellId}set cellId(t){this._cellId!==t&&(this._cellId=t,this._markAsDirty())}constructor(t,e=null,i,s,a){super(t),this.name=t,this.scene=a,this._workingCanvas=null,this._video=void 0,this._videoWidth=void 0,this._videoHeight=void 0,this._loaded=!1,this._source=void 0,this._autoScale=!1,this._sourceLeft=0,this._sourceTop=0,this._sourceWidth=0,this._sourceHeight=0,this._svgAttributesComputationCompleted=!1,this._cellWidth=0,this._cellHeight=0,this._cellId=-1,this._keepSize=!0,this._detectPointerOnOpaqueOnly=void 0,this._imageDataCache={data:null,key:""},this.listener=void 0,this.onImageLoadedObservable=new zi.y$,this.onSVGAttributesComputedObservable=new zi.y$,this.width=i,this.height=s,this.source=e,this.listener=a.onAfterRenderObservable.add((()=>{this.isVisible&&this.source&&this._onImageLoaded()}))}contains(t,e){if(!super.contains(t,e))return!1;if(!this._detectPointerOnOpaqueOnly||!this._workingCanvas)return!0;const i=0|this._currentMeasure.width,s=0|this._currentMeasure.height,a=i+"_"+s;let r=this._imageDataCache.data;if(!r||this._imageDataCache.key!==a){const t=this._workingCanvas.getContext("2d");this._imageDataCache.data=r=t.getImageData(0,0,i,s).data,this._imageDataCache.key=a}return r[4*((t=t-this._currentMeasure.left|0)+(e=e-this._currentMeasure.top|0)*i)+3]>0}_getTypeName(){return"Image"}synchronizeSizeWithContent(){this._loaded&&(this.width=this._video.width+"px",this.height=this._video.height+"px")}_processMeasures(t,e){this._loaded&&(this._autoScale&&this.synchronizeSizeWithContent(),this.parent&&this.parent.parent&&(this.parent.adaptWidthToChildren=!0,this.parent.adaptHeightToChildren=!0)),super._processMeasures(t,e)}_prepareWorkingCanvasForOpaqueDetection(){if(!this._detectPointerOnOpaqueOnly)return;const t=this._currentMeasure.width,e=this._currentMeasure.height;if(!this._workingCanvas){const i=this._host?.getScene()?.getEngine()||oi.l.LastCreatedEngine;if(!i)throw new Error("Invalid engine. Unable to create a canvas.");this._workingCanvas=i.createCanvas(t,e)}this._workingCanvas.getContext("2d").clearRect(0,0,t,e)}_drawImage(t,e,i,s,a,r,n,o,h){if(t.drawImage(this._video,e,i,s,a,r,n,o,h),!this._detectPointerOnOpaqueOnly)return;(t=this._workingCanvas.getContext("2d")).drawImage(this._video,e,i,s,a,r-this._currentMeasure.left,n-this._currentMeasure.top,o,h)}_draw(t){let e,i,s,a;if(t.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(t.shadowColor=this.shadowColor,t.shadowBlur=this.shadowBlur,t.shadowOffsetX=this.shadowOffsetX,t.shadowOffsetY=this.shadowOffsetY),-1===this.cellId)e=this._sourceLeft,i=this._sourceTop,s=this._sourceWidth?this._sourceWidth:this._videoWidth,a=this._sourceHeight?this._sourceHeight:this._videoHeight;else{const t=this._video.videoWidth/this.cellWidth,r=this.cellId/t>>0,n=this.cellId%t;e=this.cellWidth*n,i=this.cellHeight*r,s=this.cellWidth,a=this.cellHeight}this._prepareWorkingCanvasForOpaqueDetection(),this._applyStates(t),this._loaded&&this._drawImage(t,e,i,s,a,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._keepSize?this._currentMeasure.width*a/s:this._currentMeasure.height),t.restore()}dispose(){super.dispose(),this.onImageLoadedObservable.clear(),this.onSVGAttributesComputedObservable.clear(),this.listener&&this.scene.onAfterRenderObservable.remove(this.listener),ou(this._video)}},(0,xs.Z)(nu.prototype,"detectPointerOnOpaqueOnly",[qd],w()(nu.prototype,"detectPointerOnOpaqueOnly"),nu.prototype),(0,xs.Z)(nu.prototype,"sourceLeft",[Xd],w()(nu.prototype,"sourceLeft"),nu.prototype),(0,xs.Z)(nu.prototype,"sourceTop",[$d],w()(nu.prototype,"sourceTop"),nu.prototype),(0,xs.Z)(nu.prototype,"sourceWidth",[Qd],w()(nu.prototype,"sourceWidth"),nu.prototype),(0,xs.Z)(nu.prototype,"sourceHeight",[Jd],w()(nu.prototype,"sourceHeight"),nu.prototype),(0,xs.Z)(nu.prototype,"autoScale",[tu],w()(nu.prototype,"autoScale"),nu.prototype),(0,xs.Z)(nu.prototype,"keepSize",[eu],w()(nu.prototype,"keepSize"),nu.prototype),(0,xs.Z)(nu.prototype,"source",[iu],w()(nu.prototype,"source"),nu.prototype),(0,xs.Z)(nu.prototype,"cellWidth",[su],w()(nu.prototype,"cellWidth"),nu.prototype),(0,xs.Z)(nu.prototype,"cellHeight",[au],w()(nu.prototype,"cellHeight"),nu.prototype),(0,xs.Z)(nu.prototype,"cellId",[ru],w()(nu.prototype,"cellId"),nu.prototype),nu);var lu,cu;let du=Y((cu=class extends Bn{constructor(t){super(),this._url="",this._width="200px",this._height="100px",this._videoDom=void 0,t?.url&&(this._url=t.url),t?.width&&(this._width=t.width),t?.height&&(this._height=t.height)}get VideoDom(){return this._videoDom}get Url(){return this._url}set Url(t){this._url=t,this.update()}initDrawObject(){const t=new Re.W(this.UniqueName);t.width=this._width,t.height=this._height;const e=new hu(this.UniqueName,this._url,this._width,this._height,Er.Scene);return t.background="#000",this._videoDom=e.VideoDom,e.keepSize=!0,t.addControl(e),t}updateDrawObject(t){super.updateDrawObject(t);t.children[0].source=this._url}readFile(t){super.readFile(t),t.read(),this.update()}writeFile(t){super.writeFile(t),t.write(1)}erase(t=!0){super.erase(t)}destory(){super.destory()}},cu.type="VideoGui",lu=cu))||lu;var uu,pu,mu,gu,_u,wu,yu,bu,fu,vu,xu;let Su=(uu=(0,hi.qC)(),pu=(0,hi.qC)(),mu=(0,hi.qC)(),gu=(0,hi.qC)(),_u=(0,hi.qC)(),wu=(0,hi.qC)(),yu=(0,hi.qC)(),bu=(0,hi.qC)(),fu=(0,hi.qC)(),vu=(0,hi.qC)(),xu=class extends ai.o{get isLoaded(){return this._loaded}get detectPointerOnOpaqueOnly(){return this._detectPointerOnOpaqueOnly}set detectPointerOnOpaqueOnly(t){this._detectPointerOnOpaqueOnly!==t&&(this._detectPointerOnOpaqueOnly=t)}get sourceLeft(){return this._sourceLeft}set sourceLeft(t){this._sourceLeft!==t&&(this._sourceLeft=t,this._markAsDirty())}get sourceTop(){return this._sourceTop}set sourceTop(t){this._sourceTop!==t&&(this._sourceTop=t,this._markAsDirty())}get sourceWidth(){return this._sourceWidth}set sourceWidth(t){this._sourceWidth!==t&&(this._sourceWidth=t,this._markAsDirty())}get sourceHeight(){return this._sourceHeight}set sourceHeight(t){this._sourceHeight!==t&&(this._sourceHeight=t,this._markAsDirty())}get imageWidth(){return this._canvasWidth}get imageHeight(){return this._canvasHeight}get svgAttributesComputationCompleted(){return this._svgAttributesComputationCompleted}get autoScale(){return this._autoScale}set autoScale(t){this._autoScale!==t&&(this._autoScale=t,t&&this._loaded&&this.synchronizeSizeWithContent())}get keepSize(){return this._autoScale}set keepSize(t){this._keepSize!==t&&(this._keepSize=t,t&&this._loaded&&this.synchronizeSizeWithContent())}set CanvasDom(t){this._canvas_=t,this._imageDataCache.data=null,this._onImageLoaded()}get CanvasDom(){return this._canvas_}_onImageLoaded(){this._imageDataCache.data=null,this._canvasWidth=this._canvas_.width,this._canvasHeight=this._canvas_.height,this._loaded=!0,this._autoScale&&this.synchronizeSizeWithContent(),this.onImageLoadedObservable.notifyObservers(this),this._markAsDirty()}get cellWidth(){return this._cellWidth}set cellWidth(t){this._cellWidth!==t&&(this._cellWidth=t,this._markAsDirty())}get cellHeight(){return this._cellHeight}set cellHeight(t){this._cellHeight!==t&&(this._cellHeight=t,this._markAsDirty())}get cellId(){return this._cellId}set cellId(t){this._cellId!==t&&(this._cellId=t,this._markAsDirty())}constructor(t,e,i){super(t),this.name=t,this.scene=i,this._needAnimation=!1,this._workingCanvas=null,this._canvas_=void 0,this._canvasWidth=void 0,this._canvasHeight=void 0,this._loaded=!1,this._source=void 0,this._autoScale=!1,this._sourceLeft=0,this._sourceTop=0,this._sourceWidth=0,this._sourceHeight=0,this._svgAttributesComputationCompleted=!1,this._cellWidth=0,this._cellHeight=0,this._cellId=-1,this._keepSize=!0,this._detectPointerOnOpaqueOnly=void 0,this._imageDataCache={data:null,key:""},this.listener=void 0,this.onImageLoadedObservable=new zi.y$,this.onSVGAttributesComputedObservable=new zi.y$,this.CanvasDom=e,this.listener=i.onAfterRenderObservable.add((()=>{this.isVisible&&this._needAnimation&&this._onImageLoaded()}))}contains(t,e){if(!super.contains(t,e))return!1;if(!this._detectPointerOnOpaqueOnly||!this._workingCanvas)return!0;const i=0|this._currentMeasure.width,s=0|this._currentMeasure.height,a=i+"_"+s;let r=this._imageDataCache.data;if(!r||this._imageDataCache.key!==a){const t=this._workingCanvas.getContext("2d");this._imageDataCache.data=r=t.getImageData(0,0,i,s).data,this._imageDataCache.key=a}return r[4*((t=t-this._currentMeasure.left|0)+(e=e-this._currentMeasure.top|0)*i)+3]>0}_getTypeName(){return"Image"}synchronizeSizeWithContent(){this._loaded&&(this.width=this._canvas_.width+"px",this.height=this._canvas_.height+"px")}_processMeasures(t,e){this._loaded&&(this._autoScale&&this.synchronizeSizeWithContent(),this.parent&&this.parent.parent&&(this.parent.adaptWidthToChildren=!0,this.parent.adaptHeightToChildren=!0)),super._processMeasures(t,e)}_prepareWorkingCanvasForOpaqueDetection(){if(!this._detectPointerOnOpaqueOnly)return;const t=this._currentMeasure.width,e=this._currentMeasure.height;if(!this._workingCanvas){const i=this._host?.getScene()?.getEngine()||oi.l.LastCreatedEngine;if(!i)throw new Error("Invalid engine. Unable to create a canvas.");this._workingCanvas=i.createCanvas(t,e)}this._workingCanvas.getContext("2d").clearRect(0,0,t,e)}_drawImage(t,e,i,s,a,r,n,o,h){if(t.drawImage(this._canvas_,e,i,s,a,r,n,o,h),!this._detectPointerOnOpaqueOnly)return;(t=this._workingCanvas.getContext("2d")).drawImage(this._canvas_,e,i,s,a,r-this._currentMeasure.left,n-this._currentMeasure.top,o,h)}_draw(t){let e,i,s,a;if(t.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(t.shadowColor=this.shadowColor,t.shadowBlur=this.shadowBlur,t.shadowOffsetX=this.shadowOffsetX,t.shadowOffsetY=this.shadowOffsetY),-1===this.cellId)e=this._sourceLeft,i=this._sourceTop,s=this._sourceWidth?this._sourceWidth:this._canvasWidth,a=this._sourceHeight?this._sourceHeight:this._canvasHeight;else{const t=this._canvas_.width/this.cellWidth,r=this.cellId/t>>0,n=this.cellId%t;e=this.cellWidth*n,i=this.cellHeight*r,s=this.cellWidth,a=this.cellHeight}this._prepareWorkingCanvasForOpaqueDetection(),this._applyStates(t),this._loaded&&this._drawImage(t,e,i,s,a,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._keepSize?this._currentMeasure.width*a/s:this._currentMeasure.height),t.restore()}dispose(){super.dispose(),this.onImageLoadedObservable.clear(),this.onSVGAttributesComputedObservable.clear(),this.listener&&this.scene.onAfterRenderObservable.remove(this.listener)}},(0,xs.Z)(xu.prototype,"detectPointerOnOpaqueOnly",[uu],w()(xu.prototype,"detectPointerOnOpaqueOnly"),xu.prototype),(0,xs.Z)(xu.prototype,"sourceLeft",[pu],w()(xu.prototype,"sourceLeft"),xu.prototype),(0,xs.Z)(xu.prototype,"sourceTop",[mu],w()(xu.prototype,"sourceTop"),xu.prototype),(0,xs.Z)(xu.prototype,"sourceWidth",[gu],w()(xu.prototype,"sourceWidth"),xu.prototype),(0,xs.Z)(xu.prototype,"sourceHeight",[_u],w()(xu.prototype,"sourceHeight"),xu.prototype),(0,xs.Z)(xu.prototype,"autoScale",[wu],w()(xu.prototype,"autoScale"),xu.prototype),(0,xs.Z)(xu.prototype,"keepSize",[yu],w()(xu.prototype,"keepSize"),xu.prototype),(0,xs.Z)(xu.prototype,"cellWidth",[bu],w()(xu.prototype,"cellWidth"),xu.prototype),(0,xs.Z)(xu.prototype,"cellHeight",[fu],w()(xu.prototype,"cellHeight"),xu.prototype),(0,xs.Z)(xu.prototype,"cellId",[vu],w()(xu.prototype,"cellId"),xu.prototype),xu);var Mu,Ou;let Pu=Y((Ou=class extends ec{constructor(t){super(),this.particleSystem=t,this._name="\u5b50\u7c92\u5b50\u7279\u6548\u89e6\u53d1\u5668",this.type=me.l.END,this._intance=void 0}get Intance(){return this._intance||(this._intance=this.initParticle()),this._intance}initParticle(){const t=this.particleSystem.Intance;t.disposeOnStop=!0;const e=new me.H(t);return e.type=this.type,e}updateParticle(t){t.type=this.type,this.particleSystem.updateParticle(t.particleSystem)}destory(){super.destory(),this._intance&&(this._intance.dispose(),this._intance=null)}fromJSON(t){if(t)return t.type&&(this.type=t.type),this.particleSystem.fromJSON(t,!0),this}readFile(t){super.readFile(t),this.particleSystem=t.readObject()}writeFile(t){super.writeFile(t),t.writeObject(this.particleSystem)}},Ou.type="SubEmitter",Mu=Ou))||Mu;class Cu{constructor(t){this.attachSystem=t,this._emiter=void 0}get AttachSystem(){return this.attachSystem}set AttachSystem(t){this.attachSystem=t}update(){}fromJSON(t){return this}toJSON(){return null}readFile(t){}writeFile(t){}}var Au,Eu;let zu=Y(((Eu=class extends Cu{constructor(t,e){super(t),this.attachSystem=t,this._emiter=void 0,this._radius=1,this.angle=Math.PI/4,e?.radius&&(this._radius=e.radius),e?.angle&&(this.angle=e.angle),t?.HasIntance&&this.setEmiter()}setEmiter(){this._emiter=this.attachSystem.Intance.createConeEmitter(this._radius,this.angle)}get AttachSystem(){return this.attachSystem}set AttachSystem(t){this.attachSystem=t,this.setEmiter()}get Radius(){return this._radius}set Radius(t){t!==this._radius&&(this._radius=t,this.update())}get Angle(){return this.angle}set Angle(t){t!==this.angle&&(this.angle=t,this.update())}update(){this._emiter&&(this._emiter.radius=this._radius,this._emiter.angle=this.angle)}toJSON(){return{Radius:this.Radius,Angle:this.Angle}}fromJSON(t){return t.Radius&&(this._radius=t.Radius),t.Angle&&(this.angle=t.Angle),this}writeFile(t){super.writeFile(t),t.write(1),t.write(this._radius),t.write(this.angle)}readFile(t){super.readFile(t),t.read(),this._radius=t.read(),this.angle=t.read()}}).type="ConeEmitter",Au=Eu))||Au;class Du extends Cu{constructor(t,e){super(t),this.attachSystem=t,this._radius=1,this._radiusRange=1,e?.radius&&(this._radius=e.radius),e?.radiusRange&&(this._radiusRange=e.radiusRange),t?.HasIntance&&this.setEmiter()}setEmiter(){}get AttachSystem(){return this.attachSystem}set AttachSystem(t){this.attachSystem=t,this.setEmiter()}get Radius(){return this._radius}set Radius(t){t!==this._radius&&(this._radius=t,this.update())}get RadiusRange(){return this._radiusRange}set RadiusRange(t){t!==this._radiusRange&&(this._radiusRange=t,this.update())}update(){this._emiter&&(this._emiter.radius=this._radius,this._emiter.radiusRange=this._radiusRange)}toJSON(){return{Radius:this.Radius,RadiusRange:this.RadiusRange}}fromJSON(t){return this._radius=t.Radius,this._radiusRange=t.RadiusRange,this}writeFile(t){super.writeFile(t),t.write(1),t.write(this._radius),t.write(this._radiusRange)}readFile(t){super.readFile(t),t.read(),this._radius=t.read(),this._radiusRange=t.read()}}var Tu,Ru;let Iu=Y(((Ru=class extends Du{constructor(t,e){super(t,e),this.attachSystem=t,this.height=1,this._emiter=void 0,e?.height&&(this.height=e.height),t?.HasIntance&&this.setEmiter()}setEmiter(){this._emiter=this.attachSystem.Intance.createCylinderEmitter(this._radius,this.height,this._radiusRange)}writeFile(t){super.writeFile(t),t.write(1),t.write(this.height)}readFile(t){super.readFile(t),t.read(),this.height=t.read()}}).type="CylinderEmitter",Tu=Ru))||Tu;var Lu,Fu;let ku=Y(((Fu=class extends Iu{constructor(t,e){super(t,e),this.attachSystem=t,this._emiter=void 0,t?.HasIntance&&this.setEmiter()}setEmiter(){this._emiter=this.attachSystem.Intance.createDirectedCylinderEmitter(this._radius,this.height,this._radiusRange,rr(this.attachSystem.Direction1),rr(this.attachSystem.Direction2))}}).type="DirectedCylinder",Lu=Fu))||Lu;var ju,Bu;let Nu=Y(((Bu=class extends Du{constructor(t,e){super(t,e),this.attachSystem=t,this._emiter=void 0,t?.HasIntance&&this.setEmiter()}setEmiter(){this._emiter=this.attachSystem.Intance.createHemisphericEmitter(this._radius,this._radiusRange)}}).type="HemisphericEmiter",ju=Bu))||ju;var Gu,Hu;let Vu,Zu,Wu=Y(((Hu=class extends Du{constructor(t,e){super(t,e),this.attachSystem=t,this._emiter=void 0,t?.HasIntance&&this.setEmiter()}setEmiter(){this._emiter=this.attachSystem.Intance.createSphereEmitter(this._radius,this._radiusRange)}}).type="SphereEmiter",Gu=Hu))||Gu;var Uu,Ku;function Yu(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}function qu(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=Yu(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=Yu(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}!function(t){t[t.Point=0]="Point",t[t.Box=1]="Box",t[t.Sphere=2]="Sphere",t[t.Hemisphere=3]="Hemisphere",t[t.Cylinder=4]="Cylinder",t[t.DirctedCylinder=5]="DirctedCylinder",t[t.Cone=6]="Cone",t[t.Mesh=7]="Mesh",t[t.Custom=8]="Custom"}(Vu||(Vu={})),function(t){t[t.Point=0]="Point",t[t.Entity=1]="Entity",t[t.Camera=2]="Camera"}(Zu||(Zu={}));let Xu=Y((Ku=class t extends ec{constructor(t){super(),this._intance=void 0,this.capacity=1e3,this._updateSpeed=.01,this._size={min:.1,max:.5},this._image=void 0,this._scale={min:{x:.1,y:.1},max:{x:.5,y:.5}},this.color1="#CD581BFF",this.color2="#000000FF",this.colorDead="#00000000",this._manualEmitCount=-1,this.emitPower={min:1,max:3},this._angularSpeed={min:0,max:Math.PI},this._pivot=new ki.FM,this.direction1=new ki.P(0,1),this.direction2=new ki.P(0,1),this.minEmitBox=new ki.P(-.5,-.5,-.5),this.maxEmitBox=new ki.P(.5,.5,.5),this._gravity=new ki.P(0,0),this._rate=100,this.lifeTime={min:.3,max:1.5},this.spriteOption={isAnimationSheetEnabled:!1,spriteCellHeight:32,spriteCellWidth:32,spriteRandomStartCell:!0,startSpriteCellID:0,endSpriteCellID:3,spriteCellChangeSpeed:0},this.emiterShape=Vu.Box,this.emiterType=Zu.Point,this.emiter=void 0,this.emiterEntity=void 0,this.emiterPosition=new ki.P,this.blendMode=Ze.p.BLENDMODE_ONEONE,this.subParticleSystems=[],this.needUpdateSubEmiters=!1,this.gradients=[],this._targetStopDuration=0,this._position=ki.P.Zero(),t?.image&&(this._image=t.image),t?.capacity&&(this.capacity=t.capacity),t?.manualEmitCount&&(this._manualEmitCount=t.manualEmitCount)}get HasIntance(){return!!this._intance}get Intance(){return this._intance||(this._intance=this.initParticle(),this.Id&&this.updateStatus()),this._intance}get ManualEmitCount(){return this._manualEmitCount}set ManualEmitCount(t){t!==this._manualEmitCount&&(this._manualEmitCount=t,this.update())}get Capacity(){return this.capacity}set Capacity(e){this.capacity!==e&&(this.capacity=e,t.Reading||(this._intance&&(this._intance.dispose(),this._intance=null),this.Intance,this.updateStatus()))}get UpdateSpeed(){return this._updateSpeed}set UpdateSpeed(t){t!==this._updateSpeed&&(this._updateSpeed=t,this.update())}get Size(){return this._size}set Size(t){this._size=t,this.update()}get TextureUrl(){var t;return this._image?H()(t=this._image).call(t,"http")?this._image:Ji.Texture_URL+this._image:""}get Image(){return this._image}set Image(t){t!==this._image&&(this._image=t,this.update())}get Scale(){return this._scale}set Scale(t){this.writeSnapshoot(),this._scale=t,this.update()}get Color1(){return this.color1}set Color1(t){this.color1=t,this.update()}get Color2(){return this.color2}set Color2(t){t!==this.color2&&(this.color2=t,this.update())}get ColorDead(){return this.colorDead}set ColorDead(t){t!==this.colorDead&&(this.colorDead=t,this.update())}get EmitPower(){return this.emitPower}set EmitPower(t){t!==this.emitPower&&(this.emitPower=t,this.update())}get AngularSpeed(){return this._angularSpeed}set AngularSpeed(t){this._angularSpeed=t,this.update()}get Pivot(){return{x:(t=this._pivot).x,y:t.y};var t}set Pivot(t){nr(this._pivot,t),this.update()}get Direction1(){return hr(this.direction1)}set Direction1(t){nr(this.direction1,t),this.update()}get Direction2(){return hr(this.direction2)}set Direction2(t){nr(this.direction2,t),this.update()}get MinEmitBox(){return hr(this.minEmitBox)}set MinEmitBox(t){nr(this.minEmitBox,t),this.update()}get MaxEmitBox(){return hr(this.maxEmitBox)}set MaxEmitBox(t){nr(this.maxEmitBox,t),this.update()}get Gravity(){return hr(this._gravity)}set Gravity(t){nr(this._gravity,t),this.update()}get EmiterPosition(){return hr(this.emiterPosition)}set EmiterPosition(t){nr(this.emiterPosition,t),this.update()}get Rate(){return this._rate}set Rate(t){t!==this._rate&&(this._rate=t,this.update())}get LifeTime(){return this.lifeTime}set LifeTime(t){this.lifeTime=t,this.update()}get SpriteOption(){return this.spriteOption}set SpriteOption(t){this.spriteOption=t,this.update()}get EmiterType(){return this.emiterType}set EmiterType(t){t!==this.emiterType&&(this.emiterType=t,this.updateEmitType())}get EmiterShape(){return this.emiterShape}set EmiterShape(t){t!==this.emiterShape&&(this.emiterShape=t,this.updateEmitShape())}get EmiterEntity(){return this.emiterEntity}set EmiterEntity(t){this.emiterEntity=t,this.update()}get BlendMode(){return this.blendMode}set BlendMode(t){t!==this.blendMode&&(this.blendMode=t,this.update())}get SubParticleSystems(){return[...this.subParticleSystems]}set SubParticleSystems(t){this.subParticleSystems=t,this.needUpdateSubEmiters=!0,this.update()}get Emiter(){return this.emiter}get Gradients(){return[...this.gradients]}set Gradients(t){this.removeGradients(),this.gradients=t,this.updateGradient()}get TargetStopDuration(){return this._targetStopDuration}set TargetStopDuration(t){t!==this._targetStopDuration&&(this._targetStopDuration=t,this.update())}get Position(){return hr(this._position)}set Position(t){this.writeSnapshoot(),nr(this._position,t),this.update()}fillScene(t){const e=t??this.SceneSize;if(e){let{minimum:t,maximum:i}=e;if(t=t.clone(),i=i.clone(),this.emiterType!==Zu.Point)return;{const e=new ki.P(0,i.y+10);t.y=0,t.y=0,this.emiterPosition=e,this.emiterShape===Vu.Box&&(this.minEmitBox=t,this.maxEmitBox=i,this.update())}}}appendGradient(t){this.gradients.push(t),this.updateGradient()}removeGradient(t){if(this.gradients[t]){var e;const i=st()(e=this.gradients).call(e,t,1);this.removeGradients(i)}}initParticle(){const t=new Ze.p(this.UniupeName,this.capacity,Er.Scene);return t.particleTexture=new Fi.x(this.TextureUrl,Er.Scene),this.updateParticle(t),t}updateParticle(t){t.translationPivot=this._pivot;const e=t.particleTexture;e.url!==this.TextureUrl&&e.updateURL(this.TextureUrl),this.updateEmitType(t),this.updateEmitShape(t),t.blendMode=this.blendMode,t.minEmitBox=this.minEmitBox,t.maxEmitBox=this.maxEmitBox,this.color1&&(t.color1=xi.HE.FromHexString(this.color1)),this.color2&&(t.color2=xi.HE.FromHexString(this.color2)),this.colorDead&&(t.colorDead=xi.HE.FromHexString(this.colorDead)),t.minSize=this._size.min,t.maxSize=this._size.max,t.minLifeTime=this.lifeTime.min,t.maxLifeTime=this.lifeTime.max,t.targetStopDuration=this._targetStopDuration,t.emitRate=this._rate,t.gravity=this._gravity,t.direction1=this.direction1,t.direction2=this.direction2,this.spriteOption.isAnimationSheetEnabled?(t.isAnimationSheetEnabled=this.spriteOption.isAnimationSheetEnabled,t.spriteCellHeight=this.spriteOption.spriteCellHeight,t.spriteCellWidth=this.spriteOption.spriteCellWidth,t.spriteRandomStartCell=this.spriteOption.spriteRandomStartCell,t.startSpriteCellID=this.spriteOption.startSpriteCellID,t.endSpriteCellID=this.spriteOption.endSpriteCellID,t.spriteCellChangeSpeed=this.spriteOption.spriteCellChangeSpeed):t.isAnimationSheetEnabled=this.spriteOption.isAnimationSheetEnabled,t.minAngularSpeed=this._angularSpeed.min,t.maxAngularSpeed=this._angularSpeed.max,t.minEmitPower=this.emitPower.min,t.maxEmitPower=this.emitPower.max,t.updateSpeed=this._updateSpeed,t.manualEmitCount=this._manualEmitCount,this.needUpdateSubEmiters&&this.updateSubEmiters(t),this.updateGradient(t),t.worldOffset.copyFrom(this._position)}update(){t.Reading||this._intance&&this.updateParticle(this._intance)}start(){this._intance&&this._intance.start()}stop(){this._intance&&this._intance.stop()}destory(){if(super.destory(),this._intance){this._intance.dispose(),this._intance=null;for(const t of this.subParticleSystems)t.destory()}}fromJSON(e,i=!1){let s;i||(t.Reading=!0);for(const i in e)if(i in this)if("SubParticleSystems"===i){var a;const i=wa()(a=e.SubParticleSystems).call(a,(e=>new Pu(new t).fromJSON(e)));this.subParticleSystems=i,this.needUpdateSubEmiters=!0}else"Emiter"===i?s=e[i]:this[i]=e[i];return i||(t.Reading=!1),s&&this.emiter&&(this.emiter.fromJSON(s),I()((()=>{this.emiter.AttachSystem=this}),0)),this}erase(t){super.erase(t),this._intance&&this._intance.stop(),Mr.trigger({type:"remove",target:this}),this.trigger({type:"remove",target:this})}toJSON(){return{capacity:this.capacity,updateSpeed:this._updateSpeed,size:qu({},this._size),image:this._image,scale:this._scale,color1:this.color1,color2:this.color2,colorDead:this.colorDead}}clone(){const e=new t({image:this._image,capacity:this.capacity});let i=new X;return this.writeFile(i),e.readFile(i),this._id=null,e}writeFile(t){super.writeFile(t),t.write(2),t.write(this.capacity),t.write(this._manualEmitCount),t.write(this._updateSpeed),t.write(this._size.min),t.write(this._size.max),t.write(this._image),t.write(this._scale.min.x),t.write(this._scale.min.y),t.write(this._scale.max.x),t.write(this._scale.max.y),t.write(this.color1),t.write(this.color2),t.write(this.colorDead),t.write(this.emitPower.min),t.write(this.emitPower.max),t.write(this._angularSpeed.min),t.write(this._angularSpeed.max),t.write(this._pivot.x),t.write(this._pivot.y),t.writeArray(this.direction1.asArray()),t.writeArray(this.direction2.asArray()),t.writeArray(this.minEmitBox.asArray()),t.writeArray(this.maxEmitBox.asArray()),t.writeArray(this._gravity.asArray()),t.write(this._rate),t.write(this.lifeTime.min),t.write(this.lifeTime.max),t.write(this._targetStopDuration),t.write(this.spriteOption.isAnimationSheetEnabled),t.write(this.spriteOption.spriteCellHeight),t.write(this.spriteOption.spriteCellWidth),t.write(this.spriteOption.spriteRandomStartCell),t.write(this.spriteOption.startSpriteCellID),t.write(this.spriteOption.endSpriteCellID),t.write(this.spriteOption.spriteCellChangeSpeed),t.write(this.emiterShape),t.write(this.emiterType),t.writeArray(this.emiterPosition.asArray()),t.writeObjectId(this.emiterEntity),t.write(this.blendMode),t.writeAnyArray(this.subParticleSystems,t.writeObject),t.writeObject(this.emiter),t.writeAnyArray(this.gradients,(e=>{t.write(e.key),t.write(e.period),t.write(e.value),t.write(e.otherValue)})),t.writeVector3(this._position)}readFile(t){super.readFile(t);const e=t.read();this.capacity=t.read(),this._manualEmitCount=t.read(),this._updateSpeed=t.read(),this._size.min=t.read(),this._size.max=t.read(),this._image=t.read(),this._scale.min.x=t.read(),this._scale.min.y=t.read(),this._scale.max.x=t.read(),this._scale.max.y=t.read(),this.color1=t.read(),this.color2=t.read(),this.colorDead=t.read(),this.emitPower.min=t.read(),this.emitPower.max=t.read(),this._angularSpeed.min=t.read(),this._angularSpeed.max=t.read(),this._pivot.x=t.read(),this._pivot.y=t.read();let i=t.read(),s=t.readArray(i);this.direction1.fromArray(s),i=t.read(),s=t.readArray(i),this.direction2.fromArray(s),i=t.read(),s=t.readArray(i),this.minEmitBox.fromArray(s),i=t.read(),s=t.readArray(i),this.maxEmitBox.fromArray(s),i=t.read(),s=t.readArray(i),this._gravity.fromArray(s),this._rate=t.read(),this.lifeTime.min=t.read(),this.lifeTime.max=t.read(),this._targetStopDuration=t.read(),this.spriteOption.isAnimationSheetEnabled=t.read(),this.spriteOption.spriteCellHeight=t.read(),this.spriteOption.spriteCellWidth=t.read(),this.spriteOption.spriteRandomStartCell=t.read(),this.spriteOption.startSpriteCellID=t.read(),this.spriteOption.endSpriteCellID=t.read(),this.spriteOption.spriteCellChangeSpeed=t.read(),this.emiterShape=t.read(),this.emiterType=t.read(),i=t.read(),s=t.readArray(i),this.emiterPosition.fromArray(s),this.emiterEntity=t.readObjectId(),this.blendMode=t.read(),t.readAnyArrayAndPush(this.subParticleSystems,t.readObject),this.needUpdateSubEmiters=this.subParticleSystems.length>0,this.emiter=t.readObject(this.emiter),this.emiter&&!this.emiter.AttachSystem&&I()((()=>{this.emiter.AttachSystem=this}),0),this.gradients.length=0,t.readAnyArray((()=>{const e={key:"Size",period:0,value:0,otherValue:0};e.key=t.read(),e.period=t.read(),e.value=t.read(),e.otherValue=t.read(),this.gradients.push(e)})),e>1&&t.readVector3(this._position),this.update(),this.updateStatus()}updateSubEmiters(t=this._intance){var e;t&&(t.subEmitters=[wa()(e=this.subParticleSystems).call(e,(t=>t.Intance))],this.updateStatus(),this.needUpdateSubEmiters=!1)}updateEmitShape(t=this._intance){switch(this.emiter=null,this.emiterShape){case Vu.Point:t&&t.createPointEmitter(this.direction1,this.direction2);break;case Vu.Box:t&&t.createBoxEmitter(this.direction1,this.direction2,this.minEmitBox,this.maxEmitBox);break;case Vu.Sphere:this.emiter=new Wu(this);break;case Vu.Hemisphere:this.emiter=new Nu(this);break;case Vu.Cylinder:this.emiter=new Iu(this);break;case Vu.DirctedCylinder:this.emiter=new ku(this);break;case Vu.Cone:this.emiter=new zu(this);case Vu.Mesh:case Vu.Custom:}}updateEmitType(t=this._intance){if(t)switch(this.emiterType){case Zu.Point:t.emitter=this.emiterPosition;break;case Zu.Entity:this.emiterEntity?.Object&&(t.emitter=this.emiterEntity.Object.RenderObject);break;case Zu.Camera:t.emitter=Er.Scene.activeCamera}}updateGradient(t=this._intance){if(t)for(const e of this.gradients)switch(e.key){case"Size":t.removeSizeGradient(e.period),t.addSizeGradient(e.period,e.value,e.otherValue);break;case"Color":t.removeColorGradient(e.period),t.addColorGradient(e.period,xi.HE.FromHexString(e.value),xi.HE.FromHexString(e.otherValue))}}removeGradients(t=this.gradients,e=this._intance){if(e)for(const i of t)switch(i.key){case"Size":e.removeSizeGradient(i.period);break;case"Color":e.removeColorGradient(i.period)}}},Ku.type="ParticleSystem",Ku.Reading=!1,Uu=Ku))||Uu;var $u,Qu;let Ju=Y((Qu=class extends ec{constructor(...t){super(...t),this._name="\u7c92\u5b50\u7ec4\u5408",this._intance=void 0,this.systems=[]}get Intance(){return this._intance||(this._intance=this.initParticle(),this.updateStatus()),this._intance}initParticle(){const t=new _e.D;for(const e of this.systems)t.systems.push(e.Intance);return t}updateParticle(t){for(let e=0;e<this.systems.length;e++)this.systems[e].updateParticle(t.systems[e])}start(){this._intance&&this._intance.start()}stop(){var t;b()(t=this.systems).call(t,(t=>t.stop()))}fillScene(){const t=this.SceneSize;if(t)for(let e=0;e<this.systems.length;e++)this.systems[e].fillScene(t)}destory(){this._intance?.dispose?.(),this.systems.length=0}erase(t=!0){var e;super.erase(t),this._intance&&b()(e=this._intance.systems).call(e,(t=>t.stop())),Mr.trigger({type:"remove",target:this}),this.trigger({type:"remove",target:this})}fromJSON(t){Xu.Reading=!0;for(const e of t){const t=new Xu;t.fromJSON(e,!0),this.systems.push(t)}return Xu.Reading=!1,this}writeFile(t){super.writeFile(t),t.writeAnyArray(this.systems,t.writeObject)}readFile(t){super.readFile(t),t.readAnyArrayAndPush(this.systems,t.readObject),this.updateStatus()}},Qu.type="ParticleSystemGroup",$u=Qu))||$u;var tp,ep;let ip=Y((ep=class t extends Bt{constructor(){super(),this.entitys=void 0,this._isPickable=!0,this._visiable=!0,this._isSelect=!1,this._groupId=void 0;const t=this;this.entitys=new Proxy([],{get:(t,e,i)=>Fr()(t,e,i),set:(e,i,s,a)=>(Fr()(e,i,a)!==s&&t.UndoRecord&&s instanceof q&&(t.Id?s.Object.GroupId=t.ObjectId:console.warn("\u8bf7\u5148\u6dfb\u52a0\u5230Database\u540e\u5728\u8fdb\u884c\u64cd\u4f5c!")),jr()(e,i,s,a))})}get GroupId(){return this._groupId}set GroupId(t){this._groupId=t}get IsSelect(){return this._isSelect}set IsSelect(t){this._isSelect=t}get IsPickable(){return this._isPickable}set IsPickable(t){if(t!==this._isPickable){this.writeSnapshoot(),this._isPickable=t;for(const e of this.entitys)"IsPickable"in e.Object&&(e.Object.IsPickable=t)}}get Visiable(){return this._visiable}set Visiable(t){if(t!==this._visiable){this.writeSnapshoot(),this._visiable=t;for(const e of this.entitys)"Visiable"in e.Object&&(e.Object.Visiable=t)}}erase(t){super.erase(t);for(const e of this.entitys)e.Object?.erase?.(t)}readFile(t){super.readFile(t);const e=t.read();var i;(t.readAnyArrayAndPush(this.entitys,t.readObjectId),e>=2&&(this.GroupId=t.readObjectId()),e>=3&&(this._visiable=t.read(),this._isPickable=t.read()),e<=3)&&b()(i=this.entitys).call(i,(t=>{t.Object&&(t.Object.GroupId||(t.Object.GroupId=this.ObjectId))}))}writeFile(e){super.writeFile(e),e.write(t.VERSION),e.writeAnyArray(this.entitys,e.writeObjectId),e.writeObjectId(this._groupId),e.write(this._visiable),e.write(this._isPickable)}},ep.VERSION=3,ep.type="CollectionRecord",tp=ep))||tp;var sp,ap;let rp=Y(((ap=class extends ip{constructor(){super();const t=this;this.entitys=new Proxy([],{get:(t,e,i)=>Fr()(t,e,i),set:(e,i,s,a)=>(Fr()(e,i,a)!==s&&t.UndoRecord&&s instanceof q&&s.Object instanceof Er&&(t.Id?s.Object.GroupId=t.ObjectId:console.warn("\u8bf7\u5148\u6dfb\u52a0\u5230Database\u540e\u5728\u8fdb\u884c\u64cd\u4f5c!")),jr()(e,i,s,a))})}readFile(t){super.readFile(t),t.read()}writeFile(t){super.writeFile(t),t.write(1)}}).type="GroupRecord",sp=ap))||sp;var np=i(39133),op=i.n(np),hp=i(64647);const lp=(t,e,i,s=5)=>{let a,r,n;i<0?(a=4*Math.atan(-i),r=new ki.FM(t.x,t.y),n=new ki.FM(e.x,e.y)):(a=4*Math.atan(i),r=new ki.FM(e.x,e.y),n=new ki.FM(t.x,t.y));const o=n.subtract(r),h=o.length(),l=r.add(o.scale(.5)),c=Math.abs(h/2/Math.tan(a/2)),d=o.normalize();let u;if(a<Math.PI){const t=new ki.FM(d.x*Math.cos(Math.PI/2)-d.y*Math.sin(Math.PI/2),d.y*Math.cos(Math.PI/2)+d.x*Math.sin(Math.PI/2));u=l.add(t.scale(-c))}else{const t=new ki.FM(d.x*Math.cos(Math.PI/2)-d.y*Math.sin(Math.PI/2),d.y*Math.cos(Math.PI/2)+d.x*Math.sin(Math.PI/2));u=l.add(t.scale(c))}const p=Math.atan2(n.y-u.y,n.x-u.x)/Math.PI*180;let m=Math.atan2(r.y-u.y,r.x-u.x)/Math.PI*180;m<p&&(m+=360);const g=n.subtract(u).length(),_=Math.floor(p/s)*s+s,w=Math.ceil(m/s)*s-s,y=[];for(let t=_;t<=w;t+=s)y.push(u.add(new ki.FM(Math.cos(t/180*Math.PI)*g,Math.sin(t/180*Math.PI)*g)));return i<0&&Wo()(y).call(y),y};function cp(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}class dp extends ot{constructor(t,e){super(),this.scene=e,this.BlockMap=new(U()),this.material=new(U()),this.matrix4=new ki.y3,this.name=void 0,this.result=void 0,this.entitys=[],this.ModelList=[],this.root=void 0,this.center=void 0,this.config={destoryBlock:!0,ignoreLayers:new(Q()),ignoreBlocks:new(Q()),scale:1e3,destoryDXF:!1,modelMap:{}},this.size=new ki.P,this.outerWalls=[],console.time("\u5206\u6790dxf"),this.result=dp.Parser.parse(t),console.timeEnd("\u5206\u6790dxf"),ki.y3.FromXYZAxesToRef(new ki.P(1),new ki.P(0,0,1),new ki.P(0,1),this.matrix4),window.dxf=this;const i=this.asVector3(this.result.header.$EXTMAX),s=this.asVector3(this.result.header.$EXTMIN),a=ki.P.Center(i,s),r=new ra(s,i);a.z=0,this.center=a,this.size=r.extendSizeWorld.scale(2*this.config.scale);for(const t in this.result.blocks)if(this.result.blocks.hasOwnProperty(t)){const e=this.result.blocks[t];if(1===e.type){const t=this.result.tables.blockRecord.blockRecord,i=t[e.name].dbHandle;if(i)for(const s in t)if(t.hasOwnProperty(s)&&t[s].handle===i){e.name=t[s].name,e.used=!0;break}}}}get UsedBlocksLayers(){const t=new(Q()),e=new(Q());for(const i of this.result.entities){if("INSERT"===i.type){const e=i.name,s=this.result.blocks[e];t.add(s)}const s=this.result.tables.layer.layers;e.add(s[i.layer])}return[cs()(t),cs()(e)]}async parse(){console.time("\u52a0\u8f7dDXF");const t=await this.parseEntitys(this.result.entities,null,!0),e=new ji.Y("root-position",this.scene);for(const i of t)i.parent=e;e.position=this.center.negate();const i=new ji.Y("dxf-root",this.scene);e.parent=i,i.rotation.x=-Math.PI/2,this.root=i,this.root.metadata={needDispose:!0},this.entitys=t,console.timeEnd("\u52a0\u8f7dDXF"),this.trigger({type:"load",target:null})}async parseEntitys(t,e,i){let s=0,a=[];if(e){const i=[],r=[];for(const e of t){const t=await this.parseEntity(e);t.length>0&&(t[0]instanceof Ce._?r.push(...t):i.push(t)),s++,s>500&&(await Cs(0),s=0)}let n;this.config.modelMap[e.name]?.isOuterWall&&(n=this.parseWall(i));const o=(0,qt.xW)(this.config.modelMap[e.name]?.name||e.name,{lines:i},this.scene);o.metadata={block:!0,layer:e.layer,originName:e.name,wall:n};for(const t of r)t.parent=o;a.push(o)}else for(let e=0;e<t.length;e++){const r=t[e];if(i){if(this.config.ignoreLayers.has(r.layer))continue;if("INSERT"===r.type){const t=r.name;if(this.config.ignoreBlocks.has(t))continue}}const n=await this.parseEntity(r);if(n.length>0)if(n[0]instanceof ki.P){const t=(0,qt.nL)(r.layer,{points:n},this.scene);t.metadata={block:!1,layer:r.layer,id:r.handle},this.setColor(r,t),a.push(t)}else a.push(...n);s++,s>500&&(await Cs(0),s=0),i&&this.trigger({type:"loading",target:null,total:this.result.entities.length,current:e})}return a}async parseEntity(t){switch(t.type){case"LINE":return this.parseLine(t);case"POLYLINE":case"LWPOLYLINE":return this.parsePolyline(t);case"INSERT":{const{xScale:i,yScale:s,zScale:a,position:r,rotation:n,name:o}=t,h=this.result.blocks[o];let l;if(h.entities){if(this.BlockMap.has(o)){const t=this.BlockMap.get(o),e=t.clone(t.name);e.metadata=function(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=cp(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=cp(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}({},t.metadata),l=[e]}else l=await this.parseEntitys(h.entities,h),this.BlockMap.set(o,l[0]);let c=this.config.modelMap[h.name]?.rotationOffset??0;c=sa(c);for(const o of l){if(o.scaling=new ki.P(i??1,s??1,a??1),o.position=this.asVector3(r),!o.metadata.size){o.rotation.z=c,o.computeWorldMatrix(!0);const t=o.getBoundingInfo().boundingBox.extendSizeWorld.scale(2);o.metadata.size=t}const h=Wt.w1.ToRadians(n??0);o.rotation.z=h,o.metadata.rotation=h,o.metadata.rotationOffset=c,o.computeWorldMatrix(!0);const l=o.getBoundingInfo().boundingBox.centerWorld.clone();var e;if(l.addToRef(this.center.negate(),l),o.metadata.center=l,o.metadata.id=t.handle,o.metadata.scale=o.scaling,o.metadata.wall)o.metadata.wall.outline=wa()(e=o.metadata.wall.outline).call(e,(t=>t.add(o.position).add(this.center.negate())))}}return l}default:return[]}}parseLine(t){const e=t.vertices;if(e?.length){return wa()(e).call(e,(t=>this.asVector3(t)))}return[]}parsePolyline(t){const e=t.vertices;if(!e?.length)return[];const i=[];for(let t=0;t<e.length-1;t++){const s=this.asVector3(e[t],!1),a=this.asVector3(e[t+1],!1);if(i.push(s),e[t].bulge){const r=lp(s,a,e[t].bulge,10);i.push(...wa()(r).call(r,(t=>this.asVector3(new ki.P(t.x,t.y)))))}t===e.length-2&&i.push(a)}return t.shape&&i.push(i[0].clone()),i}asVector3(t,e=!0){return function(t,e=1){return new ki.P(t.x/e,t.y/e,(t.z??0)/e)}(t,this.config.scale)}setColor(t,e){const i=this.result.tables.layer.layers;let s=[];s=i?function(t){let e=[],i=255&t,s=t>>8&255,a=t>>16&255;return e[0]=a,e[1]=s,e[2]=i,e}(i[t.layer].color):[255,255,255];const a=s.join("-");e.color=xi.Wo.FromArray(s),this.material.set(a,e.material)}parseWall(t){const e=[];new(op());for(const i of t)i.length>2&&i[0].equalsWithEpsilon(ta(i))&&e.push(i);if(1===e.length)return{thickness:10,outline:e[0]};{dt()(e).call(e,((t,e)=>$a(t)-$a(e)));const t=e[0][0];let i=1/0;for(let s=0;s<e[1].length-1;s++){const a=Ka([e[1][s],e[1][s+1]],t);i=Math.min(i,a)}return{thickness:i,outline:e[1]}}}}dp.Parser=new hp.Z;var up=i(93120),pp=i.n(up);function mp(t){return new(N())((e=>I()(e,t)))}let gp;document.addEventListener("paste",(function(t){gp&&gp(t.clipboardData?.getData("text/plain")||"")}));function _p(t){if(t)if(ur()(t))for(const e of t)_p(e);else if("object"==typeof t)for(const i in t){var e;"string"==typeof t[i]&&H()(e=t[i]).call(e,"function")?t[i]=new Function("return "+t[i])():"object"==typeof t[i]&&_p(t[i])}return t}let wp;!function(t){t.Delete="DELETE",t.Model2Zero="MODEL2ZERO",t.SelectAll="SELECTALL",t.Copy="COPY",t.Paste="PASTE",t.Group="GROUP"}(wp||(wp={}));var yp=i(31025);let bp;!function(t){t.Model="models",t.Component="components",t.Files="files",t.GlobalVariables="globalVariables",t.Particles="particles",t.Materials="materials",t.Textures="textures"}(bp||(bp={}));const fp="/editor/file/prefix";new(Q());class vp{}vp.info=(t,e={})=>{},vp.warn=(t,e={})=>{},vp.success=(t,e={})=>{},vp.error=(t,e={})=>{},vp.close=t=>{};var xp=i(43653),Sp=i.n(xp),Mp=i(19082);const Op="Admin-Token";function Pp(t){return Mp.Z.remove(t)}function Cp(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}function Ap(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=Cp(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=Cp(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}let Ep;!function(t){t[t.Ok=0]="Ok",t[t.InvalidToken=61]="InvalidToken",t[t.Error=50]="Error",t[t.Disabled=62]="Disabled"}(Ep||(Ep={}));const zp=Sp().create({baseURL:""});zp.interceptors.request.use((t=>{let e=Mp.Z.get(Op);return e&&(t.headers.Authorization="Bearer "+e),t}),(t=>N().reject(t)));const Dp={code:-1,data:null};zp.interceptors.response.use((function(t){if(t.data.code===Ep.InvalidToken&&(window.IGNORE_INVAILID_TOKEN||I()((()=>{Mp.Z.remove(Op),Pp("userInfo"),Pp("refresh_token"),Pp("expires_time"),window.location.reload()}),1e3)),t.data.code===Ep.Error&&t.data.error&&vp.error(t.data.error?.[0]),t.data.code===Ep.Disabled&&"/none"!==location.pathname){let t=document.location.origin+"/none";document.location.href=t}return N().resolve(t.data)}),(function(t){return N().reject(Dp)}));const Tp=async t=>(vp.error("\u8bf7\u6c42\u53d1\u751f\u9519\u8bef"),Ap(Ap({},Dp),{},{msg:t?.message??"\u8bf7\u6c42\u53d1\u751f\u9519\u8bef"}));const Rp=(0,yp.LO)({intance:null,prefix:""});(0,yp.aD)((t=>{Rp.intance=t})),(0,yp.aD)((async()=>{if(Rp.prefix)return;const t=await async function(t,e){return zp.get(t,e).catch(Tp)}(fp);t.code===Ep.Ok&&(Rp.prefix=t.data.prefix,Ji.assetURL=t.data.prefix)}));function Ip(t){let e=[];return b()(t).call(t,(t=>{const i=document.createElement("script");i.src=t,document.body.append(i);let s=new(N())(((t,e)=>{i.onload=function(){t(!0)},i.onerror=()=>{e(!1)}}));e.push(s)})),N().all(e)}let Lp,Fp;const kp=[];function jp(){return Lp||(Fp?new(N())((t=>{kp.push(t)})):(Fp=Ip(["https://am-img.gkiiot.com/editor/libs/echarts.min.js","https://am-img.gkiiot.com/editor/libs/hc.min.js","https://am-img.gkiiot.com/img/editor/libs/echarts-tooltip-carousel.js","https://cdn.bootcdn.net/ajax/libs/hls.js/1.2.4/hls.js"]).then((()=>Ip(["https://am-img.gkiiot.com/editor/libs/plug.min.js"]))).then((()=>Ip(["https://am-img.gkiiot.com/editor/libs/hc-ui-carousel.js"]))),Fp.then((t=>(Lp=window.ht,window.storagePrefix=Ji.assetURL,Lp.Default.convertURL=function(t){let e=Ji.assetURL;return!e||!t||/^data:image/.test(t)||/^http/.test(t)||/^https/.test(t)||(t=e+"/"+t),t},b()(kp).call(kp,(t=>t(!0))),kp.length=0,Lp)))))}new(Q());const Bp=z()();async function Np(){await jp();const t=new Lp.DataModel;t.a("unshow",!0);const e=new Lp.graph.GraphView(t);return e.getSelectWidth=()=>0,e.setMovableFunc((t=>!1)),e.setPannable(!1),e.setRectSelectable(!1),e.setScrollBarVisible(!1),e.handleScroll=()=>!1,e.onDataClicked=(t,e)=>{if(!t)return;Mr.trigger({type:"click",target:t.target3d,event:e});const i=t.target3d;i.trigger({type:"click",target:t.target3d,event:e}),zr.PreviewMode||(i.start(e.clientX,e.clientY),Rp.intance.Editor.selectControl&&(Rp.intance.Editor.selectControl.SelectDOM=i))},e.getView().addEventListener("keydown",(t=>{"Delete"===t.key?(vc.ExecCommand(wp.Delete),t.stopPropagation()):"KeyC"===t.code&&t.ctrlKey?(vc.ExecCommand(wp.Copy),t.stopPropagation()):"KeyV"===t.code&&t.ctrlKey&&(vc.ExecCommand(wp.Paste),t.stopPropagation())})),e}async function Gp(t,e){e=(t=>t+(-1!==et()(t).call(t,"?")?"&":"?")+"timestap="+Bp)(e);const i=new Lp.Node;t.add(i);const s=function(){let t=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(t+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy-]/g,(function(e){let i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?i:3&i|8).toString(16)}))}();return new(N())((t=>{Lp.Default.xhrLoad(e,(function(e){e?(Lp.Default.setImage(s,Lp.Default.parse(e)),i.setImage(s),t(i)):(vp.error("2d\u8d44\u6e90\u672a\u627e\u5230"),t(null))}))}))}function Hp(t){return Lp.Default.getImage(t)}var Vp,Zp;Y((Zp=class extends Tr{constructor(t){super(),this._source=void 0,this.graphView=void 0,this.hcNode=void 0,this._dataBindings=void 0,this._setAttr={},this.load=t=>{if(!t)return;const e="object"==typeof t.width?t.width.value:t.width,i="object"==typeof t.height?t.height.value:t.height;this._width||(this._width=e),this._height||(this._height=i),this._dataBindings=t.dataBindings;const s=this.graphView.getView();s.style.cssText=`\n    position:absolute;\n    left:${this._position.x}px;\n    top:${this._position.y}px;\n    width:${this._width}px;\n    height:${this._height}px;\n    outline:none;\n    `,this.Visiable||(s.style.visibility="hidden"),I()((()=>{s.style.visibility="visible",s.style.display=this.Visiable&&!this.IsErase?"block":"none"}),0),this.graphView.fitContent(!1,0),this.update()},t?.url&&(this._source=t.url),window.gui=this}get Source(){return this._source}set Source(t){this._source=t}get DataBindings(){return this._dataBindings??[]}get Attr(){return this._setAttr}getProp(t){if(this._setAttr[t])return this._setAttr[t];var e;return F()(e=this.DataBindings).call(e,(e=>e.attr===t))?.defaultValue}setProp(t,e){this.updateAttr({[t]:e})}updateAttr(t){0!==d()(t).length&&this.graphView&&this.hcNode&&(A()(this._setAttr,t),t=_p(t=JSON.parse(j()(t))),this.hcNode.a(t))}initDrawObject(){const t=document.createElement("div");return Np().then((e=>{this.graphView=e;const i=zr.Wait();Gp(e.dm(),this._source).then((t=>{if(!t)return;this.hcNode=t,t.target3d=this;const e=Hp(t.getImage());this.load(e),i(!0)})),t.replaceWith(e.getView()),this._drawObject=e.getView(),this._drawObject.metadata={entity:this},this._drawObject.style.display=this.Visiable&&!this._erase?"block":"none"})),t}updateDrawObject(t){super.updateDrawObject(t);const e=this.convertValue(this._width,zr.MainViewer.Width),i=this.convertValue(this._height,zr.MainViewer.Height);this.graphView.setWidth(e),this.hcNode.setWidth(e),this.graphView.setHeight(i),this.hcNode.setHeight(i),this.graphView.fitContent(!1,0),this.updateAttr(this._setAttr)}getTexture(){return null}async toDataURL(t=!0){let e;const i=this.graphView.__htmlOrderList?.[0];if(i&&i instanceof HTMLElement){if(e=this.graphView.__htmlOrderList[0].getElementsByTagName("canvas")[0],"VIDEO"===i.nodeName)return}else e=this.graphView.getCanvas();return e||(e=this.graphView.getCanvas()),await mp(1e3),t?new(N())((t=>{e.toBlob(t,"image/jpeg")})):e.toDataURL("image/jpeg")}writeFile(t){super.writeFile(t),t.write(2),t.write(this._source),t.write(j()(this._setAttr))}readFile(t){super.readFile(t);const e=t.read();this._source=t.read(),e>1&&(this._setAttr=JSON.parse(t.read())),this.update()}},Zp.type="HC2DDom",Vp=Zp));var Wp,Up;Y((Up=class t extends Bn{static get Container(){if(this._container)return this._container;const t=this._container=document.createElement("div");return t.style.pointerEvents="none",t.style.visibility="hidden",t.style.position="fixed",document.body.append(t),t}constructor(e){super(),this._source=void 0,this.graphView=void 0,this.hcNode=void 0,this._dataBindings=void 0,this._setAttr={},this.timer=void 0,this.load=e=>{if(!e)return;const i="object"==typeof e.width?e.width.value:e.width,s="object"==typeof e.height?e.height.value:e.height;this._dataBindings=e.dataBindings;const a=this.graphView.getView();this._width=i+"px",this._height=s+"px",a.style.cssText=`position:fixed;left:0;top:0;width:${i}px;height:${s}px;`,t.Container.append(a),this.clearDom(a)},e?.url&&(this._source=e.url)}get Source(){return this._source}set Source(t){this._source=t}get DataBindings(){return this._dataBindings??[]}get Attr(){return this._setAttr}getProp(t){if(this._setAttr[t])return this._setAttr[t];var e;return F()(e=this.DataBindings).call(e,(e=>e.attr===t))?.defaultValue}setProp(t,e){this.updateAttr({[t]:e})}updateAttr(e){if(0===d()(e).length||!this.graphView||!this.hcNode)return;const i=this.graphView.getView();i.isConnected||t.Container.append(i),this.clearDom(i),A()(this._setAttr,e),e=_p(e=JSON.parse(j()(e))),this.hcNode.a(e)}initDrawObject(){const t=pa(this.UniqueName);t.width="1px",t.height="1px",t.horizontalAlignment=0,t.verticalAlignment=0;const e=zr.Wait();return Np().then((i=>{this.graphView=i,Gp(i.dm(),this._source).then((i=>{if(!i)return;this.hcNode=i;const s=Hp(i.getImage());this.load(s),this.generateLinkLine(t,100),this.updateDrawObject(t),e(!0)}))})),t}updateDrawObject(t){let e;super.updateDrawObject(t),this.linkEntity?t.linkWithMesh(this.linkEntity.Object.DrawObject):t.linkWithMesh(null),this.graphView.fitContent(!1,0);let i=null;const s=this.graphView.__htmlOrderList?.[0];if(s&&s instanceof HTMLElement?(e=this.graphView.__htmlOrderList[0].getElementsByTagName("canvas")[0],"VIDEO"===s.nodeName&&(i=s)):e=this.graphView.getCanvas(),e||(e=this.graphView.getCanvas()),0===t.children.length)if(i){F()(this.DataBindings);const e=new hu(this.UniqueName+"_video",i,this._width,this._height,zr.MainScene);t.addControl(e),e.width=this._width,e.height=this._height}else{const a=new Su(this.UniqueName,e,zr.MainScene);if(t.addControl(a),this.graphView.getView()&&"VIDEO"===s?.childNodes?.[0]?.nodeName){i=s.childNodes[0];const e=new hu(this.UniqueName+"_video",i,this._width,this._height,zr.MainScene);t.addControl(e);let{width:a,height:r}=i.style;e.width=this.calculateWidthOrHeight(a,"_width"),e.height=this.calculateWidthOrHeight(r,"_height")}a.width=this._width,a.height=this._height}else{const s=t.children[0];i?s.source=i:s.CanvasDom=e}t.width=this._width,t.height=this._height,this.updateAttr(this._setAttr)}calculateWidthOrHeight(t,e){if(as()(t).call(t,"%")){let i=this[e],s=ga()(t.split("%")[0])/100;"string"==typeof i&&(i=ga()(i.split("px")[0])),t=i*s+"px"}return t}getTexture(){return null}get IsSelect(){return this._isSelect}set IsSelect(t){if(this._isSelect=t,!this._drawObject)return;const e=this._drawObject;e.background=t?"#9595d8":""}async toDataURL(t=!0){const e=this._drawObject.children[0];if(e instanceof Su){const i=e.CanvasDom;return await mp(1e3),t?new(N())((t=>{i.toBlob(t,"image/jpeg")})):i.toDataURL("image/jpeg")}return null}writeFile(t){super.writeFile(t),t.write(1),t.write(this._source),t.write(j()(this._setAttr))}readFile(t){super.readFile(t),t.read(),this._source=t.read(),this._setAttr=JSON.parse(t.read()),this.update()}clearDom(t){this.timer&&clearTimeout(this.timer),this.timer=I()((()=>{t.remove()}),3e4)}},Up.type="HC2DGui",Up._container=void 0,Wp=Up));var Kp,Yp;Y((Yp=class extends Br{constructor(t){super(),this._source=t,this.graphView=void 0,this.hcNode=void 0,this._dataBindings=void 0,this.texture=void 0,this.timer=void 0,this.load=t=>{if(!t)return;const e="object"==typeof t.width?t.width.value:t.width,i="object"==typeof t.height?t.height.value:t.height;this._dataBindings=t.dataBindings;const s=this.graphView.getView();s.style.cssText=`position:fixed;left:0;top:0;width:${e}px;height:${i}px;visibility:hidden`,this.graphView.getCanvas().width=e,this.graphView.getCanvas().height=i,document.body.append(s),this.texture&&this.texture.update(),I()((()=>{s.remove()}),2e3)}}get Texture(){return this.texture||this.update(),this.texture}get Source(){return this._source}set Source(t){t!==this._source&&(this._source=t,this.update())}initTexture(){const t=Np();let e;return t.addViewListener((t=>{this.timer&&clearTimeout(this.timer),"validate"===t?.kind&&(this.timer=I()((()=>{let t=!1;const i=this.graphView.__htmlOrderList?.[0];if("VIDEO"===i?.nodeName)this.texture?i.src!==this.texture.video.src&&(t=!0,this.texture.updateURL(i.src)):(this.texture=ca("video"+z()(),i.src,zr.MainScene),e(this));else{let s;i&&i instanceof HTMLElement&&(s=i.getElementsByTagName("canvas")[0]),s||(s=this.graphView.getCanvas()),s&&(this.texture?(t=!0,this.texture._canvas=s,this.texture._context=s.getContext("2d")):(this.texture=la("canvas"+z()(),s,zr.MainScene),e(this)))}t&&(this.graphView.fitContent(!1,0),this.texture.update())}),100))})),this.graphView=t,new(N())((t=>{Gp(this.graphView.dm(),this._source).then((i=>{this.hcNode=i;const s=Hp(i.getImage());this.load(s),e=t}))}))}update(){super.update(),this.graphView}writeFile(t){super.writeFile(t),t.write(1),t.write(this._source)}readFile(t){super.readFile(t),t.read(),this._source=t.read(),this.initTexture()}},Yp.type="HC2DTexture",Kp=Yp));var qp=i(32960),Xp=i(44645);function $p(t){return`CustomComponent_${t}`}function Qp(t){const{code:e,id:i,propertys:s,title:a}=t;if(!e)return;const r=function(t){if(t)try{return new Function("HC","return "+pp()(t).call(t))(l)}catch(t){return null}}(e);r.type=$p(i),r.Schema={title:a,propertys:s},co(r)}A()(l,a);var Jp=i(76875),tm=i.n(Jp);function em(t,e){var i=d()(t);if(p()){var s=p()(t);e&&(s=g()(s).call(s,(function(e){return w()(t,e).enumerable}))),i.push.apply(i,s)}return i}function im(t){for(var e=1;e<arguments.length;e++){var i,s,a=null!=arguments[e]?arguments[e]:{};e%2?b()(i=em(Object(a),!0)).call(i,(function(e){(0,P.Z)(t,e,a[e])})):v()?S()(t,v()(a)):b()(s=em(Object(a))).call(s,(function(e){O()(t,e,w()(a,e))}))}return t}A()(l,a,s),Ji.assetURL="/data/",Ji.Texture_URL="https://am-img.gkiiot.com/editor/",Ji.SkyBox_URL="https://am-img.gkiiot.com/editor/",document.title="\u6d77\u521b\u53ef\u89c6\u5316\u5e73\u53f0";let sm=z()();const am=()=>{const t=(0,qp.useRef)(null),[e,i]=(0,qp.useState)(!1);let s;const a=t=>fetch("/data/"+`components/${t}.json?t=${sm}`).then((t=>t.json())),r=async t=>{i(!0);const e=await(t=>fetch(`/data/app${t||""}.json?t=${sm}`).then((t=>t.json())))(t);if(!e)return;const r=e.components??[];for(const t of r){const e=await a(t);e&&Qp(im(im({},e.data),{},{id:t}))}s.loadFile(e.data);!async function(t,e,i){i.ImportScript=Ip;for(const a of t)try{if(void 0!==a.enabled&&!a.enabled)continue;if(a.version){const t=tm()((async function(){})).constructor("app","HC",a.code);await t(e,i)}else{const t=(s=a.code,new Function("return "+pp()(s).call(s)))();await t(e,i)}}catch(t){console.error(a.name+": \t\n"+t)}var s}(e.scripts??[],s,l),s.on("loadComplete",(()=>{i(!1)}))};return(0,qp.useEffect)((()=>{(async()=>{if(t.current){const e=t.current;e.width=e.parentElement.clientWidth,e.height=e.parentElement.clientHeight,Ji.isEncrypt=!1,window.app=s=new uc({canvas:e,editor:!1,cameraRadius:100});const i=new(T())(location.search).get("id");try{const t=await(t=>{const e=`variable.json?t=${sm}`;try{return fetch("/data/"+e).then((t=>t.json())).catch((t=>t))}catch(t){return null}})();t&&(zr.GlobalVariables=t)}catch(t){}r(i?Number(i):void 0)}})()}),[]),qp.createElement(qp.Fragment,null,qp.createElement("canvas",{style:{width:"100%",height:"100%"},ref:t},"\u9884\u89c8\u9875\u9762"),e&&qp.createElement("div",{style:{position:"fixed",left:0,right:0,top:0,bottom:0,margin:"auto",width:"100%",height:"100%",background:"#00000073",textAlign:"center"}},qp.createElement("img",{src:"/static/images/loading/loading-mask.gif",alt:""}),qp.createElement("div",{style:{color:"#fff",fontSize:24}},"\u8d44\u6e90\u8f7d\u5165\u4e2d,\u8bf7\u7a0d\u540e\u3002\u3002\u3002")))};(0,Xp.s)(document.getElementById("app")).render(qp.createElement(am,null))}},i={};function s(t){var a=i[t];if(void 0!==a)return a.exports;var r=i[t]={exports:{}};return e[t].call(r.exports,r,r.exports,s),r.exports}s.m=e,t=[],s.O=(e,i,a,r)=>{if(!i){var n=1/0;for(c=0;c<t.length;c++){for(var[i,a,r]=t[c],o=!0,h=0;h<i.length;h++)(!1&r||n>=r)&&Object.keys(s.O).every((t=>s.O[t](i[h])))?i.splice(h--,1):(o=!1,r<n&&(n=r));if(o){t.splice(c--,1);var l=a();void 0!==l&&(e=l)}}return e}r=r||0;for(var c=t.length;c>0&&t[c-1][2]>r;c--)t[c]=t[c-1];t[c]=[i,a,r]},s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var t={826:0};s.O.j=e=>0===t[e];var e=(e,i)=>{var a,r,[n,o,h]=i,l=0;if(n.some((e=>0!==t[e]))){for(a in o)s.o(o,a)&&(s.m[a]=o[a]);if(h)var c=h(s)}for(e&&e(i);l<n.length;l++)r=n[l],s.o(t,r)&&t[r]&&t[r][0](),t[r]=0;return s.O(c)},i=self.webpackChunk=self.webpackChunk||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))})();var a=s.O(void 0,[739,274,471,336,480,461,499,729,338,906,669,919,877,658,133,289,637,57],(()=>s(55495)));a=s.O(a)})();